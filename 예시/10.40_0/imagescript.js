var rect,win,i,input,containers,target,canvas=document.getElementById("canvas"),main=document.querySelector(".main"),mainsub=document.querySelector(".mainsub"),ctx=(document.getElementById("canvas").style.display="none",document.querySelector(".mainsub").style.display="none",document.getElementById("canvas").getContext("2d")),canvasx=getOffset(document.getElementById("canvas")).left,canvasy=getOffset(document.getElementById("canvas")).top,last_mousex=0,last_mousey=0,mousex=0,mousey=0,mousedown=!1,maskstatus=!1,maskon=!1,hasInput=!1,texton=!1,cropon=!0,mainRect=document.querySelector(".main").getBoundingClientRect(),mainRecttop=mainRect.top,bodyRecx=document.body.getBoundingClientRect(),offsetx=mainRect.x,offsety=mainRect.top,changed=document.querySelectorAll(".changed"),cropper="",croppedx=0,croppedy=0,el="",elnum="",imgSrc="",body=document.querySelector("body"),cropping=!1,cPushArray=new Array,cStep=-1;function switching(){document.querySelector("#switch").checked?(console.log(document.querySelector("#switch").checked),document.querySelectorAll(".container").forEach(e=>{e.style.marginBottom="30px"})):(console.log(document.querySelector("#switch").checked),document.querySelectorAll(".container").forEach(e=>{e.style.marginBottom="0px"}))}function undomask(){console.log("undomask"),canvas=document.querySelector("#canvas");var e=new Image;e.src=cPushArray[cStep].src,e.onload=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(e,0,0)}}function redomask(){console.log("redomask"),canvas=document.querySelector("#canvas");var e=new Image;e.src=cPushArray[cStep].src,e.onload=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(e,0,0)}}function undotext(){console.log("undotext"),canvas=document.querySelector("#canvas");var e=new Image;e.src=cPushArray[cStep].src,e.onload=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(e,0,0)}}function redotext(){console.log("redotext"),canvas=document.querySelector("#canvas");var e=new Image;e.src=cPushArray[cStep].src,e.onload=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(e,0,0)}}function undoclose(){console.log("undoclose"),console.log(cPushArray),elnum=cPushArray[cStep+1].num,(el=document.querySelector(".main").children[elnum]).style.display="block",el=""}function redoclose(){console.log("redoclose"),console.log(cPushArray),elnum=cPushArray[cStep].num,(el=document.querySelector(".main").children[elnum]).style.display="none",el=""}function undocrop(){for(console.log("undocrop"),console.log(cPushArray),elnum=cPushArray[cStep+1].num,cropper.destroy(),el=document.querySelector(".main").children[elnum],i=0;i<el.children.length;i++)el.children[i].style.display="block";el.querySelector(".changed").style.display="none",el.querySelector(".changed").src="",cropping=!1,el=""}function redocrop(){if(console.log("redocrop"),console.log(cPushArray),""==cPushArray[cStep].src){for(elnum=cPushArray[cStep].num,el=document.querySelector(".main").children[elnum].querySelector(".image"),cropper="",el.className="image",document.querySelector(".main").children[elnum].querySelector(".changed").src="",document.querySelector(".main").children[elnum].querySelector(".changed").style.display="none",i=0;i<document.querySelector(".main").children[elnum].children.length;i++)document.querySelector(".main").children[elnum].children[i].style.display="block",document.querySelector(".main").children[elnum].children[i].className.includes("crop")&&document.querySelector(".main").children[elnum].children[i].remove();cropper=new Cropper(el,2),cropping=!0}else{for(elnum=cPushArray[cStep].num,imgSrc=cPushArray[cStep].src,document.querySelector(".main").children[elnum].querySelector(".changed").src=imgSrc,i=0;i<document.querySelector(".main").children[elnum].children.length;i++)document.querySelector(".main").children[elnum].children[i].style.display="none";document.querySelector(".main").children[elnum].querySelector(".changed").style.display="block",document.querySelector(".main").children[elnum].querySelector(".closebutton").style.display="block",cropper.destroy(),el=""}}function texting(){masking(),canvas.style.cursor="text",cropon=!(texton=!(maskon=!1))}function addInput(e,t){(mainsub=document.getElementById("mainsub")).width=document.querySelector(".main").clientWidth,mainsub.height=document.querySelector(".main").clientHeight,mainsub.x=document.querySelector(".main").x,mainsub.top=document.querySelector(".main").top,mainsub.style.display="block",console.log("a"),(input=document.createElement("input")).type="text",input.style.position="fixed",input.style.left=e-5+"px",input.style.top=t-12+"px",input.style.zindex=8,input.className="word",console.log(input),input.onkeydown=handleEnter,document.querySelector(".mainsub").appendChild(input),input.focus(),input.style.height=document.querySelector("#size").value+"px",input.style["font-size"]=document.querySelector("#size").value+"px",input.style["font-family"]="'NanumSquare', sans-serif",hasInput=!0}function handleEnter(e){13===e.keyCode&&hasInput?(drawText(this.value,parseInt(this.style.left,10),parseInt(this.style.top,10)),document.querySelector(".mainsub").removeChild(this),document.querySelector(".mainsub").style.display="none",hasInput=!1,++cStep<cPushArray.length&&(cPushArray.length=cStep),cPushArray.push({tar:"text",src:document.getElementById("canvas").toDataURL()}),console.log(cPushArray)):27===e.keyCode&&hasInput&&(this.value="",this.style.display="none")}function drawText(e,t,n){document.getElementById("canvas").getContext("2d").textBaseline="top",document.getElementById("canvas").getContext("2d").textAlign="left",document.getElementById("canvas").getContext("2d").font=document.querySelector("#size").value+"px NanumSquare",document.getElementById("canvas").getContext("2d").fillStyle=document.querySelector("#fontcolor").value,document.getElementById("canvas").getContext("2d").fillText(e,t-document.querySelector(".main").getBoundingClientRect().x+3,n-document.querySelector(".main").getBoundingClientRect().top+7-45)}function downloading(){console.log("downloading"),domtoimage.toJpeg(document.querySelector(".main"),{style:{left:"100px"}}).then(function(e){console.log(e),downloadURI(e,document.getElementById("canvas").dataset.productnum+"_d.jpg")})}function downloadURI(e,t){var n=document.createElement("a");n.download=t,n.href=e,document.body.appendChild(n),n.click()}function doneing(){console.log("doneing"),(canvas=document.getElementById("canvas")).style.display="block",downloading(),cropon=!1}function masking(){(canvas=document.getElementById("canvas")).style.cursor="crosshair",maskstatus?canvas.style.display="block":(canvas.width=document.querySelector(".main").clientWidth,canvas.height=document.querySelector(".main").clientHeight-45,canvas.style.display="block",maskstatus=!0),cropon=texton=!(maskon=!0),console.log(maskon),document.getElementById("canvas").click()}function hiding(){(canvas=document.getElementById("canvas")).style.display="none",cropon=!(texton=maskon=!1)}function reseting(){document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height),maskstatus=!1}function getOffset(e){return e.getClientRects().length?(rect=e.getBoundingClientRect(),win=e.ownerDocument.defaultView,{top:rect.top+win.pageYOffset,left:rect.left+win.pageXOffset}):{top:0,left:0}}function curindex(e){return a=[].indexOf.call(e.parentNode.children,e)}function clickBodyEvent(e){if(target=e.target,console.log("target : "),console.log(target),console.log(maskon),main=document.querySelector(".main"),target.tagName.includes("BUTTON")){if("mask"==target.id)return void masking();if("done"==target.id)return void doneing();if("text"==target.id)return void texting();if("hide"==target.id)return void hiding();if("reset"==target.id)return void reseting()}if(target.tagName.includes("INPUT")){if("colorpick"==target.id||"fontcolor"==target.id||"size"==target.id)return;if("switch"==target.id)return void switching()}if(maskon)document.getElementById("canvas").addEventListener("mousedown",function(e){maskon&&(mainRect=document.querySelector(".main").getBoundingClientRect(),console.log(e.pageX),console.log(mainRect.x),console.log(e.pageY),console.log(mainRect.top),last_mousex=parseInt(e.pageX-mainRect.x),last_mousey=parseInt(e.pageY-mainRecttop-45),mousedown=!0)}),document.getElementById("canvas").addEventListener("mouseup",function(e){maskon&&(mousedown=!1)}),document.getElementById("canvas").addEventListener("mousemove",function(e){maskon&&(mainRect=document.querySelector(".main").getBoundingClientRect(),mousex=parseInt(e.pageX-mainRect.x),mousey=parseInt(e.pageY-mainRecttop-45),mousedown)&&((ctx=document.getElementById("canvas").getContext("2d")).beginPath(),ctx.rect(last_mousex,last_mousey,mousex-last_mousex,mousey-last_mousey),ctx.strokeStyle=document.querySelector("#colorpick").value,ctx.lineWidth=0,ctx.fillStyle=document.querySelector("#colorpick").value,ctx.fill(),ctx.stroke())}),++cStep<cPushArray.length&&(cPushArray.length=cStep),cPushArray.push({tar:"mask",src:document.getElementById("canvas").toDataURL()}),console.log(cPushArray),console.log(cPushArray[cPushArray.length-1].src==cPushArray[cPushArray.length-2].src);else{if(texton)if(hasInput){if("word"==target.className)return;drawText((mainsub=document.querySelector(".mainsub")).querySelector(".word").value,parseInt(mainsub.querySelector(".word").style.left,10),parseInt(mainsub.querySelector(".word").style.top,10)),++cStep<cPushArray.length&&(cPushArray.length=cStep),cPushArray.push({tar:"text",src:document.getElementById("canvas").toDataURL()}),console.log(cPushArray),mainsub.removeChild(mainsub.querySelector(".word")),mainsub.style.display="none",hasInput=!1}else{if("CANVAS"!=target.tagName)return;addInput(e.clientX,e.clientY)}if(cropon)if("closebutton"==target.className)target.closest(".container").style.display="none",++cStep<cPushArray.length&&(cPushArray.length=cStep),cPushArray.push({tar:"close",num:curindex(target.parentNode)}),console.log(cPushArray);else if(target.tagName.includes("IMG")&&""==el){for(++cStep<cPushArray.length&&(cPushArray.length=cStep),cPushArray.push({tar:"crop",num:curindex(target.parentNode),src:""}),console.log(cPushArray),cropper="",(el=target.closest(".container").querySelector(".image")).className="image",target.closest(".container").querySelector(".changed").src="",target.closest(".container").querySelector(".changed").style.display="none",i=0;i<target.closest(".container").children.length;i++)target.closest(".container").children[i].style.display="block",target.closest(".container").children[i].className.includes("crop")&&target.closest(".container").children[i].remove();cropper=new Cropper(el,2),cropping=!0}else if(!target.className.includes("crop")&&cropping){for(console.log(cropper),imgSrc=cropper.getCroppedCanvas({}).toDataURL(),console.log(cStep),i=cStep;-1<i;i--)if(console.log(i),"crop"==cPushArray[i].tar){cPushArray[i].src=imgSrc;break}for(console.log(cPushArray),el.closest(".container").querySelector(".changed").src=imgSrc,el.closest(".container").querySelector(".changed").style.display="block",i=0;i<el.closest(".container").children.length;i++)el.closest(".container").children[i].style.display="none";el.closest(".container").querySelector(".changed").style.display="block",el.closest(".container").querySelector(".closebutton").style.display="block",cropper.destroy(),el=""}}}document.querySelector("#colorpick").value="#FFFFFF",document.addEventListener("keydown",function(e){var t;e.ctrlKey&&"z"===e.key&&0<cPushArray.length?-1<cStep&&("close"==cPushArray[--cStep+1].tar?undoclose():"crop"==cPushArray[cStep+1].tar?undocrop():"mask"==cPushArray[cStep+1].tar?undomask():"text"==cPushArray[cStep+1].tar&&undotext()):e.ctrlKey&&"y"===e.key?1<cPushArray.length-cStep&&("close"==cPushArray[++cStep].tar?redoclose():"crop"==cPushArray[cStep].tar?redocrop():"mask"==cPushArray[cStep].tar?redomask():"text"==cPushArray[cStep].tar&&redotext()):hasInput||("f"===e.key?masking():"r"===e.key?texting():"d"===e.key?(t=document.getElementById("colorpick"),window.EyeDropper?(new EyeDropper).open().then(e=>{t.value=e.sRGBHex}).catch(e=>{t.value=e}):t.textContent="Your browser does not support the EyeDropper API"):"e"===e.key?(t=document.getElementById("fontcolor"),window.EyeDropper?(new EyeDropper).open().then(e=>{t.value=e.sRGBHex}).catch(e=>{t.value=e}):t.textContent="Your browser does not support the EyeDropper API"):"a"===e.key&&hiding())}),body.addEventListener("click",clickBodyEvent);