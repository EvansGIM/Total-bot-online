<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>TotalBot - ìƒí’ˆ ìƒì„¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f7;
      color: #333;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #e0e0e0;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      max-width: 500px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Product Info Card */
    .product-info-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      gap: 24px;
    }

    .product-thumb {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      object-fit: cover;
      background: #f0f0f0;
      flex-shrink: 0;
    }

    .product-details {
      flex: 1;
    }

    .product-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #222;
    }

    .product-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .meta-label {
      font-size: 12px;
      color: #888;
    }

    .meta-value {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .meta-value a {
      color: #667eea;
      text-decoration: none;
    }

    .meta-value a:hover {
      text-decoration: underline;
    }

    .original-name {
      font-size: 13px;
      color: #666;
      background: #f9f9f9;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 12px;
      word-break: break-all;
    }

    /* Tabs */
    .tabs {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .tab-header {
      display: flex;
      border-bottom: 1px solid #e5e8eb;
    }

    .tab-btn {
      flex: 1;
      padding: 16px 24px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
      background: #f9f9f9;
      color: #333;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .tab-content {
      display: none;
      padding: 24px;
    }

    .tab-content.active {
      display: block;
    }

    /* Image Grid */
    .image-section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .image-item:hover {
      transform: scale(1.02);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-item .overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .image-item:hover .overlay {
      opacity: 1;
    }

    .image-item .overlay button {
      padding: 8px 16px;
      background: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin: 0 4px;
    }

    .image-item .index {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Detail Images */
    .detail-images-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #e5e8eb;
      border-radius: 8px;
      padding: 16px;
      background: #fafafa;
    }

    .detail-image {
      width: 100%;
      border-radius: 4px;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    /* Rejection Section */
    .rejection-section {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .rejection-title {
      color: #991b1b;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rejection-reason {
      background: white;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      margin-bottom: 16px;
    }

    .rejection-actions {
      display: flex;
      gap: 12px;
    }

    /* SKU Table */
    .sku-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .sku-table th,
    .sku-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e8eb;
    }

    .sku-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #666;
    }

    .sku-table tr:hover {
      background: #f9fafb;
    }

    .sku-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .sku-status.pending { background: #fef3c7; color: #92400e; }
    .sku-status.approved { background: #d1fae5; color: #065f46; }
    .sku-status.rejected { background: #fee2e2; color: #991b1b; }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .toast.success { background: #10b981; color: white; }
    .toast.error { background: #ef4444; color: white; }
    .toast.warning { background: #f59e0b; color: white; }
    .toast.info { background: #3b82f6; color: white; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Loading */
    .loading {
      padding: 60px;
      text-align: center;
      color: #888;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #ddd;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 12px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      max-width: 90%;
      max-height: 90%;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    /* Empty state */
    .empty-state {
      padding: 60px;
      text-align: center;
      color: #888;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Detail Editor Styles */
    .detail-editor-wrapper {
      display: flex;
      gap: 24px;
      min-height: 600px;
    }

    .detail-editor {
      flex: 1;
      border: 2px dashed #e5e8eb;
      border-radius: 12px;
      padding: 16px;
      background: #fafafa;
      overflow-y: auto;
      max-height: 800px;
    }

    .detail-preview-panel {
      width: 400px;
      flex-shrink: 0;
      border: 1px solid #e5e8eb;
      border-radius: 12px;
      overflow: hidden;
      background: white;
    }

    .preview-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
      text-align: center;
    }

    .preview-content {
      padding: 16px;
      max-height: 750px;
      overflow-y: auto;
      background: white;
    }

    .preview-content img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 8px;
    }

    /* Editor Block */
    .editor-block {
      background: white;
      border: 1px solid #e5e8eb;
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s;
      position: relative;
    }

    .editor-block:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .editor-block.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .editor-block.drag-over {
      border-color: #667eea;
      border-style: dashed;
      background: rgba(102, 126, 234, 0.05);
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e8eb;
      border-radius: 8px 8px 0 0;
    }

    .block-type {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .block-actions {
      display: flex;
      gap: 4px;
    }

    .block-actions button {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      background: #f0f0f0;
      color: #666;
      transition: all 0.2s;
    }

    .block-actions button:hover {
      background: #e0e0e0;
      color: #333;
    }

    .block-actions button.danger:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .block-content {
      padding: 12px;
    }

    .block-content img {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 4px;
      cursor: pointer;
    }

    .block-content textarea {
      width: 100%;
      min-height: 100px;
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      padding: 12px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
    }

    .block-content textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Image URL Edit Modal */
    .url-edit-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .url-edit-overlay.active {
      display: flex;
    }

    .url-edit-modal {
      background: white;
      padding: 24px;
      border-radius: 12px;
      width: 500px;
      max-width: 90%;
    }

    .url-edit-modal h3 {
      margin-bottom: 16px;
      font-size: 18px;
    }

    .url-edit-modal input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .url-edit-modal input:focus {
      outline: none;
      border-color: #667eea;
    }

    .url-edit-modal .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Drag placeholder */
    .drag-placeholder {
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: rgba(102, 126, 234, 0.1);
      margin-bottom: 12px;
      height: 100px;
    }

    /* Info Cards (ì›ë³¸ ì •ë³´ íƒ­) */
    .info-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .info-card {
      background: #f9fafb;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e5e8eb;
    }

    .info-card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
    }

    .info-card-body {
      padding: 16px;
    }

    .info-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 14px;
      color: #333;
      font-weight: 500;
      word-break: break-word;
    }

    .info-value.chinese {
      font-size: 15px;
      line-height: 1.5;
    }

    .info-value a {
      color: #667eea;
      text-decoration: none;
    }

    .info-value a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Image Modal -->
  <div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
    <button class="modal-close" onclick="closeImageModal()">&times;</button>
    <div class="modal-content">
      <img id="modalImage" src="" alt="">
    </div>
  </div>

  <!-- URL Edit Modal -->
  <div class="url-edit-overlay" id="urlEditModal">
    <div class="url-edit-modal" onclick="event.stopPropagation()">
      <h3>ì´ë¯¸ì§€ URL ë³€ê²½</h3>
      <input type="text" id="imageUrlInput" placeholder="ìƒˆ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”">
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeUrlEditModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="confirmUrlChange()">ë³€ê²½</button>
      </div>
    </div>
  </div>

  <div class="header">
    <div class="header-left">
      <button class="back-btn" onclick="goBack()">
        <span>â†</span> ëª©ë¡ìœ¼ë¡œ
      </button>
      <h1 id="pageTitle">ìƒí’ˆ ìƒì„¸</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="loadProduct()">
        <span>ğŸ”„</span> ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Product Info Card -->
    <div class="product-info-card" id="productInfoCard">
      <div class="loading">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab-header">
        <button class="tab-btn active" data-tab="options">ì˜µì…˜ ì´ë¯¸ì§€</button>
        <button class="tab-btn" data-tab="detail">ìƒì„¸í˜ì´ì§€</button>
        <button class="tab-btn" data-tab="sku">SKU í˜„í™©</button>
        <button class="tab-btn" data-tab="info">ì›ë³¸ ì •ë³´</button>
      </div>

      <!-- ì˜µì…˜ ì´ë¯¸ì§€ íƒ­ -->
      <div class="tab-content active" id="tab-options">
        <div class="action-bar">
          <button class="btn btn-primary" onclick="downloadAllOptionImages()">
            <span>ğŸ“¥</span> ì „ì²´ ë‹¤ìš´ë¡œë“œ
          </button>
          <button class="btn btn-secondary" onclick="openInEditor('options')">
            <span>ğŸ¨</span> í¸ì§‘ê¸°ì—ì„œ ì—´ê¸°
          </button>
        </div>
        <div class="image-section">
          <h3 class="section-title">ë©”ì¸ ì´ë¯¸ì§€</h3>
          <div class="image-grid" id="mainImagesGrid">
            <div class="loading">ì´ë¯¸ì§€ ë¡œë”© ì¤‘</div>
          </div>
        </div>
        <div class="image-section">
          <h3 class="section-title">ì˜µì…˜ ì´ë¯¸ì§€</h3>
          <div class="image-grid" id="optionImagesGrid">
            <div class="loading">ì´ë¯¸ì§€ ë¡œë”© ì¤‘</div>
          </div>
        </div>
      </div>

      <!-- ìƒì„¸í˜ì´ì§€ íƒ­ -->
      <div class="tab-content" id="tab-detail">
        <div class="action-bar">
          <button class="btn btn-success" onclick="saveDetailPage()" id="saveDetailBtn">
            <span>ğŸ’¾</span> ì €ì¥
          </button>
          <button class="btn btn-primary" onclick="addBlock('image')">
            <span>ğŸ–¼ï¸</span> ì´ë¯¸ì§€ ì¶”ê°€
          </button>
          <button class="btn btn-primary" onclick="addBlock('text')">
            <span>ğŸ“</span> í…ìŠ¤íŠ¸ ì¶”ê°€
          </button>
          <button class="btn btn-warning" onclick="resetOptionsBlock()">
            <span>ğŸ”„</span> ì˜µì…˜ ë¸”ë¡ ë¦¬ì…‹
          </button>
          <button class="btn btn-secondary" onclick="downloadDetailImages()">
            <span>ğŸ“¥</span> ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
        <div class="detail-editor-wrapper">
          <div class="detail-editor" id="detailEditor">
            <div class="loading">ìƒì„¸í˜ì´ì§€ ë¡œë”© ì¤‘</div>
          </div>
          <div class="detail-preview-panel" id="detailPreviewPanel">
            <div class="preview-header">ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="preview-content" id="previewContent"></div>
          </div>
        </div>
      </div>

      <!-- SKU í˜„í™© íƒ­ -->
      <div class="tab-content" id="tab-sku">
        <div id="rejectionSection" class="rejection-section" style="display: none;">
          <div class="rejection-title">
            <span>âš ï¸</span> ë°˜ë ¤ëœ SKUê°€ ìˆìŠµë‹ˆë‹¤
          </div>
          <div class="rejection-reason" id="rejectionReason">
            ë°˜ë ¤ ì‚¬ìœ ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
          </div>
          <div class="rejection-actions">
            <button class="btn btn-warning" onclick="openCoupangWing()">
              <span>ğŸ”—</span> ì¿ íŒ¡WINGì—ì„œ í™•ì¸
            </button>
            <button class="btn btn-primary" onclick="prepareResubmit()">
              <span>ğŸ“</span> íšŒì‹  ì¤€ë¹„
            </button>
          </div>
        </div>
        <table class="sku-table" id="skuTable">
          <thead>
            <tr>
              <th>SKU ID</th>
              <th>ì˜µì…˜ëª…</th>
              <th>ê°€ê²©</th>
              <th>ìƒíƒœ</th>
              <th>ë‹¨ê³„</th>
            </tr>
          </thead>
          <tbody id="skuTableBody">
            <tr><td colspan="5" class="loading">SKU ì •ë³´ ë¡œë”© ì¤‘</td></tr>
          </tbody>
        </table>
      </div>

      <!-- ì›ë³¸ ì •ë³´ íƒ­ -->
      <div class="tab-content" id="tab-info">
        <div class="product-meta" id="originalInfo">
          <div class="loading">ì›ë³¸ ì •ë³´ ë¡œë”© ì¤‘</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ =====
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function checkAuth() {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    async function authFetch(url, options = {}) {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
      };

      const response = await fetch(url, { ...options, headers });

      if (response.status === 401) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
        return;
      }

      return response;
    }

    // Toast ì•Œë¦¼
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ìƒí’ˆ ID ê°€ì ¸ì˜¤ê¸°
    function getProductId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    let currentProduct = null;
    let detailBlocks = []; // ìƒì„¸í˜ì´ì§€ ë¸”ë¡ ë°ì´í„°
    let editingBlockIndex = null; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë¸”ë¡ ì¸ë±ìŠ¤
    let draggedBlockIndex = null; // ë“œë˜ê·¸ ì¤‘ì¸ ë¸”ë¡ ì¸ë±ìŠ¤

    // ë’¤ë¡œê°€ê¸°
    function goBack() {
      window.location.href = 'uploaded.html';
    }

    // íƒ­ ì „í™˜
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
      });
    });

    // ìƒí’ˆ ë¡œë“œ
    async function loadProduct() {
      const productId = getProductId();
      if (!productId) {
        showToast('ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      try {
        const response = await authFetch(`/api/products/${productId}`);
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        currentProduct = data.product;
        renderProductInfo();
        renderOptionImages();
        renderDetailImages();
        renderSkuTable();
        renderOriginalInfo();

      } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
        showToast('ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ìƒí’ˆ ì •ë³´ ë Œë”ë§
    function renderProductInfo() {
      const p = currentProduct;
      const mainImage = p.titleImage?.[0] || p.mainImage || p.images?.[0] || '';
      const optionCount = p.results?.length || 0;

      document.getElementById('pageTitle').textContent = p.title || p.titleCn || 'ìƒí’ˆ ìƒì„¸';

      document.getElementById('productInfoCard').innerHTML = `
        <img class="product-thumb" src="${mainImage}" alt=""
             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23ccc%22>ğŸ“¦</text></svg>'">
        <div class="product-details">
          <h2 class="product-title">${p.title || p.titleCn || 'ì œëª© ì—†ìŒ'}</h2>
          <div class="product-meta">
            <div class="meta-item">
              <span class="meta-label">ê²¬ì ì„œ ID</span>
              <span class="meta-value">#${p.quoteId || '-'}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ì—…ë¡œë“œ ì¼ì‹œ</span>
              <span class="meta-value">${p.uploadedAt ? new Date(p.uploadedAt).toLocaleString('ko-KR') : '-'}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ì˜µì…˜ ìˆ˜</span>
              <span class="meta-value">${p.skuStatus?.totalSku || optionCount || '-'}ê°œ</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ìŠ¹ì¸ ìƒíƒœ</span>
              <span class="meta-value">${getStatusText(p)}</span>
            </div>
          </div>
          ${p.titleCn ? `<div class="original-name">ğŸ“ ì›ë³¸ëª…: ${p.titleCn}</div>` : ''}
        </div>
      `;
    }

    function getStatusText(p) {
      if (p.status === 'approved') return 'âœ… ìŠ¹ì¸ì™„ë£Œ';
      if (p.isRejected) return 'âŒ ë°˜ë ¤';
      if (!p.skuStatus) return 'ğŸ” ë¯¸í™•ì¸';

      const { approved, pending, rejected, totalSku } = p.skuStatus;
      if (approved === totalSku) return 'âœ… ì „ì²´ ìŠ¹ì¸';
      if (rejected === totalSku) return 'âŒ ì „ì²´ ë°˜ë ¤';
      return `â³ ì‹¬ì‚¬ì¤‘ (${approved || 0}/${totalSku} ìŠ¹ì¸)`;
    }

    // ì˜µì…˜ ì´ë¯¸ì§€ ë Œë”ë§
    function renderOptionImages() {
      const p = currentProduct;

      // ë©”ì¸ ì´ë¯¸ì§€ (titleImage ë°°ì—´ ì‚¬ìš©)
      const mainImages = p.titleImage || p.images || [];
      const mainGrid = document.getElementById('mainImagesGrid');

      if (mainImages.length === 0) {
        mainGrid.innerHTML = '<div class="empty-state"><div class="icon">ğŸ–¼ï¸</div><p>ë©”ì¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      } else {
        mainGrid.innerHTML = mainImages.map((img, i) => `
          <div class="image-item" onclick="openImageModal('${img}')">
            <img src="${img}" alt="ë©”ì¸ ${i + 1}" onerror="this.parentElement.style.display='none'">
            <span class="index">${i + 1}</span>
            <div class="overlay">
              <button onclick="event.stopPropagation(); downloadImage('${img}', 'main_${i + 1}')">ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
        `).join('');
      }

      // ì˜µì…˜ ì´ë¯¸ì§€ (results ë°°ì—´ì˜ option1Img ë˜ëŠ” imageLink ì‚¬ìš©) - ì¤‘ë³µ ì œê±°
      const options = p.results || [];
      const optionImages = [];
      const seenUrls = new Set(); // ì¤‘ë³µ URL ì²´í¬ìš©

      options.forEach((opt, i) => {
        const imgUrl = opt.option1Img || opt.imageLink || opt.optionImage || opt.image;
        if (imgUrl && !seenUrls.has(imgUrl)) {
          seenUrls.add(imgUrl);
          const optName = opt.optionName1 || opt.optionName1Cn || opt.name || `ì˜µì…˜${i + 1}`;
          optionImages.push({ url: imgUrl, name: optName });
        }
      });

      const optionGrid = document.getElementById('optionImagesGrid');

      if (optionImages.length === 0) {
        optionGrid.innerHTML = '<div class="empty-state"><div class="icon">ğŸ¨</div><p>ì˜µì…˜ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      } else {
        optionGrid.innerHTML = optionImages.map((img, i) => `
          <div class="image-item" onclick="openImageModal('${img.url}')">
            <img src="${img.url}" alt="${img.name}" onerror="this.parentElement.style.display='none'">
            <span class="index">${img.name}</span>
            <div class="overlay">
              <button onclick="event.stopPropagation(); downloadImage('${img.url}', 'option_${i + 1}')">ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
        `).join('');
      }
    }

    // ìƒì„¸í˜ì´ì§€ ë Œë”ë§ (í¸ì§‘ê¸°ì—ì„œ ë§Œë“  detailHtml) - ì¸ë¼ì¸ ì—ë””í„°
    function renderDetailImages() {
      const p = currentProduct;
      const editor = document.getElementById('detailEditor');
      const previewContent = document.getElementById('previewContent');

      // detailHtmlì„ íŒŒì‹±í•´ì„œ ë¸”ë¡ìœ¼ë¡œ ë³€í™˜
      detailBlocks = parseHtmlToBlocks(p.detailHtml || '');

      // ì˜µì…˜ ë¸”ë¡ì´ ì—†ìœ¼ë©´ ìë™ ìƒì„±í•´ì„œ ì¶”ê°€
      const hasOptionsBlock = detailBlocks.some(b => b.type === 'options');
      if (!hasOptionsBlock && p.results && p.results.length > 0) {
        // ì ì ˆí•œ ìœ„ì¹˜ì— ì˜µì…˜ ë¸”ë¡ ì‚½ì… (ì œëª© ë‹¤ìŒ, ë˜ëŠ” ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ë‹¤ìŒ)
        let insertIndex = 0;
        for (let i = 0; i < detailBlocks.length; i++) {
          if (detailBlocks[i].type === 'heading' && detailBlocks[i].level === 'h1') {
            insertIndex = i + 1;
            break;
          }
          if (detailBlocks[i].type === 'image') {
            insertIndex = i + 1;
            break;
          }
        }
        detailBlocks.splice(insertIndex, 0, generateOptionsBlock(p));
      }

      if (detailBlocks.length === 0) {
        editor.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“„</div>
            <p>ìƒì„¸í˜ì´ì§€ê°€ ì•„ì§ í¸ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            <p style="font-size: 13px; margin-top: 8px;">ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ë¯¸ì§€ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
          </div>
        `;
        previewContent.innerHTML = '<div class="empty-state"><p>ë¯¸ë¦¬ë³´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
      } else {
        renderBlocks();
        updatePreview();
      }
    }

    // ì˜µì…˜ ë¸”ë¡ ìƒì„± (ìƒí’ˆ ë°ì´í„°ì—ì„œ)
    function generateOptionsBlock(product) {
      const options = product.results || [];
      if (options.length === 0) return null;

      // ì˜µì…˜ í…Œì´ë¸” HTML ìƒì„±
      const tableHtml = `
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">ì˜µì…˜</th>
              <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">ê°€ê²©</th>
            </tr>
          </thead>
          <tbody>
            ${options.map(opt => {
              const opt1 = opt.optionName1 || opt.optionName1Cn || '';
              const opt2 = opt.optionName2 || opt.optionName2Cn || '';
              const fullName = opt2 ? `${opt1} - ${opt2}` : opt1;
              const price = opt.price ? Number(opt.price).toLocaleString() + 'ì›' : '-';
              return `
                <tr>
                  <td style="padding: 12px; border: 1px solid #ddd;">${fullName}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${price}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      return {
        type: 'options',
        content: tableHtml,
        title: 'êµ¬ë§¤ ì˜µì…˜'
      };
    }

    // ì˜µì…˜ ë¸”ë¡ ë¦¬ì…‹
    function resetOptionsBlock() {
      if (!currentProduct || !currentProduct.results || currentProduct.results.length === 0) {
        showToast('ì˜µì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      // ê¸°ì¡´ ì˜µì…˜ ë¸”ë¡ ì°¾ì•„ì„œ ì œê±°
      detailBlocks = detailBlocks.filter(b => b.type !== 'options');

      // ìƒˆ ì˜µì…˜ ë¸”ë¡ ìƒì„±
      const newOptionsBlock = generateOptionsBlock(currentProduct);

      // ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…
      let insertIndex = 0;
      for (let i = 0; i < detailBlocks.length; i++) {
        if (detailBlocks[i].type === 'heading' && detailBlocks[i].level === 'h1') {
          insertIndex = i + 1;
          break;
        }
        if (detailBlocks[i].type === 'image') {
          insertIndex = i + 1;
          break;
        }
      }

      detailBlocks.splice(insertIndex, 0, newOptionsBlock);
      renderBlocks();
      updatePreview();
      showToast('ì˜µì…˜ ë¸”ë¡ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }

    // HTMLì„ ë¸”ë¡ìœ¼ë¡œ íŒŒì‹± (ìˆœì„œ ìœ ì§€, ì´ë¯¸ì§€/í…ìŠ¤íŠ¸/í…Œì´ë¸” ë“± ëª¨ë‘ íŒŒì‹±)
    function parseHtmlToBlocks(html) {
      if (!html || html.trim() === '') return [];

      const blocks = [];
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;

      // ìµœìƒìœ„ ì»¨í…Œì´ë„ˆ ì°¾ê¸° (ë³´í†µ max-width div)
      let container = tempDiv.querySelector('div[style*="max-width"]') || tempDiv;

      // ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  ìš”ì†Œë¥¼ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
      function processElement(element) {
        const children = element.childNodes;

        for (let i = 0; i < children.length; i++) {
          const node = children[i];

          // í…ìŠ¤íŠ¸ ë…¸ë“œëŠ” ê±´ë„ˆë›°ê¸° (ì˜ë¯¸ ìˆëŠ” í…ìŠ¤íŠ¸ëŠ” ìš”ì†Œ ì•ˆì— ìˆìŒ)
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent.trim();
            // ì˜ë¯¸ ìˆëŠ” ë‹¨ë… í…ìŠ¤íŠ¸ë§Œ ì¶”ê°€ (ìµœì†Œ 10ì ì´ìƒ)
            if (text && text.length > 10 && !text.includes('\n')) {
              blocks.push({ type: 'text', content: text });
            }
            continue;
          }

          if (node.nodeType !== Node.ELEMENT_NODE) continue;

          const tagName = node.tagName.toLowerCase();

          // ì œëª© ì²˜ë¦¬ (h1~h6)
          if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
            const text = node.textContent.trim();
            if (text) {
              blocks.push({ type: 'heading', content: text, level: tagName });
            }
            continue;
          }

          // ì´ë¯¸ì§€ ì²˜ë¦¬
          if (tagName === 'img') {
            const src = node.getAttribute('src');
            if (src) {
              blocks.push({ type: 'image', content: src });
            }
            continue;
          }

          // í…Œì´ë¸” ì²˜ë¦¬
          if (tagName === 'table') {
            blocks.push({ type: 'table', content: node.outerHTML });
            continue;
          }

          // ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬
          if (tagName === 'ul' || tagName === 'ol') {
            blocks.push({ type: 'list', content: node.outerHTML });
            continue;
          }

          // div, p ë“± ì»¨í…Œì´ë„ˆ ì²˜ë¦¬
          if (['div', 'p', 'section', 'article', 'span'].includes(tagName)) {
            // ì§ì ‘ ìì‹ìœ¼ë¡œ íŠ¹ìˆ˜ ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸
            const directImg = node.querySelector(':scope > img');
            const directTable = node.querySelector(':scope > table');
            const directList = node.querySelector(':scope > ul, :scope > ol');
            const directHeading = node.querySelector(':scope > h1, :scope > h2, :scope > h3, :scope > h4, :scope > h5, :scope > h6');

            // ë³µí•© ì»¨í…Œì´ë„ˆë©´ ì¬ê·€ ì²˜ë¦¬
            if (directImg || directTable || directList || directHeading || node.children.length > 1) {
              processElement(node);
              continue;
            }

            // ë‚´ë¶€ì— ì´ë¯¸ì§€ë§Œ ìˆëŠ” ê²½ìš°
            const imgs = node.querySelectorAll('img');
            if (imgs.length > 0) {
              imgs.forEach(img => {
                const src = img.getAttribute('src');
                if (src) {
                  blocks.push({ type: 'image', content: src });
                }
              });
              continue;
            }

            // ë‚´ë¶€ì— í…Œì´ë¸”ë§Œ ìˆëŠ” ê²½ìš°
            const tables = node.querySelectorAll('table');
            if (tables.length > 0) {
              tables.forEach(table => {
                blocks.push({ type: 'table', content: table.outerHTML });
              });
              continue;
            }

            // ë‚´ë¶€ì— ë¦¬ìŠ¤íŠ¸ë§Œ ìˆëŠ” ê²½ìš°
            const lists = node.querySelectorAll('ul, ol');
            if (lists.length > 0) {
              lists.forEach(list => {
                blocks.push({ type: 'list', content: list.outerHTML });
              });
              continue;
            }

            // ìˆœìˆ˜ í…ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ
            const text = node.textContent.trim();
            if (text) {
              const style = node.getAttribute('style') || '';
              blocks.push({ type: 'text', content: text, style: style });
            }
            continue;
          }

          // ê¸°íƒ€ ìš”ì†ŒëŠ” ì¬ê·€ ì²˜ë¦¬
          if (node.children && node.children.length > 0) {
            processElement(node);
          }
        }
      }

      processElement(container);

      return blocks;
    }

    // ë¸”ë¡ ë Œë”ë§
    function renderBlocks() {
      const editor = document.getElementById('detailEditor');

      if (detailBlocks.length === 0) {
        editor.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“„</div>
            <p>ìƒì„¸í˜ì´ì§€ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
            <p style="font-size: 13px; margin-top: 8px;">ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ë¯¸ì§€ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
          </div>
        `;
        return;
      }

      editor.innerHTML = detailBlocks.map((block, index) => {
        const dragAttrs = `draggable="true" data-index="${index}"
                 ondragstart="handleDragStart(event, ${index})"
                 ondragend="handleDragEnd(event)"
                 ondragover="handleDragOver(event, ${index})"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, ${index})"`;

        if (block.type === 'image') {
          return `
            <div class="editor-block" ${dragAttrs}>
              <div class="block-header">
                <span class="block-type">ğŸ–¼ï¸ ì´ë¯¸ì§€</span>
                <div class="block-actions">
                  <button onclick="moveBlockUp(${index})">â†‘</button>
                  <button onclick="moveBlockDown(${index})">â†“</button>
                  <button onclick="editImageUrl(${index})">URL ë³€ê²½</button>
                  <button class="danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
                </div>
              </div>
              <div class="block-content">
                <img src="${block.content}" alt="ìƒì„¸ì´ë¯¸ì§€ ${index + 1}"
                     onclick="openImageModal('${block.content}')"
                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2212%22 text-anchor=%22middle%22 fill=%22%23999%22>ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨</text></svg>'">
              </div>
            </div>
          `;
        } else if (block.type === 'heading') {
          return `
            <div class="editor-block" ${dragAttrs}>
              <div class="block-header">
                <span class="block-type">ğŸ“Œ ì œëª© (${block.level || 'h2'})</span>
                <div class="block-actions">
                  <button onclick="moveBlockUp(${index})">â†‘</button>
                  <button onclick="moveBlockDown(${index})">â†“</button>
                  <button class="danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
                </div>
              </div>
              <div class="block-content">
                <input type="text" value="${escapeHtmlAttr(block.content)}"
                       onchange="updateBlockContent(${index}, this.value); updatePreview()"
                       style="width: 100%; padding: 12px; font-size: 18px; font-weight: bold; border: 1px solid #e5e8eb; border-radius: 6px;">
              </div>
            </div>
          `;
        } else if (block.type === 'options') {
          // ì˜µì…˜ ì „ìš© ë¸”ë¡ - ì‚­ì œì™€ ìˆœì„œ ë³€ê²½ë§Œ ê°€ëŠ¥
          return `
            <div class="editor-block" ${dragAttrs} style="border: 2px solid #f59e0b;">
              <div class="block-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <span class="block-type" style="color: white;">ğŸ›’ ì˜µì…˜ ë¸”ë¡</span>
                <div class="block-actions">
                  <button onclick="moveBlockUp(${index})" style="background: rgba(255,255,255,0.2); color: white;">â†‘</button>
                  <button onclick="moveBlockDown(${index})" style="background: rgba(255,255,255,0.2); color: white;">â†“</button>
                  <button class="danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
                </div>
              </div>
              <div class="block-content" style="overflow-x: auto;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #92400e;">
                  ${block.title || 'êµ¬ë§¤ ì˜µì…˜'} (${currentProduct?.results?.length || 0}ê°œ)
                </div>
                ${block.content}
              </div>
            </div>
          `;
        } else if (block.type === 'table') {
          return `
            <div class="editor-block" ${dragAttrs}>
              <div class="block-header">
                <span class="block-type">ğŸ“Š í…Œì´ë¸”</span>
                <div class="block-actions">
                  <button onclick="moveBlockUp(${index})">â†‘</button>
                  <button onclick="moveBlockDown(${index})">â†“</button>
                  <button class="danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
                </div>
              </div>
              <div class="block-content" style="overflow-x: auto;">
                ${block.content}
              </div>
            </div>
          `;
        } else if (block.type === 'list') {
          return `
            <div class="editor-block" ${dragAttrs}>
              <div class="block-header">
                <span class="block-type">ğŸ“‹ ë¦¬ìŠ¤íŠ¸</span>
                <div class="block-actions">
                  <button onclick="moveBlockUp(${index})">â†‘</button>
                  <button onclick="moveBlockDown(${index})">â†“</button>
                  <button class="danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
                </div>
              </div>
              <div class="block-content">
                ${block.content}
              </div>
            </div>
          `;
        } else {
          // text ë¸”ë¡
          return `
            <div class="editor-block" ${dragAttrs}>
              <div class="block-header">
                <span class="block-type">ğŸ“ í…ìŠ¤íŠ¸</span>
                <div class="block-actions">
                  <button onclick="moveBlockUp(${index})">â†‘</button>
                  <button onclick="moveBlockDown(${index})">â†“</button>
                  <button class="danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
                </div>
              </div>
              <div class="block-content">
                <textarea onchange="updateBlockContent(${index}, this.value)"
                          oninput="updatePreview()">${block.content}</textarea>
              </div>
            </div>
          `;
        }
      }).join('');
    }

    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updatePreview() {
      const previewContent = document.getElementById('previewContent');

      if (detailBlocks.length === 0) {
        previewContent.innerHTML = '<div class="empty-state"><p>ë¯¸ë¦¬ë³´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      previewContent.innerHTML = detailBlocks.map((block, index) => {
        if (block.type === 'image') {
          return `<img src="${block.content}" alt="ìƒì„¸ì´ë¯¸ì§€ ${index + 1}" style="width: 100%; display: block; margin-bottom: 8px;">`;
        } else if (block.type === 'heading') {
          const level = block.level || 'h2';
          const fontSize = level === 'h1' ? '24px' : level === 'h2' ? '20px' : '16px';
          return `<${level} style="font-size: ${fontSize}; font-weight: bold; margin: 16px 0 8px 0; color: #333;">${block.content}</${level}>`;
        } else if (block.type === 'options') {
          return `
            <div style="margin-bottom: 16px;">
              <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #333;">${block.title || 'êµ¬ë§¤ ì˜µì…˜'}</h2>
              ${block.content}
            </div>
          `;
        } else if (block.type === 'table') {
          return `<div style="margin-bottom: 12px; overflow-x: auto;">${block.content}</div>`;
        } else if (block.type === 'list') {
          return `<div style="margin-bottom: 12px;">${block.content}</div>`;
        } else {
          return `<div style="padding: 12px; background: #f9f9f9; margin-bottom: 8px; border-radius: 4px; font-size: 14px; line-height: 1.6;">${block.content.replace(/\n/g, '<br>')}</div>`;
        }
      }).join('');
    }

    // HTML ì†ì„±ê°’ ì´ìŠ¤ì¼€ì´í”„
    function escapeHtmlAttr(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
    function handleDragStart(event, index) {
      draggedBlockIndex = index;
      event.currentTarget.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', index);
    }

    function handleDragEnd(event) {
      event.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.editor-block').forEach(el => {
        el.classList.remove('drag-over');
      });
      draggedBlockIndex = null;
    }

    function handleDragOver(event, index) {
      event.preventDefault();
      if (draggedBlockIndex === null || draggedBlockIndex === index) return;
      event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(event, targetIndex) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (draggedBlockIndex === null || draggedBlockIndex === targetIndex) {
        draggedBlockIndex = null;
        return;
      }

      // ë¸”ë¡ ìˆœì„œ ë³€ê²½
      const draggedBlock = detailBlocks[draggedBlockIndex];
      detailBlocks.splice(draggedBlockIndex, 1);
      detailBlocks.splice(targetIndex, 0, draggedBlock);

      draggedBlockIndex = null;
      renderBlocks();
      updatePreview();
      showToast('ë¸”ë¡ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ë¸”ë¡ ì´ë™ (ë²„íŠ¼)
    function moveBlockUp(index) {
      if (index <= 0) return;
      [detailBlocks[index], detailBlocks[index - 1]] = [detailBlocks[index - 1], detailBlocks[index]];
      renderBlocks();
      updatePreview();
    }

    function moveBlockDown(index) {
      if (index >= detailBlocks.length - 1) return;
      [detailBlocks[index], detailBlocks[index + 1]] = [detailBlocks[index + 1], detailBlocks[index]];
      renderBlocks();
      updatePreview();
    }

    // ë¸”ë¡ ì‚­ì œ
    function deleteBlock(index) {
      if (!confirm('ì´ ë¸”ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      detailBlocks.splice(index, 1);
      renderBlocks();
      updatePreview();
      showToast('ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ë¸”ë¡ ë‚´ìš© ì—…ë°ì´íŠ¸ (í…ìŠ¤íŠ¸)
    function updateBlockContent(index, content) {
      detailBlocks[index].content = content;
    }

    // ì´ë¯¸ì§€ URL ë³€ê²½ ëª¨ë‹¬
    function editImageUrl(index) {
      editingBlockIndex = index;
      document.getElementById('imageUrlInput').value = detailBlocks[index].content;
      document.getElementById('urlEditModal').classList.add('active');
    }

    function closeUrlEditModal() {
      document.getElementById('urlEditModal').classList.remove('active');
      editingBlockIndex = null;
    }

    function confirmUrlChange() {
      const newUrl = document.getElementById('imageUrlInput').value.trim();
      if (!newUrl) {
        showToast('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      if (editingBlockIndex !== null) {
        detailBlocks[editingBlockIndex].content = newUrl;
        renderBlocks();
        updatePreview();
        showToast('ì´ë¯¸ì§€ URLì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }

      closeUrlEditModal();
    }

    // ë¸”ë¡ ì¶”ê°€
    function addBlock(type) {
      if (type === 'image') {
        const url = prompt('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (url && url.trim()) {
          detailBlocks.push({ type: 'image', content: url.trim() });
          renderBlocks();
          updatePreview();
          showToast('ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
      } else if (type === 'text') {
        detailBlocks.push({ type: 'text', content: 'í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...' });
        renderBlocks();
        updatePreview();
        showToast('í…ìŠ¤íŠ¸ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }
    }

    // ìƒì„¸í˜ì´ì§€ ì €ì¥
    async function saveDetailPage() {
      if (!currentProduct) {
        showToast('ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      // ë¸”ë¡ì„ HTMLë¡œ ë³€í™˜ (ì›ë³¸ êµ¬ì¡° ìœ ì§€)
      const htmlParts = detailBlocks.map(block => {
        if (block.type === 'image') {
          return `<div style="margin-bottom: 20px; text-align: center;"><img src="${block.content}" style="max-width: 100%; height: auto; border-radius: 8px;"></div>`;
        } else if (block.type === 'heading') {
          const level = block.level || 'h2';
          const fontSize = level === 'h1' ? '28px' : level === 'h2' ? '20px' : '16px';
          return `<${level} style="font-size: ${fontSize}; font-weight: bold; margin-bottom: 12px; color: #333;">${block.content}</${level}>`;
        } else if (block.type === 'options') {
          // ì˜µì…˜ ë¸”ë¡ì€ ì œëª© + í…Œì´ë¸”ë¡œ ì €ì¥
          return `
            <div style="margin-bottom: 30px;">
              <h2 style="font-size: 20px; margin-bottom: 12px; color: #333;">${block.title || 'êµ¬ë§¤ ì˜µì…˜'}</h2>
              ${block.content}
            </div>
          `;
        } else if (block.type === 'table') {
          return block.content; // í…Œì´ë¸”ì€ ì›ë³¸ HTML ê·¸ëŒ€ë¡œ
        } else if (block.type === 'list') {
          return block.content; // ë¦¬ìŠ¤íŠ¸ë„ ì›ë³¸ HTML ê·¸ëŒ€ë¡œ
        } else {
          // í…ìŠ¤íŠ¸ ë¸”ë¡
          const style = block.style || 'padding: 12px; font-size: 14px; line-height: 1.6;';
          return `<div style="${style}">${block.content.replace(/\n/g, '<br>')}</div>`;
        }
      });

      // ì „ì²´ë¥¼ ë˜í¼ë¡œ ê°ì‹¸ê¸°
      const html = `<div style="max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif;">\n${htmlParts.join('\n')}\n</div>`;

      try {
        const response = await authFetch(`/api/products/${currentProduct.id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            detailHtml: html
          })
        });

        if (!response) return;

        const data = await response.json();
        if (data.success) {
          currentProduct.detailHtml = html;
          showToast('ìƒì„¸í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
          throw new Error(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
      }
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„ (srcdocìš©)
    function escapeHtml(html) {
      return html
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // SKU í…Œì´ë¸” ë Œë”ë§
    function renderSkuTable() {
      const p = currentProduct;
      const skuStatus = p.skuStatus;
      const options = p.results || p.options || [];

      // ë°˜ë ¤ ì„¹ì…˜
      const rejectionSection = document.getElementById('rejectionSection');
      if (p.isRejected || (skuStatus && skuStatus.rejected > 0)) {
        rejectionSection.style.display = 'block';
        document.getElementById('rejectionReason').textContent =
          p.rejectionReason || 'ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì¿ íŒ¡WINGì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.';
      } else {
        rejectionSection.style.display = 'none';
      }

      const tbody = document.getElementById('skuTableBody');

      if (!skuStatus || !skuStatus.skuDetails) {
        // SKU ìƒì„¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì˜µì…˜ ëª©ë¡ìœ¼ë¡œ í‘œì‹œ
        if (options.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">SKU ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
          tbody.innerHTML = options.map((opt, i) => {
            const optName = opt.optionName1 || opt.optionName1Cn || opt.name || `ì˜µì…˜ ${i + 1}`;
            const optName2 = opt.optionName2 || opt.optionName2Cn || '';
            const fullName = optName2 ? `${optName} / ${optName2}` : optName;
            return `
              <tr>
                <td>-</td>
                <td>${fullName}</td>
                <td>${opt.price ? Number(opt.price).toLocaleString() + 'ì›' : '-'}</td>
                <td><span class="sku-status pending">ë¯¸í™•ì¸</span></td>
                <td>-</td>
              </tr>
            `;
          }).join('');
        }
      } else {
        tbody.innerHTML = skuStatus.skuDetails.map(sku => {
          let statusClass = 'pending';
          let statusText = 'ì‹¬ì‚¬ì¤‘';

          if (sku.status === 'approved' || sku.stage === 'R21') {
            statusClass = 'approved';
            statusText = 'ìŠ¹ì¸';
          } else if (sku.status === 'rejected') {
            statusClass = 'rejected';
            statusText = 'ë°˜ë ¤';
          }

          return `
            <tr>
              <td>${sku.skuId || '-'}</td>
              <td>${sku.optionName || '-'}</td>
              <td>${sku.price ? sku.price.toLocaleString() + 'ì›' : '-'}</td>
              <td><span class="sku-status ${statusClass}">${statusText}</span></td>
              <td>${sku.stage || '-'}</td>
            </tr>
          `;
        }).join('');
      }
    }

    // ì›ë³¸ ì •ë³´ ë Œë”ë§
    function renderOriginalInfo() {
      const p = currentProduct;
      // results ë°°ì—´ì—ì„œ ì²« ë²ˆì§¸ í•­ëª©ì˜ link ì‚¬ìš©
      const sourceUrl = p.link || (p.results?.[0]?.link) || p.url || p.sourceUrl || '';
      const sourceType = detectSourceType(sourceUrl);

      document.getElementById('originalInfo').innerHTML = `
        <div class="action-bar" style="margin-bottom: 20px;">
          ${sourceUrl ? `
            <a href="${sourceUrl}" target="_blank" class="btn btn-primary">
              <span>ğŸ”—</span> ì›ë³¸ í˜ì´ì§€ ì—´ê¸°
            </a>
          ` : ''}
          <button class="btn btn-secondary" onclick="copyToClipboard('${p.titleCn || ''}')">
            <span>ğŸ“‹</span> ì¤‘êµ­ì–´ëª… ë³µì‚¬
          </button>
          ${sourceUrl ? `
            <button class="btn btn-secondary" onclick="copyToClipboard('${sourceUrl}')">
              <span>ğŸ”—</span> ë§í¬ ë³µì‚¬
            </button>
          ` : ''}
        </div>

        <div class="info-cards">
          <div class="info-card">
            <div class="info-card-header">ğŸ“ ìƒí’ˆëª…</div>
            <div class="info-card-body">
              <div class="info-row">
                <span class="info-label">ì›ë³¸ (ì¤‘êµ­ì–´)</span>
                <span class="info-value chinese">${p.titleCn || '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ë²ˆì—­</span>
                <span class="info-value">${p.title || '-'}</span>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-card-header">ğŸ”— ì†Œì‹± ì •ë³´</div>
            <div class="info-card-body">
              <div class="info-row">
                <span class="info-label">ì†Œì‹±ì²˜</span>
                <span class="info-value">${sourceType}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ì›ë³¸ ë§í¬</span>
                <span class="info-value" style="word-break: break-all;">
                  ${sourceUrl ? `<a href="${sourceUrl}" target="_blank" style="color: #667eea;">${sourceUrl.substring(0, 60)}${sourceUrl.length > 60 ? '...' : ''}</a>` : '-'}
                </span>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-card-header">ğŸ’° ê°€ê²© ì •ë³´</div>
            <div class="info-card-body">
              <div class="info-row">
                <span class="info-label">ì›ë³¸ ê°€ê²©</span>
                <span class="info-value">${getOriginalPrice(p)}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ì˜µì…˜ ìˆ˜</span>
                <span class="info-value">${p.results?.length || '-'}ê°œ</span>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-card-header">ğŸ“… ê¸°íƒ€ ì •ë³´</div>
            <div class="info-card-body">
              <div class="info-row">
                <span class="info-label">ìˆ˜ì§‘ ì¼ì‹œ</span>
                <span class="info-value">${p.savedAt ? new Date(p.savedAt).toLocaleString('ko-KR') : '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ìƒí’ˆ ID</span>
                <span class="info-value" style="font-size: 12px;">${p.id || '-'}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function detectSourceType(url) {
      if (!url) return '-';
      if (url.includes('1688.com')) return '1688';
      if (url.includes('taobao.com')) return 'íƒ€ì˜¤ë°”ì˜¤';
      if (url.includes('tmall.com')) return 'í‹°ëª°';
      if (url.includes('aliexpress.com')) return 'ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤';
      return 'ê¸°íƒ€';
    }

    function getOriginalPrice(p) {
      // resultsì—ì„œ ê°€ê²© ì¶”ì¶œ
      if (p.results && p.results.length > 0) {
        const prices = p.results
          .flatMap(r => r.optionName2Price || [])
          .filter(p => p && p !== '')
          .map(p => parseFloat(p));

        if (prices.length > 0) {
          const min = Math.min(...prices);
          const max = Math.max(...prices);
          return min === max ? `Â¥${min}` : `Â¥${min} ~ Â¥${max}`;
        }
      }
      if (p.priceMin) return `Â¥${p.priceMin}` + (p.priceMax && p.priceMax !== p.priceMin ? ` ~ Â¥${p.priceMax}` : '');
      return '-';
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }).catch(() => {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      });
    }

    // ì´ë¯¸ì§€ ëª¨ë‹¬
    function openImageModal(src) {
      document.getElementById('modalImage').src = src;
      document.getElementById('imageModal').classList.add('active');
    }

    function closeImageModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    async function downloadImage(url, filename) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${filename}.jpg`;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
      } catch (error) {
        showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    // ì „ì²´ ì˜µì…˜ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    async function downloadAllOptionImages() {
      const p = currentProduct;
      if (!p) return;

      showToast('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...', 'info');

      const images = [];

      // ë©”ì¸ ì´ë¯¸ì§€ (titleImage ì‚¬ìš©)
      (p.titleImage || p.images || []).forEach((img, i) => {
        images.push({ url: img, name: `main_${i + 1}` });
      });

      // ì˜µì…˜ ì´ë¯¸ì§€ (resultsì˜ option1Img ë˜ëŠ” imageLink ì‚¬ìš©) - ì¤‘ë³µ ì œê±°
      const options = p.results || [];
      const seenUrls = new Set();
      let optIndex = 1;
      options.forEach((opt) => {
        const imgUrl = opt.option1Img || opt.imageLink || opt.optionImage || opt.image;
        if (imgUrl && !seenUrls.has(imgUrl)) {
          seenUrls.add(imgUrl);
          const optName = opt.optionName1 || opt.optionName1Cn || opt.name || '';
          images.push({ url: imgUrl, name: `option_${optIndex}_${optName}`.replace(/[^a-zA-Z0-9ê°€-í£_]/g, '') });
          optIndex++;
        }
      });

      if (images.length === 0) {
        showToast('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      // ìˆœì°¨ ë‹¤ìš´ë¡œë“œ
      for (let i = 0; i < images.length; i++) {
        await downloadImage(images[i].url, images[i].name);
        await new Promise(r => setTimeout(r, 300)); // ë”œë ˆì´
      }

      showToast(`${images.length}ê°œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, 'success');
    }

    // ìƒì„¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    async function downloadDetailImages() {
      const p = currentProduct;
      if (!p) return;

      const images = p.detailImages || p.descriptionImages || [];

      if (images.length === 0) {
        showToast('ë‹¤ìš´ë¡œë“œí•  ìƒì„¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      showToast('ìƒì„¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...', 'info');

      for (let i = 0; i < images.length; i++) {
        await downloadImage(images[i], `detail_${i + 1}`);
        await new Promise(r => setTimeout(r, 300));
      }

      showToast(`${images.length}ê°œ ìƒì„¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, 'success');
    }

    // í¸ì§‘ê¸°ì—ì„œ ì—´ê¸°
    function openInEditor(type) {
      const p = currentProduct;
      if (!p) return;

      if (type === 'options') {
        window.open(`option-editor.html?productId=${p.id}`, '_blank');
      } else if (type === 'detail') {
        window.open(`editor.html?productId=${p.id}`, '_blank');
      }
    }

    // ì¿ íŒ¡WING ì—´ê¸°
    function openCoupangWing() {
      const p = currentProduct;
      if (p && p.quoteId) {
        window.open(`https://wing.coupang.com/vendor-inventory/quotations/${p.quoteId}`, '_blank');
      } else {
        window.open('https://wing.coupang.com/vendor-inventory/quotations', '_blank');
      }
    }

    // ì¬ì œì¶œ ì¤€ë¹„
    function prepareResubmit() {
      showToast('ë°˜ë ¤ íšŒì‹  ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
      // TODO: ë°˜ë ¤ íšŒì‹  ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ë¡œ ì´ë™
    }

    // ESCë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeImageModal();
        closeUrlEditModal();
      }
    });

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      if (!checkAuth()) return;
      loadProduct();
    });
  </script>
</body>
</html>
