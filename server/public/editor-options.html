<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TotalBot - 옵션 편집</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f7;
      color: #333;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #1e90ff;
      color: white;
    }

    .btn-primary:hover {
      background: #1873cc;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }

    .editor-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .product-name-section {
      padding: 24px;
      border-bottom: 1px solid #e5e8eb;
    }

    .product-name-section h2 {
      font-size: 18px;
      margin-bottom: 12px;
    }

    .product-name-section input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }

    .product-name-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-ai-title {
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-ai-title:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-ai-title:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-ai-title .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    /* 메인 탭 */
    .main-tabs {
      display: flex;
      gap: 4px;
      background: #f9fafb;
      padding: 0 24px;
      border-bottom: 2px solid #e5e8eb;
    }

    .main-tab {
      background: transparent;
      border: none;
      padding: 16px 24px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .main-tab:hover {
      color: #333;
      background: rgba(0,0,0,0.02);
    }

    .main-tab.active {
      color: #1e90ff;
      font-weight: 600;
      border-bottom-color: #1e90ff;
      background: white;
    }

    .main-tab-content {
      display: none;
    }

    .main-tab-content.active {
      display: block;
    }

    /* 이미지 탭 레이아웃 */
    .images-grid-layout {
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .image-section {
      background: white;
    }

    .image-section h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #333;
      font-weight: 600;
    }

    .preview-image-large {
      width: 100%;
      max-width: 600px;
      border-radius: 8px;
      border: 2px solid #e5e8eb;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preview-image-large:hover {
      border-color: #1e90ff;
      box-shadow: 0 2px 8px rgba(30,144,255,0.2);
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    /* 이미지 컨테이너 (공통) */
    .image-item-container {
      position: relative;
      cursor: pointer;
      border-radius: 6px;
      overflow: hidden;
    }

    .image-item-container img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 6px;
      border: 2px solid #e5e8eb;
      transition: all 0.2s;
      display: block;
      position: relative;
      z-index: 2;
    }

    .image-item-container:hover img {
      border-color: #1e90ff;
      transform: scale(1.02);
    }

    /* 편집 버튼 (hover시 표시) */
    .image-edit-btn {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(30, 144, 255, 0.95), rgba(20, 120, 220, 0.95));
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(30, 144, 255, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8px);
      cursor: pointer;
      z-index: 10;
      letter-spacing: 0.5px;
    }

    .image-item-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0);
      transition: all 0.3s ease;
      z-index: 1;
      pointer-events: none;
      border-radius: 6px;
    }

    .image-item-container:hover::before {
      background: rgba(0, 0, 0, 0.3);
    }

    .image-item-container:hover .image-edit-btn {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1.05);
    }

    .image-edit-btn:hover {
      background: linear-gradient(135deg, rgba(20, 120, 220, 1), rgba(15, 100, 200, 1));
      box-shadow: 0 6px 20px rgba(30, 144, 255, 0.5), 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: translateX(-50%) scale(1.1);
    }

    .image-edit-btn:active {
      transform: translateX(-50%) scale(1.02);
    }

    /* 추가 이미지 선택 기능 */
    .additional-image-item.selected img {
      border: 3px solid #1e90ff !important;
      box-shadow: 0 0 0 3px rgba(30,144,255,0.2);
    }

    .additional-image-item.selected::after {
      content: '✓';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: #1e90ff;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      z-index: 15;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* 옵션 이미지 선택 기능 */
    .option-image-item.selected img {
      border: 3px solid #28a745 !important;
      box-shadow: 0 0 0 3px rgba(40,167,69,0.2);
    }

    .option-image-item.selected::after {
      content: '✓';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: #28a745;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      z-index: 15;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* 옵션 이미지 개수 표시 */
    .option-image-count {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      z-index: 15;
      backdrop-filter: blur(4px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    /* 옵션 이미지 삭제 버튼 */
    .image-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    .image-item-container:hover .image-delete-btn {
      opacity: 1;
      transform: scale(1);
    }

    .image-delete-btn:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: scale(1.1);
    }

    /* 옵션 이미지 교체 버튼 */
    .image-replace-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .image-item-container:hover .image-replace-btn {
      opacity: 1;
      transform: scale(1);
    }

    .image-replace-btn:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: scale(1.1);
    }

    /* 숨겨진 파일 인풋 */
    .hidden-file-input {
      display: none;
    }

    /* 상세페이지 에디터 */
    .detail-page-editor {
      padding: 24px;
    }

    .detail-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e8eb;
    }

    .detail-toolbar h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .toolbar-actions {
      display: flex;
      gap: 12px;
    }

    .detail-content {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
      min-height: 600px;
    }

    .detail-sources {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #e5e8eb;
      overflow-y: auto;
      max-height: 700px;
    }

    .source-section h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      color: #333;
    }

    .source-group {
      margin-bottom: 20px;
    }

    .source-group h5 {
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .source-images {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .source-image-item {
      position: relative;
      cursor: grab;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid #e5e8eb;
      transition: all 0.2s;
    }

    .source-image-item:active {
      cursor: grabbing;
    }

    .source-image-item:hover {
      border-color: #1e90ff;
      transform: scale(1.05);
    }

    .source-image-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }

    /* 드롭다운 박스 스타일 */
    .dropdown-box {
      background: white;
      border: 2px solid #e5e8eb;
      border-radius: 10px;
      margin-bottom: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .dropdown-box:hover {
      border-color: #1e90ff;
      box-shadow: 0 2px 8px rgba(30, 144, 255, 0.1);
    }

    .dropdown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px;
      cursor: pointer;
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      transition: all 0.2s ease;
      user-select: none;
    }

    .dropdown-header:hover {
      background: linear-gradient(to right, #f0f2f5, #f8f9fa);
    }

    .dropdown-header.active {
      background: linear-gradient(to right, rgba(30, 144, 255, 0.05), rgba(30, 144, 255, 0.02));
    }

    .dropdown-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 14px;
      color: #1a1a1a;
    }

    .dropdown-icon {
      font-size: 18px;
    }

    .dropdown-arrow {
      font-size: 20px;
      color: #666;
      transition: transform 0.3s ease;
    }

    .dropdown-header.active .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 18px;
    }

    .dropdown-content.active {
      max-height: 600px;
      overflow-y: auto;
      padding: 18px;
      border-top: 1px solid #e5e8eb;
    }

    .dropdown-content::-webkit-scrollbar {
      width: 6px;
    }

    .dropdown-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .dropdown-content::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .dropdown-content::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    /* 템플릿 그리드 */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .template-item {
      cursor: pointer;
      border: 2px solid #e5e8eb;
      border-radius: 8px;
      padding: 8px;
      transition: all 0.2s;
      background: white;
    }

    .template-item:hover {
      border-color: #1e90ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(30, 144, 255, 0.15);
    }

    .template-item.active {
      border-color: #1e90ff;
      background: rgba(30, 144, 255, 0.05);
    }

    .template-preview {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px;
      background: #fafbfc;
      border-radius: 4px;
      margin-bottom: 6px;
      min-height: 50px;
    }

    .template-preview-vertical {
      flex-direction: column;
      align-items: stretch;
    }

    .template-preview-card {
      border: 1px solid #e5e8eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .template-preview-gradient {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      border-left: 3px solid #1e90ff;
    }

    .template-preview-img {
      width: 30px;
      height: 30px;
      background: #ddd;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: #888;
      font-weight: 600;
      flex-shrink: 0;
    }

    .template-preview-vertical .template-preview-img {
      width: 100%;
      height: 35px;
    }

    .template-preview-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .template-name {
      text-align: center;
      font-size: 11px;
      color: #666;
      font-weight: 600;
    }

    .template-item.active .template-name {
      color: #1e90ff;
    }

    .template-select-inline {
      padding: 6px 10px;
      border: 1px solid #e5e8eb;
      border-radius: 4px;
      font-size: 12px;
      background: white;
      cursor: pointer;
      margin: 6px 0;
      width: 100%;
    }

    .template-select-inline:focus {
      outline: none;
      border-color: #1e90ff;
    }

    .detail-canvas {
      background: white;
      border-radius: 8px;
      border: 2px dashed #e5e8eb;
      padding: 24px;
    }

    .canvas-header h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #333;
    }

    .canvas-header .hint {
      margin: 0 0 20px 0;
      font-size: 13px;
      color: #888;
    }

    .detail-page-items {
      min-height: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .detail-page-item {
      background: white;
      border: 2px solid #e5e8eb;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: move;
      transition: all 0.2s;
    }

    .detail-page-item:hover {
      border-color: #1e90ff;
      box-shadow: 0 2px 8px rgba(30, 144, 255, 0.1);
    }

    .detail-page-item.dragging {
      opacity: 0.5;
    }

    .detail-page-item.drag-over {
      border-color: #1e90ff;
      border-style: solid;
      background: rgba(30, 144, 255, 0.05);
    }

    /* 옵션 블록 스타일 */
    .detail-page-item.option-block {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: white;
      border: 1px solid #e5e8eb;
    }

    .option-block-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .option-block-image {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
      font-weight: 600;
      flex-shrink: 0;
    }

    .option-block-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .option-block-title {
      font-size: 15px;
      font-weight: 700;
      color: #1a1a1a;
      padding: 0;
      cursor: text;
      line-height: 1.4;
    }

    .option-block-title:hover {
      color: #1e90ff;
    }

    .option-block-title:focus {
      outline: none;
      color: #1e90ff;
    }

    .option-block-subtitle {
      font-size: 12px;
      color: #666;
      line-height: 1.6;
      cursor: text;
      padding: 0;
    }

    .option-block-subtitle:hover {
      color: #333;
    }

    .option-block-subtitle:focus {
      outline: none;
      color: #1e90ff;
    }

    /* 품질표시사항 블록 */
    .detail-page-item.quality-table {
      display: block;
      padding: 20px;
      background: #fafbfc;
    }

    .quality-table-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .quality-table-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      cursor: text;
      background: white;
      border: 1px solid #e5e8eb;
    }

    .quality-table-title:hover {
      border-color: #1e90ff;
    }

    .quality-table-title:focus {
      outline: none;
      border-color: #1e90ff;
      box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
    }

    .quality-table-content {
      background: white;
      border: 1px solid #e5e8eb;
      border-radius: 8px;
      overflow: hidden;
    }

    .quality-table-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      border-bottom: 1px solid #e5e8eb;
    }

    .quality-table-row:last-child {
      border-bottom: none;
    }

    .quality-table-label {
      padding: 12px 16px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 13px;
      color: #555;
      border-right: 1px solid #e5e8eb;
      display: flex;
      align-items: center;
    }

    .quality-table-value {
      padding: 12px 16px;
      font-size: 13px;
      color: #333;
      cursor: text;
    }

    .quality-table-value:hover {
      background: #fafbfc;
    }

    .quality-table-value:focus {
      outline: 2px solid #1e90ff;
      background: white;
    }

    .item-drag-handle {
      color: #999;
      font-size: 24px;
      cursor: move;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .item-drag-handle:hover {
      color: #666;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .item-preview {
      flex-shrink: 0;
    }

    .item-preview-placeholder {
      width: 80px;
      height: 80px;
      background: #f5f5f5;
      border: 2px dashed #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-align: center;
      line-height: 1.3;
    }

    .item-info {
      flex: 1;
    }

    .item-type {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .item-label {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .item-text-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-top: 8px;
    }

    .item-text-display {
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .item-actions {
      display: flex;
      gap: 8px;
    }

    .item-action-btn {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      font-size: 16px;
      transition: all 0.2s;
    }

    .item-action-btn:hover {
      background: #f5f5f5;
      color: #1e90ff;
    }

    .item-action-btn.delete:hover {
      color: #ef4444;
    }

    .add-text-btn {
      width: 100%;
      padding: 16px;
      background: #f9fafb;
      border: 2px dashed #ccc;
      border-radius: 8px;
      color: #666;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 12px;
    }

    .add-text-btn:hover {
      border-color: #1e90ff;
      color: #1e90ff;
      background: rgba(30, 144, 255, 0.05);
    }

    .add-text-btn span {
      font-size: 20px;
      font-weight: bold;
      margin-right: 4px;
    }

    /* 미리보기 모달 */
    .modal-large {
      max-width: 900px;
      width: 90%;
    }

    .detail-preview-content {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
    }

    .detail-preview-content img {
      width: 100%;
      display: block;
      margin-bottom: 0;
      border-radius: 8px;
    }

    .detail-preview-text {
      padding: 20px;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      background: white;
    }

    /* 옵션 테이블 컨테이너 */
    .options-table-container {
      padding: 24px;
      background: white;
      overflow-x: auto;
    }

    /* 상세페이지 탭 */
    .detail-page-editor {
      padding: 24px;
      background: white;
    }

    .detail-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e8eb;
    }

    .detail-preview {
      min-height: 400px;
      border: 1px solid #e5e8eb;
      border-radius: 8px;
      background: #f9fafb;
    }

    .toolbar {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e8eb;
      background: #f9fafb;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar h3 {
      font-size: 16px;
      font-weight: 600;
      margin-right: auto;
    }

    .bulk-edit-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .bulk-edit-group input {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 150px;
    }

    .options-table {
      width: 100%;
      border-collapse: collapse;
    }

    .options-table th {
      background: #f9fafb;
      padding: 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      border-bottom: 2px solid #e5e8eb;
      position: sticky;
      top: 0;
    }

    .options-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .options-table tbody tr:hover {
      background: #f9fafb;
    }

    .options-table input {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 100%;
    }

    .options-table input:focus {
      outline: none;
      border-color: #1e90ff;
      box-shadow: 0 0 0 3px rgba(30,144,255,0.1);
    }

    .price-display {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .profit-positive {
      color: #10b981;
      font-weight: 600;
    }

    .profit-warning {
      color: #ef4444;
      font-weight: 600;
    }

    .option-image-preview {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #e5e8eb;
      cursor: pointer;
    }

    .option-image-preview:hover {
      border-color: #1e90ff;
    }

    .no-image {
      width: 50px;
      height: 50px;
      background: #f0f0f0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #ccc;
    }

    /* 매직 브러쉬 모달 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f0f0f0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }

    .modal-close:hover {
      background: #e0e0e0;
    }

    .modal-body {
      padding: 24px;
    }

    .image-editor-container {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 24px;
    }

    .canvas-container {
      border: 1px solid #e5e8eb;
      border-radius: 8px;
      overflow: auto;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 500px;
      max-height: 70vh;
    }

    .canvas-container canvas {
      display: block;
      cursor: crosshair;
    }

    .canvas-container canvas.eraser-mode {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="none" stroke="red" stroke-width="2"/></svg>') 12 12, crosshair;
    }

    .editor-tools {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tool-group {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
    }

    .tool-group h3 {
      font-size: 14px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .tool-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .tool-btn {
      padding: 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .tool-btn:hover {
      background: #f0f0f0;
      border-color: #1e90ff;
    }

    .tool-btn.active {
      background: #1e90ff;
      color: white;
      border-color: #1e90ff;
    }

    .slider-group {
      margin-top: 12px;
    }

    .slider-group label {
      display: block;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .slider-group input[type="range"] {
      width: 100%;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    /* 옵션 일괄 편집 - 모던 UI */
    .options-toolbar {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 24px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.08);
      border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .options-toolbar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .options-toolbar-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a2e;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .options-toolbar-header h3::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }

    .edit-tabs {
      display: flex;
      gap: 8px;
      background: white;
      padding: 6px;
      border-radius: 12px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
    }

    .edit-tab {
      background: transparent;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .edit-tab::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .edit-tab:hover {
      color: #333;
      background: rgba(102, 126, 234, 0.08);
    }

    .edit-tab.active {
      color: white;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .edit-tab-content {
      display: none;
      animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .edit-tab-content.active {
      display: block;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .edit-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .edit-section-title .icon {
      font-size: 16px;
    }

    .bulk-edit-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .bulk-edit-group input {
      padding: 12px 16px;
      border: 2px solid #e5e8eb;
      border-radius: 10px;
      font-size: 14px;
      width: 180px;
      transition: all 0.2s;
      background: #f9fafb;
    }

    .bulk-edit-group input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .bulk-edit-group input::placeholder {
      color: #aaa;
    }

    .option-select {
      padding: 12px 16px;
      border: 2px solid #e5e8eb;
      border-radius: 10px;
      font-size: 14px;
      background: #f9fafb;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 130px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .option-select:focus {
      outline: none;
      border-color: #667eea;
      background-color: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .arrow-icon {
      font-size: 20px;
      color: #667eea;
      font-weight: bold;
    }

    .btn-action {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-action-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    }

    .btn-action-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
    }

    .btn-action-primary:active {
      transform: translateY(0);
    }

    .btn-action-ai {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.25);
    }

    .btn-action-ai:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.35);
    }

    .btn-action-secondary {
      background: white;
      color: #333;
      border: 2px solid #e5e8eb;
    }

    .btn-action-secondary:hover {
      border-color: #667eea;
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .hint {
      font-size: 13px;
      color: #888;
      margin: 12px 0 0 0;
      padding: 10px 14px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 3px solid #667eea;
    }

    /* AI 옵션 변환 섹션 */
    .ai-section {
      background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
      border: 2px solid rgba(240, 147, 251, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .ai-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .ai-badge {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .ai-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a2e;
    }

    .ai-description {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* 가격 수집 섹션 */
    .price-collect-section {
      padding: 16px 0;
    }

    .price-result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .price-result-box {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
    }

    .price-result-box.rocket {
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      border-color: #fed7aa;
    }

    .price-result-box h4 {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .price-result-box.rocket h4 {
      color: #ea580c;
      border-bottom-color: #fdba74;
    }

    .price-result-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .price-item {
      background: white;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .price-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .price-item.selected {
      border-color: #667eea;
      background: #eef2ff;
    }

    .price-label {
      display: block;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .price-value {
      display: block;
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    .price-count {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }

    .price-result-box.rocket .price-count {
      border-top-color: #fdba74;
    }

    .price-apply-section {
      background: #f0fdf4;
      border: 2px solid #86efac;
      border-radius: 12px;
      padding: 16px;
    }

    .price-apply-header {
      font-size: 14px;
      font-weight: 600;
      color: #166534;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .price-apply-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .price-apply-group span {
      font-size: 13px;
      color: #374151;
    }

    /* 기준가 선택 버튼 */
    .price-base-btn {
      flex: 1;
      min-width: 80px;
      padding: 12px 8px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      color: #64748b;
      transition: all 0.2s;
      line-height: 1.4;
    }

    .price-base-btn:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }

    .price-base-btn.active {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }

    .price-base-btn span {
      display: block;
      font-size: 14px;
      font-weight: 700;
      margin-top: 4px;
    }

    .price-base-btn.active span {
      color: white;
    }

    /* 빠른 조정 버튼 */
    .quick-adjust-btn {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #f8fafc;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #475569;
      transition: all 0.15s;
    }

    .quick-adjust-btn:hover {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    /* 슬라이더 스타일 */
    #priceSlider {
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, #ef4444 0%, #eab308 25%, #22c55e 50%, #eab308 75%, #ef4444 100%);
      border-radius: 10px;
    }

    #priceSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #priceSlider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* 매핑 다이얼로그 개선 */
    .mapping-dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .mapping-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .mapping-dialog-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .mapping-dialog-overlay.active .mapping-dialog-content {
      transform: scale(1) translateY(0);
    }

    .mapping-dialog-header {
      padding: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .mapping-dialog-header h3 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }

    .mapping-dialog-header p {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .mapping-dialog-body {
      padding: 24px;
      max-height: 400px;
      overflow-y: auto;
    }

    .mapping-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .mapping-item:hover {
      background: #f0f4ff;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .mapping-item-number {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }

    .mapping-item-original {
      flex: 1;
      font-size: 14px;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mapping-item-arrow {
      color: #667eea;
      font-size: 18px;
    }

    .mapping-item-input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e5e8eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .mapping-item-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .mapping-dialog-footer {
      padding: 20px 24px;
      background: #f9fafb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* 커스텀 AI 버튼 */
    .btn-custom-ai {
      margin-left: auto;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
    }

    .btn-custom-ai:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
    }

    /* 커스텀 AI 모달 */
    .custom-ai-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      backdrop-filter: blur(4px);
    }

    .custom-ai-modal.active {
      display: flex;
    }

    .custom-ai-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .custom-ai-header {
      background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .custom-ai-header h3 {
      color: white;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .custom-ai-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .custom-ai-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .custom-ai-body {
      padding: 24px;
    }

    .custom-ai-body label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }

    .custom-ai-textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px 16px;
      border: 2px solid #e5e8eb;
      border-radius: 12px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s;
    }

    .custom-ai-textarea:focus {
      outline: none;
      border-color: #a855f7;
      box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.1);
    }

    .custom-ai-textarea::placeholder {
      color: #aaa;
    }

    .custom-ai-select-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      align-items: center;
    }

    .custom-ai-select-row label {
      margin: 0;
      white-space: nowrap;
    }

    .custom-ai-select {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e5e8eb;
      border-radius: 10px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .custom-ai-footer {
      padding: 16px 24px 24px;
      display: flex;
      gap: 12px;
    }

    .btn-custom-cancel {
      flex: 1;
      padding: 14px;
      font-size: 14px;
      font-weight: 600;
      background: #f5f5f5;
      border: none;
      border-radius: 10px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-custom-cancel:hover {
      background: #eee;
    }

    .btn-custom-apply {
      flex: 2;
      padding: 14px;
      font-size: 14px;
      font-weight: 700;
      background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-custom-apply:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
    }

    .btn-custom-apply:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* 매핑 다이얼로그 */
    .mapping-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .mapping-dialog.active {
      display: flex;
    }

    .mapping-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .mapping-content h2 {
      margin: 0 0 20px 0;
      font-size: 20px;
      color: #333;
    }

    .mapping-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .mapping-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .mapping-row input:first-child {
      background: #f0f0f0;
      color: #666;
    }

    .mapping-row input:last-child {
      border: 2px solid #000;
    }

    .mapping-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* 설정 모달 */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      padding: 0;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .settings-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .settings-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .settings-section {
      margin-bottom: 32px;
    }

    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #333;
      font-weight: 600;
      border-bottom: 2px solid #e5e8eb;
      padding-bottom: 8px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-field label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .settings-field input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .settings-main-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-main-tab {
      background: transparent;
      border: none;
      padding: 14px 28px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .settings-main-tab:hover {
      color: #333;
      background: #f5f5f5;
    }

    .settings-main-tab.active {
      color: #1e90ff;
      font-weight: 700;
      border-bottom-color: #1e90ff;
    }

    .settings-main-tab-content {
      display: none;
    }

    .settings-main-tab-content.active {
      display: block;
    }

    .settings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-tab {
      background: transparent;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .settings-tab:hover {
      color: #333;
      background: #f5f5f5;
    }

    .settings-tab.active {
      color: #1e90ff;
      font-weight: 600;
      border-bottom-color: #1e90ff;
    }

    .settings-tab-content {
      display: none;
    }

    .settings-tab-content.active {
      display: block;
    }

    .margin-rows-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      padding: 12px;
      background: #f9fafb;
    }

    .margin-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e8eb;
    }

    .margin-row input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .margin-row button {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .margin-row button:hover {
      background: #dc2626;
    }

    .margin-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .settings-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e8eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .price-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .price-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      text-align: right;
    }

    .price-input:focus {
      outline: none;
      border-color: #1e90ff;
      box-shadow: 0 0 0 3px rgba(30,144,255,0.1);
    }

    .price-main {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .price-sub {
      font-size: 11px;
      color: #888;
      text-align: center;
    }

    .price-sub.profit-positive {
      color: #10b981;
      font-weight: 500;
    }

    .price-sub.profit-warning {
      color: #ef4444;
      font-weight: 500;
    }

    .margin-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .margin-amount {
      font-size: 13px;
      font-weight: 600;
    }

    .margin-percent {
      font-size: 11px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>옵션 편집</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="window.location.href='/products.html'">목록으로</button>
      <button class="btn btn-success" onclick="saveProduct()">저장</button>
    </div>
  </div>

  <div class="container">
    <div id="alertContainer"></div>

    <div class="editor-wrapper">
      <!-- 상품명 섹션 -->
      <div class="product-name-section">
        <h2>상품명</h2>
        <div class="product-name-input-wrapper">
          <input type="text" id="productTitle" placeholder="상품명을 입력하세요">
          <button class="btn-ai-title" id="btnAiTitle" onclick="generateAITitle()">
            <span class="spinner" id="aiTitleSpinner"></span>
            <span id="aiTitleText">AI 작명</span>
          </button>
        </div>
      </div>

      <!-- 탭 메뉴 -->
      <div class="main-tabs">
        <button class="main-tab" onclick="switchMainTab('images')">이미지</button>
        <button class="main-tab active" onclick="switchMainTab('options')">옵션</button>
        <button class="main-tab" onclick="switchMainTab('detail')">상세페이지</button>
      </div>

      <!-- 이미지 탭 -->
      <div id="images-tab" class="main-tab-content">
        <div class="images-grid-layout">
          <!-- 추가 이미지들 (좌측) -->
          <div class="image-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">추가 이미지</h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="openBackgroundRemovalModal('additional')" style="font-size: 13px; padding: 6px 12px;">
                  ✂️ 배경제거
                </button>
                <button class="btn btn-primary" onclick="openAIImageEditor('additional')" style="font-size: 13px; padding: 6px 12px;">
                  🎨 AI 편집
                </button>
              </div>
            </div>
            <div class="images-grid" id="additionalImagesGridTab">
              <!-- 추가 이미지들이 여기에 동적으로 추가됨 -->
            </div>
          </div>

          <!-- 옵션 이미지 유니크 값 (우측) -->
          <div class="image-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">옵션 이미지</h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="openBackgroundRemovalModal('option')" style="font-size: 13px; padding: 6px 12px;">
                  ✂️ 배경제거
                </button>
                <button class="btn btn-primary" onclick="openAIImageEditor('option')" style="font-size: 13px; padding: 6px 12px;">
                  🎨 AI 편집
                </button>
              </div>
            </div>
            <div class="images-grid" id="optionImagesGridTab">
              <!-- 옵션 이미지 유니크 값들이 여기에 동적으로 추가됨 -->
            </div>
          </div>
        </div>
      </div>

      <!-- 옵션 탭 -->
      <div id="options-tab" class="main-tab-content active">
        <!-- 모던 옵션 일괄 편집 툴바 -->
        <div class="options-toolbar">
          <div class="options-toolbar-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3>옵션 일괄 편집</h3>
            <button class="btn-action btn-action-ai" onclick="openAIRenameModal()" style="padding: 8px 16px; font-size: 13px;">
              <span>✨</span> AI 작명
            </button>
          </div>

          <!-- 탭 선택 -->
          <div class="edit-tabs">
            <button class="edit-tab active" onclick="switchEditTab('mapping')">이름 매핑</button>
            <button class="edit-tab" onclick="switchEditTab('find-replace')">찾기/바꾸기</button>
            <button class="edit-tab" onclick="switchEditTab('numbering')">순번 부여</button>
            <button class="edit-tab" onclick="switchEditTab('price-collect')">가격 수집</button>
          </div>

          <!-- 이름 매핑 탭 (좌우 레이아웃) -->
          <div id="mapping-tab" class="edit-tab-content active">
            <div class="mapping-dual-layout" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <!-- 옵션1 매핑 -->
              <div class="mapping-column" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                <div class="edit-section-title" style="margin-bottom: 12px;">
                  <span class="icon">🏷️</span>
                  옵션1 매핑
                </div>
                <div id="option1MappingList" class="mapping-list" style="max-height: 300px; overflow-y: auto;">
                  <!-- 옵션1 유니크 값들이 여기에 렌더링됨 -->
                </div>
              </div>
              <!-- 옵션2 매핑 -->
              <div class="mapping-column" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                <div class="edit-section-title" style="margin-bottom: 12px;">
                  <span class="icon">🏷️</span>
                  옵션2 매핑
                </div>
                <div id="option2MappingList" class="mapping-list" style="max-height: 300px; overflow-y: auto;">
                  <!-- 옵션2 유니크 값들이 여기에 렌더링됨 -->
                </div>
              </div>
            </div>
            <p class="hint" style="margin-top: 12px;">각 옵션의 유니크 값을 직접 수정하면 동일한 값이 모두 변경됩니다. Enter 또는 포커스 아웃 시 자동 적용됩니다.</p>
          </div>

          <!-- 찾기/바꾸기 탭 -->
          <div id="find-replace-tab" class="edit-tab-content">
            <div class="edit-section-title">
              <span class="icon">🔍</span>
              텍스트 찾아 바꾸기
            </div>
            <div class="bulk-edit-group">
              <select id="replaceTargetOption" class="option-select">
                <option value="optionName1">옵션1</option>
                <option value="optionName2">옵션2</option>
              </select>
              <input type="text" id="findText" placeholder="찾을 텍스트">
              <span class="arrow-icon">→</span>
              <input type="text" id="replaceText" placeholder="바꿀 텍스트">
              <button class="btn-action btn-action-primary" onclick="bulkReplace()">
                치환하기
              </button>
            </div>
            <p class="hint">선택한 옵션의 모든 값에서 특정 텍스트를 찾아 일괄 변경합니다. 빈 칸으로 두면 해당 텍스트를 삭제합니다.</p>
          </div>

          <!-- 순번 부여 탭 -->
          <div id="numbering-tab" class="edit-tab-content">
            <div class="edit-section-title">
              <span class="icon">🔢</span>
              자동 순번 부여
            </div>
            <div class="bulk-edit-group">
              <select id="numberingTargetOption" class="option-select">
                <option value="optionName1">옵션1</option>
                <option value="optionName2">옵션2</option>
              </select>
              <input type="text" id="numberingPrefix" placeholder="접두사 (예: 색상)" style="width: 150px;">
              <select id="numberingType" class="option-select" style="min-width: 150px;">
                <option value="number">숫자 (1, 2, 3...)</option>
                <option value="letter">알파벳 (A, B, C...)</option>
              </select>
              <button class="btn-action btn-action-primary" onclick="applyNumbering()">
                순번 부여
              </button>
            </div>
            <p class="hint">유니크한 옵션 값에 순차적으로 번호를 부여합니다. 예: "색상1", "색상2" 또는 "색상A", "색상B"</p>
          </div>

          <!-- 가격 수집 탭 -->
          <div id="price-collect-tab" class="edit-tab-content">
            <div class="price-collect-layout" style="display: grid; grid-template-columns: 1fr 280px; gap: 20px;">
              <!-- 좌측: 가격 수집 메인 영역 -->
              <div class="price-collect-main">
                <div class="price-collect-section">
                  <div class="edit-section-title">
                    <span class="icon">💰</span>
                    쿠팡 가격 비교
                  </div>
                  <p class="hint" style="margin-bottom: 15px;">쿠팡에서 경쟁 상품 가격을 수집하고 내 판매가와 비교합니다.</p>

                  <div class="bulk-edit-group" style="margin-bottom: 10px;">
                    <input type="text" id="priceCollectKeyword" placeholder="검색 키워드 입력 (예: 자켓, 원피스)" style="flex: 1; min-width: 200px;">
                    <button class="btn-action btn-action-primary" onclick="collectCoupangPrices()" id="priceCollectBtn">
                      <span id="priceCollectIcon">🔍</span>
                      <span id="priceCollectText">가격 수집</span>
                    </button>
                  </div>
                  <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666; cursor: pointer;">
                      <input type="checkbox" id="useIncognitoMode" style="width: 16px; height: 16px; cursor: pointer;">
                      <span>🔒 시크릿 모드로 검색</span>
                      <span style="color: #999; font-size: 11px;">(개인화 검색 제외)</span>
                    </label>
                  </div>
                </div><!-- price-collect-section 끝 -->

                <!-- 수집 결과 영역 -->
              <div id="priceCollectResult" style="display: none;">
                <!-- 가격 비교 테이블 -->
                <div class="price-comparison-container" style="margin-bottom: 20px;">
                  <table class="price-comparison-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                      <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th style="padding: 12px; text-align: center; width: 100px;"></th>
                        <th style="padding: 12px; text-align: center;">최저가</th>
                        <th style="padding: 12px; text-align: center;">평균가</th>
                        <th style="padding: 12px; text-align: center;">중간가</th>
                        <th style="padding: 12px; text-align: center;">최고가</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 쿠팡 시장가 -->
                      <tr style="background: #f8f9ff;">
                        <td style="padding: 12px; font-weight: 600; color: #667eea;">
                          <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">🛒</span>
                            쿠팡 시장가
                          </div>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="allMinPrice">-</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="allAvgPrice">-</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="allMidPrice">-</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="allMaxPrice">-</td>
                      </tr>
                      <!-- 내 판매가 -->
                      <tr style="background: #f0fff4;">
                        <td style="padding: 12px; font-weight: 600; color: #38a169;">
                          <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">💵</span>
                            내 판매가
                          </div>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="myMinPrice">-</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="myAvgPrice">-</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="myMidPrice">-</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;" id="myMaxPrice">-</td>
                      </tr>
                      <!-- 예상 마진 -->
                      <tr style="background: #fff5f5;" id="marginRow">
                        <td style="padding: 12px; font-weight: 600; color: #e53e3e;">
                          <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">📊</span>
                            예상 마진
                          </div>
                        </td>
                        <td style="padding: 12px; text-align: center;" id="marginMin">-</td>
                        <td style="padding: 12px; text-align: center;" id="marginAvg">-</td>
                        <td style="padding: 12px; text-align: center;" id="marginMid">-</td>
                        <td style="padding: 12px; text-align: center;" id="marginMax">-</td>
                      </tr>
                    </tbody>
                  </table>
                  <div style="text-align: right; margin-top: 8px; color: #666; font-size: 12px;">
                    수집된 상품: <span id="allCount" style="font-weight: 600;">0</span>개
                  </div>
                </div>

                <!-- 경쟁력 분석 -->
                <div id="competitiveAnalysis" style="display: none; background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <span style="font-size: 20px;" id="competitiveIcon">📈</span>
                    <span style="font-weight: 600; font-size: 14px;" id="competitiveTitle">경쟁력 분석</span>
                  </div>
                  <div id="competitiveMessage" style="font-size: 13px; color: #333; line-height: 1.6;"></div>
                </div>

                <!-- 가격 적용 영역 - 직관적 UI -->
                <div class="price-apply-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                  <div class="price-apply-header" style="margin-bottom: 20px;">
                    <span class="icon">💰</span>
                    <span style="font-weight: 600;">판매가 설정 도우미</span>
                  </div>

                  <!-- 기준가 선택 -->
                  <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button type="button" class="price-base-btn active" data-base="min" onclick="selectPriceBase('min')">
                      최저가<br><span id="basePriceMin">-</span>
                    </button>
                    <button type="button" class="price-base-btn" data-base="avg" onclick="selectPriceBase('avg')">
                      평균가<br><span id="basePriceAvg">-</span>
                    </button>
                    <button type="button" class="price-base-btn" data-base="mid" onclick="selectPriceBase('mid')">
                      중간가<br><span id="basePriceMid">-</span>
                    </button>
                    <button type="button" class="price-base-btn" data-base="max" onclick="selectPriceBase('max')">
                      최고가<br><span id="basePriceMax">-</span>
                    </button>
                  </div>

                  <!-- 슬라이더와 미리보기 -->
                  <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                      <span style="font-size: 13px; color: #666; min-width: 60px;">가격 조정</span>
                      <input type="range" id="priceSlider" min="-50" max="50" value="0"
                             style="flex: 1; height: 8px; cursor: pointer;"
                             oninput="updatePricePreview()">
                      <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="number" id="priceAdjustPercent" value="0"
                               style="width: 60px; text-align: center; font-weight: 600; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; padding: 8px;"
                               oninput="syncSlider()">
                        <span style="font-weight: 600;">%</span>
                      </div>
                    </div>

                    <!-- 빠른 조정 버튼 -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(-20)">-20%</button>
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(-10)">-10%</button>
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(-5)">-5%</button>
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(0)">0%</button>
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(5)">+5%</button>
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(10)">+10%</button>
                      <button type="button" class="quick-adjust-btn" onclick="quickAdjust(20)">+20%</button>
                    </div>

                    <!-- 예상 결과 미리보기 -->
                    <div id="pricePreviewBox" style="background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                        <div>
                          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">예상 판매가</div>
                          <div id="previewPrice" style="font-size: 20px; font-weight: 700; color: #2563eb;">-</div>
                        </div>
                        <div>
                          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">예상 마진</div>
                          <div id="previewMargin" style="font-size: 20px; font-weight: 700; color: #059669;">-</div>
                        </div>
                        <div>
                          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">마진율</div>
                          <div id="previewMarginRate" style="font-size: 20px; font-weight: 700; color: #7c3aed;">-</div>
                        </div>
                      </div>
                    </div>

                    <!-- 적용 버튼 -->
                    <button class="btn-action btn-action-primary" onclick="applyCollectedPrice()"
                            style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;">
                      이 가격으로 모든 옵션에 적용
                    </button>
                  </div>

                  <p class="hint" style="margin-top: 15px; text-align: center;">
                    기준가 선택 후 슬라이더로 조정하면 실시간 미리보기가 표시됩니다
                  </p>
                </div><!-- price-apply-section 끝 -->
              </div><!-- priceCollectResult 끝 -->
              </div><!-- price-collect-main 끝 -->

              <!-- 우측: 검색 히스토리 -->
              <div class="price-history-sidebar" style="background: #f8f9fa; border-radius: 12px; padding: 15px; height: fit-content;">
                <div class="history-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <div style="font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                    <span>📋</span> 검색 히스토리
                  </div>
                  <button onclick="clearAllPriceHistory()" style="background: none; border: none; color: #999; font-size: 12px; cursor: pointer;" title="전체 삭제">
                    🗑️
                  </button>
                </div>
                <div id="priceHistoryList" style="max-height: 400px; overflow-y: auto;">
                  <div style="color: #888; text-align: center; padding: 30px 10px; font-size: 13px;">
                    가격 수집 기록이 없습니다
                  </div>
                </div>
              </div>
            </div><!-- price-collect-layout 끝 -->
          </div><!-- price-collect-tab 끝 -->
        </div><!-- options-toolbar 끝 -->

        <!-- 옵션 테이블 -->
        <div class="options-table-container">
          <table class="options-table">
            <thead>
              <tr>
                <th style="width: 60px;">#</th>
                <th style="width: 80px;">이미지</th>
                <th>옵션1</th>
                <th>옵션2</th>
                <th style="width: 120px;">원가</th>
                <th style="width: 120px;">공급가</th>
                <th style="width: 120px;">판매가</th>
              </tr>
            </thead>
            <tbody id="optionsTableBody">
              <!-- 옵션 행들이 여기에 동적으로 추가됨 -->
            </tbody>
          </table>
        </div>
      </div><!-- options-tab 끝 -->

      <!-- 상세페이지 탭 -->
      <div id="detail-tab" class="main-tab-content">
        <div class="detail-page-editor">
          <div class="detail-toolbar">
            <h3>상세페이지 구성</h3>
            <div class="toolbar-actions">
              <button class="btn btn-secondary" onclick="syncOptionImagesToDetailPage()" title="옵션 이미지를 최신 상태로 동기화">🔄 이미지 동기화</button>
              <button class="btn btn-secondary" onclick="resetDetailPage()">초기화</button>
              <button class="btn btn-primary" onclick="previewDetailPage()">미리보기</button>
            </div>
          </div>

          <div class="detail-content">
            <!-- 좌측: 드롭다운 메뉴 -->
            <div class="detail-sources">
              <div class="source-section">

                <!-- 이미지 추가하기 드롭다운 -->
                <div class="dropdown-box">
                  <div class="dropdown-header" onclick="toggleDropdown('imagesDropdown')">
                    <div class="dropdown-title">
                      <span class="dropdown-icon">🖼️</span>
                      <span>이미지 추가하기</span>
                    </div>
                    <span class="dropdown-arrow">▼</span>
                  </div>
                  <div id="imagesDropdown" class="dropdown-content">
                    <div class="source-group" style="margin-bottom: 20px;">
                      <h5 style="font-size: 13px; color: #666; margin-bottom: 10px;">대표 이미지</h5>
                      <div id="detailMainImageSource" class="source-images"></div>
                    </div>

                    <div class="source-group" style="margin-bottom: 20px;">
                      <h5 style="font-size: 13px; color: #666; margin-bottom: 10px;">추가 이미지 (연출)</h5>
                      <div id="detailAdditionalImagesSource" class="source-images"></div>
                    </div>

                    <div class="source-group">
                      <h5 style="font-size: 13px; color: #666; margin-bottom: 10px;">옵션 이미지</h5>
                      <div id="detailOptionImagesSource" class="source-images"></div>
                    </div>
                  </div>
                </div>

                <!-- 텍스트 추가하기 드롭다운 -->
                <div class="dropdown-box">
                  <div class="dropdown-header" onclick="toggleDropdown('textDropdown')">
                    <div class="dropdown-title">
                      <span class="dropdown-icon">📝</span>
                      <span>텍스트 추가하기</span>
                    </div>
                    <span class="dropdown-arrow">▼</span>
                  </div>
                  <div id="textDropdown" class="dropdown-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px; line-height: 1.5;">텍스트를 드래그하여 추가하세요</p>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                      <div class="text-add-btn" draggable="true" data-text-type="title" style="padding: 12px; border: 2px solid #1e90ff; background: rgba(30, 144, 255, 0.05); border-radius: 8px; cursor: grab; font-weight: 600; color: #1e90ff; font-size: 16px; user-select: none;">
                        📌 타이틀
                      </div>
                      <div class="text-add-btn" draggable="true" data-text-type="subtitle" style="padding: 10px; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.05); border-radius: 8px; cursor: grab; font-weight: 600; color: #667eea; font-size: 14px; user-select: none;">
                        📍 중간 타이틀
                      </div>
                      <div class="text-add-btn" draggable="true" data-text-type="paragraph" style="padding: 10px; border: 2px solid #666; background: rgba(0, 0, 0, 0.02); border-radius: 8px; cursor: grab; font-weight: 500; color: #666; font-size: 13px; user-select: none;">
                        📄 일반 텍스트
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 템플릿 변경 드롭다운 -->
                <div class="dropdown-box">
                  <div class="dropdown-header" onclick="toggleDropdown('templateDropdown')">
                    <div class="dropdown-title">
                      <span class="dropdown-icon">📐</span>
                      <span>템플릿 변경</span>
                    </div>
                    <span class="dropdown-arrow">▼</span>
                  </div>
                  <div id="templateDropdown" class="dropdown-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px; line-height: 1.5;">템플릿을 선택하면 모든 옵션 블록에 적용됩니다</p>

                    <div class="template-grid" style="grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <div class="template-item" data-template="horizontal" onclick="selectOptionTemplate('horizontal')">
                      <div class="template-preview">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">가로형</div>
                    </div>

                    <div class="template-item" data-template="horizontal-reverse" onclick="selectOptionTemplate('horizontal-reverse')">
                      <div class="template-preview" style="flex-direction: row-reverse;">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">가로 반전</div>
                    </div>

                    <div class="template-item" data-template="vertical" onclick="selectOptionTemplate('vertical')">
                      <div class="template-preview template-preview-vertical">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 5px; background: #333; width: 60%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 45%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">세로형</div>
                    </div>

                    <div class="template-item" data-template="card" onclick="selectOptionTemplate('card')">
                      <div class="template-preview template-preview-card">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 5px; background: #333; width: 65%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">카드형</div>
                    </div>

                    <div class="template-item" data-template="centered" onclick="selectOptionTemplate('centered')">
                      <div class="template-preview template-preview-vertical" style="align-items: center;">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text" style="text-align: center; align-items: center;">
                          <div style="height: 5px; background: #333; width: 60%; margin: 0 auto 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 45%; margin: 0 auto; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">중앙 정렬</div>
                    </div>

                    <div class="template-item" data-template="split" onclick="selectOptionTemplate('split')">
                      <div class="template-preview" style="gap: 0;">
                        <div class="template-preview-img" style="background: #ddd; border-radius: 3px 0 0 3px;">IMG</div>
                        <div class="template-preview-text" style="background: #f5f5f5; padding: 4px; border-radius: 0 3px 3px 0;">
                          <div style="height: 5px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">50/50 분할</div>
                    </div>

                    <div class="template-item" data-template="modern" onclick="selectOptionTemplate('modern')">
                      <div class="template-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 6px; border-radius: 4px;">
                        <div class="template-preview-img" style="background: rgba(255,255,255,0.9);">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: white; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.8); width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">모던형</div>
                    </div>

                    <div class="template-item active" data-template="gradient" onclick="selectOptionTemplate('gradient')">
                      <div class="template-preview template-preview-gradient">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">그라데이션</div>
                    </div>

                    <!-- 컬러풀 템플릿 -->
                    <div class="template-item" data-template="neon" onclick="selectOptionTemplate('neon')">
                      <div class="template-preview" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 6px; border-radius: 4px;">
                        <div class="template-preview-img" style="background: rgba(255,255,255,0.9);">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: white; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.8); width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">💗 네온</div>
                    </div>

                    <div class="template-item" data-template="sunset" onclick="selectOptionTemplate('sunset')">
                      <div class="template-preview" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 6px; border-radius: 4px;">
                        <div class="template-preview-img" style="background: rgba(255,255,255,0.9);">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: white; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.8); width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">🌅 일몰</div>
                    </div>

                    <div class="template-item" data-template="ocean" onclick="selectOptionTemplate('ocean')">
                      <div class="template-preview" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 6px; border-radius: 4px;">
                        <div class="template-preview-img" style="background: rgba(255,255,255,0.9);">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: white; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.8); width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">🌊 바다</div>
                    </div>

                    <div class="template-item" data-template="mint" onclick="selectOptionTemplate('mint')">
                      <div class="template-preview" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 6px; border-radius: 4px;">
                        <div class="template-preview-img" style="background: rgba(255,255,255,0.9);">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: white; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.8); width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">🌿 민트</div>
                    </div>

                    <div class="template-item" data-template="dark" onclick="selectOptionTemplate('dark')">
                      <div class="template-preview" style="background: #1a1a1a; padding: 6px; border-radius: 4px; border: 1px solid #333;">
                        <div class="template-preview-img" style="background: #2a2a2a;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: white; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.7); width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">🌙 다크</div>
                    </div>

                    <!-- 독특한 스타일 -->
                    <div class="template-item" data-template="neon-border" onclick="selectOptionTemplate('neon-border')">
                      <div class="template-preview" style="border: 2px solid #f093fb; padding: 6px; border-radius: 4px; box-shadow: 0 0 10px rgba(240, 147, 251, 0.3);">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">✨ 네온 테두리</div>
                    </div>

                    <div class="template-item" data-template="badge" onclick="selectOptionTemplate('badge')">
                      <div class="template-preview" style="border: 2px dashed #1e90ff; padding: 6px; border-radius: 12px;">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">🏷️ 배지</div>
                    </div>

                    <div class="template-item" data-template="diagonal" onclick="selectOptionTemplate('diagonal')">
                      <div class="template-preview" style="background: linear-gradient(45deg, #f8f9fa 50%, white 50%); padding: 6px; border-radius: 4px; border: 1px solid #e5e8eb;">
                        <div class="template-preview-img" style="background: #ddd;">IMG</div>
                        <div class="template-preview-text">
                          <div style="height: 6px; background: #333; width: 70%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: #999; width: 50%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">📐 대각선</div>
                    </div>

                    <div class="template-item" data-template="overlay" onclick="selectOptionTemplate('overlay')">
                      <div class="template-preview template-preview-vertical" style="position: relative; background: #ddd; padding: 0;">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                          <div style="height: 5px; background: white; width: 60%; margin-bottom: 3px; border-radius: 2px;"></div>
                          <div style="height: 4px; background: rgba(255,255,255,0.8); width: 45%; border-radius: 2px;"></div>
                        </div>
                      </div>
                      <div class="template-name">🖼️ 오버레이</div>
                    </div>

                  </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- 우측: 상세페이지 구성 -->
            <div class="detail-canvas">
              <div class="canvas-header">
                <h4>상세페이지 구성 순서</h4>
                <p class="hint">이미지를 드래그하여 순서를 변경하거나, 좌측에서 이미지를 추가하세요</p>
              </div>

              <div id="detailPageCanvas" class="detail-page-items">
                <!-- 상세페이지 아이템들이 여기에 추가됨 -->
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 상세페이지 미리보기 모달 -->
  <div class="modal" id="detailPreviewModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>상세페이지 미리보기</h2>
        <button class="modal-close" onclick="closeDetailPreview()">×</button>
      </div>
      <div class="modal-body">
        <div id="detailPreviewContent" class="detail-preview-content">
          <!-- 미리보기 내용이 여기에 렌더링됨 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 매직 브러쉬 모달 -->
  <div class="modal" id="magicBrushModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>🎨 매직 브러쉬 - 이미지 편집</h2>
        <button class="modal-close" onclick="closeMagicBrush()">×</button>
      </div>
      <div class="modal-body">
        <div class="image-editor-container">
          <div class="canvas-container">
            <canvas id="imageCanvas"></canvas>
          </div>
          <div class="editor-tools">
            <div class="tool-group">
              <h3>매직 이레이저 (AI)</h3>
              <div class="tool-buttons">
                <button class="tool-btn" id="magicEraserBtn" onclick="toggleMagicEraser()">매직 이레이저</button>
                <button class="tool-btn" onclick="applyMagicEraser()">영역 제거 및 채우기</button>
              </div>
              <div class="slider-group">
                <label>브러시 크기: <span id="brushSizeValue">20</span>px</label>
                <input type="range" id="brushSizeSlider" min="5" max="100" value="20" oninput="updateBrushSize()">
              </div>
              <p style="font-size: 12px; color: #888; margin-top: 8px;">
                ✨ 드래그로 제거할 영역을 빨간색으로 칠한 후 "영역 제거 및 채우기" 버튼을 클릭하세요.
              </p>
            </div>

            <div class="tool-group">
              <h3>일반 지우개</h3>
              <div class="tool-buttons">
                <button class="tool-btn" id="eraserBtn" onclick="toggleEraser()">투명하게 지우기</button>
                <button class="tool-btn" onclick="clearCanvas()">전체 지우기</button>
              </div>
            </div>

            <div class="tool-group">
              <h3>배경 제거</h3>
              <button class="tool-btn" onclick="removeBackground()">배경 자동 제거</button>
            </div>

            <div class="tool-group">
              <h3>크기 조정</h3>
              <div class="tool-buttons">
                <button class="tool-btn" onclick="resizeImage(800, 800)">800x800</button>
                <button class="tool-btn" onclick="resizeImage(1000, 1000)">1000x1000</button>
                <button class="tool-btn" onclick="resizeImage(1200, 1200)">1200x1200</button>
                <button class="tool-btn" onclick="resizeImage(1500, 1500)">1500x1500</button>
              </div>
            </div>

            <div class="tool-group">
              <h3>밝기/대비</h3>
              <div class="slider-group">
                <label>밝기: <span id="brightnessValue">0</span></label>
                <input type="range" id="brightnessSlider" min="-100" max="100" value="0" oninput="adjustBrightness()">
              </div>
              <div class="slider-group">
                <label>대비: <span id="contrastValue">0</span></label>
                <input type="range" id="contrastSlider" min="-100" max="100" value="0" oninput="adjustContrast()">
              </div>
            </div>

            <div class="tool-group">
              <h3>필터</h3>
              <div class="tool-buttons">
                <button class="tool-btn" onclick="applyFilter('grayscale')">흑백</button>
                <button class="tool-btn" onclick="applyFilter('sepia')">세피아</button>
                <button class="tool-btn" onclick="applyFilter('blur')">블러</button>
                <button class="tool-btn" onclick="applyFilter('sharpen')">선명하게</button>
              </div>
            </div>

            <div class="tool-group">
              <button class="btn btn-primary" style="width: 100%;" onclick="saveEditedImage()">저장</button>
              <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="resetImage()">초기화</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 이름 매핑 다이얼로그 -->
  <div class="mapping-dialog" id="mappingDialog">
    <div class="mapping-content">
      <h2 id="mappingDialogTitle">옵션 이름 매핑</h2>
      <p class="hint">유니크한 옵션 값들을 한 번에 변경합니다. 동일한 값을 가진 모든 항목이 함께 업데이트됩니다.</p>
      <div id="mappingRows"></div>
      <div class="mapping-buttons">
        <button class="btn btn-secondary" onclick="closeMappingDialog()">취소</button>
        <button class="btn btn-primary" onclick="applyMapping()">적용</button>
      </div>
    </div>
  </div>

  <!-- 설정 모달 -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2>⚙️ TotalBot 설정</h2>
        <button class="modal-close" onclick="closeSettingsModal()">×</button>
      </div>

      <!-- 설정 메인 탭 -->
      <div class="settings-main-tabs">
        <button class="settings-main-tab active" onclick="switchMainSettingsTab('info')">정보 설정</button>
        <button class="settings-main-tab" onclick="switchMainSettingsTab('price')">가격 설정</button>
        <button class="settings-main-tab" onclick="switchMainSettingsTab('template')">템플릿 설정</button>
      </div>

      <div class="settings-body">
        <!-- 정보 설정 탭 -->
        <div id="info-main-settings-tab" class="settings-main-tab-content active">
          <div class="settings-section">
            <h3>계정 정보</h3>
            <div class="settings-grid">
              <div class="settings-field">
                <label>쿠팡 아이디</label>
                <input type="text" id="coupangId" placeholder="쿠팡 아이디를 입력하세요">
              </div>
              <div class="settings-field">
                <label>쿠팡 비밀번호</label>
                <input type="password" id="coupangPassword" placeholder="쿠팡 비밀번호를 입력하세요">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>주소 정보</h3>
            <div class="settings-grid">
              <div class="settings-field" style="grid-column: 1 / -1;">
                <label>주소</label>
                <input type="text" id="address" placeholder="주소를 입력하세요">
              </div>
            </div>
          </div>
        </div>

        <!-- 가격 설정 탭 -->
        <div id="price-main-settings-tab" class="settings-main-tab-content">
          <!-- 기본 설정 -->
          <div class="settings-section">
            <h3>기본 설정</h3>
            <div class="settings-grid">
              <div class="settings-field">
                <label>환율 (CNY → KRW)</label>
                <input type="number" id="settingsExchangeRate" value="190" step="1">
              </div>
              <div class="settings-field">
                <label>개당포장 비용 (원)</label>
                <input type="number" id="settingsPackagingCost" value="500" step="100">
              </div>
              <div class="settings-field">
                <label>쉽먼트 비용 (원)</label>
                <input type="number" id="settingsShipmentCost" value="0" step="100">
              </div>
              <div class="settings-field">
                <label>쿠팡 최소 마진금 (원)</label>
                <input type="number" id="settingsMinMargin" value="3000" step="100">
              </div>
            </div>
          </div>

          <!-- 마진 설정 -->
          <div class="settings-section">
            <h3>마진 설정</h3>

            <div class="settings-tabs">
              <button class="settings-tab active" onclick="switchSettingsTab('supply')">공급가 마진</button>
              <button class="settings-tab" onclick="switchSettingsTab('sale')">판매가 마진</button>
            </div>

            <!-- 공급가 마진 탭 -->
            <div id="supply-settings-tab" class="settings-tab-content active">
              <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                원가 구간별로 공급가 마진율을 설정합니다. 낮은 금액부터 순서대로 입력하세요.
              </p>
              <div class="margin-rows-container" id="supplyMarginRows">
                <!-- 공급가 마진 행들이 여기에 동적으로 추가됨 -->
              </div>
              <div class="margin-actions">
                <button class="btn btn-primary btn-sm" onclick="addSupplyMarginRow()">+ 행 추가</button>
                <button class="btn btn-secondary btn-sm" onclick="sortSupplyMarginRows()">정렬</button>
                <button class="btn btn-secondary btn-sm" onclick="clearSupplyMarginRows()">모두 삭제</button>
              </div>
            </div>

            <!-- 판매가 마진 탭 -->
            <div id="sale-settings-tab" class="settings-tab-content">
              <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                공급가 구간별로 판매가 마진율을 설정합니다. 낮은 금액부터 순서대로 입력하세요.
              </p>
              <div class="margin-rows-container" id="saleMarginRows">
                <!-- 판매가 마진 행들이 여기에 동적으로 추가됨 -->
              </div>
              <div class="margin-actions">
                <button class="btn btn-primary btn-sm" onclick="addSaleMarginRow()">+ 행 추가</button>
                <button class="btn btn-secondary btn-sm" onclick="sortSaleMarginRows()">정렬</button>
                <button class="btn btn-secondary btn-sm" onclick="clearSaleMarginRows()">모두 삭제</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 템플릿 설정 탭 -->
        <div id="template-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>대표 이미지</h3>
            <div class="settings-field">
              <label>대표 이미지 업로드</label>
              <input type="file" id="brandImageUpload" accept="image/*" onchange="handleBrandImageUpload(event)">
              <div id="brandImagePreview" style="margin-top: 10px; display: none;">
                <img id="brandImagePreviewImg" style="max-width: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>상세페이지 기본 구성 설정</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              상품 수집 시 자동으로 생성되는 상세페이지의 기본 구성을 설정합니다.
            </p>
            <div id="defaultDetailPageCanvas" class="detail-page-canvas" style="min-height: 300px; background: #f8f9fa; border-radius: 8px; padding: 20px;">
              <!-- 기본 템플릿 아이템들이 여기에 표시됨 -->
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
              <button class="btn btn-primary btn-sm" onclick="addDefaultText()">+ 텍스트 추가</button>
              <button class="btn btn-secondary btn-sm" onclick="resetDefaultTemplate()">기본값으로 초기화</button>
            </div>
          </div>

          <div class="settings-section">
            <h3>품질표시사항 기본값 설정</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
              품질표시사항에 기본으로 표시될 값을 설정합니다. (상품명, 색상, 사이즈는 자동 생성)
            </p>

            <div class="settings-field">
              <label>제조사</label>
              <input type="text" id="qtManufacturer" placeholder="브랜드명" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div class="settings-field">
              <label>취급시 주의사항</label>
              <input type="text" id="qtCaution" placeholder="상세페이지 참조" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div class="settings-field">
              <label>제조 연월</label>
              <input type="text" id="qtManufactureDate" placeholder="2024년 1월" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div class="settings-field">
              <label>품질 보증기준</label>
              <input type="text" id="qtWarranty" placeholder="관련법 및 소비자 분쟁해결 규정에 따름" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div class="settings-field">
              <label>A/S 책임자와 전화번호</label>
              <input type="text" id="qtAS" placeholder="상호명 / 전화번호" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div class="settings-field" style="margin-top: 20px;">
              <label style="margin-bottom: 12px; display: block;">추가 항목</label>
              <div id="qtCustomRows" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- 커스텀 행들이 여기에 추가됨 -->
              </div>
              <button class="btn btn-primary btn-sm" onclick="addQualityTableCustomRow()" style="margin-top: 12px;">+ 항목 추가</button>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">취소</button>
        <button class="btn btn-success" onclick="saveSettings()">저장</button>
      </div>
    </div>
  </div>

  <script>
    // 버전 확인용 (브라우저 캐시 확인)
    console.log('🔄 TotalBot Editor 버전: 2025-11-29-v2 (인증 추가)');
    console.log('✅ 최신 버전이 로드되었습니다.');

    // ===== 인증 관련 함수 =====
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function checkAuth() {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    async function authFetch(url, options = {}) {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        throw new Error('로그인이 필요합니다.');
      }

      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
      };

      const response = await fetch(url, { ...options, headers });

      if (response.status === 401) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
        throw new Error('세션이 만료되었습니다.');
      }

      return response;
    }

    // 페이지 로드 시 인증 체크
    if (!checkAuth()) {
      throw new Error('인증 필요');
    }

    // Chrome 확장 프로그램 통신 함수
    async function sendMessageToExtension(message, timeout = 60000) {
      return new Promise((resolve, reject) => {
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        const handler = (event) => {
          if (event.data && event.data.type === 'TOTALBOT_RESPONSE' && event.data.messageId === messageId) {
            window.removeEventListener('message', handler);
            resolve(event.data.response);
          }
        };

        window.addEventListener('message', handler);

        window.postMessage({
          type: 'TOTALBOT_REQUEST',
          messageId: messageId,
          message: message
        }, '*');

        // 타임아웃
        setTimeout(() => {
          window.removeEventListener('message', handler);
          reject(new Error('Extension 응답 타임아웃'));
        }, timeout);
      });
    }

    let productId = null;
    let productData = {
      title: '',
      titleCn: '',
      platform: '1688-product',
      mainImage: '',
      images: [],
      results: []
    };

    // 선택된 추가 이미지 추적 (견적서용)
    let selectedAdditionalImages = new Set();
    // 선택된 옵션 이미지 추적 (배경제거용)
    let selectedOptionImages = new Set();

    // 상세페이지 구성 데이터
    let detailPageItems = [];
    let selectedOptionTemplate = 'gradient'; // 기본 템플릿
    let draggedItem = null;

    // TotalBot 설정
    let settings = {
      // 정보 설정
      coupangId: '',
      coupangPassword: '',
      address: '',
      // 가격 설정
      exchangeRate: 190,
      packagingCost: 500,
      shipmentCost: 0,
      minMargin: 3000,
      supplyMargins: [
        { amount: 10000, percent: 50 },
        { amount: 50000, percent: 45 },
        { amount: 100000, percent: 40 },
        { amount: 200000, percent: 35 },
        { amount: Infinity, percent: 30 }
      ],
      saleMargins: [
        { amount: 10000, percent: 35 },
        { amount: 50000, percent: 30 },
        { amount: 100000, percent: 25 },
        { amount: 200000, percent: 20 },
        { amount: Infinity, percent: 15 }
      ],
      // 템플릿 설정
      brandImageUrl: '',
      defaultDetailTemplate: [
        { type: 'brand-image', label: '브랜드 이미지' },
        { type: 'title', label: '제품명' },
        { type: 'option-blocks', label: '옵션 블록들' },
        { type: 'quality-table', label: '품질표시사항' }
      ],
      // 품질표시사항 설정
      qualityTable: {
        제조사: '',
        취급시주의사항: '상세페이지 참조',
        제조연월: '',
        품질보증기준: '관련법 및 소비자 분쟁해결 규정에 따름',
        AS책임자: '',
        customRows: [] // { label: '', value: '' } 형태로 추가 가능
      }
    };

    // 설정 로드 (서버에서 유저별로 관리)
    async function loadSettings() {
      try {
        const response = await authFetch('/api/settings');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.settings) {
            const serverSettings = data.settings;

            // 서버에서 가져온 설정 병합
            if (serverSettings.priceSettings) {
              settings.exchangeRate = serverSettings.priceSettings.exchangeRate || settings.exchangeRate;
              settings.packagingCost = serverSettings.priceSettings.packagingCost || settings.packagingCost;
              settings.shipmentCost = serverSettings.priceSettings.shipmentCost || settings.shipmentCost;
              settings.minMargin = serverSettings.priceSettings.minMargin || settings.minMargin;
              if (serverSettings.priceSettings.supplyMargins) {
                settings.supplyMargins = serverSettings.priceSettings.supplyMargins;
              }
              if (serverSettings.priceSettings.saleMargins) {
                settings.saleMargins = serverSettings.priceSettings.saleMargins;
              }
            }

            // 품질표시사항 설정 로드
            if (serverSettings.qualityTable) {
              settings.qualityTable = serverSettings.qualityTable;
            }

            // 상세페이지 기본 템플릿 로드
            if (serverSettings.defaultDetailTemplate && serverSettings.defaultDetailTemplate.length > 0) {
              settings.defaultDetailTemplate = serverSettings.defaultDetailTemplate;
            }

            // 브랜드 이미지 URL 로드
            if (serverSettings.brandImageUrl) {
              settings.brandImageUrl = serverSettings.brandImageUrl;
            }

            // 쿠팡 정보는 localStorage에서만 로드 (보안상)
            const localCreds = localStorage.getItem('totalbotCredentials');
            if (localCreds) {
              try {
                const creds = JSON.parse(localCreds);
                settings.coupangId = creds.coupangId || '';
                settings.coupangPassword = creds.coupangPassword || '';
                settings.address = creds.address || '';
              } catch (e) {
                console.error('localStorage credentials 로드 실패:', e);
              }
            }

            console.log('✅ Settings loaded from server');
          }
        }
      } catch (e) {
        console.warn('서버 설정 로드 실패:', e);
      }
    }

    // 설정 저장 (서버 API에 모든 설정 저장)
    async function saveSettingsToStorage() {
      // 쿠팡 정보는 localStorage에만 저장 (보안상)
      localStorage.setItem('totalbotCredentials', JSON.stringify({
        coupangId: settings.coupangId || '',
        coupangPassword: settings.coupangPassword || '',
        address: settings.address || ''
      }));

      // 서버에 모든 설정 저장
      try {
        const serverSettings = {
          qualityTable: settings.qualityTable,
          defaultDetailTemplate: settings.defaultDetailTemplate,
          brandImageUrl: settings.brandImageUrl || '',
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            packagingCost: settings.packagingCost,
            shipmentCost: settings.shipmentCost,
            minMargin: settings.minMargin,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins
          }
        };

        const response = await authFetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(serverSettings)
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('✅ Settings saved to server');
          } else {
            console.error('❌ 서버 설정 저장 실패:', data.message);
          }
        }
      } catch (e) {
        console.error('❌ 서버 설정 저장 오류:', e);
      }
    }

    let currentEditingImage = null;
    let currentEditingImageUrl = null; // 원본 이미지 URL 추적
    let currentEditingOptionIndexes = null; // 현재 편집 중인 옵션 인덱스들
    let originalImageData = null;
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');

    // 지우개 관련 변수
    let isErasing = false;
    let isMagicErasing = false;
    let isDrawing = false;
    let brushSize = 20;
    let lastX = 0;
    let lastY = 0;
    let maskCanvas = null;
    let maskCtx = null;

    // 페이지 로드
    window.addEventListener('load', async () => {
      await loadSettings(); // 설정 먼저 로드

      const urlParams = new URLSearchParams(window.location.search);
      productId = urlParams.get('id');

      if (productId) {
        loadProduct(productId);
      }
    });

    // 설정 모달 열기
    function openSettingsModal() {
      // 정보 설정값 표시
      document.getElementById('coupangId').value = settings.coupangId || '';
      document.getElementById('coupangPassword').value = settings.coupangPassword || '';
      document.getElementById('address').value = settings.address || '';

      // 가격 설정값 표시
      document.getElementById('settingsExchangeRate').value = settings.exchangeRate;
      document.getElementById('settingsPackagingCost').value = settings.packagingCost;
      document.getElementById('settingsShipmentCost').value = settings.shipmentCost;
      document.getElementById('settingsMinMargin').value = settings.minMargin;

      // 마진 행 렌더링
      renderSupplyMarginRows();
      renderSaleMarginRows();

      // 템플릿 설정 렌더링
      if (settings.brandImageUrl) {
        document.getElementById('brandImagePreview').style.display = 'block';
        document.getElementById('brandImagePreviewImg').src = settings.brandImageUrl;
      }
      renderDefaultDetailTemplate();
      renderDefaultQualityRows();

      document.getElementById('settingsModal').classList.add('active');
    }

    // 설정 모달 닫기
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    // 드롭다운 토글 함수
    function toggleDropdown(dropdownId) {
      const content = document.getElementById(dropdownId);
      const header = content.previousElementSibling;

      // 토글
      content.classList.toggle('active');
      header.classList.toggle('active');
    }

    // 설정 메인 탭 전환
    function switchMainSettingsTab(tabName) {
      // 모든 메인 탭 버튼 비활성화
      document.querySelectorAll('.settings-main-tab').forEach(btn => btn.classList.remove('active'));
      // 모든 메인 탭 컨텐츠 숨기기
      document.querySelectorAll('.settings-main-tab-content').forEach(content => content.classList.remove('active'));

      // 선택한 탭 활성화
      event.target.classList.add('active');
      document.getElementById(`${tabName}-main-settings-tab`).classList.add('active');
    }

    // 설정 탭 전환 (가격 설정 내부)
    function switchSettingsTab(tabName) {
      // 모든 탭 버튼 비활성화
      document.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active'));
      // 모든 탭 컨텐츠 숨기기
      document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));

      // 선택한 탭 활성화
      event.target.classList.add('active');
      document.getElementById(`${tabName}-settings-tab`).classList.add('active');
    }

    // 공급가 마진 행 렌더링
    function renderSupplyMarginRows() {
      const container = document.getElementById('supplyMarginRows');
      container.innerHTML = '';

      settings.supplyMargins.forEach((margin, index) => {
        const row = document.createElement('div');
        row.className = 'margin-row';
        row.innerHTML = `
          <div>
            <input type="number"
              value="${margin.amount === Infinity ? '' : margin.amount}"
              placeholder="금액 (원)"
              onchange="updateSupplyMargin(${index}, 'amount', this.value)"
              ${margin.amount === Infinity ? 'disabled' : ''}>
            <small style="font-size: 11px; color: #888;">미만</small>
          </div>
          <div>
            <input type="number"
              value="${margin.percent}"
              placeholder="마진 (%)"
              onchange="updateSupplyMargin(${index}, 'percent', this.value)">
            <small style="font-size: 11px; color: #888;">%</small>
          </div>
          <button onclick="deleteSupplyMargin(${index})" ${margin.amount === Infinity ? 'disabled' : ''}>삭제</button>
        `;
        container.appendChild(row);
      });
    }

    // 판매가 마진 행 렌더링
    function renderSaleMarginRows() {
      const container = document.getElementById('saleMarginRows');
      container.innerHTML = '';

      settings.saleMargins.forEach((margin, index) => {
        const row = document.createElement('div');
        row.className = 'margin-row';
        row.innerHTML = `
          <div>
            <input type="number"
              value="${margin.amount === Infinity ? '' : margin.amount}"
              placeholder="금액 (원)"
              onchange="updateSaleMargin(${index}, 'amount', this.value)"
              ${margin.amount === Infinity ? 'disabled' : ''}>
            <small style="font-size: 11px; color: #888;">미만</small>
          </div>
          <div>
            <input type="number"
              value="${margin.percent}"
              placeholder="마진 (%)"
              onchange="updateSaleMargin(${index}, 'percent', this.value)">
            <small style="font-size: 11px; color: #888;">%</small>
          </div>
          <button onclick="deleteSaleMargin(${index})" ${margin.amount === Infinity ? 'disabled' : ''}>삭제</button>
        `;
        container.appendChild(row);
      });
    }

    // 공급가 마진 업데이트
    function updateSupplyMargin(index, field, value) {
      if (field === 'amount') {
        settings.supplyMargins[index].amount = value === '' ? Infinity : parseFloat(value);
      } else {
        settings.supplyMargins[index].percent = parseFloat(value);
      }
    }

    // 판매가 마진 업데이트
    function updateSaleMargin(index, field, value) {
      if (field === 'amount') {
        settings.saleMargins[index].amount = value === '' ? Infinity : parseFloat(value);
      } else {
        settings.saleMargins[index].percent = parseFloat(value);
      }
    }

    // 공급가 마진 행 추가
    function addSupplyMarginRow() {
      // Infinity 행 이전에 추가
      settings.supplyMargins.splice(settings.supplyMargins.length - 1, 0, { amount: 0, percent: 30 });
      renderSupplyMarginRows();
    }

    // 판매가 마진 행 추가
    function addSaleMarginRow() {
      settings.saleMargins.splice(settings.saleMargins.length - 1, 0, { amount: 0, percent: 15 });
      renderSaleMarginRows();
    }

    // 공급가 마진 행 삭제
    function deleteSupplyMargin(index) {
      if (settings.supplyMargins[index].amount !== Infinity) {
        settings.supplyMargins.splice(index, 1);
        renderSupplyMarginRows();
      }
    }

    // 판매가 마진 행 삭제
    function deleteSaleMargin(index) {
      if (settings.saleMargins[index].amount !== Infinity) {
        settings.saleMargins.splice(index, 1);
        renderSaleMarginRows();
      }
    }

    // 공급가 마진 정렬
    function sortSupplyMarginRows() {
      const infinityRow = settings.supplyMargins.pop();
      settings.supplyMargins.sort((a, b) => a.amount - b.amount);
      settings.supplyMargins.push(infinityRow);
      renderSupplyMarginRows();
    }

    // 판매가 마진 정렬
    function sortSaleMarginRows() {
      const infinityRow = settings.saleMargins.pop();
      settings.saleMargins.sort((a, b) => a.amount - b.amount);
      settings.saleMargins.push(infinityRow);
      renderSaleMarginRows();
    }

    // 공급가 마진 모두 삭제
    function clearSupplyMarginRows() {
      if (confirm('모든 공급가 마진 설정을 삭제하시겠습니까?')) {
        settings.supplyMargins = [{ amount: Infinity, percent: 30 }];
        renderSupplyMarginRows();
      }
    }

    // 판매가 마진 모두 삭제
    function clearSaleMarginRows() {
      if (confirm('모든 판매가 마진 설정을 삭제하시겠습니까?')) {
        settings.saleMargins = [{ amount: Infinity, percent: 15 }];
        renderSaleMarginRows();
      }
    }

    // 설정 저장
    async function saveSettings() {
      // 정보 설정 저장
      settings.coupangId = document.getElementById('coupangId').value || '';
      settings.coupangPassword = document.getElementById('coupangPassword').value || '';
      settings.address = document.getElementById('address').value || '';

      // 가격 설정 저장
      settings.exchangeRate = parseFloat(document.getElementById('settingsExchangeRate').value) || 190;
      settings.packagingCost = parseFloat(document.getElementById('settingsPackagingCost').value) || 500;
      settings.shipmentCost = parseFloat(document.getElementById('settingsShipmentCost').value) || 0;
      settings.minMargin = parseFloat(document.getElementById('settingsMinMargin').value) || 3000;

      // 품질표시사항 설정 저장
      if (!settings.qualityTable) settings.qualityTable = {};
      settings.qualityTable.제조사 = document.getElementById('qtManufacturer').value || '';
      settings.qualityTable.취급시주의사항 = document.getElementById('qtCaution').value || '상세페이지 참조';
      settings.qualityTable.제조연월 = document.getElementById('qtManufactureDate').value || '';
      settings.qualityTable.품질보증기준 = document.getElementById('qtWarranty').value || '관련법 및 소비자 분쟁해결 규정에 따름';
      settings.qualityTable.AS책임자 = document.getElementById('qtAS').value || '';

      // 서버에 저장
      await saveSettingsToStorage();

      // 가격 재계산
      renderOptions();

      closeSettingsModal();
      showAlert('설정이 저장되었습니다.', 'success');
    }

    // 대표 이미지 업로드
    function handleBrandImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          settings.brandImageUrl = e.target.result;
          document.getElementById('brandImagePreview').style.display = 'block';
          document.getElementById('brandImagePreviewImg').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    // 기본 템플릿에 텍스트 추가
    function addDefaultText() {
      const text = prompt('추가할 텍스트를 입력하세요:');
      if (text) {
        settings.defaultDetailTemplate.push({
          type: 'text',
          label: text,
          text: text
        });
        renderDefaultDetailTemplate();
      }
    }

    // 기본 템플릿 초기화
    function resetDefaultTemplate() {
      if (confirm('기본 템플릿을 초기화하시겠습니까?')) {
        settings.defaultDetailTemplate = [
          { type: 'brand-image', label: '브랜드 이미지' },
          { type: 'title', label: '제품명' },
          { type: 'option-blocks', label: '옵션 블록들' },
          { type: 'quality-table', label: '품질표시사항' }
        ];
        renderDefaultDetailTemplate();
      }
    }

    // 기본 템플릿 렌더링
    function renderDefaultDetailTemplate() {
      const canvas = document.getElementById('defaultDetailPageCanvas');
      canvas.innerHTML = '';

      if (settings.defaultDetailTemplate.length === 0) {
        canvas.innerHTML = '<p style="text-align: center; color: #888; padding: 60px;">템플릿이 비어있습니다.</p>';
        return;
      }

      settings.defaultDetailTemplate.forEach((item, index) => {
        const div = document.createElement('div');
        div.style.cssText = `
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          margin-bottom: 8px;
          background: white;
          border-radius: 6px;
          border: 1px solid #e0e0e0;
        `;

        const label = document.createElement('div');
        label.style.cssText = 'font-size: 14px; font-weight: 500;';
        label.textContent = item.label;

        const actions = document.createElement('div');
        actions.style.cssText = 'display: flex; gap: 8px;';

        // 위로 이동 버튼
        if (index > 0) {
          const upBtn = document.createElement('button');
          upBtn.className = 'btn btn-sm';
          upBtn.textContent = '↑';
          upBtn.onclick = () => {
            [settings.defaultDetailTemplate[index-1], settings.defaultDetailTemplate[index]] =
            [settings.defaultDetailTemplate[index], settings.defaultDetailTemplate[index-1]];
            renderDefaultDetailTemplate();
          };
          actions.appendChild(upBtn);
        }

        // 아래로 이동 버튼
        if (index < settings.defaultDetailTemplate.length - 1) {
          const downBtn = document.createElement('button');
          downBtn.className = 'btn btn-sm';
          downBtn.textContent = '↓';
          downBtn.onclick = () => {
            [settings.defaultDetailTemplate[index], settings.defaultDetailTemplate[index+1]] =
            [settings.defaultDetailTemplate[index+1], settings.defaultDetailTemplate[index]];
            renderDefaultDetailTemplate();
          };
          actions.appendChild(downBtn);
        }

        // 삭제 버튼 (브랜드 이미지, 제품명, 옵션 블록들, 품질표시사항은 삭제 불가)
        if (item.type === 'text') {
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-sm';
          deleteBtn.textContent = '🗑';
          deleteBtn.onclick = () => {
            settings.defaultDetailTemplate.splice(index, 1);
            renderDefaultDetailTemplate();
          };
          actions.appendChild(deleteBtn);
        }

        div.appendChild(label);
        div.appendChild(actions);
        canvas.appendChild(div);
      });
    }

    // 품질표시사항 기본 행 추가
    function addDefaultQualityRow() {
      settings.defaultQualityRows.push({ label: '', value: '' });
      renderDefaultQualityRows();
    }

    // 품질표시사항 행 렌더링
    function renderDefaultQualityRows() {
      // 품질표시사항 설정값 표시
      const qt = settings.qualityTable || {};

      document.getElementById('qtManufacturer').value = qt.제조사 || '';
      document.getElementById('qtCaution').value = qt.취급시주의사항 || '상세페이지 참조';
      document.getElementById('qtManufactureDate').value = qt.제조연월 || '';
      document.getElementById('qtWarranty').value = qt.품질보증기준 || '관련법 및 소비자 분쟁해결 규정에 따름';
      document.getElementById('qtAS').value = qt.AS책임자 || '';

      // 커스텀 행 렌더링
      renderQualityTableCustomRows();
    }

    // 품질표시사항 커스텀 행 렌더링
    function renderQualityTableCustomRows() {
      const container = document.getElementById('qtCustomRows');
      container.innerHTML = '';

      const qt = settings.qualityTable || {};
      const customRows = qt.customRows || [];

      customRows.forEach((row, index) => {
        const rowDiv = document.createElement('div');
        rowDiv.style.cssText = 'display: flex; gap: 12px; align-items: center;';

        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.placeholder = '항목명';
        labelInput.value = row.label || '';
        labelInput.style.cssText = 'flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;';
        labelInput.oninput = (e) => {
          settings.qualityTable.customRows[index].label = e.target.value;
        };

        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.placeholder = '기본값';
        valueInput.value = row.value || '';
        valueInput.style.cssText = 'flex: 2; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;';
        valueInput.oninput = (e) => {
          settings.qualityTable.customRows[index].value = e.target.value;
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-secondary btn-sm';
        deleteBtn.textContent = '🗑';
        deleteBtn.style.cssText = 'padding: 8px 12px;';
        deleteBtn.onclick = () => {
          settings.qualityTable.customRows.splice(index, 1);
          renderQualityTableCustomRows();
        };

        rowDiv.appendChild(labelInput);
        rowDiv.appendChild(valueInput);
        rowDiv.appendChild(deleteBtn);
        container.appendChild(rowDiv);
      });
    }

    // 품질표시사항 커스텀 행 추가
    function addQualityTableCustomRow() {
      if (!settings.qualityTable) settings.qualityTable = {};
      if (!settings.qualityTable.customRows) settings.qualityTable.customRows = [];

      settings.qualityTable.customRows.push({ label: '', value: '' });
      renderQualityTableCustomRows();
    }

    // 메인 탭 전환
    function switchMainTab(tabName) {
      // 모든 탭 버튼 비활성화
      document.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
      // 모든 탭 컨텐츠 숨기기
      document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));

      // 선택한 탭 활성화
      event.target.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // 상품 데이터 로드
    // 추가 이미지 선택 토글
    function toggleAdditionalImageSelection(imageUrl, event) {
      // 편집 버튼 클릭시에는 선택되지 않도록
      if (event.target.classList.contains('image-edit-btn')) {
        return;
      }

      if (selectedAdditionalImages.has(imageUrl)) {
        selectedAdditionalImages.delete(imageUrl);
      } else {
        selectedAdditionalImages.add(imageUrl);
      }

      // UI 업데이트
      const imgElement = document.querySelector(`[data-additional-image="${imageUrl}"]`);
      if (imgElement) {
        imgElement.classList.toggle('selected');
      }
    }

    // 옵션 이미지 선택 토글
    function toggleOptionImageSelection(imageUrl, event) {
      // 버튼 클릭시에는 선택되지 않도록
      if (event && event.target && (event.target.tagName === 'BUTTON' || event.target.classList.contains('image-edit-btn'))) {
        return;
      }

      if (selectedOptionImages.has(imageUrl)) {
        selectedOptionImages.delete(imageUrl);
      } else {
        selectedOptionImages.add(imageUrl);
      }

      // UI 업데이트
      const imgElement = document.querySelector(`[data-option-image="${imageUrl}"]`);
      if (imgElement) {
        imgElement.classList.toggle('selected');
      }
    }

    // 유니크 옵션 이미지 렌더링
    function renderUniqueOptionImages() {
      const optionImagesGrid = document.getElementById('optionImagesGridTab');
      optionImagesGrid.innerHTML = '';

      if (!productData.results || productData.results.length === 0) {
        optionImagesGrid.innerHTML = '<p style="color: #888; padding: 20px;">옵션 이미지가 없습니다.</p>';
        return;
      }

      // 유니크 이미지 추출 (이미지별로 사용 횟수도 계산)
      const imageMap = new Map();

      productData.results.forEach((option, index) => {
        const imgSrc = option.imageLink || option.titleImage?.[0] || '';
        if (imgSrc) {
          if (!imageMap.has(imgSrc)) {
            imageMap.set(imgSrc, {
              url: imgSrc,
              count: 0,
              optionIndexes: []
            });
          }
          const imageInfo = imageMap.get(imgSrc);
          imageInfo.count++;
          imageInfo.optionIndexes.push(index);
        }
      });

      // 유니크 이미지들을 그리드에 표시
      imageMap.forEach((imageInfo, imgSrc) => {
        const container = document.createElement('div');
        container.className = 'image-item-container option-image-item';
        container.setAttribute('data-option-image', imgSrc);

        // 선택 상태 복원
        if (selectedOptionImages.has(imgSrc)) {
          container.classList.add('selected');
        }

        // 컨테이너 클릭 시 선택/해제
        container.onclick = (e) => {
          if (e.target.tagName === 'BUTTON') return; // 버튼 클릭은 무시
          toggleOptionImageSelection(imgSrc, e);
        };

        const img = document.createElement('img');
        img.src = imgSrc;
        img.onerror = function() {
          this.parentElement.innerHTML = '<div style="padding: 20px; background: #f5f5f5; text-align: center; border-radius: 6px;">📷</div>';
        };

        // 삭제 버튼 (우측 상단)
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'image-delete-btn';
        deleteBtn.innerHTML = '×';
        deleteBtn.title = `이 이미지를 사용하는 ${imageInfo.count}개 옵션 삭제`;
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteOptionsByImage(imgSrc, imageInfo.optionIndexes);
        };

        // 편집 버튼
        const editBtn = document.createElement('button');
        editBtn.className = 'image-edit-btn';
        editBtn.textContent = '편집';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          openMagicBrush(imgSrc, imageInfo.optionIndexes);
        };

        // 교체 버튼 (우측 하단)
        const replaceBtn = document.createElement('button');
        replaceBtn.className = 'image-replace-btn';
        replaceBtn.innerHTML = '🔄';
        replaceBtn.title = '이미지 교체';
        replaceBtn.onclick = (e) => {
          e.stopPropagation();
          triggerImageReplace(imgSrc, imageInfo.optionIndexes);
        };

        const countLabel = document.createElement('div');
        countLabel.className = 'option-image-count';
        countLabel.textContent = `${imageInfo.count}개 옵션`;

        container.appendChild(img);
        container.appendChild(deleteBtn);
        container.appendChild(editBtn);
        container.appendChild(replaceBtn);
        container.appendChild(countLabel);
        optionImagesGrid.appendChild(container);
      });
    }

    // 이미지를 사용하는 옵션들 삭제
    function deleteOptionsByImage(imgSrc, optionIndexes) {
      const count = optionIndexes.length;
      if (!confirm(`이 이미지를 사용하는 ${count}개 옵션을 삭제하시겠습니까?\n\n삭제된 옵션은 복구할 수 없습니다.`)) {
        return;
      }

      // 인덱스가 큰 것부터 삭제해야 인덱스가 밀리지 않음
      const sortedIndexes = [...optionIndexes].sort((a, b) => b - a);
      sortedIndexes.forEach(index => {
        productData.results.splice(index, 1);
      });

      // UI 업데이트
      renderOptions();
      renderUniqueOptionImages();
      scheduleAutoSave();

      showAlert(`${count}개 옵션이 삭제되었습니다.`, 'success');
    }

    // 이미지 교체 트리거
    function triggerImageReplace(oldImgSrc, optionIndexes) {
      // 숨겨진 파일 인풋 생성
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.className = 'hidden-file-input';

      fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          // 파일을 Base64로 변환
          const reader = new FileReader();
          reader.onload = async (event) => {
            const newImgSrc = event.target.result;

            // 해당 이미지를 사용하는 모든 옵션의 이미지 교체
            optionIndexes.forEach(index => {
              if (productData.results[index]) {
                productData.results[index].imageLink = newImgSrc;
                if (productData.results[index].titleImage) {
                  productData.results[index].titleImage[0] = newImgSrc;
                }
              }
            });

            // UI 업데이트
            renderOptions();
            renderUniqueOptionImages();
            scheduleAutoSave();

            showAlert(`${optionIndexes.length}개 옵션의 이미지가 교체되었습니다.`, 'success');
          };
          reader.readAsDataURL(file);
        } catch (error) {
          console.error('이미지 교체 오류:', error);
          showAlert('이미지 교체에 실패했습니다.', 'error');
        }
      };

      // 파일 선택 다이얼로그 열기
      fileInput.click();
    }

    async function loadProduct(id) {
      try {
        const response = await authFetch(`/api/products/${id}`);

        if (!response.ok) {
          throw new Error('상품을 불러올 수 없습니다.');
        }

        const data = await response.json();
        productData = data.product;

        // 저장된 선택 이미지 복원 (견적서용)
        if (productData.selectedAdditionalImages && Array.isArray(productData.selectedAdditionalImages)) {
          selectedAdditionalImages = new Set(productData.selectedAdditionalImages);
        } else {
          selectedAdditionalImages = new Set();
        }

        // 상품명 표시
        document.getElementById('productTitle').value = productData.title || productData.titleCn || '';

        // 추가 이미지들 (이미지 탭 - 좌측)
        const additionalGridTab = document.getElementById('additionalImagesGridTab');
        additionalGridTab.innerHTML = '';

        // 대표 이미지를 추가 이미지 목록 맨 앞에 추가
        const allImages = [];
        if (productData.mainImage) {
          allImages.push(productData.mainImage);
        }
        if (productData.images && productData.images.length > 0) {
          allImages.push(...productData.images);
        }

        if (allImages.length > 0) {
          allImages.forEach(img => {
            const container = document.createElement('div');
            container.className = 'image-item-container additional-image-item';
            container.setAttribute('data-additional-image', img);

            // 이전 선택 상태 복원
            if (selectedAdditionalImages.has(img)) {
              container.classList.add('selected');
            }

            const imgEl = document.createElement('img');
            imgEl.src = img;
            imgEl.onerror = function() { this.style.display = 'none'; };

            // 편집 버튼
            const editBtn = document.createElement('button');
            editBtn.className = 'image-edit-btn';
            editBtn.textContent = '편집';
            editBtn.onclick = (e) => {
              e.stopPropagation();
              openMagicBrush(img);
            };

            // 컨테이너 클릭시 선택/해제
            container.onclick = (e) => toggleAdditionalImageSelection(img, e);

            container.appendChild(imgEl);
            container.appendChild(editBtn);
            additionalGridTab.appendChild(container);
          });
        } else {
          additionalGridTab.innerHTML = '<p style="color: #888; padding: 20px;">추가 이미지가 없습니다.</p>';
        }

        // 옵션 이미지 렌더링 (이미지 탭 - 우측)
        renderUniqueOptionImages();

        // 옵션 렌더링
        renderOptions();

        // 매핑 리스트 초기화 (기본 탭이 매핑이므로)
        renderMappingLists();

        // 상세페이지 에디터 초기화
        initDetailPageEditor();

        // 자동 번역 (빈 필드만 번역)
        await autoTranslate(true);

        showAlert('상품 데이터를 불러왔습니다.', 'success');
      } catch (error) {
        console.error('상품 로드 오류:', error);
        showAlert('상품 데이터를 불러오는데 실패했습니다.', 'error');
      }
    }

    // ========================================
    // 상세페이지 에디터 기능
    // ========================================

    // 품질표시사항 행을 설정값으로 업데이트
    function updateQualityTableFromSettings(items) {
      const qt = settings.qualityTable || {};

      items.forEach(item => {
        if (item.type === 'quality-table' && item.rows) {
          item.rows.forEach(row => {
            // 설정에서 값 가져와서 업데이트 (빈 값이 아닌 경우에만)
            switch(row.label) {
              case '제조사':
                if (qt.제조사) row.value = qt.제조사;
                break;
              case '취급시 주의사항':
                if (qt.취급시주의사항) row.value = qt.취급시주의사항;
                break;
              case '제조 연월':
                if (qt.제조연월) row.value = qt.제조연월;
                break;
              case '품질보증기준':
                if (qt.품질보증기준) row.value = qt.품질보증기준;
                break;
              case 'A/S 책임자와 전화번호':
                if (qt.AS책임자) row.value = qt.AS책임자;
                break;
            }
          });
        }
      });

      return items;
    }

    // 옵션 탭의 옵션명을 상세페이지 아이템에 동기화
    function syncOptionNamesToDetailPage() {
      if (!productData.results || !detailPageItems) return;

      // productData.results에서 유니크한 옵션명 목록 생성
      const currentOptionNames = [...new Set(
        productData.results.map(opt => opt.optionName1 || opt.optionName1Cn || '')
      )].filter(name => name);

      // detailPageItems의 option-block들 찾기
      const optionBlocks = detailPageItems.filter(item => item.type === 'option-block');

      // 순서대로 매칭하여 옵션명 동기화
      optionBlocks.forEach((block, index) => {
        if (currentOptionNames[index] && block.optionName !== currentOptionNames[index]) {
          console.log(`[Sync] 옵션명 동기화: "${block.optionName}" → "${currentOptionNames[index]}"`);
          block.optionName = currentOptionNames[index];
        }
      });
    }

    // 상세페이지 에디터 초기화
    function initDetailPageEditor() {
      renderDetailSources();

      // 저장된 detailPageItems가 있으면 불러오기, 없으면 자동 생성
      if (productData.detailPageItems && productData.detailPageItems.length > 0) {
        console.log('[Editor] 저장된 detailPageItems 불러오기 (' + productData.detailPageItems.length + '개)');
        detailPageItems = productData.detailPageItems;

        // 옵션 탭에서 수정된 옵션명을 상세페이지에 동기화
        syncOptionNamesToDetailPage();

        // 품질표시사항에 현재 설정값 적용
        updateQualityTableFromSettings(detailPageItems);
        renderDetailCanvas();
      } else {
        console.log('[Editor] detailPageItems 없음, 자동 생성');
        autoGenerateDetailPage();
      }

      // 드롭 존 설정
      const canvas = document.getElementById('detailPageCanvas');
      let dropIndicator = null;
      let dropIndex = -1;

      canvas.addEventListener('dragover', (e) => {
        e.preventDefault();

        // 재정렬 작업 중이면 캔버스의 드롭 인디케이터 숨김
        if (draggedItem !== null) {
          if (dropIndicator && dropIndicator.parentNode) {
            dropIndicator.parentNode.removeChild(dropIndicator);
            dropIndicator = null;
          }
          return;
        }

        e.dataTransfer.dropEffect = 'copy';

        // 드롭 위치 계산
        const items = canvas.querySelectorAll('.detail-page-item');
        let closestItem = null;
        let closestDistance = Number.POSITIVE_INFINITY;
        let insertBefore = false;

        items.forEach((item, index) => {
          const rect = item.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          const distance = Math.abs(e.clientY - midpoint);

          if (distance < closestDistance) {
            closestDistance = distance;
            closestItem = item;
            insertBefore = e.clientY < midpoint;
            dropIndex = insertBefore ? index : index + 1;
          }
        });

        // 드롭 인디케이터 표시
        if (!dropIndicator) {
          dropIndicator = document.createElement('div');
          dropIndicator.style.cssText = `
            height: 3px;
            background: #1e90ff;
            margin: 4px 0;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(30, 144, 255, 0.5);
          `;
        }

        if (closestItem) {
          if (insertBefore) {
            closestItem.parentNode.insertBefore(dropIndicator, closestItem);
          } else {
            closestItem.parentNode.insertBefore(dropIndicator, closestItem.nextSibling);
          }
        } else {
          // 빈 캔버스거나 모든 아이템 아래
          canvas.appendChild(dropIndicator);
          dropIndex = detailPageItems.length;
        }
      });

      canvas.addEventListener('dragleave', (e) => {
        if (e.target === canvas && dropIndicator && dropIndicator.parentNode) {
          dropIndicator.parentNode.removeChild(dropIndicator);
          dropIndicator = null;
        }
      });

      canvas.addEventListener('drop', (e) => {
        e.preventDefault();

        if (dropIndicator && dropIndicator.parentNode) {
          dropIndicator.parentNode.removeChild(dropIndicator);
          dropIndicator = null;
        }

        // 재정렬 작업은 무시 (setupDragEvents에서 처리)
        const isReorder = e.dataTransfer.getData('reorder');
        if (isReorder === 'true') {
          return;
        }

        const imageSrc = e.dataTransfer.getData('imageSrc');
        const textType = e.dataTransfer.getData('textType');
        const label = e.dataTransfer.getData('label');

        // 텍스트 드롭
        if (textType) {
          const labels = {
            'title': '타이틀',
            'subtitle': '중간 타이틀',
            'paragraph': '일반 텍스트'
          };

          const newItem = {
            type: 'custom-text',
            textType: textType,
            text: '',
            color: '#000000',
            align: 'left',
            font: 'system-ui',
            label: labels[textType]
          };

          // 드롭 위치에 삽입
          if (dropIndex >= 0 && dropIndex < detailPageItems.length) {
            detailPageItems.splice(dropIndex, 0, newItem);
          } else {
            detailPageItems.push(newItem);
          }

          renderDetailCanvas();
          showAlert(`${labels[textType]}이(가) 추가되었습니다.`, 'success');
          dropIndex = -1;
          return;
        }

        // 이미지 드롭
        if (!imageSrc) return;

        const imageCount = detailPageItems.filter(item =>
          item.type === 'brand-image' || item.type === 'image' || item.type === 'option-block'
        ).length + 1;

        const newItem = {
          type: 'image',
          imageSrc: imageSrc,
          label: label,
          imageNumber: imageCount,
          layout: 'presentation',
          align: 'center',
          imageText: '',
          textPosition: 'right'
        };

        // 드롭 위치에 삽입
        if (dropIndex >= 0 && dropIndex < detailPageItems.length) {
          detailPageItems.splice(dropIndex, 0, newItem);
        } else {
          detailPageItems.push(newItem);
        }

        renderDetailCanvas();
        showAlert('이미지가 추가되었습니다', 'success');
        dropIndex = -1;
      });

      // 텍스트 버튼 드래그 이벤트 설정
      setupTextDragEvents();

      // 상품명 변경 시 상세페이지 제품명 자동 업데이트
      const productTitleInput = document.getElementById('productTitle');
      if (productTitleInput) {
        productTitleInput.addEventListener('input', (e) => {
          const newTitle = e.target.value;
          updateDetailPageTitle(newTitle);
        });
      }
    }

    // 상세페이지 제품명 업데이트
    function updateDetailPageTitle(newTitle) {
      let updated = false;
      detailPageItems.forEach(item => {
        // 'title' 타입 아이템의 텍스트 업데이트
        if (item.type === 'title') {
          item.text = newTitle;
          item.label = newTitle;
          updated = true;
        }
        // 품질표시사항의 상품명도 업데이트
        if (item.type === 'quality-table' && item.rows) {
          item.rows.forEach(row => {
            if (row.label === '상품명') {
              row.value = newTitle;
              updated = true;
            }
          });
        }
      });

      if (updated) {
        renderDetailCanvas();
      }
    }

    // 텍스트 버튼 드래그 이벤트 설정
    function setupTextDragEvents() {
      const textButtons = document.querySelectorAll('.text-add-btn[draggable="true"]');

      textButtons.forEach(btn => {
        btn.addEventListener('dragstart', (e) => {
          const textType = e.target.dataset.textType;
          e.dataTransfer.setData('textType', textType);
          e.dataTransfer.effectAllowed = 'copy';

          // 드래그 중 스타일 변경
          e.target.style.opacity = '0.5';
          e.target.style.cursor = 'grabbing';
        });

        btn.addEventListener('dragend', (e) => {
          // 드래그 끝나면 스타일 복원
          e.target.style.opacity = '1';
          e.target.style.cursor = 'grab';
        });
      });
    }

    // 사용 가능한 이미지 소스 렌더링
    function renderDetailSources() {
      // 대표 이미지
      const mainImageSource = document.getElementById('detailMainImageSource');
      mainImageSource.innerHTML = '';
      if (productData.mainImage) {
        const item = createSourceImageItem(productData.mainImage, '대표 이미지');
        mainImageSource.appendChild(item);
      }

      // 추가 이미지
      const additionalImagesSource = document.getElementById('detailAdditionalImagesSource');
      additionalImagesSource.innerHTML = '';
      if (productData.images && productData.images.length > 0) {
        productData.images.forEach((img, index) => {
          const item = createSourceImageItem(img, `추가 이미지 ${index + 1}`);
          additionalImagesSource.appendChild(item);
        });
      }

      // 옵션 이미지 (유니크)
      const optionImagesSource = document.getElementById('detailOptionImagesSource');
      optionImagesSource.innerHTML = '';

      const uniqueOptionImages = new Map();
      if (productData.results) {
        productData.results.forEach(option => {
          const img = option.imageLink || option.titleImage?.[0];
          if (img && !uniqueOptionImages.has(img)) {
            const optionName = option.optionName1 || option.optionName1Cn || '옵션';
            uniqueOptionImages.set(img, optionName);
          }
        });

        uniqueOptionImages.forEach((name, img) => {
          const item = createSourceImageItem(img, name, true);
          optionImagesSource.appendChild(item);
        });
      }
    }

    // 소스 이미지 아이템 생성
    function createSourceImageItem(imageSrc, label, isOption = false) {
      const div = document.createElement('div');
      div.className = 'source-image-item';
      div.draggable = true;
      div.dataset.imageSrc = imageSrc;
      div.dataset.label = label;
      div.dataset.isOption = isOption;

      const img = document.createElement('img');
      img.src = imageSrc;
      img.onerror = function() {
        this.parentElement.style.display = 'none';
      };

      div.appendChild(img);

      // 드래그 이벤트
      div.addEventListener('dragstart', (e) => {
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('imageSrc', imageSrc);
        e.dataTransfer.setData('label', label);
        e.dataTransfer.setData('isOption', isOption);
      });

      div.addEventListener('click', () => {
        // 추가 이미지만 클릭으로 추가 가능 (대표 이미지와 옵션 이미지는 자동 구성에 포함됨)
        if (!isOption && label.includes('추가 이미지')) {
          const imageCount = detailPageItems.filter(item =>
            item.type === 'brand-image' || item.type === 'image' || item.type === 'option-block'
          ).length + 1;

          addDetailPageItem({
            type: 'image',
            imageSrc: imageSrc,
            label: label,
            imageNumber: imageCount,
            layout: 'presentation',
            align: 'center',
            imageText: '',
            textPosition: 'right'
          });
        }
      });

      return div;
    }

    // 상세페이지 캔버스 렌더링
    function renderDetailCanvas() {
      const canvas = document.getElementById('detailPageCanvas');
      canvas.innerHTML = '';

      if (detailPageItems.length === 0) {
        canvas.innerHTML = '<p style="text-align: center; color: #888; padding: 60px;">좌측에서 이미지를 드래그하거나 클릭하여 추가하세요</p>';
        return;
      }

      detailPageItems.forEach((item, index) => {
        const itemEl = createDetailPageItemElement(item, index);
        canvas.appendChild(itemEl);
      });
    }

    // 상세페이지 아이템 엘리먼트 생성
    function createDetailPageItemElement(item, index) {
      const div = document.createElement('div');
      div.className = 'detail-page-item';
      div.draggable = true;
      div.dataset.index = index;

      // 품질표시사항 블록
      if (item.type === 'quality-table') {
        div.classList.add('quality-table');

        // 헤더
        const header = document.createElement('div');
        header.className = 'quality-table-header';

        const handle = document.createElement('span');
        handle.className = 'item-drag-handle';
        handle.innerHTML = '⋮⋮';

        const title = document.createElement('div');
        title.className = 'quality-table-title';
        title.textContent = item.title || '품질표시사항';
        title.contentEditable = true;
        title.onblur = (e) => {
          detailPageItems[index].title = e.target.textContent;
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'item-action-btn delete';
        deleteBtn.innerHTML = '🗑';
        deleteBtn.title = '삭제';
        deleteBtn.onclick = () => {
          detailPageItems.splice(index, 1);
          renderDetailCanvas();
        };

        header.appendChild(handle);
        header.appendChild(title);
        header.appendChild(deleteBtn);

        // 테이블 컨텐츠
        const tableContent = document.createElement('div');
        tableContent.className = 'quality-table-content';

        if (item.rows && item.rows.length > 0) {
          item.rows.forEach((row, rowIndex) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'quality-table-row';

            const label = document.createElement('div');
            label.className = 'quality-table-label';
            label.textContent = row.label || '항목';
            label.contentEditable = true;
            label.onblur = (e) => {
              detailPageItems[index].rows[rowIndex].label = e.target.textContent;
            };

            const value = document.createElement('div');
            value.className = 'quality-table-value';
            value.textContent = row.value || '내용';
            value.contentEditable = true;
            value.onblur = (e) => {
              detailPageItems[index].rows[rowIndex].value = e.target.textContent;
            };

            rowDiv.appendChild(label);
            rowDiv.appendChild(value);
            tableContent.appendChild(rowDiv);
          });
        }

        div.appendChild(header);
        div.appendChild(tableContent);

        setupDragEvents(div, index);
        return div;
      }

      // 옵션 블록은 특별한 레이아웃
      if (item.type === 'option-block') {
        div.classList.add('option-block');

        // 드래그 핸들
        const handle = document.createElement('span');
        handle.className = 'item-drag-handle';
        handle.innerHTML = '⋮⋮';

        // 컨텐츠 (좌측 이미지 + 우측 텍스트)
        const content = document.createElement('div');
        content.className = 'option-block-content';

        const imagePlaceholder = document.createElement('div');
        imagePlaceholder.className = 'option-block-image';
        if (item.imageSrc) {
          imagePlaceholder.innerHTML = '<img src="' + item.imageSrc + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">';
        } else {
          imagePlaceholder.textContent = item.imageLabel || '[Image #1]';
        }

        const textArea = document.createElement('div');
        textArea.className = 'option-block-text';

        const title = document.createElement('div');
        title.className = 'option-block-title';
        title.textContent = item.optionName || '옵션명';
        title.contentEditable = true;
        title.onblur = (e) => {
          detailPageItems[index].optionName = e.target.textContent;
        };

        // 템플릿 선택기 추가
        const templateSelect = document.createElement('select');
        templateSelect.className = 'template-select-inline';
        templateSelect.dataset.itemIndex = index; // 인덱스를 dataset에 저장
        templateSelect.innerHTML = `
          <optgroup label="기본 스타일">
            <option value="horizontal" ${item.template === 'horizontal' ? 'selected' : ''}>가로형</option>
            <option value="horizontal-reverse" ${item.template === 'horizontal-reverse' ? 'selected' : ''}>가로형 반전</option>
            <option value="vertical" ${item.template === 'vertical' ? 'selected' : ''}>세로형</option>
            <option value="card" ${item.template === 'card' ? 'selected' : ''}>카드형</option>
            <option value="centered" ${item.template === 'centered' ? 'selected' : ''}>중앙 정렬</option>
            <option value="split" ${item.template === 'split' ? 'selected' : ''}>50/50 분할</option>
            <option value="gradient" ${item.template === 'gradient' ? 'selected' : ''}>그라데이션</option>
          </optgroup>
          <optgroup label="컬러풀">
            <option value="modern" ${item.template === 'modern' ? 'selected' : ''}>🟣 모던 (보라)</option>
            <option value="neon" ${item.template === 'neon' ? 'selected' : ''}>💗 네온 (핑크)</option>
            <option value="sunset" ${item.template === 'sunset' ? 'selected' : ''}>🌅 일몰 (오렌지)</option>
            <option value="ocean" ${item.template === 'ocean' ? 'selected' : ''}>🌊 바다 (파랑)</option>
            <option value="mint" ${item.template === 'mint' ? 'selected' : ''}>🌿 민트 (초록)</option>
            <option value="dark" ${item.template === 'dark' ? 'selected' : ''}>🌙 다크모드</option>
          </optgroup>
          <optgroup label="독특한 스타일">
            <option value="neon-border" ${item.template === 'neon-border' ? 'selected' : ''}>✨ 네온 테두리</option>
            <option value="badge" ${item.template === 'badge' ? 'selected' : ''}>🏷️ 배지형</option>
            <option value="diagonal" ${item.template === 'diagonal' ? 'selected' : ''}>📐 대각선</option>
            <option value="overlay" ${item.template === 'overlay' ? 'selected' : ''}>🖼️ 오버레이</option>
          </optgroup>
        `;
        templateSelect.onchange = function(e) {
          const newTemplate = e.target.value;
          const itemIndex = parseInt(e.target.dataset.itemIndex);

          // 옵션명으로 아이템 찾기 (더 안전)
          const optionName = item.optionName;
          const foundIndex = detailPageItems.findIndex((it, idx) =>
            it.type === 'option-block' && it.optionName === optionName
          );

          if (foundIndex !== -1) {
            detailPageItems[foundIndex].template = newTemplate;
            console.log(`✅ 템플릿 변경 성공: 옵션="${optionName}", index=${foundIndex}, template=${newTemplate}`, detailPageItems[foundIndex]);
            showAlert(`"${optionName}" 템플릿이 ${newTemplate}로 변경되었습니다.`, 'success');
          } else {
            console.error(`❌ 템플릿 변경 실패: 옵션="${optionName}"을 찾을 수 없음`);
          }
        };

        const subtitle = document.createElement('div');
        subtitle.className = 'option-block-subtitle';
        subtitle.textContent = item.option2List || '옵션2 목록';
        subtitle.contentEditable = true;
        subtitle.onblur = (e) => {
          detailPageItems[index].option2List = e.target.textContent;
        };

        textArea.appendChild(title);
        textArea.appendChild(templateSelect);
        textArea.appendChild(subtitle);

        content.appendChild(imagePlaceholder);
        content.appendChild(textArea);

        // 삭제 버튼
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'item-action-btn delete';
        deleteBtn.innerHTML = '🗑';
        deleteBtn.title = '삭제';
        deleteBtn.onclick = () => {
          detailPageItems.splice(index, 1);
          renderDetailCanvas();
        };

        div.appendChild(handle);
        div.appendChild(content);
        div.appendChild(deleteBtn);

        setupDragEvents(div, index);
        return div;
      }

      // 커스텀 텍스트 블록 (색상 + 정렬 옵션 포함)
      if (item.type === 'custom-text') {
        div.classList.add('custom-text-block');

        // 드래그 핸들
        const handle = document.createElement('span');
        handle.className = 'item-drag-handle';
        handle.innerHTML = '⋮⋮';

        // 컨텐츠 영역
        const content = document.createElement('div');
        content.className = 'custom-text-content';
        content.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 10px;';

        // 텍스트 입력
        const textInput = document.createElement('textarea');
        textInput.className = 'custom-text-input';
        textInput.value = item.text || '';
        textInput.placeholder = '텍스트를 입력하세요...';

        // 타입별 기본 폰트 크기
        const fontSizes = {
          'title': '24',
          'subtitle': '18',
          'paragraph': '14'
        };
        const defaultFontSize = fontSizes[item.textType] || '14';

        // 스타일 미리보기 적용 함수
        const applyPreviewStyles = () => {
          const color = item.color || '#000000';
          const align = item.align || 'left';
          const font = item.font || 'system-ui';
          const fontSize = item.fontSize || defaultFontSize;
          const fontWeight = item.fontWeight || 'normal';
          const borderStyle = item.borderStyle || 'none';

          let borderCss = '1px solid #e5e8eb';
          let borderRadius = '6px';
          let borderLeft = 'none';

          switch(borderStyle) {
            case 'thin':
              borderCss = '1px solid #ccc';
              break;
            case 'box':
              borderCss = '2px solid #333';
              break;
            case 'rounded':
              borderCss = '2px solid #1e90ff';
              borderRadius = '12px';
              break;
            case 'left-accent':
              borderCss = '1px solid #e5e8eb';
              borderLeft = '4px solid #1e90ff';
              break;
          }

          textInput.style.cssText = `
            width: 100%;
            padding: 12px;
            border: ${borderCss};
            border-radius: ${borderRadius};
            ${borderLeft !== 'none' ? 'border-left: ' + borderLeft + ';' : ''}
            font-size: ${fontSize}px;
            font-family: ${font};
            color: ${color};
            text-align: ${align};
            font-weight: ${fontWeight};
            resize: vertical;
            min-height: 60px;
            background: #fafbfc;
            transition: all 0.2s;
          `;
        };

        // 초기 스타일 적용
        applyPreviewStyles();

        textInput.oninput = (e) => {
          detailPageItems[index].text = e.target.value;
        };

        // 옵션 컨트롤
        const controls = document.createElement('div');
        controls.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px; align-items: center;';

        // 색상 선택
        const colorLabel = document.createElement('label');
        colorLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        colorLabel.innerHTML = '🎨 색상:';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = item.color || '#000000';
        colorInput.style.cssText = 'width: 40px; height: 30px; border: 1px solid #e5e8eb; border-radius: 4px; cursor: pointer;';
        colorInput.onchange = (e) => {
          detailPageItems[index].color = e.target.value;
          applyPreviewStyles();
        };
        colorLabel.appendChild(colorInput);

        // 정렬 선택
        const alignLabel = document.createElement('label');
        alignLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        alignLabel.innerHTML = '📐 정렬:';

        const alignSelect = document.createElement('select');
        alignSelect.value = item.align || 'left';
        alignSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        alignSelect.innerHTML = `
          <option value="left" ${item.align === 'left' || !item.align ? 'selected' : ''}>왼쪽</option>
          <option value="center" ${item.align === 'center' ? 'selected' : ''}>가운데</option>
          <option value="right" ${item.align === 'right' ? 'selected' : ''}>오른쪽</option>
        `;
        alignSelect.onchange = (e) => {
          detailPageItems[index].align = e.target.value;
          applyPreviewStyles();
        };
        alignLabel.appendChild(alignSelect);

        // 폰트 선택
        const fontLabel = document.createElement('label');
        fontLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        fontLabel.innerHTML = '🔤 폰트:';

        const fontSelect = document.createElement('select');
        fontSelect.value = item.font || 'system-ui';
        fontSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        fontSelect.innerHTML = `
          <option value="system-ui" ${item.font === 'system-ui' || !item.font ? 'selected' : ''}>시스템 기본</option>
          <option value="'Noto Sans KR', sans-serif" ${item.font === "'Noto Sans KR', sans-serif" ? 'selected' : ''}>Noto Sans KR</option>
          <option value="'Nanum Gothic', sans-serif" ${item.font === "'Nanum Gothic', sans-serif" ? 'selected' : ''}>나눔고딕</option>
          <option value="Georgia, serif" ${item.font === 'Georgia, serif' ? 'selected' : ''}>Georgia</option>
          <option value="'Times New Roman', serif" ${item.font === "'Times New Roman', serif" ? 'selected' : ''}>Times New Roman</option>
          <option value="'Courier New', monospace" ${item.font === "'Courier New', monospace" ? 'selected' : ''}>Courier New</option>
        `;
        fontSelect.onchange = (e) => {
          detailPageItems[index].font = e.target.value;
          applyPreviewStyles();
        };
        fontLabel.appendChild(fontSelect);

        // 굵기 선택
        const weightLabel = document.createElement('label');
        weightLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        weightLabel.innerHTML = '굵기:';

        const weightSelect = document.createElement('select');
        weightSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        weightSelect.innerHTML = `
          <option value="normal" ${!item.fontWeight || item.fontWeight === 'normal' ? 'selected' : ''}>보통</option>
          <option value="bold" ${item.fontWeight === 'bold' ? 'selected' : ''}>굵게</option>
        `;
        weightSelect.onchange = (e) => {
          detailPageItems[index].fontWeight = e.target.value;
          applyPreviewStyles();
        };
        weightLabel.appendChild(weightSelect);

        // 테두리 선택
        const borderLabel = document.createElement('label');
        borderLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        borderLabel.innerHTML = '테두리:';

        const borderSelect = document.createElement('select');
        borderSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        borderSelect.innerHTML = `
          <option value="none" ${!item.borderStyle || item.borderStyle === 'none' ? 'selected' : ''}>없음</option>
          <option value="thin" ${item.borderStyle === 'thin' ? 'selected' : ''}>얇은선</option>
          <option value="box" ${item.borderStyle === 'box' ? 'selected' : ''}>박스</option>
          <option value="rounded" ${item.borderStyle === 'rounded' ? 'selected' : ''}>둥근박스</option>
          <option value="left-accent" ${item.borderStyle === 'left-accent' ? 'selected' : ''}>왼쪽강조</option>
        `;
        borderSelect.onchange = (e) => {
          detailPageItems[index].borderStyle = e.target.value;
          applyPreviewStyles();
        };
        borderLabel.appendChild(borderSelect);

        // 타입 표시
        const typeLabel = document.createElement('div');
        typeLabel.style.cssText = 'margin-left: auto; font-size: 11px; color: #999; font-weight: 600;';
        const typeNames = {
          'title': '타이틀',
          'subtitle': '중간 타이틀',
          'paragraph': '일반 텍스트'
        };
        typeLabel.textContent = typeNames[item.textType] || item.textType;

        controls.appendChild(colorLabel);
        controls.appendChild(alignLabel);
        controls.appendChild(fontLabel);
        controls.appendChild(weightLabel);
        controls.appendChild(borderLabel);
        controls.appendChild(typeLabel);

        content.appendChild(textInput);
        content.appendChild(controls);

        // 삭제 버튼
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'item-action-btn delete';
        deleteBtn.innerHTML = '🗑';
        deleteBtn.title = '삭제';
        deleteBtn.onclick = () => {
          detailPageItems.splice(index, 1);
          renderDetailCanvas();
        };

        div.appendChild(handle);
        div.appendChild(content);
        div.appendChild(deleteBtn);

        setupDragEvents(div, index);
        return div;
      }

      // 제품명 블록 (custom-text와 동일한 형식)
      if (item.type === 'title') {
        div.classList.add('custom-text-block');

        // 드래그 핸들
        const handle = document.createElement('span');
        handle.className = 'item-drag-handle';
        handle.innerHTML = '⋮⋮';

        // 컨텐츠 영역
        const content = document.createElement('div');
        content.className = 'custom-text-content';
        content.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 10px;';

        // 텍스트 입력
        const textInput = document.createElement('textarea');
        textInput.className = 'custom-text-input';
        textInput.value = item.text || '';
        textInput.placeholder = '제품명을 입력하세요...';

        // 스타일 미리보기 적용 함수
        const applyPreviewStyles = () => {
          const color = item.color || '#000000';
          const align = item.align || 'left';
          const font = item.font || 'system-ui';
          const fontSize = item.fontSize || '18';
          const fontWeight = item.fontWeight || 'bold';
          const borderStyle = item.borderStyle || 'none';

          let borderCss = '1px solid #e5e8eb';
          let borderRadius = '6px';
          let borderLeft = 'none';

          switch(borderStyle) {
            case 'thin':
              borderCss = '1px solid #ccc';
              break;
            case 'box':
              borderCss = '2px solid #333';
              break;
            case 'rounded':
              borderCss = '2px solid #1e90ff';
              borderRadius = '12px';
              break;
            case 'left-accent':
              borderCss = '1px solid #e5e8eb';
              borderLeft = '4px solid #1e90ff';
              break;
          }

          textInput.style.cssText = `
            width: 100%;
            padding: 12px;
            border: ${borderCss};
            border-radius: ${borderRadius};
            ${borderLeft !== 'none' ? 'border-left: ' + borderLeft + ';' : ''}
            font-size: ${fontSize}px;
            font-family: ${font};
            color: ${color};
            text-align: ${align};
            font-weight: ${fontWeight};
            resize: vertical;
            min-height: 60px;
            background: #fafbfc;
            transition: all 0.2s;
          `;
        };

        // 초기 스타일 적용
        applyPreviewStyles();

        textInput.oninput = (e) => {
          detailPageItems[index].text = e.target.value;
          detailPageItems[index].label = e.target.value;
        };

        // 옵션 컨트롤
        const controls = document.createElement('div');
        controls.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px; align-items: center;';

        // 색상 선택
        const colorLabel = document.createElement('label');
        colorLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        colorLabel.innerHTML = '🎨 색상:';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = item.color || '#000000';
        colorInput.style.cssText = 'width: 40px; height: 30px; border: 1px solid #e5e8eb; border-radius: 4px; cursor: pointer;';
        colorInput.onchange = (e) => {
          detailPageItems[index].color = e.target.value;
          applyPreviewStyles();
        };
        colorLabel.appendChild(colorInput);

        // 정렬 선택
        const alignLabel = document.createElement('label');
        alignLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        alignLabel.innerHTML = '📐 정렬:';

        const alignSelect = document.createElement('select');
        alignSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        alignSelect.innerHTML = `
          <option value="left" ${item.align === 'left' || !item.align ? 'selected' : ''}>왼쪽</option>
          <option value="center" ${item.align === 'center' ? 'selected' : ''}>가운데</option>
          <option value="right" ${item.align === 'right' ? 'selected' : ''}>오른쪽</option>
        `;
        alignSelect.onchange = (e) => {
          detailPageItems[index].align = e.target.value;
          applyPreviewStyles();
        };
        alignLabel.appendChild(alignSelect);

        // 폰트 선택
        const fontLabel = document.createElement('label');
        fontLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        fontLabel.innerHTML = '🔤 폰트:';

        const fontSelect = document.createElement('select');
        fontSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        fontSelect.innerHTML = `
          <option value="system-ui" ${item.font === 'system-ui' || !item.font ? 'selected' : ''}>시스템 기본</option>
          <option value="'Noto Sans KR', sans-serif" ${item.font === "'Noto Sans KR', sans-serif" ? 'selected' : ''}>Noto Sans KR</option>
          <option value="'Nanum Gothic', sans-serif" ${item.font === "'Nanum Gothic', sans-serif" ? 'selected' : ''}>나눔고딕</option>
          <option value="Georgia, serif" ${item.font === 'Georgia, serif' ? 'selected' : ''}>Georgia</option>
          <option value="'Times New Roman', serif" ${item.font === "'Times New Roman', serif" ? 'selected' : ''}>Times New Roman</option>
          <option value="'Courier New', monospace" ${item.font === "'Courier New', monospace" ? 'selected' : ''}>Courier New</option>
        `;
        fontSelect.onchange = (e) => {
          detailPageItems[index].font = e.target.value;
          applyPreviewStyles();
        };
        fontLabel.appendChild(fontSelect);

        // 굵기 선택
        const weightLabel = document.createElement('label');
        weightLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        weightLabel.innerHTML = '굵기:';

        const weightSelect = document.createElement('select');
        weightSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        weightSelect.innerHTML = `
          <option value="normal" ${item.fontWeight === 'normal' ? 'selected' : ''}>보통</option>
          <option value="bold" ${!item.fontWeight || item.fontWeight === 'bold' ? 'selected' : ''}>굵게</option>
        `;
        weightSelect.onchange = (e) => {
          detailPageItems[index].fontWeight = e.target.value;
          applyPreviewStyles();
        };
        weightLabel.appendChild(weightSelect);

        // 테두리 선택
        const borderLabel = document.createElement('label');
        borderLabel.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;';
        borderLabel.innerHTML = '테두리:';

        const borderSelect = document.createElement('select');
        borderSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        borderSelect.innerHTML = `
          <option value="none" ${!item.borderStyle || item.borderStyle === 'none' ? 'selected' : ''}>없음</option>
          <option value="thin" ${item.borderStyle === 'thin' ? 'selected' : ''}>얇은선</option>
          <option value="box" ${item.borderStyle === 'box' ? 'selected' : ''}>박스</option>
          <option value="rounded" ${item.borderStyle === 'rounded' ? 'selected' : ''}>둥근박스</option>
          <option value="left-accent" ${item.borderStyle === 'left-accent' ? 'selected' : ''}>왼쪽강조</option>
        `;
        borderSelect.onchange = (e) => {
          detailPageItems[index].borderStyle = e.target.value;
          applyPreviewStyles();
        };
        borderLabel.appendChild(borderSelect);

        // 타입 표시
        const typeLabel = document.createElement('div');
        typeLabel.style.cssText = 'margin-left: auto; font-size: 11px; color: #999; font-weight: 600;';
        typeLabel.textContent = '제품명';

        controls.appendChild(colorLabel);
        controls.appendChild(alignLabel);
        controls.appendChild(fontLabel);
        controls.appendChild(weightLabel);
        controls.appendChild(borderLabel);
        controls.appendChild(typeLabel);

        content.appendChild(textInput);
        content.appendChild(controls);

        // 삭제 버튼
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'item-action-btn delete';
        deleteBtn.innerHTML = '🗑';
        deleteBtn.title = '삭제';
        deleteBtn.onclick = () => {
          detailPageItems.splice(index, 1);
          renderDetailCanvas();
        };

        div.appendChild(handle);
        div.appendChild(content);
        div.appendChild(deleteBtn);

        setupDragEvents(div, index);
        return div;
      }

      // 일반 아이템 (이미지만)
      // 드래그 핸들
      const handle = document.createElement('span');
      handle.className = 'item-drag-handle';
      handle.innerHTML = '⋮⋮';

      // 미리보기 ([Image #1] 형식)
      const preview = document.createElement('div');
      preview.className = 'item-preview';

      const placeholder = document.createElement('div');
      placeholder.className = 'item-preview-placeholder';

      if (item.type === 'brand-image' || item.type === 'image') {
        if (item.imageSrc) {
          // 실제 이미지 썸네일 표시
          placeholder.innerHTML = '<img src="' + item.imageSrc + '" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">';
        } else {
          placeholder.textContent = '[Image #' + (index + 1) + ']';
        }
      } else {
        placeholder.innerHTML = '📝<br>[Text #' + (index + 1) + ']';
      }

      preview.appendChild(placeholder);

      // 정보
      const info = document.createElement('div');
      info.className = 'item-info';

      const type = document.createElement('div');
      type.className = 'item-type';

      if (item.type === 'brand-image') {
        type.textContent = '브랜드 이미지';
      } else if (item.type === 'image') {
        type.textContent = '추가 이미지';
      } else {
        type.textContent = '텍스트';
      }

      const label = document.createElement('div');
      label.className = 'item-label';
      label.textContent = item.label || item.text || '내용 없음';

      info.appendChild(type);
      info.appendChild(label);

      // 이미지 레이아웃 선택
      if (item.type === 'image') {
        // 레이아웃 유형 선택
        const layoutGroup = document.createElement('div');
        layoutGroup.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 8px;';

        const layoutLabel = document.createElement('label');
        layoutLabel.style.cssText = 'font-size: 12px; color: #666; font-weight: 600;';
        layoutLabel.textContent = '📐 레이아웃 유형:';

        const layoutSelect = document.createElement('select');
        layoutSelect.value = item.layout || 'presentation';
        layoutSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
        layoutSelect.innerHTML = `
          <option value="presentation" ${item.layout === 'presentation' ? 'selected' : ''}>연출 이미지</option>
          <option value="image-with-text" ${item.layout === 'image-with-text' ? 'selected' : ''}>이미지 + 텍스트</option>
        `;
        layoutSelect.onchange = (e) => {
          detailPageItems[index].layout = e.target.value;
          // 기본값 설정
          if (e.target.value === 'presentation' && !detailPageItems[index].align) {
            detailPageItems[index].align = 'center';
          }
          if (e.target.value === 'image-with-text' && !detailPageItems[index].imageText) {
            detailPageItems[index].imageText = '';
          }
          renderDetailCanvas();
        };

        layoutGroup.appendChild(layoutLabel);
        layoutGroup.appendChild(layoutSelect);
        info.appendChild(layoutGroup);

        // 연출 이미지일 때: 정렬 선택
        if (item.layout === 'presentation' || !item.layout) {
          const alignGroup = document.createElement('div');
          alignGroup.style.cssText = 'margin-top: 8px; display: flex; flex-direction: column; gap: 6px;';

          const alignLabel = document.createElement('label');
          alignLabel.style.cssText = 'font-size: 12px; color: #666; font-weight: 600;';
          alignLabel.textContent = '📍 이미지 정렬:';

          const alignSelect = document.createElement('select');
          alignSelect.value = item.align || 'center';
          alignSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
          alignSelect.innerHTML = `
            <option value="left" ${item.align === 'left' ? 'selected' : ''}>왼쪽</option>
            <option value="center" ${item.align === 'center' ? 'selected' : ''}>가운데</option>
            <option value="right" ${item.align === 'right' ? 'selected' : ''}>오른쪽</option>
          `;
          alignSelect.onchange = (e) => {
            detailPageItems[index].align = e.target.value;
          };

          alignGroup.appendChild(alignLabel);
          alignGroup.appendChild(alignSelect);
          info.appendChild(alignGroup);
        }

        // 이미지 + 텍스트일 때: 텍스트 위치 선택
        if (item.layout === 'image-with-text') {
          // 텍스트 위치 선택
          const positionGroup = document.createElement('div');
          positionGroup.style.cssText = 'margin-top: 8px; display: flex; flex-direction: column; gap: 6px;';

          const positionLabel = document.createElement('label');
          positionLabel.style.cssText = 'font-size: 12px; color: #666; font-weight: 600;';
          positionLabel.textContent = '📍 텍스트 위치:';

          const positionSelect = document.createElement('select');
          positionSelect.value = item.textPosition || 'right';
          positionSelect.style.cssText = 'padding: 6px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px;';
          positionSelect.innerHTML = `
            <option value="left" ${item.textPosition === 'left' ? 'selected' : ''}>왼쪽</option>
            <option value="right" ${item.textPosition === 'right' ? 'selected' : ''}>오른쪽</option>
          `;
          positionSelect.onchange = (e) => {
            detailPageItems[index].textPosition = e.target.value;
          };

          positionGroup.appendChild(positionLabel);
          positionGroup.appendChild(positionSelect);
          info.appendChild(positionGroup);

          // 텍스트 입력
          const textGroup = document.createElement('div');
          textGroup.style.cssText = 'margin-top: 8px; display: flex; flex-direction: column; gap: 6px;';

          const textLabel = document.createElement('label');
          textLabel.style.cssText = 'font-size: 12px; color: #666; font-weight: 600;';
          textLabel.textContent = '📝 텍스트 내용:';

          const textInput = document.createElement('textarea');
          textInput.value = item.imageText || '';
          textInput.placeholder = '이미지 옆에 표시할 텍스트를 입력하세요...';
          textInput.style.cssText = 'padding: 8px 10px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 12px; resize: vertical; min-height: 60px;';
          textInput.oninput = (e) => {
            detailPageItems[index].imageText = e.target.value;
          };

          textGroup.appendChild(textLabel);
          textGroup.appendChild(textInput);
          info.appendChild(textGroup);
        }
      }

      // 텍스트 표시/입력 (text 타입만 - title은 별도 처리됨)
      if (item.type === 'text') {
        const textDisplay = document.createElement('div');
        textDisplay.className = 'item-text-display';
        textDisplay.textContent = item.text || '';
        textDisplay.contentEditable = true;
        textDisplay.placeholder = '텍스트를 입력하세요...';

        // 스타일 미리보기 적용 함수
        const applyPreviewStyles = () => {
          const fontSize = item.fontSize || '14';
          const textAlign = item.textAlign || 'left';
          const textColor = item.textColor || '#000000';
          const fontWeight = item.fontWeight || 'normal';
          const borderStyle = item.borderStyle || 'none';

          let borderCss = 'none';
          let borderRadius = '4px';
          let padding = '10px 12px';
          let borderLeft = 'none';

          switch(borderStyle) {
            case 'thin':
              borderCss = '1px solid #e5e8eb';
              break;
            case 'box':
              borderCss = '2px solid #333';
              break;
            case 'rounded':
              borderCss = '2px solid #1e90ff';
              borderRadius = '12px';
              break;
            case 'left-accent':
              borderCss = '1px solid #e5e8eb';
              borderLeft = '4px solid #1e90ff';
              break;
          }

          textDisplay.style.cssText = `
            font-size: ${fontSize}px;
            text-align: ${textAlign};
            color: ${textColor};
            font-weight: ${fontWeight};
            border: ${borderCss};
            border-radius: ${borderRadius};
            padding: ${padding};
            ${borderLeft !== 'none' ? 'border-left: ' + borderLeft + ';' : ''}
            min-height: 40px;
            background: #fafbfc;
            transition: all 0.2s;
          `;
        };

        // 초기 스타일 적용
        applyPreviewStyles();

        textDisplay.onblur = (e) => {
          detailPageItems[index].text = e.target.textContent;
          detailPageItems[index].label = e.target.textContent;
        };
        info.appendChild(textDisplay);

        // 텍스트 스타일 컨트롤
        const styleControls = document.createElement('div');
        styleControls.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; align-items: center;';

        // 1. 텍스트 크기
        const sizeGroup = document.createElement('div');
        sizeGroup.style.cssText = 'display: flex; align-items: center; gap: 4px;';
        const sizeLabel = document.createElement('span');
        sizeLabel.textContent = '크기';
        sizeLabel.style.cssText = 'font-size: 11px; color: #666;';
        const sizeSelect = document.createElement('select');
        sizeSelect.style.cssText = 'padding: 4px 6px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 11px;';
        sizeSelect.innerHTML = `
          <option value="12" ${item.fontSize === '12' ? 'selected' : ''}>작게</option>
          <option value="14" ${!item.fontSize || item.fontSize === '14' ? 'selected' : ''}>보통</option>
          <option value="18" ${item.fontSize === '18' ? 'selected' : ''}>크게</option>
          <option value="custom" ${item.fontSize && !['12','14','18'].includes(item.fontSize) ? 'selected' : ''}>직접입력</option>
        `;
        const customSizeInput = document.createElement('input');
        customSizeInput.type = 'number';
        customSizeInput.min = '8';
        customSizeInput.max = '72';
        customSizeInput.value = item.fontSize || '14';
        customSizeInput.style.cssText = 'width: 45px; padding: 4px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 11px; display: ' + (item.fontSize && !['12','14','18'].includes(item.fontSize) ? 'block' : 'none') + ';';
        sizeSelect.onchange = (e) => {
          if (e.target.value === 'custom') {
            customSizeInput.style.display = 'block';
          } else {
            customSizeInput.style.display = 'none';
            detailPageItems[index].fontSize = e.target.value;
            applyPreviewStyles();
          }
        };
        customSizeInput.onchange = (e) => {
          detailPageItems[index].fontSize = e.target.value;
          applyPreviewStyles();
        };
        sizeGroup.appendChild(sizeLabel);
        sizeGroup.appendChild(sizeSelect);
        sizeGroup.appendChild(customSizeInput);

        // 2. 정렬
        const alignGroup = document.createElement('div');
        alignGroup.style.cssText = 'display: flex; align-items: center; gap: 4px;';
        const alignLabel = document.createElement('span');
        alignLabel.textContent = '정렬';
        alignLabel.style.cssText = 'font-size: 11px; color: #666;';
        const alignSelect = document.createElement('select');
        alignSelect.style.cssText = 'padding: 4px 6px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 11px;';
        alignSelect.innerHTML = `
          <option value="left" ${!item.textAlign || item.textAlign === 'left' ? 'selected' : ''}>왼쪽</option>
          <option value="center" ${item.textAlign === 'center' ? 'selected' : ''}>가운데</option>
          <option value="right" ${item.textAlign === 'right' ? 'selected' : ''}>오른쪽</option>
        `;
        alignSelect.onchange = (e) => {
          detailPageItems[index].textAlign = e.target.value;
          applyPreviewStyles();
        };
        alignGroup.appendChild(alignLabel);
        alignGroup.appendChild(alignSelect);

        // 3. 색상
        const colorGroup = document.createElement('div');
        colorGroup.style.cssText = 'display: flex; align-items: center; gap: 4px;';
        const colorLabel = document.createElement('span');
        colorLabel.textContent = '색상';
        colorLabel.style.cssText = 'font-size: 11px; color: #666;';
        const colorSelect = document.createElement('select');
        colorSelect.style.cssText = 'padding: 4px 6px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 11px;';
        colorSelect.innerHTML = `
          <option value="#000000" ${!item.textColor || item.textColor === '#000000' ? 'selected' : ''}>검정</option>
          <option value="#666666" ${item.textColor === '#666666' ? 'selected' : ''}>회색</option>
          <option value="#1e90ff" ${item.textColor === '#1e90ff' ? 'selected' : ''}>파랑</option>
          <option value="#e74c3c" ${item.textColor === '#e74c3c' ? 'selected' : ''}>빨강</option>
          <option value="#27ae60" ${item.textColor === '#27ae60' ? 'selected' : ''}>초록</option>
          <option value="#f39c12" ${item.textColor === '#f39c12' ? 'selected' : ''}>주황</option>
        `;
        colorSelect.onchange = (e) => {
          detailPageItems[index].textColor = e.target.value;
          applyPreviewStyles();
        };
        colorGroup.appendChild(colorLabel);
        colorGroup.appendChild(colorSelect);

        // 4. 굵기
        const weightGroup = document.createElement('div');
        weightGroup.style.cssText = 'display: flex; align-items: center; gap: 4px;';
        const weightLabel = document.createElement('span');
        weightLabel.textContent = '굵기';
        weightLabel.style.cssText = 'font-size: 11px; color: #666;';
        const weightSelect = document.createElement('select');
        weightSelect.style.cssText = 'padding: 4px 6px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 11px;';
        weightSelect.innerHTML = `
          <option value="normal" ${!item.fontWeight || item.fontWeight === 'normal' ? 'selected' : ''}>보통</option>
          <option value="bold" ${item.fontWeight === 'bold' ? 'selected' : ''}>굵게</option>
        `;
        weightSelect.onchange = (e) => {
          detailPageItems[index].fontWeight = e.target.value;
          applyPreviewStyles();
        };
        weightGroup.appendChild(weightLabel);
        weightGroup.appendChild(weightSelect);

        // 5. 테두리
        const borderGroup = document.createElement('div');
        borderGroup.style.cssText = 'display: flex; align-items: center; gap: 4px;';
        const borderLabel = document.createElement('span');
        borderLabel.textContent = '테두리';
        borderLabel.style.cssText = 'font-size: 11px; color: #666;';
        const borderSelect = document.createElement('select');
        borderSelect.style.cssText = 'padding: 4px 6px; border: 1px solid #e5e8eb; border-radius: 4px; font-size: 11px;';
        borderSelect.innerHTML = `
          <option value="none" ${!item.borderStyle || item.borderStyle === 'none' ? 'selected' : ''}>없음</option>
          <option value="thin" ${item.borderStyle === 'thin' ? 'selected' : ''}>얇은선</option>
          <option value="box" ${item.borderStyle === 'box' ? 'selected' : ''}>박스</option>
          <option value="rounded" ${item.borderStyle === 'rounded' ? 'selected' : ''}>둥근박스</option>
          <option value="left-accent" ${item.borderStyle === 'left-accent' ? 'selected' : ''}>왼쪽강조</option>
        `;
        borderSelect.onchange = (e) => {
          detailPageItems[index].borderStyle = e.target.value;
          applyPreviewStyles();
        };
        borderGroup.appendChild(borderLabel);
        borderGroup.appendChild(borderSelect);

        styleControls.appendChild(sizeGroup);
        styleControls.appendChild(alignGroup);
        styleControls.appendChild(colorGroup);
        styleControls.appendChild(weightGroup);
        styleControls.appendChild(borderGroup);
        info.appendChild(styleControls);
      }

      // 액션 버튼들
      const actions = document.createElement('div');
      actions.className = 'item-actions';

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'item-action-btn delete';
      deleteBtn.innerHTML = '🗑';
      deleteBtn.title = '삭제';
      deleteBtn.onclick = () => {
        detailPageItems.splice(index, 1);
        renderDetailCanvas();
      };

      actions.appendChild(deleteBtn);

      // 조합
      div.appendChild(handle);
      div.appendChild(preview);
      div.appendChild(info);
      div.appendChild(actions);

      setupDragEvents(div, index);
      return div;
    }

    // 드래그 이벤트 설정
    function setupDragEvents(div, index) {
      div.addEventListener('dragstart', (e) => {
        e.stopPropagation(); // 캔버스로 버블링 방지
        draggedItem = index;
        div.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('reorder', 'true'); // 재정렬 작업 표시
      });

      div.addEventListener('dragend', () => {
        div.classList.remove('dragging');
        draggedItem = null;
        // 모든 drag-over 클래스 제거
        document.querySelectorAll('.detail-page-item.drag-over').forEach(el => {
          el.classList.remove('drag-over');
        });
      });

      div.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation(); // 캔버스로 버블링 방지
        if (draggedItem !== null) {
          e.dataTransfer.dropEffect = 'move';
          div.classList.add('drag-over');
        }
      });

      div.addEventListener('dragleave', (e) => {
        e.stopPropagation();
        div.classList.remove('drag-over');
      });

      div.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation(); // 캔버스로 버블링 방지
        div.classList.remove('drag-over');

        if (draggedItem !== null && draggedItem !== index) {
          // 순서 변경
          const item = detailPageItems.splice(draggedItem, 1)[0];
          // draggedItem보다 index가 크면 splice 후 인덱스 조정 필요
          const targetIndex = index > draggedItem ? index - 1 : index;
          detailPageItems.splice(targetIndex, 0, item);
          renderDetailCanvas();
          showAlert('아이템 순서가 변경되었습니다.', 'success');
        }
      });
    }

    // 상세페이지 아이템 추가
    function addDetailPageItem(item) {
      detailPageItems.push(item);
      renderDetailCanvas();
    }

    // 텍스트 블록 추가
    function addTextBlock() {
      addDetailPageItem({
        type: 'text',
        text: '',
        label: '텍스트 블록'
      });
    }

    // 커스텀 텍스트 블록 추가 (크기별)
    function addCustomTextBlock(textType) {
      const labels = {
        'title': '타이틀',
        'subtitle': '중간 타이틀',
        'paragraph': '일반 텍스트'
      };

      addDetailPageItem({
        type: 'custom-text',
        textType: textType,
        text: '',
        color: '#000000',
        align: 'left',
        font: 'system-ui',
        label: labels[textType]
      });

      showAlert(`${labels[textType]}이(가) 추가되었습니다.`, 'success');
    }

    // 품질표시사항 추가
    function addQualityTable() {
      const productTitle = productData.title || productData.titleCn || '제품명';

      // 옵션1/옵션2 유니크 값 추출
      const uniqueOption1Values = [];
      const uniqueOption2Values = [];
      if (productData.results && productData.results.length > 0) {
        const opt1Set = new Set();
        const opt2Set = new Set();
        productData.results.forEach(option => {
          const opt1 = option.optionName1 || option.optionName1Cn;
          const opt2 = option.optionName2 || option.optionName2Cn;
          if (opt1 && !opt1Set.has(opt1)) {
            opt1Set.add(opt1);
            uniqueOption1Values.push(opt1);
          }
          if (opt2 && !opt2Set.has(opt2)) {
            opt2Set.add(opt2);
            uniqueOption2Values.push(opt2);
          }
        });
      }

      const colorValue = uniqueOption1Values.length > 0 ? uniqueOption1Values.join(', ') : '상세페이지 참조';
      const sizeValue = uniqueOption2Values.length > 0 ? uniqueOption2Values.join(', ') : '상세페이지 참조';

      const qt = settings.qualityTable || {};

      const qualityRows = [
        { label: '상품명', value: productTitle },
        { label: '색상', value: colorValue },
        { label: '사이즈', value: sizeValue },
        { label: '제조국', value: qt.제조국 || 'Made in China' },
        { label: '제조사', value: qt.제조사 || '' },
        { label: '취급시 주의사항', value: qt.취급시주의사항 || '상세페이지 참조' },
        { label: '품질보증기준', value: qt.품질보증기준 || '관련법 및 소비자 분쟁해결 규정에 따름' },
        { label: 'A/S 책임자와 전화번호', value: qt.AS책임자 || '' }
      ];

      // 커스텀 행 추가
      if (qt.customRows && qt.customRows.length > 0) {
        qt.customRows.forEach(row => {
          if (row.label) {
            qualityRows.push({ label: row.label, value: row.value || '' });
          }
        });
      }

      addDetailPageItem({
        type: 'quality-table',
        title: '품질표시사항',
        rows: qualityRows
      });
    }

    // 자동 구성
    function autoGenerateDetailPage() {
      detailPageItems = [];
      let imageCounter = 1;

      // 1. 브랜드 이미지 (설정에서 업로드한 이미지 우선 사용)
      const brandImageSrc = settings.brandImageUrl || productData.mainImage;
      if (brandImageSrc) {
        detailPageItems.push({
          type: 'brand-image',
          imageSrc: brandImageSrc,
          label: '브랜드 이미지',
          imageNumber: imageCounter++
        });
      }

      // 2. 제품명 (타이틀) - 기본: 큰 사이즈(28px), 중앙 정렬
      const productTitle = productData.title || productData.titleCn || '제품명';
      detailPageItems.push({
        type: 'title',
        text: productTitle,
        label: productTitle,
        fontSize: '28',
        align: 'center'
      });

      // 3. 추가 이미지는 기본적으로 포함 안함 (사용자가 수동으로 추가)

      // 4. 옵션 블록들 - 옵션1별로 그룹핑
      const option1Groups = new Map();

      if (productData.results && productData.results.length > 0) {
        productData.results.forEach(option => {
          const opt1 = option.optionName1 || option.optionName1Cn || '옵션1';
          const opt2 = option.optionName2 || option.optionName2Cn || '';
          const img = option.imageLink || option.titleImage?.[0] || '';

          if (!option1Groups.has(opt1)) {
            option1Groups.set(opt1, {
              image: img,
              imageSrc: img,
              optionName: opt1,
              option2List: []
            });
          }

          if (opt2) {
            option1Groups.get(opt1).option2List.push(opt2);
          }
        });

        // 옵션 블록 추가
        option1Groups.forEach((group, opt1) => {
          // 옵션2 중복 제거
          const uniqueOption2 = [...new Set(group.option2List)];
          const option2Text = uniqueOption2.length > 0
            ? uniqueOption2.join(', ')
            : '옵션2 없음';

          detailPageItems.push({
            type: 'option-block',
            imageSrc: group.imageSrc,
            imageLabel: '[Image #' + imageCounter++ + ']',
            optionName: group.optionName,
            option2List: option2Text,
            template: selectedOptionTemplate
          });
        });
      }

      // 5. 품질표시사항 추가
      // 옵션1 유니크 값들 (색상용)
      const uniqueOption1Values = [];
      const uniqueOption2Values = [];
      if (productData.results && productData.results.length > 0) {
        const opt1Set = new Set();
        const opt2Set = new Set();
        productData.results.forEach(option => {
          const opt1 = option.optionName1 || option.optionName1Cn;
          const opt2 = option.optionName2 || option.optionName2Cn;
          if (opt1 && !opt1Set.has(opt1)) {
            opt1Set.add(opt1);
            uniqueOption1Values.push(opt1);
          }
          if (opt2 && !opt2Set.has(opt2)) {
            opt2Set.add(opt2);
            uniqueOption2Values.push(opt2);
          }
        });
      }

      const colorValue = uniqueOption1Values.length > 0 ? uniqueOption1Values.join(', ') : '상세페이지 참조';
      const sizeValue = uniqueOption2Values.length > 0 ? uniqueOption2Values.join(', ') : '상세페이지 참조';

      // 품질표시사항 설정 가져오기
      const qt = settings.qualityTable || {};

      const qualityRows = [
        { label: '상품명', value: productTitle },
        { label: '색상', value: colorValue },
        { label: '사이즈', value: sizeValue },
        { label: '제조국', value: 'Made in China' },
        { label: '제조사', value: qt.제조사 || '내용' },
        { label: '취급시 주의사항', value: qt.취급시주의사항 || '상세페이지 참조' },
        { label: '제조 연월', value: qt.제조연월 || '내용' },
        { label: '품질보증기준', value: qt.품질보증기준 || '관련법 및 소비자 분쟁해결 규정에 따름' },
        { label: 'A/S 책임자와 전화번호', value: qt.AS책임자 || '내용' }
      ];

      // 설정에서 추가한 커스텀 행 추가
      if (qt.customRows && qt.customRows.length > 0) {
        qt.customRows.forEach(row => {
          if (row.label) {
            qualityRows.push({ label: row.label, value: row.value || '' });
          }
        });
      }

      detailPageItems.push({
        type: 'quality-table',
        title: '품질표시사항',
        rows: qualityRows
      });

      renderDetailCanvas();
    }

    // 옵션 템플릿 선택
    function selectOptionTemplate(template) {
      selectedOptionTemplate = template;

      // 모든 템플릿 아이템에서 active 클래스 제거
      document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('active');
      });

      // 선택된 템플릿에 active 클래스 추가
      document.querySelector(`[data-template="${template}"]`).classList.add('active');

      // 모든 기존 옵션 블록의 템플릿도 변경
      detailPageItems.forEach((item, index) => {
        if (item.type === 'option-block') {
          item.template = template;
        }
      });

      // 화면 다시 렌더링
      renderDetailCanvas();

      console.log('✅ 템플릿 선택됨:', template, '- 모든 옵션 블록에 적용');
      showAlert(`모든 옵션 블록이 ${template} 템플릿으로 변경되었습니다.`, 'success');
    }

    // 초기화 (자동 구성으로 리셋)
    function resetDetailPage() {
      if (confirm('상세페이지를 초기 상태로 되돌리시겠습니까?')) {
        autoGenerateDetailPage();
        showAlert('상세페이지가 초기화되었습니다.', 'success');
      }
    }

    // 옵션 이미지 동기화 (productData.results의 최신 이미지를 상세페이지에 반영)
    function syncOptionImagesToDetailPage() {
      if (!productData.results || productData.results.length === 0) {
        showAlert('동기화할 옵션 이미지가 없습니다.', 'warning');
        return;
      }

      // productData.results에서 옵션1별 유니크 이미지 추출 (순서 유지)
      const option1ImageList = [];
      const seenOpt1 = new Set();

      productData.results.forEach(option => {
        const opt1 = option.optionName1 || option.optionName1Cn || '옵션';
        const img = option.imageLink || option.titleImage?.[0] || '';
        if (img && !seenOpt1.has(opt1)) {
          seenOpt1.add(opt1);
          option1ImageList.push(img);
        }
      });

      console.log('[이미지 동기화] 유니크 이미지 수:', option1ImageList.length);

      // detailPageItems의 option-block들 추출
      const optionBlocks = detailPageItems.filter(item => item.type === 'option-block');
      console.log('[이미지 동기화] 옵션 블록 수:', optionBlocks.length);

      if (optionBlocks.length === 0) {
        showAlert('상세페이지에 옵션 블록이 없습니다.', 'warning');
        return;
      }

      // 순서대로 이미지 업데이트
      let updatedCount = 0;
      optionBlocks.forEach((block, index) => {
        if (index < option1ImageList.length) {
          const newImg = option1ImageList[index];
          if (block.imageSrc !== newImg) {
            console.log(`[이미지 동기화] 블록 ${index} 업데이트: ${block.optionName}`);
            block.imageSrc = newImg;
            updatedCount++;
          }
        }
      });

      if (updatedCount > 0) {
        renderDetailCanvas();
        renderDetailSources();
        scheduleAutoSave();
        showAlert(`✅ ${updatedCount}개 옵션 이미지가 동기화되었습니다.`, 'success');
      } else {
        showAlert('이미 최신 상태입니다.', 'info');
      }
    }

    // 미리보기
    function previewDetailPage() {
      console.log('미리보기 시작, detailPageItems:', JSON.parse(JSON.stringify(detailPageItems)));
      const previewContent = document.getElementById('detailPreviewContent');
      previewContent.innerHTML = '';

      if (detailPageItems.length === 0) {
        previewContent.innerHTML = '<p style="text-align: center; padding: 60px; color: #888;">상세페이지에 추가된 항목이 없습니다.</p>';
      } else {
        detailPageItems.forEach(item => {
          // 브랜드 이미지
          if (item.type === 'brand-image') {
            const img = document.createElement('img');
            img.src = item.imageSrc;
            img.style.marginBottom = '0';
            previewContent.appendChild(img);
          }
          // 제품명 (타이틀)
          else if (item.type === 'title') {
            const titleDiv = document.createElement('div');
            titleDiv.className = 'detail-preview-text';

            // 스타일 속성 적용
            const fontSize = item.fontSize || '18';
            const color = item.color || '#000000';
            const align = item.align || 'left';
            const font = item.font || 'system-ui';
            const fontWeight = item.fontWeight || 'bold';
            const borderStyle = item.borderStyle || 'none';

            let borderCss = 'none';
            let borderRadius = '0';
            let borderLeft = '';
            let padding = '30px 20px';

            switch(borderStyle) {
              case 'thin':
                borderCss = '1px solid #e5e8eb';
                padding = '30px 20px';
                break;
              case 'box':
                borderCss = '2px solid #333';
                padding = '30px 20px';
                break;
              case 'rounded':
                borderCss = '2px solid #1e90ff';
                borderRadius = '12px';
                padding = '30px 20px';
                break;
              case 'left-accent':
                borderCss = '1px solid #e5e8eb';
                borderLeft = '4px solid #1e90ff';
                padding = '30px 20px';
                break;
            }

            titleDiv.style.cssText = `
              font-size: ${fontSize}px;
              font-weight: ${fontWeight};
              font-family: ${font};
              color: ${color};
              text-align: ${align};
              padding: ${padding};
              border: ${borderCss};
              border-radius: ${borderRadius};
              ${borderLeft ? 'border-left: ' + borderLeft + ';' : ''}
              line-height: 1.6;
              margin: 10px 0;
            `;
            titleDiv.textContent = item.text || '제품명';
            previewContent.appendChild(titleDiv);
          }
          // 추가 이미지
          else if (item.type === 'image') {
            const layout = item.layout || 'presentation';

            if (layout === 'presentation') {
              // 연출 이미지 - 정렬에 따라 표시
              const imageContainer = document.createElement('div');
              const align = item.align || 'center';

              imageContainer.style.cssText = `
                display: flex;
                justify-content: ${align === 'left' ? 'flex-start' : align === 'right' ? 'flex-end' : 'center'};
                margin: 20px 0;
                padding: 0 20px;
              `;

              const img = document.createElement('img');
              img.src = item.imageSrc;

              // 가운데 정렬은 100%, 왼쪽/오른쪽은 50%로 작게
              if (align === 'center') {
                img.style.cssText = `
                  max-width: 100%;
                  height: auto;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                `;
              } else {
                img.style.cssText = `
                  max-width: 50%;
                  height: auto;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                `;
              }

              imageContainer.appendChild(img);
              previewContent.appendChild(imageContainer);
            } else if (layout === 'image-with-text') {
              // 이미지 + 텍스트 레이아웃 - 심플하게
              const textPosition = item.textPosition || 'right';

              const container = document.createElement('div');
              container.style.cssText = `
                display: flex;
                align-items: center;
                gap: 40px;
                padding: 0 20px;
                margin: 20px 0;
              `;

              // 이미지 컨테이너
              const imgContainer = document.createElement('div');
              imgContainer.style.cssText = `
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
              `;

              const img = document.createElement('img');
              img.src = item.imageSrc;
              img.style.cssText = `
                max-width: 100%;
                height: auto;
                border-radius: 8px;
              `;
              imgContainer.appendChild(img);

              // 텍스트 컨테이너
              const textContainer = document.createElement('div');
              textContainer.style.cssText = `
                flex: 1;
                display: flex;
                align-items: center;
              `;

              const text = document.createElement('div');
              text.style.cssText = `
                font-size: 18px;
                line-height: 1.8;
                color: #333;
                white-space: pre-wrap;
                width: 100%;
              `;
              text.textContent = item.imageText || '텍스트를 입력하세요...';
              textContainer.appendChild(text);

              // 텍스트 위치에 따라 순서 결정
              if (textPosition === 'left') {
                container.appendChild(textContainer);
                container.appendChild(imgContainer);
              } else {
                container.appendChild(imgContainer);
                container.appendChild(textContainer);
              }

              previewContent.appendChild(container);
            }
          }
          // 옵션 블록
          else if (item.type === 'option-block') {
            const template = item.template || selectedOptionTemplate;
            console.log('미리보기 렌더링:', { optionName: item.optionName, template, itemTemplate: item.template, selectedOptionTemplate });
            const optionBlock = document.createElement('div');

            // 템플릿별 스타일 적용
            if (template === 'horizontal') {
              // 가로형 (미니멀)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 20px;
                margin: 10px 0;
                background: white;
                border: 1px solid #e5e8eb;
                border-radius: 6px;
              `;
            } else if (template === 'horizontal-reverse') {
              // 가로형 반전 (이미지 오른쪽)
              optionBlock.style.cssText = `
                display: flex;
                flex-direction: row-reverse;
                align-items: center;
                gap: 16px;
                padding: 20px;
                margin: 10px 0;
                background: white;
                border: 1px solid #e5e8eb;
                border-radius: 6px;
              `;
            } else if (template === 'vertical') {
              // 세로형
              optionBlock.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 16px;
                padding: 20px;
                margin: 10px 0;
                background: white;
                border: 1px solid #e5e8eb;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
              `;
            } else if (template === 'card') {
              // 카드형
              optionBlock.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 16px;
                padding: 24px;
                margin: 10px 0;
                background: white;
                border: 2px solid #e5e8eb;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
              `;
            } else if (template === 'centered') {
              // 중앙 정렬형
              optionBlock.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 20px;
                padding: 30px;
                margin: 10px 0;
                background: white;
                border: 1px solid #e5e8eb;
                border-radius: 10px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
              `;
            } else if (template === 'split') {
              // 50/50 분할형
              optionBlock.style.cssText = `
                display: flex;
                align-items: stretch;
                gap: 0;
                margin: 10px 0;
                background: white;
                border: 1px solid #e5e8eb;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              `;
            } else if (template === 'modern') {
              // 모던형 (보라 그라데이션)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
              `;
            } else if (template === 'neon') {
              // 네온 (핑크/사이언)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
              `;
            } else if (template === 'sunset') {
              // 일몰 (오렌지/핑크)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(250, 112, 154, 0.3);
              `;
            } else if (template === 'ocean') {
              // 바다 (파랑/청록)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(79, 172, 254, 0.3);
              `;
            } else if (template === 'mint') {
              // 민트 (민트/연두)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(67, 233, 123, 0.3);
              `;
            } else if (template === 'dark') {
              // 다크모드
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: #1a1a1a;
                border: 1px solid #333;
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
              `;
            } else if (template === 'neon-border') {
              // 네온 테두리
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: white;
                border: 3px solid;
                border-image: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) 1;
                border-radius: 0;
                box-shadow: 0 0 20px rgba(240, 147, 251, 0.3);
              `;
            } else if (template === 'badge') {
              // 배지 스타일
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 20px 24px;
                margin: 10px 0;
                background: white;
                border: 2px dashed #1e90ff;
                border-radius: 20px;
                position: relative;
              `;
            } else if (template === 'diagonal') {
              // 대각선 분할
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(45deg, #f8f9fa 50%, white 50%);
                border: 1px solid #e5e8eb;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
              `;
            } else if (template === 'overlay') {
              // 오버레이 (이미지 위에 텍스트)
              optionBlock.style.cssText = `
                position: relative;
                margin: 10px 0;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
              `;
            } else {
              // gradient (기본)
              optionBlock.style.cssText = `
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 24px;
                margin: 10px 0;
                background: linear-gradient(to right, #f8f9fa, #ffffff);
                border: 1px solid #e5e8eb;
                border-left: 4px solid #1e90ff;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              `;
            }

            // 이미지 컨테이너
            if (item.imageSrc) {
              const imgContainer = document.createElement('div');

              if (template === 'vertical' || template === 'card' || template === 'centered') {
                imgContainer.style.cssText = `
                  width: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: ${template === 'centered' ? '#fafbfc' : '#f8f9fa'};
                  border-radius: 8px;
                  overflow: hidden;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                  min-height: 300px;
                  padding: 10px;
                `;
              } else if (template === 'split') {
                imgContainer.style.cssText = `
                  flex: 1;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: #f8f9fa;
                  padding: 30px;
                  min-height: 300px;
                `;
              } else if (template === 'overlay') {
                imgContainer.style.cssText = `
                  width: 100%;
                  position: relative;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  min-height: 400px;
                  background: #f8f9fa;
                `;
              } else if (template === 'modern' || template === 'neon' || template === 'sunset' || template === 'ocean' || template === 'mint') {
                imgContainer.style.cssText = `
                  flex-shrink: 0;
                  width: 220px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: rgba(255, 255, 255, 0.95);
                  border-radius: 12px;
                  overflow: hidden;
                  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
                  min-height: 220px;
                  padding: 15px;
                `;
              } else if (template === 'dark') {
                imgContainer.style.cssText = `
                  flex-shrink: 0;
                  width: 220px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: #2a2a2a;
                  border-radius: 12px;
                  overflow: hidden;
                  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
                  min-height: 220px;
                  padding: 15px;
                `;
              } else {
                imgContainer.style.cssText = `
                  flex-shrink: 0;
                  width: 200px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: #f8f9fa;
                  border-radius: 8px;
                  overflow: hidden;
                  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
                  min-height: 200px;
                  padding: 10px;
                `;
              }

              const img = document.createElement('img');
              img.src = item.imageSrc;
              if (template === 'overlay') {
                img.style.cssText = `
                  max-width: 100%;
                  max-height: 100%;
                  width: auto;
                  height: auto;
                  object-fit: contain;
                `;
              } else {
                img.style.cssText = `
                  max-width: 100%;
                  max-height: 100%;
                  width: auto;
                  height: auto;
                  object-fit: contain;
                `;
              }
              imgContainer.appendChild(img);
              optionBlock.appendChild(imgContainer);
            }

            // 텍스트 컨테이너
            const textContainer = document.createElement('div');
            const isColorTemplate = ['modern', 'neon', 'sunset', 'ocean', 'mint', 'dark'].includes(template);

            if (template === 'split') {
              textContainer.style.cssText = `
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 16px;
                padding: 30px;
                background: white;
              `;
            } else if (template === 'overlay') {
              textContainer.style.cssText = `
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 30px;
                background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
                z-index: 10;
              `;
            } else {
              textContainer.style.cssText = `
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 12px;
              `;
            }

            const optionTitle = document.createElement('div');
            if (isColorTemplate || template === 'overlay') {
              optionTitle.style.cssText = `
                font-size: 24px;
                font-weight: 700;
                color: white;
                line-height: 1.4;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
              `;
            } else {
              optionTitle.style.cssText = `
                font-size: 22px;
                font-weight: 700;
                color: #1a1a1a;
                line-height: 1.4;
              `;
            }
            optionTitle.textContent = item.optionName || '옵션명';

            const optionSubtitle = document.createElement('div');
            if (isColorTemplate) {
              optionSubtitle.style.cssText = `
                font-size: 15px;
                color: rgba(255, 255, 255, 0.95);
                line-height: 1.8;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
              `;
            } else if (template === 'overlay') {
              optionSubtitle.style.cssText = `
                font-size: 15px;
                color: rgba(255, 255, 255, 0.9);
                line-height: 1.8;
                padding: 12px 16px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 8px;
                backdrop-filter: blur(5px);
              `;
            } else if (template === 'split') {
              optionSubtitle.style.cssText = `
                font-size: 15px;
                color: #666;
                line-height: 1.8;
                padding: 16px;
                background: #f8f9fa;
                border-radius: 6px;
                border: none;
              `;
            } else {
              optionSubtitle.style.cssText = `
                font-size: 15px;
                color: #666;
                line-height: 1.8;
                padding: 12px 16px;
                background: ${template === 'card' ? '#f8f9fa' : 'white'};
                border-radius: 6px;
                border: 1px solid #e5e8eb;
              `;
            }
            optionSubtitle.textContent = item.option2List || '';

            textContainer.appendChild(optionTitle);
            textContainer.appendChild(optionSubtitle);
            optionBlock.appendChild(textContainer);

            previewContent.appendChild(optionBlock);
          }
          // 품질표시사항
          else if (item.type === 'quality-table') {
            const qualityTable = document.createElement('div');
            qualityTable.style.cssText = `
              margin: 20px 0;
              background: white;
              border: 2px solid #e5e8eb;
              border-radius: 12px;
              overflow: hidden;
            `;

            const tableTitle = document.createElement('div');
            tableTitle.style.cssText = `
              font-size: 20px;
              font-weight: 700;
              color: #333;
              padding: 20px 24px;
              background: #f8f9fa;
              border-bottom: 2px solid #e5e8eb;
              text-align: center;
            `;
            tableTitle.textContent = item.title || '품질표시사항';
            qualityTable.appendChild(tableTitle);

            if (item.rows && item.rows.length > 0) {
              item.rows.forEach((row, idx) => {
                const rowDiv = document.createElement('div');
                rowDiv.style.cssText = `
                  display: grid;
                  grid-template-columns: 200px 1fr;
                  border-bottom: ${idx === item.rows.length - 1 ? 'none' : '1px solid #e5e8eb'};
                `;

                const label = document.createElement('div');
                label.style.cssText = `
                  padding: 14px 20px;
                  background: #fafbfc;
                  font-weight: 600;
                  font-size: 14px;
                  color: #555;
                  border-right: 1px solid #e5e8eb;
                `;
                label.textContent = row.label || '';

                const value = document.createElement('div');
                value.style.cssText = `
                  padding: 14px 20px;
                  font-size: 14px;
                  color: #333;
                  background: white;
                `;
                value.textContent = row.value || '';

                rowDiv.appendChild(label);
                rowDiv.appendChild(value);
                qualityTable.appendChild(rowDiv);
              });
            }

            previewContent.appendChild(qualityTable);
          }
          // 일반 텍스트
          else if (item.type === 'text' && item.text) {
            const textDiv = document.createElement('div');
            textDiv.className = 'detail-preview-text';
            textDiv.textContent = item.text;
            previewContent.appendChild(textDiv);
          }
          // 커스텀 텍스트 (색상 + 정렬 + 크기 + 굵기 + 테두리)
          else if (item.type === 'custom-text' && item.text) {
            const textDiv = document.createElement('div');
            textDiv.className = 'detail-preview-custom-text';

            // 크기별 기본 스타일
            const defaultFontSizes = {
              'title': '24',
              'subtitle': '18',
              'paragraph': '14'
            };

            const defaultFontWeights = {
              'title': 'bold',
              'subtitle': 'bold',
              'paragraph': 'normal'
            };

            const fontSize = item.fontSize || defaultFontSizes[item.textType] || '14';
            const fontWeight = item.fontWeight || defaultFontWeights[item.textType] || 'normal';
            const borderStyle = item.borderStyle || 'none';

            let borderCss = 'none';
            let borderRadius = '0';
            let borderLeft = '';
            let padding = '15px 20px';

            switch(borderStyle) {
              case 'thin':
                borderCss = '1px solid #e5e8eb';
                break;
              case 'box':
                borderCss = '2px solid #333';
                break;
              case 'rounded':
                borderCss = '2px solid #1e90ff';
                borderRadius = '12px';
                break;
              case 'left-accent':
                borderCss = '1px solid #e5e8eb';
                borderLeft = '4px solid #1e90ff';
                break;
            }

            textDiv.style.cssText = `
              font-size: ${fontSize}px;
              font-weight: ${fontWeight};
              font-family: ${item.font || 'system-ui'};
              color: ${item.color || '#000000'};
              text-align: ${item.align || 'left'};
              margin: 10px 0;
              padding: ${padding};
              border: ${borderCss};
              border-radius: ${borderRadius};
              ${borderLeft ? 'border-left: ' + borderLeft + ';' : ''}
              line-height: 1.6;
              white-space: pre-wrap;
            `;
            textDiv.textContent = item.text;
            previewContent.appendChild(textDiv);
          }
        });
      }

      document.getElementById('detailPreviewModal').classList.add('active');
    }

    // 미리보기 닫기
    function closeDetailPreview() {
      document.getElementById('detailPreviewModal').classList.remove('active');
    }

    // 옵션 렌더링
    function renderOptions() {
      const tbody = document.getElementById('optionsTableBody');
      tbody.innerHTML = '';

      if (!productData.results || productData.results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #888;">옵션이 없습니다.</td></tr>';
        return;
      }

      console.log('[Editor Debug] 옵션 렌더링 시작, 총', productData.results.length, '개');
      if (productData.results.length > 0) {
        console.log('[Editor Debug] 첫 번째 옵션 데이터:', productData.results[0]);
      }

      productData.results.forEach((option, index) => {
        const row = tbody.insertRow();

        const imgSrc = option.imageLink || option.titleImage?.[0] || '';
        const imgHtml = imgSrc
          ? `<img src="${imgSrc}" class="option-image-preview" onclick="openMagicBrush('${imgSrc}')" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'>📷</div>'">`
          : '<div class="no-image">📷</div>';

        // 사용자 정의 가격이 있으면 사용, 없으면 자동 계산
        const priceCNY = parseFloat(option.price) || 0;

        if (index === 0) {
          console.log('[Editor Debug] 첫 번째 옵션 가격:', {
            rawPrice: option.price,
            priceCNY,
            optionName1: option.optionName1,
            optionName2: option.optionName2
          });
        }

        const autoPrices = calculatePricesWithMargins(priceCNY);

        const costKRW = option.costKRW || autoPrices.costKRW;
        const supplyPrice = option.supplyPrice || autoPrices.supplyPrice;
        const sellPrice = option.sellPrice || autoPrices.sellPrice;

        // 자동 계산된 값도 옵션에 저장 (견적서 작성시 사용)
        option.costKRW = costKRW;
        option.supplyPrice = supplyPrice;
        option.sellPrice = sellPrice;

        // 마진 계산
        const supplyMargin = supplyPrice - costKRW;
        const supplyMarginPercent = costKRW > 0 ? Math.round((supplyMargin / costKRW) * 100) : 0;
        const saleMargin = sellPrice - supplyPrice;
        const saleMarginPercent = supplyPrice > 0 ? Math.round((saleMargin / supplyPrice) * 100) : 0;

        // 마진 색상 결정
        const supplyMarginClass = supplyMargin > 0 ? 'profit-positive' : 'profit-warning';
        const saleMarginClass = saleMargin >= settings.minMargin ? 'profit-positive' : 'profit-warning';

        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${imgHtml}</td>
          <td><input type="text" value="${option.optionName1 || ''}" onchange="updateOption(${index}, 'optionName1', this.value)"></td>
          <td><input type="text" value="${option.optionName2 || ''}" onchange="updateOption(${index}, 'optionName2', this.value)"></td>
          <td>
            <div class="price-cell">
              <input type="number" class="price-input" value="${costKRW}" readonly style="background: #f5f5f5; cursor: not-allowed;">
              <div class="price-sub">(${priceCNY.toLocaleString()} CNY)</div>
            </div>
          </td>
          <td>
            <div class="price-cell">
              <input type="number" class="price-input" value="${supplyPrice}" onchange="updateSupplyPrice(${index}, this.value)" step="1">
              <div class="price-sub ${supplyMarginClass}">
                마진: ${supplyMargin.toLocaleString()}원 (${supplyMarginPercent}%)
              </div>
            </div>
          </td>
          <td>
            <div class="price-cell">
              <input type="number" class="price-input" value="${sellPrice}" onchange="updateSellPrice(${index}, this.value)" step="1">
              <div class="price-sub ${saleMarginClass}">
                마진: ${saleMargin.toLocaleString()}원 (${saleMarginPercent}%)
              </div>
            </div>
          </td>
        `;
      });
    }

    // 공급가 업데이트
    function updateSupplyPrice(index, value) {
      const supplyPrice = parseFloat(value) || 0;
      productData.results[index].supplyPrice = supplyPrice;

      // 판매가가 사용자 정의되지 않았다면 자동 계산
      if (!productData.results[index].sellPrice) {
        const priceCNY = productData.results[index].price || 0;
        const autoPrices = calculatePricesWithMargins(priceCNY);
        productData.results[index].sellPrice = autoPrices.sellPrice;
      }

      renderOptions();
      scheduleAutoSave();
    }

    // 판매가 업데이트
    function updateSellPrice(index, value) {
      const sellPrice = parseFloat(value) || 0;
      productData.results[index].sellPrice = sellPrice;
      renderOptions();
      scheduleAutoSave();
    }

    // 가격 계산 함수 (마진% 포함)
    function calculatePricesWithMargins(priceCNY) {
      // 1. 원화 원가
      const costKRW = priceCNY * settings.exchangeRate;

      // 2. 공급 마진% 선택 (설정에서 가져옴)
      let supplyMarginPercent = 30; // 기본값
      for (const rule of settings.supplyMargins) {
        if (costKRW < rule.amount) {
          supplyMarginPercent = rule.percent;
          break;
        }
      }

      // 3. 공급가 = (원화 원가 / (1 - 공급마진%)) + 포장비
      const supplyPrice = (costKRW / (1 - supplyMarginPercent / 100)) + settings.packagingCost;

      // 4. 판매 마진% 선택 (설정에서 가져옴)
      let saleMarginPercent = 15; // 기본값
      for (const rule of settings.saleMargins) {
        if (supplyPrice < rule.amount) {
          saleMarginPercent = rule.percent;
          break;
        }
      }

      // 5. 판매가 = 공급가 / (1 - 판매마진%)
      let sellPrice = supplyPrice / (1 - saleMarginPercent / 100);

      // 6. 최소 마진 보장
      const margin = sellPrice - supplyPrice;
      if (margin < settings.minMargin) {
        sellPrice = supplyPrice + settings.minMargin;
      }

      return {
        costKRW: Math.round(costKRW),
        supplyPrice: Math.round(supplyPrice),
        sellPrice: Math.round(sellPrice),
        margin: Math.round(sellPrice - supplyPrice),
        supplyMarginPercent: supplyMarginPercent,
        saleMarginPercent: saleMarginPercent
      };
    }

    // 가격 계산 함수 (마진% 미포함 - 하위 호환용)
    function calculatePrices(priceCNY) {
      const result = calculatePricesWithMargins(priceCNY);
      return {
        costKRW: result.costKRW,
        supplyPrice: result.supplyPrice,
        sellPrice: result.sellPrice,
        margin: result.margin
      };
    }

    // 가격 업데이트
    function updatePrice(index, value) {
      productData.results[index].price = parseFloat(value) || 0;
      renderOptions();
    }

    // 옵션 업데이트
    function updateOption(index, field, value) {
      const oldValue = productData.results[index][field];
      productData.results[index][field] = value;

      // optionName1이 변경된 경우, detailPageItems의 해당 옵션 블록도 동기화
      if (field === 'optionName1' && detailPageItems && detailPageItems.length > 0) {
        // 해당 옵션의 기존 이름으로 detailPageItems에서 찾기
        const foundItem = detailPageItems.find(item =>
          item.type === 'option-block' && item.optionName === oldValue
        );
        if (foundItem) {
          foundItem.optionName = value;
          console.log(`[Sync] 상세페이지 옵션명 동기화: "${oldValue}" → "${value}"`);
          // 상세페이지 탭이 활성화된 경우 UI도 갱신
          if (document.querySelector('.tab-btn.active')?.dataset?.tab === 'detail-page') {
            renderDetailCanvas();
          }
        }
      }

      scheduleAutoSave();
    }

    // 자동 저장 (debounce)
    let autoSaveTimeout = null;
    function scheduleAutoSave() {
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      autoSaveTimeout = setTimeout(() => {
        autoSaveProduct();
      }, 1500); // 1.5초 후 자동 저장
    }

    // 자동 저장 실행 (알림 없이)
    async function autoSaveProduct() {
      if (!productId) return; // 새 상품은 자동 저장 안 함

      productData.title = document.getElementById('productTitle').value;
      productData.detailPageItems = detailPageItems;

      if (detailPageItems && detailPageItems.length > 0) {
        productData.detailHtml = generateDetailPageHtml(detailPageItems);
      }

      try {
        const response = await authFetch(`/api/products/${productId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });

        if (response.ok) {
          console.log('[AutoSave] 자동 저장 완료');
        }
      } catch (error) {
        console.error('[AutoSave] 자동 저장 실패:', error);
      }
    }

    // 탭 전환
    function switchEditTab(tabName) {
      // 모든 탭 버튼 비활성화
      document.querySelectorAll('.edit-tab').forEach(btn => btn.classList.remove('active'));
      // 모든 탭 컨텐츠 숨기기
      document.querySelectorAll('.edit-tab-content').forEach(content => content.classList.remove('active'));

      // 선택한 탭 활성화
      event.target.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // 매핑 탭인 경우 리스트 렌더링
      if (tabName === 'mapping') {
        renderMappingLists();
      }

      // 가격 수집 탭인 경우 히스토리 로드
      if (tabName === 'price-collect') {
        loadPriceHistory();
      }
    }

    // 일괄 치환
    function bulkReplace() {
      const targetOption = document.getElementById('replaceTargetOption').value;
      const find = document.getElementById('findText').value;
      const replace = document.getElementById('replaceText').value;

      // 빈 값 찾기 허용
      // if (find === '') {
      //   alert('찾을 텍스트를 입력하세요.');
      //   return;
      // }

      let count = 0;

      if (find === '') {
        // 빈 값을 찾아서 replace 텍스트로 채우기
        productData.results.forEach(opt => {
          if (opt[targetOption] === '') {
            opt[targetOption] = replace;
            count++;
          }
        });
        showAlert(`${count}개 빈 항목을 '${replace}'(으)로 채웠습니다.`, 'success');
      } else {
        // 일반 찾기/바꾸기
        productData.results.forEach(opt => {
          if (opt[targetOption] && opt[targetOption].includes(find)) {
            opt[targetOption] = opt[targetOption].replace(new RegExp(find, 'g'), replace);
            count++;
          }
        });
        showAlert(`${count}개 항목이 치환되었습니다.`, 'success');
      }

      renderOptions();
      scheduleAutoSave();
    }

    // 이름 매핑 다이얼로그 열기
    function openMappingDialog() {
      const targetOption = document.getElementById('mappingTargetOption').value;
      const optionLabel = targetOption === 'optionName1' ? '옵션1' : '옵션2';

      // 유니크한 값 추출
      const uniqueValues = [];
      const seen = new Set();

      productData.results.forEach(opt => {
        const value = opt[targetOption] || '';
        if (!seen.has(value)) {
          uniqueValues.push(value);
          seen.add(value);
        }
      });

      // 매핑 행 생성
      const mappingRows = document.getElementById('mappingRows');
      mappingRows.innerHTML = '';

      uniqueValues.forEach(value => {
        const row = document.createElement('div');
        row.className = 'mapping-row';
        row.innerHTML = `
          <input type="text" value="${value || '(빈 값)'}" readonly>
          <span>→</span>
          <input type="text" value="${value}" data-old-value="${value}" placeholder="새 값 입력">
        `;
        mappingRows.appendChild(row);
      });

      // 제목 업데이트
      document.getElementById('mappingDialogTitle').textContent = `${optionLabel} 이름 매핑`;

      // 다이얼로그 표시
      document.getElementById('mappingDialog').classList.add('active');
    }

    // 이름 매핑 적용
    function applyMapping() {
      const targetOption = document.getElementById('mappingTargetOption').value;
      const mappingRows = document.querySelectorAll('#mappingRows .mapping-row');

      const mapping = {};
      mappingRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const oldValue = inputs[1].dataset.oldValue;
        const newValue = inputs[1].value.trim();

        if (newValue && oldValue !== newValue) {
          mapping[oldValue] = newValue;
        }
      });

      // 매핑 적용
      let count = 0;
      productData.results.forEach(opt => {
        const currentValue = opt[targetOption] || '';
        if (mapping.hasOwnProperty(currentValue)) {
          opt[targetOption] = mapping[currentValue];
          count++;
        }
      });

      renderOptions();
      closeMappingDialog();
      scheduleAutoSave();

      showAlert(`${count}개 항목이 변경되었습니다.`, 'success');
    }

    // 이름 매핑 다이얼로그 닫기
    function closeMappingDialog() {
      document.getElementById('mappingDialog').classList.remove('active');
    }

    // 순번 부여
    function applyNumbering() {
      const targetOption = document.getElementById('numberingTargetOption').value;
      const prefix = document.getElementById('numberingPrefix').value.trim();
      const type = document.getElementById('numberingType').value;

      // 유니크한 값 추출
      const uniqueValues = [];
      const seen = new Set();

      productData.results.forEach(opt => {
        const value = opt[targetOption] || '';
        if (!seen.has(value)) {
          uniqueValues.push(value);
          seen.add(value);
        }
      });

      // 순번 생성
      const mapping = {};
      uniqueValues.forEach((value, index) => {
        let suffix;
        if (type === 'number') {
          suffix = (index + 1).toString();
        } else {
          // 알파벳 (A, B, C, ... Z, AA, AB, ...)
          suffix = numberToLetter(index);
        }
        mapping[value] = prefix + suffix;
      });

      // 적용
      let count = 0;
      productData.results.forEach(opt => {
        const currentValue = opt[targetOption] || '';
        if (mapping.hasOwnProperty(currentValue)) {
          opt[targetOption] = mapping[currentValue];
          count++;
        }
      });

      renderOptions();
      scheduleAutoSave();
      showAlert(`${count}개 항목에 순번이 부여되었습니다.`, 'success');
    }

    // 숫자를 알파벳으로 변환 (0=A, 1=B, ..., 25=Z, 26=AA, ...)
    function numberToLetter(num) {
      let result = '';
      num = num + 1; // 1부터 시작

      while (num > 0) {
        const remainder = (num - 1) % 26;
        result = String.fromCharCode(65 + remainder) + result;
        num = Math.floor((num - 1) / 26);
      }

      return result;
    }

    // ========== AI 상품명 작명 기능 ==========

    // AI 상품명 생성
    async function generateAITitle() {
      const btn = document.getElementById('btnAiTitle');
      const spinner = document.getElementById('aiTitleSpinner');
      const text = document.getElementById('aiTitleText');
      const titleInput = document.getElementById('productTitle');

      const currentTitle = titleInput.value.trim();

      if (!currentTitle) {
        showAlert('현재 상품명이 없습니다.', 'error');
        return;
      }

      // 버튼 상태 변경
      btn.disabled = true;
      spinner.style.display = 'inline-block';
      text.textContent = '생성중...';

      try {
        const response = await fetch('/api/gemini/generate-title', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            originalTitle: currentTitle,
            titleCn: productData.titleCn || ''
          })
        });

        const result = await response.json();

        if (result.success && result.title) {
          titleInput.value = result.title;
          productData.title = result.title;
          showAlert('상품명이 AI로 생성되었습니다!', 'success');
          scheduleAutoSave();
        } else {
          showAlert(result.message || 'AI 상품명 생성 실패', 'error');
        }
      } catch (error) {
        console.error('AI 상품명 생성 오류:', error);
        showAlert('AI 상품명 생성 중 오류가 발생했습니다.', 'error');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
        text.textContent = 'AI 작명';
      }
    }

    // ========== 쿠팡 가격 수집 기능 ==========

    // 수집된 가격 데이터 저장
    let collectedPriceData = {
      all: null,
      rocket: null
    };

    // 안전하게 요소에 텍스트 설정 (전역)
    function setTextSafe(id, text, style = null) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
        if (style) {
          Object.assign(el.style, style);
        }
      }
    }

    // 쿠팡 가격 수집 (Chrome 확장 프로그램 사용)
    async function collectCoupangPrices() {
      const keyword = document.getElementById('priceCollectKeyword').value.trim();
      const btn = document.getElementById('priceCollectBtn');
      const icon = document.getElementById('priceCollectIcon');
      const text = document.getElementById('priceCollectText');
      const useIncognito = document.getElementById('useIncognitoMode')?.checked || false;

      if (!keyword) {
        showAlert('검색 키워드를 입력해주세요.', 'error');
        return;
      }

      // 버튼 상태 변경
      btn.disabled = true;
      icon.textContent = '⏳';
      text.textContent = useIncognito ? '시크릿 모드 수집중...' : '수집중...';

      try {
        // Chrome 확장 프로그램으로 가격 수집 요청
        const result = await sendMessageToExtension({
          action: 'collectCoupangPrices',
          keyword: keyword,
          options: { incognito: useIncognito }
        });

        console.log('가격 수집 결과:', result);

        if (result && result.found) {
          // 새로운 응답 형식 처리 (result.all 객체에 직접 데이터가 있는 경우)
          let priceData;

          if (result.all && result.all.status === 'success') {
            // 새 형식: result.all에 직접 데이터가 있음
            priceData = {
              all: result.all,
              rocket: result.rocket || null
            };
          } else {
            // 기존 형식: result에 minPrice, maxPrice 등이 있음
            priceData = {
              all: {
                status: 'success',
                min: result.minPrice,
                max: result.maxPrice,
                average: result.avgPrice,
                median: result.medianPrice,
                totalItems: result.count
              },
              rocket: null
            };
          }

          collectedPriceData.all = priceData.all;
          collectedPriceData.rocket = priceData.rocket;

          // 결과 표시
          displayPriceResults(priceData);
          document.getElementById('priceCollectResult').style.display = 'block';

          const itemCount = priceData.all.totalItems || result.rawCount || result.count || 0;
          showAlert(`가격 수집 완료! ${itemCount}개 상품 가격 수집됨`, 'success');

          // 히스토리에 저장
          savePriceHistory(keyword, [], {
            minPrice: priceData.all.min,
            avgPrice: priceData.all.average,
            midPrice: priceData.all.median,
            maxPrice: priceData.all.max,
            productCount: itemCount
          });
        } else {
          showAlert(result?.error || '가격 수집 실패 - 검색 결과가 없거나 확장 프로그램이 연결되지 않았습니다.', 'error');
        }
      } catch (error) {
        console.error('가격 수집 오류:', error);
        showAlert('가격 수집 중 오류가 발생했습니다. Chrome 확장 프로그램이 설치되어 있는지 확인해주세요.', 'error');
      } finally {
        btn.disabled = false;
        icon.textContent = '🔍';
        text.textContent = '가격 수집 시작';
      }
    }

    // 가격 결과 표시 및 마진 계산
    function displayPriceResults(data) {
      const formatPrice = (price) => price ? `${price.toLocaleString()}원` : '-';

      // 안전하게 요소에 텍스트 설정
      const setTextSafe = (id, text, style = null) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = text;
          if (style) {
            Object.assign(el.style, style);
          }
        }
      };

      // 안전하게 innerHTML 설정
      const setHtmlSafe = (id, html) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      };

      // 쿠팡 시장가 표시
      if (data.all && data.all.status === 'success') {
        setTextSafe('allMinPrice', formatPrice(data.all.min));
        setTextSafe('allAvgPrice', formatPrice(data.all.average));
        setTextSafe('allMidPrice', formatPrice(data.all.median));
        setTextSafe('allMaxPrice', formatPrice(data.all.max));
        setTextSafe('allCount', data.all.totalItems);
      } else {
        setTextSafe('allMinPrice', '-');
        setTextSafe('allAvgPrice', '-');
        setTextSafe('allMidPrice', '-');
        setTextSafe('allMaxPrice', '-');
        setTextSafe('allCount', '0');
      }

      // 내 판매가 통계 계산
      const myPrices = getMyPriceStats();
      setTextSafe('myMinPrice', formatPrice(myPrices.min));
      setTextSafe('myAvgPrice', formatPrice(myPrices.avg));
      setTextSafe('myMidPrice', formatPrice(myPrices.median));
      setTextSafe('myMaxPrice', formatPrice(myPrices.max));

      // 마진 계산 및 표시
      if (data.all && data.all.status === 'success' && myPrices.min > 0) {
        displayMarginComparison(data.all, myPrices);
      } else {
        setTextSafe('marginMin', '-');
        setTextSafe('marginAvg', '-');
        setTextSafe('marginMid', '-');
        setTextSafe('marginMax', '-');
      }

      // 기준가 버튼 업데이트
      updateBasePriceButtons();
    }

    // 내 판매가 통계 계산 (sellPrice가 KRW 판매가, price는 CNY 원가)
    function getMyPriceStats() {
      const prices = productData.results
        .map(opt => parseFloat(opt.sellPrice) || 0)  // sellPrice가 KRW 판매가
        .filter(p => p > 0);

      if (prices.length === 0) {
        return { min: 0, max: 0, avg: 0, median: 0 };
      }

      const sorted = [...prices].sort((a, b) => a - b);
      const min = sorted[0];
      const max = sorted[sorted.length - 1];
      const avg = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
      const mid = Math.floor(sorted.length / 2);
      const median = sorted.length % 2 !== 0
        ? sorted[mid]
        : Math.round((sorted[mid - 1] + sorted[mid]) / 2);

      return { min, max, avg, median };
    }

    // 마진 비교 표시
    function displayMarginComparison(marketData, myPrices) {
      // 마진 계산: 내 판매가 - 쿠팡 시장가
      const margins = {
        min: myPrices.min - marketData.min,
        avg: myPrices.avg - marketData.average,
        mid: myPrices.median - marketData.median,
        max: myPrices.max - marketData.max
      };

      // 마진율 계산 (소수점 제거)
      const marginRates = {
        min: marketData.min > 0 ? Math.round((myPrices.min - marketData.min) / marketData.min * 100) : 0,
        avg: marketData.average > 0 ? Math.round((myPrices.avg - marketData.average) / marketData.average * 100) : 0,
        mid: marketData.median > 0 ? Math.round((myPrices.median - marketData.median) / marketData.median * 100) : 0,
        max: marketData.max > 0 ? Math.round((myPrices.max - marketData.max) / marketData.max * 100) : 0
      };

      // 마진 표시 함수
      const formatMargin = (margin, rate) => {
        const color = margin >= 0 ? '#38a169' : '#e53e3e';
        const sign = margin >= 0 ? '+' : '';
        const rateSign = parseFloat(rate) >= 0 ? '+' : '';
        return `<span style="color: ${color}; font-weight: 600;">${sign}${margin.toLocaleString()}원</span><br><span style="color: ${color}; font-size: 11px;">(${rateSign}${rate}%)</span>`;
      };

      // 각 셀에 마진 표시
      const setHtmlSafe = (id, html) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      };

      setHtmlSafe('marginMin', formatMargin(margins.min, marginRates.min));
      setHtmlSafe('marginAvg', formatMargin(margins.avg, marginRates.avg));
      setHtmlSafe('marginMid', formatMargin(margins.mid, marginRates.mid));
      setHtmlSafe('marginMax', formatMargin(margins.max, marginRates.max));

      // 경쟁력 분석 표시
      displayCompetitiveAnalysis(marketData, myPrices, margins, marginRates);
    }

    // 경쟁력 분석 표시
    function displayCompetitiveAnalysis(marketData, myPrices, margins, marginRates) {
      const analysisEl = document.getElementById('competitiveAnalysis');
      const iconEl = document.getElementById('competitiveIcon');
      const titleEl = document.getElementById('competitiveTitle');
      const messageEl = document.getElementById('competitiveMessage');

      if (!analysisEl) return;

      analysisEl.style.display = 'block';

      // 중간가 기준으로 경쟁력 판단
      const midDiff = parseFloat(marginRates.mid);
      let bgColor, icon, title, message;

      if (midDiff <= -20) {
        // 매우 저렴 (시장가보다 20% 이상 저렴)
        bgColor = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        icon = '🏆';
        title = '가격 경쟁력 우수!';
        message = `내 판매가가 시장 중간가보다 <strong>${Math.abs(midDiff)}% 저렴</strong>합니다.<br>
          가격 경쟁력이 높아 판매에 유리합니다. 마진 확보 여부를 확인해보세요.`;
      } else if (midDiff <= -5) {
        // 약간 저렴
        bgColor = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
        icon = '✅';
        title = '적정 가격대';
        message = `내 판매가가 시장 중간가보다 <strong>${Math.abs(midDiff)}% 저렴</strong>합니다.<br>
          경쟁력 있는 가격으로 설정되어 있습니다.`;
      } else if (midDiff <= 5) {
        // 비슷한 가격
        bgColor = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
        icon = '⚖️';
        title = '시장 평균 가격';
        message = `내 판매가가 시장 중간가와 <strong>유사</strong>합니다 (${midDiff > 0 ? '+' : ''}${midDiff}%).<br>
          차별화 포인트(빠른 배송, 품질 등)로 경쟁해보세요.`;
      } else if (midDiff <= 20) {
        // 약간 비쌈
        bgColor = 'linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%)';
        icon = '⚠️';
        title = '가격이 다소 높음';
        message = `내 판매가가 시장 중간가보다 <strong>${midDiff}% 비쌉</strong>니다.<br>
          가격 조정을 고려하거나, 프리미엄 제품으로 포지셔닝하세요.`;
      } else {
        // 매우 비쌈
        bgColor = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
        icon = '🚨';
        title = '가격 조정 필요';
        message = `내 판매가가 시장 중간가보다 <strong>${midDiff}% 비쌉</strong>니다.<br>
          경쟁력 확보를 위해 가격 조정을 강력히 권장합니다.`;
      }

      analysisEl.style.background = bgColor;
      if (iconEl) iconEl.textContent = icon;
      if (titleEl) titleEl.textContent = title;
      if (messageEl) messageEl.innerHTML = message;

      // 옵션별 역마진 경고 표시
      displayNegativeMarginWarning(marketData);
    }

    // 옵션별 역마진 경고 표시
    function displayNegativeMarginWarning(marketData) {
      // 기존 경고 제거
      const existingWarning = document.getElementById('negativeMarginWarning');
      if (existingWarning) existingWarning.remove();

      if (!collectedPriceData.all || !marketData) return;

      const marketMedian = marketData.median || 0;
      if (marketMedian <= 0) return;

      // 각 옵션의 판매가와 시장가 비교
      let negativeCount = 0;
      let lowMarginCount = 0;  // 마진 10% 미만
      const negativeOptions = [];
      const lowMarginOptions = [];

      productData.results.forEach((opt, idx) => {
        const sellPrice = parseFloat(opt.sellPrice) || 0;
        if (sellPrice <= 0) return;

        const margin = sellPrice - marketMedian;
        const marginRate = Math.round((margin / marketMedian) * 100);

        if (sellPrice < marketMedian) {
          // 역마진 (시장가보다 내 판매가가 낮음)
          negativeCount++;
          const optName = opt.optionName1 || opt.optionName1Cn || `옵션${idx + 1}`;
          negativeOptions.push({
            name: optName.substring(0, 20),
            price: sellPrice,
            margin: margin,
            marginRate: marginRate
          });
        } else if (marginRate < 10 && marginRate >= 0) {
          // 저마진
          lowMarginCount++;
          const optName = opt.optionName1 || opt.optionName1Cn || `옵션${idx + 1}`;
          lowMarginOptions.push({
            name: optName.substring(0, 20),
            price: sellPrice,
            margin: margin,
            marginRate: marginRate
          });
        }
      });

      // 경고가 없으면 종료
      if (negativeCount === 0 && lowMarginCount === 0) return;

      // 경고 UI 생성
      const warningDiv = document.createElement('div');
      warningDiv.id = 'negativeMarginWarning';
      warningDiv.style.cssText = `
        margin-top: 15px;
        padding: 12px 15px;
        border-radius: 8px;
        font-size: 13px;
      `;

      let warningHtml = '';

      if (negativeCount > 0) {
        warningDiv.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
        warningDiv.style.border = '1px solid #f87171';
        warningHtml = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 18px;">🚨</span>
            <strong style="color: #dc2626;">역마진 경고! ${negativeCount}개 옵션</strong>
          </div>
          <div style="color: #991b1b; font-size: 12px;">
            다음 옵션의 판매가가 시장 중간가(${marketMedian.toLocaleString()}원)보다 낮습니다:
          </div>
          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
            ${negativeOptions.slice(0, 5).map(opt => `
              <span style="background: #fecaca; padding: 3px 8px; border-radius: 4px; font-size: 11px; color: #991b1b;">
                ${opt.name}: ${opt.price.toLocaleString()}원 (${opt.marginRate}%)
              </span>
            `).join('')}
            ${negativeCount > 5 ? `<span style="color: #991b1b; font-size: 11px;">외 ${negativeCount - 5}개</span>` : ''}
          </div>
        `;
      } else if (lowMarginCount > 0) {
        warningDiv.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
        warningDiv.style.border = '1px solid #f59e0b';
        warningHtml = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 18px;">⚠️</span>
            <strong style="color: #d97706;">저마진 주의! ${lowMarginCount}개 옵션</strong>
          </div>
          <div style="color: #92400e; font-size: 12px;">
            다음 옵션의 마진율이 10% 미만입니다 (시장 중간가: ${marketMedian.toLocaleString()}원):
          </div>
          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
            ${lowMarginOptions.slice(0, 5).map(opt => `
              <span style="background: #fde68a; padding: 3px 8px; border-radius: 4px; font-size: 11px; color: #92400e;">
                ${opt.name}: ${opt.price.toLocaleString()}원 (+${opt.marginRate}%)
              </span>
            `).join('')}
            ${lowMarginCount > 5 ? `<span style="color: #92400e; font-size: 11px;">외 ${lowMarginCount - 5}개</span>` : ''}
          </div>
        `;
      }

      warningDiv.innerHTML = warningHtml;

      // competitiveAnalysis 뒤에 삽입
      const analysisEl = document.getElementById('competitiveAnalysis');
      if (analysisEl && analysisEl.parentNode) {
        analysisEl.parentNode.insertBefore(warningDiv, analysisEl.nextSibling);
      }
    }

    // 현재 선택된 기준가 타입
    let selectedPriceBase = 'min';

    // 기준가 선택
    function selectPriceBase(baseType) {
      selectedPriceBase = baseType;

      // 버튼 활성화 상태 변경
      document.querySelectorAll('.price-base-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.base === baseType) {
          btn.classList.add('active');
        }
      });

      updatePricePreview();
    }

    // 빠른 조정
    function quickAdjust(percent) {
      document.getElementById('priceAdjustPercent').value = percent;
      document.getElementById('priceSlider').value = percent;
      updatePricePreview();
    }

    // 슬라이더와 입력 동기화
    function syncSlider() {
      const value = parseFloat(document.getElementById('priceAdjustPercent').value) || 0;
      document.getElementById('priceSlider').value = Math.max(-50, Math.min(50, value));
      updatePricePreview();
    }

    // 가격 미리보기 업데이트
    function updatePricePreview() {
      const adjustPercent = parseFloat(document.getElementById('priceSlider').value) || 0;
      document.getElementById('priceAdjustPercent').value = adjustPercent;

      const source = collectedPriceData.all;
      if (!source || source.status !== 'success') {
        setTextSafe('previewPrice', '-');
        setTextSafe('previewMargin', '-');
        setTextSafe('previewMarginRate', '-');
        return;
      }

      // 기준 가격 가져오기
      let basePrice = 0;
      switch (selectedPriceBase) {
        case 'min': basePrice = source.min; break;
        case 'avg': basePrice = source.average; break;
        case 'mid': basePrice = source.median; break;
        case 'max': basePrice = source.max; break;
      }

      if (!basePrice) return;

      // 예상 판매가
      const expectedPrice = Math.round(basePrice * (1 + adjustPercent / 100));

      // 평균 원가 계산 (공급가 기준)
      const avgCost = getAverageCost();

      // 마진 계산
      const margin = expectedPrice - avgCost;
      const marginRate = avgCost > 0 ? ((margin / expectedPrice) * 100) : 0;

      // 표시
      const priceEl = document.getElementById('previewPrice');
      const marginEl = document.getElementById('previewMargin');
      const marginRateEl = document.getElementById('previewMarginRate');

      if (priceEl) priceEl.textContent = expectedPrice.toLocaleString() + '원';

      if (marginEl) {
        marginEl.textContent = (margin >= 0 ? '+' : '') + margin.toLocaleString() + '원';
        marginEl.style.color = margin >= 0 ? '#059669' : '#dc2626';
      }

      if (marginRateEl) {
        marginRateEl.textContent = Math.round(marginRate) + '%';
        marginRateEl.style.color = marginRate >= 20 ? '#059669' : (marginRate >= 10 ? '#d97706' : '#dc2626');
      }

      // 슬라이더 조정 시 역마진 경고도 실시간 업데이트
      if (collectedPriceData.all && collectedPriceData.all.status === 'success') {
        updateNegativeMarginWarningWithPreview(expectedPrice);
      }
    }

    // 슬라이더 조정 시 역마진 경고 실시간 업데이트
    function updateNegativeMarginWarningWithPreview(expectedPrice) {
      // 기존 경고 제거
      const existingWarning = document.getElementById('negativeMarginWarning');
      if (existingWarning) existingWarning.remove();

      if (!collectedPriceData.all) return;

      const marketMedian = collectedPriceData.all.median || 0;
      if (marketMedian <= 0 || !expectedPrice) return;

      // 예상 판매가와 시장가 비교
      let negativeCount = 0;
      let lowMarginCount = 0;
      const negativeOptions = [];
      const lowMarginOptions = [];

      productData.results.forEach((opt, idx) => {
        // 현재 슬라이더로 조정된 예상 판매가 사용
        const margin = expectedPrice - marketMedian;
        const marginRate = Math.round((margin / marketMedian) * 100);

        if (expectedPrice < marketMedian) {
          negativeCount++;
          const optName = opt.optionName1 || opt.optionName1Cn || `옵션${idx + 1}`;
          if (negativeOptions.length < 5) {
            negativeOptions.push({
              name: optName.substring(0, 20),
              price: expectedPrice,
              marginRate: marginRate
            });
          }
        } else if (marginRate < 10 && marginRate >= 0) {
          lowMarginCount++;
          const optName = opt.optionName1 || opt.optionName1Cn || `옵션${idx + 1}`;
          if (lowMarginOptions.length < 5) {
            lowMarginOptions.push({
              name: optName.substring(0, 20),
              price: expectedPrice,
              marginRate: marginRate
            });
          }
        }
      });

      // 경고가 없으면 종료
      if (negativeCount === 0 && lowMarginCount === 0) return;

      // 경고 UI 생성
      const warningDiv = document.createElement('div');
      warningDiv.id = 'negativeMarginWarning';
      warningDiv.style.cssText = `
        margin-top: 15px;
        padding: 12px 15px;
        border-radius: 8px;
        font-size: 13px;
      `;

      let warningHtml = '';
      const optionCount = productData.results.length;

      if (negativeCount > 0) {
        warningDiv.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
        warningDiv.style.border = '1px solid #f87171';
        warningHtml = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">🚨</span>
            <strong style="color: #dc2626;">역마진 경고!</strong>
            <span style="color: #991b1b; font-size: 12px;">
              예상 판매가(${expectedPrice.toLocaleString()}원)가 시장 중간가(${marketMedian.toLocaleString()}원)보다 낮습니다
            </span>
          </div>
        `;
      } else if (lowMarginCount > 0) {
        warningDiv.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
        warningDiv.style.border = '1px solid #f59e0b';
        const marginRate = Math.round((expectedPrice - marketMedian) / marketMedian * 100);
        warningHtml = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">⚠️</span>
            <strong style="color: #d97706;">저마진 주의!</strong>
            <span style="color: #92400e; font-size: 12px;">
              마진율 ${marginRate}% (시장 중간가 대비)
            </span>
          </div>
        `;
      }

      warningDiv.innerHTML = warningHtml;

      // competitiveAnalysis 뒤에 삽입
      const analysisEl = document.getElementById('competitiveAnalysis');
      if (analysisEl && analysisEl.parentNode) {
        analysisEl.parentNode.insertBefore(warningDiv, analysisEl.nextSibling);
      }
    }

    // 평균 원가 계산
    function getAverageCost() {
      if (!productData.results || productData.results.length === 0) return 0;

      const costs = productData.results
        .map(opt => parseFloat(opt.supplyPrice) || parseFloat(opt.costPrice) || 0)
        .filter(c => c > 0);

      if (costs.length === 0) return 0;
      return costs.reduce((a, b) => a + b, 0) / costs.length;
    }

    // 기준가 버튼에 가격 표시
    function updateBasePriceButtons() {
      const source = collectedPriceData.all;
      if (!source || source.status !== 'success') return;

      setTextSafe('basePriceMin', source.min ? source.min.toLocaleString() + '원' : '-');
      setTextSafe('basePriceAvg', source.average ? Math.round(source.average).toLocaleString() + '원' : '-');
      setTextSafe('basePriceMid', source.median ? source.median.toLocaleString() + '원' : '-');
      setTextSafe('basePriceMax', source.max ? source.max.toLocaleString() + '원' : '-');

      updatePricePreview();
    }

    // 수집된 가격으로 판매가 적용
    function applyCollectedPrice() {
      const adjustPercent = parseFloat(document.getElementById('priceAdjustPercent').value) || 0;

      const source = collectedPriceData.all;
      if (!source || source.status !== 'success') {
        showAlert('가격 데이터가 없습니다. 먼저 가격을 수집해주세요.', 'error');
        return;
      }

      // 기준 가격 가져오기
      let basePrice = 0;
      let baseName = '';
      switch (selectedPriceBase) {
        case 'min': basePrice = source.min; baseName = '최저가'; break;
        case 'avg': basePrice = source.average; baseName = '평균가'; break;
        case 'mid': basePrice = source.median; baseName = '중간가'; break;
        case 'max': basePrice = source.max; baseName = '최고가'; break;
      }

      if (!basePrice) {
        showAlert('기준 가격을 찾을 수 없습니다.', 'error');
        return;
      }

      // 조정된 가격 계산
      const adjustedPrice = Math.round(basePrice * (1 + adjustPercent / 100));
      const avgCost = getAverageCost();
      const margin = adjustedPrice - avgCost;
      const marginRate = avgCost > 0 ? ((margin / adjustedPrice) * 100) : 0;

      // 확인
      const confirmMsg = `쿠팡 ${baseName}: ${Math.round(basePrice).toLocaleString()}원
조정: ${adjustPercent >= 0 ? '+' : ''}${adjustPercent}%
적용 판매가: ${adjustedPrice.toLocaleString()}원
예상 마진: ${margin.toLocaleString()}원 (${Math.round(marginRate)}%)

모든 옵션의 판매가를 변경하시겠습니까?`;

      if (!confirm(confirmMsg)) return;

      // 모든 옵션의 판매가 및 공급가 변경
      let updatedCount = 0;
      productData.results.forEach(opt => {
        // 판매가 설정
        opt.price = adjustedPrice;
        opt.sellPrice = adjustedPrice;

        // 공급가 역산: 판매가에서 판매마진율을 적용해서 공급가 계산
        // 판매가 = 공급가 / (1 - 판매마진%)  =>  공급가 = 판매가 * (1 - 판매마진%)
        const saleMarginPercent = getSaleMarginPercent(adjustedPrice);
        const newSupplyPrice = Math.round(adjustedPrice * (1 - saleMarginPercent / 100));
        opt.supplyPrice = newSupplyPrice;

        updatedCount++;
      });

      // UI 업데이트
      renderOptions();
      scheduleAutoSave();

      showAlert(`${updatedCount}개 옵션의 판매가가 ${adjustedPrice.toLocaleString()}원으로 변경되었습니다.`, 'success');
    }

    // 판매가 구간별 마진율 조회
    function getSaleMarginPercent(sellPrice) {
      for (const tier of settings.saleMargins) {
        if (sellPrice <= tier.amount) {
          return tier.percent;
        }
      }
      // 마지막 구간 반환
      return settings.saleMargins[settings.saleMargins.length - 1].percent;
    }

    // ========== AI 옵션명 변환 기능 ==========

    // AI 옵션명 자동 변환 (중국어 → 한국어)
    async function applyAIRename() {
      const targetOption = document.getElementById('aiTargetOption').value;
      const btn = document.getElementById('aiRenameBtn');
      const icon = document.getElementById('aiRenameIcon');
      const text = document.getElementById('aiRenameText');

      // 대상 옵션 필드 결정
      const targetFields = targetOption === 'all'
        ? ['optionName1', 'optionName2']
        : [targetOption];

      // 유니크한 옵션 값 수집 (전체 옵션인 경우 옵션1, 옵션2 모두 수집)
      const uniqueValues = [];
      const seen = new Set();

      productData.results.forEach(opt => {
        targetFields.forEach(field => {
          const value = opt[field] || '';
          if (value && !seen.has(value)) {
            uniqueValues.push(value);
            seen.add(value);
          }
        });
      });

      if (uniqueValues.length === 0) {
        showAlert('변환할 옵션 값이 없습니다.', 'warning');
        return;
      }

      // 로딩 상태
      btn.disabled = true;
      icon.textContent = '⏳';
      text.textContent = 'AI 변환 중...';

      try {
        const response = await fetch('/api/gemini/rename-options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            optionValues: uniqueValues,
            mode: 'auto'
          })
        });

        if (!response.ok) throw new Error('AI 변환 실패');

        const data = await response.json();
        const mapping = data.mapping || {};

        // 매핑 적용 (실제로 값이 변경된 경우만 카운트)
        let changedCount = 0;
        productData.results.forEach(opt => {
          targetFields.forEach(field => {
            const currentValue = opt[field] || '';
            if (mapping[currentValue] && mapping[currentValue] !== currentValue) {
              opt[field] = mapping[currentValue];
              changedCount++;
            }
          });
        });

        renderOptions();
        if (changedCount > 0) {
          showAlert(`AI가 ${changedCount}개 옵션을 변환했습니다.`, 'success');
          scheduleAutoSave();
        } else {
          showAlert('변환할 중국어 옵션이 없거나 이미 변환되었습니다.', 'info');
        }
      } catch (error) {
        console.error('AI 변환 오류:', error);
        showAlert('AI 변환에 실패했습니다. 다시 시도해주세요.', 'error');
      } finally {
        btn.disabled = false;
        icon.textContent = '✨';
        text.textContent = 'AI 변환 시작';
      }
    }

    // ========== END AI 기능 ==========

    // 자동 번역
    // silent: true일 경우 확인창 및 알림 없이 자동 실행 (로드시 사용)
    async function autoTranslate(silent = false) {
      if (!silent && !confirm('중국어를 자동 번역하시겠습니까?')) {
        return;
      }

      try {
        // 번역이 필요한 텍스트만 수집 (중복 제거)
        const textsToTranslate = new Set();

        // 상품명 번역 대상
        if (productData.titleCn && productData.titleCn.trim() && (!productData.title || !productData.title.trim())) {
          textsToTranslate.add(productData.titleCn);
        }

        // 옵션명 번역 대상
        if (productData.results && Array.isArray(productData.results)) {
          productData.results.forEach(opt => {
            // 한국어 옵션1이 비어있고 중국어가 있으면 번역 대상
            if (opt.optionName1Cn && opt.optionName1Cn.trim() && (!opt.optionName1 || !opt.optionName1.trim())) {
              textsToTranslate.add(opt.optionName1Cn);
            }
            // 한국어 옵션2가 비어있고 중국어가 있으면 번역 대상
            if (opt.optionName2Cn && opt.optionName2Cn.trim() && (!opt.optionName2 || !opt.optionName2.trim())) {
              textsToTranslate.add(opt.optionName2Cn);
            }
          });
        }

        if (textsToTranslate.size === 0) {
          if (!silent) {
            showAlert('번역할 항목이 없습니다.', 'info');
          }
          return;
        }

        if (silent) {
          console.log(`[자동 번역] ${textsToTranslate.size}개 항목 번역 중...`);
        }

        const response = await fetch('/api/translate/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ texts: Array.from(textsToTranslate) })
        });

        if (!response.ok) throw new Error('번역 실패');

        const data = await response.json();
        const translationMap = data.results || {};

        // 번역 결과 적용 (빈 필드만)
        let count = 0;

        // 상품명 번역 적용
        if (productData.titleCn && translationMap[productData.titleCn]) {
          if (!productData.title || !productData.title.trim()) {
            productData.title = translationMap[productData.titleCn];
            document.getElementById('productTitle').value = productData.title;
            count++;
          }
        }

        // 옵션명 번역 적용
        if (productData.results && Array.isArray(productData.results)) {
          productData.results.forEach(opt => {
            if (opt.optionName1Cn && translationMap[opt.optionName1Cn]) {
              if (!opt.optionName1 || !opt.optionName1.trim()) {
                opt.optionName1 = translationMap[opt.optionName1Cn];
                count++;
              }
            }
            if (opt.optionName2Cn && translationMap[opt.optionName2Cn]) {
              if (!opt.optionName2 || !opt.optionName2.trim()) {
                opt.optionName2 = translationMap[opt.optionName2Cn];
                count++;
              }
            }
          });
        }

        renderOptions();

        if (silent) {
          console.log(`[자동 번역] ${count}개 필드 번역 완료`);
        } else {
          showAlert(`${count}개 필드의 번역이 완료되었습니다.`, 'success');
        }
      } catch (error) {
        console.error('번역 오류:', error);
        if (!silent) {
          showAlert('번역에 실패했습니다.', 'error');
        }
      }
    }

    // 매직 브러쉬 열기
    function openMagicBrush(imageSrc, optionIndexes = null) {
      if (!imageSrc) return;

      // 원본 URL 및 옵션 인덱스 저장
      currentEditingImageUrl = imageSrc;
      currentEditingOptionIndexes = optionIndexes;

      currentEditingImage = new Image();
      currentEditingImage.crossOrigin = 'anonymous';
      currentEditingImage.onload = function() {
        // 원본 크기로 캔버스 설정
        canvas.width = this.width;
        canvas.height = this.height;
        ctx.drawImage(this, 0, 0);

        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // 캔버스 이벤트 리스너 설정
        setupCanvasEvents();

        document.getElementById('magicBrushModal').classList.add('active');
      };
      currentEditingImage.src = imageSrc;
    }

    // 캔버스 이벤트 설정
    function setupCanvasEvents() {
      canvas.onmousedown = startDrawing;
      canvas.onmousemove = draw;
      canvas.onmouseup = stopDrawing;
      canvas.onmouseleave = stopDrawing;

      // 터치 이벤트도 지원
      canvas.ontouchstart = (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        startDrawing({ offsetX: x, offsetY: y });
      };

      canvas.ontouchmove = (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        draw({ offsetX: x, offsetY: y });
      };

      canvas.ontouchend = stopDrawing;
    }

    // 매직 이레이저 모드 토글
    function toggleMagicEraser() {
      isMagicErasing = !isMagicErasing;
      isErasing = false;

      const magicBtn = document.getElementById('magicEraserBtn');
      const eraserBtn = document.getElementById('eraserBtn');

      if (isMagicErasing) {
        magicBtn.classList.add('active');
        eraserBtn.classList.remove('active');
        canvas.classList.add('eraser-mode');

        // 마스크 캔버스 생성
        if (!maskCanvas) {
          maskCanvas = document.createElement('canvas');
          maskCanvas.width = canvas.width;
          maskCanvas.height = canvas.height;
          maskCtx = maskCanvas.getContext('2d');
        }
      } else {
        magicBtn.classList.remove('active');
        canvas.classList.remove('eraser-mode');
      }
    }

    // 일반 지우개 모드 토글
    function toggleEraser() {
      isErasing = !isErasing;
      isMagicErasing = false;

      const btn = document.getElementById('eraserBtn');
      const magicBtn = document.getElementById('magicEraserBtn');

      if (isErasing) {
        btn.classList.add('active');
        magicBtn.classList.remove('active');
        canvas.classList.add('eraser-mode');
      } else {
        btn.classList.remove('active');
        canvas.classList.remove('eraser-mode');
      }
    }

    // 브러시 크기 업데이트
    function updateBrushSize() {
      brushSize = parseInt(document.getElementById('brushSizeSlider').value);
      document.getElementById('brushSizeValue').textContent = brushSize;
    }

    // 드로잉 시작
    function startDrawing(e) {
      if (!isErasing && !isMagicErasing) return;
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }

    // 드로잉
    function draw(e) {
      if (!isDrawing) return;

      if (isErasing) {
        // 일반 지우개: 투명하게
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      } else if (isMagicErasing) {
        // 매직 이레이저: 마스크에 빨간색으로 표시
        // 마스크 캔버스에 그리기
        maskCtx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
        maskCtx.lineWidth = brushSize;
        maskCtx.lineCap = 'round';
        maskCtx.lineJoin = 'round';

        maskCtx.beginPath();
        maskCtx.moveTo(lastX, lastY);
        maskCtx.lineTo(e.offsetX, e.offsetY);
        maskCtx.stroke();

        // 캔버스에도 표시 (사용자에게 보여주기 위해)
        ctx.save();
        ctx.globalAlpha = 0.5;
        ctx.strokeStyle = 'red';
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        ctx.restore();
      }

      [lastX, lastY] = [e.offsetX, e.offsetY];
    }

    // 드로잉 중지
    function stopDrawing() {
      isDrawing = false;
      if (isErasing) {
        ctx.globalCompositeOperation = 'source-over'; // 일반 모드로 복귀
      }
    }

    // 매직 이레이저 적용 (OpenCV Inpainting API 사용)
    async function applyMagicEraser() {
      if (!isMagicErasing || !maskCanvas) {
        alert('매직 이레이저 모드를 활성화하고 제거할 영역을 드래그하세요.');
        return;
      }

      if (!confirm('선택한 영역을 AI로 자연스럽게 채우시겠습니까?')) {
        return;
      }

      showAlert('AI 매직 이레이저 처리 중... (5-10초 소요)', 'success');

      try {
        // 원본 이미지를 Base64로 변환
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(originalImageData, 0, 0);
        const imageBase64 = tempCanvas.toDataURL('image/png');

        // 마스크를 Base64로 변환
        const maskBase64 = maskCanvas.toDataURL('image/png');

        console.log('[Magic Eraser] API 호출 시작...');

        // API 호출
        const response = await fetch('/api/magic-erase', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image: imageBase64,
            mask: maskBase64,
            method: 'telea' // 'telea' (빠름) 또는 'ns' (느리지만 더 자연스러움)
          })
        });

        if (!response.ok) {
          throw new Error('매직 이레이저 API 호출 실패');
        }

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || '처리 실패');
        }

        console.log('[Magic Eraser] 성공!');

        // 결과 이미지 로드
        const resultImg = new Image();
        resultImg.onload = () => {
          canvas.width = resultImg.width;
          canvas.height = resultImg.height;
          ctx.drawImage(resultImg, 0, 0);

          // 새로운 originalImageData 저장
          originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          // 마스크 초기화
          maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);

          showAlert('AI 매직 이레이저 완료!', 'success');
        };
        resultImg.onerror = () => {
          showAlert('결과 이미지 로드 실패', 'error');
        };
        resultImg.src = result.result;

      } catch (error) {
        console.error('[Magic Eraser] 오류:', error);
        showAlert('매직 이레이저 처리 실패: ' + error.message, 'error');
      }
    }

    // 인페인팅 알고리즘 (간단한 버전)
    function performInpainting(imageData, maskData) {
      const data = imageData.data;
      const mask = maskData.data;
      const width = imageData.width;
      const height = imageData.height;

      // 마스크된 픽셀 찾기
      const maskedPixels = [];
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const i = (y * width + x) * 4;
          if (mask[i] > 0) { // 빨간색 마스크
            maskedPixels.push({ x, y, i });
          }
        }
      }

      // 각 마스크된 픽셀을 주변 픽셀의 평균으로 채우기
      maskedPixels.forEach(pixel => {
        const neighbors = [];
        const radius = 3;

        for (let dy = -radius; dy <= radius; dy++) {
          for (let dx = -radius; dx <= radius; dx++) {
            const nx = pixel.x + dx;
            const ny = pixel.y + dy;

            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
              const ni = (ny * width + nx) * 4;

              // 마스크되지 않은 픽셀만 사용
              if (mask[ni] === 0) {
                neighbors.push({
                  r: data[ni],
                  g: data[ni + 1],
                  b: data[ni + 2]
                });
              }
            }
          }
        }

        // 평균 계산
        if (neighbors.length > 0) {
          const avgR = neighbors.reduce((sum, p) => sum + p.r, 0) / neighbors.length;
          const avgG = neighbors.reduce((sum, p) => sum + p.g, 0) / neighbors.length;
          const avgB = neighbors.reduce((sum, p) => sum + p.b, 0) / neighbors.length;

          data[pixel.i] = avgR;
          data[pixel.i + 1] = avgG;
          data[pixel.i + 2] = avgB;
          data[pixel.i + 3] = 255; // 불투명
        }
      });

      // 여러 번 반복해서 더 자연스럽게
      for (let iter = 0; iter < 3; iter++) {
        maskedPixels.forEach(pixel => {
          const neighbors = [];
          const radius = 2;

          for (let dy = -radius; dy <= radius; dy++) {
            for (let dx = -radius; dx <= radius; dx++) {
              if (dx === 0 && dy === 0) continue;

              const nx = pixel.x + dx;
              const ny = pixel.y + dy;

              if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                const ni = (ny * width + nx) * 4;
                neighbors.push({
                  r: data[ni],
                  g: data[ni + 1],
                  b: data[ni + 2]
                });
              }
            }
          }

          if (neighbors.length > 0) {
            const avgR = neighbors.reduce((sum, p) => sum + p.r, 0) / neighbors.length;
            const avgG = neighbors.reduce((sum, p) => sum + p.g, 0) / neighbors.length;
            const avgB = neighbors.reduce((sum, p) => sum + p.b, 0) / neighbors.length;

            data[pixel.i] = avgR;
            data[pixel.i + 1] = avgG;
            data[pixel.i + 2] = avgB;
          }
        });
      }
    }

    // 캔버스 전체 지우기
    function clearCanvas() {
      if (confirm('캔버스를 전체 지우시겠습니까?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    // 매직 브러쉬 닫기
    function closeMagicBrush() {
      document.getElementById('magicBrushModal').classList.remove('active');

      // 이벤트 리스너 제거
      canvas.onmousedown = null;
      canvas.onmousemove = null;
      canvas.onmouseup = null;
      canvas.onmouseleave = null;
      canvas.ontouchstart = null;
      canvas.ontouchmove = null;
      canvas.ontouchend = null;

      // 상태 초기화
      isErasing = false;
      isMagicErasing = false;
      isDrawing = false;
      currentEditingImage = null;
      currentEditingImageUrl = null;
      currentEditingOptionIndexes = null;
      originalImageData = null;

      // 마스크 캔버스 초기화
      if (maskCanvas) {
        maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      }

      // 캔버스 초기화
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 버튼 상태 초기화
      const eraserBtn = document.getElementById('eraserBtn');
      const magicBtn = document.getElementById('magicEraserBtn');
      if (eraserBtn) eraserBtn.classList.remove('active');
      if (magicBtn) magicBtn.classList.remove('active');
      canvas.classList.remove('eraser-mode');

      // 슬라이더 초기화
      document.getElementById('brightnessSlider').value = 0;
      document.getElementById('contrastSlider').value = 0;
      document.getElementById('brightnessValue').textContent = 0;
      document.getElementById('contrastValue').textContent = 0;
      document.getElementById('brushSizeSlider').value = 20;
      document.getElementById('brushSizeValue').textContent = 20;
      brushSize = 20;
    }

    // 배경 제거 (간단한 버전)
    function removeBackground() {
      if (!originalImageData) return;

      alert('배경 제거 기능은 추후 고급 AI 모델을 연동하여 구현 예정입니다.\n현재는 시뮬레이션 버전입니다.');

      // 실제로는 remove.bg API나 rembg 같은 도구 필요
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      // 간단한 배경 제거 시뮬레이션 (흰색 배경 제거)
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        // 밝은 색상을 투명하게
        if (r > 240 && g > 240 && b > 240) {
          data[i + 3] = 0; // 알파값을 0으로
        }
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // 크기 조정
    function resizeImage(width, height) {
      if (!currentEditingImage) return;

      canvas.width = width;
      canvas.height = height;

      ctx.drawImage(currentEditingImage, 0, 0, width, height);
      showAlert(`이미지 크기가 ${width}x${height}로 조정되었습니다.`, 'success');
    }

    // 밝기 조정
    function adjustBrightness() {
      if (!originalImageData) return;

      const brightness = parseInt(document.getElementById('brightnessSlider').value);
      document.getElementById('brightnessValue').textContent = brightness;

      const imageData = ctx.createImageData(originalImageData);
      const data = imageData.data;
      const origData = originalImageData.data;

      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, Math.max(0, origData[i] + brightness));
        data[i + 1] = Math.min(255, Math.max(0, origData[i + 1] + brightness));
        data[i + 2] = Math.min(255, Math.max(0, origData[i + 2] + brightness));
        data[i + 3] = origData[i + 3];
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // 대비 조정
    function adjustContrast() {
      if (!originalImageData) return;

      const contrast = parseInt(document.getElementById('contrastSlider').value);
      document.getElementById('contrastValue').textContent = contrast;

      const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

      const imageData = ctx.createImageData(originalImageData);
      const data = imageData.data;
      const origData = originalImageData.data;

      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, Math.max(0, factor * (origData[i] - 128) + 128));
        data[i + 1] = Math.min(255, Math.max(0, factor * (origData[i + 1] - 128) + 128));
        data[i + 2] = Math.min(255, Math.max(0, factor * (origData[i + 2] - 128) + 128));
        data[i + 3] = origData[i + 3];
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // 필터 적용
    function applyFilter(filterType) {
      if (!originalImageData) return;

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      switch (filterType) {
        case 'grayscale':
          for (let i = 0; i < data.length; i += 4) {
            const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = data[i + 1] = data[i + 2] = gray;
          }
          break;
        case 'sepia':
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i + 1], b = data[i + 2];
            data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
            data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
            data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
          }
          break;
      }

      ctx.putImageData(imageData, 0, 0);
      showAlert(`${filterType} 필터가 적용되었습니다.`, 'success');
    }

    // 이미지 초기화
    function resetImage() {
      if (!originalImageData) return;
      ctx.putImageData(originalImageData, 0, 0);
      document.getElementById('brightnessSlider').value = 0;
      document.getElementById('contrastSlider').value = 0;
      document.getElementById('brightnessValue').textContent = 0;
      document.getElementById('contrastValue').textContent = 0;
    }

    // 편집된 이미지 저장
    function saveEditedImage() {
      if (!currentEditingImageUrl) {
        showAlert('저장할 이미지가 없습니다.', 'error');
        return;
      }

      // 편집된 이미지를 Base64로 변환
      const editedImageDataURL = canvas.toDataURL('image/png');

      // 원본 이미지 URL과 같은 imageLink를 가진 모든 옵션 찾아서 업데이트
      let updateCount = 0;
      productData.results.forEach(option => {
        if (option.imageLink === currentEditingImageUrl) {
          option.imageLink = editedImageDataURL;
          updateCount++;
        }
      });

      // mainImage도 같은 URL이면 업데이트
      if (productData.mainImage === currentEditingImageUrl) {
        productData.mainImage = editedImageDataURL;
        document.getElementById('mainImagePreview').src = editedImageDataURL;
      }

      // images 배열도 확인
      if (productData.images && productData.images.length > 0) {
        productData.images = productData.images.map(img =>
          img === currentEditingImageUrl ? editedImageDataURL : img
        );

        // 추가 이미지 그리드 다시 렌더링
        const additionalGrid = document.getElementById('additionalImagesGrid');
        additionalGrid.innerHTML = '';
        productData.images.forEach(img => {
          const imgEl = document.createElement('img');
          imgEl.src = img;
          imgEl.onclick = () => openMagicBrush(img);
          imgEl.onerror = function() { this.style.display = 'none'; };
          additionalGrid.appendChild(imgEl);
        });
      }

      // 옵션 테이블 다시 렌더링
      renderOptions();

      // 모달 닫기
      closeMagicBrush();

      showAlert(`${updateCount}개 옵션의 이미지가 업데이트되었습니다. 변경사항을 저장하려면 상단의 "저장" 버튼을 클릭하세요.`, 'success');
    }

    // detailPageItems를 HTML 문자열로 변환
    function generateDetailPageHtml(items) {
      if (!items || items.length === 0) {
        return '';
      }

      let html = '<div style="max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif;">\n';

      items.forEach(item => {
        if (item.type === 'brand-image') {
          html += `  <img src="${item.imageSrc}" style="width: 100%; margin-bottom: 0;">\n`;
        }
        else if (item.type === 'title') {
          const text = item.text || '제품명';
          const fontSize = item.fontSize || '18';
          const color = item.color || '#000000';
          const align = item.align || 'left';
          const font = item.font || 'system-ui';
          const fontWeight = item.fontWeight || 'bold';
          const borderStyle = item.borderStyle || 'none';

          let borderCss = 'none';
          let borderRadius = '0';
          let borderLeft = '';

          switch(borderStyle) {
            case 'thin': borderCss = '1px solid #e5e8eb'; break;
            case 'box': borderCss = '2px solid #333'; break;
            case 'rounded': borderCss = '2px solid #1e90ff'; borderRadius = '12px'; break;
            case 'left-accent': borderCss = '1px solid #e5e8eb'; borderLeft = 'border-left: 4px solid #1e90ff;'; break;
          }

          html += `  <div style="font-size: ${fontSize}px; font-weight: ${fontWeight}; font-family: ${font}; color: ${color}; text-align: ${align}; padding: 30px 20px; line-height: 1.6; border: ${borderCss}; border-radius: ${borderRadius}; ${borderLeft} margin: 10px 0;">\n`;
          html += `    ${text}\n`;
          html += `  </div>\n`;
        }
        else if (item.type === 'image') {
          const layout = item.layout || 'presentation';

          if (layout === 'presentation') {
            const align = item.align || 'center';
            const justifyContent = align === 'left' ? 'flex-start' : align === 'right' ? 'flex-end' : 'center';
            const maxWidth = align === 'center' ? '100%' : '50%';

            html += `  <div style="display: flex; justify-content: ${justifyContent}; margin: 20px 0; padding: 0 20px;">\n`;
            html += `    <img src="${item.imageSrc}" style="max-width: ${maxWidth}; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">\n`;
            html += `  </div>\n`;
          }
        }
        else if (item.type === 'text') {
          const text = item.text || '';
          html += `  <div style="padding: 20px; font-size: 15px; line-height: 1.8; color: #666;">\n`;
          html += `    ${text}\n`;
          html += `  </div>\n`;
        }
        else if (item.type === 'custom-text' && item.text) {
          const text = item.text;
          const defaultFontSizes = { 'title': '24', 'subtitle': '18', 'paragraph': '14' };
          const defaultFontWeights = { 'title': 'bold', 'subtitle': 'bold', 'paragraph': 'normal' };

          const fontSize = item.fontSize || defaultFontSizes[item.textType] || '14';
          const fontWeight = item.fontWeight || defaultFontWeights[item.textType] || 'normal';
          const color = item.color || '#000000';
          const align = item.align || 'left';
          const font = item.font || 'system-ui';
          const borderStyle = item.borderStyle || 'none';

          let borderCss = 'none';
          let borderRadius = '0';
          let borderLeft = '';

          switch(borderStyle) {
            case 'thin': borderCss = '1px solid #e5e8eb'; break;
            case 'box': borderCss = '2px solid #333'; break;
            case 'rounded': borderCss = '2px solid #1e90ff'; borderRadius = '12px'; break;
            case 'left-accent': borderCss = '1px solid #e5e8eb'; borderLeft = 'border-left: 4px solid #1e90ff;'; break;
          }

          html += `  <div style="font-size: ${fontSize}px; font-weight: ${fontWeight}; font-family: ${font}; color: ${color}; text-align: ${align}; padding: 15px 20px; line-height: 1.6; border: ${borderCss}; border-radius: ${borderRadius}; ${borderLeft} margin: 10px 0; white-space: pre-wrap;">\n`;
          html += `    ${text}\n`;
          html += `  </div>\n`;
        }
        else if (item.type === 'quality-table') {
          const title = item.title || '품질 정보';
          html += `  <div style="margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">\n`;
          html += `    <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">${title}</h3>\n`;
          html += `    <table style="width: 100%; border-collapse: collapse;">\n`;

          if (item.rows && item.rows.length > 0) {
            item.rows.forEach(row => {
              html += `      <tr style="border-bottom: 1px solid #e0e0e0;">\n`;
              html += `        <td style="padding: 12px; font-weight: 600; color: #555; width: 30%;">${row.label || ''}</td>\n`;
              html += `        <td style="padding: 12px; color: #666;">${row.value || ''}</td>\n`;
              html += `      </tr>\n`;
            });
          }

          html += `    </table>\n`;
          html += `  </div>\n`;
        }
        else if (item.type === 'option-block') {
          const imageSrc = item.imageSrc || '';
          const optionName = item.optionName || '';
          const option2List = item.option2List || '';
          const template = item.template || 'horizontal';

          // 템플릿에 따른 스타일 설정
          let containerStyle = '';
          let imageContainerStyle = '';
          let textContainerStyle = '';
          let titleStyle = '';
          let listStyle = '';

          switch (template) {
            case 'gradient':
              containerStyle = 'margin: 20px 0; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; gap: 30px;';
              imageContainerStyle = 'flex: 0 0 300px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'flex: 1; color: #fff;';
              titleStyle = 'font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #fff;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: rgba(255, 255, 255, 0.9);';
              break;

            case 'modern':
              containerStyle = 'margin: 20px 0; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; gap: 30px;';
              imageContainerStyle = 'flex: 0 0 300px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'flex: 1; color: #fff;';
              titleStyle = 'font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #fff;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: rgba(255, 255, 255, 0.9);';
              break;

            case 'neon':
              containerStyle = 'margin: 20px 0; padding: 30px; background: linear-gradient(135deg, #ff0080 0%, #ff8c00 100%); border-radius: 12px; display: flex; align-items: center; gap: 30px;';
              imageContainerStyle = 'flex: 0 0 300px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'flex: 1; color: #fff;';
              titleStyle = 'font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #fff;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: rgba(255, 255, 255, 0.9);';
              break;

            case 'ocean':
              containerStyle = 'margin: 20px 0; padding: 30px; background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); border-radius: 12px; display: flex; align-items: center; gap: 30px;';
              imageContainerStyle = 'flex: 0 0 300px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'flex: 1; color: #fff;';
              titleStyle = 'font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #fff;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: rgba(255, 255, 255, 0.9);';
              break;

            case 'vertical':
              containerStyle = 'margin: 20px 0; padding: 30px; background: #f9f9f9; border-radius: 12px;';
              imageContainerStyle = 'margin-bottom: 20px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'text-align: center;';
              titleStyle = 'font-size: 22px; font-weight: 700; margin-bottom: 15px; color: #333;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: #666;';
              break;

            case 'card':
              containerStyle = 'margin: 20px 0; padding: 25px; background: #fff; border: 2px solid #e5e8eb; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); display: flex; align-items: center; gap: 25px;';
              imageContainerStyle = 'flex: 0 0 280px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'flex: 1;';
              titleStyle = 'font-size: 22px; font-weight: 700; margin-bottom: 15px; color: #333;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: #666;';
              break;

            default: // horizontal
              containerStyle = 'margin: 20px 0; padding: 25px; background: #f9f9f9; border-radius: 12px; display: flex; align-items: center; gap: 25px;';
              imageContainerStyle = 'flex: 0 0 280px; border-radius: 8px; overflow: hidden;';
              textContainerStyle = 'flex: 1;';
              titleStyle = 'font-size: 22px; font-weight: 700; margin-bottom: 15px; color: #333;';
              listStyle = 'font-size: 14px; line-height: 1.8; color: #666;';
          }

          html += `  <div style="${containerStyle}">\n`;

          // 이미지
          if (imageSrc) {
            html += `    <div style="${imageContainerStyle}">\n`;
            html += `      <img src="${imageSrc}" style="width: 100%; height: auto; display: block;">\n`;
            html += `    </div>\n`;
          }

          // 텍스트 영역
          html += `    <div style="${textContainerStyle}">\n`;
          html += `      <h3 style="${titleStyle}">${optionName}</h3>\n`;

          // 옵션2 목록을 쉼표로 분리해서 리스트로 표시
          if (option2List) {
            const options = option2List.split(',').map(opt => opt.trim()).filter(opt => opt);
            if (options.length > 0) {
              html += `      <div style="${listStyle}">\n`;
              options.forEach(opt => {
                html += `        • ${opt}<br>\n`;
              });
              html += `      </div>\n`;
            }
          }

          html += `    </div>\n`;
          html += `  </div>\n`;
        }
      });

      html += '</div>\n';
      return html;
    }

    // 상품 저장
    async function saveProduct() {
      productData.title = document.getElementById('productTitle').value;

      if (!productData.title && !productData.titleCn) {
        showAlert('상품명을 입력하세요.', 'error');
        return;
      }

      // detailPageItems를 저장 (편집기 상태 유지용)
      productData.detailPageItems = detailPageItems;

      // 선택된 추가 이미지 저장 (견적서용)
      productData.selectedAdditionalImages = Array.from(selectedAdditionalImages);

      // 편집 완료 상태 표시
      productData.isEdited = true;

      // detailPageItems를 HTML로 변환해서 productData.detailHtml에 저장 (이미지 생성용)
      if (detailPageItems && detailPageItems.length > 0) {
        productData.detailHtml = generateDetailPageHtml(detailPageItems);
        console.log('[Save] detailPageItems 저장 (' + detailPageItems.length + '개) 및 HTML 생성 완료 (' + productData.detailHtml.length + '자)');
      } else {
        console.log('[Save] detailPageItems가 비어있음, detailHtml 유지');
      }

      try {
        const url = productId ? `/api/products/${productId}` : '/api/products/save';
        const method = productId ? 'PUT' : 'POST';

        const response = await authFetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });

        if (!response.ok) {
          if (response.status === 413) {
            const sizeKB = Math.round(JSON.stringify(productData).length / 1024);
            throw new Error(`데이터 용량이 너무 큽니다 (${sizeKB}KB). 이미지를 줄이거나 상세페이지 내용을 간소화해주세요.`);
          }
          throw new Error('저장 실패');
        }

        const data = await response.json();
        productId = data.id || data.product.id;

        showAlert('상품이 저장되었습니다.', 'success');

        if (!window.location.search.includes('id=')) {
          window.history.pushState({}, '', `?id=${productId}`);
        }
      } catch (error) {
        console.error('저장 오류:', error);
        showAlert(error.message || '상품 저장에 실패했습니다.', 'error');
      }
    }

    // 알림 표시
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // 배경 제거 모달에서 선택된 이미지 인덱스
    let selectedBgRemoveImages = new Set();
    let bgRemoveImageType = '';
    let bgRemoveImageList = [];

    // 배경 제거 모달 열기
    function openBackgroundRemovalModal(imageType) {
      bgRemoveImageType = imageType;
      selectedBgRemoveImages.clear();
      bgRemoveImageList = [];

      // 이미지 타입에 따라 이미지 목록 가져오기
      if (imageType === 'additional') {
        bgRemoveImageList = [productData.mainImage, ...(productData.images || [])].filter(Boolean);
      } else if (imageType === 'option') {
        const uniqueOptionImages = new Set();
        productData.results.forEach(option => {
          const imgSrc = option.imageLink || option.titleImage?.[0] || '';
          if (imgSrc) uniqueOptionImages.add(imgSrc);
        });
        bgRemoveImageList = Array.from(uniqueOptionImages);
      }

      if (bgRemoveImageList.length === 0) {
        showAlert('처리할 이미지가 없습니다.', 'error');
        return;
      }

      // 모달 HTML
      const modalHTML = `
        <div id="bg-remove-modal" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        ">
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          ">
            <!-- 헤더 -->
            <div style="
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              padding: 24px 32px;
              border-radius: 16px 16px 0 0;
            ">
              <h2 style="margin: 0; font-size: 24px;">✂️ 배경 제거 (누끼)</h2>
              <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">
                이미지 배경을 자동으로 제거합니다
              </p>
            </div>

            <!-- 본문 -->
            <div style="padding: 32px;">
              <!-- 이미지 선택 -->
              <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <label style="font-weight: 600; color: #333;">
                    배경을 제거할 이미지 선택 (클릭하여 선택)
                  </label>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="selectAllBgRemoveImages()" style="font-size: 12px; padding: 6px 12px;">
                      전체 선택
                    </button>
                    <button class="btn btn-secondary" onclick="deselectAllBgRemoveImages()" style="font-size: 12px; padding: 6px 12px;">
                      선택 해제
                    </button>
                  </div>
                </div>
                <div id="bg-remove-images-grid" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                  gap: 12px;
                ">
                  ${bgRemoveImageList.map((img, idx) => `
                    <div class="bg-remove-image-item" data-index="${idx}" onclick="toggleBgRemoveImageSelection(${idx})" style="
                      position: relative;
                      cursor: pointer;
                      border-radius: 8px;
                      overflow: hidden;
                      border: 3px solid #e1e5e9;
                      transition: all 0.2s;
                    ">
                      <img src="${img}" style="
                        width: 100%;
                        aspect-ratio: 1;
                        object-fit: cover;
                        display: block;
                      ">
                      <div class="bg-check-mark" style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        width: 24px;
                        height: 24px;
                        background: #28a745;
                        color: white;
                        border-radius: 50%;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                      ">✓</div>
                    </div>
                  `).join('')}
                </div>
                <div id="bg-remove-selected-count" style="margin-top: 12px; color: #666; font-size: 14px;">
                  선택된 이미지: 0개
                </div>
              </div>

              <!-- 버튼 -->
              <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeBgRemoveModal()" style="padding: 12px 24px;">
                  취소
                </button>
                <button id="bg-remove-execute-btn" class="btn" onclick="executeBgRemove()" style="
                  padding: 12px 24px;
                  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                  color: white;
                  font-weight: 600;
                ">
                  ✂️ 배경 제거 실행
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // 배경 제거 이미지 선택 토글
    function toggleBgRemoveImageSelection(index) {
      if (selectedBgRemoveImages.has(index)) {
        selectedBgRemoveImages.delete(index);
      } else {
        selectedBgRemoveImages.add(index);
      }
      updateBgRemoveSelectionUI();
    }

    // 전체 선택
    function selectAllBgRemoveImages() {
      bgRemoveImageList.forEach((_, idx) => selectedBgRemoveImages.add(idx));
      updateBgRemoveSelectionUI();
    }

    // 전체 해제
    function deselectAllBgRemoveImages() {
      selectedBgRemoveImages.clear();
      updateBgRemoveSelectionUI();
    }

    // UI 업데이트
    function updateBgRemoveSelectionUI() {
      document.querySelectorAll('.bg-remove-image-item').forEach((item, idx) => {
        const checkMark = item.querySelector('.bg-check-mark');
        if (selectedBgRemoveImages.has(idx)) {
          item.style.borderColor = '#28a745';
          item.style.boxShadow = '0 0 0 3px rgba(40,167,69,0.2)';
          checkMark.style.display = 'flex';
        } else {
          item.style.borderColor = '#e1e5e9';
          item.style.boxShadow = 'none';
          checkMark.style.display = 'none';
        }
      });
      document.getElementById('bg-remove-selected-count').textContent =
        `선택된 이미지: ${selectedBgRemoveImages.size}개`;
    }

    // 모달 닫기
    function closeBgRemoveModal() {
      const modal = document.getElementById('bg-remove-modal');
      if (modal) modal.remove();
    }

    // 배경 제거 실행
    async function executeBgRemove() {
      if (selectedBgRemoveImages.size === 0) {
        showAlert('배경을 제거할 이미지를 선택해주세요.', 'warning');
        return;
      }

      // 버튼 비활성화
      const executeBtn = document.getElementById('bg-remove-execute-btn');
      executeBtn.disabled = true;
      executeBtn.textContent = '처리 중...';

      // 선택된 이미지들 처리 정보 준비
      let imagesToProcess = [];

      if (bgRemoveImageType === 'additional') {
        const allImages = [productData.mainImage, ...(productData.images || [])].filter(Boolean);
        selectedBgRemoveImages.forEach(idx => {
          const imgUrl = bgRemoveImageList[idx];
          const realIndex = allImages.indexOf(imgUrl);
          if (realIndex !== -1) {
            imagesToProcess.push({ url: imgUrl, index: realIndex, isMain: realIndex === 0 });
          }
        });
      } else if (bgRemoveImageType === 'option') {
        selectedBgRemoveImages.forEach(idx => {
          const imgUrl = bgRemoveImageList[idx];
          const indices = [];
          productData.results.forEach((option, optIdx) => {
            const optImg = option.imageLink || option.titleImage?.[0] || '';
            if (optImg === imgUrl) indices.push(optIdx);
          });
          if (indices.length > 0) {
            imagesToProcess.push({ url: imgUrl, indices: indices });
          }
        });
      }

      // 모달 내 진행 상태 표시로 변경
      const modalContent = document.querySelector('#bg-remove-modal > div > div:last-child');
      modalContent.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <h3 style="margin: 0 0 20px 0;">✂️ 배경 제거 중...</h3>
          <div id="bg-remove-status" style="margin-bottom: 15px; color: #666;">준비 중...</div>
          <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
            <div id="bg-remove-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s;"></div>
          </div>
          <div id="bg-remove-count" style="margin-top: 10px; font-size: 14px; color: #888;">0 / ${imagesToProcess.length}</div>
        </div>
      `;

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < imagesToProcess.length; i++) {
        const item = imagesToProcess[i];
        const statusEl = document.getElementById('bg-remove-status');
        const barEl = document.getElementById('bg-remove-bar');
        const countEl = document.getElementById('bg-remove-count');

        statusEl.textContent = `처리 중: ${i + 1}번째 이미지...`;
        barEl.style.width = `${((i + 1) / imagesToProcess.length) * 100}%`;
        countEl.textContent = `${i + 1} / ${imagesToProcess.length}`;

        try {
          const imageBase64 = await imageUrlToBase64(item.url);
          if (!imageBase64) {
            console.error('[배경제거] 이미지 로드 실패:', item.url);
            failCount++;
            continue;
          }

          const response = await authFetch('/api/remove-background', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageBase64: imageBase64 })
          });

          const result = await response.json();

          if (result.success && result.result) {
            // base64 이미지를 서버에 업로드하여 URL로 변환
            let imageUrl = result.result;
            try {
              const uploadResp = await authFetch('/api/upload/image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: result.result })
              });
              const uploadResult = await uploadResp.json();
              if (uploadResult.success && uploadResult.url) {
                // 상대경로를 절대경로로 변환
                imageUrl = window.location.origin + uploadResult.url;
                console.log('[배경제거] 이미지 업로드 완료:', imageUrl);
              }
            } catch (uploadErr) {
              console.warn('[배경제거] 이미지 업로드 실패, base64 사용:', uploadErr);
            }

            if (bgRemoveImageType === 'additional') {
              if (item.isMain) {
                productData.mainImage = imageUrl;
              } else {
                const imgIndex = item.index - 1;
                if (imgIndex >= 0 && productData.images) {
                  productData.images[imgIndex] = imageUrl;
                }
              }
            } else if (bgRemoveImageType === 'option') {
              item.indices.forEach(idx => {
                if (productData.results[idx].imageLink) {
                  productData.results[idx].imageLink = imageUrl;
                }
                if (productData.results[idx].titleImage) {
                  productData.results[idx].titleImage[0] = imageUrl;
                }
              });
            }
            successCount++;
          } else {
            console.error('[배경제거] API 실패:', result.message);
            failCount++;
          }
        } catch (error) {
          console.error('[배경제거] 오류:', error);
          failCount++;
        }
      }

      // 모달 닫기
      closeBgRemoveModal();

      // 상세페이지 detailPageItems의 이미지도 업데이트
      // 처리된 이미지 URL 매핑 생성 (oldUrl -> newUrl)
      const imageUpdateMap = new Map();

      // 상세페이지 자동 동기화
      if (bgRemoveImageType === 'option') {
        // 옵션 이미지 편집 후 자동 동기화
        syncOptionImagesToDetailPage();
      } else if (bgRemoveImageType === 'additional') {
        // 추가 이미지는 URL 매칭으로 업데이트
        imagesToProcess.forEach(item => {
          const oldUrl = item.url;
          let newUrl;
          if (item.isMain) {
            newUrl = productData.mainImage;
          } else {
            const imgIndex = item.index - 1;
            newUrl = productData.images?.[imgIndex];
          }

          if (newUrl && newUrl !== oldUrl) {
            detailPageItems.forEach(block => {
              if ((block.type === 'image' || block.type === 'brand-image') && block.imageSrc === oldUrl) {
                block.imageSrc = newUrl;
              }
            });
          }
        });
        renderDetailCanvas();
      }

      // UI 갱신
      refreshImageTabs();           // 이미지 탭 새로고침
      renderDetailSources();        // 상세페이지 소스 이미지 새로고침
      scheduleAutoSave();

      // 결과 알림
      if (failCount === 0) {
        showAlert(`✅ ${successCount}개 이미지 배경 제거 완료!`, 'success');
      } else {
        showAlert(`⚠️ 완료: ${successCount}개 성공, ${failCount}개 실패`, 'warning');
      }
    }

    // 이미지 URL을 Base64로 변환
    async function imageUrlToBase64(url) {
      // Data URL인 경우 그대로 반환
      if (url.startsWith('data:')) {
        return url;
      }

      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          try {
            const dataURL = canvas.toDataURL('image/png');
            resolve(dataURL);
          } catch (e) {
            console.error('[Base64 변환] 오류:', e);
            resolve(null);
          }
        };
        img.onerror = function() {
          console.error('[Base64 변환] 이미지 로드 실패:', url);
          resolve(null);
        };
        img.src = url;
      });
    }

    // AI 이미지 편집 모달 열기
    async function openAIImageEditor(imageType) {
      // 이미지 타입에 따라 다른 이미지 목록 가져오기
      let imagesToEdit = [];

      if (imageType === 'additional') {
        // 추가 이미지들
        imagesToEdit = productData.images || [];
      } else if (imageType === 'option') {
        // 옵션 이미지들 (유니크 값만)
        const uniqueOptionImages = new Set();
        productData.results.forEach(option => {
          const imgSrc = option.imageLink || option.titleImage?.[0] || '';
          if (imgSrc) {
            uniqueOptionImages.add(imgSrc);
          }
        });
        imagesToEdit = Array.from(uniqueOptionImages);
      }

      if (imagesToEdit.length === 0) {
        showAlert('편집할 이미지가 없습니다.', 'error');
        return;
      }

      // AI 이미지 편집 모달 HTML
      const modalHTML = `
        <div id="ai-image-modal" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        ">
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          ">
            <!-- 헤더 -->
            <div style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 24px 32px;
              border-radius: 16px 16px 0 0;
            ">
              <h2 style="margin: 0; font-size: 24px;">🎨 AI 이미지 편집</h2>
              <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">
                Gemini AI로 이미지를 자동으로 편집합니다
              </p>
            </div>

            <!-- 본문 -->
            <div style="padding: 32px;">
              <!-- 프롬프트 섹션 -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                  AI 프롬프트
                </label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                  <button class="btn btn-secondary" onclick="setAIPrompt('remove the background')" style="font-size: 12px; padding: 6px 12px;">배경 제거</button>
                  <button class="btn btn-secondary" onclick="setAIPrompt('make the product image more professional and clean')" style="font-size: 12px; padding: 6px 12px;">전문적으로</button>
                  <button class="btn btn-secondary" onclick="setAIPrompt('enhance the lighting and colors')" style="font-size: 12px; padding: 6px 12px;">색상 개선</button>
                  <button class="btn btn-secondary" onclick="setAIPrompt('center the product and add white background')" style="font-size: 12px; padding: 6px 12px;">중앙 정렬 + 흰 배경</button>
                </div>
                <textarea id="ai-prompt-input" style="
                  width: 100%;
                  padding: 12px;
                  border: 2px solid #e1e5e9;
                  border-radius: 8px;
                  font-size: 14px;
                  min-height: 80px;
                  resize: vertical;
                " placeholder="AI에게 어떻게 이미지를 편집하길 원하는지 설명하세요...">remove the background and make it professional for e-commerce</textarea>
              </div>

              <!-- 이미지 선택 -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #333;">
                  편집할 이미지 선택 (클릭하여 선택)
                </label>
                <div id="ai-images-grid" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                  gap: 12px;
                ">
                  ${imagesToEdit.map((img, idx) => `
                    <div class="ai-image-item" data-index="${idx}" onclick="toggleAIImageSelection(${idx})" style="
                      position: relative;
                      cursor: pointer;
                      border-radius: 8px;
                      overflow: hidden;
                      border: 3px solid #e1e5e9;
                      transition: all 0.2s;
                    ">
                      <img src="${img}" style="
                        width: 100%;
                        aspect-ratio: 1;
                        object-fit: cover;
                        display: block;
                      ">
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- 진행 상황 -->
              <div id="ai-progress" style="display: none; margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-weight: 600; margin-bottom: 8px;">진행 중...</div>
                <div id="ai-progress-text" style="color: #666; font-size: 14px;">준비 중...</div>
              </div>

              <!-- 버튼 -->
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeAIImageModal()">취소</button>
                <button class="btn btn-primary" onclick="startAIImageGeneration('${imageType}')">
                  선택한 이미지 AI 편집 시작
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // 모달 추가
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // AI 이미지 모달 닫기
    function closeAIImageModal() {
      const modal = document.getElementById('ai-image-modal');
      if (modal) {
        modal.remove();
      }
      selectedAIImages.clear();
    }

    // AI 프롬프트 설정
    function setAIPrompt(text) {
      document.getElementById('ai-prompt-input').value = text;
    }

    // 선택된 AI 이미지 추적
    let selectedAIImages = new Set();

    // AI 이미지 선택 토글
    function toggleAIImageSelection(index) {
      const item = document.querySelector(`.ai-image-item[data-index="${index}"]`);

      if (selectedAIImages.has(index)) {
        selectedAIImages.delete(index);
        item.style.borderColor = '#e1e5e9';
        item.style.boxShadow = 'none';
      } else {
        selectedAIImages.add(index);
        item.style.borderColor = '#4CAF50';
        item.style.boxShadow = '0 0 0 3px rgba(76, 175, 80, 0.2)';
      }
    }

    // AI 이미지 생성 시작
    async function startAIImageGeneration(imageType) {
      if (selectedAIImages.size === 0) {
        showAlert('최소 1개 이상의 이미지를 선택해주세요.', 'error');
        return;
      }

      const prompt = document.getElementById('ai-prompt-input').value.trim();
      if (!prompt) {
        showAlert('프롬프트를 입력해주세요.', 'error');
        return;
      }

      // 진행 상황 표시
      const progressDiv = document.getElementById('ai-progress');
      const progressText = document.getElementById('ai-progress-text');
      progressDiv.style.display = 'block';

      let imagesToEdit = [];
      if (imageType === 'additional') {
        imagesToEdit = productData.images || [];
      } else if (imageType === 'option') {
        const uniqueOptionImages = new Set();
        productData.results.forEach(option => {
          const imgSrc = option.imageLink || option.titleImage?.[0] || '';
          if (imgSrc) {
            uniqueOptionImages.add(imgSrc);
          }
        });
        imagesToEdit = Array.from(uniqueOptionImages);
      }

      let successCount = 0;
      let failCount = 0;

      for (const index of selectedAIImages) {
        try {
          const imageUrl = imagesToEdit[index];
          progressText.textContent = `처리 중: ${successCount + failCount + 1}/${selectedAIImages.size}`;

          // 이미지를 Base64로 변환
          const imageData = await imageUrlToBase64(imageUrl);

          // Gemini API 호출
          const response = await fetch('/api/gemini/generate-image', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              imageData,
              prompt,
              productName: productData.title
            })
          });

          const result = await response.json();

          if (result.success) {
            // base64 이미지를 서버에 업로드하여 URL로 변환
            let imageUrl = result.imageData;
            try {
              const uploadResp = await fetch('/api/upload/image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: result.imageData })
              });
              const uploadResult = await uploadResp.json();
              if (uploadResult.success && uploadResult.url) {
                imageUrl = window.location.origin + uploadResult.url;
                console.log('[AI 이미지] 이미지 업로드 완료:', imageUrl);
              }
            } catch (uploadErr) {
              console.warn('[AI 이미지] 이미지 업로드 실패, base64 사용:', uploadErr);
            }

            // 생성된 이미지로 교체
            if (imageType === 'additional') {
              productData.images[index] = imageUrl;
            } else if (imageType === 'option') {
              // 옵션 이미지 업데이트
              const oldUrl = imagesToEdit[index];
              productData.results.forEach(option => {
                const optionImgSrc = option.imageLink || option.titleImage?.[0] || '';
                if (optionImgSrc === oldUrl) {
                  if (option.imageLink) {
                    option.imageLink = imageUrl;
                  } else if (option.titleImage && option.titleImage.length > 0) {
                    option.titleImage[0] = imageUrl;
                  }
                }
              });
            }
            successCount++;
          } else {
            failCount++;
            console.error(`이미지 ${index + 1} 생성 실패:`, result.message);
          }

        } catch (error) {
          failCount++;
          console.error(`이미지 ${index + 1} 처리 중 오류:`, error);
        }
      }

      // 완료
      progressDiv.style.display = 'none';
      closeAIImageModal();

      showAlert(
        `AI 이미지 편집 완료! 성공: ${successCount}개, 실패: ${failCount}개`,
        failCount === 0 ? 'success' : 'warning'
      );

      // 화면 새로고침
      if (successCount > 0) {
        // 이미지 탭 다시 렌더링
        refreshImageTabs();
      }
    }

    // 이미지 탭 새로고침
    function refreshImageTabs() {
      // 추가 이미지 탭 새로고침
      const additionalGridTab = document.getElementById('additionalImagesGridTab');
      additionalGridTab.innerHTML = '';

      const allImages = [];
      if (productData.mainImage) {
        allImages.push(productData.mainImage);
      }
      if (productData.images && productData.images.length > 0) {
        allImages.push(...productData.images);
      }

      if (allImages.length > 0) {
        allImages.forEach(img => {
          const container = document.createElement('div');
          container.className = 'image-item-container additional-image-item';
          container.setAttribute('data-additional-image', img);

          if (selectedAdditionalImages.has(img)) {
            container.classList.add('selected');
          }

          const imgElement = document.createElement('img');
          imgElement.src = img;
          imgElement.onerror = function() {
            this.parentElement.innerHTML = '<div style="padding: 20px; background: #f5f5f5; text-align: center; border-radius: 6px;">📷</div>';
          };

          const editBtn = document.createElement('button');
          editBtn.className = 'image-edit-btn';
          editBtn.textContent = '편집';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            openMagicBrush(img, null);
          };

          container.onclick = (e) => {
            if (!e.target.classList.contains('image-edit-btn')) {
              toggleAdditionalImageSelection(img, e);
            }
          };

          container.appendChild(imgElement);
          container.appendChild(editBtn);
          additionalGridTab.appendChild(container);
        });
      } else {
        additionalGridTab.innerHTML = '<p style="color: #888; padding: 20px;">추가 이미지가 없습니다.</p>';
      }

      // 옵션 이미지 탭 새로고침
      renderUniqueOptionImages();
    }

    // ========== 커스텀 AI 모달 ==========
    function openCustomAIModal() {
      document.getElementById('customAIModal').classList.add('active');
    }

    function closeCustomAIModal() {
      document.getElementById('customAIModal').classList.remove('active');
    }

    async function applyCustomAIFromModal() {
      const targetOption = document.getElementById('customAiTargetOption').value;
      const customPrompt = document.getElementById('customAiPrompt').value.trim();
      const btn = document.getElementById('customAiApplyBtn');
      const btnText = document.getElementById('customAiBtnText');

      if (!customPrompt) {
        showAlert('AI에게 전달할 프롬프트를 입력해주세요.', 'warning');
        return;
      }

      // 대상 옵션 필드 결정
      const targetFields = targetOption === 'all'
        ? ['optionName1', 'optionName2']
        : [targetOption];

      // 유니크한 옵션 값 수집 (전체 옵션인 경우 옵션1, 옵션2 모두 수집)
      const uniqueValues = [];
      const seen = new Set();

      productData.results.forEach(opt => {
        targetFields.forEach(field => {
          const value = opt[field] || '';
          if (value && !seen.has(value)) {
            uniqueValues.push(value);
            seen.add(value);
          }
        });
      });

      if (uniqueValues.length === 0) {
        showAlert('변환할 옵션 값이 없습니다.', 'warning');
        return;
      }

      // 로딩 상태
      btn.disabled = true;
      btnText.textContent = 'AI 변환 중...';

      try {
        const response = await fetch('/api/gemini/rename-options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            optionValues: uniqueValues,
            mode: 'custom',
            customPrompt: customPrompt
          })
        });

        if (!response.ok) throw new Error('AI 변환 실패');

        const data = await response.json();
        const mapping = data.mapping || {};

        // 매핑 적용
        let count = 0;
        productData.results.forEach(opt => {
          targetFields.forEach(field => {
            const currentValue = opt[field] || '';
            if (mapping[currentValue] && mapping[currentValue] !== currentValue) {
              opt[field] = mapping[currentValue];
              count++;
            }
          });
        });

        renderOptions();
        closeCustomAIModal();
        showAlert(`AI가 ${count}개 옵션을 변환했습니다.`, 'success');
        if (count > 0) {
          scheduleAutoSave();
        }
      } catch (error) {
        console.error('커스텀 AI 변환 오류:', error);
        showAlert('AI 변환에 실패했습니다. 다시 시도해주세요.', 'error');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'AI 변환 적용';
      }
    }

    // ========== AI 작명 모달 ==========
    function openAIRenameModal() {
      document.getElementById('aiRenameModal').classList.add('active');
    }

    function closeAIRenameModal() {
      document.getElementById('aiRenameModal').classList.remove('active');
    }

    async function applyAIRenameFromModal(type) {
      const targetOption = document.getElementById('aiTargetOption').value;

      // 대상 옵션 필드 결정
      const targetFields = targetOption === 'all'
        ? ['optionName1', 'optionName2']
        : [targetOption];

      // 유니크한 옵션 값 수집
      const uniqueValues = [];
      const seen = new Set();

      productData.results.forEach(opt => {
        targetFields.forEach(field => {
          const value = opt[field] || '';
          if (value && !seen.has(value)) {
            uniqueValues.push(value);
            seen.add(value);
          }
        });
      });

      if (uniqueValues.length === 0) {
        showAlert('변환할 옵션 값이 없습니다.', 'warning');
        return;
      }

      closeAIRenameModal();
      showAlert(`AI가 ${uniqueValues.length}개의 옵션을 분석중입니다...`, 'info');

      try {
        // AI API 호출
        const response = await fetch('/api/ai-rename', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            optionValues: uniqueValues,
            type: type
          })
        });

        if (!response.ok) throw new Error('AI API 호출 실패');

        const result = await response.json();
        const mapping = result.mapping || {};

        // 매핑 적용
        let count = 0;
        productData.results.forEach(opt => {
          targetFields.forEach(field => {
            const currentValue = opt[field];
            if (currentValue && mapping[currentValue]) {
              opt[field] = mapping[currentValue];
              count++;
            }
          });
        });

        renderOptions();
        renderMappingLists(); // 매핑 탭 업데이트
        showAlert(`AI가 ${count}개 옵션을 변환했습니다.`, 'success');
        if (count > 0) {
          scheduleAutoSave();
        }
      } catch (error) {
        console.error('AI 변환 오류:', error);
        showAlert('AI 변환에 실패했습니다. 다시 시도해주세요.', 'error');
      }
    }

    // ========== 매핑 리스트 렌더링 ==========
    function renderMappingLists() {
      renderSingleMappingList('optionName1', 'option1MappingList');
      renderSingleMappingList('optionName2', 'option2MappingList');
    }

    function renderSingleMappingList(fieldName, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      // 유니크한 값 추출
      const uniqueValues = [];
      const seen = new Set();

      productData.results.forEach(opt => {
        const value = opt[fieldName] || '';
        if (!seen.has(value)) {
          uniqueValues.push(value);
          seen.add(value);
        }
      });

      container.innerHTML = '';

      if (uniqueValues.length === 0) {
        container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">옵션이 없습니다</div>';
        return;
      }

      uniqueValues.forEach((value, index) => {
        const row = document.createElement('div');
        row.className = 'mapping-row';
        row.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px;';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = value;
        input.className = 'mapping-input';
        input.style.cssText = 'flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;';
        input.dataset.field = fieldName;
        input.dataset.originalValue = value;

        // Enter 또는 blur 시 적용
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.target.blur();
          }
        });

        input.addEventListener('blur', () => {
          applyMappingChange(fieldName, value, input.value);
        });

        row.appendChild(input);
        container.appendChild(row);
      });
    }

    function applyMappingChange(fieldName, originalValue, newValue) {
      if (originalValue === newValue) return;

      let count = 0;
      productData.results.forEach(opt => {
        if (opt[fieldName] === originalValue) {
          opt[fieldName] = newValue;
          count++;
        }
      });

      if (count > 0) {
        renderOptions();
        renderMappingLists(); // 매핑 리스트도 업데이트
        showAlert(`${count}개 항목이 변경되었습니다.`, 'success');
        scheduleAutoSave();
      }
    }

    // ========== 가격 수집 히스토리 ==========
    let currentHistoryId = null; // 현재 열린 히스토리 ID
    let currentHistoryData = null; // 현재 열린 히스토리 데이터

    // 히스토리 목록 로드
    async function loadPriceHistory() {
      try {
        const token = localStorage.getItem('token');
        if (!token) return;

        const response = await fetch('/api/price-history', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const result = await response.json();
        renderPriceHistoryList(result.history || []);
      } catch (error) {
        console.error('히스토리 로드 오류:', error);
      }
    }

    // 히스토리 목록 렌더링
    function renderPriceHistoryList(history) {
      const container = document.getElementById('priceHistoryList');
      if (!container) return;

      if (!history || history.length === 0) {
        container.innerHTML = '<div style="color: #888; text-align: center; padding: 30px 10px; font-size: 13px;">가격 수집 기록이 없습니다</div>';
        return;
      }

      container.innerHTML = history.map(item => {
        const date = new Date(item.createdAt);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

        return `
          <div class="history-item" onclick="openPriceHistoryDetail('${item.id}')"
               style="padding: 10px 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
               onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='transparent'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <span style="font-weight: 600; font-size: 13px; color: #333;">${item.keyword}</span>
              <span style="font-size: 11px; color: #999;">${dateStr}</span>
            </div>
            <div style="display: flex; gap: 8px; font-size: 11px; color: #666;">
              <span>최저 ${formatPrice(item.minPrice)}</span>
              <span>~</span>
              <span>최고 ${formatPrice(item.maxPrice)}</span>
              <span style="margin-left: auto;">${item.productCount}개</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // 히스토리 상세 보기
    async function openPriceHistoryDetail(historyId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/price-history/${historyId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          showAlert('히스토리를 불러올 수 없습니다.', 'error');
          return;
        }

        const result = await response.json();
        currentHistoryId = historyId;
        currentHistoryData = result.data;

        // 모달 데이터 설정
        document.getElementById('historyModalKeyword').textContent = result.data.keyword;
        document.getElementById('historyMinPrice').textContent = formatPrice(result.data.minPrice);
        document.getElementById('historyAvgPrice').textContent = formatPrice(result.data.avgPrice);
        document.getElementById('historyMidPrice').textContent = formatPrice(result.data.midPrice);
        document.getElementById('historyMaxPrice').textContent = formatPrice(result.data.maxPrice);
        document.getElementById('historyProductCount').textContent = result.data.productCount;

        const date = new Date(result.data.createdAt);
        document.getElementById('historyCreatedAt').textContent =
          `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

        // 모달 열기
        document.getElementById('priceHistoryModal').classList.add('active');
      } catch (error) {
        console.error('히스토리 상세 로드 오류:', error);
        showAlert('히스토리 로드 중 오류가 발생했습니다.', 'error');
      }
    }

    // 히스토리 모달 닫기
    function closePriceHistoryModal() {
      document.getElementById('priceHistoryModal').classList.remove('active');
      currentHistoryId = null;
      currentHistoryData = null;
    }

    // 히스토리 삭제
    async function deletePriceHistoryItem() {
      if (!currentHistoryId) return;

      if (!confirm('이 검색 기록을 삭제하시겠습니까?')) return;

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/price-history/${currentHistoryId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          showAlert('삭제에 실패했습니다.', 'error');
          return;
        }

        closePriceHistoryModal();
        loadPriceHistory();
        showAlert('히스토리가 삭제되었습니다.', 'success');
      } catch (error) {
        console.error('히스토리 삭제 오류:', error);
        showAlert('삭제 중 오류가 발생했습니다.', 'error');
      }
    }

    // 전체 히스토리 삭제
    async function clearAllPriceHistory() {
      if (!confirm('모든 검색 기록을 삭제하시겠습니까?')) return;

      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/price-history', {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          showAlert('삭제에 실패했습니다.', 'error');
          return;
        }

        loadPriceHistory();
        showAlert('모든 히스토리가 삭제되었습니다.', 'success');
      } catch (error) {
        console.error('히스토리 전체 삭제 오류:', error);
        showAlert('삭제 중 오류가 발생했습니다.', 'error');
      }
    }

    // 히스토리 데이터를 가격 수집 결과에 로드
    function loadHistoryToCollect() {
      if (!currentHistoryData) return;

      // collectedPriceData에 데이터 적용
      collectedPriceData.all = {
        status: 'success',
        min: currentHistoryData.minPrice,
        max: currentHistoryData.maxPrice,
        average: currentHistoryData.avgPrice,
        median: currentHistoryData.midPrice,
        totalItems: currentHistoryData.productCount
      };

      // UI 업데이트
      document.getElementById('allMinPrice').textContent = formatPrice(currentHistoryData.minPrice);
      document.getElementById('allAvgPrice').textContent = formatPrice(currentHistoryData.avgPrice);
      document.getElementById('allMidPrice').textContent = formatPrice(currentHistoryData.midPrice);
      document.getElementById('allMaxPrice').textContent = formatPrice(currentHistoryData.maxPrice);
      document.getElementById('allCount').textContent = currentHistoryData.productCount;

      // 기준가 버튼 업데이트
      document.getElementById('basePriceMin').textContent = formatPrice(currentHistoryData.minPrice);
      document.getElementById('basePriceAvg').textContent = formatPrice(currentHistoryData.avgPrice);
      document.getElementById('basePriceMid').textContent = formatPrice(currentHistoryData.midPrice);
      document.getElementById('basePriceMax').textContent = formatPrice(currentHistoryData.maxPrice);

      // 검색 키워드 설정
      document.getElementById('priceCollectKeyword').value = currentHistoryData.keyword;

      // 결과 영역 표시
      document.getElementById('priceCollectResult').style.display = 'block';

      // 내 판매가 계산
      calculateMyPrices();

      // 초기 미리보기 업데이트
      updatePricePreview();

      closePriceHistoryModal();
      showAlert(`"${currentHistoryData.keyword}" 검색 결과를 불러왔습니다.`, 'success');
    }

    // 가격 수집 결과 히스토리에 저장
    async function savePriceHistory(keyword, results, stats) {
      try {
        const token = localStorage.getItem('token');
        if (!token) return;

        await fetch('/api/price-history', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ keyword, results, stats })
        });

        // 히스토리 목록 새로고침
        loadPriceHistory();
      } catch (error) {
        console.error('히스토리 저장 오류:', error);
      }
    }

    // 가격 포맷팅 헬퍼
    function formatPrice(price) {
      if (!price && price !== 0) return '-';
      return Math.round(price).toLocaleString() + '원';
    }
  </script>

  <!-- 커스텀 AI 모달 -->
  <div id="customAIModal" class="custom-ai-modal" onclick="if(event.target === this) closeCustomAIModal()">
    <div class="custom-ai-content">
      <div class="custom-ai-header">
        <h3><span>🎨</span> 커스텀 AI 변환</h3>
        <button class="custom-ai-close" onclick="closeCustomAIModal()">&times;</button>
      </div>
      <div class="custom-ai-body">
        <label for="customAiPrompt">AI에게 전달할 지시사항</label>
        <textarea id="customAiPrompt" class="custom-ai-textarea" placeholder="예: 모든 옵션명을 간단한 한글로 변환해주세요. 색상은 '빨강', '파랑' 등 기본 색상명으로 변환하고, 사이즈는 'S', 'M', 'L'로 통일해주세요."></textarea>
        <div class="custom-ai-select-row">
          <label>대상 옵션:</label>
          <select id="customAiTargetOption" class="custom-ai-select">
            <option value="all" selected>전체 (옵션1+옵션2)</option>
            <option value="optionName1">옵션1</option>
            <option value="optionName2">옵션2</option>
          </select>
        </div>
      </div>
      <div class="custom-ai-footer">
        <button class="btn-custom-cancel" onclick="closeCustomAIModal()">취소</button>
        <button id="customAiApplyBtn" class="btn-custom-apply" onclick="applyCustomAIFromModal()">
          <span>✨</span>
          <span id="customAiBtnText">AI 변환 적용</span>
        </button>
      </div>
    </div>
  </div>

  <!-- AI 작명 모달 -->
  <div id="aiRenameModal" class="custom-ai-modal" onclick="if(event.target === this) closeAIRenameModal()">
    <div class="custom-ai-content">
      <div class="custom-ai-header">
        <h3><span>✨</span> AI 작명</h3>
        <button class="custom-ai-close" onclick="closeAIRenameModal()">&times;</button>
      </div>
      <div class="custom-ai-body">
        <p class="ai-description" style="margin-bottom: 15px;">
          AI가 중국어 옵션명을 자연스러운 한국어로 변환합니다. 색상, 사이즈 등을 자동으로 인식하여 쇼핑몰에 적합한 형태로 변환해드립니다.
        </p>
        <div class="custom-ai-select-row" style="margin-bottom: 15px;">
          <label>대상 옵션:</label>
          <select id="aiTargetOption" class="custom-ai-select">
            <option value="all" selected>전체 (옵션1+옵션2)</option>
            <option value="optionName1">옵션1만</option>
            <option value="optionName2">옵션2만</option>
          </select>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button class="btn-action btn-action-ai" onclick="applyAIRenameFromModal('standard')" style="width: 100%; justify-content: center; padding: 12px;">
            <span>🔄</span> 중국어 → 한국어 자동 변환
          </button>
          <button class="btn-action btn-action-primary" onclick="openCustomAIModal(); closeAIRenameModal();" style="width: 100%; justify-content: center; padding: 12px;">
            <span>🎨</span> 커스텀 프롬프트로 변환
          </button>
        </div>
      </div>
      <div class="custom-ai-footer">
        <button class="btn-custom-cancel" onclick="closeAIRenameModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 가격 히스토리 상세 모달 -->
  <div id="priceHistoryModal" class="custom-ai-modal" onclick="if(event.target === this) closePriceHistoryModal()">
    <div class="custom-ai-content" style="max-width: 700px;">
      <div class="custom-ai-header">
        <h3><span>📊</span> <span id="historyModalKeyword">키워드</span> 검색 결과</h3>
        <button class="custom-ai-close" onclick="closePriceHistoryModal()">&times;</button>
      </div>
      <div class="custom-ai-body" style="max-height: 500px; overflow-y: auto;">
        <!-- 요약 정보 -->
        <div id="historyModalSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
          <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #666;">최저가</div>
            <div id="historyMinPrice" style="font-size: 18px; font-weight: 700; color: #2563eb;">-</div>
          </div>
          <div style="background: #f0fff4; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #666;">평균가</div>
            <div id="historyAvgPrice" style="font-size: 18px; font-weight: 700; color: #059669;">-</div>
          </div>
          <div style="background: #fefce8; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #666;">중간가</div>
            <div id="historyMidPrice" style="font-size: 18px; font-weight: 700; color: #ca8a04;">-</div>
          </div>
          <div style="background: #fef2f2; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #666;">최고가</div>
            <div id="historyMaxPrice" style="font-size: 18px; font-weight: 700; color: #dc2626;">-</div>
          </div>
        </div>
        <div style="font-size: 12px; color: #888; text-align: center;">
          수집일시: <span id="historyCreatedAt">-</span> | 상품 수: <span id="historyProductCount">-</span>개
        </div>
      </div>
      <div class="custom-ai-footer" style="display: flex; gap: 10px;">
        <button class="btn-custom-cancel" onclick="deletePriceHistoryItem()" style="color: #dc2626;">
          🗑️ 삭제
        </button>
        <button class="btn-custom-apply" onclick="loadHistoryToCollect()">
          📥 이 데이터로 가격 설정
        </button>
      </div>
    </div>
  </div>
</body>
</html>
