<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>TotalBot - ì—…ë¡œë“œ ì™„ë£Œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f7;
      color: #333;
    }

    /* Sidebar Styles */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: #1a1a2e;
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-header {
      padding: 24px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .sidebar-header h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.8;
    }

    .sidebar-menu {
      padding: 16px 0;
    }

    .sidebar-menu-title {
      padding: 12px 20px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: #ccc;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .sidebar-menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }

    .sidebar-menu-item.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      border-left-color: #667eea;
    }

    .sidebar-menu-item .menu-icon {
      width: 24px;
      margin-right: 12px;
      font-size: 18px;
      text-align: center;
    }

    .sidebar-menu-item .menu-badge {
      margin-left: auto;
      background: #667eea;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 12px 20px;
    }

    /* Hamburger Button */
    .hamburger-btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: #f0f0f0;
    }

    .hamburger-btn span {
      display: block;
      width: 22px;
      height: 2px;
      background: #333;
      margin: 2px 0;
      border-radius: 1px;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: #1e90ff;
      color: white;
    }

    .btn-primary:hover {
      background: #1873cc;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-info:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .dash-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .dash-card .icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .dash-card .icon.blue { background: #dbeafe; }
    .dash-card .icon.orange { background: #ffedd5; }
    .dash-card .icon.green { background: #d1fae5; }

    .dash-card .info .value {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }

    .dash-card .info .label {
      font-size: 13px;
      color: #666;
    }

    /* Products Section */
    .products-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-header h2 .icon {
      font-size: 22px;
    }

    /* Product List */
    .product-list {
      padding: 0;
    }

    .product-item {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .product-item:last-child {
      border-bottom: none;
    }

    .product-item:hover {
      background: #f9fafb;
    }

    .product-item .thumb {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      background: #f0f0f0;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .product-item .info {
      flex: 1;
      min-width: 0;
    }

    .product-item .title {
      font-size: 15px;
      font-weight: 600;
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }

    .product-item .meta {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: #666;
    }

    .product-item .meta .sku-info {
      display: flex;
      gap: 8px;
    }

    .product-item .meta .sku-total { color: #333; font-weight: 600; }
    .product-item .meta .sku-pending { color: #f59e0b; }
    .product-item .meta .sku-approved { color: #10b981; }
    .product-item .meta .sku-rejected { color: #ef4444; }

    .product-item .quote-id {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .product-item .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
      margin-left: 16px;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.unchecked {
      background: #f3f4f6;
      color: #6b7280;
    }

    /* Stage Progress */
    .stage-progress {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    /* Empty State */
    .empty-state {
      padding: 60px 24px;
      text-align: center;
      color: #888;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .toast.success { background: #10b981; color: white; }
    .toast.error { background: #ef4444; color: white; }
    .toast.warning { background: #f59e0b; color: white; }
    .toast.info { background: #3b82f6; color: white; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Loading */
    .loading {
      padding: 40px;
      text-align: center;
      color: #888;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>TotalBot</h2>
      <p>ì¿ íŒ¡ ìë™í™” í”Œë«í¼</p>
    </div>

    <div class="sidebar-menu">
      <div class="sidebar-menu-title">ìƒí’ˆ ê´€ë¦¬</div>
      <a class="sidebar-menu-item" href="products.html">
        <span class="menu-icon">ğŸ“¦</span>
        ìˆ˜ì§‘ ìƒí’ˆ
      </a>
      <a class="sidebar-menu-item active" href="uploaded.html">
        <span class="menu-icon">ğŸš€</span>
        ì—…ë¡œë“œ ì™„ë£Œ
      </a>
      <a class="sidebar-menu-item" href="quotations.html">
        <span class="menu-icon">ğŸ“‹</span>
        ê²¬ì ì„œ ê´€ë¦¬
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">ë°œì£¼ ê´€ë¦¬</div>
      <a class="sidebar-menu-item" href="orders.html">
        <span class="menu-icon">ğŸ›’</span>
        ìë™ ë°œì£¼
        <span class="menu-badge">NEW</span>
      </a>
      <a class="sidebar-menu-item" href="order-list.html">
        <span class="menu-icon">ğŸ“‘</span>
        ë°œì£¼ ë¦¬ìŠ¤íŠ¸
      </a>
      <a class="sidebar-menu-item" href="shipments.html">
        <span class="menu-icon">ğŸšš</span>
        ë°°ì†¡ ê´€ë¦¬
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">ë¶„ì„/ì„¤ì •</div>
      <a class="sidebar-menu-item" href="settlement.html">
        <span class="menu-icon">ğŸ’°</span>
        ì •ì‚°
      </a>
      <a class="sidebar-menu-item" href="settings.html">
        <span class="menu-icon">âš™ï¸</span>
        ì„¤ì •
      </a>
    </div>
  </nav>

  <div class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="toggleSidebar()" title="ë©”ë‰´">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1>ì—…ë¡œë“œ ì™„ë£Œ</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-info" onclick="checkApprovalStatus()" id="checkApprovalBtn">
        <span>ğŸ”</span> ìŠ¹ì¸ í™•ì¸
      </button>
      <button class="btn btn-secondary" onclick="loadProducts()">
        <span>ğŸ”„</span> ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
      <div class="dash-card">
        <div class="icon blue">ğŸ“Š</div>
        <div class="info">
          <div class="value" id="totalSkuCount">0</div>
          <div class="label">ì „ì²´ SKU</div>
        </div>
      </div>
      <div class="dash-card">
        <div class="icon orange">â³</div>
        <div class="info">
          <div class="value" id="pendingSkuCount">0</div>
          <div class="label">ì‹¬ì‚¬ì¤‘</div>
        </div>
      </div>
      <div class="dash-card">
        <div class="icon green">âœ…</div>
        <div class="info">
          <div class="value" id="approvedSkuCount">0</div>
          <div class="label">ìŠ¹ì¸ì™„ë£Œ</div>
        </div>
      </div>
    </div>

    <!-- Products List -->
    <div class="products-section">
      <div class="section-header">
        <h2>
          <span class="icon">ğŸš€</span>
          ì—…ë¡œë“œëœ ìƒí’ˆ
          <span id="productCount" style="font-weight: normal; color: #888; font-size: 14px;"></span>
        </h2>
      </div>

      <div class="product-list" id="productList">
        <div class="loading">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
      </div>
    </div>
  </div>

  <script>
    // ===== ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ =====
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function checkAuth() {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    async function authFetch(url, options = {}) {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
      };

      const response = await fetch(url, { ...options, headers });

      if (response.status === 401) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
        return;
      }

      return response;
    }

    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    });

    // Toast ì•Œë¦¼
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    let allProducts = [];

    // ìƒí’ˆ ëª©ë¡ ë¡œë“œ
    async function loadProducts() {
      try {
        const response = await authFetch('/api/products/list');
        if (!response) return;

        const data = await response.json();

        if (!data.success) {
          throw new Error('ìƒí’ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        // ì—…ë¡œë“œëœ ìƒí’ˆë§Œ í•„í„°ë§
        allProducts = data.products.filter(p =>
          p.status === 'uploaded' || p.status === 'approved'
        );

        updateDashboard();
        renderProducts();

      } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('productList').innerHTML = `
          <div class="empty-state">
            <div class="icon">âš ï¸</div>
            <p>ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
          </div>
        `;
      }
    }

    // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    function updateDashboard() {
      let totalSku = 0;
      let pendingSku = 0;
      let approvedSku = 0;

      allProducts.forEach(p => {
        if (p.skuStatus) {
          totalSku += p.skuStatus.totalSku || 0;
          pendingSku += p.skuStatus.pending || 0;
          approvedSku += p.skuStatus.approved || 0;
        }
      });

      const uncheckedCount = allProducts.filter(p => !p.skuStatus).length;

      document.getElementById('totalSkuCount').textContent =
        totalSku > 0 ? totalSku : (uncheckedCount > 0 ? `${uncheckedCount}ê°œ ë¯¸í™•ì¸` : '0');
      document.getElementById('pendingSkuCount').textContent = pendingSku;
      document.getElementById('approvedSkuCount').textContent = approvedSku;
      document.getElementById('productCount').textContent = `(${allProducts.length}ê°œ)`;
    }

    // ìƒí’ˆ ë Œë”ë§
    function renderProducts() {
      const container = document.getElementById('productList');

      if (allProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸš€</div>
            <p>ì•„ì§ ì—…ë¡œë“œëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p style="font-size: 13px; margin-top: 8px;">ìˆ˜ì§‘ ìƒí’ˆ í˜ì´ì§€ì—ì„œ ì¿ íŒ¡ì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
        return;
      }

      const html = allProducts.map(product => {
        const mainImage = product.mainImages?.[0] || product.images?.[0] || '';
        const skuStatus = product.skuStatus;
        const quoteId = product.quoteId || '-';

        // SKU ì •ë³´
        let skuHtml = '';
        if (skuStatus) {
          skuHtml = `
            <div class="sku-info">
              <span class="sku-total">${skuStatus.totalSku || 0}ê°œ SKU</span>
              ${skuStatus.pending > 0 ? `<span class="sku-pending">Â· ${skuStatus.pending}ê°œ ì‹¬ì‚¬ì¤‘</span>` : ''}
              ${skuStatus.approved > 0 ? `<span class="sku-approved">Â· ${skuStatus.approved}ê°œ ìŠ¹ì¸</span>` : ''}
              ${skuStatus.rejected > 0 ? `<span class="sku-rejected">Â· ${skuStatus.rejected}ê°œ ë°˜ë ¤</span>` : ''}
            </div>
          `;
        } else {
          skuHtml = `<div class="sku-info"><span style="color: #888;">ğŸ” ìŠ¹ì¸ í™•ì¸ í•„ìš”</span></div>`;
        }

        // ìƒíƒœ ë±ƒì§€
        let statusBadge = '';
        let stageProgress = '';

        if (product.status === 'approved') {
          statusBadge = '<span class="status-badge approved">ìŠ¹ì¸ì™„ë£Œ</span>';
        } else if (product.isRejected || (skuStatus && skuStatus.rejected === skuStatus.totalSku && skuStatus.totalSku > 0)) {
          statusBadge = '<span class="status-badge rejected">ë°˜ë ¤</span>';
          stageProgress = 'ë°˜ë ¤ë¨';
        } else if (!skuStatus) {
          statusBadge = '<span class="status-badge unchecked">ë¯¸í™•ì¸</span>';
          stageProgress = 'í™•ì¸ í•„ìš”';
        } else {
          // ì‹¬ì‚¬ ë‹¨ê³„
          const stage = skuStatus.currentStage;
          if (stage === 'R21') {
            statusBadge = '<span class="status-badge pending">ë°œì£¼ì„œë°œí–‰</span>';
            stageProgress = `3ë‹¨ê³„ (${skuStatus.step3Completed}/${skuStatus.totalSku})`;
          } else if (stage === 'HOTW') {
            statusBadge = '<span class="status-badge pending">ìƒí’ˆì •ë³´</span>';
            stageProgress = `2ë‹¨ê³„ (${skuStatus.step2Completed}/${skuStatus.totalSku})`;
          } else if (stage === 'ONBOARDED') {
            statusBadge = '<span class="status-badge pending">ê°€ê²©/ì •ì±…</span>';
            stageProgress = `1ë‹¨ê³„ (${skuStatus.step1Completed}/${skuStatus.totalSku})`;
          } else {
            statusBadge = '<span class="status-badge pending">ì‹¬ì‚¬ì¤‘</span>';
            stageProgress = 'ì‹¬ì‚¬ ì§„í–‰ì¤‘';
          }
        }

        return `
          <div class="product-item" onclick="showProductDetail('${product.id}')">
            <img class="thumb" src="${mainImage}" alt=""
                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23ccc%22>ğŸ“¦</text></svg>'">
            <div class="info">
              <div class="title">${product.title || 'ì œëª© ì—†ìŒ'}</div>
              <div class="meta">
                ${skuHtml}
              </div>
              <div class="quote-id">ê²¬ì ì„œ #${quoteId}</div>
              ${stageProgress ? `<div class="stage-progress">${stageProgress}</div>` : ''}
            </div>
            ${statusBadge}
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // ìƒí’ˆ ìƒì„¸ ë³´ê¸°
    function showProductDetail(productId) {
      window.location.href = `product-detail.html?id=${productId}`;
    }

    // ìŠ¹ì¸ ìƒíƒœ í™•ì¸
    async function checkApprovalStatus() {
      const btn = document.getElementById('checkApprovalBtn');
      const originalText = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<span>â³</span> í™•ì¸ ì¤‘...';
        showToast('ìŠ¹ì¸ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');

        // ì‹¬ì‚¬ì¤‘ì¸ ìƒí’ˆë§Œ í•„í„°ë§ (ë°˜ë ¤/ìŠ¹ì¸ ì™„ë£Œ ì œì™¸)
        const productsToCheck = allProducts.filter(p => {
          const skuStatus = p.skuStatus;
          if (!skuStatus) return true;

          const totalSku = skuStatus.totalSku || 0;
          const approved = skuStatus.approved || 0;
          const rejected = skuStatus.rejected || 0;
          const pending = skuStatus.pending || 0;

          if ((rejected === totalSku || approved === totalSku || pending === 0) && totalSku > 0) {
            return false;
          }
          return true;
        });

        if (productsToCheck.length === 0) {
          showToast('í™•ì¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë‘ ì™„ë£Œë¨)', 'info');
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        // Extensionì— ë©”ì‹œì§€ ì „ì†¡
        const responseHandler = (event) => {
          if (event.data && event.data.source === 'totalbot-extension-response' &&
              event.data.originalAction === 'checkApprovalNow') {
            window.removeEventListener('message', responseHandler);

            const response = event.data.response;
            btn.disabled = false;
            btn.innerHTML = originalText;

            if (response && response.success) {
              const result = response.result;
              const skipped = result.skippedCount || 0;

              if (result.approvedCount > 0) {
                showToast(`${result.approvedCount}ê°œ ìƒí’ˆì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success', 5000);
              } else if (result.checkedCount > 0) {
                let msg = `${result.checkedCount}ê°œ ê²¬ì ì„œ í™•ì¸ ì™„ë£Œ.`;
                if (skipped > 0) {
                  msg += ` (${skipped}ê°œ ê±´ë„ˆëœ€)`;
                }
                showToast(msg, 'info');
              } else if (skipped > 0) {
                showToast(`ëª¨ë“  ìƒí’ˆì´ ì‹¬ì‚¬ ì™„ë£Œë¨ (${skipped}ê°œ ê±´ë„ˆëœ€)`, 'info');
              }

              if (result.checkedCount > 0) {
                loadProducts();
              }
            } else {
              showToast(response?.error || 'ìŠ¹ì¸ í™•ì¸ ì‹¤íŒ¨', 'error');
            }
          }
        };

        window.addEventListener('message', responseHandler);

        setTimeout(() => {
          window.removeEventListener('message', responseHandler);
          if (btn.disabled) {
            btn.disabled = false;
            btn.innerHTML = originalText;
            showToast('ì‘ë‹µ ì‹œê°„ ì´ˆê³¼. ì¿ íŒ¡ í˜ì´ì§€ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.', 'error');
          }
        }, 30000);

        window.postMessage({
          source: 'totalbot-page',
          action: 'checkApprovalNow',
          products: productsToCheck.filter(p => p.quoteId)
        }, '*');

      } catch (error) {
        console.error('ìŠ¹ì¸ í™•ì¸ ì˜¤ë¥˜:', error);
        showToast('ìŠ¹ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      if (!checkAuth()) return;
      loadProducts();
    });
  </script>
</body>
</html>
