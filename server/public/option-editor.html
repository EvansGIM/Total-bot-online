<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜µì…˜ëª… ì¼ê´„í¸ì§‘ - TotalBot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Nanum Gothic', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 40px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .main-content {
      padding: 40px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e1e5e9;
      margin-bottom: 30px;
    }

    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      color: #667eea;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: normal;
      cursor: pointer;
    }

    .radio-group input[type="radio"] {
      width: auto;
      cursor: pointer;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #1976d2;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      font-size: 13px;
      color: #1976d2;
    }

    .preview-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }

    .preview-section h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .preview-table th,
    .preview-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e1e5e9;
    }

    .preview-table th {
      background: #f1f3f5;
      font-weight: 600;
      color: #495057;
    }

    .preview-table tbody tr:hover {
      background: #f8f9fa;
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }

    button {
      padding: 14px 32px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f1f3f5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e9ecef;
    }

    .status-message {
      text-align: center;
      padding: 20px;
      margin-top: 20px;
      border-radius: 8px;
      font-size: 14px;
    }

    .status-message.success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-message.error {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>âœï¸ ì˜µì…˜ëª… ì¼ê´„í¸ì§‘</h1>
      <p class="subtitle">ìƒí’ˆ ì˜µì…˜ëª…ì„ í•œ ë²ˆì— ë³€ê²½í•˜ê±°ë‚˜ ì •ë¦¬í•©ë‹ˆë‹¤</p>
    </header>

    <div class="main-content">
      <!-- íƒ­ -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('find-replace')">ì°¾ê¸° ë° ë°”ê¾¸ê¸°</button>
        <button class="tab-btn" onclick="switchTab('rename')">ìˆœì°¨ì  ì´ë¦„ ë³€ê²½</button>
      </div>

      <!-- ì°¾ê¸° ë° ë°”ê¾¸ê¸° íƒ­ -->
      <div id="find-replace-tab" class="tab-content active">
        <div class="info-box">
          ğŸ’¡ í…ìŠ¤íŠ¸ì˜ ì¼ë¶€ë§Œ ì¼ì¹˜í•´ë„ ë³€ê²½ë©ë‹ˆë‹¤. ì˜ˆ: 'ë¸”ë™'ì„ ì°¾ìœ¼ë©´ 'ë¸”ë™ XL', 'ë¸”ë™ M' ë“±ì´ ëª¨ë‘ ë³€ê²½ë©ë‹ˆë‹¤.
        </div>

        <div class="form-group">
          <label for="option-type-fr">ì˜µì…˜ ì¢…ë¥˜</label>
          <select id="option-type-fr">
            <option value="option1">ì˜µì…˜1</option>
            <option value="option2">ì˜µì…˜2</option>
          </select>
        </div>

        <div class="form-group">
          <label for="find-text">ì°¾ì„ í…ìŠ¤íŠ¸</label>
          <input type="text" id="find-text" placeholder="ì˜ˆ: ë¸”ë™, í™”ì´íŠ¸, XL ë“±">
        </div>

        <div class="form-group">
          <label for="replace-text">ë°”ê¿€ í…ìŠ¤íŠ¸</label>
          <input type="text" id="replace-text" placeholder="ì˜ˆ: ê²€ì •, í°ìƒ‰, 95 ë“±">
        </div>

        <div class="button-group">
          <button class="btn-secondary" onclick="previewFindReplace()">ë¯¸ë¦¬ë³´ê¸°</button>
          <button class="btn-primary" onclick="applyFindReplace()">ì ìš©í•˜ê¸°</button>
        </div>
      </div>

      <!-- ìˆœì°¨ì  ì´ë¦„ ë³€ê²½ íƒ­ -->
      <div id="rename-tab" class="tab-content">
        <div class="info-box">
          ğŸ’¡ ì˜µì…˜1 ê°’ì„ ì¼ê´„ì ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. ë™ì¼í•œ ì˜µì…˜1 ê°’ì„ ê°€ì§„ í•­ëª©ë“¤ì€ ê°™ì€ ë²ˆí˜¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.
        </div>

        <div class="form-group">
          <label for="option-type-rename">ì˜µì…˜ ì¢…ë¥˜</label>
          <select id="option-type-rename">
            <option value="option1">ì˜µì…˜1</option>
            <option value="option2">ì˜µì…˜2</option>
          </select>
        </div>

        <div class="form-group">
          <label for="prefix">ê¸°ë³¸ ì´ë¦„</label>
          <input type="text" id="prefix" placeholder="ì˜ˆ: ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ ë“±">
        </div>

        <div class="form-group">
          <label>ë²ˆí˜¸ ìœ í˜•</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="numbering-type" value="123" checked>
              123 (ìˆ«ì)
            </label>
            <label>
              <input type="radio" name="numbering-type" value="ABC">
              ABC (ì•ŒíŒŒë²³)
            </label>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-secondary" onclick="previewRename()">ë¯¸ë¦¬ë³´ê¸°</button>
          <button class="btn-primary" onclick="applyRename()">ì ìš©í•˜ê¸°</button>
        </div>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ -->
      <div id="preview-section" class="preview-section" style="display: none;">
        <h3>ğŸ” ë³€ê²½ ë¯¸ë¦¬ë³´ê¸°</h3>
        <table class="preview-table">
          <thead>
            <tr>
              <th>í˜„ì¬ ê°’</th>
              <th>â†’</th>
              <th>ë³€ê²½ í›„ ê°’</th>
            </tr>
          </thead>
          <tbody id="preview-body">
          </tbody>
        </table>
      </div>

      <div id="status-message"></div>
    </div>
  </div>

  <script>
    let productData = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì œí’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadProductData() {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('productId');

      try {
        const response = await fetch(`/api/products/${productId || 'latest'}`);
        if (!response.ok) {
          throw new Error('ì œí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        productData = await response.json();
      } catch (error) {
        showStatus('error', `ì˜¤ë¥˜: ${error.message}`);
      }
    }

    // íƒ­ ì „í™˜
    function switchTab(tabName) {
      // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // ëª¨ë“  íƒ­ ë‚´ìš© ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // ì„ íƒí•œ íƒ­ í™œì„±í™”
      event.target.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
      document.getElementById('preview-section').style.display = 'none';
      document.getElementById('status-message').innerHTML = '';
    }

    // ì°¾ê¸° ë° ë°”ê¾¸ê¸° ë¯¸ë¦¬ë³´ê¸°
    function previewFindReplace() {
      const findText = document.getElementById('find-text').value.trim();
      const replaceText = document.getElementById('replace-text').value;
      const optionType = document.getElementById('option-type-fr').value;

      if (!findText) {
        showStatus('error', 'ì°¾ì„ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!productData || !productData.options) {
        showStatus('error', 'ì œí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const previewData = [];
      productData.options.forEach(option => {
        const currentValue = option[optionType];
        if (currentValue && currentValue.includes(findText)) {
          const newValue = currentValue.replace(new RegExp(findText, 'g'), replaceText);
          previewData.push({ current: currentValue, new: newValue });
        }
      });

      displayPreview(previewData);
    }

    // ìˆœì°¨ì  ì´ë¦„ ë³€ê²½ ë¯¸ë¦¬ë³´ê¸°
    function previewRename() {
      const prefix = document.getElementById('prefix').value.trim();
      const numberingType = document.querySelector('input[name="numbering-type"]:checked').value;
      const optionType = document.getElementById('option-type-rename').value;

      if (!prefix) {
        showStatus('error', 'ê¸°ë³¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!productData || !productData.options) {
        showStatus('error', 'ì œí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ê³ ìœ í•œ ì˜µì…˜ ê°’ ì¶”ì¶œ
      const uniqueValues = [...new Set(productData.options.map(opt => opt[optionType]))];
      const valueMap = {};

      uniqueValues.forEach((value, index) => {
        let number;
        if (numberingType === 'ABC') {
          number = indexToLetter(index);
        } else {
          number = String(index + 1);
        }
        valueMap[value] = `${prefix}${number}`;
      });

      const previewData = [];
      uniqueValues.forEach(value => {
        previewData.push({ current: value, new: valueMap[value] });
      });

      displayPreview(previewData);
    }

    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    function displayPreview(data) {
      const previewSection = document.getElementById('preview-section');
      const previewBody = document.getElementById('preview-body');

      if (data.length === 0) {
        showStatus('error', 'ë³€ê²½í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        previewSection.style.display = 'none';
        return;
      }

      previewBody.innerHTML = '';
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.current}</td>
          <td style="text-align: center; color: #667eea;">â†’</td>
          <td><strong>${item.new}</strong></td>
        `;
        previewBody.appendChild(row);
      });

      previewSection.style.display = 'block';
      showStatus('', '');
    }

    // ì°¾ê¸° ë° ë°”ê¾¸ê¸° ì ìš©
    async function applyFindReplace() {
      const findText = document.getElementById('find-text').value.trim();
      const replaceText = document.getElementById('replace-text').value;
      const optionType = document.getElementById('option-type-fr').value;

      if (!findText) {
        showStatus('error', 'ì°¾ì„ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch('/api/gemini/edit-option-names', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productData.id,
            optionType,
            action: 'find-replace',
            findText,
            replaceText
          })
        });

        const result = await response.json();

        if (result.success) {
          showStatus('success', `âœ… ${result.updatedCount}ê°œ ì˜µì…˜ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          // ì œí’ˆ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
          await loadProductData();
        } else {
          showStatus('error', `âŒ ${result.message}`);
        }
      } catch (error) {
        showStatus('error', `âŒ ì˜¤ë¥˜: ${error.message}`);
      }
    }

    // ìˆœì°¨ì  ì´ë¦„ ë³€ê²½ ì ìš©
    async function applyRename() {
      const prefix = document.getElementById('prefix').value.trim();
      const numberingType = document.querySelector('input[name="numbering-type"]:checked').value;
      const optionType = document.getElementById('option-type-rename').value;

      if (!prefix) {
        showStatus('error', 'ê¸°ë³¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch('/api/gemini/edit-option-names', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productData.id,
            optionType,
            action: 'rename-sequential',
            prefix,
            numberingType
          })
        });

        const result = await response.json();

        if (result.success) {
          showStatus('success', `âœ… ${result.updatedCount}ê°œ ì˜µì…˜ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          // ì œí’ˆ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
          await loadProductData();
        } else {
          showStatus('error', `âŒ ${result.message}`);
        }
      } catch (error) {
        showStatus('error', `âŒ ì˜¤ë¥˜: ${error.message}`);
      }
    }

    // ì¸ë±ìŠ¤ë¥¼ ì•ŒíŒŒë²³ìœ¼ë¡œ ë³€í™˜
    function indexToLetter(index) {
      let result = '';
      while (index >= 0) {
        result = String.fromCharCode(65 + (index % 26)) + result;
        index = Math.floor(index / 26) - 1;
      }
      return result;
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(type, message) {
      const statusEl = document.getElementById('status-message');
      statusEl.className = type ? `status-message ${type}` : '';
      statusEl.textContent = message;
    }

    // ì´ˆê¸°í™”
    loadProductData();
  </script>
</body>
</html>
