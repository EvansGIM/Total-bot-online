<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>TotalBot - ÏÉÅÌíà Í¥ÄÎ¶¨ v3</title>
  <!-- JSZip ÎùºÏù¥Î∏åÎü¨Î¶¨ (ZIP ÌååÏùº Ï≤òÎ¶¨Ïö©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f7;
      color: #333;
    }

    /* Sidebar Styles */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: #1a1a2e;
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-header {
      padding: 24px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .sidebar-header h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.8;
    }

    .sidebar-menu {
      padding: 16px 0;
    }

    .sidebar-menu-title {
      padding: 12px 20px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: #ccc;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .sidebar-menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }

    .sidebar-menu-item.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      border-left-color: #667eea;
    }

    .sidebar-menu-item .menu-icon {
      width: 24px;
      margin-right: 12px;
      font-size: 18px;
      text-align: center;
    }

    .sidebar-menu-item .menu-badge {
      margin-left: auto;
      background: #667eea;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 12px 20px;
    }

    /* Hamburger Button */
    .hamburger-btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: #f0f0f0;
    }

    .hamburger-btn span {
      display: block;
      width: 22px;
      height: 2px;
      background: #333;
      margin: 2px 0;
      border-radius: 1px;
      transition: all 0.3s;
    }

    /* Floating Action Buttons */
    .floating-actions {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 900;
      pointer-events: none;
    }

    .floating-actions.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .floating-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1a1a2e;
      padding: 8px 12px;
      border-radius: 50px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .floating-pill .selected-badge {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }

    .floating-pill .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .floating-pill .btn-delete {
      background: #ef4444;
      color: white;
    }

    .floating-pill .btn-delete:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .floating-pill .btn-quote {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .floating-pill .btn-quote:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #1e90ff;
      color: white;
    }

    .btn-primary:hover {
      background: #1873cc;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .products-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .search-box {
      display: flex;
      gap: 8px;
    }

    .search-box input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 250px;
      font-size: 14px;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
    }

    .products-table thead {
      background: #f9fafb;
      border-bottom: 1px solid #e5e8eb;
    }

    .products-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #666;
    }

    .products-table td {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }

    .products-table tbody tr:hover {
      background: #f9fafb;
    }

    .products-table tbody tr:has(input[type="checkbox"]:checked) {
      background: #e3f2fd;
    }

    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #e5e8eb;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .product-image:hover {
      transform: scale(1.05);
      border-color: #667eea;
    }

    /* Ïù¥ÎØ∏ÏßÄ Ìò∏Î≤Ñ ÎØ∏Î¶¨Î≥¥Í∏∞ (fixed positionÏúºÎ°ú overflow Î¨∏Ï†ú Ìï¥Í≤∞) */
    #imagePreviewPopup {
      position: fixed;
      width: 280px;
      height: 280px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      pointer-events: none;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }

    #imagePreviewPopup.visible {
      opacity: 1;
      visibility: visible;
    }

    #imagePreviewPopup img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #f8f8f8;
    }

    .product-title {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .platform-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-1688 {
      background: #ff6b00;
      color: white;
    }

    .badge-coupang {
      background: #ff0037;
      color: white;
    }

    .badge-aliexpress {
      background: #e62e04;
      color: white;
    }

    .platform-link {
      text-decoration: none;
      cursor: pointer;
    }

    .platform-link:hover .platform-badge {
      opacity: 0.8;
      transform: scale(1.05);
      transition: all 0.2s ease;
    }

    .source-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .source-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      opacity: 0.9;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-edit {
      background: #1e90ff;
      color: white;
    }

    .btn-edit:hover {
      background: #1873cc;
    }

    .btn-delete {
      background: #ff4444;
      color: white;
    }

    .btn-delete:hover {
      background: #cc0000;
    }

    .empty-state {
      padding: 80px 24px;
      text-align: center;
      color: #888;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    .loading {
      padding: 40px;
      text-align: center;
      color: #888;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* ÏÑ§Ï†ï Î™®Îã¨ */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      padding: 0;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .settings-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f0f0f0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }

    .modal-close:hover {
      background: #e0e0e0;
    }

    .settings-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .settings-section {
      margin-bottom: 32px;
    }

    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #333;
      font-weight: 600;
      border-bottom: 2px solid #e5e8eb;
      padding-bottom: 8px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-field label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .settings-field input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .settings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-tab {
      background: transparent;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .settings-tab:hover {
      color: #333;
      background: #f5f5f5;
    }

    .settings-tab.active {
      color: #1e90ff;
      font-weight: 600;
      border-bottom-color: #1e90ff;
    }

    .settings-tab-content {
      display: none;
    }

    .settings-tab-content.active {
      display: block;
    }

    .margin-rows-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      padding: 12px;
      background: #f9fafb;
    }

    .margin-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e8eb;
    }

    .margin-row input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .margin-row button {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .margin-row button:hover {
      background: #dc2626;
    }

    .margin-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    /* ÏÑ§Ï†ï Î©îÏù∏ ÌÉ≠ Ïä§ÌÉÄÏùº */
    .settings-main-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-main-tab {
      background: transparent;
      border: none;
      padding: 14px 28px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .settings-main-tab:hover {
      color: #1e90ff;
      background: rgba(30, 144, 255, 0.05);
    }

    .settings-main-tab.active {
      color: #1e90ff;
      font-weight: 700;
      border-bottom-color: #1e90ff;
    }

    .settings-main-tab-content {
      display: none;
    }

    .settings-main-tab-content.active {
      display: block;
    }

    .settings-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e8eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-info:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }

    .toast.success {
      background: #28a745;
    }

    .toast.error {
      background: #dc3545;
    }

    .toast.info {
      background: #17a2b8;
    }

    .toast.warning {
      background: #ffc107;
      color: #212529;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* ========================================
       Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ Ïä§ÌÉÄÏùº
       ======================================== */
    #coupangCategoryModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .coupang-modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .coupang-modal-header {
      padding: 24px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .coupang-modal-header h2 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }

    .coupang-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .coupang-modal-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    .coupang-modal-body {
      padding: 24px;
      flex: 1;
      overflow-y: auto;
    }

    .coupang-search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .coupang-search-input {
      width: 100%;
      padding: 18px 24px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: all 0.3s;
    }

    .coupang-search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .coupang-status {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .coupang-status.loading {
      background: #e3f2fd;
      color: #1976d2;
      display: block;
    }

    .coupang-status.error {
      background: #ffebee;
      color: #c62828;
      display: block;
    }

    .coupang-status.success {
      background: #e8f5e9;
      color: #2e7d32;
      display: block;
    }

    .coupang-category-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .coupang-category-item {
      padding: 16px;
      border: 2px solid #f0f0f0;
      border-radius: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .coupang-category-item:hover {
      background: #f8f9fa;
      border-color: #667eea;
    }

    .coupang-category-item.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      color: white;
    }

    .coupang-category-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .coupang-category-content {
      flex: 1;
    }

    .coupang-category-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .coupang-category-path {
      font-size: 14px;
      opacity: 0.7;
    }

    .coupang-category-item.selected .coupang-category-path {
      opacity: 0.9;
    }

    .coupang-empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .coupang-modal-footer {
      padding: 20px 24px;
      border-top: 2px solid #f0f0f0;
    }

    .coupang-download-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .coupang-download-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .coupang-download-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* ========================================
       Ïπ¥ÌÖåÍ≥†Î¶¨ ÏùºÍ¥Ñ ÏàòÏßë Î™®Îã¨ Ïä§ÌÉÄÏùº
       ======================================== */
    #batchCategoryModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .batch-keyword-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    .batch-keyword-input {
      flex: 1;
      padding: 14px 18px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s;
    }

    .batch-keyword-input:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
    }

    .batch-keyword-input.has-results {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .batch-keyword-input.searching {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .batch-keyword-status {
      font-size: 12px;
      min-width: 80px;
      text-align: center;
      padding: 6px 10px;
      border-radius: 6px;
      background: #f3f4f6;
      color: #6b7280;
    }

    .batch-keyword-status.success {
      background: #d1fae5;
      color: #059669;
    }

    .batch-keyword-status.searching {
      background: #dbeafe;
      color: #2563eb;
    }

    .batch-keyword-status.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .batch-remove-btn {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }

    .batch-remove-btn:hover {
      background: #fecaca;
    }

    .batch-add-btn {
      width: 100%;
      padding: 12px;
      background: #f3f4f6;
      border: 2px dashed #d1d5db;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .batch-add-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
      color: #374151;
    }

    .batch-results-summary {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
    }

    .batch-results-summary h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: #92400e;
    }

    .batch-category-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      margin: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .batch-category-chip .remove {
      cursor: pointer;
      color: #9ca3af;
      font-weight: bold;
    }

    .batch-category-chip .remove:hover {
      color: #dc2626;
    }

    /* Î∞∞Ïπò Ïπ¥ÌÖåÍ≥†Î¶¨ Î¶¨Ïä§Ìä∏ ÏïÑÏù¥ÌÖú Ïä§ÌÉÄÏùº */
    .batch-category-item {
      padding: 14px 16px;
      border: 2px solid #f0f0f0;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
    }

    .batch-category-item:hover {
      background: #f8f9fa;
      border-color: #f59e0b;
    }

    .batch-category-item.downloaded {
      background: #f0fdf4;
      border-color: #10b981;
    }

    .batch-category-item.downloading {
      background: #eff6ff;
      border-color: #3b82f6;
    }

    .batch-category-item .batch-category-content {
      flex: 1;
      min-width: 0;
    }

    .batch-category-item .batch-category-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .batch-category-item .batch-category-path {
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .batch-category-item.downloaded .batch-category-download-btn {
      background: #10b981;
      cursor: default;
    }

    .batch-category-item .batch-category-download-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .batch-category-item .batch-category-download-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .batch-category-item .batch-category-download-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .batch-keyword-group-header {
      margin: 16px 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .batch-keyword-group-header h4 {
      margin: 0;
      font-size: 14px;
      color: #374151;
    }

    /* ÏàòÏßë ÏÑ§Ï†ï Î™®Îã¨ Ïä§ÌÉÄÏùº */
    .batch-collection-item {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 10px;
    }

    .collection-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .collection-category-name {
      font-weight: 600;
      font-size: 13px;
      color: #374151;
      min-width: 120px;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .collection-search-input {
      flex: 0 0 140px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
    }

    .collection-search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .collection-price-btns {
      display: flex;
      gap: 4px;
    }

    .price-btn {
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #fff;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .price-btn:hover {
      background: #f3f4f6;
    }

    .price-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .collection-checkboxes,
    .collection-sort-group,
    .collection-random-group,
    .collection-count-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .collection-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #4b5563;
      cursor: pointer;
      white-space: nowrap;
    }

    .collection-checkbox input[type="checkbox"],
    .collection-checkbox input[type="radio"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    .collection-price-group {
      display: flex;
      gap: 4px;
    }

    .price-radio {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 11px;
      color: #4b5563;
      cursor: pointer;
    }

    .price-radio input[type="radio"] {
      width: 12px;
      height: 12px;
    }

    .translate-btn {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .translate-btn:hover {
      background: #f3f4f6;
    }

    .random-pages-input,
    .product-count-input {
      width: 60px;
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #fff;
    }

    .collection-label {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
    }

    /* ÌîÑÎ°úÍ∑∏Î†àÏä§ Î™®Îã¨ Ïä§ÌÉÄÏùº */
    .progress-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .progress-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .progress-num {
      width: 24px;
      height: 24px;
      background: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }

    .progress-name {
      font-size: 13px;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .progress-keyword {
      font-size: 12px;
      color: #9ca3af;
    }

    .progress-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.pending {
      background: #f3f4f6;
      color: #6b7280;
    }

    .status-badge.searching {
      background: #dbeafe;
      color: #2563eb;
    }

    .status-badge.collecting {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.processing {
      background: #e0e7ff;
      color: #4f46e5;
    }

    .status-badge.uploading {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.completed {
      background: #10b981;
      color: white;
    }

    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .progress-detail {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Main Tabs (2 tabs only) */
    .main-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      padding: 0;
    }

    .main-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px 24px;
      background: white;
      border: 2px solid #e5e8eb;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .main-tab:hover {
      border-color: #1e90ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.15);
    }

    .main-tab.active {
      background: linear-gradient(135deg, #1e90ff 0%, #4dabf7 100%);
      border-color: transparent;
      box-shadow: 0 4px 16px rgba(30, 144, 255, 0.3);
    }

    .main-tab .tab-icon {
      font-size: 28px;
    }

    .main-tab .tab-label {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .main-tab.active .tab-label {
      color: white;
    }

    .main-tab .tab-count {
      background: #f0f0f0;
      color: #666;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
    }

    .main-tab.active .tab-count {
      background: rgba(255,255,255,0.25);
      color: white;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Upload Dashboard */
    .upload-dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .dashboard-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 24px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-left: 4px solid;
    }

    .dashboard-card.total {
      border-left-color: #1e90ff;
    }

    .dashboard-card.pending {
      border-left-color: #ffa726;
    }

    .dashboard-card.approved {
      border-left-color: #66bb6a;
    }

    .dashboard-card .card-icon {
      font-size: 36px;
    }

    .dashboard-card .card-info {
      flex: 1;
    }

    .dashboard-card .card-value {
      font-size: 32px;
      font-weight: 700;
      color: #222;
      line-height: 1;
    }

    .dashboard-card .card-label {
      font-size: 14px;
      color: #888;
      margin-top: 4px;
    }

    /* Approval Stage Badge */
    .approval-stage {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .approval-stage.stage-onboarded {
      background: #fff3e0;
      color: #e65100;
    }

    .approval-stage.stage-hotw {
      background: #e3f2fd;
      color: #1565c0;
    }

    .approval-stage.stage-r21 {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .approval-stage.stage-approved {
      background: linear-gradient(135deg, #4caf50, #81c784);
      color: white;
    }

    .approval-stage.stage-rejected {
      background: #ffebee;
      color: #c62828;
    }

    .approval-stage.stage-pending {
      background: #f5f5f5;
      color: #757575;
    }

    .approval-stage .stage-icon {
      font-size: 14px;
    }

    /* Uploaded Product Card */
    .uploaded-product-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: white;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .uploaded-product-card:hover {
      background: #fafafa;
    }

    .uploaded-product-card:last-child {
      border-bottom: none;
    }

    .uploaded-product-card .product-thumb {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: #f0f0f0;
    }

    .uploaded-product-card .product-info {
      flex: 1;
      min-width: 0;
    }

    .uploaded-product-card .product-title {
      font-size: 14px;
      font-weight: 600;
      color: #222;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .uploaded-product-card .product-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #888;
    }

    .uploaded-product-card .quote-id {
      color: #1e90ff;
      font-weight: 500;
    }

    .uploaded-product-card .sku-stats {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .uploaded-product-card .sku-total {
      color: #333;
      font-weight: 600;
    }

    .uploaded-product-card .sku-pending {
      color: #f59e0b;
    }

    .uploaded-product-card .sku-approved {
      color: #10b981;
    }

    .uploaded-product-card .sku-rejected {
      color: #ef4444;
    }

    .uploaded-product-card .sku-unchecked {
      color: #9ca3af;
      font-size: 11px;
      font-style: italic;
    }

    .uploaded-product-card .product-quote {
      font-size: 11px;
      color: #1e90ff;
      margin-top: 4px;
    }

    .uploaded-product-card .product-stage-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 120px;
    }

    .uploaded-product-card .stage-progress {
      font-size: 11px;
      color: #888;
    }

    /* Status Badge in Table */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.collected {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.uploaded {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.edited {
      background: #e0e7ff;
      color: #3730a3;
    }

    .status-badge.manual_pending {
      background: #fef3c7;
      color: #b45309;
      border: 1px dashed #f59e0b;
    }
    .status-badge.ai_completed {
      background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
      color: #6d28d9;
      font-weight: 600;
    }

    /* AI Progress Modal */
    .ai-progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .ai-progress-overlay.active {
      display: flex;
    }
    .ai-progress-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }
    .ai-progress-header {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ai-progress-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .ai-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .ai-progress-body {
      padding: 20px 24px;
      max-height: 400px;
      overflow-y: auto;
    }
    .ai-progress-status {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ai-progress-bar-container {
      background: #e5e7eb;
      border-radius: 8px;
      height: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .ai-progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      border-radius: 8px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .ai-progress-logs {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      color: #555;
      max-height: 250px;
      overflow-y: auto;
    }
    .ai-log-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .ai-log-item:last-child {
      border-bottom: none;
    }
    .ai-log-time {
      color: #9ca3af;
      font-size: 11px;
      white-space: nowrap;
    }
    .ai-log-message {
      flex: 1;
    }
    .ai-log-success {
      color: #10b981;
    }
    .ai-log-error {
      color: #ef4444;
    }
    .ai-log-info {
      color: #6366f1;
    }
    .ai-progress-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }
    .ai-progress-footer p {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }
    .btn-close-modal {
      margin-top: 12px;
      padding: 10px 32px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-close-modal:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3);
    }
    .ai-spinner.complete {
      border: none;
      animation: none;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <!-- AI Progress Modal -->
  <div class="ai-progress-overlay" id="aiProgressOverlay">
    <div class="ai-progress-modal">
      <div class="ai-progress-header">
        <div class="ai-spinner" id="aiSpinner"></div>
        <h3>ü§ñ AI ÏûêÎèô ÏàòÏ†ï ÏßÑÌñâÏ§ë</h3>
      </div>
      <div class="ai-progress-body">
        <div class="ai-progress-status">
          <span id="aiProgressStatusText">Ï§ÄÎπÑÏ§ë...</span>
        </div>
        <div class="ai-progress-bar-container">
          <div class="ai-progress-bar" id="aiProgressBar"></div>
        </div>
        <div class="ai-progress-logs" id="aiProgressLogs">
          <!-- Î°úÍ∑∏Í∞Ä Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê® -->
        </div>
      </div>
      <div class="ai-progress-footer" id="aiProgressFooter">
        <p id="aiProgressWarning">‚ö†Ô∏è Ï∞ΩÏùÑ Îã´ÏßÄ ÎßàÏÑ∏Ïöî. AIÍ∞Ä Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖçÏä§Ìä∏Î•º Ï≤òÎ¶¨Ï§ëÏûÖÎãàÎã§.</p>
        <button id="aiProgressCloseBtn" class="btn-close-modal" style="display: none;" onclick="closeAIProgressAndRefresh()">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Image Preview Popup -->
  <div id="imagePreviewPopup">
    <img id="imagePreviewImg" src="" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>TotalBot</h2>
      <p>Ïø†Ìå° ÏûêÎèôÌôî ÌîåÎû´Ìèº</p>
    </div>

    <div class="sidebar-menu">
      <div class="sidebar-menu-title">ÏÉÅÌíà Í¥ÄÎ¶¨</div>
      <a class="sidebar-menu-item active" href="products.html">
        <span class="menu-icon">üì¶</span>
        ÏàòÏßë ÏÉÅÌíà
      </a>
      <a class="sidebar-menu-item" href="uploaded.html">
        <span class="menu-icon">üöÄ</span>
        ÏóÖÎ°úÎìú ÏôÑÎ£å
      </a>
      <a class="sidebar-menu-item" href="quotations.html">
        <span class="menu-icon">üìã</span>
        Í≤¨Ï†ÅÏÑú Í¥ÄÎ¶¨
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">Î∞úÏ£º Í¥ÄÎ¶¨</div>
      <a class="sidebar-menu-item" href="orders.html">
        <span class="menu-icon">üõí</span>
        ÏûêÎèô Î∞úÏ£º
        <span class="menu-badge">NEW</span>
      </a>
      <a class="sidebar-menu-item" href="order-list.html">
        <span class="menu-icon">üìë</span>
        Î∞úÏ£º Î¶¨Ïä§Ìä∏
      </a>
      <a class="sidebar-menu-item" href="shipments.html">
        <span class="menu-icon">üöö</span>
        Î∞∞ÏÜ° Í¥ÄÎ¶¨
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">Î∂ÑÏÑù/ÏÑ§Ï†ï</div>
      <a class="sidebar-menu-item" href="settlement.html">
        <span class="menu-icon">üí∞</span>
        Ï†ïÏÇ∞
      </a>
      <a class="sidebar-menu-item" onclick="openSettingsModal(); toggleSidebar();" style="cursor: pointer;">
        <span class="menu-icon">‚öôÔ∏è</span>
        ÏÑ§Ï†ï
      </a>
      <a class="sidebar-menu-item" onclick="logout();" style="cursor: pointer; color: #dc3545;">
        <span class="menu-icon">üö™</span>
        Î°úÍ∑∏ÏïÑÏõÉ
      </a>
    </div>
  </nav>

  <div class="header">
    <div class="header-left" style="display: flex; align-items: center; gap: 16px;">
      <button class="hamburger-btn" onclick="toggleSidebar()" title="Î©îÎâ¥">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1>ÏàòÏßë ÏÉÅÌíà</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="openBatchCategoryModal()" style="font-size: 13px; padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none;">
        üìÅ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏûêÎèô ÏàòÏßë
      </button>
      <button class="btn btn-secondary" id="coupangLoginStatus" onclick="checkCoupangLogin()"
              style="font-size: 18px; padding: 8px 12px; position: relative;"
              title="Ïø†Ìå° Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏">
        <span id="coupangLoginIcon">‚ùå</span>
        <span style="font-size: 11px; position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">Ïø†Ìå°</span>
      </button>
      <button class="btn btn-secondary" onclick="resetQvtCookies()" style="font-size: 14px; padding: 8px 12px;" title="Ïø†Ìå° QVT Ïø†ÌÇ§ Î¶¨ÏÖã">üîÑ QVT</button>
      <button class="btn btn-secondary" onclick="openSettingsModal()" style="font-size: 18px; padding: 8px 12px;">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- ÌîåÎ°úÌåÖ Ïï°ÏÖò Î≤ÑÌäº (Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ†ÌÉù Ïãú ÌëúÏãú) -->
  <div class="floating-actions" id="floatingActions">
    <div class="floating-pill">
      <span class="selected-badge" id="selectedCountText">0Í∞ú</span>
      <button class="action-btn" onclick="processAIAutoEdit()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">ü§ñ AI ÏûêÎèô ÏàòÏ†ï</button>
      <button class="action-btn btn-delete" onclick="deleteSelected()">üóëÔ∏è ÏÇ≠Ï†ú</button>
      <button class="action-btn btn-quote" onclick="generateQuote()">üöÄ Ï†úÌíà Îì±Î°ù</button>
      <button class="action-btn" onclick="showDirectQuoteIdInput()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üìù ID ÏûÖÎ†•</button>
    </div>
  </div>

  <div class="container">
    <!-- ÏàòÏßë ÏÉÅÌíà Î™©Î°ù -->
    <div class="products-section">
      <div class="section-header">
        <h2>ÏàòÏßëÎêú ÏÉÅÌíà Î™©Î°ù <span id="productCount" style="font-weight: normal; color: #888;"></span></h2>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ÏÉÅÌíàÎ™ÖÏúºÎ°ú Í≤ÄÏÉâ..." onkeyup="filterProducts()">
          <button class="btn btn-secondary btn-sm" onclick="loadProducts()">ÏÉàÎ°úÍ≥†Ïπ®</button>
        </div>
      </div>
      <div id="productsContainer">
        <div class="loading">ÏÉÅÌíà Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      </div>
    </div>
  </div>

  <!-- ÏÑ§Ï†ï Î™®Îã¨ -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2>‚öôÔ∏è TotalBot ÏÑ§Ï†ï</h2>
        <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
      </div>

      <!-- ÏÑ§Ï†ï Î©îÏù∏ ÌÉ≠ -->
      <div class="settings-main-tabs">
        <button class="settings-main-tab" onclick="switchMainSettingsTab('info')">Ï†ïÎ≥¥ ÏÑ§Ï†ï</button>
        <button class="settings-main-tab active" onclick="switchMainSettingsTab('price')">Í∞ÄÍ≤© ÏÑ§Ï†ï</button>
        <button class="settings-main-tab" onclick="switchMainSettingsTab('quotation')">Í≤¨Ï†ÅÏÑú ÏñëÏãù</button>
        <button class="settings-main-tab" onclick="switchMainSettingsTab('template')">ÌÖúÌîåÎ¶ø ÏÑ§Ï†ï</button>
      </div>

      <div class="settings-body">
        <!-- Ï†ïÎ≥¥ ÏÑ§Ï†ï ÌÉ≠ -->
        <div id="info-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>Ïø†Ìå° Í≥ÑÏ†ï Ï†ïÎ≥¥</h3>
            <div class="settings-grid">
              <div class="settings-field">
                <label>Ïø†Ìå° ÏïÑÏù¥Îîî</label>
                <input type="text" id="settingsCoupangId" placeholder="Ïø†Ìå° ÏïÑÏù¥Îîî ÏûÖÎ†•">
              </div>
              <div class="settings-field">
                <label>Ïø†Ìå° ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                <input type="password" id="settingsCoupangPassword" placeholder="Ïø†Ìå° ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>Î∞òÌíà/ÍµêÌôò Ï£ºÏÜå</h3>
            <div class="settings-field">
              <label>Ï£ºÏÜå</label>
              <input type="text" id="settingsAddress" placeholder="Î∞òÌíà/ÍµêÌôò Ï£ºÏÜå ÏûÖÎ†•">
            </div>
          </div>

          <div class="settings-section">
            <h3>Î∏åÎûúÎìú Ï†ïÎ≥¥</h3>
            <div class="settings-field">
              <label>Î∏åÎûúÎìúÎ™Ö</label>
              <input type="text" id="settingsBrandName" placeholder="Î∏åÎûúÎìúÎ™Ö ÏûÖÎ†• (Í≤¨Ï†ÅÏÑúÏóê ÏÇ¨Ïö©Îê®)">
            </div>
          </div>

          <div class="settings-section">
            <h3>Îã§Ïö¥Î°úÎìú ÏÑ§Ï†ï</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              Í≤¨Ï†ÅÏÑú ZIP ÌååÏùºÏùò Ï†ÄÏû• ÏúÑÏπòÎ•º Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§. Îã§Ïùå Îã§Ïö¥Î°úÎìú Ïãú Ï†ÄÏû• ÏúÑÏπòÎ•º Îã§Ïãú ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.
            </p>
            <button class="btn btn-secondary" onclick="resetDownloadPath()">Ï†ÄÏû• ÏúÑÏπò Ï¥àÍ∏∞Ìôî</button>
          </div>
        </div>

        <!-- Í∞ÄÍ≤© ÏÑ§Ï†ï ÌÉ≠ -->
        <div id="price-main-settings-tab" class="settings-main-tab-content active">
          <!-- Í∏∞Î≥∏ ÏÑ§Ï†ï -->
          <div class="settings-section">
            <h3>Í∏∞Î≥∏ ÏÑ§Ï†ï</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label>ÌôòÏú® (CNY ‚Üí KRW)</label>
              <input type="number" id="settingsExchangeRate" value="190" step="1">
            </div>
            <div class="settings-field">
              <label>Í∞úÎãπÌè¨Ïû• ÎπÑÏö© (Ïõê)</label>
              <input type="number" id="settingsPackagingCost" value="500" step="100">
            </div>
            <div class="settings-field">
              <label>ÏâΩÎ®ºÌä∏ ÎπÑÏö© (Ïõê)</label>
              <input type="number" id="settingsShipmentCost" value="0" step="100">
            </div>
            <div class="settings-field">
              <label>Ïø†Ìå° ÏµúÏÜå ÎßàÏßÑÍ∏à (Ïõê)</label>
              <input type="number" id="settingsMinMargin" value="3000" step="100">
            </div>
          </div>
        </div>

        <!-- ÎßàÏßÑ ÏÑ§Ï†ï -->
        <div class="settings-section">
          <h3>ÎßàÏßÑ ÏÑ§Ï†ï</h3>

          <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('supply')">Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ</button>
            <button class="settings-tab" onclick="switchSettingsTab('sale')">ÌåêÎß§Í∞Ä ÎßàÏßÑ</button>
          </div>

          <!-- Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ ÌÉ≠ -->
          <div id="supply-settings-tab" class="settings-tab-content active">
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ÏõêÍ∞Ä Íµ¨Í∞ÑÎ≥ÑÎ°ú Í≥µÍ∏âÍ∞Ä ÎßàÏßÑÏú®ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§. ÎÇÆÏùÄ Í∏àÏï°Î∂ÄÌÑ∞ ÏàúÏÑúÎåÄÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
            </p>
            <div class="margin-rows-container" id="supplyMarginRows">
              <!-- Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ ÌñâÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
            </div>
            <div class="margin-actions">
              <button class="btn btn-primary btn-sm" onclick="addSupplyMarginRow()">+ Ìñâ Ï∂îÍ∞Ä</button>
              <button class="btn btn-secondary btn-sm" onclick="sortSupplyMarginRows()">Ï†ïÎ†¨</button>
              <button class="btn btn-secondary btn-sm" onclick="clearSupplyMarginRows()">Î™®Îëê ÏÇ≠Ï†ú</button>
            </div>
          </div>

          <!-- ÌåêÎß§Í∞Ä ÎßàÏßÑ ÌÉ≠ -->
          <div id="sale-settings-tab" class="settings-tab-content">
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              Í≥µÍ∏âÍ∞Ä Íµ¨Í∞ÑÎ≥ÑÎ°ú ÌåêÎß§Í∞Ä ÎßàÏßÑÏú®ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§. ÎÇÆÏùÄ Í∏àÏï°Î∂ÄÌÑ∞ ÏàúÏÑúÎåÄÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
            </p>
            <div class="margin-rows-container" id="saleMarginRows">
              <!-- ÌåêÎß§Í∞Ä ÎßàÏßÑ ÌñâÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
            </div>
            <div class="margin-actions">
              <button class="btn btn-primary btn-sm" onclick="addSaleMarginRow()">+ Ìñâ Ï∂îÍ∞Ä</button>
              <button class="btn btn-secondary btn-sm" onclick="sortSaleMarginRows()">Ï†ïÎ†¨</button>
              <button class="btn btn-secondary btn-sm" onclick="clearSaleMarginRows()">Î™®Îëê ÏÇ≠Ï†ú</button>
            </div>
          </div>
        </div>
        </div>

        <!-- ÌÖúÌîåÎ¶ø ÏÑ§Ï†ï ÌÉ≠ -->
        <div id="template-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ</h3>
            <div class="settings-field">
              <label>Î∏åÎûúÎìú ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ</label>
              <input type="file" id="brandImageInput" accept="image/*" onchange="handleBrandImageUpload(event)" style="margin-bottom: 8px;">
              <div id="brandImagePreview" style="display: none; margin-top: 12px;">
                <img id="brandImagePreviewImg" src="" alt="ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞" style="max-width: 300px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Í∏∞Î≥∏ Íµ¨ÏÑ± ÏÑ§Ï†ï</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÏóê Í∏∞Î≥∏ÏúºÎ°ú ÌëúÏãúÎê† Ìï≠Î™©Îì§ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§. ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌïòÍ±∞ÎÇò ÌÖçÏä§Ìä∏Î•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.
            </p>
            <div id="defaultDetailTemplateContainer"></div>
            <button class="btn btn-primary btn-sm" onclick="addDefaultTemplateText()" style="margin-top: 12px;">+ ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä</button>
            <button class="btn btn-secondary btn-sm" onclick="resetDefaultTemplate()" style="margin-top: 12px;">Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã</button>
          </div>

          <div class="settings-section">
            <h3>ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠ Í∏∞Î≥∏ ÎÇ¥Ïö©</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠Ïóê Í∏∞Î≥∏ÏúºÎ°ú ÌëúÏãúÎê† ÌñâÎì§ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§.
            </p>
            <div id="defaultQualityRowsContainer"></div>
            <button class="btn btn-primary btn-sm" onclick="addDefaultQualityRow()" style="margin-top: 12px;">+ Ìñâ Ï∂îÍ∞Ä</button>
          </div>

        </div>

        <!-- Í≤¨Ï†ÅÏÑú ÏñëÏãù ÌÉ≠ -->
        <div id="quotation-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>Í≤¨Ï†ÅÏÑú ÏûëÏÑ± ÏñëÏãù</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              Ïø†Ìå° Í≤¨Ï†ÅÏÑú Excel ÌååÏùºÏóê ÏûêÎèôÏúºÎ°ú ÏûëÏÑ±Îê† ÎÇ¥Ïö©ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§.<br>
              <strong>ÌäπÏàò Ìï≠Î™©</strong> (Í≤ÄÏÉâÌÉúÍ∑∏, Í≥µÍ∏âÍ∞Ä, ÌåêÎß§Í∞Ä, Î∏åÎûúÎìú Îì±)ÏùÄ ÏûêÎèôÏúºÎ°ú Ï≤òÎ¶¨ÎêòÎ©∞ Ïó¨Í∏∞Ïóê ÌëúÏãúÎêòÏßÄ ÏïäÏäµÎãàÎã§.
            </p>
            <div id="quotationMappingContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; background: #fafafa;"></div>
            <button class="btn btn-primary btn-sm" onclick="addQuotationMapping()" style="margin-top: 12px;">+ Îß§Ìïë Ï∂îÍ∞Ä</button>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">Ï∑®ÏÜå</button>
        <button class="btn btn-success" onclick="saveSettings()">Ï†ÄÏû•</button>
      </div>
    </div>
  </div>

  <script>
    // Î≤ÑÏ†Ñ ÌôïÏù∏Ïö© (Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãú ÌôïÏù∏)
    console.log('üîÑ TotalBot Products Î≤ÑÏ†Ñ: 2025-11-29-v5-AUTH (Ïù∏Ï¶ù Ï∂îÍ∞Ä)');
    console.log('‚úÖ ÏµúÏã† Î≤ÑÏ†ÑÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');

    // ===== Ïù∏Ï¶ù Í¥ÄÎ†® Ìï®Ïàò =====
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function getUserInfo() {
      const info = localStorage.getItem('userInfo');
      return info ? JSON.parse(info) : null;
    }

    function checkAuth() {
      const token = getAuthToken();
      if (!token) {
        // Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    async function authFetch(url, options = {}) {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        throw new Error('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      }

      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
      };

      const response = await fetch(url, { ...options, headers });

      // 401 ÏóêÎü¨Î©¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú
      if (response.status === 401) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
        throw new Error('ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.');
      }

      return response;
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïù∏Ï¶ù Ï≤¥ÌÅ¨
    if (!checkAuth()) {
      throw new Error('Ïù∏Ï¶ù ÌïÑÏöî');
    }

    // ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Ìï®Ïàò
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Î°úÍ∑∏ÏïÑÏõÉ
    function logout() {
      if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('userName');
        window.location.href = '/login.html';
      }
    }

    // Ïù¥ÎØ∏ÏßÄ Ìò∏Î≤Ñ ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
    function showImagePreview(event) {
      const img = event.target;
      const previewSrc = img.dataset.preview;

      // Í∏∞Î≥∏ placeholder Ïù¥ÎØ∏ÏßÄÏù∏ Í≤ΩÏö∞ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏïàÌï®
      if (!previewSrc || previewSrc.includes('data:image/svg+xml')) return;

      const popup = document.getElementById('imagePreviewPopup');
      const previewImg = document.getElementById('imagePreviewImg');

      previewImg.src = previewSrc;

      // Ïù¥ÎØ∏ÏßÄ ÏúÑÏπò Í≥ÑÏÇ∞ (Ïù¥ÎØ∏ÏßÄ Ïò§Î•∏Ï™ΩÏóê ÌëúÏãú)
      const rect = img.getBoundingClientRect();
      let left = rect.right + 10;
      let top = rect.top + (rect.height / 2) - 140; // ÎØ∏Î¶¨Î≥¥Í∏∞ ÎÜíÏù¥Ïùò Ï†àÎ∞ò

      // ÌôîÎ©¥ Ïò§Î•∏Ï™Ω Î≤óÏñ¥ÎÇòÎ©¥ ÏôºÏ™ΩÏóê ÌëúÏãú
      if (left + 280 > window.innerWidth) {
        left = rect.left - 290;
      }

      // ÌôîÎ©¥ ÏúÑ/ÏïÑÎûò Î≤óÏñ¥ÎÇòÎ©¥ Ï°∞Ï†ï
      if (top < 10) top = 10;
      if (top + 280 > window.innerHeight - 10) {
        top = window.innerHeight - 290;
      }

      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
      popup.classList.add('visible');
    }

    // Ïù¥ÎØ∏ÏßÄ Ìò∏Î≤Ñ ÎØ∏Î¶¨Î≥¥Í∏∞ Ïà®Í∏∞Í∏∞
    function hideImagePreview() {
      const popup = document.getElementById('imagePreviewPopup');
      popup.classList.remove('visible');
    }

    // ESC ÌÇ§Î°ú ÏÇ¨Ïù¥ÎìúÎ∞î Îã´Í∏∞
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    });

    // Toast ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Ïø†Ìå° ÏäπÏù∏ ÏÉÅÌÉú ÌôïÏù∏ Ìï®Ïàò
    async function checkApprovalStatus() {
      const btn = event?.target || document.querySelector('.btn-info');
      const originalText = btn?.textContent || 'üîç ÏäπÏù∏ ÌôïÏù∏';

      try {
        btn.disabled = true;
        btn.textContent = 'ÌôïÏù∏ Ï§ë...';
        showToast('ÏäπÏù∏ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...', 'info');

        // ÏóÖÎ°úÎìúÎê® ÏÉÅÌÉúÏùò ÏÉÅÌíà Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        const response = await authFetch('/api/products/list');
        const data = await response.json();

        if (!data.success) {
          throw new Error('ÏÉÅÌíà Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
        }

        const uploadedProducts = data.products.filter(p =>
          p.status === 'uploaded' && p.quoteId
        );

        if (uploadedProducts.length === 0) {
          showToast('ÌôïÏù∏Ìï† ÏóÖÎ°úÎìúÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§', 'warning');
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        // ÏùëÎãµ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï (Ìïú Î≤àÎßå Ïã§Ìñâ)
        const responseHandler = (event) => {
          if (event.data && event.data.source === 'totalbot-extension-response' &&
              event.data.originalAction === 'checkApprovalNow') {
            window.removeEventListener('message', responseHandler);

            const response = event.data.response;
            btn.disabled = false;
            btn.textContent = originalText;

            if (response && response.success) {
              const result = response.result;
              const skipped = result.skippedCount || 0;

              if (result.approvedCount > 0) {
                showToast(`${result.approvedCount}Í∞ú ÏÉÅÌíàÏù¥ ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§!`, 'success', 5000);
              } else if (result.checkedCount > 0) {
                let msg = `${result.checkedCount}Í∞ú Í≤¨Ï†ÅÏÑú ÌôïÏù∏ ÏôÑÎ£å.`;
                if (skipped > 0) {
                  msg += ` (${skipped}Í∞ú Í±¥ÎÑàÎúÄ: Î∞òÎ†§/ÏäπÏù∏ ÏôÑÎ£å)`;
                }
                showToast(msg, 'info');
              } else if (skipped > 0) {
                showToast(`Î™®Îì† ÏÉÅÌíàÏù¥ Ïã¨ÏÇ¨ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§ (${skipped}Í∞ú Í±¥ÎÑàÎúÄ)`, 'info');
              } else {
                showToast('ÌôïÏù∏Ìï† Í≤¨Ï†ÅÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§', 'warning');
              }
              // Í≤∞Í≥ºÏóê Í¥ÄÍ≥ÑÏóÜÏù¥ SKU Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏúºÎØÄÎ°ú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
              if (result.checkedCount > 0) {
                loadProducts();
              }
            } else {
              const errorMsg = response?.error || 'ÏäπÏù∏ ÌôïÏù∏ Ïã§Ìå®';
              showToast(errorMsg, 'error');
            }
          }
        };

        window.addEventListener('message', responseHandler);

        // ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï (30Ï¥à)
        setTimeout(() => {
          window.removeEventListener('message', responseHandler);
          if (btn.disabled) {
            btn.disabled = false;
            btn.textContent = originalText;
            showToast('ÏùëÎãµ ÏãúÍ∞Ñ Ï¥àÍ≥º. Ïø†Ìå° ÌéòÏù¥ÏßÄÍ∞Ä Ïó¥Î†§ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.', 'error');
          }
        }, 30000);

        // Chrome ExtensionÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ° (postMessage ÏÇ¨Ïö©)
        window.postMessage({
          source: 'totalbot-page',
          action: 'checkApprovalNow',
          products: uploadedProducts
        }, '*');

      } catch (error) {
        console.error('ÏäπÏù∏ ÌôïÏù∏ Ïò§Î•ò:', error);
        showToast('ÏäπÏù∏ ÌôïÏù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    let allProducts = [];
    let selectedProducts = new Set();
    let currentTab = 'collected';

    // ÏÉÅÌÉú ÎùºÎ≤® Î∞òÌôò
    function getStatusLabel(status, isEdited) {
      // Ìé∏Ïßë ÏôÑÎ£å ÏÉÅÌÉú Ïö∞ÏÑ† ÌëúÏãú
      if (isEdited && status === 'collected') {
        return 'Ìé∏ÏßëÏôÑÎ£å';
      }
      const labels = {
        'collected': 'ÏàòÏßëÎê®',
        'uploaded': 'Ïã¨ÏÇ¨Ï§ë',
        'approved': 'ÏäπÏù∏ÏôÑÎ£å',
        'manual_pending': 'ID Îì±Î°ù ÎåÄÍ∏∞',
        'ai_completed': 'AI ÏàòÏ†ïÏôÑÎ£å'
      };
      return labels[status] || 'ÏàòÏßëÎê®';
    }

    // Î©îÏù∏ ÌÉ≠ Ï†ÑÌôò
    function switchMainTab(tab) {
      currentTab = tab;

      // ÌÉ≠ Î≤ÑÌäº ÌôúÏÑ±Ìôî
      document.querySelectorAll('.main-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });

      // ÌÉ≠ ÎÇ¥Ïö© ÌëúÏãú
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tab}-tab-content`).classList.add('active');

      // Ìï¥Îãπ ÌÉ≠Ïùò ÏÉÅÌíà Î†åÎçîÎßÅ
      if (tab === 'collected') {
        const collectedProducts = allProducts.filter(p => (p.status || 'collected') === 'collected');
        renderProducts(collectedProducts);
      } else {
        renderUploadedProducts();
      }
    }

    // ÌÉ≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    function updateTabCounts() {
      const collectedCount = allProducts.filter(p => (p.status || 'collected') === 'collected').length;
      const uploadedCount = allProducts.filter(p => p.status === 'uploaded' || p.status === 'approved').length;

      document.getElementById('tab-count-collected').textContent = collectedCount;
      document.getElementById('tab-count-uploaded').textContent = uploadedCount;

      // ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
      updateUploadDashboard();
    }

    // ÏóÖÎ°úÎìú ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏ (Ïã§Ï†ú API Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
    function updateUploadDashboard() {
      const uploadedProducts = allProducts.filter(p => p.status === 'uploaded' || p.status === 'approved');

      // Ïã§Ï†ú SKU Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ
      let totalSku = 0;
      let pendingSku = 0;
      let approvedSku = 0;

      uploadedProducts.forEach(p => {
        if (p.skuStatus) {
          // APIÏóêÏÑú Î∞õÏùÄ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞
          totalSku += p.skuStatus.totalSku || 0;
          pendingSku += p.skuStatus.pending || 0;
          approvedSku += p.skuStatus.approved || 0;
        }
      });

      // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉÅÌíà ÏàòÎ°ú ÌëúÏãú (ÏïÑÏßÅ ÌôïÏù∏ Ïïà Îê®)
      const checkedProducts = uploadedProducts.filter(p => p.skuStatus).length;
      const uncheckedProducts = uploadedProducts.length - checkedProducts;

      document.getElementById('dash-total-sku').textContent = totalSku > 0 ? totalSku : (uncheckedProducts > 0 ? `${uncheckedProducts}Í∞ú ÎØ∏ÌôïÏù∏` : '0');
      document.getElementById('dash-pending-count').textContent = pendingSku;
      document.getElementById('dash-approved-count').textContent = approvedSku;
    }

    // ÏäπÏù∏ Îã®Í≥Ñ Î±ÉÏßÄ ÏÉùÏÑ±
    function getApprovalStageBadge(product) {
      const status = product.status;
      const skuStatus = product.skuStatus;
      const approvalStage = skuStatus?.currentStage || product.approvalStage;

      if (status === 'approved') {
        return `<span class="approval-stage stage-approved">
          <span class="stage-icon">‚úì</span> ÏäπÏù∏ÏôÑÎ£å
        </span>`;
      }

      if (product.isRejected || (skuStatus && skuStatus.rejected > 0)) {
        return `<span class="approval-stage stage-rejected">
          <span class="stage-icon">‚úó</span> Î∞òÎ†§
        </span>`;
      }

      // Ïã¨ÏÇ¨ Îã®Í≥ÑÎ≥Ñ
      if (approvalStage === 'R21') {
        return `<span class="approval-stage stage-r21">
          <span class="stage-icon">üìã</span> Î∞úÏ£ºÏÑúÎ∞úÌñâ
        </span>`;
      } else if (approvalStage === 'HOTW') {
        return `<span class="approval-stage stage-hotw">
          <span class="stage-icon">üì¶</span> ÏÉÅÌíàÏ†ïÎ≥¥
        </span>`;
      } else if (approvalStage === 'ONBOARDED') {
        return `<span class="approval-stage stage-onboarded">
          <span class="stage-icon">üí∞</span> Í∞ÄÍ≤©/Ï†ïÏ±Ö
        </span>`;
      }

      // ÏïÑÏßÅ ÌôïÏù∏ Ïïà Îê®
      if (!skuStatus) {
        return `<span class="approval-stage stage-pending">
          <span class="stage-icon">‚ùì</span> ÎØ∏ÌôïÏù∏
        </span>`;
      }

      // Í∏∞Î≥∏: Ïã¨ÏÇ¨Ï§ë
      return `<span class="approval-stage stage-pending">
        <span class="stage-icon">‚è≥</span> Ïã¨ÏÇ¨ÎåÄÍ∏∞
      </span>`;
    }

    // ÏóÖÎ°úÎìúÎêú ÏÉÅÌíà Î™©Î°ù Î†åÎçîÎßÅ
    function renderUploadedProducts() {
      const container = document.getElementById('uploadedProductsContainer');
      const uploadedProducts = allProducts.filter(p => p.status === 'uploaded' || p.status === 'approved');

      if (uploadedProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üöÄ</div>
            <p>ÏïÑÏßÅ ÏóÖÎ°úÎìúÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</p>
            <p style="font-size: 13px; color: #888;">ÏàòÏßë ÏÉÅÌíàÏùÑ Ïø†Ìå°Ïóê ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.</p>
          </div>
        `;
        return;
      }

      const html = uploadedProducts.map(product => {
        const mainImage = product.mainImages?.[0] || product.images?.[0] || '';
        const quoteId = product.quoteId || '-';

        // SKU Ï†ïÎ≥¥ Í≥ÑÏÇ∞
        const skuInfo = getSkuInfo(product);

        // SKU ÏÉÅÌÉú ÌëúÏãú (Îç∞Ïù¥ÌÑ∞ Ïú†Î¨¥Ïóê Îî∞Îùº Îã§Î•¥Í≤å)
        let skuStatsHtml;
        if (skuInfo.hasData) {
          skuStatsHtml = `
            <span class="sku-stats">
              <span class="sku-total">${skuInfo.total}Í∞ú SKU</span>
              ${skuInfo.pending > 0 ? `<span class="sku-pending">¬∑ ${skuInfo.pending}Í∞ú Ïã¨ÏÇ¨Ï§ë</span>` : ''}
              ${skuInfo.approved > 0 ? `<span class="sku-approved">¬∑ ${skuInfo.approved}Í∞ú ÏäπÏù∏</span>` : ''}
              ${skuInfo.rejected > 0 ? `<span class="sku-rejected">¬∑ ${skuInfo.rejected}Í∞ú Î∞òÎ†§</span>` : ''}
            </span>
          `;
        } else {
          skuStatsHtml = `
            <span class="sku-stats">
              <span class="sku-unchecked">üîç ÏäπÏù∏ ÌôïÏù∏ Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</span>
            </span>
          `;
        }

        return `
          <div class="uploaded-product-card" onclick="showProductDetail('${product.id}')">
            <img class="product-thumb" src="${mainImage}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23ccc%22>üì¶</text></svg>'">
            <div class="product-info">
              <div class="product-title">${product.title || 'Ï†úÎ™© ÏóÜÏùå'}</div>
              <div class="product-meta">
                ${skuStatsHtml}
              </div>
              <div class="product-quote">Í≤¨Ï†ÅÏÑú #${quoteId}</div>
            </div>
            <div class="product-stage-info">
              ${getApprovalStageBadge(product)}
              <div class="stage-progress">${getStageProgressText(product)}</div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // SKU Ï†ïÎ≥¥ Í≥ÑÏÇ∞ (APIÏóêÏÑú Î∞õÏùÄ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
    function getSkuInfo(product) {
      // skuStatusÍ∞Ä ÏûàÏúºÎ©¥ Ïã§Ï†ú API Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
      if (product.skuStatus) {
        return {
          total: product.skuStatus.totalSku || 0,
          pending: product.skuStatus.pending || 0,
          approved: product.skuStatus.approved || 0,
          rejected: product.skuStatus.rejected || 0,
          inProgress: product.skuStatus.inProgress || 0,
          hasData: true
        };
      }

      // skuStatusÍ∞Ä ÏóÜÏúºÎ©¥ (ÏïÑÏßÅ ÌôïÏù∏ Ïïà Îêú ÏÉÅÌíà) - Í∏∞Î≥∏Í∞í
      return {
        total: 0,
        pending: 0,
        approved: 0,
        rejected: 0,
        inProgress: 0,
        hasData: false
      };
    }

    // Ïã¨ÏÇ¨ ÏßÑÌñâ Îã®Í≥Ñ ÌÖçÏä§Ìä∏
    function getStageProgressText(product) {
      const status = product.status;
      const skuStatus = product.skuStatus;

      if (status === 'approved') {
        return 'Ïã¨ÏÇ¨ ÏôÑÎ£å';
      }

      if (product.isRejected) {
        return 'Î∞òÎ†§Îê®';
      }

      // skuStatusÍ∞Ä ÏûàÏúºÎ©¥ ÏÉÅÏÑ∏ ÏßÑÌñâÎ•† ÌëúÏãú
      if (skuStatus && skuStatus.totalSku > 0) {
        const total = skuStatus.totalSku;
        const approved = skuStatus.approved || 0;
        const stage = skuStatus.currentStage;

        if (approved === total) {
          return 'Ïã¨ÏÇ¨ ÏôÑÎ£å';
        }

        // Îã®Í≥ÑÎ≥Ñ ÏÉÅÏÑ∏
        if (stage === 'R21') {
          return `3Îã®Í≥Ñ (${skuStatus.step3Completed}/${total})`;
        } else if (stage === 'HOTW') {
          return `2Îã®Í≥Ñ (${skuStatus.step2Completed}/${total})`;
        } else if (stage === 'ONBOARDED') {
          return `1Îã®Í≥Ñ (${skuStatus.step1Completed}/${total})`;
        }

        return `Ïã¨ÏÇ¨Ï§ë ${approved}/${total}`;
      }

      // Îç∞Ïù¥ÌÑ∞ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Î©îÏãúÏßÄ
      return 'ÌôïÏù∏ ÌïÑÏöî';
    }

    // Íµ¨ Ìï®Ïàò Ìò∏Ìôò (Í∏∞Ï°¥ ÏΩîÎìúÏóêÏÑú Ìò∏Ï∂úÎê† Ïàò ÏûàÏùå)
    function updateStatusCounts() {
      updateTabCounts();
    }

    function filterByStatus(status) {
      if (status === 'collected') {
        switchMainTab('collected');
      } else {
        switchMainTab('uploaded');
      }
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÉÅÌíà Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
    window.addEventListener('load', () => {
      loadProducts();
    });

    // Îí§Î°úÍ∞ÄÍ∏∞/ÏïûÏúºÎ°úÍ∞ÄÍ∏∞Î°ú ÌéòÏù¥ÏßÄ Î≥µÏõê Ïãú ÏÉàÎ°úÍ≥†Ïπ®
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        // bfcacheÏóêÏÑú Î≥µÏõêÎêú Í≤ΩÏö∞ ÏÉÅÌíà Î™©Î°ù Îã§Ïãú Î°úÎìú
        console.log('[Products] ÌéòÏù¥ÏßÄ Î≥µÏõêÎê®, ÏÉÅÌíà Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®');
        loadProducts();
      }
    });

    // ÏÉÅÌíà Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ (ÏàòÏßë ÏÉÅÌíàÎßå)
    async function loadProducts() {
      try {
        const response = await authFetch('/api/products/list');

        if (!response.ok) {
          throw new Error('ÏÉÅÌíà Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
        }

        const data = await response.json();
        allProducts = data.products || [];

        // ÏàòÏßë ÏÉÅÌíà ÌïÑÌÑ∞ÎßÅ (collected + manual_pending + ai_completed, ÏóÖÎ°úÎìú/ÏäπÏù∏Îêú ÏÉÅÌíàÏùÄ uploaded.htmlÏóêÏÑú ÌëúÏãú)
        const collectedProducts = allProducts.filter(p => {
          const status = p.status || 'collected';
          return status === 'collected' || status === 'manual_pending' || status === 'ai_completed';
        });

        // ÏÉÅÌíà Ïàò ÌëúÏãú
        document.getElementById('productCount').textContent = `(${collectedProducts.length}Í∞ú)`;

        renderProducts(collectedProducts);
      } catch (error) {
        console.error('ÏÉÅÌíà Î°úÎìú Ïò§Î•ò:', error);
        showEmptyState('ÏÉÅÌíà Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }

    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (Ìò∏ÌôòÏö©)
    function updateStats() {
      updateTabCounts();
    }

    // ÏÉÅÌíà Î™©Î°ù Î†åÎçîÎßÅ
    function renderProducts(products) {
      const container = document.getElementById('productsContainer');

      if (!products || products.length === 0) {
        showEmptyState('ÏïÑÏßÅ ÏàòÏßëÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.<br>Chrome ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®ÏúºÎ°ú ÏÉÅÌíàÏùÑ ÏàòÏßëÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const html = `
        <table class="products-table">
          <thead>
            <tr>
              <th><input type="checkbox" class="checkbox" onchange="toggleSelectAll(this)"></th>
              <th>Ïù¥ÎØ∏ÏßÄ</th>
              <th>ÏÉÅÌíàÎ™Ö</th>
              <th>ÌîåÎû´Ìèº</th>
              <th>ÏòµÏÖò Ïàò</th>
              <th>Í∞ÄÍ≤©</th>
              <th>ÏÉÅÌÉú</th>
              <th>ÏàòÏßëÏùº</th>
              <th>ÏûëÏóÖ</th>
            </tr>
          </thead>
          <tbody>
            ${products.map((product, index) => {
              // ÎîîÎ≤ÑÍπÖ: Ï≤´ Î≤àÏß∏ ÏÉÅÌíàÏùò Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏
              if (index === 0) {
                console.log('[Products Debug] Ï≤´ Î≤àÏß∏ ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞:', {
                  mainImage: product.mainImage,
                  titleImage: product.titleImage,
                  imageLink: product.imageLink,
                  price: product.price,
                  resultsCount: product.results?.length,
                  firstResult: product.results?.[0]
                });
              }

              // Ïù¥ÎØ∏ÏßÄ Ï∂îÏ∂ú: titleImage Î∞∞Ïó¥Ïùò Ï≤´ Î≤àÏß∏ ÎòêÎäî imageLink ÏÇ¨Ïö©
              const productImage = product.mainImage ||
                                   (product.titleImage && Array.isArray(product.titleImage) ? product.titleImage[0] : null) ||
                                   product.imageLink ||
                                   (product.results && product.results[0] && product.results[0].imageLink) ||
                                   (product.results && product.results[0] && product.results[0].titleImage && product.results[0].titleImage[0]) ||
                                   '';

              // Í∞ÄÍ≤© Ï∂îÏ∂ú: results Î∞∞Ïó¥Ïùò Ï≤´ Î≤àÏß∏ Ìï≠Î™©ÏóêÏÑú Í∞ÄÍ≤© Ï∞æÍ∏∞
              const productPrice = product.price ||
                                   (product.results && product.results[0] && product.results[0].optionName2Price) ||
                                   (product.results && product.results[0] && product.results[0].price) ||
                                   '';

              const displayPrice = productPrice ? (Array.isArray(productPrice) ? productPrice[0] : productPrice) : '-';

              // ÎîîÎ≤ÑÍπÖ: Ï≤´ Î≤àÏß∏ ÏÉÅÌíàÏùò ÏµúÏ¢Ö Ïù¥ÎØ∏ÏßÄÏôÄ Í∞ÄÍ≤©
              if (index === 0) {
                console.log('[Products Debug] ÏµúÏ¢ÖÍ∞í:', {
                  productImage,
                  productPrice,
                  displayPrice
                });
              }

              return `
              <tr onclick="toggleRowCheckbox(this, '${product.id || index}')" style="cursor: pointer;">
                <td><input type="checkbox" class="checkbox" onclick="event.stopPropagation()" onchange="toggleProduct('${product.id || index}')"></td>
                <td><img src="${productImage}" class="product-image" data-preview="${productImage}" onmouseenter="showImagePreview(event)" onmouseleave="hideImagePreview()" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2214%22%3EÏù¥ÎØ∏ÏßÄ ÏóÜÏùå%3C/text%3E%3C/svg%3E'"></td>
                <td><div class="product-title" title="${product.title || product.titleCn || ''}">${product.title || product.titleCn || 'Ï†úÎ™© ÏóÜÏùå'}</div></td>
                <td>${product.url ? `<a href="${product.url}" target="_blank" rel="noopener noreferrer" class="source-link" title="${getPlatformName(product.platform)} ÏõêÎ≥∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô" onclick="event.stopPropagation()">üîó ÏõêÎ≥∏ ÎßÅÌÅ¨</a>` : `<span style="color: #999;">-</span>`}</td>
                <td>${product.resultsCount || product.results?.length || 0}Í∞ú</td>
                <td style="font-weight: bold; color: #e63946;">¬•${displayPrice}</td>
                <td><span class="status-badge ${product.isEdited && (product.status || 'collected') === 'collected' ? 'edited' : (product.status || 'collected')}">${getStatusLabel(product.status || 'collected', product.isEdited)}</span></td>
                <td>${product.savedAt ? new Date(product.savedAt).toLocaleDateString() : '-'}</td>
                <td>
                  <div class="actions">
                    <button class="btn btn-sm btn-edit" onclick="event.stopPropagation(); editProduct('${product.id || index}')">Ìé∏Ïßë</button>
                    <button class="btn btn-sm btn-delete" onclick="event.stopPropagation(); deleteProduct('${product.id || index}')">ÏÇ≠Ï†ú</button>
                  </div>
                </td>
              </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // Îπà ÏÉÅÌÉú ÌëúÏãú
    function showEmptyState(message) {
      const container = document.getElementById('productsContainer');
      container.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          <h3>${message}</h3>
        </div>
      `;
    }

    // ÌîåÎû´Ìèº Ïù¥Î¶Ñ Î≥ÄÌôò
    function getPlatformName(platform) {
      const names = {
        '1688-product': '1688',
        'coupang-product': 'Ïø†Ìå°',
        'aliexpress-product': 'ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§'
      };
      return names[platform] || platform;
    }

    // Í≤ÄÏÉâ ÌïÑÌÑ∞
    function filterProducts() {
      const query = document.getElementById('searchInput').value.toLowerCase();

      if (!query) {
        renderProducts(allProducts);
        return;
      }

      const filtered = allProducts.filter(p => {
        const title = (p.title || p.titleCn || '').toLowerCase();
        return title.includes(query);
      });

      renderProducts(filtered);
    }

    // Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú
    function toggleSelectAll(checkbox) {
      const collectedProducts = allProducts.filter(p => (p.status || 'collected') === 'collected');
      const checkboxes = document.querySelectorAll('.products-table tbody input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });

      if (checkbox.checked) {
        collectedProducts.forEach((p, i) => selectedProducts.add(p.id || i));
      } else {
        selectedProducts.clear();
      }
      updateActionBar();
    }

    // Í∞úÎ≥Ñ ÏÑ†ÌÉù
    function toggleProduct(id) {
      if (selectedProducts.has(id)) {
        selectedProducts.delete(id);
      } else {
        selectedProducts.add(id);
      }
      updateActionBar();
    }

    // Ìñâ ÌÅ¥Î¶≠ÏúºÎ°ú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä
    function toggleRowCheckbox(row, id) {
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        toggleProduct(id);
      }
    }

    // ÌîåÎ°úÌåÖ Ïï°ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
    function updateActionBar() {
      const floatingActions = document.getElementById('floatingActions');
      const countText = document.getElementById('selectedCountText');
      const count = selectedProducts.size;

      if (count > 0) {
        floatingActions.classList.add('active');
        countText.textContent = `${count}Í∞ú`;
      } else {
        floatingActions.classList.remove('active');
      }
    }

    // ÏÑ†ÌÉù Ìï¥Ï†ú
    function clearSelection() {
      selectedProducts.clear();
      const checkboxes = document.querySelectorAll('.products-table input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateActionBar();
    }

    // ÏÉÅÌíà Ìé∏Ïßë
    function editProduct(id) {
      window.location.href = `/editor-options.html?id=${id}`;
    }

    // ÏÉÅÌíà ÏÇ≠Ï†ú
    async function deleteProduct(id) {
      if (!confirm('Ïù¥ ÏÉÅÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        return;
      }

      try {
        const response = await authFetch(`/api/products/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
          loadProducts();
        } else {
          throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®');
        }
      } catch (error) {
        console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', error);
        alert('ÏÉÅÌíà ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }

    // AI Progress Modal Ìó¨Ìçº Ìï®ÏàòÎì§
    function showAIProgressModal() {
      console.log('[AI Progress] showAIProgressModal Ìò∏Ï∂úÎê®');
      const overlay = document.getElementById('aiProgressOverlay');
      console.log('[AI Progress] overlay ÏöîÏÜå:', overlay);

      if (!overlay) {
        console.error('[AI Progress] aiProgressOverlay ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
        return;
      }

      const logs = document.getElementById('aiProgressLogs');
      const bar = document.getElementById('aiProgressBar');
      const status = document.getElementById('aiProgressStatusText');

      // Ï¥àÍ∏∞Ìôî
      logs.innerHTML = '';
      bar.style.width = '0%';
      status.textContent = 'Ï§ÄÎπÑÏ§ë...';
      overlay.classList.add('active');
      console.log('[AI Progress] active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞ÄÎê®, display:', window.getComputedStyle(overlay).display);
    }

    function hideAIProgressModal() {
      const overlay = document.getElementById('aiProgressOverlay');
      overlay.classList.remove('active');

      // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      const spinner = document.getElementById('aiSpinner');
      const warning = document.getElementById('aiProgressWarning');
      const closeBtn = document.getElementById('aiProgressCloseBtn');

      spinner.classList.remove('complete');
      spinner.innerHTML = '';
      warning.style.display = 'block';
      closeBtn.style.display = 'none';
    }

    function showAIProgressComplete(success = true) {
      const spinner = document.getElementById('aiSpinner');
      const warning = document.getElementById('aiProgressWarning');
      const closeBtn = document.getElementById('aiProgressCloseBtn');

      spinner.classList.add('complete');
      spinner.innerHTML = success ? '‚úÖ' : '‚ö†Ô∏è';
      warning.style.display = 'none';
      closeBtn.style.display = 'inline-block';
    }

    let aiProgressCallback = null;

    function closeAIProgressAndRefresh() {
      hideAIProgressModal();
      if (aiProgressCallback) {
        aiProgressCallback();
        aiProgressCallback = null;
      }
    }

    function updateAIProgress(percent, statusText) {
      const bar = document.getElementById('aiProgressBar');
      const status = document.getElementById('aiProgressStatusText');
      bar.style.width = `${percent}%`;
      status.textContent = statusText;
    }

    function addAILog(message, type = 'info') {
      const logs = document.getElementById('aiProgressLogs');
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      const logItem = document.createElement('div');
      logItem.className = 'ai-log-item';
      logItem.innerHTML = `
        <span class="ai-log-time">${timeStr}</span>
        <span class="ai-log-message ai-log-${type}">${message}</span>
      `;
      logs.appendChild(logItem);
      logs.scrollTop = logs.scrollHeight;
    }

    // AI ÏûêÎèô Ï†úÌíà ÏàòÏ†ï
    async function processAIAutoEdit() {
      if (selectedProducts.size === 0) {
        showToast('AI ÏàòÏ†ïÌï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
        return;
      }

      if (!confirm(`ÏÑ†ÌÉùÌïú ${selectedProducts.size}Í∞ú ÏÉÅÌíàÏùÑ AIÎ°ú ÏûêÎèô ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏàòÏ†ï ÎÇ¥Ïö©:\n- ÏÉÅÌíàÎ™Ö AI ÏûêÎèô ÏÉùÏÑ±\n- ÏòµÏÖò Ïù¥ÎØ∏ÏßÄ ‚Üí Ìù∞ Î∞∞Í≤Ω Ï†úÌíà Ïù¥ÎØ∏ÏßÄ\n- Ï∂îÍ∞Ä Ïù¥ÎØ∏ÏßÄ ‚Üí Ïó∞Ï∂ú Ïù¥ÎØ∏ÏßÄ\n- ÏòµÏÖòÎ™Ö AI Î≥ÄÌôò\n- ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏûêÎèô Íµ¨ÏÑ±\n- ÏÉÅÌÉúÎ•º 'AI ÏàòÏ†ïÏôÑÎ£å'Î°ú Î≥ÄÍ≤Ω`)) {
        return;
      }

      const productIds = Array.from(selectedProducts);
      let successCount = 0;
      let failCount = 0;

      // Î™®Îã¨ ÌëúÏãú
      showAIProgressModal();
      addAILog(`Ï¥ù ${productIds.length}Í∞ú ÏÉÅÌíà AI ÏûêÎèô ÏàòÏ†ï ÏãúÏûë`, 'info');

      for (let i = 0; i < productIds.length; i++) {
        const productId = productIds[i];
        const progress = Math.round(((i) / productIds.length) * 100);

        updateAIProgress(progress, `ÏÉÅÌíà Ï≤òÎ¶¨ Ï§ë... (${i + 1}/${productIds.length})`);
        addAILog(`[${i + 1}/${productIds.length}] ÏÉÅÌíà ID: ${productId} Ï≤òÎ¶¨ ÏãúÏûë...`, 'info');

        try {
          const response = await authFetch(`/api/products/${productId}/ai-auto-edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const result = await response.json();

          if (result.success) {
            successCount++;
            const changes = result.changes || {};

            // ÏÑ∏Î∂Ä Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Î°úÍ∑∏
            if (changes.title) {
              addAILog(`  ‚úì ÏÉÅÌíàÎ™Ö: ${changes.title.substring(0, 30)}...`, 'success');
            }
            if (changes.optionImagesProcessed > 0) {
              addAILog(`  ‚úì ÏòµÏÖò Ïù¥ÎØ∏ÏßÄ ${changes.optionImagesProcessed}Í∞ú Ìù∞ Î∞∞Í≤Ω Î≥ÄÌôò`, 'success');
            }
            if (changes.styledImageCreated) {
              addAILog(`  ‚úì Ïó∞Ï∂ú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å`, 'success');
            }
            if (changes.optionsConverted > 0) {
              addAILog(`  ‚úì ÏòµÏÖòÎ™Ö ${changes.optionsConverted}Í∞ú Î≥ÄÌôò`, 'success');
            }
            if (changes.detailImagesAdded > 0) {
              addAILog(`  ‚úì ÏÉÅÏÑ∏ Ïù¥ÎØ∏ÏßÄ ${changes.detailImagesAdded}Í∞ú Ï∂îÍ∞Ä`, 'success');
            }
            if (changes.detailPageUpdated) {
              addAILog(`  ‚úì ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Íµ¨ÏÑ± ÏôÑÎ£å`, 'success');
            }
            addAILog(`  ‚úì ÏÉÅÌíà Ï≤òÎ¶¨ ÏôÑÎ£å!`, 'success');
          } else {
            failCount++;
            addAILog(`  ‚úó Ïã§Ìå®: ${result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`, 'error');
          }
        } catch (error) {
          failCount++;
          addAILog(`  ‚úó Ïò§Î•ò: ${error.message}`, 'error');
        }
      }

      // ÏôÑÎ£å
      updateAIProgress(100, 'ÏôÑÎ£å!');

      if (failCount === 0) {
        addAILog(`‚úÖ Ï¥ù ${successCount}Í∞ú ÏÉÅÌíà AI ÏûêÎèô ÏàòÏ†ï ÏôÑÎ£å!`, 'success');
        showAIProgressComplete(true);
      } else {
        addAILog(`‚ö†Ô∏è ÏôÑÎ£å: ÏÑ±Í≥µ ${successCount}Í∞ú, Ïã§Ìå® ${failCount}Í∞ú`, 'error');
        showAIProgressComplete(false);
      }

      // Îã´Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏΩúÎ∞± ÏÑ§Ï†ï
      aiProgressCallback = () => {
        if (failCount === 0) {
          showToast(`‚úÖ ${successCount}Í∞ú ÏÉÅÌíà AI ÏûêÎèô ÏàòÏ†ï ÏôÑÎ£å!`, 'success');
        } else {
          showToast(`AI ÏàòÏ†ï ÏôÑÎ£å: ÏÑ±Í≥µ ${successCount}Í∞ú, Ïã§Ìå® ${failCount}Í∞ú`, 'warning');
        }

        // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî Î∞è Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        selectedProducts.clear();
        updateActionBar();
        loadProducts();
      };
    }

    // ÏÑ†ÌÉù ÏÉÅÌíà ÏÇ≠Ï†ú
    async function deleteSelected() {
      if (selectedProducts.size === 0) {
        showToast('ÏÇ≠Ï†úÌï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
        return;
      }

      if (!confirm(`ÏÑ†ÌÉùÌïú ${selectedProducts.size}Í∞ú ÏÉÅÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        return;
      }

      try {
        const response = await authFetch('/api/products/batch-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });

        if (response.ok) {
          showToast('ÏÑ†ÌÉùÌïú ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
          selectedProducts.clear();
          updateActionBar();
          loadProducts();
        } else {
          throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®');
        }
      } catch (error) {
        console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', error);
        showToast('ÏÉÅÌíà ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
      }
    }

    // ÏÑ†ÌÉùÌïú ÏÉÅÌíàÎì§Ïùò Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Í≤¨Ï†ÅÏÑú ÏÉùÏÑ±Ïö©)
    async function loadFullProductData(productIds) {
      try {
        const response = await authFetch('/api/products/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: productIds })
        });
        const data = await response.json();
        if (data.success) {
          return data.products;
        }
        throw new Error(data.message || 'ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
      } catch (error) {
        console.error('ÏÉÅÌíà Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
        throw error;
      }
    }

    // Í≤¨Ï†ÅÏÑú ÏÉùÏÑ± - Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ Ïó¥Í∏∞
    async function generateQuote() {
      if (selectedProducts.size === 0) {
        alert('Í≤¨Ï†ÅÏÑúÎ•º ÏÉùÏÑ±Ìï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      // ‚ö†Ô∏è ÏÑ†ÌÉùÌïú ÏÉÅÌíàÏùò Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Î™©Î°ùÏùÄ Í≤ΩÎüâ Îç∞Ïù¥ÌÑ∞Îßå ÏûàÏùå)
      let selectedProductsData;
      try {
        selectedProductsData = await loadFullProductData(Array.from(selectedProducts));
      } catch (error) {
        alert('ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        return;
      }

      if (selectedProductsData.length === 0) {
        alert('Í≤¨Ï†ÅÏÑúÎ•º ÏÉùÏÑ±Ìï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const uneditedProducts = [];
      for (const product of selectedProductsData) {
        // Check if detailPageItems exists and is not empty
        if (!product.detailPageItems || product.detailPageItems.length === 0) {
          const productName = product.title || product.titleCn || 'ÏÉÅÌíà';
          uneditedProducts.push(productName);
        }
      }

      // Display error if unedited products found
      if (uneditedProducts.length > 0) {
        alert(`Îã§Ïùå ÏÉÅÌíàÎì§Ïù¥ Ìé∏ÏßëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§:\n\n${uneditedProducts.map((name, idx) => `${idx + 1}. ${name}`).join('\n')}\n\nÎ®ºÏ†Ä "Ìé∏Ïßë" Î≤ÑÌäºÏùÑ ÎàåÎü¨ Í∞Å ÏÉÅÌíàÏùò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º Ìé∏ÏßëÌïòÍ≥† Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.`);
        return;
      }

      // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º ÏûÑÏãú Ï†ÄÏû• (ÌõÑÏÜç ÏûëÏóÖÏóêÏÑú ÏÇ¨Ïö©)
      window.selectedFullProductsData = selectedProductsData;

      // Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ Ïó¥Í∏∞
      openCoupangCategoryModal();
      return;

      // Í∏∞Ï°¥ ÏΩîÎìú (ÎπÑÌôúÏÑ±Ìôî)
      /*
      if (selectedProducts.size === 0) {
        alert('Í≤¨Ï†ÅÏÑúÎ•º ÏÉùÏÑ±Ìï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      try {
        const response = await fetch('/api/quote/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Í≤¨Ï†ÅÏÑú_${new Date().toISOString().slice(0,10)}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);
        } else {
          throw new Error('Í≤¨Ï†ÅÏÑú ÏÉùÏÑ± Ïã§Ìå®');
        }
      } catch (error) {
        console.error('Í≤¨Ï†ÅÏÑú ÏÉùÏÑ± Ïò§Î•ò:', error);
        alert('Í≤¨Ï†ÅÏÑú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
      */
    }

    // Ïø†Ìå° ÏóÖÎ°úÎìú Ï§ÄÎπÑ
    async function prepareCoupangUpload() {
      if (selectedProducts.size === 0) {
        alert('ÏóÖÎ°úÎìúÌï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      try {
        const response = await fetch('/api/coupang/prepare-upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Ïø†Ìå°ÏóÖÎ°úÎìú_${new Date().toISOString().slice(0,10)}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);

          alert('Ïø†Ìå° ÏóÖÎ°úÎìúÏö© ÏóëÏÖÄ ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.\nÏø†Ìå° ÌåêÎß§Ïûê ÏÑºÌÑ∞ÏóêÏÑú ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.');
        } else {
          throw new Error('ÏóëÏÖÄ ÏÉùÏÑ± Ïã§Ìå®');
        }
      } catch (error) {
        console.error('ÏóëÏÖÄ ÏÉùÏÑ± Ïò§Î•ò:', error);
        alert('ÏóëÏÖÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }

    // ===== ÏÑ§Ï†ï Í¥ÄÎ¶¨ =====

    // TotalBot ÏÑ§Ï†ï
    let settings = {
      // Ï†ïÎ≥¥ ÏÑ§Ï†ï
      coupangId: '',
      coupangPassword: '',
      address: '',
      brandName: '',  // Î∏åÎûúÎìúÎ™Ö (Í≤¨Ï†ÅÏÑúÏóê ÏÇ¨Ïö©)
      // Í∞ÄÍ≤© ÏÑ§Ï†ï
      exchangeRate: 190,
      packagingCost: 500,
      shipmentCost: 0,
      minMargin: 3000,
      supplyMargins: [
        { amount: 10000, percent: 50 },
        { amount: 50000, percent: 45 },
        { amount: 100000, percent: 40 },
        { amount: 200000, percent: 35 },
        { amount: Infinity, percent: 30 }
      ],
      saleMargins: [
        { amount: 10000, percent: 35 },
        { amount: 50000, percent: 30 },
        { amount: 100000, percent: 25 },
        { amount: 200000, percent: 20 },
        { amount: Infinity, percent: 15 }
      ],
      // ÌÖúÌîåÎ¶ø ÏÑ§Ï†ï
      brandImageUrl: '',
      defaultDetailTemplate: [
        { type: 'brand-image', label: 'Î∏åÎûúÎìú Ïù¥ÎØ∏ÏßÄ' },
        { type: 'title', label: 'Ï†úÌíàÎ™Ö' },
        { type: 'option-blocks', label: 'ÏòµÏÖò Î∏îÎ°ùÎì§' },
        { type: 'quality-table', label: 'ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠' }
      ],
      defaultQualityRows: [
        { label: 'Ï†úÏ°∞ÏÇ¨', value: '' },
        { label: 'Ï∑®Í∏âÏãú Ï£ºÏùòÏÇ¨Ìï≠', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï∞∏Ï°∞' },
        { label: 'Ï†úÏ°∞ Ïó∞Ïõî', value: '' },
        { label: 'ÌíàÏßà Î≥¥Ï¶ùÍ∏∞Ï§Ä', value: 'Í¥ÄÎ†®Î≤ï Î∞è ÏÜåÎπÑÏûê Î∂ÑÏüÅÌï¥Í≤∞ Í∑úÏ†ïÏóê Îî∞Î¶Ñ' },
        { label: 'A/S Ï±ÖÏûÑÏûêÏôÄ Ï†ÑÌôîÎ≤àÌò∏', value: '' }
      ],
      // Í≤¨Ï†ÅÏÑú ÏûëÏÑ± ÏñëÏãù Í∏∞Î≥∏Í∞í (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏàòÏ†ï Í∞ÄÎä•Ìïú Ìï≠Î™©Îßå, json_to_excel HEADER_RULES Í∏∞Î∞ò)
      quotationMappings: [
        { header: 'ÏÉâÏÉÅ/ÎîîÏûêÏù∏', type: 'option1', value: '' },
        { header: 'ÏÉâÏÉÅ', type: 'option1', value: '' },
        { header: 'ÏÇ¨Ïù¥Ï¶à', type: 'option2', value: '' },
        { header: 'Ìå®ÏÖòÏùòÎ•ò/Ïû°Ìôî ÏÇ¨Ïù¥Ï¶à', type: 'option2', value: '' },
        { header: 'Î™®Îç∏Î™Ö/ÌíàÎ≤à', type: 'fixed', value: 'Îã®ÏùºÏÉÅÌíà' },
        { header: 'Í≥ºÏÑ∏Ïó¨Î∂Ä', type: 'fixed', value: 'Í≥ºÏÑ∏' },
        { header: 'Í±∞ÎûòÌÉÄÏûÖ', type: 'fixed', value: 'Í∏∞ÌÉÄ ÎèÑÏÜåÎß§ÏóÖÏûê' },
        { header: 'ÏàòÏûÖÏó¨Î∂Ä', type: 'fixed', value: 'ÏàòÏûÖÏÉÅÌíà' },
        { header: 'Î∞ïÏä§ ÎÇ¥ SKU ÏàòÎüâ', type: 'fixed', value: '50' },
        { header: 'Ïú†ÌÜµÍ∏∞Í∞Ñ *ÏãùÌíàÏùò Í≤ΩÏö∞ ÏÜåÎπÑÍ∏∞Í∞Ñ (ÏùºÏàòÍ∏∞Ïû¨)', type: 'fixed', value: '0' },
        { header: 'Ïú†ÌÜµÍ∏∞Í∞Ñ', type: 'fixed', value: '0' },
        { header: 'Ïù¥Ïö©Ï°∞Í±¥, Ïù¥Ïö©Í∏∞Í∞Ñ', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'ÏÉÅÌíà Ï†úÍ≥µ Î∞©Ïãù', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'ÏµúÏÜå ÏãúÏä§ÌÖú ÏÇ¨Ïñë, ÌïÑÏàò ÏÜåÌîÑÌä∏Ïõ®Ïñ¥', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'Ï≤≠ÏïΩÏ≤†Ìöå ÎòêÎäî Í≥ÑÏïΩÏùò Ìï¥Ï†ú¬∑Ìï¥ÏßÄÏóê Îî∞Î•∏ Ìö®Í≥º', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'Ï†úÏ°∞Íµ≠', type: 'fixed', value: 'Ï§ëÍµ≠ OEM' },
        { header: 'Ï†úÏ°∞Íµ≠(ÏõêÏÇ∞ÏßÄ)', type: 'fixed', value: 'Ï§ëÍµ≠ OEM' },
        { header: 'ÏπòÏàò', type: 'fixed', value: 'One Size' },
        { header: 'ÎÉÑÎπÑ/ÌîÑÎùºÏù¥Ìå¨ ÏÇ¨Ïù¥Ï¶à', type: 'fixed', value: 'Free' },
        { header: 'KCS Ïù∏Ï¶ùÎ≤àÌò∏', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'KC Ïù∏Ï¶ùÏ†ïÎ≥¥', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'KC Ïù∏Ï¶ùÏ†ïÎ≥¥(ÏûêÎèôÏ∞®Í¥ÄÎ¶¨Î≤ïÏóê Îî∞Î•∏ ÏûêÍ∏∞Ïù∏Ï¶ù ÎåÄÏÉÅ ÏûêÎèôÏ∞®Î∂ÄÌíàÏóê ÌïúÌï®)', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'Ï†ÑÍ∏∞Ïö©Ìíà Î∞è ÏÉùÌôúÏö©Ìíà, Ïñ¥Î¶∞Ïù¥ (KC) Ïù∏Ï¶ù ÎßàÌÅ¨ ÌÉÄÏûÖ', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'Ï†ÑÍ∏∞Ïö©Ìíà Î∞è ÏÉùÌôúÏö©Ìíà, Ïñ¥Î¶∞Ïù¥ (KC) Ïù∏Ï¶ùÎ≤àÌò∏', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'Î∞©ÏÜ°ÌÜµÏã† Í∏∞ÏûêÏû¨ (EMC) Ïù∏Ï¶ù Î≤àÌò∏', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'ÏïàÏ†ÑÍ∏∞Ï§ÄÏ†ÅÌï©ÌôïÏù∏ Ïã†Í≥†Î≤àÌò∏', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'Ïù∏Ï¶ù/ÌóàÍ∞Ä ÏÇ¨Ìï≠', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'ÏÜåÎπÑÏûêÏÉÅÎã¥ Í¥ÄÎ†® Ï†ÑÌôîÎ≤àÌò∏', type: 'fixed', value: '1577-7011' },
        { header: 'ÏÜåÎπÑÏûêÏÉÅÎã¥Í¥ÄÎ†® Ï†ÑÌôîÎ≤àÌò∏', type: 'fixed', value: '1577-7011' },
        { header: 'A/S Ï±ÖÏûÑÏûêÏôÄ Ï†ÑÌôîÎ≤àÌò∏', type: 'fixed', value: '1577-7011' },
        { header: 'ÌíàÏßàÎ≥¥Ï¶ùÍ∏∞Ï§Ä', type: 'fixed', value: 'Î≥∏ Ï†úÌíàÏùÄ Í≥µÏ†ïÍ±∞ÎûòÏúÑÏõêÌöå Í≥†Ïãú Î∂ÑÏüÅ Ìï¥Í≤∞Í∏∞Ï§ÄÏóê ÏùòÍ±∞ ÍµêÌôò ÎòêÎäî Î≥¥ÏÉÅ Î∞õÏúºÏã§ Ïàò ÏûàÏäµÎãàÎã§.' },
        { header: 'Íµ¨ÏÑ±Ìíà', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†úÌíà Íµ¨ÏÑ±', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†úÌíàÍµ¨ÏÑ±', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ïû¨Í≥µÍ∏â(Î¶¨ÌçºÎ∏å) Í∞ÄÍµ¨Ïùò Í≤ΩÏö∞ Ïû¨Í≥µÍ∏â ÏÇ¨Ïú† Î∞è ÌïòÏûê Î∂ÄÏúÑÏùò Í¥ÄÌïú Ï†ïÎ≥¥', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'Ïû¨Í≥µÍ∏â(Î¶¨ÌçºÎ∏å) Í∞ÄÍµ¨Ïùò Í≤ΩÏö∞ Ïû¨Í≥µÍ∏â ÏÇ¨Ïú† Î∞è ÌïòÏûê Î∂ÄÏúÑÏóê Í¥ÄÌïú Ï†ïÎ≥¥', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'ÏàòÏûÖÏã†Í≥† Î¨∏Íµ¨ Ïó¨Î∂Ä', type: 'fixed', value: 'ÏàòÏûÖÏãùÌíà ÏïàÏ†ÑÍ¥ÄÎ¶¨ ÌäπÎ≥ÑÎ≤ïÏóê Îî∞Î•∏ ÏàòÏûÖÏã†Í≥†Î•º ÌïÑÌï®' },
        { header: 'Îã® Ïàò', type: 'fixed', value: '3Îã®' },
        { header: 'ÎèôÏùºÎ™®Îç∏ Ï∂úÏãúÎÖÑÏõî', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÎèôÏùºÎ™®Îç∏Ïùò Ï∂úÏãúÎÖÑÏõî', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†ÅÏö©Ï∞®Ï¢Ö', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†úÌíàÏÇ¨Ïö©ÏúºÎ°ú Ïù∏Ìïú ÏúÑÌóò Î∞è Ïú†ÏùòÏÇ¨Ìï≠(Ïó∞Î£åÏ†àÍ∞êÏû•ÏπòÏóê ÌïúÌï®)', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'Í≤ÄÏÇ¨Ìï©Í≤©Ï¶ù Î≤àÌò∏ (ÎåÄÍ∏∞ÌôòÍ≤ΩÎ≥¥Ï†ÑÎ≤ïÏóê Îî∞Î•∏ Ï≤®Í∞ÄÏ†ú¬∑Ï¥âÎß§Ï†úÏóê ÌïúÌï®)', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ ÏóÜÏùå' },
        { header: 'Ï¢ÖÎ•ò', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†úÌíà ÏÜåÏû¨', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï£ºÏöîÏÜåÏû¨', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï£ºÏöî ÏÜåÏû¨', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ïû¨Ïßà', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÏÜåÏû¨', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†úÌíàÏùò Ï£ºÏÜåÏû¨(Ïö¥ÎèôÌôîÏù∏ Í≤ΩÏö∞ÏóêÎäî Í≤âÍ∞ê,ÏïàÍ∞êÏùÑ Íµ¨Î∂ÑÌïòÏó¨ ÌëúÏãú)', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï£ºÏñºÎ¶¨ ÏÇ¨Ïù¥Ï¶à', type: 'fixed', value: 'onesize' },
        { header: 'ÌÖåÏù¥Î∏îÎ≥¥ ÏÇ¨Ïù¥Ï¶à', type: 'fixed', value: 'M' },
        { header: 'Ïö©Îüâ', type: 'fixed', value: '1L' },
        { header: 'ÌÅ¨Í∏∞', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÌÅ¨Í∏∞, Ï§ëÎüâ', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÌÅ¨Í∏∞,Ïö©Îüâ,ÌòïÌÉú', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÌÅ¨Í∏∞‚àôÏ≤¥Ï§ëÏùò ÌïúÍ≥Ñ', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï§ëÎüâ', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï†ïÍ≤©Ï†ÑÏïï, ÏÜåÎπÑÏ†ÑÎ†•', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÏóêÎÑàÏßÄÏÜåÎπÑÌö®Ïú®Îì±Í∏â', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Î¨ºÏßàÏïàÏ†ÑÎ≥¥Í±¥ÏûêÎ£å (MSDS)', type: 'fixed', value: 'N (Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå)' },
        { header: 'Î∞∞ÏÜ°/ÏÑ§ÏπòÎπÑÏö©', type: 'fixed', value: 'Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå' },
        { header: 'Ï∂îÍ∞ÄÏÑ§ÏπòÎπÑÏö©', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÏÉÅÌíàÎ≥Ñ ÏÑ∏Î∂Ä ÏÇ¨Ïñë', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÌñâÏñ¥ ÏûÖÍ≥†', type: 'fixed', value: 'N' },
        { header: 'ÏÑ∏ÌÉÅÎ∞©Î≤ï Î∞è Ï∑®Í∏âÏãú Ï£ºÏùòÏÇ¨Ìï≠', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'Ï∑®Í∏âÏãú Ï£ºÏùòÏÇ¨Ìï≠', type: 'fixed', value: '14ÏÑ∏ ÎØ∏Îßå Ïñ¥Î¶∞Ïù¥ ÏÇ¨Ïö© Í∏àÏßÄ' },
        { header: 'Ï∑®Í∏âÎ∞©Î≤ï Î∞è Ï∑®Í∏âÏãú Ï£ºÏùòÏÇ¨Ìï≠, ÏïàÏ†ÑÌëúÏãú', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÏÇ¨Ïö©Ïó∞Î†π ÎòêÎäî Í∂åÏû•ÏÇ¨Ïö©Ïó∞Î†π', type: 'fixed', value: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑ§Î™Ö Ï∞∏Ï°∞' },
        { header: 'ÏàòÎüâ', type: 'fixed', value: '1Í∞ú' },
        { header: 'Í∞úÎãπ ÏàòÎüâ', type: 'fixed', value: '1Í∞úÏûÖ' },
        { header: 'ÎÇ¥ÏßÄÎß§Ïàò', type: 'fixed', value: '1Îß§' }
      ]
    };

    // ÏÑ§Ï†ï Î°úÎìú (ÏÑúÎ≤ÑÏóêÏÑú Ïú†Ï†ÄÎ≥ÑÎ°ú Í¥ÄÎ¶¨)
    // - Î™®Îì† ÏÑ§Ï†ïÏùÑ ÏÑúÎ≤ÑÏóêÏÑú Ïú†Ï†ÄÎ≥ÑÎ°ú Í¥ÄÎ¶¨ (Í≥µÏú† Ïª¥Ìì®ÌÑ∞ÏóêÏÑúÎèÑ Ïú†Ï†ÄÎ≥Ñ Î∂ÑÎ¶¨)
    // - coupangId, passwordÎäî localStorageÏóê Î∞±ÏóÖ (Î≥¥ÏïàÏÉÅ)
    async function loadSettings() {
      // Í∏∞Î≥∏Í∞í Î∞±ÏóÖ
      const defaultQuotationMappings = settings.quotationMappings;
      const defaultQualityRows = settings.defaultQualityRows;
      const defaultDetailTemplate = settings.defaultDetailTemplate;

      // ÏÑúÎ≤ÑÏóêÏÑú Î™®Îì† ÏÑ§Ï†ï Î°úÎìú (Ïú†Ï†ÄÎ≥Ñ Î∂ÑÎ¶¨)
      try {
        const response = await authFetch('/api/settings');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.settings) {
            const serverSettings = data.settings;

            // ÏÑúÎ≤ÑÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏÑ§Ï†ï Î≥ëÌï©
            if (serverSettings.quotationMappings && serverSettings.quotationMappings.length > 0) {
              window.quotationMappings = serverSettings.quotationMappings;
              settings.quotationMappings = serverSettings.quotationMappings;
              console.log('üìã Loaded quotationMappings from server:', window.quotationMappings.length);
            } else {
              window.quotationMappings = defaultQuotationMappings;
            }

            // ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠ Í∏∞Î≥∏ Ìñâ Î°úÎìú
            if (serverSettings.defaultQualityRows && serverSettings.defaultQualityRows.length > 0) {
              settings.defaultQualityRows = serverSettings.defaultQualityRows;
              console.log('üìã Loaded defaultQualityRows from server:', settings.defaultQualityRows.length);
            }

            // ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Í∏∞Î≥∏ ÌÖúÌîåÎ¶ø Î°úÎìú
            if (serverSettings.defaultDetailTemplate && serverSettings.defaultDetailTemplate.length > 0) {
              settings.defaultDetailTemplate = serverSettings.defaultDetailTemplate;
              console.log('üìã Loaded defaultDetailTemplate from server');
            }

            // Í∞ÄÍ≤© ÏÑ§Ï†ï Î°úÎìú
            if (serverSettings.priceSettings) {
              settings.exchangeRate = serverSettings.priceSettings.exchangeRate || settings.exchangeRate;
              settings.packagingCost = serverSettings.priceSettings.packagingCost || settings.packagingCost;
              settings.shipmentCost = serverSettings.priceSettings.shipmentCost || settings.shipmentCost;
              settings.minMargin = serverSettings.priceSettings.minMargin || settings.minMargin;
              if (serverSettings.priceSettings.supplyMargins) {
                settings.supplyMargins = serverSettings.priceSettings.supplyMargins;
              }
              if (serverSettings.priceSettings.saleMargins) {
                settings.saleMargins = serverSettings.priceSettings.saleMargins;
              }
              console.log('üìã Loaded priceSettings from server');
            }

            // Î∏åÎûúÎìú Ïù¥ÎØ∏ÏßÄ URL Î°úÎìú
            if (serverSettings.brandImageUrl) {
              settings.brandImageUrl = serverSettings.brandImageUrl;
            }

            // Î∏åÎûúÎìúÎ™Ö Î°úÎìú
            if (serverSettings.brandName) {
              settings.brandName = serverSettings.brandName;
              console.log('üìã Loaded brandName from server:', settings.brandName);
            }

            // Ïø†Ìå° Ï†ïÎ≥¥Îäî localStorageÏóêÏÑúÎßå Î°úÎìú (Î≥¥ÏïàÏÉÅ)
            const localCreds = localStorage.getItem('totalbotCredentials');
            if (localCreds) {
              try {
                const creds = JSON.parse(localCreds);
                settings.coupangId = creds.coupangId || '';
                settings.coupangPassword = creds.coupangPassword || '';
                settings.address = creds.address || '';
              } catch (e) {
                console.error('localStorage credentials Î°úÎìú Ïã§Ìå®:', e);
              }
            }

            console.log('‚úÖ All settings loaded from server');
            return;
          }
        }
      } catch (e) {
        console.warn('ÏÑúÎ≤Ñ ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', e);
      }

      // ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå® Ïãú Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
      window.quotationMappings = defaultQuotationMappings;
      console.log('üìã Using default settings (server unavailable)');
    }

    // ÏÑ§Ï†ï Ï†ÄÏû• (ÏÑúÎ≤Ñ APIÏóê Î™®Îì† ÏÑ§Ï†ï Ï†ÄÏû•)
    async function saveSettingsToStorage() {
      // Ïø†Ìå° Ï†ïÎ≥¥Îäî localStorageÏóêÎßå Ï†ÄÏû• (Î≥¥ÏïàÏÉÅ)
      localStorage.setItem('totalbotCredentials', JSON.stringify({
        coupangId: settings.coupangId || '',
        coupangPassword: settings.coupangPassword || '',
        address: settings.address || ''
      }));

      // defaultQualityRowsÎ•º qualityTable ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò (editor-options.htmlÍ≥º ÎèôÍ∏∞Ìôî)
      const qualityTable = {};
      if (settings.defaultQualityRows) {
        settings.defaultQualityRows.forEach(row => {
          switch(row.label) {
            case 'Ï†úÏ°∞ÏÇ¨':
              qualityTable.Ï†úÏ°∞ÏÇ¨ = row.value || '';
              break;
            case 'Ï∑®Í∏âÏãú Ï£ºÏùòÏÇ¨Ìï≠':
              qualityTable.Ï∑®Í∏âÏãúÏ£ºÏùòÏÇ¨Ìï≠ = row.value || 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï∞∏Ï°∞';
              break;
            case 'Ï†úÏ°∞ Ïó∞Ïõî':
              qualityTable.Ï†úÏ°∞Ïó∞Ïõî = row.value || '';
              break;
            case 'ÌíàÏßà Î≥¥Ï¶ùÍ∏∞Ï§Ä':
              qualityTable.ÌíàÏßàÎ≥¥Ï¶ùÍ∏∞Ï§Ä = row.value || 'Í¥ÄÎ†®Î≤ï Î∞è ÏÜåÎπÑÏûê Î∂ÑÏüÅÌï¥Í≤∞ Í∑úÏ†ïÏóê Îî∞Î¶Ñ';
              break;
            case 'A/S Ï±ÖÏûÑÏûêÏôÄ Ï†ÑÌôîÎ≤àÌò∏':
              qualityTable.ASÏ±ÖÏûÑÏûê = row.value || '';
              break;
          }
        });
      }

      // ÏÑúÎ≤ÑÏóê Î™®Îì† ÏÑ§Ï†ï Ï†ÄÏû•
      try {
        const serverSettings = {
          quotationMappings: window.quotationMappings || settings.quotationMappings,
          defaultQualityRows: settings.defaultQualityRows,
          qualityTable: qualityTable,
          defaultDetailTemplate: settings.defaultDetailTemplate,
          brandImageUrl: settings.brandImageUrl || '',
          brandName: settings.brandName || '',  // Î∏åÎûúÎìúÎ™Ö Ï†ÄÏû•
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            packagingCost: settings.packagingCost,
            shipmentCost: settings.shipmentCost,
            minMargin: settings.minMargin,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins
          }
        };

        const response = await authFetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(serverSettings)
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('‚úÖ All settings saved to server API');
          } else {
            console.error('‚ùå ÏÑúÎ≤Ñ ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®:', data.message);
          }
        }
      } catch (e) {
        console.error('‚ùå ÏÑúÎ≤Ñ ÏÑ§Ï†ï Ï†ÄÏû• Ïò§Î•ò:', e);
      }
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÑ§Ï†ï Î°úÎìú
    (async () => {
      await loadSettings();
      // ÏÑ§Ï†ï Î°úÎìú ÏôÑÎ£å ÌõÑ Í≤¨Ï†ÅÏÑú Îß§Ìïë Î†åÎçîÎßÅ
      if (typeof renderQuotationMappings === 'function') {
        renderQuotationMappings();
      }
    })();

    // ===== Chrome Extension ÌÜµÏã† =====

    // Extension ID Ï†ÄÏû• (ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÎèô Í∞êÏßÄ)
    let extensionId = localStorage.getItem('totalbotExtensionId') || null;

    // Extension Í∞êÏßÄ Î∞è ID Ï†ÄÏû•
    function detectExtension() {
      // localStorageÏóêÏÑú Extension ID ÌôïÏù∏
      const savedId = localStorage.getItem('totalbotExtensionId');
      if (savedId && savedId !== 'null') {
        extensionId = savedId;
        console.log('‚úÖ TotalBot Extension detected:', extensionId);
        return true;
      }

      console.log('‚ö†Ô∏è TotalBot Extension not detected');
      return false;
    }

    // CustomEvent Î¶¨Ïä§ÎÑà - content scriptÍ∞Ä Ï§ÄÎπÑÎêòÎ©¥ ÏïåÎ¶ºÎ∞õÏùå
    window.addEventListener('TotalbotExtensionReady', (event) => {
      if (event.detail && event.detail.extensionId) {
        extensionId = event.detail.extensionId;
        localStorage.setItem('totalbotExtensionId', extensionId);
        console.log('‚úÖ TotalBot Extension detected (via event):', extensionId);

        // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
        if (settings.coupangId && settings.coupangPassword) {
          checkCoupangLoginStatus();
        }
      }
    });

    // ExtensionÏúºÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ° (Promise Í∏∞Î∞ò)
    function sendMessageToExtension(action, payload) {
      return new Promise((resolve, reject) => {
        if (!extensionId) {
          detectExtension();
        }

        if (!extensionId) {
          reject(new Error('ExtensionÏù¥ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§.\n\nchrome://extensions/ ÌéòÏù¥ÏßÄÏóêÏÑú TotalBot ExtensionÏùÑ ÏÑ§ÏπòÌïòÍ≥†\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.'));
          return;
        }

        console.log('üìÆ Sending message to extension:', action);

        try {
          // externally_connectableÏùÑ ÏÇ¨Ïö©Ìïú ÏßÅÏ†ë ÌÜµÏã†
          chrome.runtime.sendMessage(extensionId, payload, (response) => {
            if (chrome.runtime.lastError) {
              console.error('‚ùå Extension Error:', chrome.runtime.lastError);
              // Extension IDÍ∞Ä ÏûòÎ™ªÎêòÏóàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ÏÇ≠Ï†ú
              localStorage.removeItem('totalbotExtensionId');
              extensionId = null;
              reject(new Error('Extension ÌÜµÏã† Ïã§Ìå®: ' + chrome.runtime.lastError.message + '\n\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'));
              return;
            }

            console.log('üì¨ Received response from extension:', action);
            resolve(response);
          });

          // ÌÉÄÏûÑÏïÑÏõÉ (4Î∂Ñ = 240Ï¥à) - Ïø†Ìå° Í≤ÄÏ¶ùÏù¥ ÏµúÎåÄ 3Î∂Ñ Í±∏Î¶¨ÎØÄÎ°ú Ïó¨Ïú†ÏûàÍ≤å ÏÑ§Ï†ï
          setTimeout(() => {
            reject(new Error('Extension ÏùëÎãµ ÌÉÄÏûÑÏïÑÏõÉ (4Î∂Ñ)'));
          }, 240000);

        } catch (error) {
          console.error('‚ùå Send message error:', error);
          reject(error);
        }
      });
    }

    // ÏÑ§Ï†ï Î™®Îã¨ Ïó¥Í∏∞
    function openSettingsModal() {
      // Ï†ïÎ≥¥ ÏÑ§Ï†ï
      document.getElementById('settingsCoupangId').value = settings.coupangId || '';
      document.getElementById('settingsCoupangPassword').value = settings.coupangPassword || '';
      document.getElementById('settingsAddress').value = settings.address || '';
      document.getElementById('settingsBrandName').value = settings.brandName || '';

      // Í∞ÄÍ≤© ÏÑ§Ï†ï
      document.getElementById('settingsExchangeRate').value = settings.exchangeRate;
      document.getElementById('settingsPackagingCost').value = settings.packagingCost;
      document.getElementById('settingsShipmentCost').value = settings.shipmentCost;
      document.getElementById('settingsMinMargin').value = settings.minMargin;

      renderSupplyMarginRows();
      renderSaleMarginRows();

      // ÌÖúÌîåÎ¶ø ÏÑ§Ï†ï
      if (settings.brandImageUrl) {
        document.getElementById('brandImagePreview').style.display = 'block';
        document.getElementById('brandImagePreviewImg').src = settings.brandImageUrl;
      } else {
        document.getElementById('brandImagePreview').style.display = 'none';
      }
      renderDefaultDetailTemplate();
      renderDefaultQualityRows();
      renderQuotationMappings(); // Í≤¨Ï†ÅÏÑú ÏñëÏãù Î†åÎçîÎßÅ

      document.getElementById('settingsModal').classList.add('active');
    }

    // ÏÑ§Ï†ï Î™®Îã¨ Îã´Í∏∞
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    // ÏÑ§Ï†ï ÌÉ≠ Ï†ÑÌôò (ÎßàÏßÑ ÏÑ§Ï†ïÏùò ÏÑúÎ∏å ÌÉ≠)
    function switchSettingsTab(tabName) {
      document.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}-settings-tab`).classList.add('active');
    }

    // ÏÑ§Ï†ï Î©îÏù∏ ÌÉ≠ Ï†ÑÌôò
    function switchMainSettingsTab(tabName) {
      document.querySelectorAll('.settings-main-tab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.settings-main-tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}-main-settings-tab`).classList.add('active');
    }

    // Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ Ìñâ Î†åÎçîÎßÅ
    function renderSupplyMarginRows() {
      const container = document.getElementById('supplyMarginRows');
      container.innerHTML = '';

      settings.supplyMargins.forEach((margin, index) => {
        const row = document.createElement('div');
        row.className = 'margin-row';
        row.innerHTML = `
          <div>
            <input type="number"
              value="${margin.amount === Infinity ? '' : margin.amount}"
              placeholder="Í∏àÏï° (Ïõê)"
              onchange="updateSupplyMargin(${index}, 'amount', this.value)"
              ${margin.amount === Infinity ? 'disabled' : ''}>
            <small style="font-size: 11px; color: #888;">ÎØ∏Îßå</small>
          </div>
          <div>
            <input type="number"
              value="${margin.percent}"
              placeholder="ÎßàÏßÑ (%)"
              onchange="updateSupplyMargin(${index}, 'percent', this.value)">
            <small style="font-size: 11px; color: #888;">%</small>
          </div>
          <button onclick="deleteSupplyMargin(${index})" ${margin.amount === Infinity ? 'disabled' : ''}>ÏÇ≠Ï†ú</button>
        `;
        container.appendChild(row);
      });
    }

    // ÌåêÎß§Í∞Ä ÎßàÏßÑ Ìñâ Î†åÎçîÎßÅ
    function renderSaleMarginRows() {
      const container = document.getElementById('saleMarginRows');
      container.innerHTML = '';

      settings.saleMargins.forEach((margin, index) => {
        const row = document.createElement('div');
        row.className = 'margin-row';
        row.innerHTML = `
          <div>
            <input type="number"
              value="${margin.amount === Infinity ? '' : margin.amount}"
              placeholder="Í∏àÏï° (Ïõê)"
              onchange="updateSaleMargin(${index}, 'amount', this.value)"
              ${margin.amount === Infinity ? 'disabled' : ''}>
            <small style="font-size: 11px; color: #888;">ÎØ∏Îßå</small>
          </div>
          <div>
            <input type="number"
              value="${margin.percent}"
              placeholder="ÎßàÏßÑ (%)"
              onchange="updateSaleMargin(${index}, 'percent', this.value)">
            <small style="font-size: 11px; color: #888;">%</small>
          </div>
          <button onclick="deleteSaleMargin(${index})" ${margin.amount === Infinity ? 'disabled' : ''}>ÏÇ≠Ï†ú</button>
        `;
        container.appendChild(row);
      });
    }

    // Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ ÏóÖÎç∞Ïù¥Ìä∏
    function updateSupplyMargin(index, field, value) {
      if (field === 'amount') {
        settings.supplyMargins[index].amount = value === '' ? Infinity : parseFloat(value);
      } else {
        settings.supplyMargins[index].percent = parseFloat(value);
      }
    }

    // ÌåêÎß§Í∞Ä ÎßàÏßÑ ÏóÖÎç∞Ïù¥Ìä∏
    function updateSaleMargin(index, field, value) {
      if (field === 'amount') {
        settings.saleMargins[index].amount = value === '' ? Infinity : parseFloat(value);
      } else {
        settings.saleMargins[index].percent = parseFloat(value);
      }
    }

    // Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ Ìñâ Ï∂îÍ∞Ä
    function addSupplyMarginRow() {
      settings.supplyMargins.splice(settings.supplyMargins.length - 1, 0, { amount: 0, percent: 30 });
      renderSupplyMarginRows();
    }

    // ÌåêÎß§Í∞Ä ÎßàÏßÑ Ìñâ Ï∂îÍ∞Ä
    function addSaleMarginRow() {
      settings.saleMargins.splice(settings.saleMargins.length - 1, 0, { amount: 0, percent: 15 });
      renderSaleMarginRows();
    }

    // Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ Ìñâ ÏÇ≠Ï†ú
    function deleteSupplyMargin(index) {
      if (settings.supplyMargins[index].amount !== Infinity) {
        settings.supplyMargins.splice(index, 1);
        renderSupplyMarginRows();
      }
    }

    // ÌåêÎß§Í∞Ä ÎßàÏßÑ Ìñâ ÏÇ≠Ï†ú
    function deleteSaleMargin(index) {
      if (settings.saleMargins[index].amount !== Infinity) {
        settings.saleMargins.splice(index, 1);
        renderSaleMarginRows();
      }
    }

    // Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ Ï†ïÎ†¨
    function sortSupplyMarginRows() {
      const infinityRow = settings.supplyMargins.pop();
      settings.supplyMargins.sort((a, b) => a.amount - b.amount);
      settings.supplyMargins.push(infinityRow);
      renderSupplyMarginRows();
    }

    // ÌåêÎß§Í∞Ä ÎßàÏßÑ Ï†ïÎ†¨
    function sortSaleMarginRows() {
      const infinityRow = settings.saleMargins.pop();
      settings.saleMargins.sort((a, b) => a.amount - b.amount);
      settings.saleMargins.push(infinityRow);
      renderSaleMarginRows();
    }

    // Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ Î™®Îëê ÏÇ≠Ï†ú
    function clearSupplyMarginRows() {
      if (confirm('Î™®Îì† Í≥µÍ∏âÍ∞Ä ÎßàÏßÑ ÏÑ§Ï†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        settings.supplyMargins = [{ amount: Infinity, percent: 30 }];
        renderSupplyMarginRows();
      }
    }

    // ÌåêÎß§Í∞Ä ÎßàÏßÑ Î™®Îëê ÏÇ≠Ï†ú
    function clearSaleMarginRows() {
      if (confirm('Î™®Îì† ÌåêÎß§Í∞Ä ÎßàÏßÑ ÏÑ§Ï†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        settings.saleMargins = [{ amount: Infinity, percent: 15 }];
        renderSaleMarginRows();
      }
    }

    // ÏÑ§Ï†ï Ï†ÄÏû•
    async function saveSettings() {
      // Ï†ïÎ≥¥ ÏÑ§Ï†ï Ï†ÄÏû•
      settings.coupangId = document.getElementById('settingsCoupangId').value || '';
      settings.coupangPassword = document.getElementById('settingsCoupangPassword').value || '';
      settings.address = document.getElementById('settingsAddress').value || '';
      settings.brandName = document.getElementById('settingsBrandName').value || '';

      // Í∞ÄÍ≤© ÏÑ§Ï†ï Ï†ÄÏû•
      settings.exchangeRate = parseFloat(document.getElementById('settingsExchangeRate').value) || 190;
      settings.packagingCost = parseFloat(document.getElementById('settingsPackagingCost').value) || 500;
      settings.shipmentCost = parseFloat(document.getElementById('settingsShipmentCost').value) || 0;
      settings.minMargin = parseFloat(document.getElementById('settingsMinMargin').value) || 3000;

      // Í≤¨Ï†ÅÏÑú ÏûëÏÑ± ÏñëÏãù Ï†ÄÏû•
      settings.quotationMappings = window.quotationMappings || [];

      await saveSettingsToStorage();
      closeSettingsModal();
      alert('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    }

    // ÌÖúÌîåÎ¶ø ÏÑ§Ï†ï Í¥ÄÎ†® Ìï®ÏàòÎì§

    // Î∏åÎûúÎìú Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
    function handleBrandImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          settings.brandImageUrl = e.target.result;
          document.getElementById('brandImagePreview').style.display = 'block';
          document.getElementById('brandImagePreviewImg').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    // Í∏∞Î≥∏ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÌÖúÌîåÎ¶ø Î†åÎçîÎßÅ
    function renderDefaultDetailTemplate() {
      const container = document.getElementById('defaultDetailTemplateContainer');
      container.innerHTML = '';

      settings.defaultDetailTemplate.forEach((item, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 6px;';

        div.innerHTML = `
          <span style="flex: 1; font-size: 14px;">${item.label}</span>
          ${index > 0 ? `<button class="btn btn-sm btn-secondary" onclick="moveTemplateItem(${index}, -1)">‚Üë</button>` : ''}
          ${index < settings.defaultDetailTemplate.length - 1 ? `<button class="btn btn-sm btn-secondary" onclick="moveTemplateItem(${index}, 1)">‚Üì</button>` : ''}
          ${item.type === 'text' ? `<button class="btn btn-sm btn-secondary" onclick="deleteTemplateItem(${index})">ÏÇ≠Ï†ú</button>` : ''}
        `;
        container.appendChild(div);
      });
    }

    // ÌÖúÌîåÎ¶ø Ìï≠Î™© Ïù¥Îèô
    function moveTemplateItem(index, direction) {
      const newIndex = index + direction;
      if (newIndex >= 0 && newIndex < settings.defaultDetailTemplate.length) {
        const temp = settings.defaultDetailTemplate[index];
        settings.defaultDetailTemplate[index] = settings.defaultDetailTemplate[newIndex];
        settings.defaultDetailTemplate[newIndex] = temp;
        renderDefaultDetailTemplate();
      }
    }

    // ÌÖúÌîåÎ¶ø ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
    function addDefaultTemplateText() {
      const text = prompt('Ï∂îÍ∞ÄÌï† ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
      if (text) {
        settings.defaultDetailTemplate.push({ type: 'text', label: text });
        renderDefaultDetailTemplate();
      }
    }

    // ÌÖúÌîåÎ¶ø Ìï≠Î™© ÏÇ≠Ï†ú
    function deleteTemplateItem(index) {
      if (confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        settings.defaultDetailTemplate.splice(index, 1);
        renderDefaultDetailTemplate();
      }
    }

    // ÌÖúÌîåÎ¶ø Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
    function resetDefaultTemplate() {
      if (confirm('Í∏∞Î≥∏ ÌÖúÌîåÎ¶øÏúºÎ°ú Î¶¨ÏÖãÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        settings.defaultDetailTemplate = [
          { type: 'brand-image', label: 'Î∏åÎûúÎìú Ïù¥ÎØ∏ÏßÄ' },
          { type: 'title', label: 'Ï†úÌíàÎ™Ö' },
          { type: 'option-blocks', label: 'ÏòµÏÖò Î∏îÎ°ùÎì§' },
          { type: 'quality-table', label: 'ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠' }
        ];
        renderDefaultDetailTemplate();
      }
    }

    // ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠ Í∏∞Î≥∏ Ìñâ Î†åÎçîÎßÅ
    function renderDefaultQualityRows() {
      const container = document.getElementById('defaultQualityRowsContainer');
      container.innerHTML = '';

      settings.defaultQualityRows.forEach((row, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';

        div.innerHTML = `
          <input type="text" value="${row.label}"
            onchange="updateDefaultQualityRow(${index}, 'label', this.value)"
            placeholder="Ìï≠Î™©Î™Ö" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="text" value="${row.value}"
            onchange="updateDefaultQualityRow(${index}, 'value', this.value)"
            placeholder="Í∏∞Î≥∏Í∞í" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <button class="btn btn-sm btn-secondary" onclick="deleteDefaultQualityRow(${index})">ÏÇ≠Ï†ú</button>
        `;
        container.appendChild(div);
      });
    }

    // ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠ Ìñâ ÏóÖÎç∞Ïù¥Ìä∏
    function updateDefaultQualityRow(index, field, value) {
      settings.defaultQualityRows[index][field] = value;
    }

    // ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠ Ìñâ Ï∂îÍ∞Ä
    function addDefaultQualityRow() {
      settings.defaultQualityRows.push({ label: '', value: '' });
      renderDefaultQualityRows();
    }

    // ÌíàÏßàÌëúÏãúÏÇ¨Ìï≠ Ìñâ ÏÇ≠Ï†ú
    function deleteDefaultQualityRow(index) {
      settings.defaultQualityRows.splice(index, 1);
      renderDefaultQualityRows();
    }

    // ===== Ïø†Ìå° ÏóÖÎ°úÎìú Í¥ÄÎ†® =====

    // Ïø†Ìå° ÏóÖÎ°úÎìú Ï§ÄÎπÑ
    async function prepareCoupangUpload() {
      try {
        console.log('üöÄ Preparing Coupang upload...');

        // ÏÑ†ÌÉùÎêú ÏÉÅÌíà ÌôïÏù∏
        if (selectedProducts.size === 0) {
          alert('ÏóÖÎ°úÎìúÌï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }

        // ÏÑ§Ï†ï ÌôïÏù∏
        if (!settings.coupangId || !settings.coupangPassword) {
          alert('ÏÑ§Ï†ïÏóêÏÑú Ïø†Ìå° ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
          openSettingsModal();
          return;
        }

        // ÏÑ†ÌÉùÎêú ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ ÏàòÏßë - ÏÑúÎ≤ÑÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        console.log('üì¶ Fetching fresh product data from server...');
        const selectedProductData = [];

        for (const productId of selectedProducts) {
          try {
            const response = await authFetch(`/api/products/${productId}`);

            if (response.ok) {
              const data = await response.json();
              const product = data.product || data;
              selectedProductData.push(product);

              // ÎîîÎ≤ÑÍπÖ: ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
              console.log(`   ‚úÖ Loaded product ${productId}:`);
              console.log(`      - title: ${(product.title || product.titleCn || '').substring(0, 30)}`);
              console.log(`      - has detailHtml: ${!!product.detailHtml}`);
              console.log(`      - detailHtml length: ${product.detailHtml ? product.detailHtml.length : 0}`);
              console.log(`      - results count: ${product.results?.length || 0}`);
              console.log(`      - images count: ${product.images?.length || 0}`);
            } else {
              console.error(`   ‚ùå Failed to load product ${productId}`);
              // Fallback to stale data
              const fallback = allProducts.find(p => p.id === productId);
              if (fallback) selectedProductData.push(fallback);
            }
          } catch (error) {
            console.error(`   ‚ùå Error loading product ${productId}:`, error);
            // Fallback to stale data
            const fallback = allProducts.find(p => p.id === productId);
            if (fallback) selectedProductData.push(fallback);
          }
        }

        console.log('üì¶ Selected products:', selectedProductData.length);

        // ExtensionÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° (window.postMessage ÏÇ¨Ïö©)
        console.log('üì§ Sending data to Chrome Extension...');
        const response = await sendMessageToExtension('uploadToCoupang', {
          action: 'uploadToCoupang',
          data: {
            products: selectedProductData,
            settings: {
              coupangId: settings.coupangId,
              coupangPassword: settings.coupangPassword,
              address: settings.address
            }
          }
        });

        console.log('‚úÖ Extension response:', response);
        if (response && response.success) {
          alert('Ïø†Ìå° ÏóÖÎ°úÎìúÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.\nÏÉà ÌÉ≠ÏóêÏÑú ÏßÑÌñâ ÏÉÅÌô©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        } else {
          alert('ÏóÖÎ°úÎìú ÏãúÏûë Ïã§Ìå®:\n' + (response?.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }

      } catch (error) {
        console.error('‚ùå Coupang upload error:', error);
        alert('Ïø†Ìå° ÏóÖÎ°úÎìú Ï§ÄÎπÑ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n' + error.message);
      }
    }

    // Ïø†Ìå° Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ Î∞è ÏãúÎèÑ
    async function checkCoupangLogin() {
      try {
        console.log('üîç Checking Coupang login status...');

        // ÏÑ§Ï†ï ÌôïÏù∏
        if (!settings.coupangId || !settings.coupangPassword) {
          alert('ÏÑ§Ï†ïÏóêÏÑú Ïø†Ìå° ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
          openSettingsModal();
          return;
        }

        // Î°úÍ∑∏Ïù∏ ÏãúÎèÑ Ï§ë ÌëúÏãú
        const loginIcon = document.getElementById('coupangLoginIcon');
        const loginBtn = document.getElementById('coupangLoginStatus');
        loginIcon.textContent = '‚è≥';
        loginBtn.disabled = true;

        // ExtensionÏúºÎ°ú Î°úÍ∑∏Ïù∏ ÏãúÎèÑ ÏöîÏ≤≠ (window.postMessage ÏÇ¨Ïö©)
        console.log('üì§ Requesting Coupang login...');
        sendMessageToExtension('checkCoupangLogin', {
          action: 'checkCoupangLogin',
          credentials: {
            coupangId: settings.coupangId,
            coupangPassword: settings.coupangPassword
          }
        }).then((response) => {
          loginBtn.disabled = false;

          console.log('‚úÖ Login check response:', response);
          if (response && response.success) {
            loginIcon.textContent = '‚úÖ';
            alert('Ïø†Ìå° Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!');
          } else {
            loginIcon.textContent = '‚ùå';
            alert('Ïø†Ìå° Î°úÍ∑∏Ïù∏ Ïã§Ìå®:\n' + (response?.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
          }
        }).catch((error) => {
          loginBtn.disabled = false;
          loginIcon.textContent = '‚ùå';
          console.error('‚ùå Extension Error:', error);
          alert('ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû® Ïò§Î•ò:\n' + error.message);
        });

      } catch (error) {
        console.error('‚ùå Login check error:', error);
        document.getElementById('coupangLoginIcon').textContent = '‚ùå';
        document.getElementById('coupangLoginStatus').disabled = false;
        alert('Î°úÍ∑∏Ïù∏ ÌôïÏù∏ Ï§ë Ïò§Î•ò:\n' + error.message);
      }
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Extension Ïó∞Í≤∞ ÌôïÏù∏ Î∞è Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Ï≤¥ÌÅ¨
    window.addEventListener('load', () => {
      console.log('‚úÖ TotalBot page loaded');

      // Extension Í∞êÏßÄ (content scriptÍ∞Ä Ï£ºÏûÖÌïòÎäî ID)
      setTimeout(() => {
        detectExtension();

        // ÏûêÎèôÏúºÎ°ú Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ (Î∞±Í∑∏ÎùºÏö¥Îìú)
        if (extensionId && settings.coupangId && settings.coupangPassword) {
          checkCoupangLoginStatus();
        }
      }, 500);
    });

    // Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎßå ÌôïÏù∏ (ÏÇ¨Ïö©Ïûê Ïù∏ÌÑ∞ÎûôÏÖò ÏóÜÏù¥)
    async function checkCoupangLoginStatus() {
      try {
        const response = await sendMessageToExtension('getCoupangLoginStatus', {
          action: 'getCoupangLoginStatus'
        });

        if (response && response.loggedIn) {
          document.getElementById('coupangLoginIcon').textContent = '‚úÖ';
          console.log('‚úÖ Already logged in to Coupang');
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Could not check login status:', error.message);
      }
    }

    // QVT Ïø†ÌÇ§ Î¶¨ÏÖã
    async function resetQvtCookies() {
      if (!confirm('Ïø†Ìå° QVT ÌéòÏù¥ÏßÄÏùò Ïø†ÌÇ§Î•º Î¶¨ÏÖãÌïòÍ≥† ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.\n\nÏø†ÌÇ§ Í¥ÄÎ†® Ïò§Î•òÍ∞Ä Î∞úÏÉùÌï† Îïå ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.')) {
        return;
      }

      try {
        const response = await sendMessageToExtension('resetQvtCookies', {
          action: 'resetQvtCookies'
        });

        if (response && response.success) {
          alert(`‚úÖ QVT Ïø†ÌÇ§ Î¶¨ÏÖã ÏôÑÎ£å!\n\nÏÇ≠Ï†úÎêú Ïø†ÌÇ§: ${response.deletedCount}Í∞ú\nÏÉàÎ°úÍ≥†Ïπ®Îêú ÌÉ≠: ${response.reloadedTabs}Í∞ú`);
        } else {
          alert('‚ö†Ô∏è QVT Ïø†ÌÇ§ Î¶¨ÏÖã Ïã§Ìå®: ' + (response?.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }
      } catch (error) {
        console.error('QVT Ïø†ÌÇ§ Î¶¨ÏÖã Ïò§Î•ò:', error);
        alert('‚ö†Ô∏è QVT Ïø†ÌÇ§ Î¶¨ÏÖã Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    }

    // Îã§Ïö¥Î°úÎìú Í≤ΩÎ°ú Ï¥àÍ∏∞Ìôî
    async function resetDownloadPath() {
      if (!confirm('Ï†ÄÏû• ÏúÑÏπòÎ•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎã§Ïùå Îã§Ïö¥Î°úÎìú Ïãú Ï†ÄÏû• ÏúÑÏπòÎ•º Îã§Ïãú ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.')) {
        return;
      }

      try {
        // Extension storageÏóêÏÑú downloadPath ÏÇ≠Ï†ú
        await sendMessageToExtension('resetDownloadPath', {
          action: 'resetDownloadPath'
        });

        alert('Ï†ÄÏû• ÏúÑÏπòÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.\nÎã§Ïùå Îã§Ïö¥Î°úÎìú Ïãú Ï†ÄÏû• ÏúÑÏπòÎ•º ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.');
      } catch (error) {
        console.error('Ï†ÄÏû• ÏúÑÏπò Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
        alert('Ï†ÄÏû• ÏúÑÏπò Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§:\n' + error.message);
      }
    }
    // ============================================
    // Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ Í¥ÄÎ†® ÏΩîÎìú
    // ============================================

    // Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ ÏÉÅÌÉú Í¥ÄÎ¶¨
    let coupangCategoryState = {
      keyword: '',
      results: [],
      selectedIds: new Set(),
      loading: false
    };

    // Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ Ïó¥Í∏∞
    function openCoupangCategoryModal() {
      document.getElementById('coupangCategoryModal').style.display = 'flex';
      document.getElementById('coupangSearchInput').focus();
    }

    // Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ Îã´Í∏∞
    function closeCoupangCategoryModal() {
      document.getElementById('coupangCategoryModal').style.display = 'none';
      // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      coupangCategoryState = {
        keyword: '',
        results: [],
        selectedIds: new Set(),
        loading: false
      };
      document.getElementById('coupangSearchInput').value = '';
      showCoupangEmptyState();
    }

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ (ÎîîÎ∞îÏö¥Ïä§ Ï†ÅÏö©)
    let coupangSearchTimeout;
    function handleCoupangSearch(e) {
      clearTimeout(coupangSearchTimeout);
      const keyword = e.target.value.trim();

      if (keyword.length === 0) {
        showCoupangEmptyState();
        return;
      }

      coupangSearchTimeout = setTimeout(() => searchCoupangCategories(keyword), 500);
    }

    // Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ API Ìò∏Ï∂ú (Extension ÏÇ¨Ïö©)
    async function searchCoupangCategories(keyword) {
      coupangCategoryState.loading = true;
      showCoupangStatus('loading', 'Í≤ÄÏÉâ Ï§ë...');

      try {
        // ExtensionÏùÑ ÌÜµÌï¥ Ïø†Ìå° API Ìò∏Ï∂ú
        const response = await sendMessageToExtension('searchCategories', {
          action: 'searchCategories',
          keyword: keyword
        });

        console.log('üîç Search response:', response);

        if (!response.success) {
          throw new Error(response.error || 'Í≤ÄÏÉâ Ïã§Ìå®');
        }

        // Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º ÏÉàÎ°úÏö¥ Í≤∞Í≥ºÎ°ú ÍµêÏ≤¥ (ÎàÑÏ†ÅÌïòÏßÄ ÏïäÏùå)
        const newCategories = response.categories || [];
        coupangCategoryState.results = newCategories;
        coupangCategoryState.keyword = keyword;
        // ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ Ï§ë ÏÉà Í≤∞Í≥ºÏóê ÏóÜÎäî Í≤ÉÏùÄ Ïú†ÏßÄ (Ïù¥Ï†ÑÏóê ÏÑ†ÌÉùÌïú Í≤É Î≥¥Ï°¥)

        if (newCategories.length === 0) {
          showCoupangStatus('error', 'Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.');
          showCoupangEmptyState();
        } else {
          hideCoupangStatus();
          renderCoupangResults();
          showCoupangStatus('success', `‚úÖ ${newCategories.length}Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâÎê®`);
          setTimeout(hideCoupangStatus, 3000);
        }
      } catch (error) {
        console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Ïò§Î•ò:', error);

        // Î°úÍ∑∏Ïù∏/ÏÑ∏ÏÖò Í¥ÄÎ†® Ïò§Î•ò Í∞êÏßÄ
        const isLoginError = error.message.includes('<!DOCTYPE') ||
                            error.message.includes('Unexpected token') ||
                            error.message.includes('ÏÑ∏ÏÖò') ||
                            error.message.includes('Î°úÍ∑∏Ïù∏') ||
                            error.message.includes('Ïù∏Ï¶ù') ||
                            error.message.includes('Failed to fetch') ||
                            error.message.includes('ÎÑ§Ìä∏ÏõåÌÅ¨');

        if (isLoginError) {
          showCoupangStatus('error', '‚ö†Ô∏è Ïø†Ìå° ÏÑ∏ÏÖò Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
          // Ïø†Ìå° Î°úÍ∑∏Ïù∏/ÏÉàÎ°úÍ≥†Ïπ® ÏïàÎÇ¥ ÌëúÏãú
          const resultsDiv = document.getElementById('coupangResults');
          resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <p style="color: #e74c3c; font-size: 16px; margin-bottom: 15px;">
                ‚ö†Ô∏è Ïø†Ìå° Wing Ïó∞Í≤∞ Î¨∏Ï†ú
              </p>
              <p style="color: #666; margin-bottom: 20px;">
                ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÍ±∞ÎÇò ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.<br>
                ÏïÑÎûò Î∞©Î≤ïÏùÑ ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî:
              </p>
              <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="resetQvtCookies()"
                        style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                  üîÑ QVT Ïø†ÌÇ§ Î¶¨ÏÖã
                </button>
                <button onclick="window.open('https://supplier.coupang.com/qvt/registration', '_blank')"
                        style="padding: 12px 24px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                  üîó QVT ÌéòÏù¥ÏßÄ Ïó¥Í∏∞
                </button>
                <button onclick="window.open('https://wing.coupang.com', '_blank')"
                        style="padding: 12px 24px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                  üîê Wing Î°úÍ∑∏Ïù∏ÌïòÍ∏∞
                </button>
              </div>
            </div>
          `;
        } else {
          showCoupangStatus('error', `Ïò§Î•ò: ${error.message}`);
          showCoupangEmptyState();
        }
      } finally {
        coupangCategoryState.loading = false;
      }
    }

    // Í≤ÄÏÉâ Í≤∞Í≥º Î†åÎçîÎßÅ
    function renderCoupangResults() {
      const resultsDiv = document.getElementById('coupangResults');
      resultsDiv.innerHTML = coupangCategoryState.results.map(cat => `
        <div
          class="coupang-category-item ${coupangCategoryState.selectedIds.has(cat.id) ? 'selected' : ''}"
          onclick="toggleCoupangCategory('${cat.id}')"
        >
          <input
            type="checkbox"
            class="coupang-category-checkbox"
            ${coupangCategoryState.selectedIds.has(cat.id) ? 'checked' : ''}
            onchange="event.stopPropagation(); toggleCoupangCategory('${cat.id}')"
          >
          <div class="coupang-category-content">
            <div class="coupang-category-name">${cat.name}</div>
            <div class="coupang-category-path">${cat.path}</div>
          </div>
        </div>
      `).join('');

      updateCoupangDownloadButton();
    }

    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù/Ìï¥Ï†ú
    function toggleCoupangCategory(categoryId) {
      if (coupangCategoryState.selectedIds.has(categoryId)) {
        coupangCategoryState.selectedIds.delete(categoryId);
      } else {
        coupangCategoryState.selectedIds.add(categoryId);
      }
      renderCoupangResults();
    }

    // Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    function updateCoupangDownloadButton() {
      const count = coupangCategoryState.selectedIds.size;
      const downloadBtn = document.getElementById('coupangDownloadBtn');
      const btnText = document.getElementById('coupangBtnText');

      downloadBtn.disabled = count === 0;
      btnText.textContent = count > 0
        ? `Í≤¨Ï†ÅÏÑú Îã§Ïö¥Î°úÎìú (${count}Í∞ú ÏÑ†ÌÉùÎê®)`
        : 'Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
    }

    // Í≤¨Ï†ÅÏÑú Îã§Ïö¥Î°úÎìú
    async function downloadCoupangQuotation() {
      if (coupangCategoryState.selectedIds.size === 0) return;

      const downloadBtn = document.getElementById('coupangDownloadBtn');
      const btnText = document.getElementById('coupangBtnText');

      downloadBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> Îã§Ïö¥Î°úÎìú Ï§ë...';

      try {
        // ExtensionÏùÑ ÌÜµÌï¥ Ïø†Ìå° API Ìò∏Ï∂ú
        const response = await sendMessageToExtension('downloadQuotation', {
          action: 'downloadQuotation',
          categoryIds: Array.from(coupangCategoryState.selectedIds),
          categories: coupangCategoryState.results.filter(c =>
            coupangCategoryState.selectedIds.has(c.id)
          )
        });

        if (!response.success) {
          throw new Error(response.error || 'Îã§Ïö¥Î°úÎìú Ïã§Ìå®');
        }

        console.log('‚úÖ Download response:', response);

        // ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î™®Îã¨ Ïó¥Í∏∞
        if (response.excelData && response.excelData.length > 0) {
          console.log('üìä Excel data received:', response.excelData);

          btnText.textContent = '‚úÖ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!';

          // Ïû†Ïãú ÌõÑ ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î™®Îã¨ Ïó¥Í∏∞
          setTimeout(() => {
            closeCoupangCategoryModal();
            showDetailCategoryModal(response.excelData);
          }, 1000);
        } else {
          // ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Ï≤òÎ¶¨
          const message = response.message || 'Í≤¨Ï†ÅÏÑú ZIP ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.';
          const filename = response.filename || 'Ïø†Ìå°_Í≤¨Ï†ÅÏÑú.zip';

          console.log('üì• Downloaded file:', filename);
          console.log('üí¨ Message:', message);

          showCoupangStatus('success', '‚úÖ ' + message);
          setTimeout(hideCoupangStatus, 5000);

          btnText.textContent = '‚úÖ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!';
          setTimeout(() => {
            closeCoupangCategoryModal();
          }, 2000);
        }

      } catch (error) {
        console.error('Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
        showCoupangStatus('error', `Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ${error.message}`);
        btnText.textContent = 'Í≤¨Ï†ÅÏÑú Îã§Ïö¥Î°úÎìú';
        downloadBtn.disabled = false;
      }
    }

    // ÏÉÅÌÉú ÌëúÏãú
    function showCoupangStatus(type, message) {
      const statusDiv = document.getElementById('coupangStatus');
      statusDiv.className = `coupang-status ${type}`;
      statusDiv.textContent = message;
    }

    function hideCoupangStatus() {
      document.getElementById('coupangStatus').className = 'coupang-status';
    }

    // Îπà ÏÉÅÌÉú ÌëúÏãú
    function showCoupangEmptyState() {
      document.getElementById('coupangResults').innerHTML = `
        <div class="coupang-empty-state">
          <p style="font-size: 48px;">üì¶</p>
          <h3>Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî</h3>
          <p>ÏÉÅÎã® Í≤ÄÏÉâÏ∞ΩÏóê ÏõêÌïòÎäî Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
        </div>
      `;
    }

    // ============================================
    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏùºÍ¥Ñ ÏàòÏßë Î™®Îã¨ Í¥ÄÎ†® ÏΩîÎìú (Í∞ÑÏÜåÌôî Î≤ÑÏ†Ñ)
    // ============================================

    // ÏùºÍ¥Ñ ÏàòÏßë ÏÉÅÌÉú Í¥ÄÎ¶¨
    let batchCategoryState = {
      searchResults: [],                // ÌòÑÏû¨ Í≤ÄÏÉâ Í≤∞Í≥º
      downloadingIds: new Set(),        // Îã§Ïö¥Î°úÎìú Ï§ëÏù∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ID
      completedCategories: new Map(),   // ÏôÑÎ£åÎêú Ïπ¥ÌÖåÍ≥†Î¶¨: categoryId -> { category, excelData, detailSelections }
      currentDetailData: null           // ÌòÑÏû¨ ÏÑ∏Î∂Ä ÏÑ†ÌÉù Ï§ëÏù∏ Îç∞Ïù¥ÌÑ∞
    };

    // Î™®Îã¨ Ïó¥Í∏∞
    function openBatchCategoryModal() {
      document.getElementById('batchCategoryModal').style.display = 'flex';
      // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      batchCategoryState = {
        searchResults: [],
        downloadingIds: new Set(),
        completedCategories: new Map(),
        currentDetailData: null
      };
      document.getElementById('batchSearchInput').value = '';
      renderBatchCategoryResults();
      renderCompletedSummary();
      updateBatchProceedButton();
    }

    // Î™®Îã¨ Îã´Í∏∞
    function closeBatchCategoryModal() {
      document.getElementById('batchCategoryModal').style.display = 'none';
    }

    // ÌÇ§ÏõåÎìú Í≤ÄÏÉâ
    async function searchBatchKeyword() {
      const input = document.getElementById('batchSearchInput');
      const keyword = input.value.trim();
      if (!keyword) return;

      // Í≤ÄÏÉâ Ï§ë ÏÉÅÌÉú ÌëúÏãú
      const resultsDiv = document.getElementById('batchCategoryResults');
      resultsDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <div class="spinner" style="margin: 0 auto 12px;"></div>
          <p>"${keyword}" Í≤ÄÏÉâ Ï§ë...</p>
        </div>
      `;

      try {
        const response = await sendMessageToExtension('searchCategories', {
          action: 'searchCategories',
          keyword: keyword
        });

        if (!response.success) {
          throw new Error(response.error || 'Í≤ÄÏÉâ Ïã§Ìå®');
        }

        batchCategoryState.searchResults = response.categories || [];
        renderBatchCategoryResults();

      } catch (error) {
        console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Ïò§Î•ò:', error);

        // ÏÑ∏ÏÖò ÎßåÎ£å ÎòêÎäî ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨ Í∞êÏßÄ Ïãú ÏûêÎèô Î≥µÍµ¨ ÏãúÎèÑ
        const errorMsg = error.message || '';
        const isSessionError = errorMsg.includes('ÏÑ∏ÏÖò') || errorMsg.includes('Î°úÍ∑∏Ïù∏') || errorMsg.includes('session') || errorMsg.includes('login');
        const isNetworkError = errorMsg.includes('ÎÑ§Ìä∏ÏõåÌÅ¨') || errorMsg.includes('network') || errorMsg.includes('ÏÉàÎ°úÍ≥†Ïπ®');

        if (isSessionError || isNetworkError) {
          console.log('üîÑ ÏÑ∏ÏÖò/ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Í∞êÏßÄ - ÏûêÎèô Î≥µÍµ¨ ÏãúÎèÑ...');
          resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #f59e0b;">
              <div class="spinner" style="margin: 0 auto 12px;"></div>
              <p>${isNetworkError ? 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Í∞êÏßÄ' : 'ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§'}</p>
              <p style="font-size: 14px; color: #888;">Ïø†ÌÇ§ Ï†ïÎ¶¨ Î∞è Ïû¨Î°úÍ∑∏Ïù∏ ÏãúÎèÑ Ï§ë...</p>
            </div>
          `;

          // ÏûêÎèô Î≥µÍµ¨ ÏãúÎèÑ (Ïø†ÌÇ§ ÏÇ≠Ï†ú + Î°úÍ∑∏Ïù∏ + Ïû¨Í≤ÄÏÉâ)
          try {
            await performAutoRecoveryAndRetry(keyword, isNetworkError);
          } catch (recoveryError) {
            console.error('ÏûêÎèô Î≥µÍµ¨ Ïã§Ìå®:', recoveryError);
            resultsDiv.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #dc2626;">
                <p style="font-size: 36px;">‚ùå</p>
                <p>ÏûêÎèô Î≥µÍµ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§</p>
                <p style="font-size: 13px; color: #888; margin: 8px 0;">${recoveryError.message || ''}</p>
                <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px;">
                  <button onclick="performManualRecovery()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üîÑ Ïø†ÌÇ§ Î¶¨ÏÖã + Ïû¨Î°úÍ∑∏Ïù∏
                  </button>
                  <button onclick="checkCoupangLogin()" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üîê Î°úÍ∑∏Ïù∏Îßå
                  </button>
                </div>
              </div>
            `;
          }
          return;
        }

        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <p style="font-size: 36px;">‚ùå</p>
            <p>Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>
            <p style="font-size: 13px; color: #888;">${errorMsg}</p>
          </div>
        `;
      }
    }

    // ÏûêÎèô Î≥µÍµ¨ ÌõÑ Ïû¨Í≤ÄÏÉâ ÏàòÌñâ (Ïø†ÌÇ§ ÏÇ≠Ï†ú + Î°úÍ∑∏Ïù∏ + Ïû¨Í≤ÄÏÉâ)
    async function performAutoRecoveryAndRetry(keyword, resetCookies = true) {
      // ÏÑ§Ï†ï ÌôïÏù∏
      if (!settings.coupangId || !settings.coupangPassword) {
        throw new Error('Ïø†Ìå° Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
      }

      // Î°úÍ∑∏Ïù∏ ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
      const loginIcon = document.getElementById('coupangLoginIcon');
      const loginBtn = document.getElementById('coupangLoginStatus');
      loginIcon.textContent = '‚è≥';
      loginBtn.disabled = true;

      const resultsDiv = document.getElementById('batchCategoryResults');

      try {
        // 1. Ïø†ÌÇ§ Î¶¨ÏÖã (ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Ïãú)
        if (resetCookies) {
          console.log('üç™ Ïø†Ìå° Ïø†ÌÇ§ Î¶¨ÏÖã Ï§ë...');
          resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #f59e0b;">
              <div class="spinner" style="margin: 0 auto 12px;"></div>
              <p>Ïø†ÌÇ§ Ï†ïÎ¶¨ Ï§ë...</p>
            </div>
          `;

          try {
            const cookieResponse = await sendMessageToExtension('resetQvtCookies', {
              action: 'resetQvtCookies'
            });
            console.log('üç™ Ïø†ÌÇ§ Î¶¨ÏÖã Í≤∞Í≥º:', cookieResponse);
          } catch (e) {
            console.warn('‚ö†Ô∏è Ïø†ÌÇ§ Î¶¨ÏÖã Ïã§Ìå® (Í≥ÑÏÜç ÏßÑÌñâ):', e);
          }

          // Ïø†ÌÇ§ ÏÇ≠Ï†ú ÌõÑ Ïû†Ïãú ÎåÄÍ∏∞
          await new Promise(resolve => setTimeout(resolve, 1500));
        }

        // 2. Î°úÍ∑∏Ïù∏ ÏãúÎèÑ
        console.log('üîê Ïø†Ìå° Î°úÍ∑∏Ïù∏ ÏãúÎèÑ Ï§ë...');
        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #f59e0b;">
            <div class="spinner" style="margin: 0 auto 12px;"></div>
            <p>Ïø†Ìå° Î°úÍ∑∏Ïù∏ Ï§ë...</p>
          </div>
        `;

        const loginResponse = await sendMessageToExtension('checkCoupangLogin', {
          action: 'checkCoupangLogin',
          credentials: {
            coupangId: settings.coupangId,
            coupangPassword: settings.coupangPassword
          }
        });

        loginBtn.disabled = false;

        if (!loginResponse || !loginResponse.success) {
          loginIcon.textContent = '‚ùå';
          throw new Error(loginResponse?.error || 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®');
        }

        loginIcon.textContent = '‚úÖ';
        console.log('‚úÖ ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ, Ïû¨Í≤ÄÏÉâ ÏãúÎèÑ...');

        // Î°úÍ∑∏Ïù∏ ÌõÑ Ïû†Ïãú ÎåÄÍ∏∞
        await new Promise(resolve => setTimeout(resolve, 1500));

        // 3. Ïû¨Í≤ÄÏÉâ
        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div class="spinner" style="margin: 0 auto 12px;"></div>
            <p>"${keyword}" Ïû¨Í≤ÄÏÉâ Ï§ë...</p>
          </div>
        `;

        const response = await sendMessageToExtension('searchCategories', {
          action: 'searchCategories',
          keyword: keyword
        });

        if (!response.success) {
          throw new Error(response.error || 'Ïû¨Í≤ÄÏÉâ Ïã§Ìå®');
        }

        batchCategoryState.searchResults = response.categories || [];
        renderBatchCategoryResults();

      } catch (error) {
        loginBtn.disabled = false;
        loginIcon.textContent = '‚ùå';
        throw error;
      }
    }

    // ÏàòÎèô Î≥µÍµ¨ Ïã§Ìñâ (Î≤ÑÌäºÏóêÏÑú Ìò∏Ï∂ú)
    async function performManualRecovery() {
      const keyword = document.getElementById('batchSearchInput').value.trim();
      const resultsDiv = document.getElementById('batchCategoryResults');

      resultsDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #f59e0b;">
          <div class="spinner" style="margin: 0 auto 12px;"></div>
          <p>ÏàòÎèô Î≥µÍµ¨ ÏßÑÌñâ Ï§ë...</p>
        </div>
      `;

      try {
        await performAutoRecoveryAndRetry(keyword, true);
      } catch (error) {
        console.error('ÏàòÎèô Î≥µÍµ¨ Ïã§Ìå®:', error);
        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <p style="font-size: 36px;">‚ùå</p>
            <p>Î≥µÍµ¨ Ïã§Ìå®: ${error.message}</p>
            <button onclick="checkCoupangLogin()" style="margin-top: 12px; padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
              üîê ÏàòÎèô Î°úÍ∑∏Ïù∏
            </button>
          </div>
        `;
      }
    }

    // Í≤ÄÏÉâ Í≤∞Í≥º Î†åÎçîÎßÅ
    function renderBatchCategoryResults() {
      const resultsDiv = document.getElementById('batchCategoryResults');

      // Ïù¥ÎØ∏ ÏôÑÎ£åÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ
      const availableResults = batchCategoryState.searchResults.filter(cat =>
        !batchCategoryState.completedCategories.has(cat.id)
      );

      if (availableResults.length === 0 && batchCategoryState.searchResults.length === 0) {
        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #888;">
            <p style="font-size: 36px;">üîç</p>
            <p>Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî</p>
          </div>
        `;
        return;
      }

      if (availableResults.length === 0) {
        resultsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #10b981;">
            <p style="font-size: 36px;">‚úÖ</p>
            <p>Î™®Îì† Í≤∞Í≥ºÍ∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.<br>Îã§Î•∏ ÌÇ§ÏõåÎìúÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî.</p>
          </div>
        `;
        return;
      }

      let html = `<div style="margin-bottom: 8px; font-size: 13px; color: #666;">${availableResults.length}Í∞ú Í≤∞Í≥º</div>`;

      availableResults.forEach(cat => {
        const isDownloading = batchCategoryState.downloadingIds.has(cat.id);
        html += `
          <div class="batch-category-item ${isDownloading ? 'downloading' : ''}">
            <div class="batch-category-content">
              <div class="batch-category-name">${cat.name}</div>
              <div class="batch-category-path">${cat.path || ''}</div>
            </div>
            <button
              class="batch-category-download-btn"
              onclick="downloadAndSelectDetail('${cat.id}', this)"
              ${isDownloading ? 'disabled' : ''}
            >
              ${isDownloading ? '‚è≥' : 'ÏÑ†ÌÉù'}
            </button>
          </div>
        `;
      });

      resultsDiv.innerHTML = html;
    }

    // ÏôÑÎ£åÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ ÏöîÏïΩ Î†åÎçîÎßÅ
    function renderCompletedSummary() {
      const summaryDiv = document.getElementById('batchCompletedSummary');
      const countSpan = document.getElementById('completedCount');
      const chipsDiv = document.getElementById('completedChipsList');

      if (!summaryDiv) return;

      const count = batchCategoryState.completedCategories.size;

      if (count === 0) {
        summaryDiv.style.display = 'none';
        return;
      }

      summaryDiv.style.display = 'block';
      countSpan.textContent = count;

      let chipsHtml = '';
      batchCategoryState.completedCategories.forEach((data, categoryId) => {
        const detailName = Object.values(data.detailSelections)[0]?.optionValue || '';
        chipsHtml += `
          <span style="display: inline-flex; align-items: center; gap: 4px; background: white; border: 1px solid #10b981; color: #059669; padding: 6px 12px; border-radius: 20px; font-size: 13px;">
            <strong>${data.category.name}</strong>
            ${detailName ? `<span style="color: #666; font-size: 11px;">¬∑ ${detailName}</span>` : ''}
            <span style="cursor: pointer; margin-left: 4px; color: #dc2626; font-weight: bold;" onclick="removeCompletedCategory('${categoryId}')">√ó</span>
          </span>
        `;
      });

      chipsDiv.innerHTML = chipsHtml;
    }

    // Îã§Ïö¥Î°úÎìú ÌõÑ ÏÑ∏Î∂Ä ÏÑ†ÌÉù Î™®Îã¨ Ïó¥Í∏∞
    async function downloadAndSelectDetail(categoryId, buttonElement) {
      const category = batchCategoryState.searchResults.find(c => c.id === categoryId);
      if (!category) return;

      batchCategoryState.downloadingIds.add(categoryId);
      buttonElement.disabled = true;
      buttonElement.textContent = '‚è≥';

      try {
        const response = await sendMessageToExtension('downloadQuotation', {
          action: 'downloadQuotation',
          categoryIds: [categoryId],
          categories: [category]
        });

        if (!response.success) {
          throw new Error(response.error || 'Îã§Ïö¥Î°úÎìú Ïã§Ìå®');
        }

        console.log('‚úÖ Download response:', response);

        if (response.excelData && response.excelData.length > 0) {
          // ÏÑ∏Î∂Ä ÏÑ†ÌÉù Î™®Îã¨ Ïó¥Í∏∞
          openBatchDetailModal(categoryId, category, response.excelData);
        } else {
          // ÏÑ∏Î∂Ä ÏÑ†ÌÉù ÏóÜÏù¥ Î∞îÎ°ú ÏôÑÎ£å
          batchCategoryState.completedCategories.set(categoryId, {
            category: category,
            excelData: [],
            detailSelections: {}
          });
          renderBatchCategoryResults();
          renderCompletedSummary();
          updateBatchProceedButton();
        }

      } catch (error) {
        console.error('Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
        alert('Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•ò: ' + error.message);
        buttonElement.textContent = 'ÏÑ†ÌÉù';
        buttonElement.disabled = false;
      } finally {
        batchCategoryState.downloadingIds.delete(categoryId);
      }
    }

    // ÏÑ∏Î∂Ä ÏÑ†ÌÉù Î™®Îã¨ Ïó¥Í∏∞
    function openBatchDetailModal(categoryId, category, excelData) {
      batchCategoryState.currentDetailData = {
        categoryId: categoryId,
        category: category,
        excelData: excelData,
        detailSelections: {}
      };

      const contentDiv = document.getElementById('batchDetailContent');
      let html = `<p style="margin-bottom: 16px; font-weight: 600; color: #374151;">üìÑ ${category.name}</p>`;

      excelData.forEach((excel, idx) => {
        const categoryName = excel.category ? excel.category.name : 'ÏÑ∏Î∂Ä Ïπ¥ÌÖåÍ≥†Î¶¨';
        const dropdownOptions = excel.dropdownOptions || [];

        html += `
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 6px;">${categoryName}</label>
            <select
              id="batchDetailSelect_${idx}"
              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
              onchange="updateBatchDetailDropdown(${idx}, this.value)"
            >
              <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
              ${dropdownOptions.map((opt, optIdx) => `<option value="${optIdx}">${opt}</option>`).join('')}
            </select>
          </div>
        `;
      });

      contentDiv.innerHTML = html;

      // ÌôïÏù∏ Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
      const confirmBtn = document.getElementById('batchDetailConfirmBtn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'ÏÑ∏Î∂Ä Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';

      document.getElementById('batchDetailModal').style.display = 'flex';
    }

    // ÏÑ∏Î∂Ä ÏÑ†ÌÉù Î™®Îã¨ Îã´Í∏∞
    function closeBatchDetailModal() {
      document.getElementById('batchDetailModal').style.display = 'none';
      batchCategoryState.currentDetailData = null;
      renderBatchCategoryResults();
    }

    // ÏÑ∏Î∂Ä ÎìúÎ°≠Îã§Ïö¥ Î≥ÄÍ≤Ω
    function updateBatchDetailDropdown(excelIndex, selectedOptionIndex) {
      if (!batchCategoryState.currentDetailData) return;

      const data = batchCategoryState.currentDetailData;

      if (selectedOptionIndex === '') {
        delete data.detailSelections[excelIndex];
      } else {
        const selectedOption = data.excelData[excelIndex].dropdownOptions[parseInt(selectedOptionIndex)];
        data.detailSelections[excelIndex] = {
          optionIndex: parseInt(selectedOptionIndex),
          optionValue: selectedOption
        };
      }

      // ÌôïÏù∏ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      const allSelected = data.excelData.every((_, idx) => data.detailSelections[idx]);
      const confirmBtn = document.getElementById('batchDetailConfirmBtn');
      confirmBtn.disabled = !allSelected;
      confirmBtn.textContent = allSelected ? '‚úì ÏÑ†ÌÉù ÏôÑÎ£å' : 'ÏÑ∏Î∂Ä Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
    }

    // ÏÑ∏Î∂Ä ÏÑ†ÌÉù ÌôïÏ†ï
    function confirmBatchDetail() {
      const data = batchCategoryState.currentDetailData;
      if (!data) return;

      // ÏôÑÎ£åÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú Ï†ÄÏû•
      batchCategoryState.completedCategories.set(data.categoryId, {
        category: data.category,
        excelData: data.excelData,
        detailSelections: data.detailSelections
      });

      console.log('‚úÖ Category completed:', data.category.name);

      // Î™®Îã¨ Îã´Í∏∞
      closeBatchDetailModal();
      renderCompletedSummary();
      updateBatchProceedButton();
    }

    // ÏôÑÎ£åÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†úÍ±∞
    function removeCompletedCategory(categoryId) {
      batchCategoryState.completedCategories.delete(categoryId);
      renderBatchCategoryResults();
      renderCompletedSummary();
      updateBatchProceedButton();
    }

    // ÏßÑÌñâ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    function updateBatchProceedButton() {
      const proceedBtn = document.getElementById('batchProceedBtn');
      if (!proceedBtn) return;

      const count = batchCategoryState.completedCategories.size;
      proceedBtn.disabled = count === 0;
      proceedBtn.querySelector('span').textContent = count > 0
        ? `Îã§Ïùå Îã®Í≥ÑÎ°ú (${count}Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨)`
        : 'Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
    }

    // Ï†úÌíà ÏàòÏßë Îã®Í≥ÑÎ°ú ÏßÑÌñâ
    function proceedToCollection() {
      if (batchCategoryState.completedCategories.size === 0) {
        alert('ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      console.log('üì¶ Proceeding with categories:', batchCategoryState.completedCategories);

      closeBatchCategoryModal();
      showBatchCollectionModal();
    }

    // ÏàòÏßë ÏÑ§Ï†ï Î™®Îã¨ ÌëúÏãú
    async function showBatchCollectionModal() {
      const modal = document.getElementById('batchCollectionModal');
      const listContainer = document.getElementById('batchCollectionList');

      let html = '';
      let index = 0;

      batchCategoryState.completedCategories.forEach((data, categoryId) => {
        Object.entries(data.detailSelections).forEach(([detailIdx, detail]) => {
          const itemId = `collection_${categoryId}_${detailIdx}`;
          const categoryName = detail.optionValue || detail;

          html += `
            <div class="batch-collection-item" data-item-id="${itemId}" data-category-id="${categoryId}" data-detail-idx="${detailIdx}" data-category-name="${categoryName}">
              <div class="collection-row">
                <div class="collection-category-name" title="${categoryName}">${categoryName}</div>
                <input type="text" class="collection-search-input" id="search_${itemId}" placeholder="AI Ï∂îÏ≤ú Ï§ë..." data-field="searchKeyword" readonly>

                <div class="collection-price-group">
                  <label class="price-radio"><input type="radio" name="price_${itemId}" value="lowest"><span>ÏµúÏ†ÄÍ∞Ä</span></label>
                  <label class="price-radio"><input type="radio" name="price_${itemId}" value="middle"><span>Ï§ëÍ∞ÑÍ∞Ä</span></label>
                  <label class="price-radio"><input type="radio" name="price_${itemId}" value="average"><span>ÌèâÍ∑†Í∞Ä</span></label>
                  <label class="price-radio"><input type="radio" name="price_${itemId}" value="highest"><span>ÏµúÍ≥†Í∞Ä</span></label>
                </div>

                <div class="collection-checkboxes">
                  <label class="collection-checkbox"><input type="checkbox" data-field="newProduct"><span>Ïã†Ï†úÌíà</span></label>
                  <label class="collection-checkbox"><input type="checkbox" data-field="fastDelivery"><span>48ÏãúÍ∞ÑÎ∞∞ÏÜ°</span></label>
                </div>

                <div class="collection-sort-group">
                  <label class="collection-checkbox"><input type="radio" name="sort_${itemId}" data-field="sortPopular" value="popular" checked><span>Ïù∏Í∏∞Ïàú</span></label>
                  <label class="collection-checkbox"><input type="radio" name="sort_${itemId}" data-field="sortSales" value="sales"><span>ÌåêÎß§ÎüâÏàú</span></label>
                </div>

                <div class="collection-random-group">
                  <label class="collection-checkbox"><input type="checkbox" data-field="random" onchange="toggleRandomPages(this, '${itemId}')"><span>ÎûúÎç§</span></label>
                  <input type="number" class="random-pages-input" id="randomPages_${itemId}" data-field="randomPages" min="1" max="100" value="5" placeholder="ÌéòÏù¥ÏßÄ" style="display: none;">
                </div>

                <div class="collection-count-group">
                  <label class="collection-label">ÏàòÏßë Ïàò:</label>
                  <input type="number" class="product-count-input" data-field="productCount" min="1" max="100" value="20">
                </div>
              </div>
            </div>
          `;
          index++;
        });
      });

      listContainer.innerHTML = html;
      modal.style.display = 'flex';

      // AI Ï∂îÏ≤ú Í≤ÄÏÉâÏñ¥ Í∞ÄÏ†∏Ïò§Í∏∞
      suggestAllKeywords();
    }

    // AIÎ°ú Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÎåÄÌï¥ Í≤ÄÏÉâÏñ¥ Ï∂îÏ≤ú
    async function suggestAllKeywords() {
      const items = document.querySelectorAll('.batch-collection-item');

      for (const item of items) {
        const itemId = item.dataset.itemId;
        const categoryName = item.dataset.categoryName;
        const input = document.getElementById(`search_${itemId}`);

        try {
          const suggested = await suggestSearchKeywordAI(categoryName);
          if (input) {
            input.value = suggested;
            input.readOnly = false;
            input.placeholder = 'ÌïúÍµ≠Ïñ¥ Í≤ÄÏÉâÏñ¥';
          }
        } catch (err) {
          console.error('Ï∂îÏ≤ú Ïò§Î•ò:', err);
          // Ïã§Ìå® Ïãú ÎßàÏßÄÎßâ Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö Ï∂îÏ∂ú
          const fallback = categoryName.split('>').pop().replace(/\s*\(\d+\)\s*$/, '').trim();
          if (input) {
            input.value = fallback;
            input.readOnly = false;
            input.placeholder = 'ÌïúÍµ≠Ïñ¥ Í≤ÄÏÉâÏñ¥';
          }
        }
      }
    }

    // AI Í≤ÄÏÉâÏñ¥ Ï∂îÏ≤ú (Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ΩÎ°ú ‚Üí ÌïúÍµ≠Ïñ¥ Í≤ÄÏÉâÏñ¥)
    async function suggestSearchKeywordAI(categoryPath) {
      try {
        const response = await fetch('/api/gemini/suggest-keyword', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ categoryPath })
        });

        if (!response.ok) throw new Error('Suggestion failed');

        const data = await response.json();
        return data.keyword || categoryPath.split('>').pop().replace(/\s*\(\d+\)\s*$/, '').trim();
      } catch (err) {
        console.error('Ï∂îÏ≤ú API Ïò§Î•ò:', err);
        return categoryPath.split('>').pop().replace(/\s*\(\d+\)\s*$/, '').trim();
      }
    }

    // GBK Ïù∏ÏΩîÎî© (ÏÑúÎ≤Ñ API ÏÇ¨Ïö©)
    async function encodeToGBK(chineseText) {
      try {
        const response = await fetch('/api/gemini/encode-gbk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: chineseText })
        });

        if (!response.ok) throw new Error('GBK encoding failed');

        const data = await response.json();
        return data.encoded || encodeURIComponent(chineseText);
      } catch (err) {
        console.error('GBK Ïù∏ÏΩîÎî© API Ïò§Î•ò:', err);
        return encodeURIComponent(chineseText);
      }
    }

    // AI Î≤àÏó≠ (ÌïúÍµ≠Ïñ¥ ‚Üí Ï§ëÍµ≠Ïñ¥)
    async function translateToChineseAI(koreanText) {
      try {
        const response = await fetch('/api/gemini/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: koreanText, targetLang: 'zh' })
        });

        if (!response.ok) throw new Error('Translation failed');

        const data = await response.json();
        return data.translated || koreanText;
      } catch (err) {
        console.error('Î≤àÏó≠ API Ïò§Î•ò:', err);
        return koreanText;
      }
    }

    // ÏàòÏßë ÏÑ§Ï†ï Î™®Îã¨ Îã´Í∏∞
    function closeBatchCollectionModal() {
      document.getElementById('batchCollectionModal').style.display = 'none';
    }

    // Í∞ÄÍ≤© ÎùºÎîîÏò§ ÏÑ†ÌÉù (Îã®Ïùº ÏÑ†ÌÉùÏù¥ÎØÄÎ°ú Î≥ÑÎèÑ Ìï®Ïàò Î∂àÌïÑÏöî)

    // ÎûúÎç§ ÌéòÏù¥ÏßÄ ÏÑ†ÌÉù ÌÜ†Í∏Ä
    function toggleRandomPages(checkbox, itemId) {
      const select = document.getElementById(`randomPages_${itemId}`);
      select.style.display = checkbox.checked ? 'inline-block' : 'none';
    }

    // ÏàòÏßë ÏãúÏûë
    async function startBatchCollection() {
      const items = document.querySelectorAll('.batch-collection-item');
      const collectionData = [];

      // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Î∞è Î°úÎî© ÌëúÏãú
      const startBtn = document.querySelector('#batchCollectionModal .coupang-download-btn');
      const originalBtnText = startBtn.innerHTML;
      startBtn.innerHTML = '<span>üîÑ Î≤àÏó≠ Ï§ë...</span>';
      startBtn.disabled = true;

      try {
        for (const item of items) {
          const itemId = item.dataset.itemId;
          const categoryId = item.dataset.categoryId;
          const detailIdx = item.dataset.detailIdx;
          const categoryName = item.dataset.categoryName;

          const searchKeywordKorean = item.querySelector('[data-field="searchKeyword"]').value.trim();

          // ÌïúÍµ≠Ïñ¥ ‚Üí Ï§ëÍµ≠Ïñ¥ Î≤àÏó≠
          console.log(`üîÑ Î≤àÏó≠ Ï§ë: ${searchKeywordKorean}`);
          let searchKeywordChinese = await translateToChineseAI(searchKeywordKorean);

          // Î≤àÏó≠ Í≤∞Í≥º Ï†ïÎ¶¨ (Î∂àÌïÑÏöîÌïú Î¨∏Ïûê Ï†úÍ±∞)
          searchKeywordChinese = searchKeywordChinese.replace(/["""'']/g, '').trim();

          console.log(`‚úÖ Î≤àÏó≠ ÏôÑÎ£å: ${searchKeywordKorean} ‚Üí ${searchKeywordChinese}`);

          // GBK Ïù∏ÏΩîÎî© (1688ÏùÄ GBK ÏÇ¨Ïö©)
          const searchKeywordGBK = await encodeToGBK(searchKeywordChinese);
          console.log(`‚úÖ GBK Ïù∏ÏΩîÎî©: ${searchKeywordChinese} ‚Üí ${searchKeywordGBK}`);

          // Í∞ÄÍ≤© ÎùºÎîîÏò§ (Îã®Ïùº ÏÑ†ÌÉù)
          const priceRadio = item.querySelector(`input[name="price_${itemId}"]:checked`);
          const selectedPrice = priceRadio ? priceRadio.value : null;

          const newProduct = item.querySelector('[data-field="newProduct"]').checked;
          const fastDelivery = item.querySelector('[data-field="fastDelivery"]').checked;
          const sortPopular = item.querySelector('[data-field="sortPopular"]').checked;
          const sortSales = item.querySelector('[data-field="sortSales"]').checked;
          const random = item.querySelector('[data-field="random"]').checked;
          const randomPages = item.querySelector('[data-field="randomPages"]').value;
          const productCount = item.querySelector('[data-field="productCount"]').value;

          item.style.border = '';

          // 1688 URL ÏÉùÏÑ± (GBK Ïù∏ÏΩîÎî©Îêú ÌÇ§ÏõåÎìú ÏÇ¨Ïö©)
          const url1688 = build1688Url({
            keyword: searchKeywordGBK,  // GBK Ïù∏ÏΩîÎî©Îêú ÌÇ§ÏõåÎìú
            price: selectedPrice,
            sortType: sortPopular ? 'normal' : 'va_sales360',
            random: random,
            randomPages: parseInt(randomPages) || 5
          });

          collectionData.push({
            itemId,
            categoryId,
            detailIdx,
            categoryName,
            searchKeywordKorean,
            searchKeywordChinese,
            searchKeywordGBK,
            selectedPrice,
            newProduct,
            fastDelivery,
            sortType: sortPopular ? 'normal' : 'va_sales360',
            random,
            randomPages: random ? parseInt(randomPages) : 0,
            productCount: parseInt(productCount) || 20,
            url1688
          });
        }

        console.log('üìä Collection data:', collectionData);

        // URL Ï∂úÎ†•
        collectionData.forEach(data => {
          console.log(`üîó ${data.categoryName}: ${data.searchKeywordKorean} ‚Üí ${data.searchKeywordChinese}`);
          console.log(`   URL: ${data.url1688}`);
        });

        // ÏàòÏßë ÏÑ§Ï†ï Î™®Îã¨ Îã´Í∏∞
        closeBatchCollectionModal();

        // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î™®Îã¨ Ïó¥Í∏∞
        openBatchProgressModal(collectionData);

        // ÏùµÏä§ÌÖêÏÖòÏóê ÏùºÍ¥Ñ ÏàòÏßë ÏöîÏ≤≠
        try {
          const response = await sendMessageToExtension('batch1688Collect', {
            action: 'batch1688Collect',
            categories: collectionData
          });

          if (response && response.success) {
            console.log('‚úÖ ÏùºÍ¥Ñ ÏàòÏßë ÏôÑÎ£å:', response);
            updateBatchProgress('completed', response);
          } else {
            console.error('‚ùå ÏùºÍ¥Ñ ÏàòÏßë Ïã§Ìå®:', response);
            updateBatchProgress('error', response);
          }
        } catch (extErr) {
          console.error('‚ùå ÏùµÏä§ÌÖêÏÖò ÌÜµÏã† Ïò§Î•ò:', extErr);
          updateBatchProgress('error', { message: extErr.message });
        }

      } catch (err) {
        console.error('ÏàòÏßë ÏãúÏûë Ïò§Î•ò:', err);
        alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + err.message);
      } finally {
        // Î≤ÑÌäº Î≥µÏõê
        startBtn.innerHTML = originalBtnText;
        startBtn.disabled = false;
      }
    }

    // ÏùºÍ¥Ñ ÏàòÏßë ÌîÑÎ°úÍ∑∏Î†àÏä§ Î™®Îã¨ Ïó¥Í∏∞
    function openBatchProgressModal(categories) {
      const modal = document.getElementById('batchProgressModal');
      const listContainer = document.getElementById('batchProgressList');

      let html = '';
      categories.forEach((cat, idx) => {
        html += `
          <div class="progress-item" id="progress_${cat.itemId}" data-cat-idx="${idx}">
            <div class="progress-info">
              <span class="progress-num">${idx + 1}</span>
              <span class="progress-name">${cat.categoryName}</span>
              <span class="progress-keyword">${cat.searchKeywordKorean}</span>
            </div>
            <div class="progress-status">
              <span class="status-badge pending">ÎåÄÍ∏∞</span>
              <span class="progress-detail"></span>
            </div>
          </div>
        `;
      });

      listContainer.innerHTML = html;
      modal.style.display = 'flex';
    }

    // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î™®Îã¨ Îã´Í∏∞
    function closeBatchProgressModal() {
      document.getElementById('batchProgressModal').style.display = 'none';
    }

    // ÌîÑÎ°úÍ∑∏Î†àÏä§ ÏóÖÎç∞Ïù¥Ìä∏
    function updateBatchProgress(status, data) {
      if (status === 'item') {
        // Í∞úÎ≥Ñ Ìï≠Î™© ÏóÖÎç∞Ïù¥Ìä∏
        const item = document.getElementById(`progress_${data.itemId}`);
        if (item) {
          const badge = item.querySelector('.status-badge');
          const detail = item.querySelector('.progress-detail');

          badge.className = `status-badge ${data.status}`;
          badge.textContent = getStatusText(data.status);
          detail.textContent = data.detail || '';
        }
      } else if (status === 'completed') {
        // Ï†ÑÏ≤¥ ÏôÑÎ£å
        const modal = document.getElementById('batchProgressModal');
        const footer = modal.querySelector('.progress-footer');
        if (footer) {
          footer.innerHTML = `
            <div style="color: #10b981; font-weight: 600;">‚úÖ ÏàòÏßë ÏôÑÎ£å!</div>
            <button class="coupang-download-btn" onclick="closeBatchProgressModal()" style="margin-top: 10px;">Îã´Í∏∞</button>
          `;
        }
      } else if (status === 'error') {
        // Ïò§Î•ò
        const modal = document.getElementById('batchProgressModal');
        const footer = modal.querySelector('.progress-footer');
        if (footer) {
          footer.innerHTML = `
            <div style="color: #ef4444; font-weight: 600;">‚ùå Ïò§Î•ò Î∞úÏÉù: ${data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}</div>
            <button class="coupang-download-btn" onclick="closeBatchProgressModal()" style="margin-top: 10px; background: #ef4444;">Îã´Í∏∞</button>
          `;
        }
      }
    }

    // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î≥ÄÌôò
    function getStatusText(status) {
      const statusMap = {
        'pending': 'ÎåÄÍ∏∞',
        'searching': 'Í≤ÄÏÉâ Ï§ë',
        'collecting': 'ÏàòÏßë Ï§ë',
        'processing': 'AI Ï≤òÎ¶¨ Ï§ë',
        'uploading': 'ÏóÖÎ°úÎìú Ï§ë',
        'completed': 'ÏôÑÎ£å',
        'error': 'Ïò§Î•ò'
      };
      return statusMap[status] || status;
    }

    // 1688 URL ÏÉùÏÑ±
    function build1688Url(options) {
      const { keyword, price, sortType, random, randomPages } = options;

      // 1688ÏùÄ UTF-8 Ïù∏ÏΩîÎî© ÏÇ¨Ïö© - Ï§ëÍµ≠Ïñ¥ ÏßÅÏ†ë Ìè¨Ìï®
      let url = `https://s.1688.com/selloffer/offer_search.htm?keywords=${keyword}`;

      // Ï†ïÎ†¨
      url += `&sortType=${sortType}`;

      // Í∞ÄÍ≤© ÌïÑÌÑ∞ (Ïø†Ìå° Í∞ÄÍ≤© Í∏∞Ï§Ä)
      if (price) {
        // Ïø†Ìå° Í∞ÄÍ≤©ÏùÑ 1688 Í∞ÄÍ≤©ÏúºÎ°ú Î≥ÄÌôò ÌïÑÏöî (ÏûÑÏãúÎ°ú Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
        // TODO: Ïã§Ï†ú Í∞ÄÍ≤© Î≥ÄÌôò Î°úÏßÅ ÌïÑÏöî
        // priceEnd = ÏÑ†ÌÉùÍ∞Ä, priceStart = ÏÑ†ÌÉùÍ∞Ä * 0.5
      }

      // ÌéòÏù¥ÏßÄ (ÎûúÎç§Ïù¥Î©¥ ÎûúÎç§ ÌéòÏù¥ÏßÄ, ÏïÑÎãàÎ©¥ 1ÌéòÏù¥ÏßÄ)
      const page = random ? Math.floor(Math.random() * randomPages) + 1 : 1;
      url += `&beginPage=${page}`;

      return url;
    }

  </script>

  <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏùºÍ¥Ñ ÏàòÏßë Î™®Îã¨ -->
  <div id="batchCategoryModal">
    <div class="coupang-modal-content" style="max-width: 700px;">
      <div class="coupang-modal-header">
        <h2>üìÅ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏùºÍ¥Ñ ÏàòÏßë</h2>
        <button class="coupang-modal-close" onclick="closeBatchCategoryModal()">√ó</button>
      </div>

      <div class="coupang-modal-body">
        <!-- ÏÑ†ÌÉù ÏôÑÎ£åÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ (ÏÉÅÎã®Ïóê ÌÉúÍ∑∏Î°ú ÌëúÏãú) -->
        <div id="batchCompletedSummary" style="display: none; margin-bottom: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px;">
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #059669; font-size: 13px;">‚úÖ ÏÑ†ÌÉù ÏôÑÎ£å (<span id="completedCount">0</span>Í∞ú)</span>
          </div>
          <div id="completedChipsList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
        </div>

        <!-- Í≤ÄÏÉâÏñ¥ ÏûÖÎ†• -->
        <div style="margin-bottom: 16px;">
          <input
            type="text"
            id="batchSearchInput"
            class="coupang-search-input"
            placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ (Ïòà: Ìã∞ÏÖîÏ∏†, Í∞ÄÎ∞©, Ïã†Î∞ú...)"
            style="width: 100%; padding: 14px 18px; font-size: 15px; border: 2px solid #e0e0e0; border-radius: 10px;"
            onkeypress="if(event.key === 'Enter') searchBatchKeyword()"
          >
        </div>

        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Í≤∞Í≥º -->
        <div id="batchCategoryResults" style="max-height: 350px; overflow-y: auto;"></div>
      </div>

      <div class="coupang-modal-footer">
        <button id="batchProceedBtn" class="coupang-download-btn" onclick="proceedToCollection()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 100%;" disabled>
          <span>Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ÏÑ∏Î∂Ä Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Î™®Îã¨ (Í∞ÑÎã® Î≤ÑÏ†Ñ) -->
  <div id="batchDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">üìù ÏÑ∏Î∂Ä Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</h3>
        <button onclick="closeBatchDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
      </div>
      <div id="batchDetailContent" style="padding: 20px; max-height: 400px; overflow-y: auto;">
        <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
      </div>
      <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb;">
        <button id="batchDetailConfirmBtn" onclick="confirmBatchDetail()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;" disabled>
          ÏÑ∏Î∂Ä Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
        </button>
      </div>
    </div>
  </div>

  <!-- ÏàòÏßë ÏÑ§Ï†ï Î™®Îã¨ (Îã§Ïùå Îã®Í≥Ñ) -->
  <div id="batchCollectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 1000px; max-height: 90vh; overflow: hidden;">
      <div class="coupang-modal-header">
        <h2>üìä ÏàòÏßë ÏÑ§Ï†ï</h2>
        <button class="coupang-modal-close" onclick="closeBatchCollectionModal()">√ó</button>
      </div>

      <div class="coupang-modal-body" style="max-height: calc(90vh - 140px); overflow-y: auto;">
        <div id="batchCollectionList">
          <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
        </div>
      </div>

      <div class="coupang-modal-footer">
        <button class="coupang-download-btn" onclick="startBatchCollection()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); width: 100%;">
          <span>üöÄ ÏàòÏßë ÏãúÏûë</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ÏùºÍ¥Ñ ÏàòÏßë ÌîÑÎ°úÍ∑∏Î†àÏä§ Î™®Îã¨ -->
  <div id="batchProgressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 800px; max-height: 90vh; overflow: hidden;">
      <div class="coupang-modal-header">
        <h2>üì¶ ÏùºÍ¥Ñ ÏàòÏßë ÏßÑÌñâ</h2>
      </div>

      <div class="coupang-modal-body" style="max-height: calc(90vh - 140px); overflow-y: auto;">
        <div id="batchProgressList" class="progress-list">
          <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
        </div>
      </div>

      <div class="coupang-modal-footer progress-footer">
        <div style="color: #3b82f6; font-weight: 600;">üîÑ ÏàòÏßë ÏßÑÌñâ Ï§ë...</div>
      </div>
    </div>
  </div>

  <!-- Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Î™®Îã¨ -->
  <div id="coupangCategoryModal">
    <div class="coupang-modal-content">
      <div class="coupang-modal-header">
        <h2>üè™ Ïø†Ìå° Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤¨Ï†ÅÏÑú</h2>
        <button class="coupang-modal-close" onclick="closeCoupangCategoryModal()">√ó</button>
      </div>

      <div class="coupang-modal-body">
        <div class="coupang-search-box">
          <input
            type="text"
            id="coupangSearchInput"
            class="coupang-search-input"
            placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ (Ïòà: Ìå®ÏÖòÏùòÎ•ò, ÏãùÌíà, Î∑∞Ìã∞...)"
            oninput="handleCoupangSearch(event)"
          >
        </div>

        <div id="coupangStatus" class="coupang-status"></div>

        <div id="coupangResults" class="coupang-category-list">
          <div class="coupang-empty-state">
            <p style="font-size: 48px;">üì¶</p>
            <h3>Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî</h3>
            <p>ÏÉÅÎã® Í≤ÄÏÉâÏ∞ΩÏóê ÏõêÌïòÎäî Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
          </div>
        </div>
      </div>

      <div class="coupang-modal-footer">
        <button id="coupangDownloadBtn" class="coupang-download-btn" onclick="downloadCoupangQuotation()" disabled>
          <span id="coupangBtnText">Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï Î™®Îã¨ -->
  <div id="detailCategoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="coupang-modal-header">
        <h2>üìù ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï</h2>
        <button class="coupang-modal-close" onclick="closeDetailCategoryModal()">√ó</button>
      </div>

      <div class="coupang-modal-body">
        <!-- Step 1: ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù -->
        <div id="categorySelectionStep">
          <p style="margin-bottom: 20px; color: #666;">Í∞Å ÏóëÏÖÄ ÌååÏùºÏùò ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
          <div id="detailCategoryList"></div>
        </div>

        <!-- Step 2: Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏûÖÎ†• -->
        <div id="additionalInfoStep" style="display: none;">
          <p style="margin-bottom: 20px; color: #666;">ÏÉÅÌíà Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>

          <!-- AI ÏùºÍ¥Ñ Ï∂îÍ∞Ä Î≤ÑÌäº -->
          <div style="margin-bottom: 25px;">
            <button
              type="button"
              id="aiBatchBtn"
              onclick="generateAllProductInfo()"
              style="width: 100%; padding: 14px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
            >
              <span id="aiBatchSpinner" style="display: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
              <span id="aiBatchText">ü§ñ AI ÏùºÍ¥Ñ Ï∂îÍ∞Ä (ÌÉúÍ∑∏, ÏÇ¨Ïù¥Ï¶à, Î¨¥Í≤å, Ï∑®Í∏âÏ£ºÏùò, Í≥ÑÏ†à)</span>
            </button>
          </div>

          <!-- Í≤ÄÏÉâÌÉúÍ∑∏ -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              üè∑Ô∏è Í≤ÄÏÉâÌÉúÍ∑∏
            </label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input
                type="text"
                id="searchTagInput"
                placeholder="ÌÉúÍ∑∏Î•º ÏûÖÎ†•ÌïòÍ≥† EnterÎ•º ÎàÑÎ•¥ÏÑ∏Ïöî"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                onkeypress="handleTagInput(event)"
              >
              <button
                type="button"
                id="aiTagBtn"
                onclick="generateAITags()"
                style="padding: 12px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px;"
              >
                <span id="aiTagSpinner" style="display: none; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                <span id="aiTagText">AI Ï∂îÏ≤ú ÌÉúÍ∑∏</span>
              </button>
            </div>
            <div id="tagList" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
          </div>

          <!-- ÏÇ¨Ïù¥Ï¶à -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              üìè ÏÇ¨Ïù¥Ï¶à (Í∞ÄÎ°ú x ÏÑ∏Î°ú x ÎÜíÏù¥)
            </label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input
                type="number"
                id="sizeWidth"
                placeholder="Í∞ÄÎ°ú"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              >
              <span style="color: #999; font-weight: bold;">√ó</span>
              <input
                type="number"
                id="sizeHeight"
                placeholder="ÏÑ∏Î°ú"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              >
              <span style="color: #999; font-weight: bold;">√ó</span>
              <input
                type="number"
                id="sizeDepth"
                placeholder="ÎÜíÏù¥"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              >
            </div>
          </div>

          <!-- Î¨¥Í≤å -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              ‚öñÔ∏è Î¨¥Í≤å (g)
              <span
                style="display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; background: #ddd; color: #666; font-size: 12px; cursor: help; margin-left: 5px;"
                title="1kg = 1000g"
              >?</span>
            </label>
            <input
              type="number"
              id="weightInput"
              placeholder="Î¨¥Í≤åÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 500)"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
            >
          </div>

          <!-- Ï∑®Í∏âÏ£ºÏùò ÏÇ¨Ïú† -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              ‚ö†Ô∏è Ï∑®Í∏âÏ£ºÏùò ÏÇ¨Ïú†
            </label>
            <select
              id="handlingCareInput"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;"
            >
              <option value="Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå">Ìï¥ÎãπÏÇ¨Ìï≠ÏóÜÏùå</option>
              <option value="Ïú†Î¶¨">Ïú†Î¶¨</option>
            </select>
          </div>

          <!-- Í≥ÑÏ†à -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              üå∏ Í≥ÑÏ†à
            </label>
            <select
              id="seasonInput"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;"
            >
              <option value="ÏÇ¨Í≥ÑÏ†à">ÏÇ¨Í≥ÑÏ†à</option>
              <option value="Î¥Ñ">Î¥Ñ</option>
              <option value="Ïó¨Î¶Ñ">Ïó¨Î¶Ñ</option>
              <option value="Í∞ÄÏùÑ">Í∞ÄÏùÑ</option>
              <option value="Í≤®Ïö∏">Í≤®Ïö∏</option>
            </select>
          </div>
        </div>
      </div>

      <div class="coupang-modal-footer" style="flex-direction: column; gap: 12px;">
        <button id="categoryNextBtn" class="coupang-download-btn" onclick="goToAdditionalInfo()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          Îã§Ïùå Îã®Í≥ÑÎ°ú
        </button>
        <div id="categoryFinalBtns" style="display: none; width: 100%;">
          <button class="coupang-download-btn" onclick="saveAllData()" style="background: linear-gradient(135deg, #00c73c 0%, #00a030 100%); margin-bottom: 10px;">
            ‚úÖ ÏôÑÎ£å (ÏûêÎèô ÏóÖÎ°úÎìú)
          </button>
          <button class="coupang-download-btn" onclick="saveAllDataDownloadOnly()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); font-size: 13px; padding: 10px;">
            üì• ÌååÏùºÎßå Îã§Ïö¥Î∞õÍ∏∞
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Î™®Îã¨ -->
  <div id="requiredFieldsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <div class="coupang-modal-header">
        <h2>‚ö†Ô∏è ÌïÑÏàò Ïπ∏ ÏûÖÎ†•</h2>
        <button class="coupang-modal-close" onclick="closeRequiredFieldsModal()">√ó</button>
      </div>

      <div class="coupang-modal-body">
        <p style="margin-bottom: 20px; color: #666;">
          Í≤¨Ï†ÅÏÑúÏóê ÏûÖÎ†•Ïù¥ ÌïÑÏöîÌïú ÌïÑÏàò Ïπ∏Ïù¥ ÏûàÏäµÎãàÎã§.<br>
          Í∞Å Ìï≠Î™©Ïùò ÏòàÏãúÎ•º Ï∞∏Í≥†ÌïòÏó¨ Í∞íÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
        </p>
        <div id="requiredFieldsList"></div>
      </div>

      <div class="coupang-modal-footer">
        <button class="coupang-download-btn" onclick="applyRequiredFields()" style="background: #00c73c;">
          Ï†ÅÏö© Î∞è Í≥ÑÏÜç
        </button>
        <button class="coupang-download-btn" onclick="closeRequiredFieldsModal()" style="background: #666;">
          Ï∑®ÏÜå
        </button>
      </div>
    </div>
  </div>

  <!-- Îã§Ïö¥Î°úÎìú ÏßÑÌñâ Î™®Îã¨ -->
  <div id="downloadProgressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10002; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 40px 50px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div class="download-spinner" style="width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <h3 style="margin: 0 0 10px; color: #333; font-size: 20px;">ÌååÏùº Îã§Ïö¥Î°úÎìú Ï§ë...</h3>
      <p id="downloadProgressText" style="margin: 0; color: #666; font-size: 14px;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- ÏßÅÏ†ë Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ (Ìé∏ÏßëÏôÑÎ£å ÏÉÅÌíàÏö©) -->
  <div id="directQuoteIdModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10002; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px; border-radius: 16px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 25px 30px; color: white;">
        <h2 style="margin: 0; font-size: 22px; font-weight: 600;">
          üìù Í≤¨Ï†ÅÏÑú ID ÏßÅÏ†ë ÏûÖÎ†•
        </h2>
        <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">
          Ïù¥ÎØ∏ Ïø†Ìå°Ïóê ÏóÖÎ°úÎìúÌïú ÏÉÅÌíàÏùò Í≤¨Ï†ÅÏÑú IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî
        </p>
      </div>

      <div style="padding: 25px 30px;">
        <p style="margin: 0 0 15px; color: #666; font-size: 14px;">
          ÏÑ†ÌÉùÌïú ÏÉÅÌíà: <strong id="directQuoteSelectedCount">0</strong>Í∞ú
        </p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
            Í≤¨Ï†ÅÏÑú ID (Ïà´Ïûê)
          </label>
          <input
            type="text"
            id="directQuoteIdInput"
            placeholder="Ïòà: 12345678"
            style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s;"
            onfocus="this.style.borderColor='#10b981'"
            onblur="this.style.borderColor='#e0e0e0'"
          >
        </div>

        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button
            onclick="saveDirectQuoteId()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;"
            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 15px rgba(16,185,129,0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
          >
            ‚úÖ ÏóÖÎ°úÎìú ÏôÑÎ£åÎ°ú Ïù¥Îèô
          </button>
          <button
            onclick="closeDirectQuoteIdModal()"
            style="width: 100%; padding: 12px; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; cursor: pointer;"
          >
            Ï∑®ÏÜå
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ -->
  <div id="quoteIdInputModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10002; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px; border-radius: 16px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px 30px; color: white;">
        <h2 style="margin: 0; font-size: 22px; font-weight: 600;">
          üìã Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•
        </h2>
        <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">
          ÌååÏùº Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!
        </p>
      </div>

      <div style="padding: 30px;">
        <p style="margin: 0 0 20px; color: #555; font-size: 14px; line-height: 1.6;">
          Ïø†Ìå° ÏúôÏóêÏÑú Í≤¨Ï†ÅÏÑúÎ•º ÏàòÎèôÏúºÎ°ú ÏóÖÎ°úÎìúÌïú ÌõÑ,<br>
          Î∞úÍ∏âÎ∞õÏùÄ <strong>Í≤¨Ï†ÅÏÑú ID</strong>Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
        </p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">
            Í≤¨Ï†ÅÏÑú ID (Ïà´Ïûê)
          </label>
          <input
            type="text"
            id="manualQuoteIdInput"
            placeholder="Ïòà: 12345678"
            style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s;"
            onfocus="this.style.borderColor='#667eea'"
            onblur="this.style.borderColor='#e0e0e0'"
          >
        </div>

        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button
            onclick="saveManualQuoteId()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #00c73c 0%, #00a030 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;"
            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 15px rgba(0,199,60,0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
          >
            ‚úÖ ÏßÄÍ∏à ÏûÖÎ†•ÌïòÍ∏∞
          </button>
          <button
            onclick="closeQuoteIdModal()"
            style="width: 100%; padding: 14px; background: #f5f5f5; color: #666; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background 0.2s;"
            onmouseover="this.style.background='#ebebeb'"
            onmouseout="this.style.background='#f5f5f5'"
          >
            ÎÇòÏ§ëÏóê ÏûÖÎ†•ÌïòÍ∏∞
          </button>
        </div>

        <p style="margin: 20px 0 0; color: #999; font-size: 12px; text-align: center;">
          üí° ÎÇòÏ§ëÏóê ÏÉÅÌíà Î™©Î°ùÏóêÏÑú Îã§Ïãú ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§
        </p>
      </div>
    </div>
  </div>

  <script>
    // ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï ÏÉÅÌÉú
    let detailCategoryState = {
      excelData: [],
      selections: {},
      tags: [],
      size: { width: '', height: '', depth: '' },
      weight: ''
    };

    // ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îã¨ Ïó¥Í∏∞ (Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù)
    window.showDetailCategoryModal = function(excelData) {
      console.log('üìã Opening detail category modal with data:', excelData);

      detailCategoryState.excelData = excelData;
      detailCategoryState.selections = {};

      // Î™®Îã¨ ÌëúÏãú
      const modal = document.getElementById('detailCategoryModal');
      modal.style.display = 'flex';

      // Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
      const listDiv = document.getElementById('detailCategoryList');
      listDiv.innerHTML = '';

      excelData.forEach((item, index) => {
        const categoryName = item.category ? item.category.name : 'Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö ÏóÜÏùå';
        const dropdownOptions = item.dropdownOptions || [];

        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'padding: 20px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px;';

        itemDiv.innerHTML = `
          <div style="margin-bottom: 10px;">
            <strong style="font-size: 16px;">üìÑ ${categoryName}</strong>
            <span style="margin-left: 10px; color: #666; font-size: 14px;">(${dropdownOptions.length}Í∞ú ÏòµÏÖò)</span>
          </div>
          <select
            id="detailCategory_${index}"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
            onchange="updateDetailSelection(${index}, this.value)"
          >
            <option value="">ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
            ${dropdownOptions.map((opt, optIndex) => `
              <option value="${optIndex}">${opt}</option>
            `).join('')}
          </select>
        `;

        listDiv.appendChild(itemDiv);
      });
    }

    // ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù ÏóÖÎç∞Ïù¥Ìä∏
    window.updateDetailSelection = function(index, selectedIndex) {
      if (selectedIndex === '') {
        delete detailCategoryState.selections[index];
      } else {
        const selectedOption = detailCategoryState.excelData[index].dropdownOptions[parseInt(selectedIndex)];
        detailCategoryState.selections[index] = {
          optionIndex: parseInt(selectedIndex),
          optionValue: selectedOption
        };
      }

      console.log('‚úÖ Selection updated:', detailCategoryState.selections);
    }

    // ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îã¨ Îã´Í∏∞
    window.closeDetailCategoryModal = function() {
      document.getElementById('detailCategoryModal').style.display = 'none';

      // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      detailCategoryState = {
        excelData: [],
        selections: {},
        tags: [],
        size: { width: '', height: '', depth: '' },
        weight: ''
      };

      // UI Ï¥àÍ∏∞Ìôî
      document.getElementById('categorySelectionStep').style.display = 'block';
      document.getElementById('additionalInfoStep').style.display = 'none';
      document.getElementById('categoryNextBtn').style.display = 'block';
      document.getElementById('categoryFinalBtns').style.display = 'none';
      document.getElementById('searchTagInput').value = '';
      document.getElementById('sizeWidth').value = '';
      document.getElementById('sizeHeight').value = '';
      document.getElementById('sizeDepth').value = '';
      document.getElementById('weightInput').value = '';
      renderTags();
    }

    // Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏûÖÎ†• Îã®Í≥ÑÎ°ú Ïù¥Îèô
    window.goToAdditionalInfo = function() {
      const totalCount = detailCategoryState.excelData.length;
      const selectedCount = Object.keys(detailCategoryState.selections).length;

      if (selectedCount < totalCount) {
        alert(`Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n(ÏÑ†ÌÉù: ${selectedCount}/${totalCount})`);
        return;
      }

      console.log('‚úÖ All categories selected:', detailCategoryState.selections);

      // Step Ï†ÑÌôò
      document.getElementById('categorySelectionStep').style.display = 'none';
      document.getElementById('additionalInfoStep').style.display = 'block';
      document.getElementById('categoryNextBtn').style.display = 'none';
      document.getElementById('categoryFinalBtns').style.display = 'block';
    }

    // ÌÉúÍ∑∏ ÏûÖÎ†• Ï≤òÎ¶¨
    window.handleTagInput = function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('searchTagInput');
        const tag = input.value.trim();

        if (tag && !detailCategoryState.tags.includes(tag)) {
          detailCategoryState.tags.push(tag);
          renderTags();
          input.value = '';
        }
      }
    }

    // ÌÉúÍ∑∏ Î†åÎçîÎßÅ
    window.renderTags = function() {
      const tagList = document.getElementById('tagList');
      tagList.innerHTML = detailCategoryState.tags.map((tag, index) => `
        <div style="display: inline-flex; align-items: center; background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 16px; font-size: 14px;">
          #${tag}
          <button
            onclick="removeTag(${index})"
            style="margin-left: 8px; background: none; border: none; color: #1976d2; cursor: pointer; font-size: 16px; padding: 0; width: 20px; height: 20px;"
          >√ó</button>
        </div>
      `).join('');
    }

    // ÌÉúÍ∑∏ Ï†úÍ±∞
    window.removeTag = function(index) {
      detailCategoryState.tags.splice(index, 1);
      renderTags();
    }

    // AI Ï∂îÏ≤ú ÌÉúÍ∑∏ ÏÉùÏÑ±
    window.generateAITags = async function() {
      const btn = document.getElementById('aiTagBtn');
      const spinner = document.getElementById('aiTagSpinner');
      const text = document.getElementById('aiTagText');

      // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ ÏàòÏßë
      let categoryNames = [];
      let detailCategories = [];

      if (detailCategoryState.excelData && detailCategoryState.excelData.length > 0) {
        // Î©îÏù∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö ÏàòÏßë
        detailCategoryState.excelData.forEach((item, index) => {
          if (item.category && item.category.name) {
            categoryNames.push(item.category.name);
          }
          // ÏÑ†ÌÉùÎêú ÏÉÅÏÑ∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏàòÏßë
          if (detailCategoryState.selections[index]) {
            detailCategories.push(detailCategoryState.selections[index].optionValue);
          }
        });
      }

      if (categoryNames.length === 0) {
        alert('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
      }

      // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥Î•º ÏÉÅÌíàÎ™ÖÏ≤òÎüº ÏÇ¨Ïö©
      const productTitle = categoryNames.join(', ');
      const categoryName = detailCategories.join(', ');

      // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
      btn.disabled = true;
      spinner.style.display = 'inline-block';
      text.textContent = 'ÏÉùÏÑ±Ï§ë...';

      try {
        const response = await fetch('/api/gemini/generate-tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productTitle,
            categoryName
          })
        });

        const result = await response.json();

        if (result.success && result.tags && result.tags.length > 0) {
          // Í∏∞Ï°¥ ÌÉúÍ∑∏ÏôÄ Ï§ëÎ≥µÎêòÏßÄ ÏïäÎäî ÌÉúÍ∑∏Îßå Ï∂îÍ∞Ä
          const newTags = result.tags.filter(tag => !detailCategoryState.tags.includes(tag));
          detailCategoryState.tags.push(...newTags);
          renderTags();
          alert(`${newTags.length}Í∞úÏùò AI Ï∂îÏ≤ú ÌÉúÍ∑∏Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
        } else {
          alert(result.message || 'AI ÌÉúÍ∑∏ Ï∂îÏ≤ú Ïã§Ìå®');
        }
      } catch (error) {
        console.error('AI ÌÉúÍ∑∏ Ï∂îÏ≤ú Ïò§Î•ò:', error);
        alert('AI ÌÉúÍ∑∏ Ï∂îÏ≤ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
        text.textContent = 'AI Ï∂îÏ≤ú ÌÉúÍ∑∏';
      }
    }

    // AI ÏùºÍ¥Ñ Ï∂îÍ∞Ä (ÌÉúÍ∑∏, ÏÇ¨Ïù¥Ï¶à, Î¨¥Í≤å, Ï∑®Í∏âÏ£ºÏùò, Í≥ÑÏ†à)
    window.generateAllProductInfo = async function() {
      const btn = document.getElementById('aiBatchBtn');
      const spinner = document.getElementById('aiBatchSpinner');
      const text = document.getElementById('aiBatchText');

      // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ ÏàòÏßë
      let categoryNames = [];
      let detailCategories = [];

      if (detailCategoryState.excelData && detailCategoryState.excelData.length > 0) {
        detailCategoryState.excelData.forEach((item, index) => {
          if (item.category && item.category.name) {
            categoryNames.push(item.category.name);
          }
          if (detailCategoryState.selections[index]) {
            detailCategories.push(detailCategoryState.selections[index].optionValue);
          }
        });
      }

      if (categoryNames.length === 0) {
        alert('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const categoryName = categoryNames.join(', ');
      const detailCategory = detailCategories.join(', ');

      // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
      btn.disabled = true;
      spinner.style.display = 'inline-block';
      text.textContent = 'AI Î∂ÑÏÑùÏ§ë...';

      try {
        const response = await fetch('/api/gemini/generate-product-info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            categoryName,
            detailCategory
          })
        });

        const result = await response.json();

        if (result.success) {
          // ÌÉúÍ∑∏ Ï∂îÍ∞Ä
          if (result.tags && result.tags.length > 0) {
            const newTags = result.tags.filter(tag => !detailCategoryState.tags.includes(tag));
            detailCategoryState.tags.push(...newTags);
            renderTags();
          }

          // ÏÇ¨Ïù¥Ï¶à ÏûÖÎ†•
          if (result.size) {
            document.getElementById('sizeWidth').value = result.size.width || '';
            document.getElementById('sizeHeight').value = result.size.height || '';
            document.getElementById('sizeDepth').value = result.size.depth || '';
          }

          // Î¨¥Í≤å ÏûÖÎ†•
          if (result.weight) {
            document.getElementById('weightInput').value = result.weight;
          }

          // Ï∑®Í∏âÏ£ºÏùò ÏÇ¨Ïú† ÏÑ†ÌÉù
          if (result.handlingCare) {
            document.getElementById('handlingCareInput').value = result.handlingCare;
          }

          // Í≥ÑÏ†à ÏÑ†ÌÉù
          if (result.season) {
            document.getElementById('seasonInput').value = result.season;
          }

          alert('‚úÖ AIÍ∞Ä Î™®Îì† Ï†ïÎ≥¥Î•º ÏûêÎèôÏúºÎ°ú ÏûÖÎ†•ÌñàÏäµÎãàÎã§!');
        } else {
          alert(result.message || 'AI Ï†ïÎ≥¥ Ï∂îÏ≤ú Ïã§Ìå®');
        }
      } catch (error) {
        console.error('AI ÏùºÍ¥Ñ Ï∂îÍ∞Ä Ïò§Î•ò:', error);
        alert('AI ÏùºÍ¥Ñ Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
        text.textContent = 'ü§ñ AI ÏùºÍ¥Ñ Ï∂îÍ∞Ä (ÌÉúÍ∑∏, ÏÇ¨Ïù¥Ï¶à, Î¨¥Í≤å, Ï∑®Í∏âÏ£ºÏùò, Í≥ÑÏ†à)';
      }
    }

    // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    window.saveAllData = function() {
      // ÏÇ¨Ïù¥Ï¶à ÏàòÏßë
      detailCategoryState.size = {
        width: document.getElementById('sizeWidth').value,
        height: document.getElementById('sizeHeight').value,
        depth: document.getElementById('sizeDepth').value
      };

      // Î¨¥Í≤å ÏàòÏßë
      detailCategoryState.weight = document.getElementById('weightInput').value;

      // Ï∑®Í∏âÏ£ºÏùò ÏÇ¨Ïú† ÏàòÏßë
      detailCategoryState.handlingCare = document.getElementById('handlingCareInput').value;

      // Í≥ÑÏ†à ÏàòÏßë
      detailCategoryState.season = document.getElementById('seasonInput').value;

      // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ (Í≤ÄÏÉâÌÉúÍ∑∏Îäî ÏÑ†ÌÉùÏÇ¨Ìï≠)
      if (!detailCategoryState.size.width || !detailCategoryState.size.height || !detailCategoryState.size.depth) {
        alert('ÏÇ¨Ïù¥Ï¶àÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      if (!detailCategoryState.weight) {
        alert('Î¨¥Í≤åÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      console.log('‚úÖ All data collected:', detailCategoryState);

      // ÏßÑÌñâ ÏÉÅÌô© Î™®Îã¨ ÌëúÏãú
      showProgressModal();

      // Ï≤´ Î≤àÏß∏ Îã®Í≥Ñ ÏãúÏûë
      updateProgressStep('prepare', 'in_progress');

      // Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± ÏãúÏûë
      fillQuotationExcels();
    }

    // Îã§Ïö¥Î°úÎìú ÌõÑ Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•Ïö© ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    let pendingDownloadProducts = [];

    // ÏßÅÏ†ë Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú
    window.showDirectQuoteIdInput = function() {
      if (selectedProducts.size === 0) {
        alert('Í≤¨Ï†ÅÏÑú IDÎ•º ÏûÖÎ†•Ìï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      document.getElementById('directQuoteSelectedCount').textContent = selectedProducts.size;
      document.getElementById('directQuoteIdInput').value = '';
      document.getElementById('directQuoteIdModal').style.display = 'flex';
    }

    // ÏßÅÏ†ë Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ Îã´Í∏∞
    window.closeDirectQuoteIdModal = function() {
      document.getElementById('directQuoteIdModal').style.display = 'none';
    }

    // ÏßÅÏ†ë Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• Î∞è ÏÉÅÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    window.saveDirectQuoteId = async function() {
      const quoteId = document.getElementById('directQuoteIdInput').value.trim();

      if (!quoteId) {
        alert('Í≤¨Ï†ÅÏÑú IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const productIds = Array.from(selectedProducts);
      if (productIds.length === 0) {
        alert('ÏÑ†ÌÉùÎêú ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.');
        return;
      }

      try {
        console.log('üì§ ÏßÅÏ†ë ID ÏûÖÎ†• - ÏÉÅÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...', productIds);

        // ÏÉÅÌÉúÎ•º 'uploaded'Î°ú Î≥ÄÍ≤Ω
        const statusResponse = await authFetch('/api/products/batch-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ids: productIds,
            status: 'uploaded'
          })
        });
        const statusResult = await statusResponse.json();
        console.log('üì• batch-status ÏùëÎãµ:', statusResult);

        if (!statusResponse.ok) {
          throw new Error(statusResult.message || 'ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®');
        }

        // Í∞Å ÏÉÅÌíàÏóê quoteId Ï†ÄÏû•
        for (const productId of productIds) {
          const putResponse = await authFetch(`/api/products/${productId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              quoteId: quoteId,
              uploadedAt: new Date().toISOString()
            })
          });
          if (!putResponse.ok) {
            console.warn(`‚ö†Ô∏è ÏÉÅÌíà ${productId} quoteId Ï†ÄÏû• Ïã§Ìå®`);
          }
        }

        console.log('‚úÖ ÏßÅÏ†ë ID ÏûÖÎ†• ÏôÑÎ£å');

        // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        selectedProducts.clear();
        updateSelectedCount();

        closeDirectQuoteIdModal();

        alert(`‚úÖ Í≤¨Ï†ÅÏÑú ID "${quoteId}"Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\n${productIds.length}Í∞ú ÏÉÅÌíàÏù¥ ÏóÖÎ°úÎìú ÏôÑÎ£åÎ°ú Ïù¥ÎèôÌñàÏäµÎãàÎã§.`);

        // ÏÉÅÌíà Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        loadProducts();

      } catch (error) {
        console.error('‚ùå ÏßÅÏ†ë ID Ï†ÄÏû• Ïò§Î•ò:', error.message || error);
        // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Îäî Ïù¥ÎØ∏ ÏÑ±Í≥µÌñàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú Î¨¥ÏãúÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ
        if (error.message && !error.message.includes('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®')) {
          // Îã®Ïàú UI ÏóêÎü¨Î©¥ Î¨¥ÏãúÌïòÍ≥† ÏôÑÎ£å Ï≤òÎ¶¨
          closeDirectQuoteIdModal();
          loadProducts();
        } else {
          alert(`Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}`);
        }
      }
    }

    // Îã§Ïö¥Î°úÎìú ÏßÑÌñâ Î™®Îã¨ ÌëúÏãú/Ïà®ÍπÄ
    function showDownloadProgressModal(text) {
      document.getElementById('downloadProgressText').textContent = text || 'Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî';
      document.getElementById('downloadProgressModal').style.display = 'flex';
    }

    function hideDownloadProgressModal() {
      document.getElementById('downloadProgressModal').style.display = 'none';
    }

    // Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú/Ïà®ÍπÄ
    function showQuoteIdModal() {
      document.getElementById('manualQuoteIdInput').value = '';
      document.getElementById('quoteIdInputModal').style.display = 'flex';
    }

    window.closeQuoteIdModal = async function() {
      // ÎÇòÏ§ëÏóê ÏûÖÎ†•ÌïòÍ∏∞: ÏÉÅÌíà ÏÉÅÌÉúÎ•º 'manual_pending'ÏúºÎ°ú Î≥ÄÍ≤Ω
      if (pendingDownloadProducts.length > 0) {
        try {
          const productIds = pendingDownloadProducts.map(p => p.id).filter(id => id);

          if (productIds.length > 0) {
            // ÏÉÅÌÉúÎ•º 'manual_pending'ÏúºÎ°ú Î≥ÄÍ≤Ω (ÏàòÎèô ÏóÖÎ°úÎìú ÎåÄÍ∏∞)
            await authFetch('/api/products/batch-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ids: productIds,
                status: 'manual_pending'
              })
            });

            console.log(`‚úÖ ${productIds.length}Í∞ú ÏÉÅÌíà ÏÉÅÌÉú -> manual_pending`);
            loadProducts(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
          }
        } catch (error) {
          console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
        }
      }

      document.getElementById('quoteIdInputModal').style.display = 'none';
      pendingDownloadProducts = [];
    }

    // Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• (Îã§Ïö¥Î°úÎìú ÌõÑ ÏàòÎèô ÏûÖÎ†•Ïö©)
    window.saveManualQuoteId = async function() {
      console.log('üîµ saveManualQuoteId Ìï®Ïàò ÏãúÏûë');
      console.log('üîµ pendingDownloadProducts:', pendingDownloadProducts);
      console.log('üîµ pendingDownloadProducts.length:', pendingDownloadProducts?.length);

      const quoteIdInput = document.getElementById('manualQuoteIdInput');
      console.log('üîµ quoteIdInput element:', quoteIdInput);

      const quoteId = quoteIdInput?.value?.trim();

      if (!quoteId) {
        alert('Í≤¨Ï†ÅÏÑú IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      if (!/^\d+$/.test(quoteId)) {
        alert('Í≤¨Ï†ÅÏÑú IDÎäî Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§.');
        return;
      }

      if (pendingDownloadProducts.length === 0) {
        alert('Ï†ÄÏû•Ìï† ÏÉÅÌíà Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
        closeQuoteIdModal();
        return;
      }

      try {
        showDownloadProgressModal('ÏÉÅÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');

        // ÏÉÅÌíà ÏÉÅÌÉúÎ•º 'uploaded'Î°ú Î≥ÄÍ≤ΩÌïòÍ≥† quoteId Ï†ÄÏû•
        const productIds = pendingDownloadProducts.map(p => p.id).filter(id => id);
        console.log('üìù Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• ÏãúÏûë:', { quoteId, productIds, pendingCount: pendingDownloadProducts.length });

        if (productIds.length > 0) {
          // ÏùºÍ¥Ñ ÏÉÅÌÉú Î≥ÄÍ≤Ω
          console.log('üì§ batch-status API Ìò∏Ï∂ú...');
          const statusResponse = await authFetch('/api/products/batch-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ids: productIds,
              status: 'uploaded'
            })
          });
          const statusResult = await statusResponse.json();
          console.log('üì• batch-status ÏùëÎãµ:', statusResult);

          if (!statusResponse.ok) {
            throw new Error(statusResult.message || 'ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®');
          }

          // Í∞Å ÏÉÅÌíàÏóê quoteId Ï†ÄÏû•
          console.log('üì§ Í∞Å ÏÉÅÌíàÏóê quoteId Ï†ÄÏû• ÏãúÏûë...');
          for (const productId of productIds) {
            const updateResponse = await authFetch(`/api/products/${productId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                quoteId: quoteId,
                uploadedAt: new Date().toISOString()
              })
            });
            const updateResult = await updateResponse.json();
            console.log(`üì• ÏÉÅÌíà ${productId} ÏóÖÎç∞Ïù¥Ìä∏:`, updateResult);
          }
          console.log('‚úÖ Î™®Îì† ÏÉÅÌíà ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        } else {
          console.warn('‚ö†Ô∏è ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÏÉÅÌíà IDÍ∞Ä ÏóÜÏäµÎãàÎã§');
        }

        hideDownloadProgressModal();

        // closeQuoteIdModal()Ïù¥ ÏÉÅÌÉúÎ•º Îã§Ïãú Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÎèÑÎ°ù Î®ºÏ†Ä Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        const savedCount = productIds.length;
        pendingDownloadProducts = [];

        // Î™®Îã¨ Îã´Í∏∞ (Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏúºÎØÄÎ°ú ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏóÜÏùå)
        document.getElementById('quoteIdInputModal').style.display = 'none';

        alert(`‚úÖ Í≤¨Ï†ÅÏÑú IDÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\n\nÍ≤¨Ï†ÅÏÑú ID: ${quoteId}\nÏÉÅÌíà ${savedCount}Í∞úÍ∞Ä ÏóÖÎ°úÎìú ÏôÑÎ£åÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);

        // ÏÉÅÌíà Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        loadProducts();

      } catch (error) {
        hideDownloadProgressModal();
        console.error('‚ùå Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• Ïò§Î•ò:', error);
        console.error('‚ùå Ïò§Î•ò Ïä§ÌÉù:', error.stack);
        console.error('‚ùå Ïò§Î•ò ÌÉÄÏûÖ:', error.name);
        console.error('‚ùå pendingDownloadProducts:', pendingDownloadProducts);
        alert(`Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message || error.toString()}`);
      }
    }

    // ÌååÏùºÎßå Îã§Ïö¥Î∞õÍ∏∞ (ÏûêÎèô ÏóÖÎ°úÎìú ÏóÜÏù¥)
    window.saveAllDataDownloadOnly = async function() {
      // ÏÇ¨Ïù¥Ï¶à ÏàòÏßë
      detailCategoryState.size = {
        width: document.getElementById('sizeWidth').value,
        height: document.getElementById('sizeHeight').value,
        depth: document.getElementById('sizeDepth').value
      };

      // Î¨¥Í≤å ÏàòÏßë
      detailCategoryState.weight = document.getElementById('weightInput').value;

      // Ï∑®Í∏âÏ£ºÏùò ÏÇ¨Ïú† ÏàòÏßë
      detailCategoryState.handlingCare = document.getElementById('handlingCareInput').value;

      // Í≥ÑÏ†à ÏàòÏßë
      detailCategoryState.season = document.getElementById('seasonInput').value;

      // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
      if (!detailCategoryState.size.width || !detailCategoryState.size.height || !detailCategoryState.size.depth) {
        alert('ÏÇ¨Ïù¥Ï¶àÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      if (!detailCategoryState.weight) {
        alert('Î¨¥Í≤åÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      console.log('üì• ÌååÏùºÎßå Îã§Ïö¥Î°úÎìú ÏãúÏûë...');

      // Î°úÎî© Î™®Îã¨ ÌëúÏãú
      showDownloadProgressModal('ÌååÏùº ÏÉùÏÑ± Î∞è Îã§Ïö¥Î°úÎìú Ï§ë...');

      try {
        // ÏÑ†ÌÉùÌïú ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (generateQuoteÏóêÏÑú Ïù¥ÎØ∏ Î°úÎìúÎê®)
        const selectedProductsData = window.selectedFullProductsData || [];

        // Í∞Å ÌååÏùº Ï†ïÎ≥¥ÏôÄ ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ìïë
        const filesData = detailCategoryState.excelData.map((item, index) => {
          const selection = detailCategoryState.selections[index];
          return {
            dataIndex: item.dataIndex,
            filename: item.downloadedFilename || item.filename,
            category: selection ? selection.optionValue : ''
          };
        });

        // ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®ÏúºÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ° (downloadOnly ÌîåÎûòÍ∑∏ Ï∂îÍ∞Ä)
        const response = await sendMessageToExtension('fillQuotationExcels', {
          action: 'fillQuotationExcels',
          filesData: filesData,
          products: selectedProductsData,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName || '',
          quotationMappings: window.quotationMappings || settings.quotationMappings || [],
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins,
            packagingCost: settings.packagingCost || 500,
            minMargin: settings.minMargin || 1000
          },
          downloadOnly: true  // Îã§Ïö¥Î°úÎìúÎßå ÏàòÌñâ
        });

        hideDownloadProgressModal();

        if (response.success) {
          console.log('‚úÖ ÌååÏùº Îã§Ïö¥Î°úÎìú ÏôÑÎ£å:', response);
          closeDetailCategoryModal();

          // Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•ÏùÑ ÏúÑÌï¥ ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
          pendingDownloadProducts = selectedProductsData;

          // Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú
          showQuoteIdModal();
        } else if (response.needsInput && response.missingRequiredFields) {
          // ÌïÑÏàò Ïπ∏ ÏûÖÎ†• ÌïÑÏöî
          showRequiredFieldsModal(response.missingRequiredFields);
          // Ïû¨ÏãúÎèÑÏö© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (downloadOnly ÌîåÎûòÍ∑∏ Ìè¨Ìï®)
          pendingQuotationData = {
            filesData: filesData,
            products: selectedProductsData,
            searchTags: detailCategoryState.tags,
            size: detailCategoryState.size,
            weight: detailCategoryState.weight,
            handlingCare: detailCategoryState.handlingCare,
            season: detailCategoryState.season,
            brandName: settings.brandName || '',
            quotationMappings: window.quotationMappings || settings.quotationMappings || [],
            priceSettings: {
              exchangeRate: settings.exchangeRate,
              supplyMargins: settings.supplyMargins,
              saleMargins: settings.saleMargins,
              packagingCost: settings.packagingCost || 500,
              minMargin: settings.minMargin || 1000
            },
            downloadOnly: true
          };
        } else {
          throw new Error(response.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò');
        }
      } catch (error) {
        hideDownloadProgressModal();
        console.error('‚ùå ÌååÏùº Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
        alert(`ÌååÏùº Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}`);
      }
    }

    // ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò
    let requiredFieldsData = null;
    let pendingQuotationData = null;

    // Excel ÌååÏùºÏóê Îç∞Ïù¥ÌÑ∞ ÏûêÎèô Ï±ÑÏö∞Í∏∞ (ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®ÏóêÏÑú Ï≤òÎ¶¨)
    async function fillQuotationExcels() {
      try {
        console.log('üìù Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± ÏãúÏûë...');

        // ÏÑ†ÌÉùÌïú ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (generateQuoteÏóêÏÑú Ïù¥ÎØ∏ Î°úÎìúÎê®)
        const selectedProductsData = window.selectedFullProductsData || [];
        console.log(`üõçÔ∏è  ÏÑ†ÌÉùÌïú ÏÉÅÌíà ${selectedProductsData.length}Í∞ú:`, selectedProductsData);

        // Í∞Å ÌååÏùº Ï†ïÎ≥¥ÏôÄ ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ìïë
        const filesData = detailCategoryState.excelData.map((item, index) => {
          const selection = detailCategoryState.selections[index];
          return {
            dataIndex: item.dataIndex,
            filename: item.downloadedFilename || item.filename,
            category: selection ? selection.optionValue : ''
          };
        });

        console.log('üìã ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®ÏúºÎ°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞:', {
          filesData,
          products: selectedProductsData.length,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName,
          quotationMappings: window.quotationMappings
        });
        console.log('üìå quotationMappings ÏÉÅÏÑ∏:', JSON.stringify(window.quotationMappings, null, 2));

        // ÏÉÅÌíà ÏòµÏÖò Îç∞Ïù¥ÌÑ∞ ÎîîÎ≤ÑÍ∑∏
        if (selectedProductsData.length > 0) {
          const firstProduct = selectedProductsData[0];
          console.log('üì¶ Ï≤´ Î≤àÏß∏ ÏÉÅÌíà:', firstProduct.title);
          console.log('üì¶ results Í∞úÏàò:', firstProduct.results?.length);
          if (firstProduct.results && firstProduct.results.length > 0) {
            const firstOpt = firstProduct.results[0];
            console.log('üì¶ Ï≤´ Î≤àÏß∏ ÏòµÏÖò ÌÇ§:', Object.keys(firstOpt));
            console.log('üì¶ optionName1:', firstOpt.optionName1);
            console.log('üì¶ optionName1Cn:', firstOpt.optionName1Cn);
            console.log('üì¶ optionName2:', firstOpt.optionName2);
          }
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Ïû¨ÏãúÎèÑÏö© - Î™®Îì† ÏÑ§Ï†ï Ìè¨Ìï®)
        pendingQuotationData = {
          filesData: filesData,
          products: selectedProductsData,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName || '',
          quotationMappings: window.quotationMappings || settings.quotationMappings || [],
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins,
            packagingCost: settings.packagingCost || 500,
            minMargin: settings.minMargin || 1000
          }
        };

        // Ï§ÄÎπÑ Îã®Í≥Ñ ÏôÑÎ£å, Excel ÏûëÏÑ± Îã®Í≥Ñ ÏãúÏûë
        updateProgressStep('prepare', 'completed');
        updateProgressStep('fill', 'in_progress');

        // ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®ÏúºÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
        const response = await sendMessageToExtension('fillQuotationExcels', {
          action: 'fillQuotationExcels',
          filesData: filesData,
          products: selectedProductsData,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName || '',
          quotationMappings: window.quotationMappings || settings.quotationMappings || [],
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins,
            packagingCost: settings.packagingCost || 500,
            minMargin: settings.minMargin || 1000
          }
        });

        // ÌïÑÏàò Ïπ∏Ïù¥ ÎàÑÎùΩÎêú Í≤ΩÏö∞
        if (response.needsInput && response.missingRequiredFields) {
          console.log('‚ö†Ô∏è ÌïÑÏàò Ïπ∏ ÏûÖÎ†• ÌïÑÏöî:', response.missingRequiredFields);
          updateProgressStep('fill', 'error');
          closeProgressModal();
          showRequiredFieldsModal(response.missingRequiredFields);
          return;
        }

        if (response.success) {
          console.log('‚úÖ Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± ÏôÑÎ£å:', response);

          // Excel ÏûëÏÑ± ÏôÑÎ£å
          updateProgressStep('fill', 'completed');

          // ÎÇòÎ®∏ÏßÄ Îã®Í≥ÑÎì§ÏùÄ background.jsÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏Îê† ÏòàÏ†ï
          // (open, upload, validate, complete)

          closeDetailCategoryModal();
          pendingQuotationData = null;
        } else {
          throw new Error(response.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò');
        }

      } catch (error) {
        console.error('‚ùå Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± Ïò§Î•ò:', error);
        updateProgressStep('fill', 'error');

        // 3Ï¥à ÌõÑ Î™®Îã¨ Îã´Í∏∞
        setTimeout(() => {
          closeProgressModal();
          alert(`Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}`);
        }, 3000);
      }
    }

    // ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú
    function showRequiredFieldsModal(missingFields) {
      requiredFieldsData = missingFields;

      const modal = document.getElementById('requiredFieldsModal');
      const listContainer = document.getElementById('requiredFieldsList');

      listContainer.innerHTML = missingFields.map((field, index) => `
        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
            ${field.header}
            <span style="color: #ff4444;">*</span>
          </label>
          ${field.example ? `
            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-left: 3px solid #2196f3; border-radius: 4px;">
              <small style="color: #666;">ÏòàÏãú:</small>
              <strong style="color: #1976d2; margin-left: 8px;">${field.example}</strong>
            </div>
          ` : ''}
          <input
            type="text"
            id="required-field-${index}"
            data-header="${field.header}"
            placeholder="Í∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
          >
        </div>
      `).join('');

      modal.style.display = 'flex';
    }

    // ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Î™®Îã¨ Îã´Í∏∞
    function closeRequiredFieldsModal() {
      document.getElementById('requiredFieldsModal').style.display = 'none';
      requiredFieldsData = null;
    }

    // ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Ï†ÅÏö©
    async function applyRequiredFields() {
      const newMappings = [];

      requiredFieldsData.forEach((field, index) => {
        const input = document.getElementById(`required-field-${index}`);
        const value = input.value.trim();

        if (value) {
          newMappings.push({
            header: field.header,
            type: 'fixed',
            value: value
          });
        }
      });

      if (newMappings.length === 0) {
        alert('ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò ÌïÑÏàò Ïπ∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      // Í≤¨Ï†ÅÏÑú ÏñëÏãùÏóê Ï∂îÍ∞ÄÌï†ÏßÄ Î¨ºÏñ¥Î≥¥Í∏∞
      const shouldSave = confirm(
        `ÏûÖÎ†•ÌïòÏã† ${newMappings.length}Í∞ú Ìï≠Î™©ÏùÑ Í≤¨Ï†ÅÏÑú ÏñëÏãùÏóê Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
        `Ï∂îÍ∞ÄÌïòÎ©¥ Îã§ÏùåÎ∂ÄÌÑ∞ Ïù¥ Í∞íÎì§Ïù¥ ÏûêÎèôÏúºÎ°ú Ï†ÅÏö©Îê©ÎãàÎã§.\n\n` +
        newMappings.map(m => `‚Ä¢ ${m.header}: ${m.value}`).join('\n')
      );

      if (shouldSave) {
        // quotationMappingsÏóê Ï∂îÍ∞Ä
        for (const mapping of newMappings) {
          const exists = window.quotationMappings.find(m => m.header === mapping.header);
          if (!exists) {
            window.quotationMappings.push(mapping);
          } else {
            // Í∏∞Ï°¥ Í≤É ÏóÖÎç∞Ïù¥Ìä∏
            exists.value = mapping.value;
          }
        }

        // ÏÑ§Ï†ï Ï†ÄÏû•
        settings.quotationMappings = window.quotationMappings;
        await saveSettingsToStorage();
        console.log('‚úÖ Í≤¨Ï†ÅÏÑú ÏñëÏãùÏóê ÏÉà Ìï≠Î™© Ï∂îÍ∞ÄÎê®');
      }

      closeRequiredFieldsModal();

      // Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± Ïû¨ÏãúÎèÑ
      if (pendingQuotationData) {
        console.log('üîÑ Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± Ïû¨ÏãúÎèÑ...');

        const isDownloadOnly = pendingQuotationData.downloadOnly || false;

        const response = await sendMessageToExtension('fillQuotationExcels', {
          action: 'fillQuotationExcels',
          ...pendingQuotationData,
          // ÏóÖÎç∞Ïù¥Ìä∏Îêú quotationMappings ÏÇ¨Ïö© (ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌïÑÏàò Ïπ∏ Ìè¨Ìï®)
          quotationMappings: window.quotationMappings || settings.quotationMappings || []
        });

        if (response.success) {
          if (isDownloadOnly) {
            console.log('‚úÖ ÌååÏùº Îã§Ïö¥Î°úÎìú ÏôÑÎ£å:', response);
            closeDetailCategoryModal();

            // Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•ÏùÑ ÏúÑÌï¥ ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            pendingDownloadProducts = pendingQuotationData.products || [];

            // Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú
            showQuoteIdModal();
          } else {
            console.log('‚úÖ Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± ÏôÑÎ£å:', response);
            alert(`‚úÖ Í≤¨Ï†ÅÏÑú ÏûêÎèô ÏûëÏÑ± ÏôÑÎ£å!\n\n${response.count}Í∞úÏùò Excel ÌååÏùºÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`);
            closeDetailCategoryModal();
          }
          pendingQuotationData = null;
        } else if (response.needsInput && response.missingRequiredFields) {
          // ÏïÑÏßÅÎèÑ ÌïÑÏàò Ïπ∏Ïù¥ Îçî ÏûàÎäî Í≤ΩÏö∞
          showRequiredFieldsModal(response.missingRequiredFields);
        } else {
          throw new Error(response.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò');
        }
      }
    }

    // Í≤¨Ï†ÅÏÑú ÏûëÏÑ± ÏñëÏãù Í¥ÄÎ†® Ìï®Ïàò
    // window.quotationMappingsÎäî loadSettings()ÏóêÏÑú Ï¥àÍ∏∞ÌôîÎê®

    function renderQuotationMappings() {
      const container = document.getElementById('quotationMappingContainer');
      if (!container) return;

      container.innerHTML = window.quotationMappings.map((mapping, index) => `
        <div style="border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; background: white;">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" value="${mapping.header || ''}" placeholder="Ìó§ÎçîÎ™Ö (Ïòà: ÏÉÅÌíàÎ™Ö)"
              onchange="updateQuotationMapping(${index}, 'header', this.value)"
              style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <select onchange="updateQuotationMapping(${index}, 'type', this.value)"
              style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="option1" ${mapping.type === 'option1' ? 'selected' : ''}>ÏòµÏÖò1 Í∞í</option>
              <option value="option2" ${mapping.type === 'option2' ? 'selected' : ''}>ÏòµÏÖò2 Í∞í</option>
              <option value="productName" ${mapping.type === 'productName' ? 'selected' : ''}>Ï†úÌíàÎ™Ö</option>
              <option value="fixed" ${mapping.type === 'fixed' ? 'selected' : ''}>ÏßÅÏ†ë ÏûëÏÑ± (Í≥†Ï†ïÍ∞í)</option>
            </select>
            <button onclick="removeQuotationMapping(${index})"
              style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ÏÇ≠Ï†ú</button>
          </div>
          ${mapping.type === 'fixed' ? `
            <input type="text" value="${mapping.value || ''}" placeholder="Í≥†Ï†ïÍ∞í ÏûÖÎ†•"
              onchange="updateQuotationMapping(${index}, 'value', this.value)"
              style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          ` : ''}
        </div>
      `).join('');
    }

    window.addQuotationMapping = function() {
      window.quotationMappings.push({ header: '', type: 'option1', value: '' });
      renderQuotationMappings();
    }

    window.removeQuotationMapping = function(index) {
      window.quotationMappings.splice(index, 1);
      renderQuotationMappings();
    }

    window.updateQuotationMapping = function(index, field, value) {
      if (window.quotationMappings[index]) {
        window.quotationMappings[index][field] = value;
        // settingsÏóêÎèÑ ÎèôÍ∏∞Ìôî
        settings.quotationMappings = window.quotationMappings;
        if (field === 'type') {
          renderQuotationMappings(); // ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ïãú UI ÏóÖÎç∞Ïù¥Ìä∏
        }
      }
    }

    // Í≤¨Ï†ÅÏÑú Îß§Ìïë Î†åÎçîÎßÅÏùÄ loadSettings() ÏôÑÎ£å ÌõÑ ÏûêÎèô Ìò∏Ï∂úÎê®

    // ===== ÏßÑÌñâ ÏÉÅÌô© Î™®Îã¨ Í¥ÄÎ†® Ìï®Ïàò =====
    let progressSteps = [];
    let currentStepIndex = -1;

    // ÏßÑÌñâ ÏÉÅÌô© Î™®Îã¨ ÌëúÏãú
    window.showProgressModal = function() {
      const modal = document.getElementById('progressModal');
      modal.style.display = 'flex';

      // Ï¥àÍ∏∞ Îã®Í≥Ñ ÏÑ§Ï†ï
      progressSteps = [
        { id: 'prepare', label: 'Í≤¨Ï†ÅÏÑú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ Ï§ë', status: 'pending' },
        { id: 'fill', label: 'Í≤¨Ï†ÅÏÑú Excel ÌååÏùº ÏûëÏÑ± Ï§ë', status: 'pending' },
        { id: 'images', label: 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ/ÎùºÎ≤®Ïª∑ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë', status: 'pending' },
        { id: 'open', label: 'Ïø†Ìå° ÌéòÏù¥ÏßÄ Ïó¥Í∏∞', status: 'pending' },
        { id: 'upload', label: 'ÌååÏùº ÏóÖÎ°úÎìú Ï§ë', status: 'pending' },
        { id: 'validate', label: 'ÌååÏùº Í≤ÄÏ¶ù Ï§ë', status: 'pending' },
        { id: 'complete', label: 'ÏóÖÎ°úÎìú ÏôÑÎ£å', status: 'pending' }
      ];

      currentStepIndex = -1;
      renderProgressSteps();
    }

    // ÏßÑÌñâ Îã®Í≥Ñ Î†åÎçîÎßÅ
    function renderProgressSteps() {
      const stepsContainer = document.getElementById('progressSteps');
      stepsContainer.innerHTML = progressSteps.map((step, index) => {
        let icon = '‚è≥';
        let color = '#999';

        if (step.status === 'completed') {
          icon = '‚úÖ';
          color = '#4caf50';
        } else if (step.status === 'in_progress') {
          icon = 'üîÑ';
          color = '#2196f3';
        } else if (step.status === 'error') {
          icon = '‚ùå';
          color = '#f44336';
        } else if (step.status === 'pending') {
          icon = '‚è≥';
          color = '#ff9800';
        }

        return `
          <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
            <span style="font-size: 24px; margin-right: 12px;">${icon}</span>
            <span style="flex: 1; font-size: 15px; color: ${color}; font-weight: ${step.status === 'in_progress' ? 'bold' : 'normal'};">
              ${step.label}
            </span>
          </div>
        `;
      }).join('');

      // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Îã®Í≥Ñ Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
      const currentStep = progressSteps.find(s => s.status === 'in_progress');
      const messageDiv = document.getElementById('progressMessage');
      if (currentStep) {
        messageDiv.innerHTML = `<strong style="color: #2196f3;">${currentStep.label}...</strong>`;
      } else {
        const lastStep = progressSteps[progressSteps.length - 1];
        if (lastStep.status === 'completed') {
          messageDiv.innerHTML = '<strong style="color: #4caf50;">‚úÖ Î™®Îì† ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!</strong>';
        } else if (progressSteps.some(s => s.status === 'error')) {
          messageDiv.innerHTML = '<strong style="color: #f44336;">‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</strong>';
        }
      }
    }

    // ÏßÑÌñâ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
    window.updateProgressStep = function(stepId, status) {
      const step = progressSteps.find(s => s.id === stepId);
      if (step) {
        step.status = status;
        renderProgressSteps();
      }
    }

    // ÏßÑÌñâ ÏÉÅÌô© Î™®Îã¨ Îã´Í∏∞
    window.closeProgressModal = function() {
      document.getElementById('progressModal').style.display = 'none';
      progressSteps = [];
      currentStepIndex = -1;
    }

    // ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®ÏúºÎ°úÎ∂ÄÌÑ∞ ÏßÑÌñâ ÏÉÅÌÉú Î©îÏãúÏßÄ ÏàòÏã† (window.postMessageÎ•º ÌÜµÌï¥)
    window.addEventListener('message', (event) => {
      // Í∞ôÏùÄ originÎßå ÌóàÏö©
      if (event.origin !== window.location.origin) {
        return;
      }

      const message = event.data;

      // TotalBot extension Î©îÏãúÏßÄÎßå Ï≤òÎ¶¨
      if (message && message.source === 'totalbot-extension') {
        console.log('üì® Extension Î©îÏãúÏßÄ ÏàòÏã†:', message.action, message.stepId, message.status);
        if (message.action === 'updateProgress') {
          console.log('üîÑ ÏßÑÌñâ ÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏:', message.stepId, '->', message.status);
          updateProgressStep(message.stepId, message.status);
        } else if (message.action === 'closeProgressModal') {
          closeProgressModal();
        } else if (message.action === 'showRejectedModal') {
          // Í≤¨Ï†ÅÏÑú Î∞òÎ†§ Î™®Îã¨ ÌëúÏãú
          showRejectedModal(message);
        } else if (message.action === 'showUploadFailedModal') {
          // ÏóÖÎ°úÎìú Ïã§Ìå® Î™®Îã¨ ÌëúÏãú
          showUploadFailedModal(message.error);
        } else if (message.action === 'showPendingModal') {
          // Í≤ÄÏ¶ù ÏßÑÌñâ Ï§ë Î™®Îã¨ ÌëúÏãú
          showPendingModal(message);
        } else if (message.action === 'batchCollectProgress') {
          // ÏùºÍ¥Ñ ÏàòÏßë ÌîÑÎ°úÍ∑∏Î†àÏä§ ÏóÖÎç∞Ïù¥Ìä∏
          handleBatchCollectProgressUpdate(message.progress);
        }
      }
    });

    // ÏùºÍ¥Ñ ÏàòÏßë ÌîÑÎ°úÍ∑∏Î†àÏä§ ÏóÖÎç∞Ïù¥Ìä∏ Ï≤òÎ¶¨
    function handleBatchCollectProgressUpdate(progress) {
      console.log('üìä ÏùºÍ¥Ñ ÏàòÏßë ÌîÑÎ°úÍ∑∏Î†àÏä§:', progress);

      const listContainer = document.getElementById('batchProgressList');
      if (!listContainer) return;

      // ÌîÑÎ°úÍ∑∏Î†àÏä§ ÏïÑÏù¥ÌÖú Ï∞æÍ∏∞ ÎòêÎäî ÏÉùÏÑ±
      let itemEl = document.querySelector(`.progress-item[data-cat-idx="${progress.categoryIndex}"]`);

      switch (progress.type) {
        case 'category_start':
          // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏãúÏûë - ÏÉÅÌÉúÎ•º 'Í≤ÄÏÉâ Ï§ë'ÏúºÎ°ú Î≥ÄÍ≤Ω
          if (itemEl) {
            const badge = itemEl.querySelector('.status-badge');
            const detail = itemEl.querySelector('.progress-detail');
            badge.className = 'status-badge searching';
            badge.textContent = 'Í≤ÄÏÉâ Ï§ë';
            detail.textContent = '1688 Í≤ÄÏÉâ ÌéòÏù¥ÏßÄ Î°úÎî©...';
          }
          break;

        case 'products_found':
          // ÏÉÅÌíà Î∞úÍ≤¨Îê®
          if (itemEl) {
            const detail = itemEl.querySelector('.progress-detail');
            detail.textContent = `${progress.foundCount}Í∞ú Î∞úÍ≤¨, ${progress.collectCount}Í∞ú ÏàòÏßë ÏòàÏ†ï`;
          }
          break;

        case 'product_start':
          // Í∞úÎ≥Ñ ÏÉÅÌíà ÏàòÏßë ÏãúÏûë
          if (itemEl) {
            const badge = itemEl.querySelector('.status-badge');
            const detail = itemEl.querySelector('.progress-detail');
            badge.className = 'status-badge collecting';
            badge.textContent = 'ÏàòÏßë Ï§ë';
            detail.textContent = `ÏÉÅÌíà ${progress.productIndex + 1}/${progress.totalProducts} ÏàòÏßë Ï§ë...`;
          }
          break;

        case 'ai_processing':
          // AI Ï≤òÎ¶¨ Ï§ë
          if (itemEl) {
            const badge = itemEl.querySelector('.status-badge');
            const detail = itemEl.querySelector('.progress-detail');
            badge.className = 'status-badge processing';
            badge.textContent = 'AI Ï≤òÎ¶¨';
            detail.textContent = `ÏÉÅÌíà ${progress.productIndex + 1} AI ÏûêÎèô Ìé∏Ïßë Ï§ë...`;
          }
          break;

        case 'product_complete':
          // ÏÉÅÌíà ÏàòÏßë ÏôÑÎ£å
          if (itemEl) {
            const detail = itemEl.querySelector('.progress-detail');
            detail.textContent = `ÏÉÅÌíà ${progress.productIndex + 1} ÏôÑÎ£å ${progress.aiSuccess ? '(AI ‚úì)' : ''}`;
          }
          break;

        case 'product_error':
          // ÏÉÅÌíà ÏàòÏßë Ïò§Î•ò
          if (itemEl) {
            const detail = itemEl.querySelector('.progress-detail');
            detail.textContent = `ÏÉÅÌíà ${progress.productIndex + 1} Ïò§Î•ò: ${progress.error}`;
          }
          break;

        case 'category_complete':
          // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏôÑÎ£å
          if (itemEl) {
            const badge = itemEl.querySelector('.status-badge');
            const detail = itemEl.querySelector('.progress-detail');
            badge.className = 'status-badge completed';
            badge.textContent = 'ÏôÑÎ£å';
            detail.textContent = `${progress.productsCollected}Í∞ú ÏÉÅÌíà ÏàòÏßë ÏôÑÎ£å`;
          }
          break;

        case 'complete':
          // Ï†ÑÏ≤¥ ÏôÑÎ£å
          const modal = document.getElementById('batchProgressModal');
          const footer = modal.querySelector('.progress-footer');
          if (footer) {
            const results = progress.results;
            footer.innerHTML = `
              <div style="color: #10b981; font-weight: 600; margin-bottom: 10px;">
                ‚úÖ ÏàòÏßë ÏôÑÎ£å!
              </div>
              <div style="font-size: 14px; margin-bottom: 15px;">
                Ïπ¥ÌÖåÍ≥†Î¶¨: ${results.completedCategories}/${results.totalCategories}Í∞ú<br>
                ÏÉÅÌíà: ${results.completedProducts}Í∞ú ÏàòÏßë ÏôÑÎ£å
                ${results.errors.length > 0 ? `<br><span style="color: #f59e0b;">Ïò§Î•ò ${results.errors.length}Í±¥</span>` : ''}
              </div>
              <button class="coupang-download-btn" onclick="closeBatchProgressModal(); loadProducts();" style="margin-top: 10px;">Îã´Í∏∞</button>
            `;
          }
          break;

        case 'error':
          // Ïò§Î•ò Î∞úÏÉù
          const errorModal = document.getElementById('batchProgressModal');
          const errorFooter = errorModal.querySelector('.progress-footer');
          if (errorFooter) {
            errorFooter.innerHTML = `
              <div style="color: #ef4444; font-weight: 600;">‚ùå Ïò§Î•ò Î∞úÏÉù: ${progress.error}</div>
              <button class="coupang-download-btn" onclick="closeBatchProgressModal()" style="margin-top: 10px; background: #ef4444;">Îã´Í∏∞</button>
            `;
          }
          break;
      }
    }

    // Í≤¨Ï†ÅÏÑú Î∞òÎ†§ Î™®Îã¨ ÌëúÏãú
    function showRejectedModal(data) {
      closeProgressModal();

      const modal = document.getElementById('rejectedModal');
      document.getElementById('rejectedQuotationName').textContent = data.quotationName || 'Ïïå Ïàò ÏóÜÏùå';
      document.getElementById('rejectedQuoteIdDisplay').textContent = data.quoteId || '-';
      document.getElementById('rejectedError').textContent = data.error || 'Í≤ÄÏ¶ù Ïã§Ìå®';
      document.getElementById('rejectedDownloadUrl').href = data.downloadUrl || '#';

      // Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• (ÏàòÎèô ÏóÖÎ°úÎìúÏö©)
      modal.dataset.quoteId = data.quoteId || '';

      modal.style.display = 'flex';
    }

    // Î∞òÎ†§ Î™®Îã¨ Îã´Í∏∞
    window.closeRejectedModal = function() {
      document.getElementById('rejectedModal').style.display = 'none';
    }

    // ÏÉÅÏÑ∏ÎÇ¥Ïó≠ Îã§Ïö¥Î°úÎìú - Ïø†Ìå° Í≤¨Ï†ÅÏÑú Î™©Î°ù ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    window.downloadRejectedDetails = function() {
      const quotationName = document.getElementById('rejectedQuotationName').textContent;

      // ÏïàÎÇ¥ Î©îÏãúÏßÄÏôÄ Ìï®Íªò Ïø†Ìå° ÌéòÏù¥ÏßÄ Ïó¥Í∏∞
      alert(`Ïø†Ìå° Í≤¨Ï†ÅÏÑú Î™©Î°ù ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.\n\n"${quotationName}" Í≤¨Ï†ÅÏÑúÎ•º Ï∞æÏïÑ\n"ÏÉÅÏÑ∏ÎÇ¥Ïó≠ Îã§Ïö¥Î°úÎìú" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥Ï£ºÏÑ∏Ïöî.`);
      window.open('https://supplier.coupang.com/qvt/quotation', '_blank');
      closeRejectedModal();
    }

    // ÏóÖÎ°úÎìú Ïã§Ìå® Î™®Îã¨ ÌëúÏãú
    function showUploadFailedModal(error) {
      closeProgressModal();

      const modal = document.getElementById('uploadFailedModal');
      document.getElementById('uploadFailedError').textContent = error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò';
      modal.style.display = 'flex';
    }

    // ÏóÖÎ°úÎìú Ïã§Ìå® Î™®Îã¨ Îã´Í∏∞
    window.closeUploadFailedModal = function() {
      document.getElementById('uploadFailedModal').style.display = 'none';
    }

    // ÏóÖÎ°úÎìú Ïã§Ìå® Ïãú Ï≤òÎ¶¨ Ï§ëÏù¥Îçò ÏÉÅÌíà ID Ï†ÄÏû•
    let failedUploadProductIds = [];

    // ÏàòÎèô ÏóÖÎ°úÎìú Î™®Îã¨ ÌëúÏãú
    window.showManualUploadModal = function() {
      closeRejectedModal();
      closeUploadFailedModal();

      // Ïù¥Ï†ÑÏóê ÏÑ†ÌÉùÌñàÎçò ÏÉÅÌíà ID Í∞ÄÏ†∏Ïò§Í∏∞ (Í≤¨Ï†ÅÏÑú ÏÉùÏÑ± Ïãú ÏÑ†ÌÉùÌïú ÏÉÅÌíàÎì§)
      if (window.selectedFullProductsData && window.selectedFullProductsData.length > 0) {
        failedUploadProductIds = window.selectedFullProductsData.map(p => p.id).filter(id => id);
      } else {
        failedUploadProductIds = Array.from(selectedProducts);
      }
      console.log('üìù ÏàòÎèô ÏóÖÎ°úÎìú ÎåÄÏÉÅ ÏÉÅÌíà:', failedUploadProductIds);

      document.getElementById('uploadedManualQuoteIdInput').value = '';
      document.getElementById('manualUploadModal').style.display = 'flex';
    }

    // ÏàòÎèô ÏóÖÎ°úÎìú Î™®Îã¨ Îã´Í∏∞
    window.closeManualUploadModal = function() {
      document.getElementById('manualUploadModal').style.display = 'none';
    }

    // ÏàòÎèô ÏóÖÎ°úÎìú Í≤¨Ï†ÅÏÑú ID Ï†ÄÏû• - Ïã§Ï†úÎ°ú ÏÉÅÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    window.saveUploadedManualQuoteId = async function() {
      const quoteId = document.getElementById('uploadedManualQuoteIdInput').value.trim();
      if (!quoteId) {
        alert('Í≤¨Ï†ÅÏÑú IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      try {
        // ÏÉÅÌíà IDÍ∞Ä ÏûàÏúºÎ©¥ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        if (failedUploadProductIds.length > 0) {
          console.log('üì§ ÏÉÅÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...', failedUploadProductIds);

          // ÏÉÅÌÉúÎ•º 'uploaded'Î°ú Î≥ÄÍ≤Ω
          const statusResponse = await authFetch('/api/products/batch-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ids: failedUploadProductIds,
              status: 'uploaded'
            })
          });
          const statusResult = await statusResponse.json();
          console.log('üì• batch-status ÏùëÎãµ:', statusResult);

          // Í∞Å ÏÉÅÌíàÏóê quoteId Ï†ÄÏû•
          for (const productId of failedUploadProductIds) {
            await authFetch(`/api/products/${productId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                quoteId: quoteId,
                uploadedAt: new Date().toISOString()
              })
            });
          }

          console.log('‚úÖ ÏÉÅÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        // localStorageÏóêÎèÑ Ï†ÄÏû•
        const recentQuotes = JSON.parse(localStorage.getItem('recentQuotations') || '[]');
        if (!recentQuotes.includes(quoteId)) {
          recentQuotes.unshift(quoteId);
          localStorage.setItem('recentQuotations', JSON.stringify(recentQuotes.slice(0, 10)));
        }

        alert(`‚úÖ Í≤¨Ï†ÅÏÑú ID "${quoteId}"Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\n${failedUploadProductIds.length}Í∞ú ÏÉÅÌíàÏù¥ ÏóÖÎ°úÎìú ÏôÑÎ£åÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);

        // ÏÉÅÌíà Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        loadProducts();

        closeManualUploadModal();
        failedUploadProductIds = [];

      } catch (error) {
        console.error('‚ùå ÏàòÎèô ÏóÖÎ°úÎìú Ï†ÄÏû• Ïò§Î•ò:', error);
        alert(`Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}`);
      }
    }

    // Í≤ÄÏ¶ù ÏßÑÌñâ Ï§ë Î™®Îã¨ ÌëúÏãú
    function showPendingModal(data) {
      closeProgressModal();

      const modal = document.getElementById('pendingModal');
      document.getElementById('pendingQuotationName').textContent = data.quotationName || 'Ïïå Ïàò ÏóÜÏùå';
      document.getElementById('pendingQuoteId').textContent = data.quoteId || '-';
      document.getElementById('pendingError').textContent = data.error || 'Í≤ÄÏ¶ùÏù¥ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§.';

      modal.style.display = 'flex';
    }

    // Í≤ÄÏ¶ù ÏßÑÌñâ Ï§ë Î™®Îã¨ Îã´Í∏∞
    window.closePendingModal = function() {
      document.getElementById('pendingModal').style.display = 'none';
    }

    // Ïø†Ìå°ÏóêÏÑú ÌôïÏù∏ÌïòÍ∏∞
    window.openCoupangQuotation = function() {
      window.open('https://supplier.coupang.com/qvt/quotation', '_blank');
      closePendingModal();
    }

  </script>

  <!-- ÏßÑÌñâ ÏÉÅÌô© Î™®Îã¨ -->
  <div id="progressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 600px; min-width: 500px;">
      <div class="coupang-modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h2 style="margin: 0; color: white;">üöÄ Ïø†Ìå° ÏûêÎèô ÏóÖÎ°úÎìú ÏßÑÌñâ Ï§ë</h2>
      </div>
      <div class="coupang-modal-body" style="padding: 30px;">
        <div id="progressSteps" style="margin-bottom: 20px;"></div>
        <div id="progressMessage" style="margin-top: 20px; font-size: 16px; text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px; min-height: 50px; display: flex; align-items: center; justify-content: center;"></div>
        <div style="margin-top: 20px; text-align: center; color: #666; font-size: 13px;">
          ‚ö†Ô∏è Ïù¥ Ï∞ΩÏùÑ Îã´ÏßÄ ÎßêÍ≥† Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî
        </div>
      </div>
    </div>
  </div>

  <!-- Í≤¨Ï†ÅÏÑú Î∞òÎ†§ Î™®Îã¨ -->
  <div id="rejectedModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 500px;">
      <div class="coupang-modal-header" style="background: #f44336; color: white;">
        <h2 style="margin: 0; color: white;">‚ùå Í≤¨Ï†ÅÏÑú Î∞òÎ†§Îê®</h2>
        <button class="coupang-modal-close" onclick="closeRejectedModal()" style="color: white;">√ó</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
          <p style="font-size: 16px; color: #333; margin: 0;">
            <strong id="rejectedQuotationName">Í≤¨Ï†ÅÏÑúÎ™Ö</strong>
          </p>
          <p style="font-size: 12px; color: #666; margin-top: 5px;">
            ID: <code id="rejectedQuoteIdDisplay" style="background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-size: 11px;">-</code>
          </p>
          <p style="font-size: 14px; color: #f44336; margin-top: 10px;" id="rejectedError">
            Í≤ÄÏ¶ù Ïã§Ìå®
          </p>
        </div>

        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #856404;">
            üí° <strong>ÏÉÅÏÑ∏ÎÇ¥Ïó≠ Îã§Ïö¥Î°úÎìú</strong> Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïã§Ìå® ÏÇ¨Ïú†Î•º ÌôïÏù∏ÌïòÍ≥†,<br>
            ÏàòÏ†ï ÌõÑ Îã§Ïãú ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.
          </p>
        </div>

        <a id="rejectedDownloadUrl" href="#" style="display: none;"></a>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeRejectedModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            Îã´Í∏∞
          </button>
          <button onclick="downloadRejectedDetails()" style="flex: 1; padding: 14px; background: #2196f3; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            üì• Ïø†Ìå°ÏóêÏÑú Îã§Ïö¥Î°úÎìú
          </button>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button onclick="showManualUploadModal()" style="background: none; border: none; color: #666; font-size: 13px; cursor: pointer; text-decoration: underline;">
            ÏàòÎèôÏúºÎ°ú Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•ÌïòÍ∏∞
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ÏóÖÎ°úÎìú Ïã§Ìå® Î™®Îã¨ -->
  <div id="uploadFailedModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px;">
      <div class="coupang-modal-header" style="background: #ff9800; color: white;">
        <h2 style="margin: 0; color: white;">‚ö†Ô∏è ÏóÖÎ°úÎìú Ïò§Î•ò</h2>
        <button class="coupang-modal-close" onclick="closeUploadFailedModal()" style="color: white;">√ó</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">üîß</div>
          <p style="font-size: 14px; color: #666;" id="uploadFailedError">
            ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.
          </p>
        </div>

        <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #1565c0;">
            üí° Ïø†Ìå° ÏÇ¨Ïù¥Ìä∏ÏóêÏÑú ÏßÅÏ†ë ÏóÖÎ°úÎìúÌïòÏÖ®Îã§Î©¥,<br>
            <strong>ÏàòÎèô ÏóÖÎ°úÎìú</strong> Î≤ÑÌäºÏúºÎ°ú Í≤¨Ï†ÅÏÑú IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeUploadFailedModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            Ï∑®ÏÜå
          </button>
          <button onclick="showManualUploadModal()" style="flex: 1; padding: 14px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            üìù ÏàòÎèô ÏóÖÎ°úÎìú
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ÏàòÎèô ÏóÖÎ°úÎìú Î™®Îã¨ -->
  <div id="manualUploadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10004; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px;">
      <div class="coupang-modal-header" style="background: #4caf50; color: white;">
        <h2 style="margin: 0; color: white;">üìù ÏàòÎèô Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•</h2>
        <button class="coupang-modal-close" onclick="closeManualUploadModal()" style="color: white;">√ó</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
            Í≤¨Ï†ÅÏÑú ID (UUID)
          </label>
          <input
            type="text"
            id="uploadedManualQuoteIdInput"
            placeholder="Ïòà: 88eeff72-f3c2-417e-9a07-742d73350956"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;"
          >
          <p style="margin: 8px 0 0; font-size: 12px; color: #999;">
            Ïø†Ìå° Í≤¨Ï†ÅÏÑú Î™©Î°ùÏóêÏÑú ÌååÏùºÎ™ÖÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ URLÏóêÏÑú IDÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeManualUploadModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            Ï∑®ÏÜå
          </button>
          <button onclick="saveUploadedManualQuoteId()" style="flex: 1; padding: 14px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            Ï†ÄÏû•
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Í≤ÄÏ¶ù ÏßÑÌñâ Ï§ë Î™®Îã¨ -->
  <div id="pendingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 500px;">
      <div class="coupang-modal-header" style="background: #ff9800; color: white;">
        <h2 style="margin: 0; color: white;">‚è≥ Í≤ÄÏ¶ù ÏßÑÌñâ Ï§ë</h2>
        <button class="coupang-modal-close" onclick="closePendingModal()" style="color: white;">√ó</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">üîÑ</div>
          <p style="font-size: 16px; color: #333; margin: 0;">
            <strong id="pendingQuotationName">Í≤¨Ï†ÅÏÑúÎ™Ö</strong>
          </p>
          <p style="font-size: 13px; color: #666; margin-top: 8px;">
            Í≤¨Ï†ÅÏÑú ID: <code id="pendingQuoteId" style="background: #f5f5f5; padding: 2px 6px; border-radius: 4px;">-</code>
          </p>
          <p style="font-size: 14px; color: #ff9800; margin-top: 10px;" id="pendingError">
            Í≤ÄÏ¶ùÏù¥ ÏïÑÏßÅ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§.
          </p>
        </div>

        <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #e65100;">
            üí° Ïø†Ìå°ÏóêÏÑú Í≤ÄÏ¶ùÏù¥ ÏôÑÎ£åÎêòÎ©¥ Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.<br>
            Í≤ÄÏ¶ùÏóêÎäî ÏµúÎåÄ <strong>2ÏãúÍ∞Ñ</strong>Ïù¥ ÏÜåÏöîÎê† Ïàò ÏûàÏäµÎãàÎã§.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closePendingModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            Îã´Í∏∞
          </button>
          <button onclick="openCoupangQuotation()" style="flex: 1; padding: 14px; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            üîó Ïø†Ìå°ÏóêÏÑú ÌôïÏù∏
          </button>
        </div>

        <div style="margin-top: 15px; text-align: center;">
          <button onclick="showManualUploadModal()" style="background: none; border: none; color: #666; font-size: 13px; cursor: pointer; text-decoration: underline;">
            ÏàòÎèôÏúºÎ°ú Í≤¨Ï†ÅÏÑú ID ÏûÖÎ†•ÌïòÍ∏∞
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Î™®Îã¨ -->
  <div id="requiredFieldModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10005; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 550px; max-height: 80vh; overflow-y: auto;">
      <div class="coupang-modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
        <h2 style="margin: 0; color: white;">‚ö†Ô∏è ÌïÑÏàò Ìï≠Î™© Í∞í ÌïÑÏöî</h2>
        <button class="coupang-modal-close" onclick="closeRequiredFieldModal()" style="color: white;">√ó</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <p style="margin: 0 0 20px; font-size: 14px; color: #666;">
          Îã§Ïùå ÌïÑÏàò Ìï≠Î™©Ïóê Í∞íÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Í∞íÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÏÑ§Ï†ïÏóê ÏûêÎèô Ï†ÄÏû•Îê©ÎãàÎã§.
        </p>

        <div id="requiredFieldsListNew" style="margin-bottom: 20px;">
          <!-- ÎèôÏ†ÅÏúºÎ°ú ÌïÑÏàò Ïπ∏ Î™©Î°ù Ï∂îÍ∞ÄÎê® -->
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="cancelRequiredFields()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            Ï∑®ÏÜå
          </button>
          <button onclick="saveRequiredFields()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #4caf50 0%, #43a047 100%); color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: 600;">
            ‚úì Ï†ÄÏû• Î∞è Í≥ÑÏÜç
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== ÌïÑÏàò Ïπ∏ ÏûÖÎ†• Î™®Îã¨ Í¥ÄÎ†® =====
    let pendingRequiredFields = [];
    let requiredFieldCallback = null;

    function showRequiredFieldModal(fields, callback) {
      console.log('üìã showRequiredFieldModal Ìò∏Ï∂úÎê®, fields:', fields);
      pendingRequiredFields = fields || [];
      requiredFieldCallback = callback;

      const container = document.getElementById('requiredFieldsListNew');
      if (!container) {
        console.error('‚ùå requiredFieldsListNew Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå!');
        return;
      }
      container.innerHTML = '';

      if (!fields || fields.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">ÏûÖÎ†•Ìï† ÌïÑÏàò Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
        document.getElementById('requiredFieldModal').style.display = 'flex';
        return;
      }

      fields.forEach((field, index) => {
        console.log(`üìã ÌïÑÎìú ${index}:`, field);
        const fieldDiv = document.createElement('div');
        fieldDiv.style.cssText = 'background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px;';

        fieldDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: 600; color: #333; font-size: 14px;">üìã ${field.header}</span>
            <span style="font-size: 12px; color: #888;">Ïó¥ ${field.column}</span>
          </div>
          <div style="display: flex; gap: 8px; margin-bottom: 12px; font-size: 12px;">
            <div style="flex: 1; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
              <span style="color: #888;">7Ìñâ:</span> <span style="color: #333;">${field.row7Value || '(ÎπÑÏñ¥ÏûàÏùå)'}</span>
            </div>
            <div style="flex: 1; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
              <span style="color: #888;">8Ìñâ:</span> <span style="color: #333;">${field.row8Value || '(ÎπÑÏñ¥ÏûàÏùå)'}</span>
            </div>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select id="requiredFieldType_${index}" onchange="toggleRequiredFieldInput(${index})" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; min-width: 120px;">
              <option value="fixed">Í≥†Ï†ïÍ∞í</option>
              <option value="option1">ÏòµÏÖò1 Í∞í</option>
              <option value="option2">ÏòµÏÖò2 Í∞í</option>
            </select>
            <input
              type="text"
              id="requiredFieldValue_${index}"
              placeholder="Í∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
            >
          </div>
        `;

        container.appendChild(fieldDiv);
      });

      document.getElementById('requiredFieldModal').style.display = 'flex';
    }

    function toggleRequiredFieldInput(index) {
      const typeSelect = document.getElementById(`requiredFieldType_${index}`);
      const valueInput = document.getElementById(`requiredFieldValue_${index}`);

      if (typeSelect.value === 'fixed') {
        valueInput.style.display = 'block';
        valueInput.placeholder = 'Í≥†Ï†ïÍ∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
      } else if (typeSelect.value === 'option1') {
        valueInput.style.display = 'none';
      } else if (typeSelect.value === 'option2') {
        valueInput.style.display = 'none';
      }
    }

    function closeRequiredFieldModal() {
      document.getElementById('requiredFieldModal').style.display = 'none';
    }

    function cancelRequiredFields() {
      closeRequiredFieldModal();
      if (requiredFieldCallback) {
        requiredFieldCallback({ cancelled: true });
        requiredFieldCallback = null;
      }
    }

    async function saveRequiredFields() {
      const results = [];

      pendingRequiredFields.forEach((field, index) => {
        const typeSelect = document.getElementById(`requiredFieldType_${index}`);
        const valueInput = document.getElementById(`requiredFieldValue_${index}`);

        const type = typeSelect.value;
        const value = type === 'fixed' ? valueInput.value.trim() : '';

        if (type === 'fixed' && !value) {
          alert(`"${field.header}" ÌïÑÎìúÏóê Í∞íÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.`);
          return;
        }

        results.push({
          header: field.header,
          type: type,
          value: value,
          column: field.column
        });
      });

      if (results.length !== pendingRequiredFields.length) {
        return; // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ïã§Ìå®
      }

      // Î°úÏª¨ ÏÑ§Ï†ïÏóê ÏÉà Îß§Ìïë Ï∂îÍ∞Ä
      for (const newMapping of results) {
        const existingIndex = window.quotationMappings.findIndex(m => m.header === newMapping.header);
        if (existingIndex >= 0) {
          window.quotationMappings[existingIndex] = newMapping;
        } else {
          window.quotationMappings.push(newMapping);
        }
      }

      // ÏÑúÎ≤ÑÏóê Ï†ÄÏû• (ÎπÑÎèôÍ∏∞, Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ)
      try {
        await authFetch('/api/settings/quotation-mappings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quotationMappings: window.quotationMappings })
        });
        console.log('‚úÖ ÌïÑÏàò Ïπ∏ Îß§ÌïëÏù¥ ÏÑúÎ≤ÑÏóê Ï†ÄÏû•Îê®');
      } catch (e) {
        console.error('‚ùå ÏÑúÎ≤Ñ Ï†ÄÏû• Ïã§Ìå®:', e);
      }

      closeRequiredFieldModal();

      if (requiredFieldCallback) {
        requiredFieldCallback({ cancelled: false, mappings: results });
        requiredFieldCallback = null;
      }
    }

    // ExtensionÏóêÏÑú ÌïÑÏàò Ïπ∏ ÏûÖÎ†• ÏöîÏ≤≠ ÏàòÏã†
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'SHOW_REQUIRED_FIELD_MODAL') {
        const { fields, messageId } = event.data;
        console.log('üìã ÌïÑÏàò Ïπ∏ Î™®Îã¨ ÏöîÏ≤≠ ÏàòÏã†:', fields);
        console.log('üìã fields ÌÉÄÏûÖ:', typeof fields, 'length:', fields?.length);

        if (!fields || fields.length === 0) {
          console.error('‚ùå fieldsÍ∞Ä ÎπÑÏñ¥ÏûàÏùå!');
        }

        showRequiredFieldModal(fields, (result) => {
          // Í≤∞Í≥ºÎ•º ExtensionÏúºÎ°ú Ï†ÑÏÜ°
          window.postMessage({
            type: 'REQUIRED_FIELD_RESPONSE',
            messageId: messageId,
            result: result
          }, '*');
        });
      }
    });
  </script>

</body>
</html>
