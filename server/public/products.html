<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>TotalBot - ìƒí’ˆ ê´€ë¦¬ v3</title>
  <!-- JSZip ë¼ì´ë¸ŒëŸ¬ë¦¬ (ZIP íŒŒì¼ ì²˜ë¦¬ìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f7;
      color: #333;
    }

    /* Sidebar Styles */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: #1a1a2e;
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-header {
      padding: 24px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .sidebar-header h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.8;
    }

    .sidebar-menu {
      padding: 16px 0;
    }

    .sidebar-menu-title {
      padding: 12px 20px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: #ccc;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .sidebar-menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }

    .sidebar-menu-item.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      border-left-color: #667eea;
    }

    .sidebar-menu-item .menu-icon {
      width: 24px;
      margin-right: 12px;
      font-size: 18px;
      text-align: center;
    }

    .sidebar-menu-item .menu-badge {
      margin-left: auto;
      background: #667eea;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 12px 20px;
    }

    /* Hamburger Button */
    .hamburger-btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: #f0f0f0;
    }

    .hamburger-btn span {
      display: block;
      width: 22px;
      height: 2px;
      background: #333;
      margin: 2px 0;
      border-radius: 1px;
      transition: all 0.3s;
    }

    /* Floating Action Buttons */
    .floating-actions {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 900;
      pointer-events: none;
    }

    .floating-actions.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .floating-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1a1a2e;
      padding: 8px 12px;
      border-radius: 50px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .floating-pill .selected-badge {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }

    .floating-pill .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .floating-pill .btn-delete {
      background: #ef4444;
      color: white;
    }

    .floating-pill .btn-delete:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .floating-pill .btn-quote {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .floating-pill .btn-quote:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #1e90ff;
      color: white;
    }

    .btn-primary:hover {
      background: #1873cc;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .products-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .search-box {
      display: flex;
      gap: 8px;
    }

    .search-box input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 250px;
      font-size: 14px;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
    }

    .products-table thead {
      background: #f9fafb;
      border-bottom: 1px solid #e5e8eb;
    }

    .products-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #666;
    }

    .products-table td {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }

    .products-table tbody tr:hover {
      background: #f9fafb;
    }

    .products-table tbody tr:has(input[type="checkbox"]:checked) {
      background: #e3f2fd;
    }

    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #e5e8eb;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .product-image:hover {
      transform: scale(1.05);
      border-color: #667eea;
    }

    /* ì´ë¯¸ì§€ í˜¸ë²„ ë¯¸ë¦¬ë³´ê¸° (fixed positionìœ¼ë¡œ overflow ë¬¸ì œ í•´ê²°) */
    #imagePreviewPopup {
      position: fixed;
      width: 280px;
      height: 280px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      pointer-events: none;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }

    #imagePreviewPopup.visible {
      opacity: 1;
      visibility: visible;
    }

    #imagePreviewPopup img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #f8f8f8;
    }

    .product-title {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .platform-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-1688 {
      background: #ff6b00;
      color: white;
    }

    .badge-coupang {
      background: #ff0037;
      color: white;
    }

    .badge-aliexpress {
      background: #e62e04;
      color: white;
    }

    .platform-link {
      text-decoration: none;
      cursor: pointer;
    }

    .platform-link:hover .platform-badge {
      opacity: 0.8;
      transform: scale(1.05);
      transition: all 0.2s ease;
    }

    .source-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .source-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      opacity: 0.9;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-edit {
      background: #1e90ff;
      color: white;
    }

    .btn-edit:hover {
      background: #1873cc;
    }

    .btn-delete {
      background: #ff4444;
      color: white;
    }

    .btn-delete:hover {
      background: #cc0000;
    }

    .empty-state {
      padding: 80px 24px;
      text-align: center;
      color: #888;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    .loading {
      padding: 40px;
      text-align: center;
      color: #888;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* ì„¤ì • ëª¨ë‹¬ */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      padding: 0;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .settings-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e8eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f0f0f0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }

    .modal-close:hover {
      background: #e0e0e0;
    }

    .settings-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .settings-section {
      margin-bottom: 32px;
    }

    .settings-section h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #333;
      font-weight: 600;
      border-bottom: 2px solid #e5e8eb;
      padding-bottom: 8px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-field label {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .settings-field input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .settings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-tab {
      background: transparent;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .settings-tab:hover {
      color: #333;
      background: #f5f5f5;
    }

    .settings-tab.active {
      color: #1e90ff;
      font-weight: 600;
      border-bottom-color: #1e90ff;
    }

    .settings-tab-content {
      display: none;
    }

    .settings-tab-content.active {
      display: block;
    }

    .margin-rows-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      padding: 12px;
      background: #f9fafb;
    }

    .margin-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e8eb;
    }

    .margin-row input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .margin-row button {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .margin-row button:hover {
      background: #dc2626;
    }

    .margin-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    /* ì„¤ì • ë©”ì¸ íƒ­ ìŠ¤íƒ€ì¼ */
    .settings-main-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 2px solid #e0e0e0;
    }

    .settings-main-tab {
      background: transparent;
      border: none;
      padding: 14px 28px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .settings-main-tab:hover {
      color: #1e90ff;
      background: rgba(30, 144, 255, 0.05);
    }

    .settings-main-tab.active {
      color: #1e90ff;
      font-weight: 700;
      border-bottom-color: #1e90ff;
    }

    .settings-main-tab-content {
      display: none;
    }

    .settings-main-tab-content.active {
      display: block;
    }

    .settings-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e8eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-info:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }

    .toast.success {
      background: #28a745;
    }

    .toast.error {
      background: #dc3545;
    }

    .toast.info {
      background: #17a2b8;
    }

    .toast.warning {
      background: #ffc107;
      color: #212529;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* ========================================
       ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ ìŠ¤íƒ€ì¼
       ======================================== */
    #coupangCategoryModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .coupang-modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .coupang-modal-header {
      padding: 24px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .coupang-modal-header h2 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }

    .coupang-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .coupang-modal-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    .coupang-modal-body {
      padding: 24px;
      flex: 1;
      overflow-y: auto;
    }

    .coupang-search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .coupang-search-input {
      width: 100%;
      padding: 18px 24px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: all 0.3s;
    }

    .coupang-search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .coupang-status {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .coupang-status.loading {
      background: #e3f2fd;
      color: #1976d2;
      display: block;
    }

    .coupang-status.error {
      background: #ffebee;
      color: #c62828;
      display: block;
    }

    .coupang-status.success {
      background: #e8f5e9;
      color: #2e7d32;
      display: block;
    }

    .coupang-category-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .coupang-category-item {
      padding: 16px;
      border: 2px solid #f0f0f0;
      border-radius: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .coupang-category-item:hover {
      background: #f8f9fa;
      border-color: #667eea;
    }

    .coupang-category-item.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      color: white;
    }

    .coupang-category-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .coupang-category-content {
      flex: 1;
    }

    .coupang-category-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .coupang-category-path {
      font-size: 14px;
      opacity: 0.7;
    }

    .coupang-category-item.selected .coupang-category-path {
      opacity: 0.9;
    }

    .coupang-empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .coupang-modal-footer {
      padding: 20px 24px;
      border-top: 2px solid #f0f0f0;
    }

    .coupang-download-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .coupang-download-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .coupang-download-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* Main Tabs (2 tabs only) */
    .main-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      padding: 0;
    }

    .main-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px 24px;
      background: white;
      border: 2px solid #e5e8eb;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .main-tab:hover {
      border-color: #1e90ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.15);
    }

    .main-tab.active {
      background: linear-gradient(135deg, #1e90ff 0%, #4dabf7 100%);
      border-color: transparent;
      box-shadow: 0 4px 16px rgba(30, 144, 255, 0.3);
    }

    .main-tab .tab-icon {
      font-size: 28px;
    }

    .main-tab .tab-label {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .main-tab.active .tab-label {
      color: white;
    }

    .main-tab .tab-count {
      background: #f0f0f0;
      color: #666;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
    }

    .main-tab.active .tab-count {
      background: rgba(255,255,255,0.25);
      color: white;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Upload Dashboard */
    .upload-dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .dashboard-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 24px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-left: 4px solid;
    }

    .dashboard-card.total {
      border-left-color: #1e90ff;
    }

    .dashboard-card.pending {
      border-left-color: #ffa726;
    }

    .dashboard-card.approved {
      border-left-color: #66bb6a;
    }

    .dashboard-card .card-icon {
      font-size: 36px;
    }

    .dashboard-card .card-info {
      flex: 1;
    }

    .dashboard-card .card-value {
      font-size: 32px;
      font-weight: 700;
      color: #222;
      line-height: 1;
    }

    .dashboard-card .card-label {
      font-size: 14px;
      color: #888;
      margin-top: 4px;
    }

    /* Approval Stage Badge */
    .approval-stage {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .approval-stage.stage-onboarded {
      background: #fff3e0;
      color: #e65100;
    }

    .approval-stage.stage-hotw {
      background: #e3f2fd;
      color: #1565c0;
    }

    .approval-stage.stage-r21 {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .approval-stage.stage-approved {
      background: linear-gradient(135deg, #4caf50, #81c784);
      color: white;
    }

    .approval-stage.stage-rejected {
      background: #ffebee;
      color: #c62828;
    }

    .approval-stage.stage-pending {
      background: #f5f5f5;
      color: #757575;
    }

    .approval-stage .stage-icon {
      font-size: 14px;
    }

    /* Uploaded Product Card */
    .uploaded-product-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: white;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .uploaded-product-card:hover {
      background: #fafafa;
    }

    .uploaded-product-card:last-child {
      border-bottom: none;
    }

    .uploaded-product-card .product-thumb {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: #f0f0f0;
    }

    .uploaded-product-card .product-info {
      flex: 1;
      min-width: 0;
    }

    .uploaded-product-card .product-title {
      font-size: 14px;
      font-weight: 600;
      color: #222;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .uploaded-product-card .product-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #888;
    }

    .uploaded-product-card .quote-id {
      color: #1e90ff;
      font-weight: 500;
    }

    .uploaded-product-card .sku-stats {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .uploaded-product-card .sku-total {
      color: #333;
      font-weight: 600;
    }

    .uploaded-product-card .sku-pending {
      color: #f59e0b;
    }

    .uploaded-product-card .sku-approved {
      color: #10b981;
    }

    .uploaded-product-card .sku-rejected {
      color: #ef4444;
    }

    .uploaded-product-card .sku-unchecked {
      color: #9ca3af;
      font-size: 11px;
      font-style: italic;
    }

    .uploaded-product-card .product-quote {
      font-size: 11px;
      color: #1e90ff;
      margin-top: 4px;
    }

    .uploaded-product-card .product-stage-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 120px;
    }

    .uploaded-product-card .stage-progress {
      font-size: 11px;
      color: #888;
    }

    /* Status Badge in Table */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.collected {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.uploaded {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.edited {
      background: #e0e7ff;
      color: #3730a3;
    }

    .status-badge.manual_pending {
      background: #fef3c7;
      color: #b45309;
      border: 1px dashed #f59e0b;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Image Preview Popup -->
  <div id="imagePreviewPopup">
    <img id="imagePreviewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>TotalBot</h2>
      <p>ì¿ íŒ¡ ìë™í™” í”Œë«í¼</p>
    </div>

    <div class="sidebar-menu">
      <div class="sidebar-menu-title">ìƒí’ˆ ê´€ë¦¬</div>
      <a class="sidebar-menu-item active" href="products.html">
        <span class="menu-icon">ğŸ“¦</span>
        ìˆ˜ì§‘ ìƒí’ˆ
      </a>
      <a class="sidebar-menu-item" href="uploaded.html">
        <span class="menu-icon">ğŸš€</span>
        ì—…ë¡œë“œ ì™„ë£Œ
      </a>
      <a class="sidebar-menu-item" href="quotations.html">
        <span class="menu-icon">ğŸ“‹</span>
        ê²¬ì ì„œ ê´€ë¦¬
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">ë°œì£¼ ê´€ë¦¬</div>
      <a class="sidebar-menu-item" href="orders.html">
        <span class="menu-icon">ğŸ›’</span>
        ìë™ ë°œì£¼
        <span class="menu-badge">NEW</span>
      </a>
      <a class="sidebar-menu-item" href="order-list.html">
        <span class="menu-icon">ğŸ“‘</span>
        ë°œì£¼ ë¦¬ìŠ¤íŠ¸
      </a>
      <a class="sidebar-menu-item" href="shipments.html">
        <span class="menu-icon">ğŸšš</span>
        ë°°ì†¡ ê´€ë¦¬
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">ë¶„ì„/ì„¤ì •</div>
      <a class="sidebar-menu-item" href="settlement.html">
        <span class="menu-icon">ğŸ’°</span>
        ì •ì‚°
      </a>
      <a class="sidebar-menu-item" onclick="openSettingsModal(); toggleSidebar();" style="cursor: pointer;">
        <span class="menu-icon">âš™ï¸</span>
        ì„¤ì •
      </a>
      <a class="sidebar-menu-item" onclick="logout();" style="cursor: pointer; color: #dc3545;">
        <span class="menu-icon">ğŸšª</span>
        ë¡œê·¸ì•„ì›ƒ
      </a>
    </div>
  </nav>

  <div class="header">
    <div class="header-left" style="display: flex; align-items: center; gap: 16px;">
      <button class="hamburger-btn" onclick="toggleSidebar()" title="ë©”ë‰´">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1>ìˆ˜ì§‘ ìƒí’ˆ</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" id="coupangLoginStatus" onclick="checkCoupangLogin()"
              style="font-size: 18px; padding: 8px 12px; position: relative;"
              title="ì¿ íŒ¡ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸">
        <span id="coupangLoginIcon">âŒ</span>
        <span style="font-size: 11px; position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">ì¿ íŒ¡</span>
      </button>
      <button class="btn btn-secondary" onclick="openSettingsModal()" style="font-size: 18px; padding: 8px 12px;">âš™ï¸</button>
    </div>
  </div>

  <!-- í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ (ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ í‘œì‹œ) -->
  <div class="floating-actions" id="floatingActions">
    <div class="floating-pill">
      <span class="selected-badge" id="selectedCountText">0ê°œ</span>
      <button class="action-btn btn-delete" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button class="action-btn btn-quote" onclick="generateQuote()">ğŸš€ ì œí’ˆ ë“±ë¡</button>
    </div>
  </div>

  <div class="container">
    <!-- ìˆ˜ì§‘ ìƒí’ˆ ëª©ë¡ -->
    <div class="products-section">
      <div class="section-header">
        <h2>ìˆ˜ì§‘ëœ ìƒí’ˆ ëª©ë¡ <span id="productCount" style="font-weight: normal; color: #888;"></span></h2>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ìƒí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="filterProducts()">
          <button class="btn btn-secondary btn-sm" onclick="loadProducts()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div id="productsContainer">
        <div class="loading">ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2>âš™ï¸ TotalBot ì„¤ì •</h2>
        <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
      </div>

      <!-- ì„¤ì • ë©”ì¸ íƒ­ -->
      <div class="settings-main-tabs">
        <button class="settings-main-tab" onclick="switchMainSettingsTab('info')">ì •ë³´ ì„¤ì •</button>
        <button class="settings-main-tab active" onclick="switchMainSettingsTab('price')">ê°€ê²© ì„¤ì •</button>
        <button class="settings-main-tab" onclick="switchMainSettingsTab('quotation')">ê²¬ì ì„œ ì–‘ì‹</button>
        <button class="settings-main-tab" onclick="switchMainSettingsTab('template')">í…œí”Œë¦¿ ì„¤ì •</button>
      </div>

      <div class="settings-body">
        <!-- ì •ë³´ ì„¤ì • íƒ­ -->
        <div id="info-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>ì¿ íŒ¡ ê³„ì • ì •ë³´</h3>
            <div class="settings-grid">
              <div class="settings-field">
                <label>ì¿ íŒ¡ ì•„ì´ë””</label>
                <input type="text" id="settingsCoupangId" placeholder="ì¿ íŒ¡ ì•„ì´ë”” ì…ë ¥">
              </div>
              <div class="settings-field">
                <label>ì¿ íŒ¡ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="settingsCoupangPassword" placeholder="ì¿ íŒ¡ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>ë°˜í’ˆ/êµí™˜ ì£¼ì†Œ</h3>
            <div class="settings-field">
              <label>ì£¼ì†Œ</label>
              <input type="text" id="settingsAddress" placeholder="ë°˜í’ˆ/êµí™˜ ì£¼ì†Œ ì…ë ¥">
            </div>
          </div>

          <div class="settings-section">
            <h3>ë¸Œëœë“œ ì •ë³´</h3>
            <div class="settings-field">
              <label>ë¸Œëœë“œëª…</label>
              <input type="text" id="settingsBrandName" placeholder="ë¸Œëœë“œëª… ì…ë ¥ (ê²¬ì ì„œì— ì‚¬ìš©ë¨)">
            </div>
          </div>

          <div class="settings-section">
            <h3>ë‹¤ìš´ë¡œë“œ ì„¤ì •</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ê²¬ì ì„œ ZIP íŒŒì¼ì˜ ì €ì¥ ìœ„ì¹˜ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ë‹¤ìŒ ë‹¤ìš´ë¡œë“œ ì‹œ ì €ì¥ ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <button class="btn btn-secondary" onclick="resetDownloadPath()">ì €ì¥ ìœ„ì¹˜ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- ê°€ê²© ì„¤ì • íƒ­ -->
        <div id="price-main-settings-tab" class="settings-main-tab-content active">
          <!-- ê¸°ë³¸ ì„¤ì • -->
          <div class="settings-section">
            <h3>ê¸°ë³¸ ì„¤ì •</h3>
          <div class="settings-grid">
            <div class="settings-field">
              <label>í™˜ìœ¨ (CNY â†’ KRW)</label>
              <input type="number" id="settingsExchangeRate" value="190" step="1">
            </div>
            <div class="settings-field">
              <label>ê°œë‹¹í¬ì¥ ë¹„ìš© (ì›)</label>
              <input type="number" id="settingsPackagingCost" value="500" step="100">
            </div>
            <div class="settings-field">
              <label>ì‰½ë¨¼íŠ¸ ë¹„ìš© (ì›)</label>
              <input type="number" id="settingsShipmentCost" value="0" step="100">
            </div>
            <div class="settings-field">
              <label>ì¿ íŒ¡ ìµœì†Œ ë§ˆì§„ê¸ˆ (ì›)</label>
              <input type="number" id="settingsMinMargin" value="3000" step="100">
            </div>
          </div>
        </div>

        <!-- ë§ˆì§„ ì„¤ì • -->
        <div class="settings-section">
          <h3>ë§ˆì§„ ì„¤ì •</h3>

          <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('supply')">ê³µê¸‰ê°€ ë§ˆì§„</button>
            <button class="settings-tab" onclick="switchSettingsTab('sale')">íŒë§¤ê°€ ë§ˆì§„</button>
          </div>

          <!-- ê³µê¸‰ê°€ ë§ˆì§„ íƒ­ -->
          <div id="supply-settings-tab" class="settings-tab-content active">
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ì›ê°€ êµ¬ê°„ë³„ë¡œ ê³µê¸‰ê°€ ë§ˆì§„ìœ¨ì„ ì„¤ì •í•©ë‹ˆë‹¤. ë‚®ì€ ê¸ˆì•¡ë¶€í„° ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.
            </p>
            <div class="margin-rows-container" id="supplyMarginRows">
              <!-- ê³µê¸‰ê°€ ë§ˆì§„ í–‰ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
            <div class="margin-actions">
              <button class="btn btn-primary btn-sm" onclick="addSupplyMarginRow()">+ í–‰ ì¶”ê°€</button>
              <button class="btn btn-secondary btn-sm" onclick="sortSupplyMarginRows()">ì •ë ¬</button>
              <button class="btn btn-secondary btn-sm" onclick="clearSupplyMarginRows()">ëª¨ë‘ ì‚­ì œ</button>
            </div>
          </div>

          <!-- íŒë§¤ê°€ ë§ˆì§„ íƒ­ -->
          <div id="sale-settings-tab" class="settings-tab-content">
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ê³µê¸‰ê°€ êµ¬ê°„ë³„ë¡œ íŒë§¤ê°€ ë§ˆì§„ìœ¨ì„ ì„¤ì •í•©ë‹ˆë‹¤. ë‚®ì€ ê¸ˆì•¡ë¶€í„° ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.
            </p>
            <div class="margin-rows-container" id="saleMarginRows">
              <!-- íŒë§¤ê°€ ë§ˆì§„ í–‰ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
            <div class="margin-actions">
              <button class="btn btn-primary btn-sm" onclick="addSaleMarginRow()">+ í–‰ ì¶”ê°€</button>
              <button class="btn btn-secondary btn-sm" onclick="sortSaleMarginRows()">ì •ë ¬</button>
              <button class="btn btn-secondary btn-sm" onclick="clearSaleMarginRows()">ëª¨ë‘ ì‚­ì œ</button>
            </div>
          </div>
        </div>
        </div>

        <!-- í…œí”Œë¦¿ ì„¤ì • íƒ­ -->
        <div id="template-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>ëŒ€í‘œ ì´ë¯¸ì§€</h3>
            <div class="settings-field">
              <label>ë¸Œëœë“œ ëŒ€í‘œ ì´ë¯¸ì§€</label>
              <input type="file" id="brandImageInput" accept="image/*" onchange="handleBrandImageUpload(event)" style="margin-bottom: 8px;">
              <div id="brandImagePreview" style="display: none; margin-top: 12px;">
                <img id="brandImagePreviewImg" src="" alt="ëŒ€í‘œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="max-width: 300px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>ìƒì„¸í˜ì´ì§€ ê¸°ë³¸ êµ¬ì„± ì„¤ì •</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ìƒì„¸í˜ì´ì§€ì— ê¸°ë³¸ìœ¼ë¡œ í‘œì‹œë  í•­ëª©ë“¤ì„ ì„¤ì •í•©ë‹ˆë‹¤. ìˆœì„œë¥¼ ë³€ê²½í•˜ê±°ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="defaultDetailTemplateContainer"></div>
            <button class="btn btn-primary btn-sm" onclick="addDefaultTemplateText()" style="margin-top: 12px;">+ í…ìŠ¤íŠ¸ ì¶”ê°€</button>
            <button class="btn btn-secondary btn-sm" onclick="resetDefaultTemplate()" style="margin-top: 12px;">ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹</button>
          </div>

          <div class="settings-section">
            <h3>í’ˆì§ˆí‘œì‹œì‚¬í•­ ê¸°ë³¸ ë‚´ìš©</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              í’ˆì§ˆí‘œì‹œì‚¬í•­ì— ê¸°ë³¸ìœ¼ë¡œ í‘œì‹œë  í–‰ë“¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
            </p>
            <div id="defaultQualityRowsContainer"></div>
            <button class="btn btn-primary btn-sm" onclick="addDefaultQualityRow()" style="margin-top: 12px;">+ í–‰ ì¶”ê°€</button>
          </div>

        </div>

        <!-- ê²¬ì ì„œ ì–‘ì‹ íƒ­ -->
        <div id="quotation-main-settings-tab" class="settings-main-tab-content">
          <div class="settings-section">
            <h3>ê²¬ì ì„œ ì‘ì„± ì–‘ì‹</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
              ì¿ íŒ¡ ê²¬ì ì„œ Excel íŒŒì¼ì— ìë™ìœ¼ë¡œ ì‘ì„±ë  ë‚´ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
              <strong>íŠ¹ìˆ˜ í•­ëª©</strong> (ê²€ìƒ‰íƒœê·¸, ê³µê¸‰ê°€, íŒë§¤ê°€, ë¸Œëœë“œ ë“±)ì€ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©° ì—¬ê¸°ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
            <div id="quotationMappingContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; background: #fafafa;"></div>
            <button class="btn btn-primary btn-sm" onclick="addQuotationMapping()" style="margin-top: 12px;">+ ë§¤í•‘ ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
        <button class="btn btn-success" onclick="saveSettings()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // ë²„ì „ í™•ì¸ìš© (ë¸Œë¼ìš°ì € ìºì‹œ í™•ì¸)
    console.log('ğŸ”„ TotalBot Products ë²„ì „: 2025-11-29-v5-AUTH (ì¸ì¦ ì¶”ê°€)');
    console.log('âœ… ìµœì‹  ë²„ì „ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');

    // ===== ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ =====
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function getUserInfo() {
      const info = localStorage.getItem('userInfo');
      return info ? JSON.parse(info) : null;
    }

    function checkAuth() {
      const token = getAuthToken();
      if (!token) {
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = '/login.html';
        return false;
      }
      return true;
    }

    async function authFetch(url, options = {}) {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login.html';
        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }

      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
      };

      const response = await fetch(url, { ...options, headers });

      // 401 ì—ëŸ¬ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
      if (response.status === 401) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
        throw new Error('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      return response;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ì²´í¬
    if (!checkAuth()) {
      throw new Error('ì¸ì¦ í•„ìš”');
    }

    // ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('userName');
        window.location.href = '/login.html';
      }
    }

    // ì´ë¯¸ì§€ í˜¸ë²„ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    function showImagePreview(event) {
      const img = event.target;
      const previewSrc = img.dataset.preview;

      // ê¸°ë³¸ placeholder ì´ë¯¸ì§€ì¸ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° ì•ˆí•¨
      if (!previewSrc || previewSrc.includes('data:image/svg+xml')) return;

      const popup = document.getElementById('imagePreviewPopup');
      const previewImg = document.getElementById('imagePreviewImg');

      previewImg.src = previewSrc;

      // ì´ë¯¸ì§€ ìœ„ì¹˜ ê³„ì‚° (ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ì— í‘œì‹œ)
      const rect = img.getBoundingClientRect();
      let left = rect.right + 10;
      let top = rect.top + (rect.height / 2) - 140; // ë¯¸ë¦¬ë³´ê¸° ë†’ì´ì˜ ì ˆë°˜

      // í™”ë©´ ì˜¤ë¥¸ìª½ ë²—ì–´ë‚˜ë©´ ì™¼ìª½ì— í‘œì‹œ
      if (left + 280 > window.innerWidth) {
        left = rect.left - 290;
      }

      // í™”ë©´ ìœ„/ì•„ë˜ ë²—ì–´ë‚˜ë©´ ì¡°ì •
      if (top < 10) top = 10;
      if (top + 280 > window.innerHeight - 10) {
        top = window.innerHeight - 290;
      }

      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
      popup.classList.add('visible');
    }

    // ì´ë¯¸ì§€ í˜¸ë²„ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
    function hideImagePreview() {
      const popup = document.getElementById('imagePreviewPopup');
      popup.classList.remove('visible');
    }

    // ESC í‚¤ë¡œ ì‚¬ì´ë“œë°” ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    });

    // Toast ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ì¿ íŒ¡ ìŠ¹ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
    async function checkApprovalStatus() {
      const btn = event?.target || document.querySelector('.btn-info');
      const originalText = btn?.textContent || 'ğŸ” ìŠ¹ì¸ í™•ì¸';

      try {
        btn.disabled = true;
        btn.textContent = 'í™•ì¸ ì¤‘...';
        showToast('ìŠ¹ì¸ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');

        // ì—…ë¡œë“œë¨ ìƒíƒœì˜ ìƒí’ˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const response = await authFetch('/api/products/list');
        const data = await response.json();

        if (!data.success) {
          throw new Error('ìƒí’ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        const uploadedProducts = data.products.filter(p =>
          p.status === 'uploaded' && p.quoteId
        );

        if (uploadedProducts.length === 0) {
          showToast('í™•ì¸í•  ì—…ë¡œë“œëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        // ì‘ë‹µ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í•œ ë²ˆë§Œ ì‹¤í–‰)
        const responseHandler = (event) => {
          if (event.data && event.data.source === 'totalbot-extension-response' &&
              event.data.originalAction === 'checkApprovalNow') {
            window.removeEventListener('message', responseHandler);

            const response = event.data.response;
            btn.disabled = false;
            btn.textContent = originalText;

            if (response && response.success) {
              const result = response.result;
              const skipped = result.skippedCount || 0;

              if (result.approvedCount > 0) {
                showToast(`${result.approvedCount}ê°œ ìƒí’ˆì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success', 5000);
              } else if (result.checkedCount > 0) {
                let msg = `${result.checkedCount}ê°œ ê²¬ì ì„œ í™•ì¸ ì™„ë£Œ.`;
                if (skipped > 0) {
                  msg += ` (${skipped}ê°œ ê±´ë„ˆëœ€: ë°˜ë ¤/ìŠ¹ì¸ ì™„ë£Œ)`;
                }
                showToast(msg, 'info');
              } else if (skipped > 0) {
                showToast(`ëª¨ë“  ìƒí’ˆì´ ì‹¬ì‚¬ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (${skipped}ê°œ ê±´ë„ˆëœ€)`, 'info');
              } else {
                showToast('í™•ì¸í•  ê²¬ì ì„œê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
              }
              // ê²°ê³¼ì— ê´€ê³„ì—†ì´ SKU ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              if (result.checkedCount > 0) {
                loadProducts();
              }
            } else {
              const errorMsg = response?.error || 'ìŠ¹ì¸ í™•ì¸ ì‹¤íŒ¨';
              showToast(errorMsg, 'error');
            }
          }
        };

        window.addEventListener('message', responseHandler);

        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
        setTimeout(() => {
          window.removeEventListener('message', responseHandler);
          if (btn.disabled) {
            btn.disabled = false;
            btn.textContent = originalText;
            showToast('ì‘ë‹µ ì‹œê°„ ì´ˆê³¼. ì¿ íŒ¡ í˜ì´ì§€ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.', 'error');
          }
        }, 30000);

        // Chrome Extensionì— ë©”ì‹œì§€ ì „ì†¡ (postMessage ì‚¬ìš©)
        window.postMessage({
          source: 'totalbot-page',
          action: 'checkApprovalNow',
          products: uploadedProducts
        }, '*');

      } catch (error) {
        console.error('ìŠ¹ì¸ í™•ì¸ ì˜¤ë¥˜:', error);
        showToast('ìŠ¹ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    let allProducts = [];
    let selectedProducts = new Set();
    let currentTab = 'collected';

    // ìƒíƒœ ë¼ë²¨ ë°˜í™˜
    function getStatusLabel(status, isEdited) {
      // í¸ì§‘ ì™„ë£Œ ìƒíƒœ ìš°ì„  í‘œì‹œ
      if (isEdited && status === 'collected') {
        return 'í¸ì§‘ì™„ë£Œ';
      }
      const labels = {
        'collected': 'ìˆ˜ì§‘ë¨',
        'uploaded': 'ì‹¬ì‚¬ì¤‘',
        'approved': 'ìŠ¹ì¸ì™„ë£Œ',
        'manual_pending': 'ìˆ˜ë™ ëŒ€ê¸°'
      };
      return labels[status] || 'ìˆ˜ì§‘ë¨';
    }

    // ë©”ì¸ íƒ­ ì „í™˜
    function switchMainTab(tab) {
      currentTab = tab;

      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.main-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });

      // íƒ­ ë‚´ìš© í‘œì‹œ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tab}-tab-content`).classList.add('active');

      // í•´ë‹¹ íƒ­ì˜ ìƒí’ˆ ë Œë”ë§
      if (tab === 'collected') {
        const collectedProducts = allProducts.filter(p => (p.status || 'collected') === 'collected');
        renderProducts(collectedProducts);
      } else {
        renderUploadedProducts();
      }
    }

    // íƒ­ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    function updateTabCounts() {
      const collectedCount = allProducts.filter(p => (p.status || 'collected') === 'collected').length;
      const uploadedCount = allProducts.filter(p => p.status === 'uploaded' || p.status === 'approved').length;

      document.getElementById('tab-count-collected').textContent = collectedCount;
      document.getElementById('tab-count-uploaded').textContent = uploadedCount;

      // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
      updateUploadDashboard();
    }

    // ì—…ë¡œë“œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ API ë°ì´í„° ì‚¬ìš©)
    function updateUploadDashboard() {
      const uploadedProducts = allProducts.filter(p => p.status === 'uploaded' || p.status === 'approved');

      // ì‹¤ì œ SKU ë°ì´í„° ì§‘ê³„
      let totalSku = 0;
      let pendingSku = 0;
      let approvedSku = 0;

      uploadedProducts.forEach(p => {
        if (p.skuStatus) {
          // APIì—ì„œ ë°›ì€ ì‹¤ì œ ë°ì´í„°
          totalSku += p.skuStatus.totalSku || 0;
          pendingSku += p.skuStatus.pending || 0;
          approvedSku += p.skuStatus.approved || 0;
        }
      });

      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒí’ˆ ìˆ˜ë¡œ í‘œì‹œ (ì•„ì§ í™•ì¸ ì•ˆ ë¨)
      const checkedProducts = uploadedProducts.filter(p => p.skuStatus).length;
      const uncheckedProducts = uploadedProducts.length - checkedProducts;

      document.getElementById('dash-total-sku').textContent = totalSku > 0 ? totalSku : (uncheckedProducts > 0 ? `${uncheckedProducts}ê°œ ë¯¸í™•ì¸` : '0');
      document.getElementById('dash-pending-count').textContent = pendingSku;
      document.getElementById('dash-approved-count').textContent = approvedSku;
    }

    // ìŠ¹ì¸ ë‹¨ê³„ ë±ƒì§€ ìƒì„±
    function getApprovalStageBadge(product) {
      const status = product.status;
      const skuStatus = product.skuStatus;
      const approvalStage = skuStatus?.currentStage || product.approvalStage;

      if (status === 'approved') {
        return `<span class="approval-stage stage-approved">
          <span class="stage-icon">âœ“</span> ìŠ¹ì¸ì™„ë£Œ
        </span>`;
      }

      if (product.isRejected || (skuStatus && skuStatus.rejected > 0)) {
        return `<span class="approval-stage stage-rejected">
          <span class="stage-icon">âœ—</span> ë°˜ë ¤
        </span>`;
      }

      // ì‹¬ì‚¬ ë‹¨ê³„ë³„
      if (approvalStage === 'R21') {
        return `<span class="approval-stage stage-r21">
          <span class="stage-icon">ğŸ“‹</span> ë°œì£¼ì„œë°œí–‰
        </span>`;
      } else if (approvalStage === 'HOTW') {
        return `<span class="approval-stage stage-hotw">
          <span class="stage-icon">ğŸ“¦</span> ìƒí’ˆì •ë³´
        </span>`;
      } else if (approvalStage === 'ONBOARDED') {
        return `<span class="approval-stage stage-onboarded">
          <span class="stage-icon">ğŸ’°</span> ê°€ê²©/ì •ì±…
        </span>`;
      }

      // ì•„ì§ í™•ì¸ ì•ˆ ë¨
      if (!skuStatus) {
        return `<span class="approval-stage stage-pending">
          <span class="stage-icon">â“</span> ë¯¸í™•ì¸
        </span>`;
      }

      // ê¸°ë³¸: ì‹¬ì‚¬ì¤‘
      return `<span class="approval-stage stage-pending">
        <span class="stage-icon">â³</span> ì‹¬ì‚¬ëŒ€ê¸°
      </span>`;
    }

    // ì—…ë¡œë“œëœ ìƒí’ˆ ëª©ë¡ ë Œë”ë§
    function renderUploadedProducts() {
      const container = document.getElementById('uploadedProductsContainer');
      const uploadedProducts = allProducts.filter(p => p.status === 'uploaded' || p.status === 'approved');

      if (uploadedProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸš€</div>
            <p>ì•„ì§ ì—…ë¡œë“œëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p style="font-size: 13px; color: #888;">ìˆ˜ì§‘ ìƒí’ˆì„ ì¿ íŒ¡ì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
        return;
      }

      const html = uploadedProducts.map(product => {
        const mainImage = product.mainImages?.[0] || product.images?.[0] || '';
        const quoteId = product.quoteId || '-';

        // SKU ì •ë³´ ê³„ì‚°
        const skuInfo = getSkuInfo(product);

        // SKU ìƒíƒœ í‘œì‹œ (ë°ì´í„° ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ)
        let skuStatsHtml;
        if (skuInfo.hasData) {
          skuStatsHtml = `
            <span class="sku-stats">
              <span class="sku-total">${skuInfo.total}ê°œ SKU</span>
              ${skuInfo.pending > 0 ? `<span class="sku-pending">Â· ${skuInfo.pending}ê°œ ì‹¬ì‚¬ì¤‘</span>` : ''}
              ${skuInfo.approved > 0 ? `<span class="sku-approved">Â· ${skuInfo.approved}ê°œ ìŠ¹ì¸</span>` : ''}
              ${skuInfo.rejected > 0 ? `<span class="sku-rejected">Â· ${skuInfo.rejected}ê°œ ë°˜ë ¤</span>` : ''}
            </span>
          `;
        } else {
          skuStatsHtml = `
            <span class="sku-stats">
              <span class="sku-unchecked">ğŸ” ìŠ¹ì¸ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
            </span>
          `;
        }

        return `
          <div class="uploaded-product-card" onclick="showProductDetail('${product.id}')">
            <img class="product-thumb" src="${mainImage}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23ccc%22>ğŸ“¦</text></svg>'">
            <div class="product-info">
              <div class="product-title">${product.title || 'ì œëª© ì—†ìŒ'}</div>
              <div class="product-meta">
                ${skuStatsHtml}
              </div>
              <div class="product-quote">ê²¬ì ì„œ #${quoteId}</div>
            </div>
            <div class="product-stage-info">
              ${getApprovalStageBadge(product)}
              <div class="stage-progress">${getStageProgressText(product)}</div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // SKU ì •ë³´ ê³„ì‚° (APIì—ì„œ ë°›ì€ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©)
    function getSkuInfo(product) {
      // skuStatusê°€ ìˆìœ¼ë©´ ì‹¤ì œ API ë°ì´í„° ì‚¬ìš©
      if (product.skuStatus) {
        return {
          total: product.skuStatus.totalSku || 0,
          pending: product.skuStatus.pending || 0,
          approved: product.skuStatus.approved || 0,
          rejected: product.skuStatus.rejected || 0,
          inProgress: product.skuStatus.inProgress || 0,
          hasData: true
        };
      }

      // skuStatusê°€ ì—†ìœ¼ë©´ (ì•„ì§ í™•ì¸ ì•ˆ ëœ ìƒí’ˆ) - ê¸°ë³¸ê°’
      return {
        total: 0,
        pending: 0,
        approved: 0,
        rejected: 0,
        inProgress: 0,
        hasData: false
      };
    }

    // ì‹¬ì‚¬ ì§„í–‰ ë‹¨ê³„ í…ìŠ¤íŠ¸
    function getStageProgressText(product) {
      const status = product.status;
      const skuStatus = product.skuStatus;

      if (status === 'approved') {
        return 'ì‹¬ì‚¬ ì™„ë£Œ';
      }

      if (product.isRejected) {
        return 'ë°˜ë ¤ë¨';
      }

      // skuStatusê°€ ìˆìœ¼ë©´ ìƒì„¸ ì§„í–‰ë¥  í‘œì‹œ
      if (skuStatus && skuStatus.totalSku > 0) {
        const total = skuStatus.totalSku;
        const approved = skuStatus.approved || 0;
        const stage = skuStatus.currentStage;

        if (approved === total) {
          return 'ì‹¬ì‚¬ ì™„ë£Œ';
        }

        // ë‹¨ê³„ë³„ ìƒì„¸
        if (stage === 'R21') {
          return `3ë‹¨ê³„ (${skuStatus.step3Completed}/${total})`;
        } else if (stage === 'HOTW') {
          return `2ë‹¨ê³„ (${skuStatus.step2Completed}/${total})`;
        } else if (stage === 'ONBOARDED') {
          return `1ë‹¨ê³„ (${skuStatus.step1Completed}/${total})`;
        }

        return `ì‹¬ì‚¬ì¤‘ ${approved}/${total}`;
      }

      // ë°ì´í„° ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
      return 'í™•ì¸ í•„ìš”';
    }

    // êµ¬ í•¨ìˆ˜ í˜¸í™˜ (ê¸°ì¡´ ì½”ë“œì—ì„œ í˜¸ì¶œë  ìˆ˜ ìˆìŒ)
    function updateStatusCounts() {
      updateTabCounts();
    }

    function filterByStatus(status) {
      if (status === 'collected') {
        switchMainTab('collected');
      } else {
        switchMainTab('uploaded');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    window.addEventListener('load', () => {
      loadProducts();
    });

    // ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸°ë¡œ í˜ì´ì§€ ë³µì› ì‹œ ìƒˆë¡œê³ ì¹¨
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        // bfcacheì—ì„œ ë³µì›ëœ ê²½ìš° ìƒí’ˆ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
        console.log('[Products] í˜ì´ì§€ ë³µì›ë¨, ìƒí’ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
        loadProducts();
      }
    });

    // ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ˜ì§‘ ìƒí’ˆë§Œ)
    async function loadProducts() {
      try {
        const response = await authFetch('/api/products/list');

        if (!response.ok) {
          throw new Error('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();
        allProducts = data.products || [];

        // ìˆ˜ì§‘ ìƒí’ˆë§Œ í•„í„°ë§ (ì—…ë¡œë“œ/ìŠ¹ì¸ëœ ìƒí’ˆì€ uploaded.htmlì—ì„œ í‘œì‹œ)
        const collectedProducts = allProducts.filter(p => (p.status || 'collected') === 'collected');

        // ìƒí’ˆ ìˆ˜ í‘œì‹œ
        document.getElementById('productCount').textContent = `(${collectedProducts.length}ê°œ)`;

        renderProducts(collectedProducts);
      } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
        showEmptyState('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸ (í˜¸í™˜ìš©)
    function updateStats() {
      updateTabCounts();
    }

    // ìƒí’ˆ ëª©ë¡ ë Œë”ë§
    function renderProducts(products) {
      const container = document.getElementById('productsContainer');

      if (!products || products.length === 0) {
        showEmptyState('ì•„ì§ ìˆ˜ì§‘ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>Chrome í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ìƒí’ˆì„ ìˆ˜ì§‘í•´ì£¼ì„¸ìš”.');
        return;
      }

      const html = `
        <table class="products-table">
          <thead>
            <tr>
              <th><input type="checkbox" class="checkbox" onchange="toggleSelectAll(this)"></th>
              <th>ì´ë¯¸ì§€</th>
              <th>ìƒí’ˆëª…</th>
              <th>í”Œë«í¼</th>
              <th>ì˜µì…˜ ìˆ˜</th>
              <th>ê°€ê²©</th>
              <th>ìƒíƒœ</th>
              <th>ìˆ˜ì§‘ì¼</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
            ${products.map((product, index) => {
              // ë””ë²„ê¹…: ì²« ë²ˆì§¸ ìƒí’ˆì˜ ë°ì´í„° êµ¬ì¡° í™•ì¸
              if (index === 0) {
                console.log('[Products Debug] ì²« ë²ˆì§¸ ìƒí’ˆ ë°ì´í„°:', {
                  mainImage: product.mainImage,
                  titleImage: product.titleImage,
                  imageLink: product.imageLink,
                  price: product.price,
                  resultsCount: product.results?.length,
                  firstResult: product.results?.[0]
                });
              }

              // ì´ë¯¸ì§€ ì¶”ì¶œ: titleImage ë°°ì—´ì˜ ì²« ë²ˆì§¸ ë˜ëŠ” imageLink ì‚¬ìš©
              const productImage = product.mainImage ||
                                   (product.titleImage && Array.isArray(product.titleImage) ? product.titleImage[0] : null) ||
                                   product.imageLink ||
                                   (product.results && product.results[0] && product.results[0].imageLink) ||
                                   (product.results && product.results[0] && product.results[0].titleImage && product.results[0].titleImage[0]) ||
                                   '';

              // ê°€ê²© ì¶”ì¶œ: results ë°°ì—´ì˜ ì²« ë²ˆì§¸ í•­ëª©ì—ì„œ ê°€ê²© ì°¾ê¸°
              const productPrice = product.price ||
                                   (product.results && product.results[0] && product.results[0].optionName2Price) ||
                                   (product.results && product.results[0] && product.results[0].price) ||
                                   '';

              const displayPrice = productPrice ? (Array.isArray(productPrice) ? productPrice[0] : productPrice) : '-';

              // ë””ë²„ê¹…: ì²« ë²ˆì§¸ ìƒí’ˆì˜ ìµœì¢… ì´ë¯¸ì§€ì™€ ê°€ê²©
              if (index === 0) {
                console.log('[Products Debug] ìµœì¢…ê°’:', {
                  productImage,
                  productPrice,
                  displayPrice
                });
              }

              return `
              <tr onclick="toggleRowCheckbox(this, '${product.id || index}')" style="cursor: pointer;">
                <td><input type="checkbox" class="checkbox" onclick="event.stopPropagation()" onchange="toggleProduct('${product.id || index}')"></td>
                <td><img src="${productImage}" class="product-image" data-preview="${productImage}" onmouseenter="showImagePreview(event)" onmouseleave="hideImagePreview()" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2214%22%3Eì´ë¯¸ì§€ ì—†ìŒ%3C/text%3E%3C/svg%3E'"></td>
                <td><div class="product-title" title="${product.title || product.titleCn || ''}">${product.title || product.titleCn || 'ì œëª© ì—†ìŒ'}</div></td>
                <td>${product.url ? `<a href="${product.url}" target="_blank" rel="noopener noreferrer" class="source-link" title="${getPlatformName(product.platform)} ì›ë³¸ í˜ì´ì§€ë¡œ ì´ë™" onclick="event.stopPropagation()">ğŸ”— ì›ë³¸ ë§í¬</a>` : `<span style="color: #999;">-</span>`}</td>
                <td>${product.results?.length || 0}ê°œ</td>
                <td style="font-weight: bold; color: #e63946;">Â¥${displayPrice}</td>
                <td><span class="status-badge ${product.isEdited && (product.status || 'collected') === 'collected' ? 'edited' : (product.status || 'collected')}">${getStatusLabel(product.status || 'collected', product.isEdited)}</span></td>
                <td>${product.savedAt ? new Date(product.savedAt).toLocaleDateString() : '-'}</td>
                <td>
                  <div class="actions">
                    <button class="btn btn-sm btn-edit" onclick="event.stopPropagation(); editProduct('${product.id || index}')">í¸ì§‘</button>
                    <button class="btn btn-sm btn-delete" onclick="event.stopPropagation(); deleteProduct('${product.id || index}')">ì‚­ì œ</button>
                  </div>
                </td>
              </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState(message) {
      const container = document.getElementById('productsContainer');
      container.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          <h3>${message}</h3>
        </div>
      `;
    }

    // í”Œë«í¼ ì´ë¦„ ë³€í™˜
    function getPlatformName(platform) {
      const names = {
        '1688-product': '1688',
        'coupang-product': 'ì¿ íŒ¡',
        'aliexpress-product': 'ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤'
      };
      return names[platform] || platform;
    }

    // ê²€ìƒ‰ í•„í„°
    function filterProducts() {
      const query = document.getElementById('searchInput').value.toLowerCase();

      if (!query) {
        renderProducts(allProducts);
        return;
      }

      const filtered = allProducts.filter(p => {
        const title = (p.title || p.titleCn || '').toLowerCase();
        return title.includes(query);
      });

      renderProducts(filtered);
    }

    // ì „ì²´ ì„ íƒ/í•´ì œ
    function toggleSelectAll(checkbox) {
      const collectedProducts = allProducts.filter(p => (p.status || 'collected') === 'collected');
      const checkboxes = document.querySelectorAll('.products-table tbody input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });

      if (checkbox.checked) {
        collectedProducts.forEach((p, i) => selectedProducts.add(p.id || i));
      } else {
        selectedProducts.clear();
      }
      updateActionBar();
    }

    // ê°œë³„ ì„ íƒ
    function toggleProduct(id) {
      if (selectedProducts.has(id)) {
        selectedProducts.delete(id);
      } else {
        selectedProducts.add(id);
      }
      updateActionBar();
    }

    // í–‰ í´ë¦­ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤ í† ê¸€
    function toggleRowCheckbox(row, id) {
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        toggleProduct(id);
      }
    }

    // í”Œë¡œíŒ… ì•¡ì…˜ ì—…ë°ì´íŠ¸
    function updateActionBar() {
      const floatingActions = document.getElementById('floatingActions');
      const countText = document.getElementById('selectedCountText');
      const count = selectedProducts.size;

      if (count > 0) {
        floatingActions.classList.add('active');
        countText.textContent = `${count}ê°œ`;
      } else {
        floatingActions.classList.remove('active');
      }
    }

    // ì„ íƒ í•´ì œ
    function clearSelection() {
      selectedProducts.clear();
      const checkboxes = document.querySelectorAll('.products-table input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateActionBar();
    }

    // ìƒí’ˆ í¸ì§‘
    function editProduct(id) {
      window.location.href = `/editor-options.html?id=${id}`;
    }

    // ìƒí’ˆ ì‚­ì œ
    async function deleteProduct(id) {
      if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const response = await authFetch(`/api/products/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadProducts();
        } else {
          throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì„ íƒ ìƒí’ˆ ì‚­ì œ
    async function deleteSelected() {
      if (selectedProducts.size === 0) {
        showToast('ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      if (!confirm(`ì„ íƒí•œ ${selectedProducts.size}ê°œ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      try {
        const response = await authFetch('/api/products/batch-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });

        if (response.ok) {
          showToast('ì„ íƒí•œ ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          selectedProducts.clear();
          updateActionBar();
          loadProducts();
        } else {
          throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        showToast('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì„ íƒí•œ ìƒí’ˆë“¤ì˜ ì „ì²´ ë°ì´í„° ë¡œë“œ (ê²¬ì ì„œ ìƒì„±ìš©)
    async function loadFullProductData(productIds) {
      try {
        const response = await authFetch('/api/products/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: productIds })
        });
        const data = await response.json();
        if (data.success) {
          return data.products;
        }
        throw new Error(data.message || 'ìƒí’ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
      } catch (error) {
        console.error('ìƒí’ˆ ì „ì²´ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        throw error;
      }
    }

    // ê²¬ì ì„œ ìƒì„± - ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
    async function generateQuote() {
      if (selectedProducts.size === 0) {
        alert('ê²¬ì ì„œë¥¼ ìƒì„±í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // âš ï¸ ì„ íƒí•œ ìƒí’ˆì˜ ì „ì²´ ë°ì´í„° ë¡œë“œ (ëª©ë¡ì€ ê²½ëŸ‰ ë°ì´í„°ë§Œ ìˆìŒ)
      let selectedProductsData;
      try {
        selectedProductsData = await loadFullProductData(Array.from(selectedProducts));
      } catch (error) {
        alert('ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      if (selectedProductsData.length === 0) {
        alert('ê²¬ì ì„œë¥¼ ìƒì„±í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const uneditedProducts = [];
      for (const product of selectedProductsData) {
        // Check if detailPageItems exists and is not empty
        if (!product.detailPageItems || product.detailPageItems.length === 0) {
          const productName = product.title || product.titleCn || 'ìƒí’ˆ';
          uneditedProducts.push(productName);
        }
      }

      // Display error if unedited products found
      if (uneditedProducts.length > 0) {
        alert(`ë‹¤ìŒ ìƒí’ˆë“¤ì´ í¸ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:\n\n${uneditedProducts.map((name, idx) => `${idx + 1}. ${name}`).join('\n')}\n\në¨¼ì € "í¸ì§‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê° ìƒí’ˆì˜ ìƒì„¸í˜ì´ì§€ë¥¼ í¸ì§‘í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.`);
        return;
      }

      // ì „ì²´ ë°ì´í„°ë¥¼ ì„ì‹œ ì €ì¥ (í›„ì† ì‘ì—…ì—ì„œ ì‚¬ìš©)
      window.selectedFullProductsData = selectedProductsData;

      // ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
      openCoupangCategoryModal();
      return;

      // ê¸°ì¡´ ì½”ë“œ (ë¹„í™œì„±í™”)
      /*
      if (selectedProducts.size === 0) {
        alert('ê²¬ì ì„œë¥¼ ìƒì„±í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch('/api/quote/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ê²¬ì ì„œ_${new Date().toISOString().slice(0,10)}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);
        } else {
          throw new Error('ê²¬ì ì„œ ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ê²¬ì ì„œ ìƒì„± ì˜¤ë¥˜:', error);
        alert('ê²¬ì ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      */
    }

    // ì¿ íŒ¡ ì—…ë¡œë“œ ì¤€ë¹„
    async function prepareCoupangUpload() {
      if (selectedProducts.size === 0) {
        alert('ì—…ë¡œë“œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch('/api/coupang/prepare-upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ids: Array.from(selectedProducts) })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ì¿ íŒ¡ì—…ë¡œë“œ_${new Date().toISOString().slice(0,10)}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);

          alert('ì¿ íŒ¡ ì—…ë¡œë“œìš© ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nì¿ íŒ¡ íŒë§¤ì ì„¼í„°ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        } else {
          throw new Error('ì—‘ì…€ ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ì—‘ì…€ ìƒì„± ì˜¤ë¥˜:', error);
        alert('ì—‘ì…€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== ì„¤ì • ê´€ë¦¬ =====

    // TotalBot ì„¤ì •
    let settings = {
      // ì •ë³´ ì„¤ì •
      coupangId: '',
      coupangPassword: '',
      address: '',
      brandName: '',  // ë¸Œëœë“œëª… (ê²¬ì ì„œì— ì‚¬ìš©)
      // ê°€ê²© ì„¤ì •
      exchangeRate: 190,
      packagingCost: 500,
      shipmentCost: 0,
      minMargin: 3000,
      supplyMargins: [
        { amount: 10000, percent: 50 },
        { amount: 50000, percent: 45 },
        { amount: 100000, percent: 40 },
        { amount: 200000, percent: 35 },
        { amount: Infinity, percent: 30 }
      ],
      saleMargins: [
        { amount: 10000, percent: 35 },
        { amount: 50000, percent: 30 },
        { amount: 100000, percent: 25 },
        { amount: 200000, percent: 20 },
        { amount: Infinity, percent: 15 }
      ],
      // í…œí”Œë¦¿ ì„¤ì •
      brandImageUrl: '',
      defaultDetailTemplate: [
        { type: 'brand-image', label: 'ë¸Œëœë“œ ì´ë¯¸ì§€' },
        { type: 'title', label: 'ì œí’ˆëª…' },
        { type: 'option-blocks', label: 'ì˜µì…˜ ë¸”ë¡ë“¤' },
        { type: 'quality-table', label: 'í’ˆì§ˆí‘œì‹œì‚¬í•­' }
      ],
      defaultQualityRows: [
        { label: 'ì œì¡°ì‚¬', value: '' },
        { label: 'ì·¨ê¸‰ì‹œ ì£¼ì˜ì‚¬í•­', value: 'ìƒì„¸í˜ì´ì§€ ì°¸ì¡°' },
        { label: 'ì œì¡° ì—°ì›”', value: '' },
        { label: 'í’ˆì§ˆ ë³´ì¦ê¸°ì¤€', value: 'ê´€ë ¨ë²• ë° ì†Œë¹„ì ë¶„ìŸí•´ê²° ê·œì •ì— ë”°ë¦„' },
        { label: 'A/S ì±…ì„ìì™€ ì „í™”ë²ˆí˜¸', value: '' }
      ],
      // ê²¬ì ì„œ ì‘ì„± ì–‘ì‹ ê¸°ë³¸ê°’ (ì‚¬ìš©ìê°€ ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª©ë§Œ, json_to_excel HEADER_RULES ê¸°ë°˜)
      quotationMappings: [
        { header: 'ìƒ‰ìƒ/ë””ìì¸', type: 'option1', value: '' },
        { header: 'ìƒ‰ìƒ', type: 'option1', value: '' },
        { header: 'ì‚¬ì´ì¦ˆ', type: 'option2', value: '' },
        { header: 'íŒ¨ì…˜ì˜ë¥˜/ì¡í™” ì‚¬ì´ì¦ˆ', type: 'option2', value: '' },
        { header: 'ëª¨ë¸ëª…/í’ˆë²ˆ', type: 'fixed', value: 'ë‹¨ì¼ìƒí’ˆ' },
        { header: 'ê³¼ì„¸ì—¬ë¶€', type: 'fixed', value: 'ê³¼ì„¸' },
        { header: 'ê±°ë˜íƒ€ì…', type: 'fixed', value: 'ê¸°íƒ€ ë„ì†Œë§¤ì—…ì' },
        { header: 'ìˆ˜ì…ì—¬ë¶€', type: 'fixed', value: 'ìˆ˜ì…ìƒí’ˆ' },
        { header: 'ë°•ìŠ¤ ë‚´ SKU ìˆ˜ëŸ‰', type: 'fixed', value: '50' },
        { header: 'ìœ í†µê¸°ê°„ *ì‹í’ˆì˜ ê²½ìš° ì†Œë¹„ê¸°ê°„ (ì¼ìˆ˜ê¸°ì¬)', type: 'fixed', value: '0' },
        { header: 'ìœ í†µê¸°ê°„', type: 'fixed', value: '0' },
        { header: 'ì´ìš©ì¡°ê±´, ì´ìš©ê¸°ê°„', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ìƒí’ˆ ì œê³µ ë°©ì‹', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ìµœì†Œ ì‹œìŠ¤í…œ ì‚¬ì–‘, í•„ìˆ˜ ì†Œí”„íŠ¸ì›¨ì–´', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ì²­ì•½ì² íšŒ ë˜ëŠ” ê³„ì•½ì˜ í•´ì œÂ·í•´ì§€ì— ë”°ë¥¸ íš¨ê³¼', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ì œì¡°êµ­', type: 'fixed', value: 'ì¤‘êµ­ OEM' },
        { header: 'ì œì¡°êµ­(ì›ì‚°ì§€)', type: 'fixed', value: 'ì¤‘êµ­ OEM' },
        { header: 'ì¹˜ìˆ˜', type: 'fixed', value: 'One Size' },
        { header: 'ëƒ„ë¹„/í”„ë¼ì´íŒ¬ ì‚¬ì´ì¦ˆ', type: 'fixed', value: 'Free' },
        { header: 'KCS ì¸ì¦ë²ˆí˜¸', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'KC ì¸ì¦ì •ë³´', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'KC ì¸ì¦ì •ë³´(ìë™ì°¨ê´€ë¦¬ë²•ì— ë”°ë¥¸ ìê¸°ì¸ì¦ ëŒ€ìƒ ìë™ì°¨ë¶€í’ˆì— í•œí•¨)', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ì „ê¸°ìš©í’ˆ ë° ìƒí™œìš©í’ˆ, ì–´ë¦°ì´ (KC) ì¸ì¦ ë§ˆí¬ íƒ€ì…', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ì „ê¸°ìš©í’ˆ ë° ìƒí™œìš©í’ˆ, ì–´ë¦°ì´ (KC) ì¸ì¦ë²ˆí˜¸', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ë°©ì†¡í†µì‹  ê¸°ìì¬ (EMC) ì¸ì¦ ë²ˆí˜¸', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ì•ˆì „ê¸°ì¤€ì í•©í™•ì¸ ì‹ ê³ ë²ˆí˜¸', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ì¸ì¦/í—ˆê°€ ì‚¬í•­', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ì†Œë¹„ììƒë‹´ ê´€ë ¨ ì „í™”ë²ˆí˜¸', type: 'fixed', value: '1577-7011' },
        { header: 'ì†Œë¹„ììƒë‹´ê´€ë ¨ ì „í™”ë²ˆí˜¸', type: 'fixed', value: '1577-7011' },
        { header: 'A/S ì±…ì„ìì™€ ì „í™”ë²ˆí˜¸', type: 'fixed', value: '1577-7011' },
        { header: 'í’ˆì§ˆë³´ì¦ê¸°ì¤€', type: 'fixed', value: 'ë³¸ ì œí’ˆì€ ê³µì •ê±°ë˜ìœ„ì›íšŒ ê³ ì‹œ ë¶„ìŸ í•´ê²°ê¸°ì¤€ì— ì˜ê±° êµí™˜ ë˜ëŠ” ë³´ìƒ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
        { header: 'êµ¬ì„±í’ˆ', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì œí’ˆ êµ¬ì„±', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì œí’ˆêµ¬ì„±', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì¬ê³µê¸‰(ë¦¬í¼ë¸Œ) ê°€êµ¬ì˜ ê²½ìš° ì¬ê³µê¸‰ ì‚¬ìœ  ë° í•˜ì ë¶€ìœ„ì˜ ê´€í•œ ì •ë³´', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ì¬ê³µê¸‰(ë¦¬í¼ë¸Œ) ê°€êµ¬ì˜ ê²½ìš° ì¬ê³µê¸‰ ì‚¬ìœ  ë° í•˜ì ë¶€ìœ„ì— ê´€í•œ ì •ë³´', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ìˆ˜ì…ì‹ ê³  ë¬¸êµ¬ ì—¬ë¶€', type: 'fixed', value: 'ìˆ˜ì…ì‹í’ˆ ì•ˆì „ê´€ë¦¬ íŠ¹ë³„ë²•ì— ë”°ë¥¸ ìˆ˜ì…ì‹ ê³ ë¥¼ í•„í•¨' },
        { header: 'ë‹¨ ìˆ˜', type: 'fixed', value: '3ë‹¨' },
        { header: 'ë™ì¼ëª¨ë¸ ì¶œì‹œë…„ì›”', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ë™ì¼ëª¨ë¸ì˜ ì¶œì‹œë…„ì›”', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì ìš©ì°¨ì¢…', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì œí’ˆì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ìœ„í—˜ ë° ìœ ì˜ì‚¬í•­(ì—°ë£Œì ˆê°ì¥ì¹˜ì— í•œí•¨)', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ê²€ì‚¬í•©ê²©ì¦ ë²ˆí˜¸ (ëŒ€ê¸°í™˜ê²½ë³´ì „ë²•ì— ë”°ë¥¸ ì²¨ê°€ì œÂ·ì´‰ë§¤ì œì— í•œí•¨)', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ' },
        { header: 'ì¢…ë¥˜', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì œí’ˆ ì†Œì¬', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì£¼ìš”ì†Œì¬', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì£¼ìš” ì†Œì¬', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì¬ì§ˆ', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì†Œì¬', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì œí’ˆì˜ ì£¼ì†Œì¬(ìš´ë™í™”ì¸ ê²½ìš°ì—ëŠ” ê²‰ê°,ì•ˆê°ì„ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ)', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì£¼ì–¼ë¦¬ ì‚¬ì´ì¦ˆ', type: 'fixed', value: 'onesize' },
        { header: 'í…Œì´ë¸”ë³´ ì‚¬ì´ì¦ˆ', type: 'fixed', value: 'M' },
        { header: 'ìš©ëŸ‰', type: 'fixed', value: '1L' },
        { header: 'í¬ê¸°', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'í¬ê¸°, ì¤‘ëŸ‰', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'í¬ê¸°,ìš©ëŸ‰,í˜•íƒœ', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'í¬ê¸°âˆ™ì²´ì¤‘ì˜ í•œê³„', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì¤‘ëŸ‰', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì •ê²©ì „ì••, ì†Œë¹„ì „ë ¥', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì—ë„ˆì§€ì†Œë¹„íš¨ìœ¨ë“±ê¸‰', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ë¬¼ì§ˆì•ˆì „ë³´ê±´ìë£Œ (MSDS)', type: 'fixed', value: 'N (í•´ë‹¹ì‚¬í•­ì—†ìŒ)' },
        { header: 'ë°°ì†¡/ì„¤ì¹˜ë¹„ìš©', type: 'fixed', value: 'í•´ë‹¹ì‚¬í•­ì—†ìŒ' },
        { header: 'ì¶”ê°€ì„¤ì¹˜ë¹„ìš©', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ìƒí’ˆë³„ ì„¸ë¶€ ì‚¬ì–‘', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'í–‰ì–´ ì…ê³ ', type: 'fixed', value: 'N' },
        { header: 'ì„¸íƒë°©ë²• ë° ì·¨ê¸‰ì‹œ ì£¼ì˜ì‚¬í•­', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì·¨ê¸‰ì‹œ ì£¼ì˜ì‚¬í•­', type: 'fixed', value: '14ì„¸ ë¯¸ë§Œ ì–´ë¦°ì´ ì‚¬ìš© ê¸ˆì§€' },
        { header: 'ì·¨ê¸‰ë°©ë²• ë° ì·¨ê¸‰ì‹œ ì£¼ì˜ì‚¬í•­, ì•ˆì „í‘œì‹œ', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ì‚¬ìš©ì—°ë ¹ ë˜ëŠ” ê¶Œì¥ì‚¬ìš©ì—°ë ¹', type: 'fixed', value: 'ìƒì„¸í˜ì´ì§€ ì„¤ëª… ì°¸ì¡°' },
        { header: 'ìˆ˜ëŸ‰', type: 'fixed', value: '1ê°œ' },
        { header: 'ê°œë‹¹ ìˆ˜ëŸ‰', type: 'fixed', value: '1ê°œì…' },
        { header: 'ë‚´ì§€ë§¤ìˆ˜', type: 'fixed', value: '1ë§¤' }
      ]
    };

    // ì„¤ì • ë¡œë“œ (ì„œë²„ì—ì„œ ìœ ì €ë³„ë¡œ ê´€ë¦¬)
    // - ëª¨ë“  ì„¤ì •ì„ ì„œë²„ì—ì„œ ìœ ì €ë³„ë¡œ ê´€ë¦¬ (ê³µìœ  ì»´í“¨í„°ì—ì„œë„ ìœ ì €ë³„ ë¶„ë¦¬)
    // - coupangId, passwordëŠ” localStorageì— ë°±ì—… (ë³´ì•ˆìƒ)
    async function loadSettings() {
      // ê¸°ë³¸ê°’ ë°±ì—…
      const defaultQuotationMappings = settings.quotationMappings;
      const defaultQualityRows = settings.defaultQualityRows;
      const defaultDetailTemplate = settings.defaultDetailTemplate;

      // ì„œë²„ì—ì„œ ëª¨ë“  ì„¤ì • ë¡œë“œ (ìœ ì €ë³„ ë¶„ë¦¬)
      try {
        const response = await authFetch('/api/settings');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.settings) {
            const serverSettings = data.settings;

            // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì„¤ì • ë³‘í•©
            if (serverSettings.quotationMappings && serverSettings.quotationMappings.length > 0) {
              window.quotationMappings = serverSettings.quotationMappings;
              settings.quotationMappings = serverSettings.quotationMappings;
              console.log('ğŸ“‹ Loaded quotationMappings from server:', window.quotationMappings.length);
            } else {
              window.quotationMappings = defaultQuotationMappings;
            }

            // í’ˆì§ˆí‘œì‹œì‚¬í•­ ê¸°ë³¸ í–‰ ë¡œë“œ
            if (serverSettings.defaultQualityRows && serverSettings.defaultQualityRows.length > 0) {
              settings.defaultQualityRows = serverSettings.defaultQualityRows;
              console.log('ğŸ“‹ Loaded defaultQualityRows from server:', settings.defaultQualityRows.length);
            }

            // ìƒì„¸í˜ì´ì§€ ê¸°ë³¸ í…œí”Œë¦¿ ë¡œë“œ
            if (serverSettings.defaultDetailTemplate && serverSettings.defaultDetailTemplate.length > 0) {
              settings.defaultDetailTemplate = serverSettings.defaultDetailTemplate;
              console.log('ğŸ“‹ Loaded defaultDetailTemplate from server');
            }

            // ê°€ê²© ì„¤ì • ë¡œë“œ
            if (serverSettings.priceSettings) {
              settings.exchangeRate = serverSettings.priceSettings.exchangeRate || settings.exchangeRate;
              settings.packagingCost = serverSettings.priceSettings.packagingCost || settings.packagingCost;
              settings.shipmentCost = serverSettings.priceSettings.shipmentCost || settings.shipmentCost;
              settings.minMargin = serverSettings.priceSettings.minMargin || settings.minMargin;
              if (serverSettings.priceSettings.supplyMargins) {
                settings.supplyMargins = serverSettings.priceSettings.supplyMargins;
              }
              if (serverSettings.priceSettings.saleMargins) {
                settings.saleMargins = serverSettings.priceSettings.saleMargins;
              }
              console.log('ğŸ“‹ Loaded priceSettings from server');
            }

            // ë¸Œëœë“œ ì´ë¯¸ì§€ URL ë¡œë“œ
            if (serverSettings.brandImageUrl) {
              settings.brandImageUrl = serverSettings.brandImageUrl;
            }

            // ë¸Œëœë“œëª… ë¡œë“œ
            if (serverSettings.brandName) {
              settings.brandName = serverSettings.brandName;
              console.log('ğŸ“‹ Loaded brandName from server:', settings.brandName);
            }

            // ì¿ íŒ¡ ì •ë³´ëŠ” localStorageì—ì„œë§Œ ë¡œë“œ (ë³´ì•ˆìƒ)
            const localCreds = localStorage.getItem('totalbotCredentials');
            if (localCreds) {
              try {
                const creds = JSON.parse(localCreds);
                settings.coupangId = creds.coupangId || '';
                settings.coupangPassword = creds.coupangPassword || '';
                settings.address = creds.address || '';
              } catch (e) {
                console.error('localStorage credentials ë¡œë“œ ì‹¤íŒ¨:', e);
              }
            }

            console.log('âœ… All settings loaded from server');
            return;
          }
        }
      } catch (e) {
        console.warn('ì„œë²„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
      window.quotationMappings = defaultQuotationMappings;
      console.log('ğŸ“‹ Using default settings (server unavailable)');
    }

    // ì„¤ì • ì €ì¥ (ì„œë²„ APIì— ëª¨ë“  ì„¤ì • ì €ì¥)
    async function saveSettingsToStorage() {
      // ì¿ íŒ¡ ì •ë³´ëŠ” localStorageì—ë§Œ ì €ì¥ (ë³´ì•ˆìƒ)
      localStorage.setItem('totalbotCredentials', JSON.stringify({
        coupangId: settings.coupangId || '',
        coupangPassword: settings.coupangPassword || '',
        address: settings.address || ''
      }));

      // defaultQualityRowsë¥¼ qualityTable í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (editor-options.htmlê³¼ ë™ê¸°í™”)
      const qualityTable = {};
      if (settings.defaultQualityRows) {
        settings.defaultQualityRows.forEach(row => {
          switch(row.label) {
            case 'ì œì¡°ì‚¬':
              qualityTable.ì œì¡°ì‚¬ = row.value || '';
              break;
            case 'ì·¨ê¸‰ì‹œ ì£¼ì˜ì‚¬í•­':
              qualityTable.ì·¨ê¸‰ì‹œì£¼ì˜ì‚¬í•­ = row.value || 'ìƒì„¸í˜ì´ì§€ ì°¸ì¡°';
              break;
            case 'ì œì¡° ì—°ì›”':
              qualityTable.ì œì¡°ì—°ì›” = row.value || '';
              break;
            case 'í’ˆì§ˆ ë³´ì¦ê¸°ì¤€':
              qualityTable.í’ˆì§ˆë³´ì¦ê¸°ì¤€ = row.value || 'ê´€ë ¨ë²• ë° ì†Œë¹„ì ë¶„ìŸí•´ê²° ê·œì •ì— ë”°ë¦„';
              break;
            case 'A/S ì±…ì„ìì™€ ì „í™”ë²ˆí˜¸':
              qualityTable.ASì±…ì„ì = row.value || '';
              break;
          }
        });
      }

      // ì„œë²„ì— ëª¨ë“  ì„¤ì • ì €ì¥
      try {
        const serverSettings = {
          quotationMappings: window.quotationMappings || settings.quotationMappings,
          defaultQualityRows: settings.defaultQualityRows,
          qualityTable: qualityTable,
          defaultDetailTemplate: settings.defaultDetailTemplate,
          brandImageUrl: settings.brandImageUrl || '',
          brandName: settings.brandName || '',  // ë¸Œëœë“œëª… ì €ì¥
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            packagingCost: settings.packagingCost,
            shipmentCost: settings.shipmentCost,
            minMargin: settings.minMargin,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins
          }
        };

        const response = await authFetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(serverSettings)
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            console.log('âœ… All settings saved to server API');
          } else {
            console.error('âŒ ì„œë²„ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', data.message);
          }
        }
      } catch (e) {
        console.error('âŒ ì„œë²„ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¡œë“œ
    (async () => {
      await loadSettings();
      // ì„¤ì • ë¡œë“œ ì™„ë£Œ í›„ ê²¬ì ì„œ ë§¤í•‘ ë Œë”ë§
      if (typeof renderQuotationMappings === 'function') {
        renderQuotationMappings();
      }
    })();

    // ===== Chrome Extension í†µì‹  =====

    // Extension ID ì €ì¥ (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê°ì§€)
    let extensionId = localStorage.getItem('totalbotExtensionId') || null;

    // Extension ê°ì§€ ë° ID ì €ì¥
    function detectExtension() {
      // localStorageì—ì„œ Extension ID í™•ì¸
      const savedId = localStorage.getItem('totalbotExtensionId');
      if (savedId && savedId !== 'null') {
        extensionId = savedId;
        console.log('âœ… TotalBot Extension detected:', extensionId);
        return true;
      }

      console.log('âš ï¸ TotalBot Extension not detected');
      return false;
    }

    // CustomEvent ë¦¬ìŠ¤ë„ˆ - content scriptê°€ ì¤€ë¹„ë˜ë©´ ì•Œë¦¼ë°›ìŒ
    window.addEventListener('TotalbotExtensionReady', (event) => {
      if (event.detail && event.detail.extensionId) {
        extensionId = event.detail.extensionId;
        localStorage.setItem('totalbotExtensionId', extensionId);
        console.log('âœ… TotalBot Extension detected (via event):', extensionId);

        // ìë™ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        if (settings.coupangId && settings.coupangPassword) {
          checkCoupangLoginStatus();
        }
      }
    });

    // Extensionìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ (Promise ê¸°ë°˜)
    function sendMessageToExtension(action, payload) {
      return new Promise((resolve, reject) => {
        if (!extensionId) {
          detectExtension();
        }

        if (!extensionId) {
          reject(new Error('Extensionì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nchrome://extensions/ í˜ì´ì§€ì—ì„œ TotalBot Extensionì„ ì„¤ì¹˜í•˜ê³ \ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.'));
          return;
        }

        console.log('ğŸ“® Sending message to extension:', action);

        try {
          // externally_connectableì„ ì‚¬ìš©í•œ ì§ì ‘ í†µì‹ 
          chrome.runtime.sendMessage(extensionId, payload, (response) => {
            if (chrome.runtime.lastError) {
              console.error('âŒ Extension Error:', chrome.runtime.lastError);
              // Extension IDê°€ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚­ì œ
              localStorage.removeItem('totalbotExtensionId');
              extensionId = null;
              reject(new Error('Extension í†µì‹  ì‹¤íŒ¨: ' + chrome.runtime.lastError.message + '\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'));
              return;
            }

            console.log('ğŸ“¬ Received response from extension:', action);
            resolve(response);
          });

          // íƒ€ì„ì•„ì›ƒ (4ë¶„ = 240ì´ˆ) - ì¿ íŒ¡ ê²€ì¦ì´ ìµœëŒ€ 3ë¶„ ê±¸ë¦¬ë¯€ë¡œ ì—¬ìœ ìˆê²Œ ì„¤ì •
          setTimeout(() => {
            reject(new Error('Extension ì‘ë‹µ íƒ€ì„ì•„ì›ƒ (4ë¶„)'));
          }, 240000);

        } catch (error) {
          console.error('âŒ Send message error:', error);
          reject(error);
        }
      });
    }

    // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
    function openSettingsModal() {
      // ì •ë³´ ì„¤ì •
      document.getElementById('settingsCoupangId').value = settings.coupangId || '';
      document.getElementById('settingsCoupangPassword').value = settings.coupangPassword || '';
      document.getElementById('settingsAddress').value = settings.address || '';
      document.getElementById('settingsBrandName').value = settings.brandName || '';

      // ê°€ê²© ì„¤ì •
      document.getElementById('settingsExchangeRate').value = settings.exchangeRate;
      document.getElementById('settingsPackagingCost').value = settings.packagingCost;
      document.getElementById('settingsShipmentCost').value = settings.shipmentCost;
      document.getElementById('settingsMinMargin').value = settings.minMargin;

      renderSupplyMarginRows();
      renderSaleMarginRows();

      // í…œí”Œë¦¿ ì„¤ì •
      if (settings.brandImageUrl) {
        document.getElementById('brandImagePreview').style.display = 'block';
        document.getElementById('brandImagePreviewImg').src = settings.brandImageUrl;
      } else {
        document.getElementById('brandImagePreview').style.display = 'none';
      }
      renderDefaultDetailTemplate();
      renderDefaultQualityRows();
      renderQuotationMappings(); // ê²¬ì ì„œ ì–‘ì‹ ë Œë”ë§

      document.getElementById('settingsModal').classList.add('active');
    }

    // ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    // ì„¤ì • íƒ­ ì „í™˜ (ë§ˆì§„ ì„¤ì •ì˜ ì„œë¸Œ íƒ­)
    function switchSettingsTab(tabName) {
      document.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}-settings-tab`).classList.add('active');
    }

    // ì„¤ì • ë©”ì¸ íƒ­ ì „í™˜
    function switchMainSettingsTab(tabName) {
      document.querySelectorAll('.settings-main-tab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.settings-main-tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}-main-settings-tab`).classList.add('active');
    }

    // ê³µê¸‰ê°€ ë§ˆì§„ í–‰ ë Œë”ë§
    function renderSupplyMarginRows() {
      const container = document.getElementById('supplyMarginRows');
      container.innerHTML = '';

      settings.supplyMargins.forEach((margin, index) => {
        const row = document.createElement('div');
        row.className = 'margin-row';
        row.innerHTML = `
          <div>
            <input type="number"
              value="${margin.amount === Infinity ? '' : margin.amount}"
              placeholder="ê¸ˆì•¡ (ì›)"
              onchange="updateSupplyMargin(${index}, 'amount', this.value)"
              ${margin.amount === Infinity ? 'disabled' : ''}>
            <small style="font-size: 11px; color: #888;">ë¯¸ë§Œ</small>
          </div>
          <div>
            <input type="number"
              value="${margin.percent}"
              placeholder="ë§ˆì§„ (%)"
              onchange="updateSupplyMargin(${index}, 'percent', this.value)">
            <small style="font-size: 11px; color: #888;">%</small>
          </div>
          <button onclick="deleteSupplyMargin(${index})" ${margin.amount === Infinity ? 'disabled' : ''}>ì‚­ì œ</button>
        `;
        container.appendChild(row);
      });
    }

    // íŒë§¤ê°€ ë§ˆì§„ í–‰ ë Œë”ë§
    function renderSaleMarginRows() {
      const container = document.getElementById('saleMarginRows');
      container.innerHTML = '';

      settings.saleMargins.forEach((margin, index) => {
        const row = document.createElement('div');
        row.className = 'margin-row';
        row.innerHTML = `
          <div>
            <input type="number"
              value="${margin.amount === Infinity ? '' : margin.amount}"
              placeholder="ê¸ˆì•¡ (ì›)"
              onchange="updateSaleMargin(${index}, 'amount', this.value)"
              ${margin.amount === Infinity ? 'disabled' : ''}>
            <small style="font-size: 11px; color: #888;">ë¯¸ë§Œ</small>
          </div>
          <div>
            <input type="number"
              value="${margin.percent}"
              placeholder="ë§ˆì§„ (%)"
              onchange="updateSaleMargin(${index}, 'percent', this.value)">
            <small style="font-size: 11px; color: #888;">%</small>
          </div>
          <button onclick="deleteSaleMargin(${index})" ${margin.amount === Infinity ? 'disabled' : ''}>ì‚­ì œ</button>
        `;
        container.appendChild(row);
      });
    }

    // ê³µê¸‰ê°€ ë§ˆì§„ ì—…ë°ì´íŠ¸
    function updateSupplyMargin(index, field, value) {
      if (field === 'amount') {
        settings.supplyMargins[index].amount = value === '' ? Infinity : parseFloat(value);
      } else {
        settings.supplyMargins[index].percent = parseFloat(value);
      }
    }

    // íŒë§¤ê°€ ë§ˆì§„ ì—…ë°ì´íŠ¸
    function updateSaleMargin(index, field, value) {
      if (field === 'amount') {
        settings.saleMargins[index].amount = value === '' ? Infinity : parseFloat(value);
      } else {
        settings.saleMargins[index].percent = parseFloat(value);
      }
    }

    // ê³µê¸‰ê°€ ë§ˆì§„ í–‰ ì¶”ê°€
    function addSupplyMarginRow() {
      settings.supplyMargins.splice(settings.supplyMargins.length - 1, 0, { amount: 0, percent: 30 });
      renderSupplyMarginRows();
    }

    // íŒë§¤ê°€ ë§ˆì§„ í–‰ ì¶”ê°€
    function addSaleMarginRow() {
      settings.saleMargins.splice(settings.saleMargins.length - 1, 0, { amount: 0, percent: 15 });
      renderSaleMarginRows();
    }

    // ê³µê¸‰ê°€ ë§ˆì§„ í–‰ ì‚­ì œ
    function deleteSupplyMargin(index) {
      if (settings.supplyMargins[index].amount !== Infinity) {
        settings.supplyMargins.splice(index, 1);
        renderSupplyMarginRows();
      }
    }

    // íŒë§¤ê°€ ë§ˆì§„ í–‰ ì‚­ì œ
    function deleteSaleMargin(index) {
      if (settings.saleMargins[index].amount !== Infinity) {
        settings.saleMargins.splice(index, 1);
        renderSaleMarginRows();
      }
    }

    // ê³µê¸‰ê°€ ë§ˆì§„ ì •ë ¬
    function sortSupplyMarginRows() {
      const infinityRow = settings.supplyMargins.pop();
      settings.supplyMargins.sort((a, b) => a.amount - b.amount);
      settings.supplyMargins.push(infinityRow);
      renderSupplyMarginRows();
    }

    // íŒë§¤ê°€ ë§ˆì§„ ì •ë ¬
    function sortSaleMarginRows() {
      const infinityRow = settings.saleMargins.pop();
      settings.saleMargins.sort((a, b) => a.amount - b.amount);
      settings.saleMargins.push(infinityRow);
      renderSaleMarginRows();
    }

    // ê³µê¸‰ê°€ ë§ˆì§„ ëª¨ë‘ ì‚­ì œ
    function clearSupplyMarginRows() {
      if (confirm('ëª¨ë“  ê³µê¸‰ê°€ ë§ˆì§„ ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        settings.supplyMargins = [{ amount: Infinity, percent: 30 }];
        renderSupplyMarginRows();
      }
    }

    // íŒë§¤ê°€ ë§ˆì§„ ëª¨ë‘ ì‚­ì œ
    function clearSaleMarginRows() {
      if (confirm('ëª¨ë“  íŒë§¤ê°€ ë§ˆì§„ ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        settings.saleMargins = [{ amount: Infinity, percent: 15 }];
        renderSaleMarginRows();
      }
    }

    // ì„¤ì • ì €ì¥
    async function saveSettings() {
      // ì •ë³´ ì„¤ì • ì €ì¥
      settings.coupangId = document.getElementById('settingsCoupangId').value || '';
      settings.coupangPassword = document.getElementById('settingsCoupangPassword').value || '';
      settings.address = document.getElementById('settingsAddress').value || '';
      settings.brandName = document.getElementById('settingsBrandName').value || '';

      // ê°€ê²© ì„¤ì • ì €ì¥
      settings.exchangeRate = parseFloat(document.getElementById('settingsExchangeRate').value) || 190;
      settings.packagingCost = parseFloat(document.getElementById('settingsPackagingCost').value) || 500;
      settings.shipmentCost = parseFloat(document.getElementById('settingsShipmentCost').value) || 0;
      settings.minMargin = parseFloat(document.getElementById('settingsMinMargin').value) || 3000;

      // ê²¬ì ì„œ ì‘ì„± ì–‘ì‹ ì €ì¥
      settings.quotationMappings = window.quotationMappings || [];

      await saveSettingsToStorage();
      closeSettingsModal();
      alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // í…œí”Œë¦¿ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤

    // ë¸Œëœë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    function handleBrandImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          settings.brandImageUrl = e.target.result;
          document.getElementById('brandImagePreview').style.display = 'block';
          document.getElementById('brandImagePreviewImg').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    // ê¸°ë³¸ ìƒì„¸í˜ì´ì§€ í…œí”Œë¦¿ ë Œë”ë§
    function renderDefaultDetailTemplate() {
      const container = document.getElementById('defaultDetailTemplateContainer');
      container.innerHTML = '';

      settings.defaultDetailTemplate.forEach((item, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 6px;';

        div.innerHTML = `
          <span style="flex: 1; font-size: 14px;">${item.label}</span>
          ${index > 0 ? `<button class="btn btn-sm btn-secondary" onclick="moveTemplateItem(${index}, -1)">â†‘</button>` : ''}
          ${index < settings.defaultDetailTemplate.length - 1 ? `<button class="btn btn-sm btn-secondary" onclick="moveTemplateItem(${index}, 1)">â†“</button>` : ''}
          ${item.type === 'text' ? `<button class="btn btn-sm btn-secondary" onclick="deleteTemplateItem(${index})">ì‚­ì œ</button>` : ''}
        `;
        container.appendChild(div);
      });
    }

    // í…œí”Œë¦¿ í•­ëª© ì´ë™
    function moveTemplateItem(index, direction) {
      const newIndex = index + direction;
      if (newIndex >= 0 && newIndex < settings.defaultDetailTemplate.length) {
        const temp = settings.defaultDetailTemplate[index];
        settings.defaultDetailTemplate[index] = settings.defaultDetailTemplate[newIndex];
        settings.defaultDetailTemplate[newIndex] = temp;
        renderDefaultDetailTemplate();
      }
    }

    // í…œí”Œë¦¿ í…ìŠ¤íŠ¸ ì¶”ê°€
    function addDefaultTemplateText() {
      const text = prompt('ì¶”ê°€í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (text) {
        settings.defaultDetailTemplate.push({ type: 'text', label: text });
        renderDefaultDetailTemplate();
      }
    }

    // í…œí”Œë¦¿ í•­ëª© ì‚­ì œ
    function deleteTemplateItem(index) {
      if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        settings.defaultDetailTemplate.splice(index, 1);
        renderDefaultDetailTemplate();
      }
    }

    // í…œí”Œë¦¿ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
    function resetDefaultTemplate() {
      if (confirm('ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        settings.defaultDetailTemplate = [
          { type: 'brand-image', label: 'ë¸Œëœë“œ ì´ë¯¸ì§€' },
          { type: 'title', label: 'ì œí’ˆëª…' },
          { type: 'option-blocks', label: 'ì˜µì…˜ ë¸”ë¡ë“¤' },
          { type: 'quality-table', label: 'í’ˆì§ˆí‘œì‹œì‚¬í•­' }
        ];
        renderDefaultDetailTemplate();
      }
    }

    // í’ˆì§ˆí‘œì‹œì‚¬í•­ ê¸°ë³¸ í–‰ ë Œë”ë§
    function renderDefaultQualityRows() {
      const container = document.getElementById('defaultQualityRowsContainer');
      container.innerHTML = '';

      settings.defaultQualityRows.forEach((row, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';

        div.innerHTML = `
          <input type="text" value="${row.label}"
            onchange="updateDefaultQualityRow(${index}, 'label', this.value)"
            placeholder="í•­ëª©ëª…" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="text" value="${row.value}"
            onchange="updateDefaultQualityRow(${index}, 'value', this.value)"
            placeholder="ê¸°ë³¸ê°’" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <button class="btn btn-sm btn-secondary" onclick="deleteDefaultQualityRow(${index})">ì‚­ì œ</button>
        `;
        container.appendChild(div);
      });
    }

    // í’ˆì§ˆí‘œì‹œì‚¬í•­ í–‰ ì—…ë°ì´íŠ¸
    function updateDefaultQualityRow(index, field, value) {
      settings.defaultQualityRows[index][field] = value;
    }

    // í’ˆì§ˆí‘œì‹œì‚¬í•­ í–‰ ì¶”ê°€
    function addDefaultQualityRow() {
      settings.defaultQualityRows.push({ label: '', value: '' });
      renderDefaultQualityRows();
    }

    // í’ˆì§ˆí‘œì‹œì‚¬í•­ í–‰ ì‚­ì œ
    function deleteDefaultQualityRow(index) {
      settings.defaultQualityRows.splice(index, 1);
      renderDefaultQualityRows();
    }

    // ===== ì¿ íŒ¡ ì—…ë¡œë“œ ê´€ë ¨ =====

    // ì¿ íŒ¡ ì—…ë¡œë“œ ì¤€ë¹„
    async function prepareCoupangUpload() {
      try {
        console.log('ğŸš€ Preparing Coupang upload...');

        // ì„ íƒëœ ìƒí’ˆ í™•ì¸
        if (selectedProducts.size === 0) {
          alert('ì—…ë¡œë“œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        // ì„¤ì • í™•ì¸
        if (!settings.coupangId || !settings.coupangPassword) {
          alert('ì„¤ì •ì—ì„œ ì¿ íŒ¡ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          openSettingsModal();
          return;
        }

        // ì„ íƒëœ ìƒí’ˆ ë°ì´í„° ìˆ˜ì§‘ - ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        console.log('ğŸ“¦ Fetching fresh product data from server...');
        const selectedProductData = [];

        for (const productId of selectedProducts) {
          try {
            const response = await authFetch(`/api/products/${productId}`);

            if (response.ok) {
              const data = await response.json();
              const product = data.product || data;
              selectedProductData.push(product);

              // ë””ë²„ê¹…: ìƒí’ˆ ë°ì´í„° í™•ì¸
              console.log(`   âœ… Loaded product ${productId}:`);
              console.log(`      - title: ${(product.title || product.titleCn || '').substring(0, 30)}`);
              console.log(`      - has detailHtml: ${!!product.detailHtml}`);
              console.log(`      - detailHtml length: ${product.detailHtml ? product.detailHtml.length : 0}`);
              console.log(`      - results count: ${product.results?.length || 0}`);
              console.log(`      - images count: ${product.images?.length || 0}`);
            } else {
              console.error(`   âŒ Failed to load product ${productId}`);
              // Fallback to stale data
              const fallback = allProducts.find(p => p.id === productId);
              if (fallback) selectedProductData.push(fallback);
            }
          } catch (error) {
            console.error(`   âŒ Error loading product ${productId}:`, error);
            // Fallback to stale data
            const fallback = allProducts.find(p => p.id === productId);
            if (fallback) selectedProductData.push(fallback);
          }
        }

        console.log('ğŸ“¦ Selected products:', selectedProductData.length);

        // Extensionìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (window.postMessage ì‚¬ìš©)
        console.log('ğŸ“¤ Sending data to Chrome Extension...');
        const response = await sendMessageToExtension('uploadToCoupang', {
          action: 'uploadToCoupang',
          data: {
            products: selectedProductData,
            settings: {
              coupangId: settings.coupangId,
              coupangPassword: settings.coupangPassword,
              address: settings.address
            }
          }
        });

        console.log('âœ… Extension response:', response);
        if (response && response.success) {
          alert('ì¿ íŒ¡ ì—…ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆ íƒ­ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.');
        } else {
          alert('ì—…ë¡œë“œ ì‹œì‘ ì‹¤íŒ¨:\n' + (response?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }

      } catch (error) {
        console.error('âŒ Coupang upload error:', error);
        alert('ì¿ íŒ¡ ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
      }
    }

    // ì¿ íŒ¡ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì‹œë„
    async function checkCoupangLogin() {
      try {
        console.log('ğŸ” Checking Coupang login status...');

        // ì„¤ì • í™•ì¸
        if (!settings.coupangId || !settings.coupangPassword) {
          alert('ì„¤ì •ì—ì„œ ì¿ íŒ¡ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
          openSettingsModal();
          return;
        }

        // ë¡œê·¸ì¸ ì‹œë„ ì¤‘ í‘œì‹œ
        const loginIcon = document.getElementById('coupangLoginIcon');
        const loginBtn = document.getElementById('coupangLoginStatus');
        loginIcon.textContent = 'â³';
        loginBtn.disabled = true;

        // Extensionìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„ ìš”ì²­ (window.postMessage ì‚¬ìš©)
        console.log('ğŸ“¤ Requesting Coupang login...');
        sendMessageToExtension('checkCoupangLogin', {
          action: 'checkCoupangLogin',
          credentials: {
            coupangId: settings.coupangId,
            coupangPassword: settings.coupangPassword
          }
        }).then((response) => {
          loginBtn.disabled = false;

          console.log('âœ… Login check response:', response);
          if (response && response.success) {
            loginIcon.textContent = 'âœ…';
            alert('ì¿ íŒ¡ ë¡œê·¸ì¸ ì„±ê³µ!');
          } else {
            loginIcon.textContent = 'âŒ';
            alert('ì¿ íŒ¡ ë¡œê·¸ì¸ ì‹¤íŒ¨:\n' + (response?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        }).catch((error) => {
          loginBtn.disabled = false;
          loginIcon.textContent = 'âŒ';
          console.error('âŒ Extension Error:', error);
          alert('í™•ì¥ í”„ë¡œê·¸ë¨ ì˜¤ë¥˜:\n' + error.message);
        });

      } catch (error) {
        console.error('âŒ Login check error:', error);
        document.getElementById('coupangLoginIcon').textContent = 'âŒ';
        document.getElementById('coupangLoginStatus').disabled = false;
        alert('ë¡œê·¸ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜:\n' + error.message);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ Extension ì—°ê²° í™•ì¸ ë° ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    window.addEventListener('load', () => {
      console.log('âœ… TotalBot page loaded');

      // Extension ê°ì§€ (content scriptê°€ ì£¼ì…í•˜ëŠ” ID)
      setTimeout(() => {
        detectExtension();

        // ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ë°±ê·¸ë¼ìš´ë“œ)
        if (extensionId && settings.coupangId && settings.coupangPassword) {
          checkCoupangLoginStatus();
        }
      }, 500);
    });

    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¡œê·¸ì¸ ìƒíƒœë§Œ í™•ì¸ (ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì—†ì´)
    async function checkCoupangLoginStatus() {
      try {
        const response = await sendMessageToExtension('getCoupangLoginStatus', {
          action: 'getCoupangLoginStatus'
        });

        if (response && response.loggedIn) {
          document.getElementById('coupangLoginIcon').textContent = 'âœ…';
          console.log('âœ… Already logged in to Coupang');
        }
      } catch (error) {
        console.log('âš ï¸ Could not check login status:', error.message);
      }
    }

    // ë‹¤ìš´ë¡œë“œ ê²½ë¡œ ì´ˆê¸°í™”
    async function resetDownloadPath() {
      if (!confirm('ì €ì¥ ìœ„ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ìŒ ë‹¤ìš´ë¡œë“œ ì‹œ ì €ì¥ ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
        return;
      }

      try {
        // Extension storageì—ì„œ downloadPath ì‚­ì œ
        await sendMessageToExtension('resetDownloadPath', {
          action: 'resetDownloadPath'
        });

        alert('ì €ì¥ ìœ„ì¹˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ìŒ ë‹¤ìš´ë¡œë“œ ì‹œ ì €ì¥ ìœ„ì¹˜ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ì €ì¥ ìœ„ì¹˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ìœ„ì¹˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n' + error.message);
      }
    }
    // ============================================
    // ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ ê´€ë ¨ ì½”ë“œ
    // ============================================

    // ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ìƒíƒœ ê´€ë¦¬
    let coupangCategoryState = {
      keyword: '',
      results: [],
      selectedIds: new Set(),
      loading: false
    };

    // ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
    function openCoupangCategoryModal() {
      document.getElementById('coupangCategoryModal').style.display = 'flex';
      document.getElementById('coupangSearchInput').focus();
    }

    // ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ ë‹«ê¸°
    function closeCoupangCategoryModal() {
      document.getElementById('coupangCategoryModal').style.display = 'none';
      // ìƒíƒœ ì´ˆê¸°í™”
      coupangCategoryState = {
        keyword: '',
        results: [],
        selectedIds: new Set(),
        loading: false
      };
      document.getElementById('coupangSearchInput').value = '';
      showCoupangEmptyState();
    }

    // ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤ ì ìš©)
    let coupangSearchTimeout;
    function handleCoupangSearch(e) {
      clearTimeout(coupangSearchTimeout);
      const keyword = e.target.value.trim();

      if (keyword.length === 0) {
        showCoupangEmptyState();
        return;
      }

      coupangSearchTimeout = setTimeout(() => searchCoupangCategories(keyword), 500);
    }

    // ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ API í˜¸ì¶œ (Extension ì‚¬ìš©)
    async function searchCoupangCategories(keyword) {
      coupangCategoryState.loading = true;
      showCoupangStatus('loading', 'ê²€ìƒ‰ ì¤‘...');

      try {
        // Extensionì„ í†µí•´ ì¿ íŒ¡ API í˜¸ì¶œ
        const response = await sendMessageToExtension('searchCategories', {
          action: 'searchCategories',
          keyword: keyword
        });

        console.log('ğŸ” Search response:', response);

        if (!response.success) {
          throw new Error(response.error || 'ê²€ìƒ‰ ì‹¤íŒ¨');
        }

        // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ ê²°ê³¼ë¡œ êµì²´ (ëˆ„ì í•˜ì§€ ì•ŠìŒ)
        const newCategories = response.categories || [];
        coupangCategoryState.results = newCategories;
        coupangCategoryState.keyword = keyword;
        // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì¤‘ ìƒˆ ê²°ê³¼ì— ì—†ëŠ” ê²ƒì€ ìœ ì§€ (ì´ì „ì— ì„ íƒí•œ ê²ƒ ë³´ì¡´)

        if (newCategories.length === 0) {
          showCoupangStatus('error', 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
          showCoupangEmptyState();
        } else {
          hideCoupangStatus();
          renderCoupangResults();
          showCoupangStatus('success', `âœ… ${newCategories.length}ê°œ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ë¨`);
          setTimeout(hideCoupangStatus, 3000);
        }
      } catch (error) {
        console.error('ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        showCoupangStatus('error', `ì˜¤ë¥˜: ${error.message}`);
        showCoupangEmptyState();
      } finally {
        coupangCategoryState.loading = false;
      }
    }

    // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
    function renderCoupangResults() {
      const resultsDiv = document.getElementById('coupangResults');
      resultsDiv.innerHTML = coupangCategoryState.results.map(cat => `
        <div
          class="coupang-category-item ${coupangCategoryState.selectedIds.has(cat.id) ? 'selected' : ''}"
          onclick="toggleCoupangCategory('${cat.id}')"
        >
          <input
            type="checkbox"
            class="coupang-category-checkbox"
            ${coupangCategoryState.selectedIds.has(cat.id) ? 'checked' : ''}
            onchange="event.stopPropagation(); toggleCoupangCategory('${cat.id}')"
          >
          <div class="coupang-category-content">
            <div class="coupang-category-name">${cat.name}</div>
            <div class="coupang-category-path">${cat.path}</div>
          </div>
        </div>
      `).join('');

      updateCoupangDownloadButton();
    }

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ/í•´ì œ
    function toggleCoupangCategory(categoryId) {
      if (coupangCategoryState.selectedIds.has(categoryId)) {
        coupangCategoryState.selectedIds.delete(categoryId);
      } else {
        coupangCategoryState.selectedIds.add(categoryId);
      }
      renderCoupangResults();
    }

    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateCoupangDownloadButton() {
      const count = coupangCategoryState.selectedIds.size;
      const downloadBtn = document.getElementById('coupangDownloadBtn');
      const btnText = document.getElementById('coupangBtnText');

      downloadBtn.disabled = count === 0;
      btnText.textContent = count > 0
        ? `ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ (${count}ê°œ ì„ íƒë¨)`
        : 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”';
    }

    // ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ
    async function downloadCoupangQuotation() {
      if (coupangCategoryState.selectedIds.size === 0) return;

      const downloadBtn = document.getElementById('coupangDownloadBtn');
      const btnText = document.getElementById('coupangBtnText');

      downloadBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> ë‹¤ìš´ë¡œë“œ ì¤‘...';

      try {
        // Extensionì„ í†µí•´ ì¿ íŒ¡ API í˜¸ì¶œ
        const response = await sendMessageToExtension('downloadQuotation', {
          action: 'downloadQuotation',
          categoryIds: Array.from(coupangCategoryState.selectedIds),
          categories: coupangCategoryState.results.filter(c =>
            coupangCategoryState.selectedIds.has(c.id)
          )
        });

        if (!response.success) {
          throw new Error(response.error || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
        }

        console.log('âœ… Download response:', response);

        // ì—‘ì…€ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        if (response.excelData && response.excelData.length > 0) {
          console.log('ğŸ“Š Excel data received:', response.excelData);

          btnText.textContent = 'âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!';

          // ì ì‹œ í›„ ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
          setTimeout(() => {
            closeCoupangCategoryModal();
            showDetailCategoryModal(response.excelData);
          }, 1000);
        } else {
          // ì—‘ì…€ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ì²˜ë¦¬
          const message = response.message || 'ê²¬ì ì„œ ZIP íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.';
          const filename = response.filename || 'ì¿ íŒ¡_ê²¬ì ì„œ.zip';

          console.log('ğŸ“¥ Downloaded file:', filename);
          console.log('ğŸ’¬ Message:', message);

          showCoupangStatus('success', 'âœ… ' + message);
          setTimeout(hideCoupangStatus, 5000);

          btnText.textContent = 'âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!';
          setTimeout(() => {
            closeCoupangCategoryModal();
          }, 2000);
        }

      } catch (error) {
        console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
        showCoupangStatus('error', `ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        btnText.textContent = 'ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ';
        downloadBtn.disabled = false;
      }
    }

    // ìƒíƒœ í‘œì‹œ
    function showCoupangStatus(type, message) {
      const statusDiv = document.getElementById('coupangStatus');
      statusDiv.className = `coupang-status ${type}`;
      statusDiv.textContent = message;
    }

    function hideCoupangStatus() {
      document.getElementById('coupangStatus').className = 'coupang-status';
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showCoupangEmptyState() {
      document.getElementById('coupangResults').innerHTML = `
        <div class="coupang-empty-state">
          <p style="font-size: 48px;">ğŸ“¦</p>
          <h3>ì¹´í…Œê³ ë¦¬ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
          <p>ìƒë‹¨ ê²€ìƒ‰ì°½ì— ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        </div>
      `;
    }

  </script>

  <!-- ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ëª¨ë‹¬ -->
  <div id="coupangCategoryModal">
    <div class="coupang-modal-content">
      <div class="coupang-modal-header">
        <h2>ğŸª ì¿ íŒ¡ ì¹´í…Œê³ ë¦¬ ê²¬ì ì„œ</h2>
        <button class="coupang-modal-close" onclick="closeCoupangCategoryModal()">Ã—</button>
      </div>

      <div class="coupang-modal-body">
        <div class="coupang-search-box">
          <input
            type="text"
            id="coupangSearchInput"
            class="coupang-search-input"
            placeholder="ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: íŒ¨ì…˜ì˜ë¥˜, ì‹í’ˆ, ë·°í‹°...)"
            oninput="handleCoupangSearch(event)"
          >
        </div>

        <div id="coupangStatus" class="coupang-status"></div>

        <div id="coupangResults" class="coupang-category-list">
          <div class="coupang-empty-state">
            <p style="font-size: 48px;">ğŸ“¦</p>
            <h3>ì¹´í…Œê³ ë¦¬ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
            <p>ìƒë‹¨ ê²€ìƒ‰ì°½ì— ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
          </div>
        </div>
      </div>

      <div class="coupang-modal-footer">
        <button id="coupangDownloadBtn" class="coupang-download-btn" onclick="downloadCoupangQuotation()" disabled>
          <span id="coupangBtnText">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„¤ì • ëª¨ë‹¬ -->
  <div id="detailCategoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="coupang-modal-header">
        <h2>ğŸ“ ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„¤ì •</h2>
        <button class="coupang-modal-close" onclick="closeDetailCategoryModal()">Ã—</button>
      </div>

      <div class="coupang-modal-body">
        <!-- Step 1: ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
        <div id="categorySelectionStep">
          <p style="margin-bottom: 20px; color: #666;">ê° ì—‘ì…€ íŒŒì¼ì˜ ìƒì„¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
          <div id="detailCategoryList"></div>
        </div>

        <!-- Step 2: ì¶”ê°€ ì •ë³´ ì…ë ¥ -->
        <div id="additionalInfoStep" style="display: none;">
          <p style="margin-bottom: 20px; color: #666;">ìƒí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

          <!-- ê²€ìƒ‰íƒœê·¸ -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              ğŸ·ï¸ ê²€ìƒ‰íƒœê·¸
            </label>
            <input
              type="text"
              id="searchTagInput"
              placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              onkeypress="handleTagInput(event)"
            >
            <div id="tagList" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
          </div>

          <!-- ì‚¬ì´ì¦ˆ -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              ğŸ“ ì‚¬ì´ì¦ˆ (ê°€ë¡œ x ì„¸ë¡œ x ë†’ì´)
            </label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input
                type="number"
                id="sizeWidth"
                placeholder="ê°€ë¡œ"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              >
              <span style="color: #999; font-weight: bold;">Ã—</span>
              <input
                type="number"
                id="sizeHeight"
                placeholder="ì„¸ë¡œ"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              >
              <span style="color: #999; font-weight: bold;">Ã—</span>
              <input
                type="number"
                id="sizeDepth"
                placeholder="ë†’ì´"
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              >
            </div>
          </div>

          <!-- ë¬´ê²Œ -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              âš–ï¸ ë¬´ê²Œ (g)
              <span
                style="display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; background: #ddd; color: #666; font-size: 12px; cursor: help; margin-left: 5px;"
                title="1kg = 1000g"
              >?</span>
            </label>
            <input
              type="number"
              id="weightInput"
              placeholder="ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 500)"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
            >
          </div>

          <!-- ì·¨ê¸‰ì£¼ì˜ ì‚¬ìœ  -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              âš ï¸ ì·¨ê¸‰ì£¼ì˜ ì‚¬ìœ 
            </label>
            <select
              id="handlingCareInput"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;"
            >
              <option value="í•´ë‹¹ì‚¬í•­ì—†ìŒ">í•´ë‹¹ì‚¬í•­ì—†ìŒ</option>
              <option value="ìœ ë¦¬">ìœ ë¦¬</option>
            </select>
          </div>

          <!-- ê³„ì ˆ -->
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: bold; margin-bottom: 8px;">
              ğŸŒ¸ ê³„ì ˆ
            </label>
            <select
              id="seasonInput"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;"
            >
              <option value="ì‚¬ê³„ì ˆ">ì‚¬ê³„ì ˆ</option>
              <option value="ë´„">ë´„</option>
              <option value="ì—¬ë¦„">ì—¬ë¦„</option>
              <option value="ê°€ì„">ê°€ì„</option>
              <option value="ê²¨ìš¸">ê²¨ìš¸</option>
            </select>
          </div>
        </div>
      </div>

      <div class="coupang-modal-footer" style="flex-direction: column; gap: 12px;">
        <button id="categoryNextBtn" class="coupang-download-btn" onclick="goToAdditionalInfo()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          ë‹¤ìŒ ë‹¨ê³„ë¡œ
        </button>
        <div id="categoryFinalBtns" style="display: none; width: 100%;">
          <button class="coupang-download-btn" onclick="saveAllData()" style="background: linear-gradient(135deg, #00c73c 0%, #00a030 100%); margin-bottom: 10px;">
            âœ… ì™„ë£Œ (ìë™ ì—…ë¡œë“œ)
          </button>
          <button class="coupang-download-btn" onclick="saveAllDataDownloadOnly()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); font-size: 13px; padding: 10px;">
            ğŸ“¥ íŒŒì¼ë§Œ ë‹¤ìš´ë°›ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- í•„ìˆ˜ ì¹¸ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="requiredFieldsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <div class="coupang-modal-header">
        <h2>âš ï¸ í•„ìˆ˜ ì¹¸ ì…ë ¥</h2>
        <button class="coupang-modal-close" onclick="closeRequiredFieldsModal()">Ã—</button>
      </div>

      <div class="coupang-modal-body">
        <p style="margin-bottom: 20px; color: #666;">
          ê²¬ì ì„œì— ì…ë ¥ì´ í•„ìš”í•œ í•„ìˆ˜ ì¹¸ì´ ìˆìŠµë‹ˆë‹¤.<br>
          ê° í•­ëª©ì˜ ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì—¬ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>
        <div id="requiredFieldsList"></div>
      </div>

      <div class="coupang-modal-footer">
        <button class="coupang-download-btn" onclick="applyRequiredFields()" style="background: #00c73c;">
          ì ìš© ë° ê³„ì†
        </button>
        <button class="coupang-download-btn" onclick="closeRequiredFieldsModal()" style="background: #666;">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- ë‹¤ìš´ë¡œë“œ ì§„í–‰ ëª¨ë‹¬ -->
  <div id="downloadProgressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10002; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 40px 50px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div class="download-spinner" style="width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <h3 style="margin: 0 0 10px; color: #333; font-size: 20px;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...</h3>
      <p id="downloadProgressText" style="margin: 0; color: #666; font-size: 14px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- ê²¬ì ì„œ ID ì…ë ¥ ëª¨ë‹¬ -->
  <div id="quoteIdInputModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10002; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px; border-radius: 16px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px 30px; color: white;">
        <h2 style="margin: 0; font-size: 22px; font-weight: 600;">
          ğŸ“‹ ê²¬ì ì„œ ID ì…ë ¥
        </h2>
        <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">
          íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
        </p>
      </div>

      <div style="padding: 30px;">
        <p style="margin: 0 0 20px; color: #555; font-size: 14px; line-height: 1.6;">
          ì¿ íŒ¡ ìœ™ì—ì„œ ê²¬ì ì„œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•œ í›„,<br>
          ë°œê¸‰ë°›ì€ <strong>ê²¬ì ì„œ ID</strong>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">
            ê²¬ì ì„œ ID (ìˆ«ì)
          </label>
          <input
            type="text"
            id="manualQuoteIdInput"
            placeholder="ì˜ˆ: 12345678"
            style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s;"
            onfocus="this.style.borderColor='#667eea'"
            onblur="this.style.borderColor='#e0e0e0'"
          >
        </div>

        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button
            onclick="saveManualQuoteId()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #00c73c 0%, #00a030 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;"
            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 15px rgba(0,199,60,0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
          >
            âœ… ì§€ê¸ˆ ì…ë ¥í•˜ê¸°
          </button>
          <button
            onclick="closeQuoteIdModal()"
            style="width: 100%; padding: 14px; background: #f5f5f5; color: #666; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background 0.2s;"
            onmouseover="this.style.background='#ebebeb'"
            onmouseout="this.style.background='#f5f5f5'"
          >
            ë‚˜ì¤‘ì— ì…ë ¥í•˜ê¸°
          </button>
        </div>

        <p style="margin: 20px 0 0; color: #999; font-size: 12px; text-align: center;">
          ğŸ’¡ ë‚˜ì¤‘ì— ìƒí’ˆ ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </p>
      </div>
    </div>
  </div>

  <script>
    // ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„¤ì • ìƒíƒœ
    let detailCategoryState = {
      excelData: [],
      selections: {},
      tags: [],
      size: { width: '', height: '', depth: '' },
      weight: ''
    };

    // ìƒì„¸ ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬ ì—´ê¸° (ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡)
    window.showDetailCategoryModal = function(excelData) {
      console.log('ğŸ“‹ Opening detail category modal with data:', excelData);

      detailCategoryState.excelData = excelData;
      detailCategoryState.selections = {};

      // ëª¨ë‹¬ í‘œì‹œ
      const modal = document.getElementById('detailCategoryModal');
      modal.style.display = 'flex';

      // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
      const listDiv = document.getElementById('detailCategoryList');
      listDiv.innerHTML = '';

      excelData.forEach((item, index) => {
        const categoryName = item.category ? item.category.name : 'ì¹´í…Œê³ ë¦¬ëª… ì—†ìŒ';
        const dropdownOptions = item.dropdownOptions || [];

        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'padding: 20px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px;';

        itemDiv.innerHTML = `
          <div style="margin-bottom: 10px;">
            <strong style="font-size: 16px;">ğŸ“„ ${categoryName}</strong>
            <span style="margin-left: 10px; color: #666; font-size: 14px;">(${dropdownOptions.length}ê°œ ì˜µì…˜)</span>
          </div>
          <select
            id="detailCategory_${index}"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
            onchange="updateDetailSelection(${index}, this.value)"
          >
            <option value="">ìƒì„¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            ${dropdownOptions.map((opt, optIndex) => `
              <option value="${optIndex}">${opt}</option>
            `).join('')}
          </select>
        `;

        listDiv.appendChild(itemDiv);
      });
    }

    // ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì—…ë°ì´íŠ¸
    window.updateDetailSelection = function(index, selectedIndex) {
      if (selectedIndex === '') {
        delete detailCategoryState.selections[index];
      } else {
        const selectedOption = detailCategoryState.excelData[index].dropdownOptions[parseInt(selectedIndex)];
        detailCategoryState.selections[index] = {
          optionIndex: parseInt(selectedIndex),
          optionValue: selectedOption
        };
      }

      console.log('âœ… Selection updated:', detailCategoryState.selections);
    }

    // ìƒì„¸ ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    window.closeDetailCategoryModal = function() {
      document.getElementById('detailCategoryModal').style.display = 'none';

      // ìƒíƒœ ì´ˆê¸°í™”
      detailCategoryState = {
        excelData: [],
        selections: {},
        tags: [],
        size: { width: '', height: '', depth: '' },
        weight: ''
      };

      // UI ì´ˆê¸°í™”
      document.getElementById('categorySelectionStep').style.display = 'block';
      document.getElementById('additionalInfoStep').style.display = 'none';
      document.getElementById('categoryNextBtn').style.display = 'block';
      document.getElementById('categoryFinalBtns').style.display = 'none';
      document.getElementById('searchTagInput').value = '';
      document.getElementById('sizeWidth').value = '';
      document.getElementById('sizeHeight').value = '';
      document.getElementById('sizeDepth').value = '';
      document.getElementById('weightInput').value = '';
      renderTags();
    }

    // ì¶”ê°€ ì •ë³´ ì…ë ¥ ë‹¨ê³„ë¡œ ì´ë™
    window.goToAdditionalInfo = function() {
      const totalCount = detailCategoryState.excelData.length;
      const selectedCount = Object.keys(detailCategoryState.selections).length;

      if (selectedCount < totalCount) {
        alert(`ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n(ì„ íƒ: ${selectedCount}/${totalCount})`);
        return;
      }

      console.log('âœ… All categories selected:', detailCategoryState.selections);

      // Step ì „í™˜
      document.getElementById('categorySelectionStep').style.display = 'none';
      document.getElementById('additionalInfoStep').style.display = 'block';
      document.getElementById('categoryNextBtn').style.display = 'none';
      document.getElementById('categoryFinalBtns').style.display = 'block';
    }

    // íƒœê·¸ ì…ë ¥ ì²˜ë¦¬
    window.handleTagInput = function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('searchTagInput');
        const tag = input.value.trim();

        if (tag && !detailCategoryState.tags.includes(tag)) {
          detailCategoryState.tags.push(tag);
          renderTags();
          input.value = '';
        }
      }
    }

    // íƒœê·¸ ë Œë”ë§
    window.renderTags = function() {
      const tagList = document.getElementById('tagList');
      tagList.innerHTML = detailCategoryState.tags.map((tag, index) => `
        <div style="display: inline-flex; align-items: center; background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 16px; font-size: 14px;">
          #${tag}
          <button
            onclick="removeTag(${index})"
            style="margin-left: 8px; background: none; border: none; color: #1976d2; cursor: pointer; font-size: 16px; padding: 0; width: 20px; height: 20px;"
          >Ã—</button>
        </div>
      `).join('');
    }

    // íƒœê·¸ ì œê±°
    window.removeTag = function(index) {
      detailCategoryState.tags.splice(index, 1);
      renderTags();
    }

    // ëª¨ë“  ë°ì´í„° ì €ì¥
    window.saveAllData = function() {
      // ì‚¬ì´ì¦ˆ ìˆ˜ì§‘
      detailCategoryState.size = {
        width: document.getElementById('sizeWidth').value,
        height: document.getElementById('sizeHeight').value,
        depth: document.getElementById('sizeDepth').value
      };

      // ë¬´ê²Œ ìˆ˜ì§‘
      detailCategoryState.weight = document.getElementById('weightInput').value;

      // ì·¨ê¸‰ì£¼ì˜ ì‚¬ìœ  ìˆ˜ì§‘
      detailCategoryState.handlingCare = document.getElementById('handlingCareInput').value;

      // ê³„ì ˆ ìˆ˜ì§‘
      detailCategoryState.season = document.getElementById('seasonInput').value;

      // ìœ íš¨ì„± ê²€ì‚¬ (ê²€ìƒ‰íƒœê·¸ëŠ” ì„ íƒì‚¬í•­)
      if (!detailCategoryState.size.width || !detailCategoryState.size.height || !detailCategoryState.size.depth) {
        alert('ì‚¬ì´ì¦ˆë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!detailCategoryState.weight) {
        alert('ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      console.log('âœ… All data collected:', detailCategoryState);

      // ì§„í–‰ ìƒí™© ëª¨ë‹¬ í‘œì‹œ
      showProgressModal();

      // ì²« ë²ˆì§¸ ë‹¨ê³„ ì‹œì‘
      updateProgressStep('prepare', 'in_progress');

      // ê²¬ì ì„œ ìë™ ì‘ì„± ì‹œì‘
      fillQuotationExcels();
    }

    // ë‹¤ìš´ë¡œë“œ í›„ ê²¬ì ì„œ ID ì…ë ¥ìš© ìƒí’ˆ ë°ì´í„° ì €ì¥
    let pendingDownloadProducts = [];

    // ë‹¤ìš´ë¡œë“œ ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
    function showDownloadProgressModal(text) {
      document.getElementById('downloadProgressText').textContent = text || 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
      document.getElementById('downloadProgressModal').style.display = 'flex';
    }

    function hideDownloadProgressModal() {
      document.getElementById('downloadProgressModal').style.display = 'none';
    }

    // ê²¬ì ì„œ ID ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
    function showQuoteIdModal() {
      document.getElementById('manualQuoteIdInput').value = '';
      document.getElementById('quoteIdInputModal').style.display = 'flex';
    }

    window.closeQuoteIdModal = async function() {
      // ë‚˜ì¤‘ì— ì…ë ¥í•˜ê¸°: ìƒí’ˆ ìƒíƒœë¥¼ 'manual_pending'ìœ¼ë¡œ ë³€ê²½
      if (pendingDownloadProducts.length > 0) {
        try {
          const productIds = pendingDownloadProducts.map(p => p.id).filter(id => id);

          if (productIds.length > 0) {
            // ìƒíƒœë¥¼ 'manual_pending'ìœ¼ë¡œ ë³€ê²½ (ìˆ˜ë™ ì—…ë¡œë“œ ëŒ€ê¸°)
            await authFetch('/api/products/batch-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ids: productIds,
                status: 'manual_pending'
              })
            });

            console.log(`âœ… ${productIds.length}ê°œ ìƒí’ˆ ìƒíƒœ -> manual_pending`);
            loadProducts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          }
        } catch (error) {
          console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
        }
      }

      document.getElementById('quoteIdInputModal').style.display = 'none';
      pendingDownloadProducts = [];
    }

    // ê²¬ì ì„œ ID ì €ì¥ (ë‹¤ìš´ë¡œë“œ í›„ ìˆ˜ë™ ì…ë ¥ìš©)
    window.saveManualQuoteId = async function() {
      console.log('ğŸ”µ saveManualQuoteId í•¨ìˆ˜ ì‹œì‘');
      console.log('ğŸ”µ pendingDownloadProducts:', pendingDownloadProducts);
      console.log('ğŸ”µ pendingDownloadProducts.length:', pendingDownloadProducts?.length);

      const quoteIdInput = document.getElementById('manualQuoteIdInput');
      console.log('ğŸ”µ quoteIdInput element:', quoteIdInput);

      const quoteId = quoteIdInput?.value?.trim();

      if (!quoteId) {
        alert('ê²¬ì ì„œ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!/^\d+$/.test(quoteId)) {
        alert('ê²¬ì ì„œ IDëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      if (pendingDownloadProducts.length === 0) {
        alert('ì €ì¥í•  ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        closeQuoteIdModal();
        return;
      }

      try {
        showDownloadProgressModal('ìƒí’ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...');

        // ìƒí’ˆ ìƒíƒœë¥¼ 'uploaded'ë¡œ ë³€ê²½í•˜ê³  quoteId ì €ì¥
        const productIds = pendingDownloadProducts.map(p => p.id).filter(id => id);
        console.log('ğŸ“ ê²¬ì ì„œ ID ì €ì¥ ì‹œì‘:', { quoteId, productIds, pendingCount: pendingDownloadProducts.length });

        if (productIds.length > 0) {
          // ì¼ê´„ ìƒíƒœ ë³€ê²½
          console.log('ğŸ“¤ batch-status API í˜¸ì¶œ...');
          const statusResponse = await authFetch('/api/products/batch-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ids: productIds,
              status: 'uploaded'
            })
          });
          const statusResult = await statusResponse.json();
          console.log('ğŸ“¥ batch-status ì‘ë‹µ:', statusResult);

          if (!statusResponse.ok) {
            throw new Error(statusResult.message || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
          }

          // ê° ìƒí’ˆì— quoteId ì €ì¥
          console.log('ğŸ“¤ ê° ìƒí’ˆì— quoteId ì €ì¥ ì‹œì‘...');
          for (const productId of productIds) {
            const updateResponse = await authFetch(`/api/products/${productId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                quoteId: quoteId,
                uploadedAt: new Date().toISOString()
              })
            });
            const updateResult = await updateResponse.json();
            console.log(`ğŸ“¥ ìƒí’ˆ ${productId} ì—…ë°ì´íŠ¸:`, updateResult);
          }
          console.log('âœ… ëª¨ë“  ìƒí’ˆ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        } else {
          console.warn('âš ï¸ ì—…ë°ì´íŠ¸í•  ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        hideDownloadProgressModal();

        // closeQuoteIdModal()ì´ ìƒíƒœë¥¼ ë‹¤ì‹œ ë³€ê²½í•˜ì§€ ì•Šë„ë¡ ë¨¼ì € ë°ì´í„° ì´ˆê¸°í™”
        const savedCount = productIds.length;
        pendingDownloadProducts = [];

        // ëª¨ë‹¬ ë‹«ê¸° (ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë¯€ë¡œ ìƒíƒœ ë³€ê²½ ì—†ìŒ)
        document.getElementById('quoteIdInputModal').style.display = 'none';

        alert(`âœ… ê²¬ì ì„œ IDê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nê²¬ì ì„œ ID: ${quoteId}\nìƒí’ˆ ${savedCount}ê°œê°€ ì—…ë¡œë“œ ì™„ë£Œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);

        // ìƒí’ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadProducts();

      } catch (error) {
        hideDownloadProgressModal();
        console.error('âŒ ê²¬ì ì„œ ID ì €ì¥ ì˜¤ë¥˜:', error);
        console.error('âŒ ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
        console.error('âŒ ì˜¤ë¥˜ íƒ€ì…:', error.name);
        console.error('âŒ pendingDownloadProducts:', pendingDownloadProducts);
        alert(`ê²¬ì ì„œ ID ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message || error.toString()}`);
      }
    }

    // íŒŒì¼ë§Œ ë‹¤ìš´ë°›ê¸° (ìë™ ì—…ë¡œë“œ ì—†ì´)
    window.saveAllDataDownloadOnly = async function() {
      // ì‚¬ì´ì¦ˆ ìˆ˜ì§‘
      detailCategoryState.size = {
        width: document.getElementById('sizeWidth').value,
        height: document.getElementById('sizeHeight').value,
        depth: document.getElementById('sizeDepth').value
      };

      // ë¬´ê²Œ ìˆ˜ì§‘
      detailCategoryState.weight = document.getElementById('weightInput').value;

      // ì·¨ê¸‰ì£¼ì˜ ì‚¬ìœ  ìˆ˜ì§‘
      detailCategoryState.handlingCare = document.getElementById('handlingCareInput').value;

      // ê³„ì ˆ ìˆ˜ì§‘
      detailCategoryState.season = document.getElementById('seasonInput').value;

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!detailCategoryState.size.width || !detailCategoryState.size.height || !detailCategoryState.size.depth) {
        alert('ì‚¬ì´ì¦ˆë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!detailCategoryState.weight) {
        alert('ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      console.log('ğŸ“¥ íŒŒì¼ë§Œ ë‹¤ìš´ë¡œë“œ ì‹œì‘...');

      // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
      showDownloadProgressModal('íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ì¤‘...');

      try {
        // ì„ íƒí•œ ìƒí’ˆ ë°ì´í„° ì‚¬ìš© (generateQuoteì—ì„œ ì´ë¯¸ ë¡œë“œë¨)
        const selectedProductsData = window.selectedFullProductsData || [];

        // ê° íŒŒì¼ ì •ë³´ì™€ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
        const filesData = detailCategoryState.excelData.map((item, index) => {
          const selection = detailCategoryState.selections[index];
          return {
            dataIndex: item.dataIndex,
            filename: item.downloadedFilename || item.filename,
            category: selection ? selection.optionValue : ''
          };
        });

        // í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ (downloadOnly í”Œë˜ê·¸ ì¶”ê°€)
        const response = await sendMessageToExtension('fillQuotationExcels', {
          action: 'fillQuotationExcels',
          filesData: filesData,
          products: selectedProductsData,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName || '',
          quotationMappings: window.quotationMappings || settings.quotationMappings || [],
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins,
            packagingCost: settings.packagingCost || 500,
            minMargin: settings.minMargin || 1000
          },
          downloadOnly: true  // ë‹¤ìš´ë¡œë“œë§Œ ìˆ˜í–‰
        });

        hideDownloadProgressModal();

        if (response.success) {
          console.log('âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', response);
          closeDetailCategoryModal();

          // ê²¬ì ì„œ ID ì…ë ¥ì„ ìœ„í•´ ìƒí’ˆ ë°ì´í„° ì €ì¥
          pendingDownloadProducts = selectedProductsData;

          // ê²¬ì ì„œ ID ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
          showQuoteIdModal();
        } else if (response.needsInput && response.missingRequiredFields) {
          // í•„ìˆ˜ ì¹¸ ì…ë ¥ í•„ìš”
          showRequiredFieldsModal(response.missingRequiredFields);
          // ì¬ì‹œë„ìš© ë°ì´í„° ì €ì¥ (downloadOnly í”Œë˜ê·¸ í¬í•¨)
          pendingQuotationData = {
            filesData: filesData,
            products: selectedProductsData,
            searchTags: detailCategoryState.tags,
            size: detailCategoryState.size,
            weight: detailCategoryState.weight,
            handlingCare: detailCategoryState.handlingCare,
            season: detailCategoryState.season,
            brandName: settings.brandName || '',
            quotationMappings: window.quotationMappings || settings.quotationMappings || [],
            priceSettings: {
              exchangeRate: settings.exchangeRate,
              supplyMargins: settings.supplyMargins,
              saleMargins: settings.saleMargins,
              packagingCost: settings.packagingCost || 500,
              minMargin: settings.minMargin || 1000
            },
            downloadOnly: true
          };
        } else {
          throw new Error(response.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
      } catch (error) {
        hideDownloadProgressModal();
        console.error('âŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
        alert(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
      }
    }

    // í•„ìˆ˜ ì¹¸ ì…ë ¥ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let requiredFieldsData = null;
    let pendingQuotationData = null;

    // Excel íŒŒì¼ì— ë°ì´í„° ìë™ ì±„ìš°ê¸° (í™•ì¥ í”„ë¡œê·¸ë¨ì—ì„œ ì²˜ë¦¬)
    async function fillQuotationExcels() {
      try {
        console.log('ğŸ“ ê²¬ì ì„œ ìë™ ì‘ì„± ì‹œì‘...');

        // ì„ íƒí•œ ìƒí’ˆ ë°ì´í„° ì‚¬ìš© (generateQuoteì—ì„œ ì´ë¯¸ ë¡œë“œë¨)
        const selectedProductsData = window.selectedFullProductsData || [];
        console.log(`ğŸ›ï¸  ì„ íƒí•œ ìƒí’ˆ ${selectedProductsData.length}ê°œ:`, selectedProductsData);

        // ê° íŒŒì¼ ì •ë³´ì™€ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
        const filesData = detailCategoryState.excelData.map((item, index) => {
          const selection = detailCategoryState.selections[index];
          return {
            dataIndex: item.dataIndex,
            filename: item.downloadedFilename || item.filename,
            category: selection ? selection.optionValue : ''
          };
        });

        console.log('ğŸ“‹ í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ì „ì†¡í•  ë°ì´í„°:', {
          filesData,
          products: selectedProductsData.length,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName,
          quotationMappings: window.quotationMappings
        });
        console.log('ğŸ“Œ quotationMappings ìƒì„¸:', JSON.stringify(window.quotationMappings, null, 2));

        // ìƒí’ˆ ì˜µì…˜ ë°ì´í„° ë””ë²„ê·¸
        if (selectedProductsData.length > 0) {
          const firstProduct = selectedProductsData[0];
          console.log('ğŸ“¦ ì²« ë²ˆì§¸ ìƒí’ˆ:', firstProduct.title);
          console.log('ğŸ“¦ results ê°œìˆ˜:', firstProduct.results?.length);
          if (firstProduct.results && firstProduct.results.length > 0) {
            const firstOpt = firstProduct.results[0];
            console.log('ğŸ“¦ ì²« ë²ˆì§¸ ì˜µì…˜ í‚¤:', Object.keys(firstOpt));
            console.log('ğŸ“¦ optionName1:', firstOpt.optionName1);
            console.log('ğŸ“¦ optionName1Cn:', firstOpt.optionName1Cn);
            console.log('ğŸ“¦ optionName2:', firstOpt.optionName2);
          }
        }

        // ë°ì´í„° ì €ì¥ (ì¬ì‹œë„ìš© - ëª¨ë“  ì„¤ì • í¬í•¨)
        pendingQuotationData = {
          filesData: filesData,
          products: selectedProductsData,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName || '',
          quotationMappings: window.quotationMappings || settings.quotationMappings || [],
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins,
            packagingCost: settings.packagingCost || 500,
            minMargin: settings.minMargin || 1000
          }
        };

        // ì¤€ë¹„ ë‹¨ê³„ ì™„ë£Œ, Excel ì‘ì„± ë‹¨ê³„ ì‹œì‘
        updateProgressStep('prepare', 'completed');
        updateProgressStep('fill', 'in_progress');

        // í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        const response = await sendMessageToExtension('fillQuotationExcels', {
          action: 'fillQuotationExcels',
          filesData: filesData,
          products: selectedProductsData,
          searchTags: detailCategoryState.tags,
          size: detailCategoryState.size,
          weight: detailCategoryState.weight,
          handlingCare: detailCategoryState.handlingCare,
          season: detailCategoryState.season,
          brandName: settings.brandName || '',
          quotationMappings: window.quotationMappings || settings.quotationMappings || [],
          priceSettings: {
            exchangeRate: settings.exchangeRate,
            supplyMargins: settings.supplyMargins,
            saleMargins: settings.saleMargins,
            packagingCost: settings.packagingCost || 500,
            minMargin: settings.minMargin || 1000
          }
        });

        // í•„ìˆ˜ ì¹¸ì´ ëˆ„ë½ëœ ê²½ìš°
        if (response.needsInput && response.missingRequiredFields) {
          console.log('âš ï¸ í•„ìˆ˜ ì¹¸ ì…ë ¥ í•„ìš”:', response.missingRequiredFields);
          updateProgressStep('fill', 'error');
          closeProgressModal();
          showRequiredFieldsModal(response.missingRequiredFields);
          return;
        }

        if (response.success) {
          console.log('âœ… ê²¬ì ì„œ ìë™ ì‘ì„± ì™„ë£Œ:', response);

          // Excel ì‘ì„± ì™„ë£Œ
          updateProgressStep('fill', 'completed');

          // ë‚˜ë¨¸ì§€ ë‹¨ê³„ë“¤ì€ background.jsì—ì„œ ì—…ë°ì´íŠ¸ë  ì˜ˆì •
          // (open, upload, validate, complete)

          closeDetailCategoryModal();
          pendingQuotationData = null;
        } else {
          throw new Error(response.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }

      } catch (error) {
        console.error('âŒ ê²¬ì ì„œ ìë™ ì‘ì„± ì˜¤ë¥˜:', error);
        updateProgressStep('fill', 'error');

        // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(() => {
          closeProgressModal();
          alert(`ê²¬ì ì„œ ìë™ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
        }, 3000);
      }
    }

    // í•„ìˆ˜ ì¹¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
    function showRequiredFieldsModal(missingFields) {
      requiredFieldsData = missingFields;

      const modal = document.getElementById('requiredFieldsModal');
      const listContainer = document.getElementById('requiredFieldsList');

      listContainer.innerHTML = missingFields.map((field, index) => `
        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
            ${field.header}
            <span style="color: #ff4444;">*</span>
          </label>
          ${field.example ? `
            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-left: 3px solid #2196f3; border-radius: 4px;">
              <small style="color: #666;">ì˜ˆì‹œ:</small>
              <strong style="color: #1976d2; margin-left: 8px;">${field.example}</strong>
            </div>
          ` : ''}
          <input
            type="text"
            id="required-field-${index}"
            data-header="${field.header}"
            placeholder="ê°’ì„ ì…ë ¥í•˜ì„¸ìš”"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
          >
        </div>
      `).join('');

      modal.style.display = 'flex';
    }

    // í•„ìˆ˜ ì¹¸ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
    function closeRequiredFieldsModal() {
      document.getElementById('requiredFieldsModal').style.display = 'none';
      requiredFieldsData = null;
    }

    // í•„ìˆ˜ ì¹¸ ì…ë ¥ ì ìš©
    async function applyRequiredFields() {
      const newMappings = [];

      requiredFieldsData.forEach((field, index) => {
        const input = document.getElementById(`required-field-${index}`);
        const value = input.value.trim();

        if (value) {
          newMappings.push({
            header: field.header,
            type: 'fixed',
            value: value
          });
        }
      });

      if (newMappings.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í•„ìˆ˜ ì¹¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê²¬ì ì„œ ì–‘ì‹ì— ì¶”ê°€í• ì§€ ë¬¼ì–´ë³´ê¸°
      const shouldSave = confirm(
        `ì…ë ¥í•˜ì‹  ${newMappings.length}ê°œ í•­ëª©ì„ ê²¬ì ì„œ ì–‘ì‹ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
        `ì¶”ê°€í•˜ë©´ ë‹¤ìŒë¶€í„° ì´ ê°’ë“¤ì´ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.\n\n` +
        newMappings.map(m => `â€¢ ${m.header}: ${m.value}`).join('\n')
      );

      if (shouldSave) {
        // quotationMappingsì— ì¶”ê°€
        for (const mapping of newMappings) {
          const exists = window.quotationMappings.find(m => m.header === mapping.header);
          if (!exists) {
            window.quotationMappings.push(mapping);
          } else {
            // ê¸°ì¡´ ê²ƒ ì—…ë°ì´íŠ¸
            exists.value = mapping.value;
          }
        }

        // ì„¤ì • ì €ì¥
        settings.quotationMappings = window.quotationMappings;
        await saveSettingsToStorage();
        console.log('âœ… ê²¬ì ì„œ ì–‘ì‹ì— ìƒˆ í•­ëª© ì¶”ê°€ë¨');
      }

      closeRequiredFieldsModal();

      // ê²¬ì ì„œ ìë™ ì‘ì„± ì¬ì‹œë„
      if (pendingQuotationData) {
        console.log('ğŸ”„ ê²¬ì ì„œ ìë™ ì‘ì„± ì¬ì‹œë„...');

        const isDownloadOnly = pendingQuotationData.downloadOnly || false;

        const response = await sendMessageToExtension('fillQuotationExcels', {
          action: 'fillQuotationExcels',
          ...pendingQuotationData,
          // ì—…ë°ì´íŠ¸ëœ quotationMappings ì‚¬ìš© (ìƒˆë¡œ ì¶”ê°€ëœ í•„ìˆ˜ ì¹¸ í¬í•¨)
          quotationMappings: window.quotationMappings || settings.quotationMappings || []
        });

        if (response.success) {
          if (isDownloadOnly) {
            console.log('âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', response);
            closeDetailCategoryModal();

            // ê²¬ì ì„œ ID ì…ë ¥ì„ ìœ„í•´ ìƒí’ˆ ë°ì´í„° ì €ì¥
            pendingDownloadProducts = pendingQuotationData.products || [];

            // ê²¬ì ì„œ ID ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
            showQuoteIdModal();
          } else {
            console.log('âœ… ê²¬ì ì„œ ìë™ ì‘ì„± ì™„ë£Œ:', response);
            alert(`âœ… ê²¬ì ì„œ ìë™ ì‘ì„± ì™„ë£Œ!\n\n${response.count}ê°œì˜ Excel íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeDetailCategoryModal();
          }
          pendingQuotationData = null;
        } else if (response.needsInput && response.missingRequiredFields) {
          // ì•„ì§ë„ í•„ìˆ˜ ì¹¸ì´ ë” ìˆëŠ” ê²½ìš°
          showRequiredFieldsModal(response.missingRequiredFields);
        } else {
          throw new Error(response.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
      }
    }

    // ê²¬ì ì„œ ì‘ì„± ì–‘ì‹ ê´€ë ¨ í•¨ìˆ˜
    // window.quotationMappingsëŠ” loadSettings()ì—ì„œ ì´ˆê¸°í™”ë¨

    function renderQuotationMappings() {
      const container = document.getElementById('quotationMappingContainer');
      if (!container) return;

      container.innerHTML = window.quotationMappings.map((mapping, index) => `
        <div style="border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; background: white;">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" value="${mapping.header || ''}" placeholder="í—¤ë”ëª… (ì˜ˆ: ìƒí’ˆëª…)"
              onchange="updateQuotationMapping(${index}, 'header', this.value)"
              style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <select onchange="updateQuotationMapping(${index}, 'type', this.value)"
              style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="option1" ${mapping.type === 'option1' ? 'selected' : ''}>ì˜µì…˜1 ê°’</option>
              <option value="option2" ${mapping.type === 'option2' ? 'selected' : ''}>ì˜µì…˜2 ê°’</option>
              <option value="productName" ${mapping.type === 'productName' ? 'selected' : ''}>ì œí’ˆëª…</option>
              <option value="fixed" ${mapping.type === 'fixed' ? 'selected' : ''}>ì§ì ‘ ì‘ì„± (ê³ ì •ê°’)</option>
            </select>
            <button onclick="removeQuotationMapping(${index})"
              style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ì‚­ì œ</button>
          </div>
          ${mapping.type === 'fixed' ? `
            <input type="text" value="${mapping.value || ''}" placeholder="ê³ ì •ê°’ ì…ë ¥"
              onchange="updateQuotationMapping(${index}, 'value', this.value)"
              style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          ` : ''}
        </div>
      `).join('');
    }

    window.addQuotationMapping = function() {
      window.quotationMappings.push({ header: '', type: 'option1', value: '' });
      renderQuotationMappings();
    }

    window.removeQuotationMapping = function(index) {
      window.quotationMappings.splice(index, 1);
      renderQuotationMappings();
    }

    window.updateQuotationMapping = function(index, field, value) {
      if (window.quotationMappings[index]) {
        window.quotationMappings[index][field] = value;
        // settingsì—ë„ ë™ê¸°í™”
        settings.quotationMappings = window.quotationMappings;
        if (field === 'type') {
          renderQuotationMappings(); // íƒ€ì… ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
        }
      }
    }

    // ê²¬ì ì„œ ë§¤í•‘ ë Œë”ë§ì€ loadSettings() ì™„ë£Œ í›„ ìë™ í˜¸ì¶œë¨

    // ===== ì§„í–‰ ìƒí™© ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ =====
    let progressSteps = [];
    let currentStepIndex = -1;

    // ì§„í–‰ ìƒí™© ëª¨ë‹¬ í‘œì‹œ
    window.showProgressModal = function() {
      const modal = document.getElementById('progressModal');
      modal.style.display = 'flex';

      // ì´ˆê¸° ë‹¨ê³„ ì„¤ì •
      progressSteps = [
        { id: 'prepare', label: 'ê²¬ì ì„œ ë°ì´í„° ì¤€ë¹„ ì¤‘', status: 'pending' },
        { id: 'fill', label: 'ê²¬ì ì„œ Excel íŒŒì¼ ì‘ì„± ì¤‘', status: 'pending' },
        { id: 'images', label: 'ìƒì„¸í˜ì´ì§€/ë¼ë²¨ì»· ì´ë¯¸ì§€ ìƒì„± ì¤‘', status: 'pending' },
        { id: 'open', label: 'ì¿ íŒ¡ í˜ì´ì§€ ì—´ê¸°', status: 'pending' },
        { id: 'upload', label: 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘', status: 'pending' },
        { id: 'validate', label: 'íŒŒì¼ ê²€ì¦ ì¤‘', status: 'pending' },
        { id: 'complete', label: 'ì—…ë¡œë“œ ì™„ë£Œ', status: 'pending' }
      ];

      currentStepIndex = -1;
      renderProgressSteps();
    }

    // ì§„í–‰ ë‹¨ê³„ ë Œë”ë§
    function renderProgressSteps() {
      const stepsContainer = document.getElementById('progressSteps');
      stepsContainer.innerHTML = progressSteps.map((step, index) => {
        let icon = 'â³';
        let color = '#999';

        if (step.status === 'completed') {
          icon = 'âœ…';
          color = '#4caf50';
        } else if (step.status === 'in_progress') {
          icon = 'ğŸ”„';
          color = '#2196f3';
        } else if (step.status === 'error') {
          icon = 'âŒ';
          color = '#f44336';
        } else if (step.status === 'pending') {
          icon = 'â³';
          color = '#ff9800';
        }

        return `
          <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
            <span style="font-size: 24px; margin-right: 12px;">${icon}</span>
            <span style="flex: 1; font-size: 15px; color: ${color}; font-weight: ${step.status === 'in_progress' ? 'bold' : 'normal'};">
              ${step.label}
            </span>
          </div>
        `;
      }).join('');

      // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      const currentStep = progressSteps.find(s => s.status === 'in_progress');
      const messageDiv = document.getElementById('progressMessage');
      if (currentStep) {
        messageDiv.innerHTML = `<strong style="color: #2196f3;">${currentStep.label}...</strong>`;
      } else {
        const lastStep = progressSteps[progressSteps.length - 1];
        if (lastStep.status === 'completed') {
          messageDiv.innerHTML = '<strong style="color: #4caf50;">âœ… ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</strong>';
        } else if (progressSteps.some(s => s.status === 'error')) {
          messageDiv.innerHTML = '<strong style="color: #f44336;">âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</strong>';
        }
      }
    }

    // ì§„í–‰ ë‹¨ê³„ ì—…ë°ì´íŠ¸
    window.updateProgressStep = function(stepId, status) {
      const step = progressSteps.find(s => s.id === stepId);
      if (step) {
        step.status = status;
        renderProgressSteps();
      }
    }

    // ì§„í–‰ ìƒí™© ëª¨ë‹¬ ë‹«ê¸°
    window.closeProgressModal = function() {
      document.getElementById('progressModal').style.display = 'none';
      progressSteps = [];
      currentStepIndex = -1;
    }

    // í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œë¶€í„° ì§„í–‰ ìƒíƒœ ë©”ì‹œì§€ ìˆ˜ì‹  (window.postMessageë¥¼ í†µí•´)
    window.addEventListener('message', (event) => {
      // ê°™ì€ originë§Œ í—ˆìš©
      if (event.origin !== window.location.origin) {
        return;
      }

      const message = event.data;

      // TotalBot extension ë©”ì‹œì§€ë§Œ ì²˜ë¦¬
      if (message && message.source === 'totalbot-extension') {
        console.log('ğŸ“¨ Extension ë©”ì‹œì§€ ìˆ˜ì‹ :', message.action, message.stepId, message.status);
        if (message.action === 'updateProgress') {
          console.log('ğŸ”„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸:', message.stepId, '->', message.status);
          updateProgressStep(message.stepId, message.status);
        } else if (message.action === 'closeProgressModal') {
          closeProgressModal();
        } else if (message.action === 'showRejectedModal') {
          // ê²¬ì ì„œ ë°˜ë ¤ ëª¨ë‹¬ í‘œì‹œ
          showRejectedModal(message);
        } else if (message.action === 'showUploadFailedModal') {
          // ì—…ë¡œë“œ ì‹¤íŒ¨ ëª¨ë‹¬ í‘œì‹œ
          showUploadFailedModal(message.error);
        } else if (message.action === 'showPendingModal') {
          // ê²€ì¦ ì§„í–‰ ì¤‘ ëª¨ë‹¬ í‘œì‹œ
          showPendingModal(message);
        }
      }
    });

    // ê²¬ì ì„œ ë°˜ë ¤ ëª¨ë‹¬ í‘œì‹œ
    function showRejectedModal(data) {
      closeProgressModal();

      const modal = document.getElementById('rejectedModal');
      document.getElementById('rejectedQuotationName').textContent = data.quotationName || 'ì•Œ ìˆ˜ ì—†ìŒ';
      document.getElementById('rejectedQuoteIdDisplay').textContent = data.quoteId || '-';
      document.getElementById('rejectedError').textContent = data.error || 'ê²€ì¦ ì‹¤íŒ¨';
      document.getElementById('rejectedDownloadUrl').href = data.downloadUrl || '#';

      // ê²¬ì ì„œ ID ì €ì¥ (ìˆ˜ë™ ì—…ë¡œë“œìš©)
      modal.dataset.quoteId = data.quoteId || '';

      modal.style.display = 'flex';
    }

    // ë°˜ë ¤ ëª¨ë‹¬ ë‹«ê¸°
    window.closeRejectedModal = function() {
      document.getElementById('rejectedModal').style.display = 'none';
    }

    // ìƒì„¸ë‚´ì—­ ë‹¤ìš´ë¡œë“œ - ì¿ íŒ¡ ê²¬ì ì„œ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
    window.downloadRejectedDetails = function() {
      const quotationName = document.getElementById('rejectedQuotationName').textContent;

      // ì•ˆë‚´ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì¿ íŒ¡ í˜ì´ì§€ ì—´ê¸°
      alert(`ì¿ íŒ¡ ê²¬ì ì„œ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n\n"${quotationName}" ê²¬ì ì„œë¥¼ ì°¾ì•„\n"ìƒì„¸ë‚´ì—­ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.`);
      window.open('https://supplier.coupang.com/qvt/quotation', '_blank');
      closeRejectedModal();
    }

    // ì—…ë¡œë“œ ì‹¤íŒ¨ ëª¨ë‹¬ í‘œì‹œ
    function showUploadFailedModal(error) {
      closeProgressModal();

      const modal = document.getElementById('uploadFailedModal');
      document.getElementById('uploadFailedError').textContent = error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      modal.style.display = 'flex';
    }

    // ì—…ë¡œë“œ ì‹¤íŒ¨ ëª¨ë‹¬ ë‹«ê¸°
    window.closeUploadFailedModal = function() {
      document.getElementById('uploadFailedModal').style.display = 'none';
    }

    // ìˆ˜ë™ ì—…ë¡œë“œ ëª¨ë‹¬ í‘œì‹œ
    window.showManualUploadModal = function() {
      closeRejectedModal();
      closeUploadFailedModal();

      document.getElementById('uploadedManualQuoteIdInput').value = '';
      document.getElementById('manualUploadModal').style.display = 'flex';
    }

    // ìˆ˜ë™ ì—…ë¡œë“œ ëª¨ë‹¬ ë‹«ê¸°
    window.closeManualUploadModal = function() {
      document.getElementById('manualUploadModal').style.display = 'none';
    }

    // ìˆ˜ë™ ì—…ë¡œë“œ ê²¬ì ì„œ ID ì €ì¥ (uploaded.html ìš©)
    window.saveUploadedManualQuoteId = function() {
      const quoteId = document.getElementById('uploadedManualQuoteIdInput').value.trim();
      if (!quoteId) {
        alert('ê²¬ì ì„œ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // localStorageì— ì €ì¥
      const recentQuotes = JSON.parse(localStorage.getItem('recentQuotations') || '[]');
      if (!recentQuotes.includes(quoteId)) {
        recentQuotes.unshift(quoteId);
        localStorage.setItem('recentQuotations', JSON.stringify(recentQuotes.slice(0, 10)));
      }

      alert(`ê²¬ì ì„œ ID "${quoteId}"ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      closeManualUploadModal();
    }

    // ê²€ì¦ ì§„í–‰ ì¤‘ ëª¨ë‹¬ í‘œì‹œ
    function showPendingModal(data) {
      closeProgressModal();

      const modal = document.getElementById('pendingModal');
      document.getElementById('pendingQuotationName').textContent = data.quotationName || 'ì•Œ ìˆ˜ ì—†ìŒ';
      document.getElementById('pendingQuoteId').textContent = data.quoteId || '-';
      document.getElementById('pendingError').textContent = data.error || 'ê²€ì¦ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.';

      modal.style.display = 'flex';
    }

    // ê²€ì¦ ì§„í–‰ ì¤‘ ëª¨ë‹¬ ë‹«ê¸°
    window.closePendingModal = function() {
      document.getElementById('pendingModal').style.display = 'none';
    }

    // ì¿ íŒ¡ì—ì„œ í™•ì¸í•˜ê¸°
    window.openCoupangQuotation = function() {
      window.open('https://supplier.coupang.com/qvt/quotation', '_blank');
      closePendingModal();
    }

  </script>

  <!-- ì§„í–‰ ìƒí™© ëª¨ë‹¬ -->
  <div id="progressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 600px; min-width: 500px;">
      <div class="coupang-modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h2 style="margin: 0; color: white;">ğŸš€ ì¿ íŒ¡ ìë™ ì—…ë¡œë“œ ì§„í–‰ ì¤‘</h2>
      </div>
      <div class="coupang-modal-body" style="padding: 30px;">
        <div id="progressSteps" style="margin-bottom: 20px;"></div>
        <div id="progressMessage" style="margin-top: 20px; font-size: 16px; text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px; min-height: 50px; display: flex; align-items: center; justify-content: center;"></div>
        <div style="margin-top: 20px; text-align: center; color: #666; font-size: 13px;">
          âš ï¸ ì´ ì°½ì„ ë‹«ì§€ ë§ê³  ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”
        </div>
      </div>
    </div>
  </div>

  <!-- ê²¬ì ì„œ ë°˜ë ¤ ëª¨ë‹¬ -->
  <div id="rejectedModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 500px;">
      <div class="coupang-modal-header" style="background: #f44336; color: white;">
        <h2 style="margin: 0; color: white;">âŒ ê²¬ì ì„œ ë°˜ë ¤ë¨</h2>
        <button class="coupang-modal-close" onclick="closeRejectedModal()" style="color: white;">Ã—</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
          <p style="font-size: 16px; color: #333; margin: 0;">
            <strong id="rejectedQuotationName">ê²¬ì ì„œëª…</strong>
          </p>
          <p style="font-size: 12px; color: #666; margin-top: 5px;">
            ID: <code id="rejectedQuoteIdDisplay" style="background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-size: 11px;">-</code>
          </p>
          <p style="font-size: 14px; color: #f44336; margin-top: 10px;" id="rejectedError">
            ê²€ì¦ ì‹¤íŒ¨
          </p>
        </div>

        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #856404;">
            ğŸ’¡ <strong>ìƒì„¸ë‚´ì—­ ë‹¤ìš´ë¡œë“œ</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹¤íŒ¨ ì‚¬ìœ ë¥¼ í™•ì¸í•˜ê³ ,<br>
            ìˆ˜ì • í›„ ë‹¤ì‹œ ì—…ë¡œë“œí•˜ì„¸ìš”.
          </p>
        </div>

        <a id="rejectedDownloadUrl" href="#" style="display: none;"></a>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeRejectedModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ë‹«ê¸°
          </button>
          <button onclick="downloadRejectedDetails()" style="flex: 1; padding: 14px; background: #2196f3; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ğŸ“¥ ì¿ íŒ¡ì—ì„œ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button onclick="showManualUploadModal()" style="background: none; border: none; color: #666; font-size: 13px; cursor: pointer; text-decoration: underline;">
            ìˆ˜ë™ìœ¼ë¡œ ê²¬ì ì„œ ID ì…ë ¥í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ ì‹¤íŒ¨ ëª¨ë‹¬ -->
  <div id="uploadFailedModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px;">
      <div class="coupang-modal-header" style="background: #ff9800; color: white;">
        <h2 style="margin: 0; color: white;">âš ï¸ ì—…ë¡œë“œ ì˜¤ë¥˜</h2>
        <button class="coupang-modal-close" onclick="closeUploadFailedModal()" style="color: white;">Ã—</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”§</div>
          <p style="font-size: 14px; color: #666;" id="uploadFailedError">
            ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #1565c0;">
            ğŸ’¡ ì¿ íŒ¡ ì‚¬ì´íŠ¸ì—ì„œ ì§ì ‘ ì—…ë¡œë“œí•˜ì…¨ë‹¤ë©´,<br>
            <strong>ìˆ˜ë™ ì—…ë¡œë“œ</strong> ë²„íŠ¼ìœ¼ë¡œ ê²¬ì ì„œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeUploadFailedModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ì·¨ì†Œ
          </button>
          <button onclick="showManualUploadModal()" style="flex: 1; padding: 14px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ğŸ“ ìˆ˜ë™ ì—…ë¡œë“œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ìˆ˜ë™ ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="manualUploadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10004; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 450px;">
      <div class="coupang-modal-header" style="background: #4caf50; color: white;">
        <h2 style="margin: 0; color: white;">ğŸ“ ìˆ˜ë™ ê²¬ì ì„œ ID ì…ë ¥</h2>
        <button class="coupang-modal-close" onclick="closeManualUploadModal()" style="color: white;">Ã—</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
            ê²¬ì ì„œ ID (UUID)
          </label>
          <input
            type="text"
            id="uploadedManualQuoteIdInput"
            placeholder="ì˜ˆ: 88eeff72-f3c2-417e-9a07-742d73350956"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;"
          >
          <p style="margin: 8px 0 0; font-size: 12px; color: #999;">
            ì¿ íŒ¡ ê²¬ì ì„œ ëª©ë¡ì—ì„œ íŒŒì¼ëª…ì„ í´ë¦­í•˜ë©´ URLì—ì„œ IDë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeManualUploadModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ì·¨ì†Œ
          </button>
          <button onclick="saveUploadedManualQuoteId()" style="flex: 1; padding: 14px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ì €ì¥
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ê²€ì¦ ì§„í–‰ ì¤‘ ëª¨ë‹¬ -->
  <div id="pendingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 500px;">
      <div class="coupang-modal-header" style="background: #ff9800; color: white;">
        <h2 style="margin: 0; color: white;">â³ ê²€ì¦ ì§„í–‰ ì¤‘</h2>
        <button class="coupang-modal-close" onclick="closePendingModal()" style="color: white;">Ã—</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”„</div>
          <p style="font-size: 16px; color: #333; margin: 0;">
            <strong id="pendingQuotationName">ê²¬ì ì„œëª…</strong>
          </p>
          <p style="font-size: 13px; color: #666; margin-top: 8px;">
            ê²¬ì ì„œ ID: <code id="pendingQuoteId" style="background: #f5f5f5; padding: 2px 6px; border-radius: 4px;">-</code>
          </p>
          <p style="font-size: 14px; color: #ff9800; margin-top: 10px;" id="pendingError">
            ê²€ì¦ì´ ì•„ì§ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.
          </p>
        </div>

        <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; color: #e65100;">
            ğŸ’¡ ì¿ íŒ¡ì—ì„œ ê²€ì¦ì´ ì™„ë£Œë˜ë©´ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            ê²€ì¦ì—ëŠ” ìµœëŒ€ <strong>2ì‹œê°„</strong>ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closePendingModal()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ë‹«ê¸°
          </button>
          <button onclick="openCoupangQuotation()" style="flex: 1; padding: 14px; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ğŸ”— ì¿ íŒ¡ì—ì„œ í™•ì¸
          </button>
        </div>

        <div style="margin-top: 15px; text-align: center;">
          <button onclick="showManualUploadModal()" style="background: none; border: none; color: #666; font-size: 13px; cursor: pointer; text-decoration: underline;">
            ìˆ˜ë™ìœ¼ë¡œ ê²¬ì ì„œ ID ì…ë ¥í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- í•„ìˆ˜ ì¹¸ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="requiredFieldModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10005; align-items: center; justify-content: center;">
    <div class="coupang-modal-content" style="max-width: 550px; max-height: 80vh; overflow-y: auto;">
      <div class="coupang-modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
        <h2 style="margin: 0; color: white;">âš ï¸ í•„ìˆ˜ í•­ëª© ê°’ í•„ìš”</h2>
        <button class="coupang-modal-close" onclick="closeRequiredFieldModal()" style="color: white;">Ã—</button>
      </div>
      <div class="coupang-modal-body" style="padding: 25px;">
        <p style="margin: 0 0 20px; font-size: 14px; color: #666;">
          ë‹¤ìŒ í•„ìˆ˜ í•­ëª©ì— ê°’ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê°’ì„ ì…ë ¥í•˜ë©´ ì„¤ì •ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
        </p>

        <div id="requiredFieldsListNew" style="margin-bottom: 20px;">
          <!-- ë™ì ìœ¼ë¡œ í•„ìˆ˜ ì¹¸ ëª©ë¡ ì¶”ê°€ë¨ -->
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="cancelRequiredFields()" style="flex: 1; padding: 14px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            ì·¨ì†Œ
          </button>
          <button onclick="saveRequiredFields()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #4caf50 0%, #43a047 100%); color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: 600;">
            âœ“ ì €ì¥ ë° ê³„ì†
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== í•„ìˆ˜ ì¹¸ ì…ë ¥ ëª¨ë‹¬ ê´€ë ¨ =====
    let pendingRequiredFields = [];
    let requiredFieldCallback = null;

    function showRequiredFieldModal(fields, callback) {
      console.log('ğŸ“‹ showRequiredFieldModal í˜¸ì¶œë¨, fields:', fields);
      pendingRequiredFields = fields || [];
      requiredFieldCallback = callback;

      const container = document.getElementById('requiredFieldsListNew');
      if (!container) {
        console.error('âŒ requiredFieldsListNew ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
        return;
      }
      container.innerHTML = '';

      if (!fields || fields.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">ì…ë ¥í•  í•„ìˆ˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        document.getElementById('requiredFieldModal').style.display = 'flex';
        return;
      }

      fields.forEach((field, index) => {
        console.log(`ğŸ“‹ í•„ë“œ ${index}:`, field);
        const fieldDiv = document.createElement('div');
        fieldDiv.style.cssText = 'background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px;';

        fieldDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: 600; color: #333; font-size: 14px;">ğŸ“‹ ${field.header}</span>
            <span style="font-size: 12px; color: #888;">ì—´ ${field.column}</span>
          </div>
          <div style="display: flex; gap: 8px; margin-bottom: 12px; font-size: 12px;">
            <div style="flex: 1; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
              <span style="color: #888;">7í–‰:</span> <span style="color: #333;">${field.row7Value || '(ë¹„ì–´ìˆìŒ)'}</span>
            </div>
            <div style="flex: 1; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
              <span style="color: #888;">8í–‰:</span> <span style="color: #333;">${field.row8Value || '(ë¹„ì–´ìˆìŒ)'}</span>
            </div>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select id="requiredFieldType_${index}" onchange="toggleRequiredFieldInput(${index})" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; min-width: 120px;">
              <option value="fixed">ê³ ì •ê°’</option>
              <option value="option1">ì˜µì…˜1 ê°’</option>
              <option value="option2">ì˜µì…˜2 ê°’</option>
            </select>
            <input
              type="text"
              id="requiredFieldValue_${index}"
              placeholder="ê°’ì„ ì…ë ¥í•˜ì„¸ìš”"
              style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
            >
          </div>
        `;

        container.appendChild(fieldDiv);
      });

      document.getElementById('requiredFieldModal').style.display = 'flex';
    }

    function toggleRequiredFieldInput(index) {
      const typeSelect = document.getElementById(`requiredFieldType_${index}`);
      const valueInput = document.getElementById(`requiredFieldValue_${index}`);

      if (typeSelect.value === 'fixed') {
        valueInput.style.display = 'block';
        valueInput.placeholder = 'ê³ ì •ê°’ì„ ì…ë ¥í•˜ì„¸ìš”';
      } else if (typeSelect.value === 'option1') {
        valueInput.style.display = 'none';
      } else if (typeSelect.value === 'option2') {
        valueInput.style.display = 'none';
      }
    }

    function closeRequiredFieldModal() {
      document.getElementById('requiredFieldModal').style.display = 'none';
    }

    function cancelRequiredFields() {
      closeRequiredFieldModal();
      if (requiredFieldCallback) {
        requiredFieldCallback({ cancelled: true });
        requiredFieldCallback = null;
      }
    }

    async function saveRequiredFields() {
      const results = [];

      pendingRequiredFields.forEach((field, index) => {
        const typeSelect = document.getElementById(`requiredFieldType_${index}`);
        const valueInput = document.getElementById(`requiredFieldValue_${index}`);

        const type = typeSelect.value;
        const value = type === 'fixed' ? valueInput.value.trim() : '';

        if (type === 'fixed' && !value) {
          alert(`"${field.header}" í•„ë“œì— ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
          return;
        }

        results.push({
          header: field.header,
          type: type,
          value: value,
          column: field.column
        });
      });

      if (results.length !== pendingRequiredFields.length) {
        return; // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨
      }

      // ë¡œì»¬ ì„¤ì •ì— ìƒˆ ë§¤í•‘ ì¶”ê°€
      for (const newMapping of results) {
        const existingIndex = window.quotationMappings.findIndex(m => m.header === newMapping.header);
        if (existingIndex >= 0) {
          window.quotationMappings[existingIndex] = newMapping;
        } else {
          window.quotationMappings.push(newMapping);
        }
      }

      // ì„œë²„ì— ì €ì¥ (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
      try {
        await authFetch('/api/settings/quotation-mappings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quotationMappings: window.quotationMappings })
        });
        console.log('âœ… í•„ìˆ˜ ì¹¸ ë§¤í•‘ì´ ì„œë²„ì— ì €ì¥ë¨');
      } catch (e) {
        console.error('âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', e);
      }

      closeRequiredFieldModal();

      if (requiredFieldCallback) {
        requiredFieldCallback({ cancelled: false, mappings: results });
        requiredFieldCallback = null;
      }
    }

    // Extensionì—ì„œ í•„ìˆ˜ ì¹¸ ì…ë ¥ ìš”ì²­ ìˆ˜ì‹ 
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'SHOW_REQUIRED_FIELD_MODAL') {
        const { fields, messageId } = event.data;
        console.log('ğŸ“‹ í•„ìˆ˜ ì¹¸ ëª¨ë‹¬ ìš”ì²­ ìˆ˜ì‹ :', fields);
        console.log('ğŸ“‹ fields íƒ€ì…:', typeof fields, 'length:', fields?.length);

        if (!fields || fields.length === 0) {
          console.error('âŒ fieldsê°€ ë¹„ì–´ìˆìŒ!');
        }

        showRequiredFieldModal(fields, (result) => {
          // ê²°ê³¼ë¥¼ Extensionìœ¼ë¡œ ì „ì†¡
          window.postMessage({
            type: 'REQUIRED_FIELD_RESPONSE',
            messageId: messageId,
            result: result
          }, '*');
        });
      }
    });
  </script>

</body>
</html>
