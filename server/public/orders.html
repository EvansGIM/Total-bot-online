<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>TotalBot - ìë™ ë°œì£¼</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6f7;
      color: #333;
    }

    /* Sidebar Styles */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: #1a1a2e;
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-header {
      padding: 24px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .sidebar-header h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.8;
    }

    .sidebar-menu {
      padding: 16px 0;
    }

    .sidebar-menu-title {
      padding: 12px 20px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: #ccc;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .sidebar-menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }

    .sidebar-menu-item.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      border-left-color: #667eea;
    }

    .sidebar-menu-item .menu-icon {
      width: 24px;
      margin-right: 12px;
      font-size: 18px;
      text-align: center;
    }

    .sidebar-menu-item .menu-badge {
      margin-left: auto;
      background: #667eea;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 12px 20px;
    }

    /* Hamburger Button */
    .hamburger-btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: #f0f0f0;
    }

    .hamburger-btn span {
      display: block;
      width: 22px;
      height: 2px;
      background: #333;
      margin: 2px 0;
      border-radius: 1px;
      transition: all 0.3s;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .icon {
      font-size: 22px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .form-row-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus,
    select:focus {
      border-color: #667eea;
      outline: none;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-large {
      padding: 16px 32px;
      font-size: 16px;
    }

    /* Progress */
    .progress-section {
      margin-top: 20px;
    }

    .progress-bar-container {
      background: #e5e7eb;
      border-radius: 8px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      border-radius: 8px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 13px;
      color: #666;
      display: flex;
      justify-content: space-between;
    }

    /* Log */
    .log-container {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
    }

    .log-entry {
      padding: 4px 0;
      color: #aaa;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .log-entry.success { color: #10b981; }
    .log-entry.error { color: #ef4444; }
    .log-entry.warning { color: #f59e0b; }
    .log-entry.info { color: #3b82f6; }

    .log-time {
      color: #666;
      margin-right: 8px;
    }

    /* ì²˜ë¦¬ ì§„í–‰ ëª¨ë‹¬ */
    .process-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10005;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .process-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .process-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .process-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .process-modal-title .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .process-modal-body {
      padding: 24px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ëª¨ë‹¬ ë‚´ ë‹¨ê³„ í‘œì‹œ */
    .modal-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 0 10px;
    }

    .modal-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .modal-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 16px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e5e7eb;
      z-index: 0;
    }

    .modal-step.completed:not(:last-child)::after {
      background: #10b981;
    }

    .modal-step-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      position: relative;
      z-index: 1;
      transition: all 0.3s;
    }

    .modal-step.active .modal-step-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .modal-step.completed .modal-step-icon {
      background: #10b981;
      color: white;
    }

    .modal-step-label {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    .modal-step.active .modal-step-label,
    .modal-step.completed .modal-step-label {
      color: #374151;
      font-weight: 600;
    }

    /* ëª¨ë‹¬ ë‚´ í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
    .modal-progress {
      margin-bottom: 20px;
    }

    .modal-progress-bar-bg {
      background: #e5e7eb;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
    }

    .modal-progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .modal-progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 13px;
      color: #6b7280;
    }

    .modal-progress-status {
      font-weight: 500;
    }

    /* ëª¨ë‹¬ ë‚´ ë¡œê·¸ */
    .modal-log-container {
      background: #0f172a;
      border-radius: 12px;
      flex: 1;
      min-height: 250px;
      max-height: 350px;
      overflow-y: auto;
      font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
      font-size: 12px;
      padding: 16px;
    }

    .modal-log-entry {
      padding: 6px 0;
      color: #94a3b8;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      line-height: 1.5;
    }

    .modal-log-entry:last-child {
      border-bottom: none;
    }

    .modal-log-entry.success { color: #34d399; }
    .modal-log-entry.error { color: #f87171; }
    .modal-log-entry.warning { color: #fbbf24; }
    .modal-log-entry.info { color: #60a5fa; }

    .modal-log-time {
      color: #64748b;
      margin-right: 8px;
    }

    .process-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .process-modal-footer .btn {
      min-width: 100px;
    }

    /* Steps */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      position: relative;
    }

    .steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 60px;
      right: 60px;
      height: 2px;
      background: #e5e7eb;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 8px;
      transition: all 0.3s;
    }

    .step.active .step-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .step.completed .step-number {
      background: #10b981;
      color: white;
    }

    .step-label {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .step.active .step-label,
    .step.completed .step-label {
      color: #333;
      font-weight: 600;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .toast.success { background: #10b981; color: white; }
    .toast.error { background: #ef4444; color: white; }
    .toast.warning { background: #f59e0b; color: white; }
    .toast.info { background: #3b82f6; color: white; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Checkbox */
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-group label {
      margin-bottom: 0;
      cursor: pointer;
    }

    /* Folder input */
    .folder-input-group {
      display: flex;
      gap: 8px;
    }

    .folder-input-group input {
      flex: 1;
    }

    /* Help text */
    .help-text {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    /* Filter list */
    .filter-list {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .filter-item:last-child {
      margin-bottom: 0;
    }

    .filter-item select, .filter-item input {
      flex: 1;
      padding: 6px 10px;
      font-size: 13px;
    }

    .filter-item .btn-remove {
      padding: 4px 8px;
      font-size: 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .filter-item .btn-remove:hover {
      background: #dc2626;
    }

    /* Order list table */
    .order-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .order-table th {
      background: #f9fafb;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e5e8eb;
    }

    .order-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-table tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-confirmed { background: #d1fae5; color: #065f46; }
    .badge-rejected { background: #fee2e2; color: #991b1b; }

    /* Info box */
    .info-box {
      background: #fff8e1;
      border: 1px dashed #ffd8a8;
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 12px;
      font-size: 13px;
      color: #6c757d;
    }

    .info-box.blue {
      background: #e3f2fd;
      border-color: #90caf9;
    }
  </style>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>TotalBot</h2>
      <p>ì¿ íŒ¡ ìë™í™” í”Œë«í¼</p>
    </div>

    <div class="sidebar-menu">
      <div class="sidebar-menu-title">ìƒí’ˆ ê´€ë¦¬</div>
      <a class="sidebar-menu-item" href="products.html">
        <span class="menu-icon">ğŸ“¦</span>
        ìˆ˜ì§‘ ìƒí’ˆ
      </a>
      <a class="sidebar-menu-item" href="uploaded.html">
        <span class="menu-icon">ğŸš€</span>
        ì—…ë¡œë“œ ì™„ë£Œ
      </a>
      <a class="sidebar-menu-item" href="quotations.html">
        <span class="menu-icon">ğŸ“‹</span>
        ê²¬ì ì„œ ê´€ë¦¬
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">ë°œì£¼ ê´€ë¦¬</div>
      <a class="sidebar-menu-item active" href="orders.html">
        <span class="menu-icon">ğŸ›’</span>
        ìë™ ë°œì£¼
        <span class="menu-badge">NEW</span>
      </a>
      <a class="sidebar-menu-item" href="order-list.html">
        <span class="menu-icon">ğŸ“‘</span>
        ë°œì£¼ ë¦¬ìŠ¤íŠ¸
      </a>
      <a class="sidebar-menu-item" href="shipments.html">
        <span class="menu-icon">ğŸšš</span>
        ë°°ì†¡ ê´€ë¦¬
      </a>

      <div class="sidebar-divider"></div>

      <div class="sidebar-menu-title">ë¶„ì„/ì„¤ì •</div>
      <a class="sidebar-menu-item" href="settlement.html">
        <span class="menu-icon">ğŸ’°</span>
        ì •ì‚°
      </a>
      <a class="sidebar-menu-item" href="settings.html">
        <span class="menu-icon">âš™ï¸</span>
        ì„¤ì •
      </a>
    </div>
  </nav>

  <div class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="toggleSidebar()" title="ë©”ë‰´">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1>ìë™ ë°œì£¼</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="refreshStatus()">
        <span>ğŸ”„</span> ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Processing Steps (ìˆ¨ê¹€ - ëª¨ë‹¬ì—ì„œ í‘œì‹œ) -->
    <div class="card" style="display: none;">
      <div class="steps">
        <div class="step" id="step1"><div class="step-number">1</div><div class="step-label">íŒŒì‹±</div></div>
        <div class="step" id="step2"><div class="step-number">2</div><div class="step-label">ì—‘ì…€ ìƒì„±</div></div>
        <div class="step" id="step3"><div class="step-number">3</div><div class="step-label">ë°œì£¼ ì—…ë¡œë“œ</div></div>
        <div class="step" id="step4"><div class="step-number">4</div><div class="step-label">ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ</div></div>
        <div class="step" id="step5"><div class="step-number">5</div><div class="step-label">ë¬¸ì„œ ì €ì¥</div></div>
      </div>
      <div class="progress-section">
        <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="progress-text"><span id="progressStatus">ëŒ€ê¸°ì¤‘</span><span id="progressPercent">0%</span></div>
      </div>
    </div>

    <!-- Folder Selection -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">ğŸ“‚</span>
          ë°œì£¼ì„œ ì†ŒìŠ¤
        </div>
      </div>

      <div class="form-group">
        <label>í´ë” ê²½ë¡œ</label>
        <div class="folder-input-group">
          <input type="text" id="folderPath" placeholder="ë°œì£¼ íŒŒì¼ë“¤ì´ ìˆëŠ” í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤." readonly>
          <button class="btn btn-secondary" onclick="selectFolder()">í´ë” ì„ íƒ</button>
          <button class="btn btn-secondary" onclick="clearFolder()">ì´ˆê¸°í™”</button>
          <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ (í´ë” ì„ íƒìš©) -->
          <input type="file" id="folderInput" webkitdirectory multiple style="display: none;" onchange="handleFolderSelect(event)">
        </div>
        <div class="info-box" id="folderHint">
          ğŸ’¡ í´ë”ë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì¿ íŒ¡ì—ì„œ ì¡°ê±´ì— ë§ëŠ” ë¯¸í™•ì • ë°œì£¼ì„œë¥¼ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
        </div>
        <div id="selectedFilesInfo" style="display: none; margin-top: 8px; padding: 12px; background: #e8f5e9; border-radius: 8px; font-size: 13px;">
          <strong>ì„ íƒëœ íŒŒì¼:</strong> <span id="selectedFileCount">0</span>ê°œ
          <div id="selectedFileList" style="max-height: 100px; overflow-y: auto; margin-top: 8px; font-size: 12px; color: #666;"></div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary btn-large" onclick="startAutoProcess()" id="startBtn">
          <span>â–¶ï¸</span> ì¼ê´„ ì²˜ë¦¬ (ìë™ ë‹¤ìš´ë¡œë“œ)
        </button>
        <button class="btn btn-danger btn-large" onclick="stopProcess()" id="stopBtn" disabled>
          <span>â¹ï¸</span> ì¤‘ì§€
        </button>
      </div>
    </div>

    <!-- Settings Card -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">âš™ï¸</span>
          ë°œì£¼ ì¡°ê±´ ì„¤ì •
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>ê°œë³„ ëª©í‘œ ë§ˆì§„ê¸ˆ (ì›)</label>
          <input type="number" id="individualMargin" value="1000" min="0">
          <div class="help-text">ìƒí’ˆë‹¹ ìµœì†Œ ë§ˆì§„</div>
        </div>
        <div class="form-group">
          <label>ì‰½ë¨¼íŠ¸ ëª©í‘œ ë§ˆì§„ê¸ˆ (ì›)</label>
          <input type="number" id="shipmentMargin" value="5000" min="0">
          <div class="help-text">ì‰½ë¨¼íŠ¸ë‹¹ ìµœì†Œ ë§ˆì§„</div>
        </div>
        <div class="form-group">
          <label>ê¸°ì¤€ ì…ê³  ì˜ˆì •ì¼ (D+)</label>
          <input type="number" id="baseDateOffset" value="3" min="1" max="30">
          <div class="help-text">ì˜¤ëŠ˜ ê¸°ì¤€ D+Nì¼ ì´í›„ ë°œì£¼ë§Œ ì²˜ë¦¬</div>
        </div>
      </div>

      <div class="form-row-2" style="margin-top: 16px;">
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="processAll">
            <label for="processAll">ëª¨ë“  ë°œì£¼ ì²˜ë¦¬ (ë§ˆì§„ ì¡°ê±´ ë¬´ì‹œ)</label>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="processStock">
            <label for="processStock">ë³´ìœ  ì¬ê³ ë§Œ ì²˜ë¦¬</label>
          </div>
        </div>
      </div>

      <!-- Center Filter Section -->
      <div class="form-group" style="margin-top: 20px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <label style="margin-bottom: 0;">ì„¼í„°ë³„ í•„í„°ë§</label>
          <button class="btn btn-success" onclick="addFilter()" style="padding: 4px 12px; font-size: 12px;">+ ì¶”ê°€</button>
        </div>
        <div class="filter-list" id="filterList">
          <div style="color: #888; text-align: center; padding: 20px;">
            í•„í„°ë¥¼ ì¶”ê°€í•˜ë©´ íŠ¹ì • ì„¼í„°/ì…ê³ ì¼ ì¡°í•©ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

    <!-- Excluded Barcodes -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">ğŸš«</span>
          ì œì™¸ ë°”ì½”ë“œ ê´€ë¦¬
        </div>
        <button class="btn btn-secondary" onclick="openExcludeBarcodeModal()">ê´€ë¦¬</button>
      </div>
      <p style="font-size: 13px; color: #666;">
        ì œì™¸ëœ ë°”ì½”ë“œ: <strong id="excludedCount">0</strong>ê°œ
      </p>
    </div>

    <!-- Log Card (ìˆ¨ê¹€ - ëª¨ë‹¬ì—ì„œ í‘œì‹œ) -->
    <div class="card" style="display: none;">
      <div class="log-container" id="logContainer">
        <div class="log-entry info">
          <span class="log-time">[ì‹œìŠ¤í…œ]</span>
          ìë™ ë°œì£¼ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- Exclude Barcode Modal -->
  <div id="excludeBarcodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">ğŸš« ì œì™¸ ë°”ì½”ë“œ ê´€ë¦¬</h3>
        <button onclick="closeExcludeBarcodeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
      </div>
      <div class="form-group">
        <label>ë°”ì½”ë“œ ì¶”ê°€ (Rë¡œ ì‹œì‘)</label>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="newBarcodeInput" placeholder="R123456789">
          <button class="btn btn-primary" onclick="addExcludedBarcode()">ì¶”ê°€</button>
        </div>
      </div>
      <div style="margin-top: 16px;">
        <label style="font-size: 13px; font-weight: 600; color: #555;">ì œì™¸ëœ ë°”ì½”ë“œ ëª©ë¡</label>
        <div id="excludedBarcodeList" style="background: #f9fafb; border-radius: 8px; padding: 12px; margin-top: 8px; max-height: 300px; overflow-y: auto;">
          <div style="color: #888; text-align: center;">ì œì™¸ëœ ë°”ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
      <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 12px;">
        <button class="btn btn-secondary" onclick="closeExcludeBarcodeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì²˜ë¦¬ ì§„í–‰ ëª¨ë‹¬ -->
  <div id="processModal" class="process-modal-overlay">
    <div class="process-modal">
      <div class="process-modal-header">
        <div class="process-modal-title">
          <div class="spinner" id="processSpinner"></div>
          <span id="processModalTitle">ì¼ê´„ ì²˜ë¦¬ ì§„í–‰ì¤‘</span>
        </div>
      </div>
      <div class="process-modal-body">
        <!-- ë‹¨ê³„ í‘œì‹œ -->
        <div class="modal-steps">
          <div class="modal-step" id="modalStep1">
            <div class="modal-step-icon">1</div>
            <div class="modal-step-label">íŒŒì‹±</div>
          </div>
          <div class="modal-step" id="modalStep2">
            <div class="modal-step-icon">2</div>
            <div class="modal-step-label">ì—‘ì…€ ìƒì„±</div>
          </div>
          <div class="modal-step" id="modalStep3">
            <div class="modal-step-icon">3</div>
            <div class="modal-step-label">ë°œì£¼ ì—…ë¡œë“œ</div>
          </div>
          <div class="modal-step" id="modalStep4">
            <div class="modal-step-icon">4</div>
            <div class="modal-step-label">ì‰½ë¨¼íŠ¸</div>
          </div>
          <div class="modal-step" id="modalStep5">
            <div class="modal-step-icon">5</div>
            <div class="modal-step-label">ë¬¸ì„œ ì €ì¥</div>
          </div>
        </div>

        <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
        <div class="modal-progress">
          <div class="modal-progress-bar-bg">
            <div class="modal-progress-bar" id="modalProgressBar"></div>
          </div>
          <div class="modal-progress-text">
            <span class="modal-progress-status" id="modalProgressStatus">ëŒ€ê¸°ì¤‘</span>
            <span id="modalProgressPercent">0%</span>
          </div>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="modal-log-container" id="modalLogContainer">
          <div class="modal-log-entry info">
            <span class="modal-log-time">[ì‹œìŠ¤í…œ]</span>
            ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...
          </div>
        </div>
      </div>
      <div class="process-modal-footer">
        <button class="btn btn-danger" id="modalStopBtn" onclick="stopProcess()">ì¤‘ì§€</button>
        <button class="btn btn-primary" id="modalCloseBtn" onclick="closeProcessModal()" disabled>ì™„ë£Œ</button>
      </div>
    </div>
  </div>

  <!-- ë°œì£¼ í™•ì • ì‹¤íŒ¨ ëª¨ë‹¬ -->
  <div id="orderConfirmFailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; max-width: 550px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
      <div style="background: #dc3545; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px;">âŒ ë°œì£¼ í™•ì • ì—…ë¡œë“œ ì‹¤íŒ¨</h2>
        <button onclick="closeOrderConfirmFailModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">Ã—</button>
      </div>
      <div style="padding: 25px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
          <p style="font-size: 14px; color: #333; font-weight: 600;">ì¿ íŒ¡ì—ì„œ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
          <p style="margin: 0; font-size: 13px; color: #856404; white-space: pre-wrap;" id="orderConfirmFailMessage">
            ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>

        <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 13px; color: #1565c0;">
            ğŸ’¡ <strong>í•´ê²° ë°©ë²•:</strong><br>
            1. ìœ„ ì˜¤ë¥˜ ë©”ì‹œì§€ì—ì„œ ì‹¤íŒ¨í•œ í–‰(row)ì„ í™•ì¸í•˜ì„¸ìš”.<br>
            2. í•´ë‹¹ ì£¼ë¬¸ì˜ ë°ì´í„°(ìˆ˜ëŸ‰, ê°€ê²© ë“±)ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”.<br>
            3. ë‹¤ì‹œ ë°œì£¼ ì²˜ë¦¬ë¥¼ ì‹œë„í•˜ì„¸ìš”.
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button onclick="closeOrderConfirmFailModal()" style="flex: 1; padding: 14px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">
            í™•ì¸
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ë²„ì „ í™•ì¸
    console.log('ğŸ”„ TotalBot ìë™ ë°œì£¼ v2025-11-27-ext (Python totalbot ê¸°ë°˜ + Extension ì—°ë™)');

    // ìƒíƒœ ë³€ìˆ˜
    let isProcessing = false;
    let excludedBarcodes = new Set();
    let centerFilters = [];
    let extensionConnected = false;
    let coupangTabId = null;

    // =====================================================
    // Chrome Extension ì—°ë™ í•¨ìˆ˜ë“¤
    // =====================================================

    /**
     * Extension ID (manifest.jsonì—ì„œ í™•ì¸ í•„ìš”)
     * ê°œë°œ ì¤‘ì—ëŠ” chrome://extensionsì—ì„œ í™•ì¸
     */
    const EXTENSION_ID = null; // nullì´ë©´ ìë™ ê°ì§€ ì‹œë„

    /**
     * Extension ì—°ê²° í™•ì¸
     */
    async function checkExtensionConnection() {
      try {
        // content-localhost.jsë¥¼ í†µí•œ ë©”ì‹œì§€ ì „ë‹¬ í™•ì¸
        const response = await sendMessageToExtension({ action: 'ping' });
        if (response && response.pong) {
          extensionConnected = true;
          addLog('âœ… Chrome Extension ì—°ê²°ë¨', 'success');
          return true;
        }
      } catch (e) {
        console.log('Extension ì—°ê²° í™•ì¸ ì‹¤íŒ¨:', e);
      }
      extensionConnected = false;
      addLog('âš ï¸ Chrome Extensionì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
      return false;
    }

    /**
     * Extensionì— ë©”ì‹œì§€ ì „ì†¡
     */
    async function sendMessageToExtension(message) {
      return new Promise((resolve, reject) => {
        // window.postMessageë¥¼ í†µí•´ content scriptì™€ í†µì‹ 
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        const handler = (event) => {
          if (event.data && event.data.type === 'TOTALBOT_RESPONSE' && event.data.messageId === messageId) {
            window.removeEventListener('message', handler);
            resolve(event.data.response);
          }
        };

        window.addEventListener('message', handler);

        window.postMessage({
          type: 'TOTALBOT_REQUEST',
          messageId: messageId,
          message: message
        }, '*');

        // íƒ€ì„ì•„ì›ƒ
        setTimeout(() => {
          window.removeEventListener('message', handler);
          reject(new Error('Extension ì‘ë‹µ íƒ€ì„ì•„ì›ƒ'));
        }, 30000);
      });
    }

    /**
     * ì¿ íŒ¡ íƒ­ ì—´ê¸° ë˜ëŠ” ì°¾ê¸°
     */
    async function openCoupangTab() {
      addLog('ì¿ íŒ¡ ë°œì£¼ í˜ì´ì§€ ì—´ê¸° ì‹œë„ ì¤‘...', 'info');

      try {
        const response = await sendMessageToExtension({
          action: 'openCoupangOrderPage'
        });

        if (response && response.success) {
          coupangTabId = response.tabId;
          addLog('ì¿ íŒ¡ ë°œì£¼ í˜ì´ì§€ ì—´ë¦¼', 'success');
          return true;
        }
      } catch (e) {
        console.error('ì¿ íŒ¡ íƒ­ ì—´ê¸° ì‹¤íŒ¨:', e);
      }

      // ëŒ€ì•ˆ: ìƒˆ ì°½ìœ¼ë¡œ ì§ì ‘ ì—´ê¸°
      window.open('https://supplier.coupang.com/scm/purchase/order/list', '_blank');
      addLog('ìƒˆ íƒ­ì—ì„œ ì¿ íŒ¡ ë°œì£¼ í˜ì´ì§€ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
      return false;
    }

    /**
     * ì¿ íŒ¡ì—ì„œ ë°œì£¼ì„œ ë‹¤ìš´ë¡œë“œ ìš”ì²­
     */
    async function downloadOrdersFromCoupang(settings) {
      addLog('ì¿ íŒ¡ì—ì„œ ë°œì£¼ì„œ ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì¤‘...', 'info');

      try {
        const response = await sendMessageToExtension({
          action: 'downloadOrders',
          settings: settings
        });

        if (response && response.success) {
          addLog(`âœ… ${response.selectedCount}ê°œ ë°œì£¼ì„œ ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì™„ë£Œ`, 'success');
          return response;
        } else {
          throw new Error(response?.error || 'ë°œì£¼ì„œ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
        }
      } catch (e) {
        addLog('âŒ ë°œì£¼ì„œ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
        throw e;
      }
    }

    /**
     * ë°œì£¼ì„œ ëª©ë¡ ì¡°íšŒ
     */
    async function fetchOrderList(settings) {
      addLog('ë°œì£¼ì„œ ëª©ë¡ ì¡°íšŒ ì¤‘...', 'info');

      try {
        const response = await sendMessageToExtension({
          action: 'getOrderList',
          settings: settings
        });

        if (response && response.success) {
          addLog(`âœ… ë°œì£¼ì„œ ${response.total}ê±´ ì¡°íšŒë¨`, 'success');
          return response.orders;
        } else {
          throw new Error(response?.error || 'ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }
      } catch (e) {
        addLog('âŒ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + e.message, 'error');
        return [];
      }
    }

    // =====================================================
    // ì„œë²„ API ì—°ë™ í•¨ìˆ˜ë“¤
    // =====================================================

    /**
     * ì„œë²„ì— ì¬ê³  ë°ì´í„° ìš”ì²­
     */
    async function fetchStockData() {
      try {
        const response = await fetch('/api/stock');
        if (response.ok) {
          return await response.json();
        }
        return null;
      } catch (e) {
        console.error('ì¬ê³  ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:', e);
        return null;
      }
    }

    /**
     * ë§ˆì§„ ê³„ì‚° (Python totalbotì˜ process_orders_with_margin_logic ì°¸ê³ )
     */
    function calculateMargin(order, stockData, settings) {
      const barcode = order.barcode || order.productBarcode;
      const purchasePrice = parseFloat(order.purchasePrice) || 0;
      const supplyPrice = parseFloat(order.supplyPrice) || 0;
      const quantity = parseInt(order.quantity) || 1;

      // ê°œë³„ ë§ˆì§„ ê³„ì‚°
      const individualMargin = supplyPrice - purchasePrice;

      // ë§ˆì§„ ì¡°ê±´ í™•ì¸
      if (settings.processAll) {
        return { pass: true, margin: individualMargin, reason: 'ëª¨ë“  ë°œì£¼ ì²˜ë¦¬' };
      }

      if (individualMargin < settings.individualMargin) {
        return { pass: false, margin: individualMargin, reason: `ê°œë³„ ë§ˆì§„ ë¶€ì¡± (${individualMargin}ì› < ${settings.individualMargin}ì›)` };
      }

      // ì¬ê³  í™•ì¸ (processStock ì˜µì…˜)
      if (settings.processStock && stockData) {
        const stock = stockData[barcode];
        if (!stock || stock.quantity < quantity) {
          return { pass: false, margin: individualMargin, reason: 'ì¬ê³  ë¶€ì¡±' };
        }
      }

      // ì œì™¸ ë°”ì½”ë“œ í™•ì¸
      if (settings.excludedBarcodes && settings.excludedBarcodes.includes(barcode)) {
        return { pass: false, margin: individualMargin, reason: 'ì œì™¸ ë°”ì½”ë“œ' };
      }

      return { pass: true, margin: individualMargin, reason: 'ì¡°ê±´ ì¶©ì¡±' };
    }

    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ESC í‚¤ë¡œ ì‚¬ì´ë“œë°” ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    });

    // Toast ì•Œë¦¼
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ë¡œê·¸ ì¶”ê°€ (ê¸°ì¡´ + ëª¨ë‹¬)
    function addLog(message, type = 'info') {
      const time = new Date().toLocaleTimeString('ko-KR');

      // ê¸°ì¡´ ë¡œê·¸ ì»¨í…Œì´ë„ˆ
      const container = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;

      // ëª¨ë‹¬ ë¡œê·¸ ì»¨í…Œì´ë„ˆ
      const modalContainer = document.getElementById('modalLogContainer');
      if (modalContainer) {
        const modalEntry = document.createElement('div');
        modalEntry.className = `modal-log-entry ${type}`;
        modalEntry.innerHTML = `<span class="modal-log-time">[${time}]</span> ${message}`;
        modalContainer.appendChild(modalEntry);
        modalContainer.scrollTop = modalContainer.scrollHeight;
      }
    }

    // ë¡œê·¸ ì§€ìš°ê¸°
    function clearLog() {
      const container = document.getElementById('logContainer');
      container.innerHTML = `
        <div class="log-entry info">
          <span class="log-time">[ì‹œìŠ¤í…œ]</span>
          ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
      `;
    }

    // ëª¨ë‹¬ ë¡œê·¸ ì´ˆê¸°í™”
    function clearModalLog() {
      const modalContainer = document.getElementById('modalLogContainer');
      if (modalContainer) {
        modalContainer.innerHTML = `
          <div class="modal-log-entry info">
            <span class="modal-log-time">[ì‹œìŠ¤í…œ]</span>
            ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...
          </div>
        `;
      }
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ê¸°ì¡´ + ëª¨ë‹¬)
    function updateProgress(percent, status) {
      // ê¸°ì¡´
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent + '%';
      document.getElementById('progressStatus').textContent = status;

      // ëª¨ë‹¬
      const modalBar = document.getElementById('modalProgressBar');
      if (modalBar) {
        modalBar.style.width = percent + '%';
        document.getElementById('modalProgressPercent').textContent = percent + '%';
        document.getElementById('modalProgressStatus').textContent = status;
      }
    }

    // ë‹¨ê³„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ + ëª¨ë‹¬)
    function setStep(stepNumber) {
      // ê¸°ì¡´ step indicator
      for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step${i}`);
        if (!step) continue;
        step.classList.remove('active', 'completed');

        if (i < stepNumber) {
          step.classList.add('completed');
        } else if (i === stepNumber) {
          step.classList.add('active');
        }
      }

      // ëª¨ë‹¬ step indicator
      for (let i = 1; i <= 5; i++) {
        const modalStep = document.getElementById(`modalStep${i}`);
        if (!modalStep) continue;
        modalStep.classList.remove('active', 'completed');

        if (i < stepNumber) {
          modalStep.classList.add('completed');
        } else if (i === stepNumber) {
          modalStep.classList.add('active');
        }
      }
    }

    // ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
    function openProcessModal() {
      clearModalLog();
      document.getElementById('processModal').style.display = 'flex';
      document.getElementById('processSpinner').style.display = 'block';
      document.getElementById('processModalTitle').textContent = 'ì¼ê´„ ì²˜ë¦¬ ì§„í–‰ì¤‘';
      document.getElementById('modalStopBtn').disabled = false;
      document.getElementById('modalCloseBtn').disabled = true;

      // ë‹¨ê³„ ì´ˆê¸°í™”
      for (let i = 1; i <= 5; i++) {
        const modalStep = document.getElementById(`modalStep${i}`);
        if (modalStep) {
          modalStep.classList.remove('active', 'completed');
        }
      }

      // ì§„í–‰ë¥  ì´ˆê¸°í™”
      document.getElementById('modalProgressBar').style.width = '0%';
      document.getElementById('modalProgressPercent').textContent = '0%';
      document.getElementById('modalProgressStatus').textContent = 'ëŒ€ê¸°ì¤‘';
    }

    // ì²˜ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeProcessModal() {
      document.getElementById('processModal').style.display = 'none';
    }

    // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ëª¨ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function completeProcessModal(success = true) {
      document.getElementById('processSpinner').style.display = 'none';
      document.getElementById('processModalTitle').textContent = success ? 'âœ… ì²˜ë¦¬ ì™„ë£Œ' : 'âš ï¸ ì²˜ë¦¬ ì¤‘ë‹¨';
      document.getElementById('modalStopBtn').disabled = true;
      document.getElementById('modalCloseBtn').disabled = false;
    }

    // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
    async function refreshStatus() {
      addLog('ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
      showToast('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }

    // ì„ íƒëœ íŒŒì¼ë“¤ì„ ì €ì¥í•  ë³€ìˆ˜
    let selectedFiles = [];

    // í´ë” ì„ íƒ (íŒŒì¼ ì…ë ¥ íŠ¸ë¦¬ê±°)
    function selectFolder() {
      document.getElementById('folderInput').click();
    }

    // í´ë” ì„ íƒ ì²˜ë¦¬
    function handleFolderSelect(event) {
      const files = Array.from(event.target.files);

      if (files.length === 0) {
        showToast('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      // Excel íŒŒì¼ë§Œ í•„í„°ë§ (.xlsx, .xls)
      const excelFiles = files.filter(file => {
        const ext = file.name.toLowerCase();
        return ext.endsWith('.xlsx') || ext.endsWith('.xls');
      });

      if (excelFiles.length === 0) {
        showToast('Excel íŒŒì¼(.xlsx, .xls)ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      selectedFiles = excelFiles;

      // í´ë” ê²½ë¡œ í‘œì‹œ (ì²« ë²ˆì§¸ íŒŒì¼ì˜ ê²½ë¡œì—ì„œ ì¶”ì¶œ)
      const firstFile = files[0];
      const folderPath = firstFile.webkitRelativePath.split('/')[0];
      document.getElementById('folderPath').value = folderPath;

      // íŒíŠ¸ ì—…ë°ì´íŠ¸
      document.getElementById('folderHint').innerHTML = `âœ… <strong>${folderPath}</strong> í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`;
      document.getElementById('folderHint').style.background = '#e8f5e9';
      document.getElementById('folderHint').style.borderColor = '#81c784';

      // ì„ íƒëœ íŒŒì¼ ì •ë³´ í‘œì‹œ
      document.getElementById('selectedFilesInfo').style.display = 'block';
      document.getElementById('selectedFileCount').textContent = excelFiles.length;
      document.getElementById('selectedFileList').innerHTML = excelFiles
        .slice(0, 10)
        .map(f => `<div>ğŸ“„ ${f.name}</div>`)
        .join('') + (excelFiles.length > 10 ? `<div>... ì™¸ ${excelFiles.length - 10}ê°œ</div>` : '');

      addLog(`í´ë” ì„ íƒ: ${folderPath} (Excel íŒŒì¼ ${excelFiles.length}ê°œ)`, 'success');
      showToast(`${excelFiles.length}ê°œì˜ Excel íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
    }

    // í´ë” ì´ˆê¸°í™”
    function clearFolder() {
      document.getElementById('folderPath').value = '';
      document.getElementById('folderInput').value = '';
      document.getElementById('folderHint').innerHTML = 'ğŸ’¡ í´ë”ë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì¿ íŒ¡ì—ì„œ ì¡°ê±´ì— ë§ëŠ” ë¯¸í™•ì • ë°œì£¼ì„œë¥¼ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.';
      document.getElementById('folderHint').style.background = '#fff8e1';
      document.getElementById('folderHint').style.borderColor = '#ffd8a8';
      document.getElementById('selectedFilesInfo').style.display = 'none';
      selectedFiles = [];
      addLog('í´ë” ì„ íƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ì„ íƒëœ íŒŒì¼ì—ì„œ ë°œì£¼ ë°ì´í„° íŒŒì‹±
    async function parseSelectedFiles() {
      if (selectedFiles.length === 0) {
        return [];
      }

      addLog(`${selectedFiles.length}ê°œ íŒŒì¼ íŒŒì‹± ì‹œì‘...`, 'info');
      const orders = [];

      for (const file of selectedFiles) {
        try {
          const data = await readExcelFile(file);
          if (data && data.length > 0) {
            orders.push(...data);
            addLog(`âœ… ${file.name}: ${data.length}ê°œ í•­ëª©`, 'success');
          }
        } catch (e) {
          addLog(`âŒ ${file.name} íŒŒì‹± ì‹¤íŒ¨: ${e.message}`, 'error');
        }
      }

      addLog(`íŒŒì‹± ì™„ë£Œ: ì´ ${orders.length}ê°œ í•­ëª©`, 'success');
      return orders;
    }

    // Excel íŒŒì¼ ì½ê¸° (SheetJS ì‚¬ìš© ì‹œ)
    async function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          try {
            // SheetJSê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì‹± ì‹œë„
            if (typeof XLSX === 'undefined') {
              // ê°„ë‹¨í•œ ëª©ì—… ë°ì´í„° ë°˜í™˜
              resolve([{
                poNumber: file.name.replace(/\.[^.]+$/, ''),
                status: 'ë¯¸í™•ì •',
                center: 'GMK1',
                productName: 'íŒŒì¼ì—ì„œ ë¡œë“œë¨',
                quantity: 1,
                purchasePrice: 10000,
                supplyPrice: 15000
              }]);
              return;
            }

            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            // ë°œì£¼ì„œ êµ¬ì¡° íŒŒì‹± (Python totalbot ì°¸ê³ )
            const orders = parseOrderSheet(jsonData, file.name);
            resolve(orders);
          } catch (err) {
            reject(err);
          }
        };

        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsArrayBuffer(file);
      });
    }

    // ë°œì£¼ì„œ ì‹œíŠ¸ íŒŒì‹± (Python totalbot order_processor.pyì™€ ë™ì¼í•œ ë¡œì§)
    // ì¿ íŒ¡ ë°œì£¼ì„œ êµ¬ì¡°:
    // - Row 10, Col C (ì¸ë±ìŠ¤ 9, 2): ë°œì£¼ë²ˆí˜¸
    // - Row 13, Col C (ì¸ë±ìŠ¤ 12, 2): ë¬¼ë¥˜ì„¼í„°
    // - Row 13, Col F (ì¸ë±ìŠ¤ 12, 5): ì…ê³ ì˜ˆì •ì¼
    // - Row 14, Col C: íšŒì†¡ë‹´ë‹¹ì, Col G: ì—°ë½ì²˜
    // - Row 15, Col C: íšŒì†¡ì§€ì£¼ì†Œ
    // - í—¤ë”: "ìƒí’ˆëª…"ì´ ìˆëŠ” í–‰ (Col C)
    // - ë°ì´í„°: ìƒí’ˆ í–‰ê³¼ ë°”ì½”ë“œ í–‰ì´ ë²ˆê°ˆì•„ ë‚˜ì˜´
    //   - ìƒí’ˆ í–‰: Col B = SKU, Col C = ìƒí’ˆëª…, Col G = ìˆ˜ëŸ‰, Col J = ë§¤ì…ê°€, Col K = ê³µê¸‰ê°€
    //   - ë°”ì½”ë“œ í–‰: Col Cì— "R"ë¡œ ì‹œì‘í•˜ëŠ” ë°”ì½”ë“œ
    function parseOrderSheet(data, filename) {
      const orders = [];

      console.log('ğŸ“‹ ë°œì£¼ì„œ íŒŒì‹± ì‹œì‘:', filename);
      console.log('ğŸ“‹ ì´ í–‰ ìˆ˜:', data.length);

      // ë‚ ì§œ í¬ë§· í—¬í¼ í•¨ìˆ˜
      function formatDate(val) {
        if (!val) return '';
        if (typeof val === 'number') {
          // Excel ë‚ ì§œ ìˆ«ì í˜•ì‹
          const excelEpoch = new Date(1899, 11, 30);
          const resultDate = new Date(excelEpoch.getTime() + val * 86400000);
          return resultDate.toISOString().split('T')[0].replace(/-/g, '');
        }
        // ë¬¸ìì—´ í˜•ì‹
        const s = String(val).replace(/[-./]/g, '');
        const digits = s.replace(/\D/g, '');
        return digits.slice(0, 8);
      }

      // 1. ê³ ì • ìœ„ì¹˜ì—ì„œ ë©”íƒ€ ì •ë³´ ì¶”ì¶œ (Python totalbot ë°©ì‹ê³¼ ë™ì¼)
      // ë°œì£¼ë²ˆí˜¸: Row 10, Col C (ì¸ë±ìŠ¤: 9, 2)
      let poNumber = data[9] && data[9][2] ? String(data[9][2]).trim() : '';

      // ë¬¼ë¥˜ì„¼í„°: Row 13, Col C (ì¸ë±ìŠ¤: 12, 2)
      let center = data[12] && data[12][2] ? String(data[12][2]).trim() : '';

      // ì…ê³ ì˜ˆì •ì¼: Row 13, Col F (ì¸ë±ìŠ¤: 12, 5)
      let expectedDate = data[12] && data[12][5] ? formatDate(data[12][5]) : '';

      // íšŒì†¡ë‹´ë‹¹ì: Row 14, Col C (ì¸ë±ìŠ¤: 13, 2)
      let returnManager = data[13] && data[13][2] ? String(data[13][2]).trim() : '';

      // íšŒì†¡ë‹´ë‹¹ì ì—°ë½ì²˜: Row 14, Col G (ì¸ë±ìŠ¤: 13, 6)
      let returnTel = data[13] && data[13][6] ? String(data[13][6]).trim() : '';

      // íšŒì†¡ì§€ì£¼ì†Œ: Row 15, Col C (ì¸ë±ìŠ¤: 14, 2)
      let returnAddr = data[14] && data[14][2] ? String(data[14][2]).trim() : '';

      console.log('ğŸ“‹ ë°œì£¼ë²ˆí˜¸:', poNumber);
      console.log('ğŸ“‹ ë¬¼ë¥˜ì„¼í„°:', center);
      console.log('ğŸ“‹ ì…ê³ ì˜ˆì •ì¼:', expectedDate);

      // 2. ë¼ë²¨ ê¸°ë°˜ í´ë°± ê²€ìƒ‰ (ê³ ì • ìœ„ì¹˜ì—ì„œ ëª» ì°¾ì€ ê²½ìš°)
      if (!poNumber || !center || !expectedDate) {
        console.log('ğŸ“‹ ê³ ì • ìœ„ì¹˜ì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í•¨, ë¼ë²¨ ê¸°ë°˜ ê²€ìƒ‰ ì‹œë„...');
        for (let i = 0; i < Math.min(20, data.length); i++) {
          const row = data[i];
          if (!row) continue;

          for (let j = 0; j < row.length; j++) {
            const cell = String(row[j] || '');
            if (!poNumber && cell.includes('ë°œì£¼ë²ˆí˜¸') && row[j + 1]) {
              poNumber = String(row[j + 1]).trim();
            }
            if (!center && (cell.includes('ë¬¼ë¥˜ì„¼í„°') || cell.includes('FC')) && row[j + 1]) {
              center = String(row[j + 1]).trim();
            }
            if (!expectedDate && (cell.includes('ì…ê³ ì˜ˆì •') || cell.includes('ì…ê³ ì¼')) && row[j + 1]) {
              expectedDate = formatDate(row[j + 1]);
            }
          }
        }
      }

      // í•„ìˆ˜ ë°ì´í„° ê²€ì¦
      if (!poNumber || !center || !expectedDate) {
        console.log('âš ï¸ í•„ìˆ˜ ë©”íƒ€ ì •ë³´ ë¶€ì¡±:', { poNumber, center, expectedDate });
        return [];
      }

      // ì…ê³ ì˜ˆì •ì¼ 8ìë¦¬ ê²€ì¦
      if (expectedDate.length !== 8) {
        console.log('âš ï¸ ì…ê³ ì˜ˆì •ì¼ í˜•ì‹ ì˜¤ë¥˜:', expectedDate);
        return [];
      }

      // 3. í—¤ë” í–‰ ì°¾ê¸° - Pythonê³¼ ë™ì¼í•˜ê²Œ Col C (ì¸ë±ìŠ¤ 2)ì—ì„œ "ìƒí’ˆëª…" ê²€ìƒ‰
      let headerRow = -1;
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row) continue;
        const cellC = row[2]; // Col C
        if (typeof cellC === 'string' && cellC.includes('ìƒí’ˆëª…')) {
          headerRow = i;
          break;
        }
      }

      console.log('ğŸ“‹ í—¤ë” í–‰:', headerRow !== -1 ? headerRow + 1 : 'not found');

      if (headerRow === -1) {
        console.log('âš ï¸ í—¤ë” í–‰ì„ ì°¾ì§€ ëª»í•¨');
        return [];
      }

      // 4. ë°ì´í„° í–‰ íŒŒì‹± - Python order_processor.pyì™€ ë™ì¼í•œ ë¡œì§
      // ìƒí’ˆ í–‰ê³¼ ë°”ì½”ë“œ í–‰ì´ ë²ˆê°ˆì•„ ë‚˜ì˜´
      // - ìƒí’ˆ í–‰: Col B(1)=SKU, Col C(2)=ìƒí’ˆëª…, Col G(6)=ìˆ˜ëŸ‰, Col J(9)=ë§¤ì…ê°€, Col K(10)=ê³µê¸‰ê°€, Col L(11)=VAT, Col M(12)=ì´ì•¡
      // - ë°”ì½”ë“œ í–‰: Col C(2)ì— "R"ë¡œ ì‹œì‘í•˜ëŠ” ë°”ì½”ë“œ, Col Q(16)=ê´€ë¦¬ì—¬ë¶€(Y), Col R(17)=ë‚ ì§œ
      let lastOrderIdx = null;

      for (let i = headerRow + 1; i < data.length; i++) {
        const row = data[i];
        if (!row) continue;

        const cellC = row[2]; // Col C (ìƒí’ˆëª… or ë°”ì½”ë“œ)
        const cellCStr = cellC ? String(cellC).trim() : '';

        // í•©ê³„ í–‰ ì²´í¬ - í•©ê³„ê°€ ë‚˜ì˜¤ë©´ ì¢…ë£Œ
        if (cellCStr.includes('í•©ê³„') || cellCStr.includes('ì´')) {
          break;
        }

        // ë°”ì½”ë“œ í–‰ ì²´í¬ - "R"ë¡œ ì‹œì‘í•˜ëŠ” ìˆ«ì íŒ¨í„´ (ì˜ˆ: R12345678)
        if (/^R\d+$/.test(cellCStr)) {
          // ì´ì „ ìƒí’ˆì— ë°”ì½”ë“œ ì¶”ê°€
          if (lastOrderIdx !== null && orders[lastOrderIdx]) {
            orders[lastOrderIdx].barcode = cellCStr;

            // ìœ í†µê¸°í•œ ì¶”ì¶œ (Col Q(16)=Yì¼ ë•Œ Col R(17) ê°’)
            const expFlag = row[16] ? String(row[16]).trim().toUpperCase() : '';
            const expDate = row[17];
            if (expFlag === 'Y' && expDate) {
              orders[lastOrderIdx].expirationDate = formatDate(expDate);
            }
          }
          continue; // ë°”ì½”ë“œ í–‰ ì²˜ë¦¬ ì™„ë£Œ, ë‹¤ìŒ í–‰ìœ¼ë¡œ
        }

        // SKU ì²´í¬ (Col B = ì¸ë±ìŠ¤ 1)
        const sku = row[1];
        if (sku === null || sku === undefined || String(sku).trim() === '') {
          continue; // SKUê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        }

        const skuStr = String(sku).trim();
        const productName = cellCStr;

        // ì´ìƒ ë°ì´í„° í•„í„°ë§ - ë©”íƒ€ë°ì´í„° í–‰ ì œì™¸
        const invalidKeywords = ['ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬', 'ì¹´í…Œê³ ë¦¬ ì½”ë“œ', 'ìœ í˜•', 'í•„ìˆ˜', 'ì„ íƒ', 'SKU ID', 'ìš´ì†¡ì¥', 'ì°¨ëŸ‰ë²ˆí˜¸'];
        if (invalidKeywords.some(keyword =>
          skuStr.includes(keyword) || productName.includes(keyword))) {
          console.log(`âš ï¸ ë©”íƒ€ë°ì´í„° í–‰ ìŠ¤í‚µ: SKU="${skuStr}", ìƒí’ˆëª…="${productName}"`);
          continue;
        }
        const quantity = parseInt(row[6]) || 0;  // Col G
        const purchasePrice = parseFloat(String(row[9] || '0').replace(/,/g, '')) || 0;  // Col J
        const supplyPrice = parseFloat(String(row[10] || '0').replace(/,/g, '')) || 0;   // Col K
        const vat = parseFloat(String(row[11] || '0').replace(/,/g, '')) || 0;           // Col L
        const totalAmount = parseFloat(String(row[12] || '0').replace(/,/g, '')) || 0;   // Col M

        // ì œì¡°ì¼ì ì¶”ì¶œ (Col Q(16)=Yì¼ ë•Œ Col R(17) ê°’)
        const mfgFlag = row[16] ? String(row[16]).trim().toUpperCase() : '';
        const mfgDate = row[17];
        const manufactureDate = (mfgFlag === 'Y' && mfgDate) ? formatDate(mfgDate) : '';

        orders.push({
          poNumber: poNumber,
          status: 'ë¯¸í™•ì •',
          center: center,
          expectedDate: expectedDate,
          productCode: skuStr,
          productName: productName,
          barcode: '',  // ë‹¤ìŒ í–‰(ë°”ì½”ë“œ í–‰)ì—ì„œ ì±„ì›Œì§
          quantity: quantity,
          confirmedQuantity: quantity,
          purchasePrice: purchasePrice,
          supplyPrice: supplyPrice,
          vat: vat,
          totalAmount: totalAmount,
          manufacturingDate: manufactureDate,  // ì„œë²„ API í•„ë“œëª…ê³¼ ì¼ì¹˜
          expirationDate: '',  // ë°”ì½”ë“œ í–‰ì—ì„œ ì±„ì›Œì§
          returnManager: returnManager,
          returnManagerPhone: returnTel,  // ì„œë²„ API í•„ë“œëª…ê³¼ ì¼ì¹˜
          returnAddress: returnAddr  // ì„œë²„ API í•„ë“œëª…ê³¼ ì¼ì¹˜
        });

        lastOrderIdx = orders.length - 1;
      }

      console.log(`ğŸ“‹ íŒŒì‹± ì™„ë£Œ: ${orders.length}ê°œ ìƒí’ˆ`);
      if (orders.length > 0) {
        console.log('ğŸ“‹ ì²« ë²ˆì§¸ ìƒí’ˆ:', JSON.stringify(orders[0], null, 2));
      }

      return orders;
    }

    // ì¼ê´„ ì²˜ë¦¬ ì‹œì‘
    async function startAutoProcess() {
      if (isProcessing) return;

      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');

      startBtn.disabled = true;
      stopBtn.disabled = false;
      isProcessing = true;

      // ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
      openProcessModal();

      try {
        const settings = getSettings();
        const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
        addLog('ì¼ê´„ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
        addLog(`ì„¤ì •: ê°œë³„ë§ˆì§„ ${settings.individualMargin}ì›, ì‰½ë¨¼íŠ¸ë§ˆì§„ ${settings.shipmentMargin}ì›, D+${settings.baseDateOffset}`, 'info');

        // Extension ì—°ê²° í™•ì¸
        const connected = await checkExtensionConnection();

        // Step 1: ë°œì£¼ì„œ ì¤€ë¹„
        setStep(1);
        updateProgress(10, 'ë°œì£¼ì„œ ì†ŒìŠ¤ ì¤€ë¹„ ì¤‘...');
        addLog('ë°œì£¼ì„œ ì†ŒìŠ¤ ì¤€ë¹„ ì¤‘...', 'info');

        const folderPath = document.getElementById('folderPath').value;
        let orders = [];

        if (folderPath && selectedFiles.length > 0) {
          // í´ë”ê°€ ì„ íƒëœ ê²½ìš° - íŒŒì¼ì—ì„œ ë°ì´í„° íŒŒì‹±
          addLog(`ì„ íƒëœ í´ë”ì—ì„œ ${selectedFiles.length}ê°œ íŒŒì¼ ì²˜ë¦¬ ì¤‘...`, 'info');

          try {
            orders = await parseSelectedFiles();

            if (orders.length === 0) {
              addLog('íŒŒì‹±ëœ ë°œì£¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
              throw new Error('ë°œì£¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            addLog(`âœ… ${orders.length}ê°œ ë°œì£¼ í•­ëª© ë¡œë“œ ì™„ë£Œ`, 'success');
          } catch (e) {
            addLog('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + e.message, 'error');
            throw e;
          }
        } else if (!folderPath) {
          addLog('í´ë” ë¯¸ì„ íƒ - ì¿ íŒ¡ì—ì„œ ë°œì£¼ì„œë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.', 'info');

          if (connected) {
            // Extensionì„ í†µí•´ ì¿ íŒ¡ ë°œì£¼ ëª©ë¡ ì¡°íšŒ
            try {
              orders = await fetchOrderList(settings);

              if (orders.length === 0) {
                // ì¿ íŒ¡ í˜ì´ì§€ ì—´ê¸° ì•ˆë‚´
                addLog('ë°œì£¼ì„œê°€ ì—†ê±°ë‚˜ ì¿ íŒ¡ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                const openTab = confirm('ì¿ íŒ¡ ë°œì£¼ í˜ì´ì§€ë¥¼ ì—´ê¹Œìš”? ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                if (openTab) {
                  await openCoupangTab();
                }
                throw new Error('ë°œì£¼ì„œ ì¡°íšŒ ì‹¤íŒ¨');
              }
            } catch (e) {
              addLog('Extension ì—°ê²° ì˜¤ë¥˜: ' + e.message, 'warning');
              addLog('ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'info');
              await simulateStep(2000);
              orders = generateMockOrders();
            }
          } else {
            addLog('Extension ë¯¸ì—°ê²° - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'warning');
            await simulateStep(2000);
            orders = generateMockOrders();
          }
        }

        updateProgress(20, 'ë°œì£¼ì„œ ì¡°íšŒ ì™„ë£Œ');

        // ë¯¸í™•ì • í•„í„°ë§ (Step 1ì˜ ì¼ë¶€)
        updateProgress(30, 'ë¯¸í™•ì • ë°œì£¼ì„œ í•„í„°ë§ ì¤‘...');
        addLog('ë¯¸í™•ì • ë°œì£¼ì„œë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤...', 'info');

        // ë¯¸í™•ì • ìƒíƒœ í•„í„°ë§
        const unconfirmedOrders = orders.filter(order => {
          const status = order.status || order.orderStatus || '';
          return status.includes('ë¯¸í™•ì •') || status.includes('ê±°ë˜ì²˜í™•ì¸ìš”ì²­');
        });

        addLog(`ë¯¸í™•ì • ë°œì£¼ì„œ ${unconfirmedOrders.length}ê±´ ë°œê²¬`, 'success');
        updateProgress(40, 'í•„í„°ë§ ì™„ë£Œ');

        // Step 2: ì—‘ì…€ ìƒì„± (ë§ˆì§„ ê³„ì‚° í¬í•¨)
        setStep(2);
        updateProgress(40, 'ë§ˆì§„ ê³„ì‚° ì¤‘...');
        addLog('ë§ˆì§„ ê³„ì‚°ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');

        // ì¬ê³  ë°ì´í„° ë¡œë“œ
        let stockData = null;
        if (settings.processStock) {
          addLog('ì¬ê³  ë°ì´í„° ë¡œë“œ ì¤‘...', 'info');
          stockData = await fetchStockData();
          if (stockData) {
            addLog('ì¬ê³  ë°ì´í„° ë¡œë“œ ì™„ë£Œ', 'success');
          } else {
            addLog('ì¬ê³  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ - ì¬ê³  í™•ì¸ ìƒëµ', 'warning');
          }
        }

        // ë§ˆì§„ ê³„ì‚° ë° ë¶„ë¥˜
        const passedOrders = [];
        const failedOrders = [];

        for (const order of unconfirmedOrders) {
          const result = calculateMargin(order, stockData, settings);
          if (result.pass) {
            passedOrders.push({ ...order, marginResult: result });
          } else {
            failedOrders.push({ ...order, marginResult: result });
            addLog(`ì œì™¸: ${order.poNumber || order.orderNumber} - ${result.reason}`, 'warning');
          }
        }

        addLog(`ë§ˆì§„ ê³„ì‚° ì™„ë£Œ: ì í•© ${passedOrders.length}ê±´, ë¶€ì í•© ${failedOrders.length}ê±´`, 'success');
        updateProgress(60, 'ë§ˆì§„ ê³„ì‚° ì™„ë£Œ');

        if (passedOrders.length === 0) {
          addLog('ì²˜ë¦¬í•  ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
          throw new Error('ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ” ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        // ë°œì£¼ í™•ì • ì–‘ì‹ ìƒì„± (Step 2ì˜ ì¼ë¶€)
        updateProgress(50, 'ë°œì£¼ í™•ì • ì–‘ì‹ ìƒì„± ì¤‘...');
        addLog('ë°œì£¼ í™•ì • ì–‘ì‹ì„ ìƒì„±í•©ë‹ˆë‹¤...', 'info');

        // ë°œì£¼ í™•ì • ì–‘ì‹ ìƒì„± (ì„œë²„ API í˜¸ì¶œ)
        let confirmationFileData = null;
        let confirmationFileName = '';
        try {
          const confirmResponse = await fetch('/api/orders/generate-confirmation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orders: passedOrders, settings })
          });

          if (confirmResponse.ok) {
            const confirmResult = await confirmResponse.json();
            confirmationFileData = confirmResult.fileData;  // Base64 ì¸ì½”ë”©ëœ íŒŒì¼ ë°ì´í„°
            confirmationFileName = confirmResult.filename || 'ë°œì£¼ í™•ì • ì–‘ì‹.xlsx';
            addLog(`âœ… ë°œì£¼ í™•ì • ì–‘ì‹ ìƒì„± ì™„ë£Œ: ${confirmationFileName} (${passedOrders.length}ê±´)`, 'success');
          } else {
            addLog('âš ï¸ ë°œì£¼ í™•ì • ì–‘ì‹ ìƒì„± ì‹¤íŒ¨ - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ', 'warning');
          }
        } catch (e) {
          addLog('âš ï¸ ë°œì£¼ í™•ì • ì–‘ì‹ ìƒì„± API ì˜¤ë¥˜: ' + e.message, 'warning');
        }

        updateProgress(80, 'ë°œì£¼ í™•ì • ì™„ë£Œ');

        // ì‰½ë¨¼íŠ¸ íŒŒì¼ ìƒì„± (Step 2ì˜ ì¼ë¶€)
        updateProgress(60, 'ì‰½ë¨¼íŠ¸ íŒŒì¼ ìƒì„± ì¤‘...');
        addLog('ì‰½ë¨¼íŠ¸ ì¼ê´„ ì–‘ì‹ì„ ìƒì„±í•©ë‹ˆë‹¤...', 'info');

        // ì„¼í„°ë³„ë¡œ ê·¸ë£¹í•‘
        const ordersByCenter = {};
        for (const order of passedOrders) {
          const center = order.center || order.fulfillmentCenter || 'GMK1';
          if (!ordersByCenter[center]) {
            ordersByCenter[center] = [];
          }
          ordersByCenter[center].push(order);
        }

        // ì‰½ë¨¼íŠ¸ íŒŒì¼ ìƒì„± (ì„œë²„ API í˜¸ì¶œ)
        let shipmentFilesData = [];  // ì„¼í„°ë³„ íŒŒì¼ ë°ì´í„° ì €ì¥
        try {
          const shipmentResponse = await fetch('/api/orders/generate-shipments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ordersByCenter, settings })
          });

          if (shipmentResponse.ok) {
            const shipmentResult = await shipmentResponse.json();
            if (shipmentResult.shipments && shipmentResult.shipments.length > 0) {
              shipmentFilesData = shipmentResult.shipments;  // ì„¼í„°ë³„ íŒŒì¼ ë°ì´í„° ë°°ì—´
              shipmentFilesData.forEach(s => {
                addLog(`âœ… ${s.filename} ìƒì„± ì™„ë£Œ (${s.orderCount}ê±´)`, 'success');
              });
            }
          } else {
            addLog('âš ï¸ ì‰½ë¨¼íŠ¸ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ', 'warning');
          }
        } catch (e) {
          addLog('âš ï¸ ì‰½ë¨¼íŠ¸ íŒŒì¼ ìƒì„± API ì˜¤ë¥˜: ' + e.message, 'warning');
        }

        // Step 3: ë°œì£¼ ì—…ë¡œë“œ
        setStep(3);
        updateProgress(70, 'ë°œì£¼ í™•ì • ì—…ë¡œë“œ ì¤‘...');
        addLog('ë°œì£¼ í™•ì • ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');

        let orderConfirmationSuccess = false;

        if (extensionConnected && confirmationFileData) {
          try {
            addLog('ğŸ“¤ ë°œì£¼ í™•ì • íŒŒì¼ì„ ì¿ íŒ¡ì— ì—…ë¡œë“œ ì¤‘...', 'info');
            addLog('â³ ì¿ íŒ¡ í˜ì´ì§€ ë¡œë”© ëŒ€ê¸° ì¤‘... (ì•½ 10ì´ˆ ì†Œìš”)', 'info');

            // ì„œë²„ì—ì„œ ìƒì„±ëœ ë°œì£¼ í™•ì • ì–‘ì‹ì„ Extensionì„ í†µí•´ ì¿ íŒ¡ì— ì—…ë¡œë“œ
            const uploadOrderResponse = await sendMessageToExtension({
              action: 'uploadOrderConfirmation',
              orderData: {
                fileData: confirmationFileData,  // Base64 ì¸ì½”ë”©ëœ Excel íŒŒì¼ ë°ì´í„°
                fileName: confirmationFileName,
                orders: passedOrders
              }
            });

            if (uploadOrderResponse && uploadOrderResponse.success) {
              // ë©”ì‹œì§€ì— "ê²€ì¦ ì‹¤íŒ¨"ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
              const message = uploadOrderResponse.message || '';
              if (message.includes('ê²€ì¦ ì‹¤íŒ¨') || message.includes('ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨')) {
                addLog(`âŒ ë°œì£¼ í™•ì • ì—…ë¡œë“œ ì‹¤íŒ¨: ${message}`, 'error');
                showOrderConfirmFailModal(message);
                orderConfirmationSuccess = false;
              } else {
                addLog(`âœ… ë°œì£¼ í™•ì • ì—…ë¡œë“œ ì™„ë£Œ: ${message}`, 'success');
                orderConfirmationSuccess = true;
              }
            } else {
              addLog(`âš ï¸ ë°œì£¼ í™•ì • ì—…ë¡œë“œ: ${uploadOrderResponse?.message || 'ê²°ê³¼ í™•ì¸ í•„ìš”'}`, 'warning');
              orderConfirmationSuccess = true; // ì‘ë‹µì´ ì™”ìœ¼ë©´ ì¼ë‹¨ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
            }
          } catch (e) {
            addLog('âŒ ë°œì£¼ í™•ì • ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
            addLog('ğŸ’¡ ì„œë²„ì˜ output í´ë”ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ìˆ˜ë™ ì—…ë¡œë“œí•˜ì„¸ìš”.', 'info');
            addLog('âš ï¸ ë°œì£¼ í™•ì •ì´ ì‹¤íŒ¨í•˜ì—¬ ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.', 'warning');
          }
        } else if (!confirmationFileData) {
          addLog('âš ï¸ ë°œì£¼ í™•ì • íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ - ìˆ˜ë™ ì—…ë¡œë“œ í•„ìš”', 'warning');
        } else {
          addLog('âš ï¸ Extension ë¯¸ì—°ê²° - ìˆ˜ë™ ì—…ë¡œë“œ í•„ìš”', 'warning');
          addLog(`ğŸ’¡ "${confirmationFileName}" íŒŒì¼ì„ ì¿ íŒ¡ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”.`, 'info');
        }

        updateProgress(90, 'ë°œì£¼ í™•ì • ì—…ë¡œë“œ ì™„ë£Œ');

        // Step 4: ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ
        setStep(4);
        updateProgress(80, 'ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ ì¤‘...');

        const uploadedShipments = []; // ì—…ë¡œë“œëœ ì‰½ë¨¼íŠ¸ ì •ë³´ ì €ì¥
        const failedShipments = [];   // ì‹¤íŒ¨í•œ ì‰½ë¨¼íŠ¸ ëª©ë¡
        const successShipments = [];  // ì„±ê³µí•œ ì‰½ë¨¼íŠ¸ ëª©ë¡

        if (orderConfirmationSuccess && extensionConnected && shipmentFilesData.length > 0) {
          // ë°œì£¼ í™•ì • ì™„ë£Œ í›„ ì‰½ë¨¼íŠ¸ ì‹œì‘ ì „ ëŒ€ê¸° (í˜ì´ì§€ ì „í™˜ ì‹œê°„)
          addLog('â³ ë°œì£¼ í™•ì • ì™„ë£Œ, 5ì´ˆ í›„ ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ ì‹œì‘...', 'info');
          await simulateStep(5000);

          addLog(`ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤... (ì´ ${shipmentFilesData.length}ê°œ íŒŒì¼)`, 'info');

          // ì„¼í„°ë³„ë¡œ ì‰½ë¨¼íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
          for (let i = 0; i < shipmentFilesData.length; i++) {
            const shipmentFile = shipmentFilesData[i];
            addLog(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
            addLog(`ğŸ“¤ [${i + 1}/${shipmentFilesData.length}] ${shipmentFile.center} ì„¼í„° ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ ì¤‘...`, 'info');
            addLog(`   ğŸ“ íŒŒì¼: ${shipmentFile.filename}`, 'info');
            addLog(`   ğŸ“… ì…ê³ ì˜ˆì •ì¼: ${shipmentFile.expectedDate}`, 'info');
            addLog(`   ğŸ“¦ ìƒí’ˆ ìˆ˜: ${shipmentFile.orderCount}ê±´`, 'info');

            try {
              const uploadShipmentResponse = await sendMessageToExtension({
                action: 'uploadShipment',
                shipmentData: {
                  fileData: shipmentFile.fileData,
                  fileName: shipmentFile.filename,
                  center: shipmentFile.center,
                  expectedDate: shipmentFile.expectedDate,
                  orderCount: shipmentFile.orderCount
                }
              });

              // ì‘ë‹µ ìƒíƒœì— ë”°ë¥¸ ì²˜ë¦¬
              const status = uploadShipmentResponse?.status || 'unknown';
              const message = uploadShipmentResponse?.message || '';
              const failReason = uploadShipmentResponse?.failReason || '';

              if (uploadShipmentResponse && uploadShipmentResponse.success && status !== 'failed') {
                if (status === 'completed') {
                  addLog(`   âœ… ì—…ë¡œë“œ ì„±ê³µ: ${message}`, 'success');
                  successShipments.push({
                    center: shipmentFile.center,
                    expectedDate: shipmentFile.expectedDate,
                    filename: shipmentFile.filename,
                    message: message
                  });
                } else if (status === 'unknown') {
                  addLog(`   âš ï¸ ì—…ë¡œë“œ ì™„ë£Œ (ê²°ê³¼ í™•ì¸ í•„ìš”)`, 'warning');
                  addLog(`   ğŸ’¡ ì¿ íŒ¡ ì‰½ë¨¼íŠ¸ í˜ì´ì§€ì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”`, 'info');
                  successShipments.push({
                    center: shipmentFile.center,
                    expectedDate: shipmentFile.expectedDate,
                    filename: shipmentFile.filename,
                    message: 'ê²°ê³¼ í™•ì¸ í•„ìš”',
                    needsManualCheck: true
                  });
                } else {
                  addLog(`   âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${message || 'ì²˜ë¦¬ë¨'}`, 'success');
                  successShipments.push({
                    center: shipmentFile.center,
                    expectedDate: shipmentFile.expectedDate,
                    filename: shipmentFile.filename,
                    message: message
                  });
                }
              } else {
                // ì‹¤íŒ¨
                const errorMsg = uploadShipmentResponse?.error || message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                addLog(`   âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${errorMsg}`, 'error');
                if (failReason) {
                  addLog(`   ğŸ“‹ ì‹¤íŒ¨ ì‚¬ìœ : ${failReason}`, 'error');
                }
                failedShipments.push({
                  center: shipmentFile.center,
                  expectedDate: shipmentFile.expectedDate,
                  filename: shipmentFile.filename,
                  error: errorMsg,
                  failReason: failReason
                });
              }
            } catch (e) {
              addLog(`   âŒ ì—…ë¡œë“œ ì˜¤ë¥˜: ${e.message}`, 'error');
              failedShipments.push({
                center: shipmentFile.center,
                expectedDate: shipmentFile.expectedDate,
                filename: shipmentFile.filename,
                error: e.message
              });
            }

            // ë‹¤ìŒ ì„¼í„° ì—…ë¡œë“œ ì „ ëŒ€ê¸°
            if (i < shipmentFilesData.length - 1) {
              addLog('   â³ ë‹¤ìŒ íŒŒì¼ ì—…ë¡œë“œ ëŒ€ê¸° ì¤‘ (5ì´ˆ)...', 'info');
              await simulateStep(5000);
            }
          }

          addLog(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');

          // ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ ê²°ê³¼ ìš”ì•½
          addLog(`ğŸ“Š ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ ê²°ê³¼: ì„±ê³µ ${successShipments.length}ê°œ, ì‹¤íŒ¨ ${failedShipments.length}ê°œ`,
                 failedShipments.length > 0 ? 'warning' : 'success');

          // ì‹¤íŒ¨í•œ í•­ëª© ìƒì„¸ í‘œì‹œ (Python totalbot ë°©ì‹)
          if (failedShipments.length > 0) {
            addLog('', 'info');
            addLog('âŒ ========== ì‹¤íŒ¨í•œ ì‰½ë¨¼íŠ¸ ëª©ë¡ ==========', 'error');
            failedShipments.forEach((f, idx) => {
              addLog(`   [${idx + 1}] ${f.center} - ${f.filename}`, 'error');
              addLog(`       ì‚¬ìœ : ${f.failReason || f.error}`, 'error');
            });
            addLog('', 'info');
            addLog('ğŸ’¡ ìˆ˜ë™ ì²˜ë¦¬ ì•ˆë‚´:', 'warning');
            addLog('   1. ì¿ íŒ¡ Wing > ì…ê³ ê´€ë¦¬ > ì‰½ë¨¼íŠ¸ ì¼ê´„ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™', 'info');
            addLog('   2. ì„œë²„ì˜ output í´ë”ì—ì„œ ì‹¤íŒ¨í•œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ', 'info');
            addLog('   3. ìˆ˜ë™ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ ë° ë“±ë¡', 'info');
            addLog('   URL: https://supplier.coupang.com/ibs/shipment/parcel/bulk-creation/upload', 'info');
          }

          // Step 5: ë¬¸ì„œ ì €ì¥ (ì„±ê³µí•œ ì‰½ë¨¼íŠ¸ì˜ ë¼ë²¨/ë‚´ì—­ì„œ ë‹¤ìš´ë¡œë“œ)
          if (successShipments.length > 0) {
            setStep(5);
            updateProgress(95, 'ë¬¸ì„œ ì €ì¥ ì¤‘...');
            addLog('', 'info');
            addLog('ğŸ” ì‰½ë¨¼íŠ¸ ê²€ìƒ‰ ë° ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ ì¤‘...', 'info');
            addLog('   (ë°œì£¼ë²ˆí˜¸ë¡œ ì‰½ë¨¼íŠ¸ ì¡°íšŒ â†’ ë¼ë²¨/ë‚´ì—­ì„œ PDF ë‹¤ìš´ë¡œë“œ)', 'info');
            await simulateStep(3000);

            try {
              const poNumbers = [...new Set(passedOrders.map(o => o.poNumber))];
              addLog(`   ğŸ“‹ ì²˜ë¦¬í•  ë°œì£¼ë²ˆí˜¸: ${poNumbers.length}ê°œ`, 'info');

              // ì‰½ë¨¼íŠ¸ í›„ì²˜ë¦¬ (ê²€ìƒ‰ + ë‹¤ìš´ë¡œë“œ) ìš”ì²­
              const postProcessResponse = await sendMessageToExtension({
                action: 'processShipmentAfterUpload',
                poNumbers: poNumbers
              });

              if (postProcessResponse && postProcessResponse.success) {
                const { shipments, downloads, failed } = postProcessResponse;

                // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                if (shipments && shipments.length > 0) {
                  addLog('', 'info');
                  addLog(`âœ… ${shipments.length}ê°œ ì‰½ë¨¼íŠ¸ ì¡°íšŒ ì™„ë£Œ:`, 'success');
                  shipments.forEach(s => {
                    addLog(`   ğŸ“‹ ${s.poNumber} â†’ parcelShipmentSeq: ${s.parcelShipmentSeq}`, 'success');
                  });
                }

                // ë‹¤ìš´ë¡œë“œ ê²°ê³¼ í‘œì‹œ ë° ì„œë²„ì— ì €ì¥
                if (downloads && downloads.length > 0) {
                  addLog('', 'info');
                  addLog(`ğŸ“¦ ${downloads.length}ê°œ ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:`, 'success');

                  for (const doc of downloads) {
                    addLog(`   ğŸ“„ ë°œì£¼ ${doc.poNumber}:`, 'info');

                    // ë¼ë²¨ ì €ì¥
                    if (doc.label && doc.label.success && doc.label.data) {
                      try {
                        const labelSaveResponse = await fetch('/api/orders/save-pdf', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            fileData: doc.label.data,
                            fileName: `ë¼ë²¨_${doc.parcelShipmentSeq}.pdf`,
                            type: 'label'
                          })
                        });
                        if (labelSaveResponse.ok) {
                          addLog(`      ğŸ·ï¸ ë¼ë²¨ ì €ì¥ ì™„ë£Œ: ë¼ë²¨_${doc.parcelShipmentSeq}.pdf`, 'success');
                        }
                      } catch (e) {
                        addLog(`      âš ï¸ ë¼ë²¨ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'warning');
                      }
                    }

                    // ë‚´ì—­ì„œ ì €ì¥
                    if (doc.manifest && doc.manifest.success && doc.manifest.data) {
                      try {
                        const manifestSaveResponse = await fetch('/api/orders/save-pdf', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            fileData: doc.manifest.data,
                            fileName: `ë‚´ì—­ì„œ_${doc.parcelShipmentSeq}.pdf`,
                            type: 'manifest'
                          })
                        });
                        if (manifestSaveResponse.ok) {
                          addLog(`      ğŸ“„ ë‚´ì—­ì„œ ì €ì¥ ì™„ë£Œ: ë‚´ì—­ì„œ_${doc.parcelShipmentSeq}.pdf`, 'success');
                        }
                      } catch (e) {
                        addLog(`      âš ï¸ ë‚´ì—­ì„œ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'warning');
                      }
                    }
                  }
                }

                // ì‹¤íŒ¨ í•­ëª© í‘œì‹œ
                if (failed && failed.length > 0) {
                  addLog('', 'info');
                  addLog(`âš ï¸ ${failed.length}ê°œ ë°œì£¼ ì²˜ë¦¬ ì‹¤íŒ¨:`, 'warning');
                  failed.forEach(f => {
                    addLog(`   âŒ ${f.poNumber}: ${f.error}`, 'error');
                  });
                }

              } else {
                addLog('âš ï¸ ì‰½ë¨¼íŠ¸ í›„ì²˜ë¦¬ ì‹¤íŒ¨: ' + (postProcessResponse?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'warning');
                addLog('ğŸ’¡ ì¿ íŒ¡ì—ì„œ ì‰½ë¨¼íŠ¸ ë²ˆí˜¸ë¥¼ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.', 'info');
              }
            } catch (e) {
              addLog('âš ï¸ ì‰½ë¨¼íŠ¸ í›„ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.message, 'warning');
              addLog('ğŸ’¡ ì¿ íŒ¡ì—ì„œ ì‰½ë¨¼íŠ¸ ë²ˆí˜¸ë¥¼ ì§ì ‘ í™•ì¸í•˜ê³  ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.', 'info');
            }
          }

        } else if (!orderConfirmationSuccess) {
          addLog('âŒ ë°œì£¼ í™•ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.', 'error');
          addLog('', 'info');
          addLog('ğŸ’¡ ìˆ˜ë™ ì²˜ë¦¬ ì•ˆë‚´:', 'warning');
          addLog('   1. ë¨¼ì € ë°œì£¼ í™•ì • íŒŒì¼ì„ ì¿ íŒ¡ì—ì„œ ìˆ˜ë™ ì—…ë¡œë“œí•˜ì„¸ìš”', 'info');
          addLog('   URL: https://supplier.coupang.com/scm/purchase/upload/form', 'info');
          addLog('   2. ë°œì£¼ í™•ì • ì™„ë£Œ í›„ ì‰½ë¨¼íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”', 'info');
          addLog('   URL: https://supplier.coupang.com/ibs/shipment/parcel/bulk-creation/upload', 'info');

          // ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ
          if (shipmentFilesData.length > 0) {
            addLog('', 'info');
            addLog('ğŸ“ ìƒì„±ëœ ì‰½ë¨¼íŠ¸ íŒŒì¼ ëª©ë¡:', 'info');
            shipmentFilesData.forEach((f, idx) => {
              addLog(`   [${idx + 1}] ${f.filename} (${f.center}, ${f.orderCount}ê±´)`, 'info');
            });
          }
        } else if (shipmentFilesData.length === 0) {
          addLog('âš ï¸ ì‰½ë¨¼íŠ¸ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'warning');
        } else {
          addLog('âš ï¸ Extension ë¯¸ì—°ê²° - ìˆ˜ë™ ì—…ë¡œë“œ í•„ìš”', 'warning');
          addLog('', 'info');
          addLog('ğŸ’¡ ìˆ˜ë™ ì²˜ë¦¬ ì•ˆë‚´:', 'warning');
          addLog('   1. Chrome Extensionì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”', 'info');
          addLog('   2. ì„œë²„ì˜ output í´ë”ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”', 'info');
          addLog('   3. ì¿ íŒ¡ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”', 'info');

          if (shipmentFilesData.length > 0) {
            addLog('', 'info');
            addLog('ğŸ“ ìˆ˜ë™ ì—…ë¡œë“œí•  íŒŒì¼ ëª©ë¡:', 'info');
            shipmentFilesData.forEach((f, idx) => {
              addLog(`   [${idx + 1}] ${f.filename} (${f.center}, ${f.orderCount}ê±´)`, 'info');
            });
          }
        }

        // ì™„ë£Œ
        updateProgress(100, 'ì²˜ë¦¬ ì™„ë£Œ');
        addLog('', 'info');
        addLog('âœ… ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        showToast('ì¼ê´„ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', 5000);

        // ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½
        addLog('', 'info');
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        addLog('ğŸ“Š ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½', 'info');
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        addLog(`   ğŸ“‹ ì „ì²´ ë°œì£¼ì„œ: ${orders.length}ê±´`, 'info');
        addLog(`   ğŸ“‹ ë¯¸í™•ì • ë°œì£¼ì„œ: ${unconfirmedOrders.length}ê±´`, 'info');
        addLog(`   âœ… ì²˜ë¦¬ëœ ë°œì£¼ì„œ: ${passedOrders.length}ê±´`, 'success');
        addLog(`   âŒ ì œì™¸ëœ ë°œì£¼ì„œ: ${failedOrders.length}ê±´`, failedOrders.length > 0 ? 'warning' : 'info');
        addLog('', 'info');
        addLog(`   ğŸ“¤ ì‰½ë¨¼íŠ¸ ì—…ë¡œë“œ: ì„±ê³µ ${successShipments.length}ê°œ / ì‹¤íŒ¨ ${failedShipments.length}ê°œ`,
               failedShipments.length > 0 ? 'warning' : 'success');

        if (extensionConnected) {
          addLog(`   ğŸ”— ì—…ë¡œë“œ ë°©ì‹: Extension ìë™ ì—…ë¡œë“œ`, 'info');
        } else {
          addLog(`   âš ï¸ ì—…ë¡œë“œ ë°©ì‹: ìˆ˜ë™ ì—…ë¡œë“œ í•„ìš”`, 'warning');
        }

        if (failedShipments.length > 0) {
          addLog('', 'info');
          addLog('âš ï¸ ì‹¤íŒ¨í•œ ì‰½ë¨¼íŠ¸ëŠ” ìœ„ì˜ ì•ˆë‚´ì— ë”°ë¼ ìˆ˜ë™ ì²˜ë¦¬í•˜ì„¸ìš”.', 'warning');
        }

      } catch (error) {
        addLog('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
        showToast('ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
        completeProcessModal(false);
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        isProcessing = false;
        // ì •ìƒ ì™„ë£Œ ì‹œ ëª¨ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        completeProcessModal(true);
      }
    }

    /**
     * í…ŒìŠ¤íŠ¸ìš© ëª©ì—… ë°œì£¼ ë°ì´í„° ìƒì„±
     */
    function generateMockOrders() {
      const centers = ['GMK1', 'GMK2', 'GMK3'];
      const statuses = ['ë¯¸í™•ì •', 'ê±°ë˜ì²˜í™•ì¸ìš”ì²­'];
      const orders = [];

      for (let i = 1; i <= 5; i++) {
        const baseDate = new Date();
        baseDate.setDate(baseDate.getDate() + Math.floor(Math.random() * 7) + 3);

        orders.push({
          poNumber: `PO-2025${String(i).padStart(6, '0')}`,
          status: statuses[Math.floor(Math.random() * statuses.length)],
          center: centers[Math.floor(Math.random() * centers.length)],
          expectedDate: baseDate.toISOString().split('T')[0].replace(/-/g, ''),
          productName: `í…ŒìŠ¤íŠ¸ ìƒí’ˆ ${i}`,
          barcode: `R${100000 + i}`,
          quantity: Math.floor(Math.random() * 10) + 1,
          purchasePrice: 10000 + Math.floor(Math.random() * 5000),
          supplyPrice: 15000 + Math.floor(Math.random() * 5000)
        });
      }

      return orders;
    }

    // ì²˜ë¦¬ ì¤‘ì§€
    function stopProcess() {
      isProcessing = false;
      addLog('ì²˜ë¦¬ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
      showToast('ì²˜ë¦¬ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');

      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;

      updateProgress(0, 'ì¤‘ì§€ë¨');
      setStep(0);

      // ëª¨ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      completeProcessModal(false);
    }

    // ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    function getSettings() {
      return {
        individualMargin: parseInt(document.getElementById('individualMargin').value) || 1000,
        shipmentMargin: parseInt(document.getElementById('shipmentMargin').value) || 5000,
        baseDateOffset: parseInt(document.getElementById('baseDateOffset').value) || 3,
        processAll: document.getElementById('processAll').checked,
        processStock: document.getElementById('processStock').checked,
        centerFilters: centerFilters,
        excludedBarcodes: Array.from(excludedBarcodes)
      };
    }

    // í•„í„° ì¶”ê°€
    function addFilter() {
      const filterList = document.getElementById('filterList');

      // ë¹ˆ ë©”ì‹œì§€ ì œê±°
      if (centerFilters.length === 0) {
        filterList.innerHTML = '';
      }

      const filterId = Date.now();
      centerFilters.push({ id: filterId, center: '', date: '' });

      const filterHtml = `
        <div class="filter-item" id="filter-${filterId}">
          <select onchange="updateFilter(${filterId}, 'center', this.value)">
            <option value="">ì„¼í„° ì„ íƒ</option>
            <option value="GMK1">GMK1</option>
            <option value="GMK2">GMK2</option>
            <option value="GMK3">GMK3</option>
            <option value="GMK4">GMK4</option>
            <option value="GMK5">GMK5</option>
          </select>
          <input type="date" onchange="updateFilter(${filterId}, 'date', this.value)">
          <button class="btn-remove" onclick="removeFilter(${filterId})">ì‚­ì œ</button>
        </div>
      `;

      filterList.insertAdjacentHTML('beforeend', filterHtml);
      saveSettings();
    }

    // í•„í„° ì—…ë°ì´íŠ¸
    function updateFilter(id, field, value) {
      const filter = centerFilters.find(f => f.id === id);
      if (filter) {
        filter[field] = value;
        saveSettings();
      }
    }

    // í•„í„° ì œê±°
    function removeFilter(id) {
      centerFilters = centerFilters.filter(f => f.id !== id);
      document.getElementById(`filter-${id}`).remove();

      if (centerFilters.length === 0) {
        document.getElementById('filterList').innerHTML = `
          <div style="color: #888; text-align: center; padding: 20px;">
            í•„í„°ë¥¼ ì¶”ê°€í•˜ë©´ íŠ¹ì • ì„¼í„°/ì…ê³ ì¼ ì¡°í•©ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
          </div>
        `;
      }
      saveSettings();
    }

    // ì œì™¸ ë°”ì½”ë“œ ëª¨ë‹¬ ì—´ê¸°
    function openExcludeBarcodeModal() {
      document.getElementById('excludeBarcodeModal').style.display = 'flex';
      renderExcludedBarcodes();
    }

    // ì œì™¸ ë°”ì½”ë“œ ëª¨ë‹¬ ë‹«ê¸°
    function closeExcludeBarcodeModal() {
      document.getElementById('excludeBarcodeModal').style.display = 'none';
    }

    // ë°œì£¼ í™•ì • ì‹¤íŒ¨ ëª¨ë‹¬ ì—´ê¸°
    function showOrderConfirmFailModal(message) {
      document.getElementById('orderConfirmFailMessage').textContent = message;
      document.getElementById('orderConfirmFailModal').style.display = 'flex';
    }

    // ë°œì£¼ í™•ì • ì‹¤íŒ¨ ëª¨ë‹¬ ë‹«ê¸°
    function closeOrderConfirmFailModal() {
      document.getElementById('orderConfirmFailModal').style.display = 'none';
    }

    // ì œì™¸ ë°”ì½”ë“œ ì¶”ê°€
    function addExcludedBarcode() {
      const input = document.getElementById('newBarcodeInput');
      const barcode = input.value.trim().toUpperCase();

      if (!barcode.startsWith('R')) {
        showToast('ë°”ì½”ë“œëŠ” Rë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        return;
      }

      if (excludedBarcodes.has(barcode)) {
        showToast('ì´ë¯¸ ì¶”ê°€ëœ ë°”ì½”ë“œì…ë‹ˆë‹¤.', 'warning');
        return;
      }

      excludedBarcodes.add(barcode);
      input.value = '';
      renderExcludedBarcodes();
      saveSettings();
      showToast(`${barcode} ì¶”ê°€ë¨`, 'success');
    }

    // ì œì™¸ ë°”ì½”ë“œ ì œê±°
    function removeExcludedBarcode(barcode) {
      excludedBarcodes.delete(barcode);
      renderExcludedBarcodes();
      saveSettings();
    }

    // ì œì™¸ ë°”ì½”ë“œ ëª©ë¡ ë Œë”ë§
    function renderExcludedBarcodes() {
      const list = document.getElementById('excludedBarcodeList');
      document.getElementById('excludedCount').textContent = excludedBarcodes.size;

      if (excludedBarcodes.size === 0) {
        list.innerHTML = '<div style="color: #888; text-align: center;">ì œì™¸ëœ ë°”ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      list.innerHTML = Array.from(excludedBarcodes).map(barcode => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; margin-bottom: 4px;">
          <code style="font-size: 13px;">${barcode}</code>
          <button onclick="removeExcludedBarcode('${barcode}')" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    // ì„¤ì • ì €ì¥
    function saveSettings() {
      const settings = getSettings();
      localStorage.setItem('orderSettings', JSON.stringify(settings));
    }

    // ì„¤ì • ë¡œë“œ
    function loadSettings() {
      const saved = localStorage.getItem('orderSettings');
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          document.getElementById('individualMargin').value = settings.individualMargin || 1000;
          document.getElementById('shipmentMargin').value = settings.shipmentMargin || 5000;
          document.getElementById('baseDateOffset').value = settings.baseDateOffset || 3;
          document.getElementById('processAll').checked = settings.processAll || false;
          document.getElementById('processStock').checked = settings.processStock || false;

          if (settings.excludedBarcodes) {
            excludedBarcodes = new Set(settings.excludedBarcodes);
            document.getElementById('excludedCount').textContent = excludedBarcodes.size;
          }

          if (settings.centerFilters && settings.centerFilters.length > 0) {
            settings.centerFilters.forEach(filter => {
              centerFilters.push(filter);
              const filterList = document.getElementById('filterList');
              if (centerFilters.length === 1) {
                filterList.innerHTML = '';
              }
              filterList.insertAdjacentHTML('beforeend', `
                <div class="filter-item" id="filter-${filter.id}">
                  <select onchange="updateFilter(${filter.id}, 'center', this.value)">
                    <option value="">ì„¼í„° ì„ íƒ</option>
                    <option value="GMK1" ${filter.center === 'GMK1' ? 'selected' : ''}>GMK1</option>
                    <option value="GMK2" ${filter.center === 'GMK2' ? 'selected' : ''}>GMK2</option>
                    <option value="GMK3" ${filter.center === 'GMK3' ? 'selected' : ''}>GMK3</option>
                    <option value="GMK4" ${filter.center === 'GMK4' ? 'selected' : ''}>GMK4</option>
                    <option value="GMK5" ${filter.center === 'GMK5' ? 'selected' : ''}>GMK5</option>
                  </select>
                  <input type="date" value="${filter.date || ''}" onchange="updateFilter(${filter.id}, 'date', this.value)">
                  <button class="btn-remove" onclick="removeFilter(${filter.id})">ì‚­ì œ</button>
                </div>
              `);
            });
          }

          addLog('ì €ì¥ëœ ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
        } catch (e) {
          console.error('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        }
      }
    }

    // ìœ í‹¸ë¦¬í‹°: ì‹œë®¬ë ˆì´ì…˜ ëŒ€ê¸°
    function simulateStep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ìœ í‹¸ë¦¬í‹°: ë‚ ì§œ í¬ë§·íŒ… (YYYYMMDD)
    function getFormattedDate(offsetDays = 0) {
      const date = new Date();
      date.setDate(date.getDate() + offsetDays);
      return date.toISOString().split('T')[0].replace(/-/g, '');
    }

    // ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì €ì¥
    document.querySelectorAll('input[type="number"], input[type="checkbox"]').forEach(input => {
      input.addEventListener('change', saveSettings);
    });

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async () => {
      loadSettings();
      addLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');

      // Extension ì—°ê²° ìƒíƒœ í™•ì¸
      setTimeout(async () => {
        const connected = await checkExtensionConnection();
        if (!connected) {
          addLog('ğŸ’¡ Chrome Extensionì„ ì„¤ì¹˜í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì¿ íŒ¡ ì—°ë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'info');
          addLog('ğŸ’¡ Extension ì—†ì´ë„ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        }
      }, 1000);
    });

    // Extension ë©”ì‹œì§€ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('message', (event) => {
      // Extensionìœ¼ë¡œë¶€í„° ë°›ì€ ì•Œë¦¼ ì²˜ë¦¬
      if (event.data && event.data.type === 'TOTALBOT_NOTIFICATION') {
        const { notificationType, data } = event.data;

        switch (notificationType) {
          case 'downloadComplete':
            addLog(`ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${data.filename}`, 'success');
            break;
          case 'loginRequired':
            addLog('ì¿ íŒ¡ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            showToast('ì¿ íŒ¡ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            break;
          case 'error':
            addLog(`ì˜¤ë¥˜: ${data.message}`, 'error');
            break;
        }
      }
    });
  </script>
</body>
</html>
