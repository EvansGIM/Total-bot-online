/**
 * TotalBot Content Script (ì™„ì „ êµ¬í˜„)
 * - 1688, ì¿ íŒ¡, ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤ ìƒí’ˆ í¬ë¡¤ë§
 * - ì›¹íŽ˜ì´ì§€ DOM ì§ì ‘ ì¡°ìž‘
 */

import { crawl1688Product } from './crawlers/1688.js';
import { crawlCoupangProduct } from './crawlers/coupang.js';
import { crawlAliexpressProduct } from './crawlers/aliexpress.js';

console.log('[TotalBot] Content Script ë¡œë“œë¨:', window.location.href);

// í˜„ìž¬ íŽ˜ì´ì§€ ìœ í˜• ê°ì§€
function detectPageType() {
  const url = window.location.href;
  const hostname = window.location.hostname;

  if (hostname.includes('1688.com')) {
    if (url.includes('/offer/') || url.includes('detail.1688.com')) {
      return '1688-product';
    }
    return '1688-other';
  } else if (hostname.includes('coupang.com')) {
    if (url.includes('/vp/products/')) {
      return 'coupang-product';
    }
    return 'coupang-other';
  } else if (hostname.includes('aliexpress.com')) {
    if (url.includes('/item/')) {
      return 'aliexpress-product';
    }
    return 'aliexpress-other';
  }

  return 'unknown';
}

// Background Scriptë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('[Content] ë©”ì‹œì§€ ìˆ˜ì‹ :', request.action);

  if (request.action === 'extractProductData') {
    handleExtractProductData(sendResponse);
    return true; // ë¹„ë™ê¸° ì‘ë‹µ
  }

  return false;
});

// ìƒí’ˆ ë°ì´í„° ì¶”ì¶œ í•¸ë“¤ëŸ¬
async function handleExtractProductData(sendResponse) {
  try {
    const pageType = detectPageType();
    console.log('[Content] íŽ˜ì´ì§€ ìœ í˜•:', pageType);

    let result = null;

    switch (pageType) {
      case '1688-product':
        result = await crawl1688Product();
        break;

      case 'coupang-product':
        result = await crawlCoupangProduct();
        break;

      case 'aliexpress-product':
        result = await crawlAliexpressProduct();
        break;

      default:
        sendResponse({
          success: false,
          error: 'ì§€ì›í•˜ì§€ ì•ŠëŠ” íŽ˜ì´ì§€ìž…ë‹ˆë‹¤. ìƒí’ˆ íŽ˜ì´ì§€ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'
        });
        return;
    }

    if (result && result.results && result.results.length > 0) {
      console.log('[Content] ë°ì´í„° ì¶”ì¶œ ì„±ê³µ:', result.results.length, 'ê°œ');

      sendResponse({
        success: true,
        data: result,
        pageType: pageType
      });
    } else {
      sendResponse({
        success: false,
        error: 'ë°ì´í„°ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

  } catch (error) {
    console.error('[Content] ì¶”ì¶œ ì˜¤ë¥˜:', error);
    sendResponse({
      success: false,
      error: error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
}

// íŽ˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ìžë™ ê°ì§€
window.addEventListener('load', () => {
  const pageType = detectPageType();
  console.log('[TotalBot] íŽ˜ì´ì§€ ìœ í˜• ê°ì§€:', pageType);

  // ìƒí’ˆ íŽ˜ì´ì§€ë©´ ì•„ì´ì½˜ í‘œì‹œ (ì„ íƒì‚¬í•­)
  if (pageType.includes('product')) {
    console.log('[TotalBot] ìƒí’ˆ íŽ˜ì´ì§€ ê°ì§€ë¨ - í¬ë¡¤ë§ ê°€ëŠ¥');

    // íŽ˜ì´ì§€ì— í‘œì‹œê¸° ì¶”ê°€ (ì„ íƒì‚¬í•­)
    showCrawlIndicator();
  }
});

// í¬ë¡¤ë§ ê°€ëŠ¥ í‘œì‹œê¸° (ì„ íƒì‚¬í•­)
function showCrawlIndicator() {
  // ì´ë¯¸ í‘œì‹œê¸°ê°€ ìžˆìœ¼ë©´ ë¦¬í„´
  if (document.querySelector('#totalbot-indicator')) return;

  const indicator = document.createElement('div');
  indicator.id = 'totalbot-indicator';
  indicator.innerHTML = 'ðŸ¤– TotalBot';
  indicator.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 24px;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 999999;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Nanum Gothic', sans-serif;
  `;

  indicator.addEventListener('mouseenter', () => {
    indicator.style.transform = 'scale(1.05)';
    indicator.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)';
  });

  indicator.addEventListener('mouseleave', () => {
    indicator.style.transform = 'scale(1)';
    indicator.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  });

  indicator.addEventListener('click', async () => {
    indicator.innerHTML = 'â³ ìˆ˜ì§‘ ì¤‘...';
    indicator.style.pointerEvents = 'none';

    try {
      const response = await new Promise((resolve) => {
        chrome.runtime.sendMessage(
          { action: 'extractProductData' },
          resolve
        );
      });

      if (response && response.success) {
        indicator.innerHTML = 'âœ… ì™„ë£Œ!';
        setTimeout(() => {
          indicator.innerHTML = 'ðŸ¤– TotalBot';
          indicator.style.pointerEvents = 'auto';
        }, 2000);
      } else {
        indicator.innerHTML = 'âŒ ì‹¤íŒ¨';
        setTimeout(() => {
          indicator.innerHTML = 'ðŸ¤– TotalBot';
          indicator.style.pointerEvents = 'auto';
        }, 2000);
      }
    } catch (error) {
      console.error('í¬ë¡¤ë§ ì˜¤ë¥˜:', error);
      indicator.innerHTML = 'âŒ ì˜¤ë¥˜';
      setTimeout(() => {
        indicator.innerHTML = 'ðŸ¤– TotalBot';
        indicator.style.pointerEvents = 'auto';
      }, 2000);
    }
  });

  document.body.appendChild(indicator);
}

console.log('[TotalBot] Content Script ì¤€ë¹„ ì™„ë£Œ');
